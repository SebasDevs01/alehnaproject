/*! For license information please see 19517.efd49b18.js.LICENSE.txt */
(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([["19517"],{7787:function(e,t,i){"use strict";function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=Array(t);i<t;i++)r[i]=e[i];return r}function s(e,t,i,r,s,n,a){try{var o=e[n](a),l=o.value}catch(e){return void i(e)}o.done?t(l):Promise.resolve(l).then(r,s)}function n(e){return function(){var t=this,i=arguments;return new Promise(function(r,n){var a=e.apply(t,i);function o(e){s(a,r,n,o,l,"next",e)}function l(e){s(a,r,n,o,l,"throw",e)}o(void 0)})}}function a(e,t,i){return t=p(t),function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e,m()?Reflect.construct(t,i||[],p(e).constructor):t.apply(e,i))}function o(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function l(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,S(r.key),r)}}function h(e,t,i){return t&&l(e.prototype,t),i&&l(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function d(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(e){if("string"==typeof e)return r(e,void 0);var i=({}).toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?r(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var s=0,n=function(){};return{s:n,n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:n}}throw TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,l=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return o=e.done,e},e:function(e){l=!0,a=e},f:function(){try{o||null==i.return||i.return()}finally{if(l)throw a}}}}function u(e,t,i){return(t=S(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function c(){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,i){var r=function(e,t){for(;!({}).hasOwnProperty.call(e,t)&&null!==(e=p(e)););return e}(e,t);if(r){var s=Object.getOwnPropertyDescriptor(r,t);return s.get?s.get.call(arguments.length<3?e:i):s.value}}).apply(null,arguments)}function p(e){return(p=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function f(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&T(e,t)}function m(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(m=function(){return!!e})()}function g(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,r)}return i}function _(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?g(Object(i),!0).forEach(function(t){u(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):g(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function v(e,t){if(null==e)return{};var i,r,s=function(e,t){if(null==e)return{};var i={};for(var r in e)if(({}).hasOwnProperty.call(e,r)){if(-1!==t.indexOf(r))continue;i[r]=e[r]}return i}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(r=0;r<n.length;r++)i=n[r],-1===t.indexOf(i)&&({}).propertyIsEnumerable.call(e,i)&&(s[i]=e[i])}return s}function y(){var e,t,i="function"==typeof Symbol?Symbol:{},r=i.iterator||"@@iterator",s=i.toStringTag||"@@toStringTag";function n(i,r,s,n){var l=Object.create((r&&r.prototype instanceof o?r:o).prototype);return A(l,"_invoke",function(i,r,s){var n,o,l,h=0,d=s||[],u=!1,c={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,i){return n=t,o=0,l=e,c.n=i,a}};function p(i,r){for(o=i,l=r,t=0;!u&&h&&!s&&t<d.length;t++){var s,n=d[t],p=c.p,f=n[2];i>3?(s=f===r)&&(l=n[(o=n[4])?5:(o=3,3)],n[4]=n[5]=e):n[0]<=p&&((s=i<2&&p<n[1])?(o=0,c.v=r,c.n=n[1]):p<f&&(s=i<3||n[0]>r||r>f)&&(n[4]=i,n[5]=r,c.n=f,o=0))}if(s||i>1)return a;throw u=!0,r}return function(s,d,f){if(h>1)throw TypeError("Generator is already running");for(u&&1===d&&p(d,f),o=d,l=f;(t=o<2?e:l)||!u;){n||(o?o<3?(o>1&&(c.n=-1),p(o,l)):c.n=l:c.v=l);try{if(h=2,n){if(o||(s="next"),t=n[s]){if(!(t=t.call(n,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,o<2&&(o=0)}else 1===o&&(t=n.return)&&t.call(n),o<2&&(l=TypeError("The iterator does not provide a '"+s+"' method"),o=1);n=e}else if((t=(u=c.n<0)?l:i.call(r,c))!==a)break}catch(t){n=e,o=1,l=t}finally{h=1}}return{value:t,done:u}}}(i,s,n),!0),l}var a={};function o(){}function l(){}function h(){}t=Object.getPrototypeOf;var d=h.prototype=o.prototype=Object.create([][r]?t(t([][r]())):(A(t={},r,function(){return this}),t));function u(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,A(e,s,"GeneratorFunction")),e.prototype=Object.create(d),e}return l.prototype=h,A(d,"constructor",h),A(h,"constructor",l),l.displayName="GeneratorFunction",A(h,s,"GeneratorFunction"),A(d),A(d,s,"Generator"),A(d,r,function(){return this}),A(d,"toString",function(){return"[object Generator]"}),(y=function(){return{w:n,m:u}})()}function A(e,t,i,r){var s=Object.defineProperty;try{s({},"",{})}catch(e){s=0}(A=function(e,t,i,r){if(t)s?s(e,t,{value:i,enumerable:!r,configurable:!r,writable:!r}):e[t]=i;else{let t=function(t,i){A(e,t,function(e){return this._invoke(t,i,e)})};t("next",0),t("throw",1),t("return",2)}})(e,t,i,r)}function T(e,t){return(T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function b(e,t,i,r){var s=c(p(1&r?e.prototype:e),t,i);return 2&r&&"function"==typeof s?function(e){return s.apply(i,e)}:s}function S(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function E(e){return(E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function k(e){var t="function"==typeof Map?new Map:void 0;return(k=function(e){if(null===e||!function(e){try{return -1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return function(e,t,i){if(m())return Reflect.construct.apply(null,arguments);var r=[null];r.push.apply(r,t);var s=new(e.bind.apply(e,r));return i&&T(s,i.prototype),s}(e,arguments,p(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),T(i,e)})(e)}i.d(t,{$i:function(){return v},B:function(){return f},Ld:function(){return y},Rx:function(){return n},T1:function(){return _},Xx:function(){return k},hz:function(){return b},j6:function(){return h},n8:function(){return u},qW:function(){return a},uk:function(){return E},vG:function(){return d},xs:function(){return o}})},86775:function(e,t,i){"use strict";i.d(t,{TA:function(){return o},sJ:function(){return n},sn:function(){return a}});var r,s=i(7787),n={MANIFEST:"manifest",NETWORK:"network",NETWORK_TIMEOUT:"network_timeout",NETWORK_FORBIDDEN:"network_forbidden",NETWORK_NOTFOUND:"network_notfound",NETWROK_RANGE_NOT_SATISFIABLE:"network_range_not_satisfiable",DEMUX:"demux",REMUX:"remux",MEDIA:"media",DRM:"drm",OTHER:"other",RUNTIME:"runtime",SUB_TYPES:{FLV:"FLV",HLS:"HLS",MP4:"MP4",FMP4:"FMP4",MSE_ADD_SB:"MSE_ADD_SB",MSE_APPEND_BUFFER:"MSE_APPEND_BUFFER",MSE_OTHER:"MSE_OTHER",MSE_FULL:"MSE_FULL",MSE_CHANGE_TYPE:"MSE_CHANGE_TYPE",OPTION:"OPTION",DASH:"DASH",LICENSE:"LICENSE",CUSTOM_LICENSE:"CUSTOM_LICENSE",MSE_HIJACK:"MSE_HIJACK",EME_HIJACK:"EME_HIJACK",SIDX:"SIDX",NO_CANPLAY_ERROR:"NO_CANPLAY_ERROR",BUFFERBREAK_ERROR:"BUFFERBREAK_ERROR",WAITING_TIMEOUT_ERROR:"WAITING_TIMEOUT_ERROR",MEDIA_ERR_ABORTED:"MEDIA_ERR_ABORTED",MEDIA_ERR_NETWORK:"MEDIA_ERR_NETWORK",MEDIA_ERR_DECODE:"MEDIA_ERR_DECODE",MEDIA_ERR_SRC_NOT_SUPPORTED:"MEDIA_ERR_SRC_NOT_SUPPORTED",MEDIA_ERR_CODEC_NOT_SUPPORTED:"MEDIA_ERR_CODEC_NOT_SUPPORTED",MEDIA_ERR_URL_EMPTY:"MEDIA_ERR_URL_EMPTY"}},a=(r={},(0,s.n8)((0,s.n8)((0,s.n8)((0,s.n8)((0,s.n8)((0,s.n8)((0,s.n8)((0,s.n8)((0,s.n8)((0,s.n8)(r,n.MANIFEST,{HLS:1100,DASH:1200}),n.NETWORK,2100),n.NETWORK_TIMEOUT,2101),n.NETWORK_FORBIDDEN,2103),n.NETWORK_NOTFOUND,2104),n.NETWROK_RANGE_NOT_SATISFIABLE,2116),n.DEMUX,{FLV:3100,HLS:3200,MP4:3300,FMP4:3400,SIDX:3410}),n.REMUX,{FMP4:4100,MP4:4200}),n.MEDIA,{MEDIA_ERR_ABORTED:5101,MEDIA_ERR_NETWORK:5102,MEDIA_ERR_DECODE:5103,MEDIA_ERR_SRC_NOT_SUPPORTED:5104,MEDIA_ERR_CODEC_NOT_SUPPORTED:5105,MEDIA_ERR_URL_EMPTY:5106,MSE_ADD_SB:5200,MSE_APPEND_BUFFER:5201,MSE_OTHER:5202,MSE_FULL:5203,MSE_HIJACK:5204,MSE_CHANGE_TYPE:5205,EME_HIJACK:5301}),n.DRM,{LICENSE:7100,CUSTOM_LICENSE:7200}),(0,s.n8)((0,s.n8)(r,n.OTHER,8e3),n.RUNTIME,{NO_CANPLAY_ERROR:9001,BUFFERBREAK_ERROR:9002,WAITING_TIMEOUT_ERROR:9003})),o=function(e){function t(e,i,r,o,l){var h;return(0,s.xs)(this,t),(h=(0,s.qW)(this,t,[l||(null==r?void 0:r.message)])).errorType=e===n.NETWORK_TIMEOUT?n.NETWORK:e,h.originError=r,h.ext=o,h.errorCode=a[e][i]||a[e],h.errorMessage=h.message,h.errorCode||(h.errorType=n.OTHER,h.errorCode=a[h.errorType]),h}return(0,s.B)(t,e),(0,s.j6)(t,null,[{key:"create",value:function(e,i,r,s,a){return e instanceof t?e:(e instanceof Error&&(r=e,e=""),e||(e=n.OTHER),new t(e,i,r,s,a))}},{key:"network",value:function(e){var i;return new t(null!=e&&e.isTimeout?n.NETWORK_TIMEOUT:n.NETWORK,null,e instanceof Error?e:null,{url:null==e?void 0:e.url,response:null==e?void 0:e.response,httpCode:null==e||null==(i=e.response)?void 0:i.status})}}])}((0,s.Xx)(Error))},40325:function(e,t,i){"use strict";i.d(t,{V:function(){return a},f:function(){return s}});var r=i(7787),s={DEBUG:1,LOG:2,WARN:3,ERROR:4},n=["Boolean","Number","String","Undefined","Null","Date","Object"],a=function(){function e(t,i){(0,r.xs)(this,e),this.name=t||"",this._prefix="[".concat(this.name,"]"),this.logCacheLevel=(null==i?void 0:i.logCacheLevel)||3,this.logMaxSize=(null==i?void 0:i.logMaxSize)||204800,this.logSize=0,this.logTextArray=[]}return(0,r.j6)(e,[{key:"debug",value:function(){for(var t,i=arguments.length,r=Array(i),n=0;n<i;n++)r[n]=arguments[n];this.logCache.apply(this,[s.DEBUG].concat(r)),e.disabled||(t=console).debug.apply(t,[this._prefix,o()].concat(r))}},{key:"log",value:function(){for(var t,i=arguments.length,r=Array(i),n=0;n<i;n++)r[n]=arguments[n];this.logCache.apply(this,[s.LOG].concat(r)),e.disabled||(t=console).log.apply(t,[this._prefix,o()].concat(r))}},{key:"warn",value:function(){for(var t,i=arguments.length,r=Array(i),n=0;n<i;n++)r[n]=arguments[n];this.logCache.apply(this,[s.WARN].concat(r)),e.disabled||(t=console).warn.apply(t,[this._prefix,o()].concat(r))}},{key:"error",value:function(){for(var t,i=arguments.length,r=Array(i),n=0;n<i;n++)r[n]=arguments[n];this.logCache.apply(this,[s.ERROR].concat(r)),e.disabled||(t=console).error.apply(t,[this._prefix,o()].concat(r))}},{key:"logCache",value:function(e){if(!(e<this.logCacheLevel)){var t="";try{for(var i=arguments.length,s=Array(i>1?i-1:0),a=1;a<i;a++)s[a-1]=arguments[a];var l=s.map(function(e){return function e(t,i,s){s||(s=1),i||(i=2);var a={};if(!t||"object"!==(0,r.uk)(t))return t;var o=Object.prototype.toString.call(t).slice(8,-1);if(!n.includes(o))return o;if(!(s>i)){for(var l in t)Object.prototype.hasOwnProperty.call(t,l)&&(s===i?a[l]=function(e){if("object"!==(0,r.uk)(e))return e;var t=Object.prototype.toString.call(e).slice(8,-1);switch(t){case"Array":case"Uint8Array":case"ArrayBuffer":return t+"["+e.length+"]";case"Object":return"{}";default:return t}}(t[l]):"object"===(0,r.uk)(t[l])?a[l]=e(t[l],i,s+1):a[l]=t[l]);return a}}(e)});t=this._prefix+o()+JSON.stringify(l)}catch(e){return}if(e>=this.logCacheLevel&&(this.logSize+=t.length,this.logTextArray.push(t)),this.logSize>this.logMaxSize){var h=this.logTextArray.shift();this.logSize-=h.length}}}},{key:"getLogCache",value:function(){var e=this.logTextArray.join("\n");return this.reset(),e}},{key:"reset",value:function(){this.logTextArray=[],this.logSize=0}},{key:"table",value:function(){var t;e.disabled||(console.group(this._prefix),(t=console).table.apply(t,arguments),console.groupEnd())}},{key:"setLogLevel",value:function(e){this.logCacheLevel=e}}],[{key:"enable",value:function(){e.disabled=!1}},{key:"disable",value:function(){e.disabled=!0}}])}();function o(){return new Date().toLocaleString()}(0,r.n8)(a,"disabled",!0)},48890:function(e,t,i){"use strict";i.d(t,{Ub:function(){return u}});var r=i(7787),s=function(){function e(){(0,r.xs)(this,e)}return(0,r.j6)(e,null,[{key:"start",value:function(e){return!e||!e.length||1===e.length&&e.end(0)-e.start(0)<1e-6||1===e.length&&0>e.start(0)?0:e.start(0)}},{key:"end",value:function(e){return!e||!e.length||1===e.length&&e.end(0)-e.start(0)<1e-6?0:e.end(e.length-1)}},{key:"get",value:function(e){if(e)try{return e.buffered}catch(e){}}},{key:"buffers",value:function(e,t){if(!e||!e.length)return[];for(var i=[],r=0,s=e.length;r<s;r++){var n=i.length;if(n&&t){var a=i[n-1],o=a[1];if(e.start(r)-o<=t){var l=e.end(r);l>o&&(a[1]=l)}else i.push([e.start(r),e.end(r)])}else i.push([e.start(r),e.end(r)])}return i}},{key:"totalLength",value:function(e){return e&&e.length?e.reduce(function(e,t){return e+(t[1]-t[0])},0):0}},{key:"info",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!t||!t.length)return{start:0,end:0,buffers:[]};for(var s=0,n=0,a=0,o=0,l=0,h=0,d=0,u=e.buffers(t,r),c=0,p=u.length;c<p;c++){var f=u[c];if(i+r>=f[0]&&i<=f[1])s=f[0],n=f[1],a=c;else if(i+r<f[0]){o=f[0],l=f[1];break}else i+r>f[1]&&(h=f[0],d=f[1])}return{start:s,end:n,index:a,buffers:u,nextStart:o,nextEnd:l,prevStart:h,prevEnd:d,currentTime:i,behind:i-s,remaining:n?n-i:0,length:e.totalLength&&e.totalLength(u)}}},{key:"isBuffered",value:function(t,i){if(t){var r=e.get(t);if(null!=r&&r.length){for(var s=0;s<r.length;s++)if(i>=r.start(s)&&i<=r.end(s))return!0}}return!1}}])}(),n=i(86775),a=i(40325),o=i(4024);function l(){var e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];try{if(e&&"undefined"!=typeof ManagedMediaSource)return ManagedMediaSource;if("undefined"!=typeof MediaSource)return MediaSource;throw Error("MediaSource no defined")}catch(e){}}function h(e){return/ManagedMediaSource/gi.test(Object.prototype.toString.call(e))}var d="updateDuration",u=function(){var e,t,i,u;function c(e,t){var i=this;(0,r.xs)(this,c),(0,r.n8)(this,"media",null),(0,r.n8)(this,"mediaSource",null),(0,r.n8)(this,"_openPromise",(0,o.$f)()),(0,r.n8)(this,"_queue",Object.create(null)),(0,r.n8)(this,"_sourceBuffer",Object.create(null)),(0,r.n8)(this,"_mseFullFlag",{}),(0,r.n8)(this,"_st",0),(0,r.n8)(this,"_opst",0),(0,r.n8)(this,"_logger",null),(0,r.n8)(this,"_config",null),(0,r.n8)(this,"_url",null),(0,r.n8)(this,"_onStartStreaming",function(){i._logger.debug("startstreaming")}),(0,r.n8)(this,"_onEndStreaming",function(){i._logger.debug("endstreaming")}),(0,r.n8)(this,"_onSBUpdateEnd",function(e){var t=i._queue[e];if(t){var r=t[0];if((null==r?void 0:r.opName)!==d&&t.shift(),r){var s,n,a=(0,o._f)()-i._opst;i.media&&i._logger.debug("UpdateEnd(".concat(e,"/").concat(r.opName,")"),o.Kx.stringify(function(e){var t=[];if(e instanceof TimeRanges)for(var i=0;i<e.length;i++)t.push({start:e.start(i),end:e.end(i)});return t}(null==(n=i._sourceBuffer[e])?void 0:n.buffered)),a,r.context),r.promise.resolve({name:r.opName,context:r.context,costtime:a});var l=null==(s=r.context)?void 0:s.callback;l&&"function"==typeof l&&l(r.context),i._startQueue(e)}}}),(0,r.n8)(this,"_onSBUpdateError",function(e,t){var r=i._queue[e];if(r){var s=r[0];s&&(i._logger.error("UpdateError",e,s.opName,s.context),s.promise.reject(new n.TA(n.sJ.MEDIA,n.sJ.SUB_TYPES.MSE_APPEND_BUFFER,t)))}}),this._config=Object.assign(c.getDefaultConfig(),t),e&&this.bindMedia(e),this._logger=new a.V("MSE"),this._config.openLog&&a.V.enable()}return(0,r.j6)(c,[{key:"version",get:function(){return"3.0.31"}},{key:"isOpened",get:function(){var e;return(null==(e=this.mediaSource)?void 0:e.readyState)==="open"}},{key:"hasOpTasks",get:function(){var e=this,t=!1;return Object.keys(this._queue).forEach(function(i){var r=e._queue[i];Array.isArray(r)&&(t||(t=r.length>0))}),t}},{key:"url",get:function(){return this._url}},{key:"duration",get:function(){var e;return(null==(e=this.mediaSource)?void 0:e.duration)||-1}},{key:"isEnded",get:function(){return!!this.mediaSource&&"ended"===this.mediaSource.readyState}},{key:"streaming",get:function(){return!h(this.mediaSource)||this.mediaSource.streaming}},{key:"handle",get:function(){var e;return null==(e=this.mediaSource)?void 0:e.handle}},{key:"liveEdge",get:function(){var e=this.bufferEnd("video"),t=this.bufferEnd("audio");return e&&t?Math.min(e,t):0}},{key:"videoMimeType",get:function(){var e;return null==(e=this._sourceBuffer.video)?void 0:e.mimeType}},{key:"isFull",value:function(e){return e?this._mseFullFlag[e]:this._mseFullFlag[c.VIDEO]}},{key:"getBlobUrl",value:function(){return this._url||(this._url=URL.createObjectURL(this.mediaSource)),this._url}},{key:"updateDuration",value:function(e){var t=this,i=this.mediaSource&&this.mediaSource.duration>e;if(this.mediaSource&&this.mediaSource.duration>e){var r=0;if(Object.keys(this._sourceBuffer).forEach(function(e){try{r=Math.max(t.bufferEnd(e)||0,r)}catch(e){}}),e<r)return Promise.resolve()}return this._enqueueBlockingOp(function(){if(t.isEnded)return void t._logger.debug("setDuration but ended");t.mediaSource&&(t.mediaSource.duration=e,t._logger.debug("setDuration",e))},d,{isReduceDuration:i})}},{key:"init",value:function(){var e=this,t=l(this._config.preferMMS),i=this.mediaSource=new t;this._st=(0,o._f)();var r=function(){var t=(0,o._f)()-e._st;e._logger.debug("sourceopen"),i.removeEventListener("sourceopen",r),e._openPromise.resolve({costtime:t})};return i.addEventListener("sourceopen",r),h(i)&&(i.addEventListener("startstreaming",this._onStartStreaming),i.addEventListener("endstreaming",this._onEndStreaming)),this._openPromise}},{key:"open",value:function(){var e=this;if(this._openPromise.used&&!this.isOpened&&this.mediaSource){var t=this.mediaSource,i=function(){var r=(0,o._f)()-e._st;e._logger.debug("sourceopen",r),t.removeEventListener("sourceopen",i),e._openPromise.resolve({costtime:r})};t.addEventListener("sourceopen",i),this._openPromise=(0,o.$f)()}return this._openPromise}},{key:"bindMedia",value:(e=(0,r.Rx)((0,r.Ld)().m(function e(t){var i,s,n,a,d=this;return(0,r.Ld)().w(function(e){for(;;)switch(e.n){case 0:if(!(this.mediaSource||this.media)){e.n=1;break}return e.n=1,this.unbindMedia();case 1:if(i=l(this._config.preferMMS),!(!t||!i)){e.n=2;break}throw Error("Param media or MediaSource does not exist");case 2:return this.media=t,n=h(s=this.mediaSource=new i),this._st=(0,o._f)(),a=function(){var e=(0,o._f)()-d._st;d._logger.debug("sourceopen"),s.removeEventListener("sourceopen",a),URL.revokeObjectURL(t.src),d._openPromise.resolve({costtime:e})},s.addEventListener("sourceopen",a),n&&(s.addEventListener("startstreaming",this._onStartStreaming),s.addEventListener("endstreaming",this._onEndStreaming)),this._url=URL.createObjectURL(s),t.src=this._url,t.disableRemotePlayback=n,e.a(2,this._openPromise)}},e,this)})),function(t){return e.apply(this,arguments)})},{key:"unbindMedia",value:(t=(0,r.Rx)((0,r.Ld)().m(function e(){var t,i,s,n=this;return(0,r.Ld)().w(function(e){for(;;)switch(e.n){case 0:if(this._openPromise.used||this._openPromise.resolve(),t=this.mediaSource){if(Object.keys(this._queue).forEach(function(e){var t=n._queue[e];t&&t.forEach(function(e){var t,i;return null==(t=e.promise)||null==(i=t.resolve)?void 0:i.call(t)})}),i=!!this.media&&this.media.readyState>=1,s="open"===t.readyState,i&&s)try{t.endOfStream()}catch(e){}Object.keys(this._sourceBuffer).forEach(function(e){try{t.removeSourceBuffer(n._sourceBuffer[e])}catch(e){}}),h(t)&&(t.removeEventListener("startstreaming",this._onStartStreaming),t.removeEventListener("endstreaming",this._onEndStreaming))}if(this.media){this.media.disableRemotePlayback=!1,this.media.removeAttribute("src");try{this.media.load()}catch(e){}this.media=null}this.mediaSource=null,this._openPromise=(0,o.$f)(),this._queue=Object.create(null),this._sourceBuffer=Object.create(null);case 1:return e.a(2)}},e,this)})),function(){return t.apply(this,arguments)})},{key:"unbind",value:(i=(0,r.Rx)((0,r.Ld)().m(function e(t){var i,s=this;return(0,r.Ld)().w(function(e){for(;;)switch(e.n){case 0:if(this._openPromise.used||this._openPromise.resolve(),i=this.mediaSource){if(Object.keys(this._queue).forEach(function(e){var t=s._queue[e];t&&t.forEach(function(e){var t,i;return null==(t=e.promise)||null==(i=t.resolve)?void 0:i.call(t)})}),t&&this.isOpened)try{i.endOfStream()}catch(e){}Object.keys(this._sourceBuffer).forEach(function(e){try{i.removeSourceBuffer(s._sourceBuffer[e])}catch(e){}})}h(i)&&(i.removeEventListener("startstreaming",this._onStartStreaming),i.removeEventListener("endstreaming",this._onEndStreaming)),this._url&&(URL.revokeObjectURL(this._url),this._url=""),this.mediaSource=null,this._openPromise=(0,o.$f)(),this._queue=Object.create(null),this._sourceBuffer=Object.create(null);case 1:return e.a(2)}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"createSource",value:function(e,t){var i;if(!this._sourceBuffer[e]&&this.mediaSource){try{i=this._sourceBuffer[e]=this.mediaSource.addSourceBuffer(t)}catch(e){throw new n.TA(n.sJ.MEDIA,n.sJ.SUB_TYPES.MSE_ADD_SB,e)}i.mimeType=t,i.addEventListener("updateend",this._onSBUpdateEnd.bind(this,e)),i.addEventListener("error",this._onSBUpdateError.bind(this,e))}}},{key:"changeType",value:function(e,t){var i=this,r=this._sourceBuffer[e];return this.mediaSource&&r&&r.mimeType!==t?"function"!=typeof r.changeType?Promise.reject(new n.TA(n.sJ.MEDIA,n.sJ.SUB_TYPES.MSE_CHANGE_TYPE,Error("changeType is not a function"))):this._enqueueOp(e,function(){try{r.changeType(t)}catch(e){throw new n.TA(n.sJ.MEDIA,n.sJ.SUB_TYPES.MSE_CHANGE_TYPE,e)}r.mimeType=t,i._onSBUpdateEnd(e)},"changeType",{mimeType:t}):Promise.resolve()}},{key:"createOrChangeSource",value:function(e,t){return this.createSource(e,t),this.changeType(e,t)}},{key:"append",value:function(e,t,i){var r=this;return t&&t.byteLength&&this._sourceBuffer[e]?this._enqueueOp(e,function(){var s,n,a;r.mediaSource&&(null==(s=r.media)||!s.error)&&(r._logger.debug("MSE APPEND START",i),r._opst=(0,o._f)(),(!r.mediaSource.sourceBuffers||null!=(n=r.mediaSource.sourceBuffers)&&n.length)&&(null==(a=r._sourceBuffer[e])||a.appendBuffer(t)))},"appendBuffer",i):Promise.resolve()}},{key:"remove",value:function(e,t,i,r){var s=this,n=!1;return this._mseFullFlag[e]&&(n=!0),this._enqueueOp(e,function(){if(s.mediaSource&&(null==(n=s.media)||!n.error)){var n,a=s._sourceBuffer[e];if(t>=i||!a)return void s._onSBUpdateEnd(e);s._opst=(0,o._f)(),s._logger.debug("MSE REMOVE START",e,t,i,r),a.remove(t,i)}},"removeBuffer",r,n)}},{key:"clearBuffer",value:function(e,t){var i,r=this;return Object.keys(this._sourceBuffer).forEach(function(s){i=r.remove(s,e,t)}),i||Promise.resolve()}},{key:"clearAllBuffer",value:function(){var e,t=this;return Object.keys(this._sourceBuffer).forEach(function(i){var r=t._sourceBuffer[i];e=t.remove(i,0,s.end(s.get(r)))}),e}},{key:"clearOpQueues",value:function(e,t){this._logger.debug("MSE clearOpQueue START");var i,r=this._queue[e];if(t&&r){this._queue[e]=[];return}if(r&&r[e]&&!(r.length<5)){var s=[];r.forEach(function(e){e.context&&e.context.isinit&&s.push(e)}),this._queue[e]=r.slice(0,2),s.length>0&&(i=this._queue[e]).push.apply(i,s)}}},{key:"endOfStream",value:function(e){var t=this;return this.mediaSource&&"open"===this.mediaSource.readyState?this._enqueueBlockingOp(function(){var i=t.mediaSource;i&&"open"===i.readyState&&(t._logger.debug("MSE endOfStream START"),e?i.endOfStream(e):i.endOfStream())},"endOfStream"):Promise.resolve()}},{key:"setLiveSeekableRange",value:function(e,t){var i=this.mediaSource;e<0||t<e||null==i||!i.setLiveSeekableRange||"open"!==i.readyState||i.setLiveSeekableRange(e,t)}},{key:"getSourceBuffer",value:function(e){return this._sourceBuffer[e]}},{key:"buffered",value:function(e){return s.get(this._sourceBuffer[e])}},{key:"bufferStart",value:function(e){return s.start(this.buffered(e))}},{key:"bufferEnd",value:function(e){return s.end(this.buffered(e))}},{key:"_enqueueOp",value:function(e,t,i,r,s){var n=this;if(!this.mediaSource)return Promise.resolve();var a=this._queue[e]=this._queue[e]||[],l={exec:t,promise:(0,o.$f)(),opName:i,context:r};return s?(a.splice(0,0,l),this._mseFullFlag[e]=!1,this._startQueue(e)):a.push(l),this.isOpened||this.isEnded?1===a.length&&this._startQueue(e):this._openPromise.then(function(){1===a.length&&n._startQueue(e)}),l.promise}},{key:"_enqueueBlockingOp",value:(u=(0,r.Rx)((0,r.Ld)().m(function e(t,i,s){var n,a,l=this;return(0,r.Ld)().w(function(e){for(;;)switch(e.n){case 0:if(this.mediaSource){e.n=1;break}return e.a(2,Promise.resolve());case 1:if((n=Object.keys(this._sourceBuffer)).length){e.n=2;break}return e.a(2,t());case 2:return a=[],n.forEach(function(e){var t=l._queue[e],r=(0,o.$f)();a.push(r),t.push({exec:function(){r.resolve()},promise:r,opName:i,context:s}),1===t.length&&l._startQueue(e)}),e.a(2,Promise.all(a).then(function(){try{return t()}finally{n.forEach(function(e){var t=l._queue[e],i=l._sourceBuffer[e];null==t||t.shift(),i&&i.updating||l._startQueue(e)})}}))}},e,this)})),function(e,t,i){return u.apply(this,arguments)})},{key:"_startQueue",value:function(e){var t=this._queue[e];if(t){var i=t[0];if(i&&!this._mseFullFlag[e])try{i.exec()}catch(s){s&&s.message&&s.message.indexOf("SourceBuffer is full")>=0?(this._mseFullFlag[e]=!0,i.context&&"object"===(0,r.uk)(i.context)&&(i.context.isFull=!0),this._logger.error("[MSE error],  context,",i.context," ,name,",i.opName,",err,SourceBuffer is full"),i.promise.reject(new n.TA(n.sJ.MEDIA,n.sJ.SUB_TYPES.MSE_FULL,s))):(this._logger.error(s),i.promise.reject(s.constructor===n.TA?s:new n.TA(n.sJ.MEDIA,n.sJ.SUB_TYPES.MSE_OTHER,s)),t.shift(),this._startQueue(e))}}}},{key:"setTimeoffset",value:function(e,t,i){var r=this;return this._enqueueOp(e,function(){t<0&&(t+=.001),r._sourceBuffer[e].timestampOffset=t,r._onSBUpdateEnd(e)},"setTimeoffset",i)}},{key:"abort",value:function(e,t){var i=this;return this.isOpened?this._enqueueOp(e,function(){i._sourceBuffer[e].abort(),i._onSBUpdateEnd(e)},"abort",t):Promise.resolve()}}],[{key:"isSupported",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:'video/mp4; codecs="avc1.42E01E,mp4a.40.2"',t=l();if(!t)return!1;try{return t.isTypeSupported(e)}catch(t){return this._logger.error(e,t),!1}}},{key:"isMMSOnly",value:function(){return"undefined"!=typeof ManagedMediaSource&&"undefined"==typeof MediaSource}},{key:"getDefaultConfig",value:function(){return{openLog:!1,preferMMS:!1}}}])}();(0,r.n8)(u,"VIDEO","video"),(0,r.n8)(u,"AUDIO","audio")},4024:function(e,t,i){"use strict";function r(){var e,t,i=new Promise(function(i,r){e=i,t=r});return i.used=!1,i.resolve=function(){return i.used=!0,e.apply(void 0,arguments)},i.reject=function(){return i.used=!0,t.apply(void 0,arguments)},i}function s(){try{return parseInt(performance.now(),10)}catch(e){return new Date().getTime()}}i.d(t,{$f:function(){return r},Kx:function(){return n},_f:function(){return s}});var n={stringify:function(e){try{return JSON.stringify(e)}catch(e){return""}},parse:function(e){try{return JSON.parse(e)}catch(e){return}}}},63847:function(e,t,i){"use strict";function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=Array(t);i<t;i++)r[i]=e[i];return r}function s(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function n(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,d(r.key),r)}}function a(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function o(e,t,i){return(t=d(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function l(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var r,s,n,a,o=[],l=!0,h=!1;try{if(n=(i=i.call(e)).next,0===t){if(Object(i)!==i)return;l=!1}else for(;!(l=(r=n.call(i)).done)&&(o.push(r.value),o.length!==t);l=!0);}catch(e){h=!0,s=e}finally{try{if(!l&&null!=i.return&&(a=i.return(),Object(a)!==a))return}finally{if(h)throw s}}return o}}(e,t)||u(e,t)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function h(e){return function(e){if(Array.isArray(e))return r(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||u(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function u(e,t){if(e){if("string"==typeof e)return r(e,t);var i=({}).toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?r(e,t):void 0}}i.d(t,{Og:function(){return h},j6:function(){return a},n8:function(){return o},xs:function(){return s},zC:function(){return l}})},85274:function(e,t,i){"use strict";i.d(t,{S:function(){return r},VE:function(){return n},mT:function(){return s}});var r={VIDEO:"video",AUDIO:"audio",METADATA:"metadata"},s={AV1:"av1",AVC:"avc",HEVC:"hevc",VVCC:"vvcC"},n={AAC:"aac",G711PCMA:"g7110a",G711PCMU:"g7110m"}},32239:function(e,t,i){"use strict";i.d(t,{s:function(){return h}});var r=i(63847),s=i(85274),n=i(55355),a=(0,r.j6)(function e(){(0,r.xs)(this,e),this.buffer=new Uint8Array(0)},[{key:"write",value:function(){for(var e=this,t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];i.forEach(function(t){t?e.buffer=function(e){for(var t=0,i=arguments.length,r=Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];r.forEach(function(e){t+=e.length});var n=new e(t),a=0;return r.forEach(function(e){n.set(e,a),a+=e.length}),n}(Uint8Array,e.buffer,t):window.console.warn(t)})}}],[{key:"writeUint16",value:function(e){return new Uint8Array([e>>8&255,255&e])}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}}]),o=function(){function e(){(0,r.xs)(this,e)}return(0,r.j6)(e,null,[{key:"box",value:function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];var s=8+(i=i.filter(Boolean)).reduce(function(e,t){return e+t.byteLength},0),n=new Uint8Array(s);n[0]=s>>24&255,n[1]=s>>16&255,n[2]=s>>8&255,n[3]=255&s,n.set(e,4);var a=8;return i.forEach(function(e){n.set(e,a),a+=e.byteLength}),n}},{key:"FullBox",value:function(t,i,r){for(var s=arguments.length,n=Array(s>3?s-3:0),a=3;a<s;a++)n[a-3]=arguments[a];return e.box.apply(e,[t,new Uint8Array([i,r>>16&255,r>>8&255,255&r])].concat(n))}},{key:"ftyp",value:function(t){return t.find(function(e){return e.type===s.S.VIDEO&&e.codecType===s.mT.HEVC})?e.FTYPHEV1:e.FTYPAVC1}},{key:"initSegment",value:function(t){var i=e.ftyp(t);return(0,n.Cs)(i,e.moov(t))}},{key:"pssh",value:function(t){var i=new Uint8Array([1,0,0,0].concat([16,119,239,236,192,178,77,2,172,227,60,30,82,226,251,75],[0,0,0,1],(0,n.qg)(t.kid),[0,0,0,0]));return e.box(e.types.pssh,i)}},{key:"moov",value:function(t){if(!t[0].useEME||!t[0].encv&&!t[0].enca)return e.box.apply(e,[e.types.moov,e.mvhd(t[0].mvhdDurtion||t[0].duration,t[0].mvhdTimecale||t[0].timescale)].concat((0,r.Og)(t.map(function(t){return e.trak(t)})),[e.mvex(t)]));t[0].pssh||(t[0].pssh={kid:t[0].kid});var i=this.pssh(t[0].pssh);return e.box.apply(e,[e.types.moov,e.mvhd(t[0].mvhdDurtion||t[0].duration,t[0].mvhdTimecale||t[0].timescale),e.mvex(t)].concat((0,r.Og)(t.map(function(t){return e.trak(t)})),[i]))}},{key:"mvhd",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9e4;return e.box(e.types.mvhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,i>>24&255,i>>16&255,i>>8&255,255&i,t>>24&255,t>>16&255,t>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]))}},{key:"trak",value:function(t){return e.box(e.types.trak,e.tkhd(t.id,t.tkhdDuration||0,t.width,t.height),e.mdia(t))}},{key:"tkhd",value:function(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return e.box(e.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,i>>24&255,i>>16&255,i>>8&255,255&i,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,255&r,0,0,s>>8&255,255&s,0,0]))}},{key:"edts",value:function(t){return e.box(e.types.edts,e.elst(t))}},{key:"elst",value:function(t){t.entries;var i=t.entriesData,r=t.version;return e.FullBox(e.types.elst,r,0,i)}},{key:"mdia",value:function(t){return e.box(e.types.mdia,e.mdhd(t.duration,t.timescale),e.hdlr(t.type),e.minf(t))}},{key:"mdhd",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9e4;return e.box(e.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,i>>24&255,i>>16&255,i>>8&255,255&i,t>>24&255,t>>16&255,t>>8&255,255&t,85,196,0,0]))}},{key:"hdlr",value:function(t){return e.box(e.types.hdlr,e.HDLR_TYPES[t])}},{key:"minf",value:function(t){return e.box(e.types.minf,t.type===s.S.VIDEO?e.VMHD:e.SMHD,e.DINF,e.stbl(t))}},{key:"stbl",value:function(t){return t&&t.ext,e.box(e.types.stbl,e.stsd(t),e.STTS,void 0,e.STSC,e.STSZ,e.STCO)}},{key:"stsd",value:function(t){var i="audio"===t.type?t.useEME&&t.enca?e.enca(t):e.mp4a(t):t.useEME&&t.encv?e.encv(t):t.av1C?e.av01(t):e.avc1hev1vvc1(t);return e.box(e.types.stsd,new Uint8Array([0,0,0,0,0,0,0,1]),i)}},{key:"enca",value:function(t){var i=t.enca.channelCount,r=t.enca.sampleRate,s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,i,0,16,0,0,0,0,r>>8&255,255&r,0,0]),n=e.esds(t.config),a=e.sinf(t.enca);return e.box(e.types.enca,s,n,a)}},{key:"encv",value:function(t){var i,s,n=t.sps.length>0?t.sps[0]:[],a=t.pps.length>0?t.pps[0]:[],o=t.width,l=t.height,h=t.sarRatio[0],d=t.sarRatio[1],u=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),c=new Uint8Array((i=(s=[1,n[1],n[2],n[3],255,225,n.length>>>8&255,255&n.length]).concat.apply(s,(0,r.Og)(n)).concat([1,a.length>>>8&255,255&a.length])).concat.apply(i,(0,r.Og)(a))),p=new Uint8Array([0,0,88,57,0,15,200,192,0,4,86,72]),f=e.sinf(t.encv),m=new Uint8Array([h>>24,h>>16&255,h>>8&255,255&h,d>>24,d>>16&255,d>>8&255,255&d]);return e.box(e.types.encv,u,e.box(e.types.avcC,c),e.box(e.types.btrt,p),f,e.box(e.types.pasp,m))}},{key:"schi",value:function(t){var i=new Uint8Array([]),r=e.tenc(t);return e.box(e.types.schi,i,r)}},{key:"tenc",value:function(t){var i=new Uint8Array([0,0,0,0,0,0,255&t.default_IsEncrypted,255&t.default_IV_size].concat((0,n.qg)(t.default_KID)));return e.box(e.types.tenc,i)}},{key:"sinf",value:function(t){var i=new Uint8Array([]),r=new Uint8Array([t.data_format.charCodeAt(0),t.data_format.charCodeAt(1),t.data_format.charCodeAt(2),t.data_format.charCodeAt(3)]),s=new Uint8Array([0,0,0,0,99,101,110,99,0,1,0,0]),n=e.schi(t);return e.box(e.types.sinf,i,e.box(e.types.frma,r),e.box(e.types.schm,s),n)}},{key:"av01",value:function(t){return e.box(e.types.av01,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,t.width>>8&255,255&t.width,t.height>>8&255,255&t.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),t.av1C,t.colr)}},{key:"avc1hev1vvc1",value:function(t){t.codecType===s.mT.HEVC?(i=e.hvcC(t),r=e.types.hvc1):t.codecType===s.mT.VVCC?(i=e.vvcC(t),r=e.types.bvc2):(i=e.avcC(t),r=e.types.avc1);var i,r,n=[new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,t.width>>8&255,255&t.width,t.height>>8&255,255&t.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),i];return t.codecType===s.mT.HEVC?n.push(e.box(e.types.fiel,new Uint8Array([1,0]))):t.sarRatio&&t.sarRatio.length>1&&n.push(e.pasp(t.sarRatio)),e.box.apply(e,[r].concat(n))}},{key:"avcC",value:function(t){var i,s,n,a=[],o=[];return t.sps.forEach(function(e){n=e.byteLength,a.push(n>>>8&255),a.push(255&n),a.push.apply(a,(0,r.Og)(e))}),t.pps.forEach(function(e){n=e.byteLength,o.push(n>>>8&255),o.push(255&n),o.push.apply(o,(0,r.Og)(e))}),e.box(e.types.avcC,new Uint8Array((i=(s=[1,a[3],a[4],a[5],255,224|t.sps.length]).concat.apply(s,a).concat([t.pps.length])).concat.apply(i,o)))}},{key:"vvcC",value:function(t){var i=t.vvcC;return e.box(e.types.bv2C,new Uint8Array(i))}},{key:"hvcC",value:function(t){var i,s=t.hvcC;if(s instanceof ArrayBuffer||s instanceof Uint8Array)return s;var n=t.vps,a=t.sps,o=t.pps;if(s){var l=s.generalProfileCompatibilityFlags,h=s.generalConstraintIndicatorFlags,d=(n.length&&1)+(a.length&&1)+(o.length&&1);i=[1,s.generalProfileSpace<<6|s.generalTierFlag<<5|s.generalProfileIdc,l>>>24,l>>>16,l>>>8,l,h[0],h[1],h[2],h[3],h[4],h[5],s.generalLevelIdc,240,0,252,252|s.chromaFormatIdc,248|s.bitDepthLumaMinus8,248|s.bitDepthChromaMinus8,0,0,s.numTemporalLayers<<3|s.temporalIdNested<<2|3,d];var u=function(e){var t;i.push(e.length>>8,e.length),(t=i).push.apply(t,(0,r.Og)(e))};n.length&&(i.push(160,0,n.length),n.forEach(u)),a.length&&(i.push(161,0,a.length),a.forEach(u)),o.length&&(i.push(162,0,o.length),o.forEach(u))}else i=[1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,153,152,9,161,0,1,0,45,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,2,128,128,45,22,89,153,164,147,43,154,128,128,128,130,0,0,3,0,2,0,0,3,0,50,16,162,0,1,0,7,68,1,193,114,180,98,64];return e.box(e.types.hvcC,new Uint8Array(i))}},{key:"pasp",value:function(t){var i=(0,r.zC)(t,2),s=i[0],n=i[1];return e.box(e.types.pasp,new Uint8Array([s>>24,s>>16&255,s>>8&255,255&s,n>>24,n>>16&255,n>>8&255,255&n]))}},{key:"mp4a",value:function(t){return e.box(e.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,t.sampleRate>>8&255,255&t.sampleRate,0,0]),t.config.length?e.esds(t.config):void 0)}},{key:"esds",value:function(t){var i=t.length;return e.box(e.types.esds,new Uint8Array([0,0,0,0,3,23+i,0,0,0,4,15+i,64,21,0,6,0,0,0,218,192,0,0,218,192,5].concat([i]).concat(t).concat([6,1,2])))}},{key:"mvex",value:function(t){return e.box.apply(e,[e.types.mvex].concat((0,r.Og)(t.map(function(t){return e.trex(t.id)}))))}},{key:"trex",value:function(t){return e.box(e.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}},{key:"trex1",value:function(t){return e.box(e.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,2,0,0,0,0,0,0,1,0,0]))}},{key:"trex2",value:function(t){return e.box(e.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,4,0,0,0,0,0,2,0,0,0]))}},{key:"moof",value:function(t){return e.box.apply(e,[e.types.moof,e.mfhd(t[0].samples?t[0].samples[0].gopId:0)].concat((0,r.Og)(t.map(function(t){return e.traf(t)}))))}},{key:"mfhd",value:function(t){return e.box(e.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}},{key:"traf",value:function(t){var i=e.tfhd(t.id),r=e.tfdt(t.baseMediaDecodeTime),s=0;if(t.isVideo&&t.videoSenc&&t.videoSenc.forEach(function(e){s+=8,e.subsamples&&e.subsamples.length&&(s+=2+6*e.subsamples.length)}),t.videoSencLength=s,t.useEME&&(t.isVideoEncryption||t.isAudioEncryption))if(t.isVideoEncryption)if(t.isVideo){var n=e.saiz(t),a=e.saio(t),o=e.trun1(t),l=e.senc(t);return e.box(e.types.traf,i,r,n,a,o,l)}else if(t.isAudioEncryption){var h=e.sbgp(),d=e.saiz(t),u=e.saio(t),c=e.senc(t),p=e.trun1(t);return e.box(e.types.traf,i,r,h,d,u,c,p)}else{var f=e.sbgp(),m=e.trun1(t);return e.box(e.types.traf,i,r,f,m)}else if(t.isVideo){var g=e.trun1(t);return e.box(e.types.traf,i,r,g)}else{var _=e.sbgp(),v=e.saiz(t),y=e.saio(t),A=e.senc(t),T=e.trun1(t);return e.box(e.types.traf,i,r,_,v,y,A,T)}var b=e.sdtp(t);return e.box(e.types.traf,i,r,b,e.trun(t.samples,b.byteLength+76))}},{key:"sdtp",value:function(t){var i=new a;return t.samples.forEach(function(e){i.write(new Uint8Array(t.isVideo?[e.keyframe?32:16]:[16]))}),e.box(e.types.sdtp,this.extension(0,0),i.buffer)}},{key:"trun1",value:function(t){var i=new a,r=a.writeUint32(t.samples.length),s=null;if(t.isVideo){var n=t.videoSencLength;s=a.writeUint32(76+16*t.samples.length+n+77),!t.isVideoEncryption&&t.isAudioEncryption&&(s=a.writeUint32(76+16*t.samples.length+20))}else{var o=76+12*t.samples.length+52;t.isAudioEncryption&&(o=76+12*t.samples.length+8*t.audioSenc.length+105),s=a.writeUint32(o)}return t.samples.forEach(function(e){i.write(a.writeUint32(e.duration)),i.write(a.writeUint32(e.size)),i.write(a.writeUint32(e.keyframe?0x2000000:65536)),t.isVideo&&i.write(a.writeUint32(e.cts?e.cts:0))}),e.box(e.types.trun,this.extension(0,t.flags),r,s,i.buffer)}},{key:"senc",value:function(t){var i=new a,r=t.samples.length,s=t.isVideo?16:8,n=2*!!t.isVideo,o=[],l=0;return t.isVideo?(o=t.videoSenc,l=t.videoSencLength):o=t.audioSenc,l=l||s*r,i.write(a.writeUint32(16+l),e.types.senc,this.extension(0,n)),i.write(a.writeUint32(r)),o.forEach(function(e){for(var t=0;t<e.InitializationVector.length;t++)i.write(new Uint8Array([e.InitializationVector[t]]));e.subsamples&&e.subsamples.length&&(i.write(a.writeUint16(e.subsamples.length)),e.subsamples.forEach(function(e){i.write(a.writeUint16(e.BytesOfClearData)),i.write(a.writeUint32(e.BytesOfProtectedData))}))}),i.buffer}},{key:"saio",value:function(t){var i=12*t.samples.length+141;!t.isVideo&&t.isAudioEncryption&&(i=149);var r=new Uint8Array([1,0,0,0,0,0,0,1,0,0,0,0,i>>24&255,i>>16&255,i>>8&255,255&i]);return e.box(e.types.saio,r)}},{key:"saiz",value:function(t){var i=t.samples.length,r=new Uint8Array([0,0,0,0,16,i>>24&255,i>>16&255,i>>8&255,255&i]);return e.box(e.types.saiz,r)}},{key:"sbgp",value:function(){var t=new Uint8Array([114,111,108,108,0,0,0,1,0,0,1,25,0,0,0,1]);return e.box(e.types.sbgp,this.extension(0,0),t)}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"tfhd",value:function(t){return e.box(e.types.tfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}},{key:"tfdt",value:function(t){var i=Math.floor(t/0x100000000),r=Math.floor(t%0x100000000);return e.box(e.types.tfdt,new Uint8Array([1,0,0,0,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r]))}},{key:"trun",value:function(t,i){var r=t.length,s=12+16*r;i+=8+s;var n=new Uint8Array(s);n.set([0,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,255&r,i>>>24&255,i>>>16&255,i>>>8&255,255&i],0);for(var a=0;a<r;a++){var o=t[a],l=o.duration,h=o.size,d=o.flag,u=void 0===d?{}:d,c=o.cts,p=void 0===c?0:c;n.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,h>>>24&255,h>>>16&255,h>>>8&255,255&h,u.isLeading<<2|(null===u.dependsOn||void 0===u.dependsOn?1:u.dependsOn),u.isDependedOn<<6|u.hasRedundancy<<4|u.paddingValue<<1|(null===u.isNonSyncSample||void 0===u.isNonSyncSample?1:u.isNonSyncSample),61440&u.degradationPriority,15&u.degradationPriority,p>>>24&255,p>>>16&255,p>>>8&255,255&p],12+16*a)}return e.box(e.types.trun,n)}},{key:"moovMP4",value:function(t){return e.box.apply(e,[e.types.moov,e.mvhd(t[0].duration,t[0].timescale)].concat((0,r.Og)(t.map(function(t){return e.trackMP4(t)}))))}},{key:"trackMP4",value:function(t){return e.box(e.types.trak,e.tkhd(t.id,t.duration,t.width,t.height),e.mdiaMP4(t))}},{key:"mdiaMP4",value:function(t){return e.box(e.types.mdia,e.mdhd(t.duration,t.timescale),e.hdlr(t.type),e.minfMP4(t))}},{key:"minfMP4",value:function(t){return e.box(e.types.minf,t.type===s.S.VIDEO?e.VMHD:e.SMHD,e.DINF,e.stblMP4(t))}},{key:"stblMP4",value:function(t){var i=t.ext,r=[e.stsd(t),e.stts(i.stts),e.stsc(i.stsc),e.stsz(i.stsz),e.stco(i.stco)];return i.stss.length&&r.push(e.stss(i.stss)),i.ctts.length&&r.push(e.ctts(i.ctts)),e.box.apply(e,[e.types.stbl].concat(r))}},{key:"stts",value:function(t){var i=t.length,r=new Uint8Array(8*i),s=0;return t.forEach(function(e){var t=e.value,i=e.count;r.set([i>>24,i>>16&255,i>>8&255,255&i,t>>24,t>>16&255,t>>8&255,255&t],s),s+=8}),e.box(e.types.stts,(0,n.Cs)(new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i]),r))}},{key:"stsc",value:function(t){var i=t.length,r=new Uint8Array(12*i),s=0;return t.forEach(function(e){var t=e.firstChunk,i=e.samplesPerChunk,n=e.sampleDescIndex;r.set([t>>24,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,n>>24,n>>16&255,n>>8&255,255&n],s),s+=12}),e.box(e.types.stsc,(0,n.Cs)(new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i]),r))}},{key:"stsz",value:function(t){var i=t.length,r=new Uint8Array(4*i),s=0;return t.forEach(function(e){r.set([e>>24,e>>16&255,e>>8&255,255&e],s),s+=4}),e.box(e.types.stsz,(0,n.Cs)(new Uint8Array([0,0,0,0,0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i]),r))}},{key:"stco",value:function(t){var i=t.length,r=new Uint8Array(4*i),s=0;return t.forEach(function(e){r.set([e>>24,e>>16&255,e>>8&255,255&e],s),s+=4}),e.box(e.types.stco,(0,n.Cs)(new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i]),r))}},{key:"stss",value:function(t){var i=t.length,r=new Uint8Array(4*i),s=0;return t.forEach(function(e){r.set([e>>24,e>>16&255,e>>8&255,255&e],s),s+=4}),e.box(e.types.stss,(0,n.Cs)(new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i]),r))}},{key:"ctts",value:function(t){var i=t.length,r=new Uint8Array(8*i),s=0;return t.forEach(function(e){var t=e.value,i=e.count;r.set([i>>24,i>>16&255,i>>8&255,255&i,t>>24,t>>16&255,t>>8&255,255&t],s),s+=8}),e.box(e.types.ctts,(0,n.Cs)(new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i]),r))}},{key:"styp",value:function(){return e.box(e.types.styp,new Uint8Array([109,115,100,104,0,0,0,0,109,115,100,104,109,115,105,120]))}},{key:"sidx",value:function(t){var i=t.timescale,r=t.samples[0].duration,s=r*t.samples.length,n=t.samples[0].sampleOffset*r,a=8;t.samples.forEach(function(e){a+=e.size});var o=0;if(t.isVideo){var l,h=0;t.videoSenc&&(l=t.videoSenc),t.isVideo&&l.forEach(function(e){h+=8,e.subsamples&&e.subsamples.length&&(h+=2+6*e.subsamples.length)}),t.videoSencLength=h,o=a+141+16*t.samples.length+h,t.useEME&&t.isAudioEncryption&&!t.isVideoEncryption&&(o=a+16*t.samples.length+84)}else o=a+116+12*t.samples.length,t.useEME&&t.isAudioEncryption&&(o=a+169+12*t.samples.length+8*t.audioSenc.length);var d=new Uint8Array([0,0,0,0,0,0,0,255&t.id,i>>24&255,i>>16&255,i>>8&255,255&i,n>>24&255,n>>16&255,n>>8&255,255&n,0,0,0,0,0,0,0,1,0,o>>16&255,o>>8&255,255&o,s>>24&255,s>>16&255,s>>8&255,255&s,144,0,0,0]);return e.box(e.types.sidx,d)}},{key:"mdat",value:function(t){return e.box(e.types.mdat,t)}}])}();(0,r.n8)(o,"types",["av01","av1C","avc1","avcC","hvc1","hvcC","dinf","dref","edts","elst","esds","ftyp","hdlr","mdat","mdhd","mdia","mfhd","minf","moof","moov","mp4a","mvex","mvhd","pasp","stbl","stco","stsc","stsd","stsz","stts","tfdt","tfhd","traf","trak","trex","tkhd","vmhd","smhd","ctts","stss","styp","pssh","sidx","sbgp","saiz","saio","senc","trun","encv","enca","sinf","btrt","frma","tenc","schm","schi","mehd","fiel","sdtp","bvc2","bv2C"].reduce(function(e,t){return e[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)],e},Object.create(null))),(0,r.n8)(o,"HDLR_TYPES",{video:new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audio:new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0])}),(0,r.n8)(o,"FTYPAVC1",o.box(o.types.ftyp,new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]))),(0,r.n8)(o,"FTYPHEV1",o.box(o.types.ftyp,new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,104,101,118,49]))),(0,r.n8)(o,"DINF",o.box(o.types.dinf,o.box(o.types.dref,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1])))),(0,r.n8)(o,"VMHD",o.box(o.types.vmhd,new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))),(0,r.n8)(o,"SMHD",o.box(o.types.smhd,new Uint8Array([0,0,0,0,0,0,0,0]))),(0,r.n8)(o,"StblTable",new Uint8Array([0,0,0,0,0,0,0,0])),(0,r.n8)(o,"STTS",o.box(o.types.stts,o.StblTable)),(0,r.n8)(o,"STSC",o.box(o.types.stsc,o.StblTable)),(0,r.n8)(o,"STSZ",o.box(o.types.stsz,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]))),(0,r.n8)(o,"STCO",o.box(o.types.stco,o.StblTable));var l=i(9633),h=(0,r.j6)(function e(t,i,s){(0,r.xs)(this,e),this.videoTrack=t,this.audioTrack=i;var n=/Chrome\/([^.]+)/.exec(navigator.userAgent);this.forceFirstIDR=n&&50>Number(n[1]),this.log=new l.V("FMP4Remuxer",!s||!s.openLog||!s.openLog)},[{key:"remux",value:function(){var e,t,i,r,s,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},l=this.videoTrack,h=this.audioTrack,d=l.exist(),u=h.exist(),c=[];return n&&(a&&a.initMerge?(d&&c.push(this.videoTrack),u&&c.push(this.audioTrack),i=o.initSegment(c)):(d&&(e=o.initSegment([this.videoTrack])),u&&(t=o.initSegment([this.audioTrack])))),d&&l.hasSample()&&(r=this._remuxVideo()),u&&h.hasSample()&&(s=this._remuxAudio()),l.samples=[],h.samples=[],{initSegment:i,videoInitSegment:e,audioInitSegment:t,videoSegment:r,audioSegment:s}}},{key:"_remuxVideo",value:function(){var e=this.videoTrack;this.forceFirstIDR&&(e.samples[0].flag={dependsOn:2,isNonSyncSample:0});var t=e.samples,i=/av01/.test(e.codec),r=0;i?t.forEach(function(e){r+=e.data.byteLength}):t.forEach(function(e){r+=e.units.reduce(function(e,t){return e+t.byteLength},0),r+=4*e.units.length});var s=new Uint8Array(r);if(i)for(var a,l=0,h=t.length,d=0;l<h;l++)a=t[l],s.set(a.data,d),a.size=a.data.byteLength,d+=a.size;else for(var u,c=new DataView(s.buffer),p=function(e,i){i=t[f];var r=0;i.units.forEach(function(t){c.setUint32(e,t.byteLength),e+=4,s.set(t,e),e+=t.byteLength,r+=4+t.byteLength}),i.size=r,g=e,u=i},f=0,m=t.length,g=0;f<m;f++)p(g,u);var _=o.mdat(s),v=o.moof([e]);return(0,n.Cs)(v,_)}},{key:"_remuxAudio",value:function(){var e=this.audioTrack,t=new Uint8Array(e.samples.reduce(function(e,t){return e+t.size},0));e.samples.reduce(function(e,i){return t.set(i.data,e),e+i.size},0);var i=o.mdat(t),r=o.moof([e]);return(0,n.Cs)(r,i)}},{key:"reset",value:function(){this.videoTrack.reset(),this.audioTrack.reset()}}])},9633:function(e,t,i){"use strict";i.d(t,{V:function(){return s}});var r=i(63847),s=function(){function e(t,i){(0,r.xs)(this,e),this.name=t||"",this._prefix="[".concat(this.name,"]"),e.disabled=i}return(0,r.j6)(e,[{key:"debug",value:function(){var t;if(!e.disabled){for(var i=arguments.length,r=Array(i),s=0;s<i;s++)r[s]=arguments[s];(t=console).debug.apply(t,[this._prefix].concat(r))}}},{key:"log",value:function(){var t;if(!e.disabled){for(var i=arguments.length,r=Array(i),s=0;s<i;s++)r[s]=arguments[s];(t=console).log.apply(t,[this._prefix].concat(r))}}},{key:"warn",value:function(){var t;if(!e.disabled){for(var i=arguments.length,r=Array(i),s=0;s<i;s++)r[s]=arguments[s];(t=console).warn.apply(t,[this._prefix].concat(r))}}},{key:"error",value:function(){var t;if(!e.disabled){for(var i=arguments.length,r=Array(i),s=0;s<i;s++)r[s]=arguments[s];(t=console).error.apply(t,[this._prefix].concat(r))}}},{key:"table",value:function(){var t;e.disabled||(console.group(this._prefix),(t=console).table.apply(t,arguments),console.groupEnd())}}],[{key:"enable",value:function(){e.disabled=!1}},{key:"disable",value:function(){e.disabled=!0}}])}();(0,r.n8)(s,"disabled",!0)},55355:function(e,t,i){"use strict";function r(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];var r=new Uint8Array((t=t.filter(Boolean)).reduce(function(e,t){return e+t.byteLength},0)),s=0;return t.forEach(function(e){r.set(e,s),s+=e.byteLength}),r}function s(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(e[t]<<8)+(e[t+1]||0)}function n(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(e[t]<<16)+(e[t+1]<<8)+(e[t+2]||0)}function a(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(e[t]<<24>>>0)+(e[t+1]<<16)+(e[t+2]<<8)+(e[t+3]||0)}function o(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new DataView(e.buffer,e.byteOffset,e.byteLength).getInt32(t)}function l(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return 0x100000000*a(e,t)+a(e,t+4)}function h(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=new DataView(e.buffer,e.byteOffset,e.byteLength);return i.getUint32(t)<<32|i.getUint32(t+4)}function d(e){for(var t,i="avc1.",r=0;r<3;r++)(t=e[r].toString(16)).length<2&&(t="0".concat(t)),i+=t;return i}function u(e){if(!Array.isArray(e)){for(var t=[],i="",r=0;r<e.length;r++)r%2&&t.push(parseInt(i=e[r-1]+e[r],16));return t}return e.map(function(e){return parseInt(e,16)})}function c(e,t){return Number(e+"."+t)}function p(e){if(e.length<5)return 0;var t=Math.hypot(e[0],e[3]),i=Math.hypot(e[1],e[4]);return 0===t||0===i?0:180*Math.atan2(e[1]/i,e[0]/t)/Math.PI}i.d(t,{Cs:function(){return r},OU:function(){return h},ZT:function(){return c},ct:function(){return p},e$:function(){return s},hy:function(){return d},kl:function(){return a},nO:function(){return n},p1:function(){return o},qg:function(){return u},xV:function(){return l}})},37804:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(var t=0,i=arguments.length,r=Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];var n=!0,a=!1,o=void 0;try{for(var l,h=r[Symbol.iterator]();!(n=(l=h.next()).done);n=!0){var d=l.value;t+=d.length}}catch(e){a=!0,o=e}finally{try{!n&&h.return&&h.return()}finally{if(a)throw o}}var u=new e(t),c=0,p=!0,f=!1,m=void 0;try{for(var g,_=r[Symbol.iterator]();!(p=(g=_.next()).done);p=!0){var v=g.value;u.set(v,c),c+=v.length}}catch(e){f=!0,m=e}finally{try{!p&&_.return&&_.return()}finally{if(f)throw m}}return u}},87118:function(e,t,i){"use strict";var r;e.exports=((r=i(37804))&&r.__esModule?r:{default:r}).default},55651:function(e){var t,i=/^(?:0|[1-9]\d*)$/;function r(e,t,i){switch(i.length){case 0:return e.call(t);case 1:return e.call(t,i[0]);case 2:return e.call(t,i[0],i[1]);case 3:return e.call(t,i[0],i[1],i[2])}return e.apply(t,i)}var s=Object.prototype,n=s.hasOwnProperty,a=s.toString,o=s.propertyIsEnumerable,l=Math.max;function h(e,t,i,r){return void 0===e||c(e,s[i])&&!n.call(r,i)?t:e}function d(e,t){return t=l(void 0===t?e.length-1:t,0),function(){for(var i=arguments,s=-1,n=l(i.length-t,0),a=Array(n);++s<n;)a[s]=i[t+s];s=-1;for(var o=Array(t+1);++s<t;)o[s]=i[s];return o[t]=a,r(e,this,o)}}function u(e,t){return!!(t=null==t?0x1fffffffffffff:t)&&("number"==typeof e||i.test(e))&&e>-1&&e%1==0&&e<t}function c(e,t){return e===t||e!=e&&t!=t}var p=Array.isArray;function f(e){var t,i,r;return null!=e&&"number"==typeof(t=e.length)&&t>-1&&t%1==0&&t<=0x1fffffffffffff&&"[object Function]"!=(r=m(i=e)?a.call(i):"")&&"[object GeneratorFunction]"!=r}function m(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}var g=(t=function(e,t,i,r){var l;!function(e,t,i,r){i||(i={});for(var s=-1,a=t.length;++s<a;){var o=t[s],l=r?r(i[o],e[o],o,i,e):void 0;!function(e,t,i){var r=e[t];n.call(e,t)&&c(r,i)&&(void 0!==i||t in e)||(e[t]=i)}(i,o,void 0===l?e[o]:l)}}(t,f(l=t)?function(e,t){var i,r,s,l=p(e)||(s=r=i=e)&&"object"==typeof s&&f(r)&&n.call(i,"callee")&&(!o.call(i,"callee")||"[object Arguments]"==a.call(i))?function(e,t){for(var i=-1,r=Array(e);++i<e;)r[i]=t(i);return r}(e.length,String):[],h=l.length,d=!!h;for(var c in e)(t||n.call(e,c))&&!(d&&("length"==c||u(c,h)))&&l.push(c);return l}(l,!0):function(e){if(!m(e)){var t,i,r=e,a=[];if(null!=r)for(var o in Object(r))a.push(o);return a}var l=(i=(t=e)&&t.constructor,t===("function"==typeof i&&i.prototype||s)),h=[];for(var d in e)"constructor"==d&&(l||!n.call(e,d))||h.push(d);return h}(l),e,r)},d(function(e,i){var r=-1,s=i.length,n=s>1?i[s-1]:void 0,a=s>2?i[2]:void 0;for(n=t.length>3&&"function"==typeof n?(s--,n):void 0,a&&function(e,t,i){if(!m(i))return!1;var r=typeof t;return("number"==r?!!(f(i)&&u(t,i.length)):"string"==r&&t in i)&&c(i[t],e)}(i[0],i[1],a)&&(n=s<3?void 0:n,s=1),e=Object(e);++r<s;){var o=i[r];o&&t(e,o,r,n)}return e}));e.exports=d(function(e){return e.push(void 0,h),r(g,void 0,e)})},37634:function(e){!function(){"use strict";var t={}.hasOwnProperty;function i(){for(var e="",s=0;s<arguments.length;s++){var n=arguments[s];n&&(e=r(e,function(e){if("string"==typeof e||"number"==typeof e)return e;if("object"!=typeof e)return"";if(Array.isArray(e))return i.apply(null,e);if(e.toString!==Object.prototype.toString&&!e.toString.toString().includes("[native code]"))return e.toString();var s="";for(var n in e)t.call(e,n)&&e[n]&&(s=r(s,n));return s}(n)))}return e}function r(e,t){return t?e?e+" "+t:e+t:e}e.exports?(i.default=i,e.exports=i):"function"==typeof define&&"object"==typeof define.amd&&define.amd?define("classnames",[],function(){return i}):window.classNames=i}()},32224:function(e,t,i){"use strict";var r=i(50354),s=i(36001);t.A=function(e){return"number"==typeof e||(0,s.A)(e)&&"[object Number]"==(0,r.A)(e)}},98363:function(e,t,i){"use strict";let r,s;i.d(t,{g8:function(){return sA},y5:function(){return rI},Ay:function(){return sC}});var n,a=Object.defineProperty,o=(e,t,i)=>{let r;return(r="symbol"!=typeof t?t+"":t)in e?a(e,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[r]=i};class l{static getDefaultConfig(){return{rangeMaxDuration:15,rangeMinDuration:5,rangeMinSize:409600,safeFactor:.1,cacheSafeFactor:3,minDangerThreshold:5,estPlayTime:12,minBandwidth:1e6,estPTcontrol:!1,minTargetCacheDur:30,maxTargetCacheDur:60,targetCacheControl:!1,rangeControl:!1}}constructor(e,t,i,r){this.config=l.getDefaultConfig(),Object.keys(r).map(e=>{void 0!==r[e]&&null!==r[e]&&(this.config[e]=r[e])}),this.duration=i,this.player=e,this.updateBitrate(t)}updateBitrate(e){this.bitrate=e,this.bitrate||(this.bitrate=this.config.minBandwidth)}getAdaptLoadDuration(){let{player:e,config:t}=this;if(!t.rangeControl)return -1;let i=(null==e?void 0:e.bufferedPoint)||null,r=i&&i.end?i.end-e.currentTime:0;return Math.max(t.rangeMaxDuration-r,t.rangeMinDuration)}getAdaptCacheBuffer(){let{player:e,config:t,bitrate:i}=this;if(!t.targetCacheControl)return -1;let{estPlayTime:r}=t,s=r;t.estPTcontrol&&(s=Math.min(r,this.duration-((null==e?void 0:e.currentTime)||0)));let n=(null==e?void 0:e.avgSpeed)*1024||0,a=Math.max(t.safeFactor*n,t.minBandwidth);e&&e.avgSpeed&&(a=t.safeFactor*n);let o=i>0?Math.floor((1-a/i)*s):0;return o=t.minDangerThreshold+Math.max(o,0),Math.min(Math.max(t.cacheSafeFactor*o,t.minTargetCacheDur),t.maxTargetCacheDur)}}class h{static getDefaultConfig(){return{rangeControl:!1,rangeMaxDuration:20,rangeMinDuration:5,rangeMinSize:409600,rangeFloatSize:10240,safeFactor:.1,cacheSafeFactor:3,minDangerThreshold:5,estPlayTime:12,minBandwidth:1e6,estPTcontrol:!1,minTargetCacheDur:30,maxTargetCacheDur:60,targetCacheControl:!1}}constructor(e,t,i,r){this.config=h.getDefaultConfig(),Object.keys(r).map(e=>{void 0!==r[e]&&null!==r[e]&&(this.config[e]=r[e])}),this.duration=i,this.player=e,this.updateBitrate(t)}updateBitrate(e){this.bitrate=e,this.bitrate||(this.bitrate=this.config.minBandwidth)}getBuffer(){let{player:e}=this,t=(null==e?void 0:e.bufferedPoint)||null;return t&&t.end?t.end-e.currentTime:0}getAdaptLoadDuration(){let{config:e,duration:t}=this;if(!e.rangeControl)return -1;let i=this.getBuffer();return Math.max(Math.min(t-i,e.rangeMaxDuration-i),e.rangeMinDuration)}getAdaptRangeSize(e){let{config:t,bitrate:i,duration:r}=this;if(!t.rangeControl)return -1;e||(e=this.getAdaptLoadDuration());let s=this.getBuffer(),n=Math.max(t.rangeMinSize,e*i/8),a=(r-s)*i/8;return n+t.rangeFloatSize>=a&&(n=a),Math.ceil(n)}getAdaptCacheBuffer(){let{player:e,config:t,bitrate:i}=this;if(!t.targetCacheControl)return -1;let{estPlayTime:r}=t,s=r;t.estPTcontrol&&(s=Math.min(r,this.duration-((null==e?void 0:e.currentTime)||0)));let n=(null==e?void 0:e.avgSpeed)*1024||0,a=Math.max(t.safeFactor*n,t.minBandwidth);e&&e.avgSpeed&&(a=t.safeFactor*n);let o=i>0?Math.floor((1-a/i)*s):0;return o=t.minDangerThreshold+Math.max(o,0),Math.min(Math.max(t.cacheSafeFactor*o,t.minTargetCacheDur),t.maxTargetCacheDur)}}var d=((r=d||{}).CHANGE_FLYING_PLUGIN_CONFIG="CHANGE_FLYING_PLUGIN_CONFIG",r);function u(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t);if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}(r.key),r)}}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(p=function(){return!!e})()}function f(e,t){return(f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var m={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,i="~";function r(){}function s(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function n(e,t,r,n,a){if("function"!=typeof r)throw TypeError("The listener must be a function");var o=new s(r,n||e,a),l=i?i+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(i=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(i?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=i?i+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,n=r.length,a=Array(n);s<n;s++)a[s]=r[s].fn;return a},o.prototype.listenerCount=function(e){var t=i?i+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,n,a){var o=i?i+e:e;if(!this._events[o])return!1;var l,h,d=this._events[o],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,r),!0;case 4:return d.fn.call(d.context,t,r,s),!0;case 5:return d.fn.call(d.context,t,r,s,n),!0;case 6:return d.fn.call(d.context,t,r,s,n,a),!0}for(h=1,l=Array(u-1);h<u;h++)l[h-1]=arguments[h];d.fn.apply(d.context,l)}else{var c,p=d.length;for(h=0;h<p;h++)switch(d[h].once&&this.removeListener(e,d[h].fn,void 0,!0),u){case 1:d[h].fn.call(d[h].context);break;case 2:d[h].fn.call(d[h].context,t);break;case 3:d[h].fn.call(d[h].context,t,r);break;case 4:d[h].fn.call(d[h].context,t,r,s);break;default:if(!l)for(c=1,l=Array(u-1);c<u;c++)l[c-1]=arguments[c];d[h].fn.apply(d[h].context,l)}}return!0},o.prototype.on=function(e,t,i){return n(this,e,t,i,!1)},o.prototype.once=function(e,t,i){return n(this,e,t,i,!0)},o.prototype.removeListener=function(e,t,r,s){var n=i?i+e:e;if(!this._events[n])return this;if(!t)return a(this,n),this;var o=this._events[n];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||a(this,n);else{for(var l=0,h=[],d=o.length;l<d;l++)(o[l].fn!==t||s&&!o[l].once||r&&o[l].context!==r)&&h.push(o[l]);h.length?this._events[n]=1===h.length?h[0]:h:a(this,n)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=i,o.EventEmitter=o,e.exports=o}(m);var g=m.exports;let _=g&&g.__esModule&&Object.prototype.hasOwnProperty.call(g,"default")?g.default:g;var v={},y=null,A=function(e){var t,i;function r(){var e,t;return function(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}(this,r),e=r,t=arguments,e=c(e),function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,p()?Reflect.construct(e,t||[],c(this).constructor):e.apply(this,t))}return function(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&f(e,t)}(r,e),t=[{key:"add",value:function(e){e&&(v[e.playerId]=e,1===Object.keys(v).length&&this.setActive(e.playerId,!0))}},{key:"remove",value:function(e){e&&(e.isUserActive,delete v[e.playerId])}},{key:"_iterate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];for(var i in v)if(Object.prototype.hasOwnProperty.call(v,i)){var r=v[i];if(t){if(e(r))break}else e(r)}}},{key:"forEach",value:function(e){this._iterate(e)}},{key:"find",value:function(e){var t=null;return this._iterate(function(i){var r=e(i);return r&&(t=i),r},!0),t}},{key:"findAll",value:function(e){var t=[];return this._iterate(function(i){e(i)&&t.push(i)}),t}},{key:"setActive",value:function(e){var t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(v[e])return t?this.forEach(function(t){e===t.playerId?(t.isUserActive=!0,t.isInstNext=!1):t.isUserActive=!1}):v[e].isUserActive=t,e}},{key:"getActiveId",value:function(){for(var e=Object.keys(v),t=0;t<e.length;t++){var i=v[e[t]];if(i&&i.isUserActive)return e[t]}return null}},{key:"setNext",value:function(e){var t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(v[e])return t?this.forEach(function(t){e===t.playerId?(t.isUserActive=!1,t.isInstNext=!0):t.isInstNext=!1}):v[e].isInstNext=t,e}}],i=[{key:"getInstance",value:function(){return y||(y=new r),y}}],t&&u(r.prototype,t),i&&u(r,i),Object.defineProperty(r,"prototype",{writable:!1}),r}(g.EventEmitter);let T=null;class b extends(A||Object.prototype.constructor){constructor(){super(...arguments),this._ploys=[]}static getInstance(){return T||(T=new b),T}_findIndexFromPloys(e){let t=-1,i=this._ploys;for(let r=0;r<i.length;r++)if(i[r]===e){t=r;break}return t}_checkStrategy(e){return!(!(null!=e&&e.start)||!e.stop||this._findIndexFromPloys(e)>-1)}registerStrategy(e){e&&(Array.isArray(e)||(e=[e]),e.filter(e=>!!e).forEach(e=>{let{Strategy:t,config:i}=e;try{let e=new t(i,this);this._checkStrategy(e)&&(e.start(),this._ploys.push(e))}catch(e){console.log("InstStrategy Error:",e)}}))}unregisterStrategy(e){if(e){e.stop();let t=this._findIndexFromPloys(e);t>-1&&this._ploys.splice(t,1)}else this._ploys.forEach(e=>{e.stop()}),this._ploys.splice(0,this._ploys.length)}setActive(e,t){let i=super.setActive(e,t);return this.emit("UPDATE_INST_ORDER"),i}setNext(e){let t=super.setNext(e);return this.emit("UPDATE_INST_ORDER"),t}}var S=((s=S||{}).UPDATE_INST_ORDER="UPDATE_INST_ORDER",s);function E(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,r)}return i}function k(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?E(Object(i),!0).forEach(function(t){R(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):E(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function P(){P=function(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,r=Object.defineProperty||function(e,t,i){e[t]=i.value},s="function"==typeof Symbol?Symbol:{},n=s.iterator||"@@iterator",a=s.asyncIterator||"@@asyncIterator",o=s.toStringTag||"@@toStringTag";function l(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch{l=function(e,t,i){return e[t]=i}}function h(e,t,i,s){var n,a,o,l,h=Object.create((t&&t.prototype instanceof c?t:c).prototype);return r(h,"_invoke",{value:(n=e,a=i,o=new S(s||[]),l="suspendedStart",function(e,t){if("executing"===l)throw Error("Generator is already running");if("completed"===l){if("throw"===e)throw t;return k()}for(o.method=e,o.arg=t;;){var i=o.delegate;if(i){var r=function e(t,i){var r=i.method,s=t.iterator[r];if(void 0===s)return i.delegate=null,"throw"===r&&t.iterator.return&&(i.method="return",i.arg=void 0,e(t,i),"throw"===i.method)||"return"!==r&&(i.method="throw",i.arg=TypeError("The iterator does not provide a '"+r+"' method")),u;var n=d(s,t.iterator,i.arg);if("throw"===n.type)return i.method="throw",i.arg=n.arg,i.delegate=null,u;var a=n.arg;return a?a.done?(i[t.resultName]=a.value,i.next=t.nextLoc,"return"!==i.method&&(i.method="next",i.arg=void 0),i.delegate=null,u):a:(i.method="throw",i.arg=TypeError("iterator result is not an object"),i.delegate=null,u)}(i,o);if(r){if(r===u)continue;return r}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if("suspendedStart"===l)throw l="completed",o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);l="executing";var s=d(n,a,o);if("normal"===s.type){if(l=o.done?"completed":"suspendedYield",s.arg===u)continue;return{value:s.arg,done:o.done}}"throw"===s.type&&(l="completed",o.method="throw",o.arg=s.arg)}})}),h}function d(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=h;var u={};function c(){}function p(){}function f(){}var m={};l(m,n,function(){return this});var g=Object.getPrototypeOf,_=g&&g(g(E([])));_&&_!==t&&i.call(_,n)&&(m=_);var v=f.prototype=c.prototype=Object.create(m);function y(e){["next","throw","return"].forEach(function(t){l(e,t,function(e){return this._invoke(t,e)})})}function A(e,t){var s;r(this,"_invoke",{value:function(r,n){function a(){return new t(function(s,a){!function r(s,n,a,o){var l=d(e[s],e,n);if("throw"!==l.type){var h=l.arg,u=h.value;return u&&"object"==typeof u&&i.call(u,"__await")?t.resolve(u.__await).then(function(e){r("next",e,a,o)},function(e){r("throw",e,a,o)}):t.resolve(u).then(function(e){h.value=e,a(h)},function(e){return r("throw",e,a,o)})}o(l.arg)}(r,n,s,a)})}return s=s?s.then(a,a):a()}})}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function b(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function E(e){if(e){var t=e[n];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,s=function t(){for(;++r<e.length;)if(i.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return s.next=s}}return{next:k}}function k(){return{value:void 0,done:!0}}return p.prototype=f,r(v,"constructor",{value:f,configurable:!0}),r(f,"constructor",{value:p,configurable:!0}),p.displayName=l(f,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,l(e,o,"GeneratorFunction")),e.prototype=Object.create(v),e},e.awrap=function(e){return{__await:e}},y(A.prototype),l(A.prototype,a,function(){return this}),e.AsyncIterator=A,e.async=function(t,i,r,s,n){void 0===n&&(n=Promise);var a=new A(h(t,i,r,s),n);return e.isGeneratorFunction(i)?a:a.next().then(function(e){return e.done?e.value:a.next()})},y(v),l(v,o,"Generator"),l(v,n,function(){return this}),l(v,"toString",function(){return"[object Generator]"}),e.keys=function(e){var t=Object(e),i=[];for(var r in t)i.push(r);return i.reverse(),function e(){for(;i.length;){var r=i.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},e.values=E,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(b),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(i,r){return a.type="throw",a.arg=e,t.next=i,r&&(t.method="next",t.arg=void 0),!!r}for(var s=this.tryEntries.length-1;s>=0;--s){var n=this.tryEntries[s],a=n.completion;if("root"===n.tryLoc)return r("end");if(n.tryLoc<=this.prev){var o=i.call(n,"catchLoc"),l=i.call(n,"finallyLoc");if(o&&l){if(this.prev<n.catchLoc)return r(n.catchLoc,!0);if(this.prev<n.finallyLoc)return r(n.finallyLoc)}else if(o){if(this.prev<n.catchLoc)return r(n.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<n.finallyLoc)return r(n.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var s=this.tryEntries[r];if(s.tryLoc<=this.prev&&i.call(s,"finallyLoc")&&this.prev<s.finallyLoc){var n=s;break}}n&&("break"===e||"continue"===e)&&n.tryLoc<=t&&t<=n.finallyLoc&&(n=null);var a=n?n.completion:{};return a.type=e,a.arg=t,n?(this.method="next",this.next=n.finallyLoc,u):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),b(i),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var s=r.arg;b(i)}return s}}throw Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:E(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=void 0),u}},e}function w(e){return(w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function x(e,t,i,r,s,n,a){try{var o=e[n](a),l=o.value}catch(e){i(e);return}o.done?t(l):Promise.resolve(l).then(r,s)}function C(e){return function(){var t=this,i=arguments;return new Promise(function(r,s){var n=e.apply(t,i);function a(e){x(n,r,s,a,o,"next",e)}function o(e){x(n,r,s,a,o,"throw",e)}a(void 0)})}}function L(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function D(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,G(r.key),r)}}function I(e,t,i){return t&&D(e.prototype,t),i&&D(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function R(e,t,i){return(t=G(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function O(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&B(e,t)}function M(e){return(M=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function B(e,t){return(B=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function N(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function U(e,t,i){return(U=N()?Reflect.construct.bind():function(e,t,i){var r=[null];r.push.apply(r,t);var s=new(Function.bind.apply(e,r));return i&&B(s,i.prototype),s}).apply(null,arguments)}function F(e){var t="function"==typeof Map?new Map:void 0;return(F=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw TypeError("Super expression must either be null or a function");if("u">typeof t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return U(e,arguments,M(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),B(i,e)})(e)}function V(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function $(e){var t=N();return function(){var i,r=M(e);i=t?Reflect.construct(r,arguments,M(this).constructor):r.apply(this,arguments);if(i&&("object"==typeof i||"function"==typeof i))return i;if(void 0!==i)throw TypeError("Derived constructors may only return object or undefined");return V(this)}}function z(){return(z="u">typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,i){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=M(e)););return e}(e,t);if(r){var s=Object.getOwnPropertyDescriptor(r,t);return s.get?s.get.call(arguments.length<3?e:i):s.value}}).apply(this,arguments)}function j(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=Array(t);i<t;i++)r[i]=e[i];return r}function G(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t);if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function H(){var e,t,i=new Promise(function(i,r){e=i,t=r});return i.used=!1,i.resolve=function(){return i.used=!0,e.apply(void 0,arguments)},i.reject=function(){return i.used=!0,t.apply(void 0,arguments)},i}var W=["Boolean","Number","String","Undefined","Null","Date","Object"],q=function(){function e(t,i){L(this,e),this.name=t||"",this._prefix="[".concat(this.name,"]"),this.logCacheLevel=(null==i?void 0:i.logCacheLevel)||3,this.logMaxSize=(null==i?void 0:i.logMaxSize)||204800,this.logSize=0,this.logTextArray=[]}return I(e,[{key:"debug",value:function(){for(var t,i=arguments.length,r=Array(i),s=0;s<i;s++)r[s]=arguments[s];this.logCache.apply(this,[1].concat(r)),e.disabled||(t=console).debug.apply(t,[this._prefix,K()].concat(r))}},{key:"log",value:function(){for(var t,i=arguments.length,r=Array(i),s=0;s<i;s++)r[s]=arguments[s];this.logCache.apply(this,[2].concat(r)),e.disabled||(t=console).log.apply(t,[this._prefix,K()].concat(r))}},{key:"warn",value:function(){for(var t,i=arguments.length,r=Array(i),s=0;s<i;s++)r[s]=arguments[s];this.logCache.apply(this,[3].concat(r)),e.disabled||(t=console).warn.apply(t,[this._prefix,K()].concat(r))}},{key:"error",value:function(){for(var t,i=arguments.length,r=Array(i),s=0;s<i;s++)r[s]=arguments[s];this.logCache.apply(this,[4].concat(r)),e.disabled||(t=console).error.apply(t,[this._prefix,K()].concat(r))}},{key:"logCache",value:function(e){if(!(e<this.logCacheLevel)){var t="";try{for(var i=arguments.length,r=Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];var n=r.map(function(e){return function e(t,i,r){r||(r=1),i||(i=2);var s={};if(!t||"object"!==w(t))return t;var n=Object.prototype.toString.call(t).slice(8,-1);if(!W.includes(n))return n;if(!(r>i)){for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(r===i?s[a]=function(e){if("object"!==w(e))return e;var t=Object.prototype.toString.call(e).slice(8,-1);switch(t){case"Array":case"Uint8Array":case"ArrayBuffer":return t+"["+e.length+"]";case"Object":return"{}";default:return t}}(t[a]):"object"===w(t[a])?s[a]=e(t[a],i,r+1):s[a]=t[a]);return s}}(e)});t=this._prefix+K()+JSON.stringify(n)}catch{return}if(e>=this.logCacheLevel&&(this.logSize+=t.length,this.logTextArray.push(t)),this.logSize>this.logMaxSize){var a=this.logTextArray.shift();this.logSize-=a.length}}}},{key:"getLogCache",value:function(){var e=this.logTextArray.join(`
`);return this.reset(),e}},{key:"reset",value:function(){this.logTextArray=[],this.logSize=0}},{key:"table",value:function(){var t;e.disabled||(console.group(this._prefix),(t=console).table.apply(t,arguments),console.groupEnd())}},{key:"setLogLevel",value:function(e){this.logCacheLevel=e}}],[{key:"enable",value:function(){e.disabled=!1}},{key:"disable",value:function(){e.disabled=!0}}]),e}();function K(){return new Date().toLocaleString()}R(q,"disabled",!0);var Y="fetch",X="arraybuffer",Q="text",J="json",Z=function(e){O(i,e);var t=$(i);function i(e,r,s,n){var a;return L(this,i),R(V(a=t.call(this,n)),"retryCount",0),R(V(a),"isTimeout",!1),R(V(a),"loaderType",Y),R(V(a),"startTime",0),R(V(a),"endTime",0),R(V(a),"options",{}),a.url=e,a.request=r,a.response=s,a}return I(i)}(F(Error)),ee=Object.prototype.toString;function et(e){if("[object Object]"!==ee.call(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function ei(e){if(!(!e||null===e[0]||void 0===e[0]||0===e[0]&&(null===e[1]||void 0===e[1]))){var t="bytes="+e[0]+"-";return e[1]&&(t+=e[1]),t}}function er(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function es(e,t){if(e){if(!t)return e;var i,r=Object.keys(t).map(function(e){if(null!=(i=t[e]))return Array.isArray(i)?e+="[]":i=[i],i.map(function(t){var i,r;return(i=t,"[object Date]"===ee.call(i))?t=t.toISOString():null!==(r=t)&&"object"===w(r)&&(t=JSON.stringify(t)),"".concat(er(e),"=").concat(er(t))}).join("&")}).filter(Boolean).join("&");if(r){var s=e.indexOf("#");-1!==s&&(e=e.slice(0,s)),e+=(-1===e.indexOf("?")?"?":"&")+r}return e}}function en(e,t,i,r,s,n,a,o,l,h,d){return s=null!=s?parseFloat(s):null,Number.isNaN(r=parseInt(r||"0",10))&&(r=0),{data:e,done:t,options:{range:l,vid:h,index:o,contentLength:r,age:s,startTime:n,firstByteTime:a,endTime:Date.now(),priOptions:d},response:i}}function ea(e,t){return Math.round(8*e*1e3/t/1024)}var eo="real_time_speed",el=function(e){O(r,e);var t,i=$(r);function r(){var e;return L(this,r),R(V(e=i.call(this)),"_abortController",null),R(V(e),"_timeoutTimer",null),R(V(e),"_reader",null),R(V(e),"_response",null),R(V(e),"_aborted",!1),R(V(e),"_index",-1),R(V(e),"_range",null),R(V(e),"_receivedLength",0),R(V(e),"_running",!1),R(V(e),"_logger",null),R(V(e),"_vid",""),R(V(e),"_onProcessMinLen",0),R(V(e),"_onCancel",null),R(V(e),"_priOptions",null),e}return I(r,[{key:"load",value:function(e){var t,i=this,r=e.url,s=e.vid,n=e.timeout,a=e.responseType,o=e.onProgress,l=e.index,h=e.onTimeout,d=e.onCancel,u=e.range,c=e.transformResponse,p=e.request,f=e.params,m=e.logger,g=e.method,_=e.headers,v=e.body,y=e.mode,A=e.credentials,T=e.cache,b=e.redirect,S=e.referrer,E=e.referrerPolicy,k=e.onProcessMinLen,w=e.priOptions;this._logger=m,this._aborted=!1,this._onProcessMinLen=k,this._onCancel=d,this._abortController="u">typeof AbortController&&new AbortController,this._running=!0,this._index=l,this._range=u||[0,0],this._vid=s||r,this._priOptions=w||{};var x={method:g,headers:_,body:v,mode:y,credentials:A,cache:T,redirect:b,referrer:S,referrerPolicy:E,signal:null==(t=this._abortController)?void 0:t.signal},L=!1;clearTimeout(this._timeoutTimer),r=es(r,f);var D=ei(u);D&&(_=p?p.headers:x.headers=x.headers||(Headers?new Headers:{}),Headers&&_ instanceof Headers?_.append("Range",D):_.Range=D),n&&(this._timeoutTimer=setTimeout(function(){if(L=!0,i.cancel(),h){var e=new Z(r,x,null,"timeout");e.isTimeout=!0,h(e,{index:i._index,range:i._range,vid:i._vid,priOptions:i._priOptions})}},n));var I=Date.now();return this._logger.debug("[fetch load start], index,",l,",range,",u),new Promise(function(e,t){var s;fetch(p||r,p?void 0:x).then((s=C(P().mark(function s(n){var h,d,p,f;return P().wrap(function(s){for(;;)switch(s.prev=s.next){case 0:if(clearTimeout(i._timeoutTimer),i._response=n,!(i._aborted||!i._running)){s.next=4;break}return s.abrupt("return");case 4:if(c&&(n=c(n,r)||n),n.ok){s.next=7;break}throw new Z(r,x,n,"bad network response");case 7:if(h=Date.now(),a!==Q){s.next=15;break}return s.next=11,n.text();case 11:case 18:d=s.sent,i._running=!1,s.next=37;break;case 15:if(a!==J){s.next=22;break}return s.next=18,n.json();case 22:if(!o){s.next=29;break}return i.resolve=e,i.reject=t,i._loadChunk(n,o,I,h),s.abrupt("return");case 29:return s.next=31,n.arrayBuffer();case 31:d=new Uint8Array(d=s.sent),i._running=!1,p=Date.now()-I,f=ea(d.byteLength,p),i.emit(eo,{speed:f,len:d.byteLength,time:p,vid:i._vid,index:i._index,range:i._range,priOptions:i._priOptions});case 37:i._logger.debug("[fetch load end], index,",l,",range,",u),e(en(d,!0,n,n.headers.get("Content-Length"),n.headers.get("age"),I,h,l,u,i._vid,i._priOptions));case 39:case"end":return s.stop()}},s)})),function(e){return s.apply(this,arguments)})).catch(function(e){var s;clearTimeout(i._timeoutTimer),i._running=!1,i._aborted&&!L||((e=e instanceof Z?e:new Z(r,x,null,null==(s=e)?void 0:s.message)).startTime=I,e.endTime=Date.now(),e.isTimeout=L,e.options={index:i._index,range:i._range,vid:i._vid,priOptions:i._priOptions},t(e))})})}},{key:"cancel",value:(t=C(P().mark(function e(){return P().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._aborted){e.next=2;break}return e.abrupt("return");case 2:if(this._aborted=!0,this._running=!1,!this._response){e.next=14;break}if(e.prev=5,!this._reader){e.next=9;break}return e.next=9,this._reader.cancel();case 9:e.next=13;break;case 11:e.prev=11,e.t0=e.catch(5);case 13:this._response=this._reader=null;case 14:if(this._abortController){try{this._abortController.abort()}catch{}this._abortController=null}this._onCancel&&this._onCancel({index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions});case 16:case"end":return e.stop()}},e,this,[[5,11]])})),function(){return t.apply(this,arguments)})},{key:"_loadChunk",value:function(e,t,i,r){var s=this;if(!e.body||!e.body.getReader){this._running=!1;var n=new Z(e.url,"",e,"onProgress of bad response.body.getReader");n.options={index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions},this.reject(n);return}this._onProcessMinLen>0&&(this._cache=new Uint8Array(2097152),this._writeIdx=0);var a,o,l,h,d=this._reader=e.body.getReader(),u=(a=C(P().mark(function n(){var a,c,p,f,m,g,_,v;return P().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return l=Date.now(),n.prev=1,n.next=4,d.read();case 4:o=n.sent,h=Date.now(),n.next=13;break;case 8:return n.prev=8,n.t0=n.catch(1),h=Date.now(),s._aborted||(s._running=!1,n.t0.options={index:s._index,range:s._range,vid:s._vid,priOptions:s._priOptions},s.reject(n.t0)),n.abrupt("return");case 13:if(p=(c=(null==(a=s._range)?void 0:a.length)>0?s._range[0]:0)+s._receivedLength,!s._aborted){n.next=19;break}return s._running=!1,t(void 0,!1,{range:[p,p],vid:s._vid,index:s._index,startTime:l,endTime:h,st:i,firstByteTime:r,priOptions:s._priOptions},e),n.abrupt("return");case 19:f=o.value?o.value.byteLength:0,s._receivedLength+=f,s._logger.debug("\u3010fetchLoader,onProgress call\u3011,task,",s._range,", start,",p,", end,",c+s._receivedLength,", done,",o.done),s._onProcessMinLen>0?s._writeIdx+f>=s._onProcessMinLen||o.done?((m=new Uint8Array(s._writeIdx+f)).set(s._cache.slice(0,s._writeIdx),0),f>0&&m.set(o.value,s._writeIdx),s._writeIdx=0,s._logger.debug("\u3010fetchLoader,onProgress enough\u3011,done,",o.done,",len,",m.byteLength,", writeIdx,",s._writeIdx)):f>0&&s._writeIdx+f<2097152?(s._cache.set(o.value,s._writeIdx),s._writeIdx+=f,s._logger.debug("\u3010fetchLoader,onProgress cache\u3011,len,",f,", writeIdx,",s._writeIdx)):f>0&&(g=new Uint8Array(s._writeIdx+f+2048),s._logger.debug("\u3010fetchLoader,onProgress extra start\u3011,size,",s._writeIdx+f+2048,", datalen,",f,", writeIdx,",s._writeIdx),g.set(s._cache.slice(0,s._writeIdx),0),f>0&&g.set(o.value,s._writeIdx),s._writeIdx+=f,delete s._cache,s._cache=g,s._logger.debug("\u3010fetchLoader,onProgress extra end\u3011,len,",f,", writeIdx,",s._writeIdx)):m=o.value,(m&&m.byteLength>0||o.done)&&t(m,o.done,{range:[s._range[0]+s._receivedLength-(m?m.byteLength:0),s._range[0]+s._receivedLength],vid:s._vid,index:s._index,startTime:l,endTime:h,st:i,firstByteTime:r,priOptions:s._priOptions},e),o.done?(_=Date.now()-i,v=ea(s._receivedLength,_),s.emit(eo,{speed:v,len:s._receivedLength,time:_,vid:s._vid,index:s._index,range:s._range,priOptions:s._priOptions}),s._running=!1,s._logger.debug("[fetchLoader onProgress end],task,",s._range,",done,",o.done),s.resolve(en(o,!0,e,e.headers.get("Content-Length"),e.headers.get("age"),i,r,s._index,s._range,s._vid,s._priOptions))):u();case 25:case"end":return n.stop()}},n,null,[[1,8]])})),function(){return a.apply(this,arguments)});u()}},{key:"receiveLen",get:function(){return this._receivedLength}},{key:"running",get:function(){return this._running},set:function(e){this._running=e}}],[{key:"isSupported",value:function(){return"u">typeof fetch}}]),r}(_),eh=function(e){O(i,e);var t=$(i);function i(){var e;return L(this,i),R(V(e=t.call(this)),"_xhr",null),R(V(e),"_aborted",!1),R(V(e),"_timeoutTimer",null),R(V(e),"_range",null),R(V(e),"_receivedLength",0),R(V(e),"_url",null),R(V(e),"_onProgress",null),R(V(e),"_index",-1),R(V(e),"_headers",null),R(V(e),"_currentChunkSizeKB",384),R(V(e),"_timeout",null),R(V(e),"_xhr",null),R(V(e),"_withCredentials",null),R(V(e),"_startTime",-1),R(V(e),"_loadCompleteResolve",null),R(V(e),"_loadCompleteReject",null),R(V(e),"_runing",!1),R(V(e),"_logger",!1),R(V(e),"_vid",""),R(V(e),"_responseType",void 0),R(V(e),"_credentials",void 0),R(V(e),"_method",void 0),R(V(e),"_transformResponse",void 0),R(V(e),"_firstRtt",void 0),R(V(e),"_onCancel",null),R(V(e),"_priOptions",null),e}return I(i,[{key:"load",value:function(e){var t=this;clearTimeout(this._timeoutTimer),this._logger=e.logger,this._range=e.range,this._onProgress=e.onProgress,this._index=e.index,this._headers=e.headers,this._withCredentials="include"===e.credentials||"same-origin"===e.credentials,this._body=e.body||null,e.method&&(this._method=e.method),this._timeout=e.timeout||null,this._runing=!0,this._vid=e.vid||e.url,this._responseType=e.responseType,this._firstRtt=-1,this._onTimeout=e.onTimeout,this._onCancel=e.onCancel,this._request=e.request,this._priOptions=e.priOptions||{},this._logger.debug("\u3010xhrLoader task\u3011, range",this._range),this._url=es(e.url,e.params);var i=Date.now();return new Promise(function(e,i){t._loadCompleteResolve=e,t._loadCompleteReject=i,t._startLoad()}).catch(function(e){if(clearTimeout(t._timeoutTimer),t._runing=!1,!t._aborted)throw(e=e instanceof Z?e:new Z(t._url,t._request)).startTime=i,e.endTime=Date.now(),e.options={index:t._index,vid:t._vid,priOptions:t._priOptions},e})}},{key:"_startLoad",value:function(){var e=null;if(this._responseType===X&&this._range&&this._range.length>1)if(this._onProgress){this._firstRtt=-1;var t=1024*this._currentChunkSizeKB,i=this._range[0]+this._receivedLength,r=this._range[1];t<this._range[1]-i&&(r=i+t),e=[i,r],this._logger.debug("[xhr_loader->],tast :",this._range,", SubRange, ",e)}else e=this._range,this._logger.debug("[xhr_loader->],tast :",this._range,", allRange, ",e);this._internalOpen(e)}},{key:"_internalOpen",value:function(e){var t=this;try{this._startTime=Date.now();var i=this._xhr=new XMLHttpRequest;i.open(this._method||"GET",this._url,!0),i.responseType=this._responseType,this._timeout&&(i.timeout=this._timeout),i.withCredentials=this._withCredentials,i.onload=this._onLoad.bind(this),i.onreadystatechange=this._onReadyStatechange.bind(this),i.onerror=function(e){t._running=!1;var i,r,s,n=new Z(t._url,t._request,null==e||null==(i=e.currentTarget)?void 0:i.response,"xhr.onerror.status:"+(null==e||null==(r=e.currentTarget)?void 0:r.status)+",statusText,"+(null==e||null==(s=e.currentTarget)?void 0:s.statusText));n.options={index:t._index,range:t._range,vid:t._vid,priOptions:t._priOptions},t._loadCompleteReject(n)},i.ontimeout=function(e){t.cancel();var i=new Z(t._url,t._request,{status:408},"timeout");t._onTimeout&&(i.isTimeout=!0,t._onTimeout(i,{index:t._index,range:t._range,vid:t._vid,priOptions:t._priOptions})),i.options={index:t._index,range:t._range,vid:t._vid,priOptions:t._priOptions},t._loadCompleteReject(i)};var r=this._headers||{},s=ei(e);s&&(r.Range=s),r&&Object.keys(r).forEach(function(e){i.setRequestHeader(e,r[e])}),this._logger.debug("[xhr.send->] tast,",this._range,",load sub range, ",e),i.send(this._body)}catch(t){t.options={index:this._index,range:e,vid:this._vid,priOptions:this._priOptions},this._loadCompleteReject(t)}}},{key:"_onReadyStatechange",value:function(e){2===e.target.readyState&&this._firstRtt<0&&(this._firstRtt=Date.now())}},{key:"_onLoad",value:function(e){var t,i=e.target.status;if(i<200||i>299){var r=new Z(this._url,null,k(k({},e.target.response),{},{status:i}),"bad response,status:"+i);return r.options={index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions},this._loadCompleteReject(r)}var s,n=null,a=!1,o=(null==(t=this._range)?void 0:t.length)>0?this._range[0]:0;if(this._responseType===X){var l,h=new Uint8Array(e.target.response);if(s=o+this._receivedLength,h&&h.byteLength>0){this._receivedLength+=h.byteLength;var d=Date.now()-this._startTime,u=ea(this._receivedLength,d);this.emit(eo,{speed:u,len:this._receivedLength,time:d,vid:this._vid,index:this._index,range:[s,o+this._receivedLength],priOptions:this._priOptions})}n=h,a=!((null==(l=this._range)?void 0:l.length)>1)||!this._range[1]||!(this._receivedLength<this._range[1]-this._range[0]),this._logger.debug("[xhr load done->], tast :",this._range,", start",s,"end ",o+this._receivedLength,",dataLen,",h?h.byteLength:0,",receivedLength",this._receivedLength,",index,",this._index,", done,",a)}else a=!0,n=e.target.response;var c={ok:i>=200&&i<300,status:i,statusText:this._xhr.statusText,url:this._xhr.responseURL,headers:this._getHeaders(this._xhr),body:this._xhr.response};this._transformResponse&&(c=this._transformResponse(c,this._url)||c),this._onProgress&&this._onProgress(n,a,{index:this._index,vid:this._vid,range:[s,o+this._receivedLength],startTime:this._startTime,endTime:Date.now(),priOptions:this._priOptions},c),a?(this._runing=!1,this._loadCompleteResolve&&this._loadCompleteResolve(en(this._onProgress?null:n,a,c,c.headers["content-length"],c.headers.age,this._startTime,this._firstRtt,this._index,this._range,this._vid,this._priOptions))):this._startLoad()}},{key:"cancel",value:function(){if(!this._aborted&&(this._aborted=!0,this._runing=!1,z(M(i.prototype),"removeAllListeners",this).call(this),this._onCancel&&this._onCancel({index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions}),this._xhr))return this._xhr.abort()}},{key:"receiveLen",get:function(){return this._receivedLength}},{key:"running",get:function(){return this._running},set:function(e){this._running=e}},{key:"_getHeaders",value:function(e){var t,i=e.getAllResponseHeaders().trim().split(`\r
`),r={},s=function(e,t){var i="u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=function(e,t){if(e){if("string"==typeof e)return j(e,void 0);var i=Object.prototype.toString.call(e).slice(8,-1);if("Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return j(e,void 0)}}(e))){i&&(e=i);var r=0,s=function(){};return{s:s,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:s}}throw TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var n,a=!0,o=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return a=e.done,e},e:function(e){o=!0,n=e},f:function(){try{a||null==i.return||i.return()}finally{if(o)throw n}}}}(i);try{for(s.s();!(t=s.n()).done;){var n=t.value.split(": ");r[n[0].toLowerCase()]=n.slice(1).join(": ")}}catch(e){s.e(e)}finally{s.f()}return r}}],[{key:"isSupported",value:function(){return"u">typeof XMLHttpRequest}}]),i}(_),ed=["retry","retryDelay","onRetryError","transformError"],eu=function(){var e;function t(e,i){L(this,t),this.promise=H(),this.alive=!!i.onProgress,i.logger||(i.logger=new q("Loader")),this._loaderType=e,this._loader=e===Y&&window.fetch?new el:new eh,this._config=i,this._retryCount=0,this._retryTimer=null,this._canceled=!1,this._retryCheckFunc=i.retryCheckFunc,this._logger=i.logger}return I(t,[{key:"exec",value:function(){var e,t=this,i=this._config,r=i.retry,s=i.retryDelay,n=i.onRetryError,a=i.transformError,o=function(e,t){if(null==e)return{};var i,r,s=function(e,t){if(null==e)return{};var i,r,s={},n=Object.keys(e);for(r=0;r<n.length;r++)i=n[r],t.indexOf(i)>=0||(s[i]=e[i]);return s}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(r=0;r<n.length;r++)i=n[r],!(t.indexOf(i)>=0)&&Object.prototype.propertyIsEnumerable.call(e,i)&&(s[i]=e[i])}return s}(i,ed),l=(e=C(P().mark(function e(){var i,h,d;return P().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t._loader.load(o);case 3:i=e.sent,t.promise.resolve(i),e.next=27;break;case 7:if(e.prev=7,e.t0=e.catch(0),t._loader.running=!1,t._logger.debug("[task request catch err]",e.t0),!t._canceled){e.next=13;break}return e.abrupt("return");case 13:if(e.t0.loaderType=t._loaderType,e.t0.retryCount=t._retryCount,h=e.t0,a&&(h=a(h)||h),n&&t._retryCount>0&&n(h,t._retryCount,{index:o.index,vid:o.vid,range:o.range,priOptions:o.priOptions}),t._retryCount++,d=!0,t._retryCheckFunc&&(d=t._retryCheckFunc(e.t0)),!(d&&t._retryCount<=r)){e.next=26;break}return clearTimeout(t._retryTimer),t._logger.debug("[task request setTimeout],retry",t._retryCount,",retry range,",o.range),t._retryTimer=setTimeout(l,s),e.abrupt("return");case 26:t.promise.reject(h);case 27:case"end":return e.stop()}},e,null,[[0,7]])})),function(){return e.apply(this,arguments)});return l(),this.promise}},{key:"cancel",value:(e=C(P().mark(function e(){return P().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return clearTimeout(this._retryTimer),this._canceled=!0,this._loader.running=!1,e.abrupt("return",this._loader.cancel());case 4:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"running",get:function(){return this._loader&&this._loader.running}},{key:"loader",get:function(){return this._loader}}]),t}(),ec=function(e){O(r,e);var t,i=$(r);function r(e){var t;return L(this,r),R(V(t=i.call(this,e)),"type",Y),R(V(t),"_queue",[]),R(V(t),"_alive",[]),R(V(t),"_currentTask",null),R(V(t),"_config",void 0),t._config=k({loaderType:Y,retry:0,retryDelay:0,timeout:0,request:null,onTimeout:void 0,onProgress:void 0,onRetryError:void 0,transformRequest:void 0,transformResponse:void 0,transformError:void 0,responseType:Q,range:void 0,url:"",params:void 0,method:"GET",headers:{},body:void 0,mode:void 0,credentials:void 0,cache:void 0,redirect:void 0,referrer:void 0,referrerPolicy:void 0,integrity:void 0,onProcessMinLen:0},e),"xhr"!==t._config.loaderType&&el.isSupported()||(t.type="xhr"),t.log=e.logger,t}return I(r,[{key:"isFetch",value:function(){return this.type===Y}},{key:"load",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};"string"!=typeof e&&e?i=e:i.url=e||i.url||this._config.url,(i=Object.assign({},this._config,i)).params&&(i.params=Object.assign({},i.params)),i.headers&&et(i.headers)&&(i.headers=Object.assign({},i.headers)),i.body&&et(i.body)&&(i.body=Object.assign({},i.body)),i.transformRequest&&(i=i.transformRequest(i)||i),i.logger=this.log;var r=new eu(this.type,i);return r.loader.on(eo,function(e){t.emit(eo,e)}),this._queue.push(r),1!==this._queue.length||this._currentTask&&this._currentTask.running||this._processTask(),r.promise}},{key:"cancel",value:(t=C(P().mark(function e(){var t;return P().wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._queue.map(function(e){return e.cancel()}).concat(this._alive.map(function(e){return e.cancel()})),this._currentTask&&t.push(this._currentTask.cancel()),this._queue=[],this._alive=[],e.next=6,Promise.all(t);case 6:return e.next=8,function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise(function(t){return setTimeout(t,e)})}();case 8:case"end":return e.stop()}},e,this)})),function(){return t.apply(this,arguments)})},{key:"_processTask",value:function(){var e=this;if(this._currentTask=this._queue.shift(),this._currentTask){this._currentTask.alive&&this._alive.push(this._currentTask);var t=this._currentTask.exec().catch(function(e){});t&&"function"==typeof t.finally&&t.finally(function(){var t,i;null!=(t=e._currentTask)&&t.alive&&(null==(i=e._alive)?void 0:i.length)>0&&(e._alive=e._alive.filter(function(t){return t&&t!==e._currentTask})),e._processTask()})}}}],[{key:"isFetchSupport",value:function(){return el.isSupported()}}]),r}(_);class ep{static getDefaultConfig(){return{PCDNBufferControl:!1,PCDNCntControl:!1,estPTcontrol:!1,minPCDNInBuffer:8,maxPCDNInBuffer:12,minPCDNOutBuffer:3,maxPCDNOutBuffer:6,safePCDNInFactor:.1,safePCDNOutFactor:.4,alpha:.5,estPlayTime:12,minBandwidth:1e6}}constructor(e,t,i,r){this.config=ep.getDefaultConfig(),Object.keys(r).map(e=>{void 0!==r[e]&&null!==r[e]&&(this.config[e]=r[e])}),this.duration=i,this.player=e,this.updateBitrate(t),this.curPCDNInBuffer=this.config.maxPCDNInBuffer,this.curPCDNOutBuffer=this.config.maxPCDNOutBuffer,this.PCDNChangeCnt=0}updateBitrate(e){this.bitrate=e,this.bitrate||(this.bitrate=this.config.minBandwidth)}getPCDNInBuffer(){let{config:e,player:t,bitrate:i}=this;if(!e.PCDNBufferControl)return null;let{estPlayTime:r}=e,s=r;e.estPTcontrol&&(s=Math.min(r,Math.max(0,this.duration-((null==t?void 0:t.currentTime)||0))));let{safePCDNInFactor:n,minBandwidth:a,maxPCDNInBuffer:o,minPCDNInBuffer:l}=e,h=n*Math.max((null==t?void 0:t.avgSpeedPCDN)*1024||0,a),d=i>0?(1-h/i)*s:0;return this.curPCDNInBuffer=Math.min(o,Math.max(l,d)),this.curPCDNInBuffer}getPCDNOutBuffer(){let{config:e,player:t,bitrate:i}=this;if(!e.PCDNBufferControl)return null;let{estPlayTime:r}=e,s=r;e.estPTcontrol&&(s=Math.min(r,Math.max(0,this.duration-((null==t?void 0:t.currentTime)||0))));let{safePCDNOutFactor:n,minBandwidth:a,maxPCDNOutBuffer:o,minPCDNOutBuffer:l}=e,h=n*Math.max((null==t?void 0:t.avgSpeedPCDN)*1024||0,a),d=i>0?(1-h/i)*s:0;return this.curPCDNOutBuffer=Math.min(o,Math.max(l,d)),this.curPCDNOutBuffer}getPCDNChangeCnt(){let{PCDNCntControl:e,alpha:t}=this.config,{curPCDNInBuffer:i,player:r}=this,s=(null==r?void 0:r.bufferedPoint)||null,n=s&&s.end?s.end-r.currentTime:0;return e?n>i+(this.PCDNChangeCnt-1)*t&&this.PCDNChangeCnt++:n>=i&&this.PCDNChangeCnt<2&&this.PCDNChangeCnt++,this.PCDNChangeCnt}}let ef=new Map,em=class e{static get pluginName(){return"PCDN"}static get pcdnReqCnt(){let{pcdn_tracker_request_cnt:t,pcdn_tracker_success_cnt:i}=e;return e.pcdn_tracker_request_cnt=0,e.pcdn_tracker_success_cnt=0,{pcdn_tracker_request_cnt:t,pcdn_tracker_failed_cnt:t-i}}static getDefaultConfig(){return{trackerUrl:"",loaderType:Y,responseType:J,mode:"cors",method:"POST",retry:0,retryDelay:3e3,timeout:5e3,node_num:5,client_info:null,maxCnt:30,withReferer:0,NULLNodeTimeStep:6e4,ErrorTimeStep:15e3}}constructor(t,i,r,s){var n,a;this.options=e.getDefaultConfig(),Object.keys(t).map(e=>{void 0!==t[e]&&null!==t[e]&&(this.options[e]=t[e])}),this.options.productConfig&&this.options.productConfig.app_id||console.error("productConfig must has"),this.loader=new ec(this.options),this.resetTrackeArgs(),this._lastFileInfo=null,this.lastfetchNodeTime=-1,this._lastRetFileKey=null,this._minUpdateNodeStep=this.options.ErrorTimeStep,null!=(a=null==(n=this.options)?void 0:n.adaptPCDNConfig)&&a.PCDNBufferControl&&(this.pcdnAdapt=new ep(i,r,s,this.options.adaptPCDNConfig))}get isOpenAdaptPCDN(){return!!this.pcdnAdapt}get curPCDNInBuffer(){return this.pcdnAdapt.curPCDNInBuffer}getPCDNInBuffer(){var e;return null==(e=this.pcdnAdapt)?void 0:e.getPCDNInBuffer()}get curPCDNOutBuffer(){return this.pcdnAdapt.curPCDNOutBuffer}getPCDNOutBuffer(){var e;return null==(e=this.pcdnAdapt)?void 0:e.getPCDNOutBuffer()}get curPCDNChangeCnt(){return this.pcdnAdapt.PCDNChangeCnt}getPCDNChangeCnt(){var e;return null==(e=this.pcdnAdapt)?void 0:e.getPCDNChangeCnt()}resetTrackeArgs(e){this.trackeArgs={fid:null,trace_id:null,req_times:(null==e?void 0:e.req_times)||0,resp_times:(null==e?void 0:e.resp_times)||0,token:null,node_num:this.options.node_num,client_info:this.options.client_info}}static async gainPCDNNode(t,i,r,s){var n,a,o;let l=e.getDefaultConfig();Object.keys(i).map(e=>{void 0!==i[e]&&null!==i[e]&&(l[e]=i[e])}),s&&s.app_id||console.error("productConfig must has");let h=new H;r?(r.byterate=e_(r.bitrate),delete r.bitrate):h.reject("video fileInfo need set");let d=JSON.stringify(Object.assign(s,{file_info:r},{node_num:(null==i?void 0:i.node_num)||3})),u=new ec(l);try{e.pcdn_tracker_request_cnt++;let i=await u.load(t,{body:d});i.done&&(null==(o=null==(a=null==(n=i.data)?void 0:n.Result)?void 0:a.nodes)?void 0:o.length)>0&&e.pcdn_tracker_success_cnt++,h.resolve(i)}catch(e){h.reject((null==e?void 0:e.message)||"get pcdnNode error")}return h}getPCDNNode(e,t,i){var r;let s=e_(t),n=ef.get(eg(e,s)),a=new H;return!(null!=n&&n.nodes)||(null==(r=null==n?void 0:n.nodes)?void 0:r.length)<1?this.fetchPCDNNode(null,null,i).then(e=>{a.resolve(e)}).catch(e=>{a.reject(e)}):(n.fromCache=!0,a.resolve(n)),a}removePCDNNode(e,t,i){let r=e_(t),s=ef.get(eg(e,r)),n=null==s?void 0:s.nodes;n&&(i?s.nodes=n.filter(e=>e&&0>i.indexOf(e.url)):n.shift(),ef.set(eg(e,r),s)),n&&n.length||this.fetchPCDNNode().then().catch(()=>{})}async fetchPCDNNode(t,i,r){var s,n;let a=new H;if(i){i.byterate=e_(i.bitrate);let e=ef.get(eg(i.vid,i.byterate));if((null==(s=null==e?void 0:e.nodes)?void 0:s.length)>0)return e.fromCache=!0,a.resolve(e),a;delete i.bitrate,this._lastFileInfo=i}else i=this._lastFileInfo;if(!i)return a.resolve(null),a;let o=!1,l=eg(i.vid,i.byterate);if(this._lastRetFileKey!==l&&(this.resetTrackeArgs(),o=!0),Date.now()-this.lastfetchNodeTime<this._minUpdateNodeStep&&!o)return a.resolve(null),a;this.lastfetchNodeTime=Date.now(),this._lastRetFileKey=l,i.sfid?i.version=1:i.vid&&(i.version=2),this.options.withReferer&&(i.with_referer=this.options.withReferer);let h=JSON.stringify(Object.assign(this.options.productConfig,{file_info:i},this.trackeArgs,{req_id:r}));if(this.trackeArgs.req_times>=this.options.maxCnt)return a.resolve(null),a;this.loader||(this.loader=new ec(this.options)),this.trackeArgs.req_times+=1;try{e.pcdn_tracker_request_cnt++;let r=await this.loader.load(t||this.options.trackerUrl,{body:h}),s=null;if(r){this.trackeArgs.resp_times+=1;let t=8*i.byterate;if(r.done&&null!=(n=r.data)&&n.Result){let n=r.data.Result;(s=n.nodes)&&s.length>0?e.pcdn_tracker_success_cnt++:this._minUpdateNodeStep=this.options.NULLNodeTimeStep,s.map(e=>{e.vid=i.vid,e.bitrate=t});let{fid:o,trace_id:l,req_id:h}=n,d={nodes:s,fid:o,vid:i.vid,trace_id:l,req_id:h,bitrate:t},u=eg(i.vid,i.byterate);ef.set(u,d),this.trackeArgs.fid=n.fid,this.trackeArgs.trace_id=n.trace_id,this.trackeArgs.token=n.token,a.resolve(d)}else this._minUpdateNodeStep=this.options.ErrorTimeStep,a.reject(r)}}catch(e){this._minUpdateNodeStep=this.options.ErrorTimeStep,console.warn("tracker catch ERR,",e),a.reject(e)}return a}};function eg(e,t){return`${e}-${t}`}function e_(e){return Math.floor(e/8)}o(em,"pcdn_tracker_request_cnt",0),o(em,"pcdn_tracker_success_cnt",0);var ev=i(40325),ey=i(48890),eA=i(22626),eT=i.n(eA);let eb=eS&&!function(){let e="_localstorage_support_test";try{return localStorage.setItem(e,!0),localStorage.removeItem(e),!1}catch{return!0}}();function eS(){try{return"u">typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}let eE={length:eb?localStorage.length:0,clear:e=>{try{for(let t=localStorage.length-1;t>=0;t--){let i=localStorage.key(t);0===i.indexOf(e)&&localStorage.removeItem(i)}}catch{}},getItem:e=>{try{return localStorage.getItem(e)}catch{return null}},key:e=>{try{return localStorage.key(e)}catch{return null}},setItem:(e,t)=>{try{localStorage.setItem(e,t)}catch{}},removeItem:e=>{try{localStorage.removeItem(e)}catch{}},isSupport:eb};class ek{constructor(){let e,t,i=new Promise((i,r)=>{e=i,t=r});return i.resolve=e,i.reject=t,i}resolve(e){}reject(e){}}let eP="KGZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiO2NvbnN0IHQ9e30se2hhc093blByb3BlcnR5OmN9PU9iamVjdC5wcm90b3R5cGU7cG9zdE1lc3NhZ2Uoe2V2ZW50OiJyZWFkeSJ9KTtmdW5jdGlvbiBvKHMsYSl7dFtzXT1zZXRUaW1lb3V0KCgpPT57cG9zdE1lc3NhZ2Uoe2RhdGE6e2Zha2VJZDpzfX0pLG8ocyxhKX0sYSl9YWRkRXZlbnRMaXN0ZW5lcigibWVzc2FnZSIsZnVuY3Rpb24ocyl7dHJ5e2NvbnN0e2RhdGE6YT17fX09cyx7YWN0aW9uOm4sZmFrZUlkOmUsdGltZTpyfT1hO3N3aXRjaChuKXtjYXNlInNldEludGVydmFsIjpvKGUscik7YnJlYWs7Y2FzZSJjbGVhckludGVydmFsIjpjLmNhbGwodCxlKSYmKGNsZWFyVGltZW91dCh0W2VdKSxkZWxldGUgdFtlXSk7YnJlYWs7Y2FzZSJzZXRUaW1lb3V0Ijp0W2VdPXNldFRpbWVvdXQoZnVuY3Rpb24oKXtwb3N0TWVzc2FnZSh7ZGF0YTp7ZmFrZUlkOmV9fSksYy5jYWxsKHQsZSkmJmRlbGV0ZSB0W2VdfSxyKTticmVhaztjYXNlImNsZWFyVGltZW91dCI6Yy5jYWxsKHQsZSkmJihjbGVhclRpbWVvdXQodFtlXSksZGVsZXRlIHRbZV0pO2JyZWFrO2RlZmF1bHQ6YnJlYWt9fWNhdGNoKGEpe3Bvc3RNZXNzYWdlKHtldmVudDoiZXJyb3IiLGRhdGE6e2Vycm9yOmF9fSl9fSl9KSgpOwo=",ew="u">typeof self&&self.Blob&&new Blob([Uint8Array.from(atob(eP),e=>e.charCodeAt(0))],{type:"text/javascript;charset=utf-8"});if("u">typeof Worker);else console.error("the browser not support web worker, fallback to unWarp function!");Promise.withResolvers||(Promise.withResolvers=function(){let e={};return e.promise=new Promise((t,i)=>{e.resolve=t,e.reject=i}),e});let ex="PRELOAD_NEXT",eC="PRELOAD_SEG_DONE",eL={PREPARE:"PREPARE",IDLE:"IDLE",PRELOADING:"PRELOADING",FINISH:"FINISH"},eD="ONE_STEP_DONE",eI={INDEXDB:0,MEMORY:1},eR={FAIL:-1,SUCCESS:0,DOWNLOADING:1},eO={MP4:"MP4",DASH:"DASH",HLS:"HLS"},eM=Object.freeze(Object.defineProperty({__proto__:null,CACHE_TYPES:eI,DOWN_STATES:eR,MEDIA_FORMAT:{DASH:0,MP4:1},MEDIA_TYPES:{VIDEO:0,AUDIO:1,MIXED:2},ONE_STEP_DONE:eD,PRELOAD_NEXT:ex,PRELOAD_SEG_DONE:eC,PRELOAD_TYPES:{DURATION:0,SIZE:1},STATES:eL,VTYPES:eO},Symbol.toStringTag,{value:"Module"}));class eB extends eA{constructor(e,t,i,r,s){super(),this.state=eL.PREPARE,this.options=e||{},this.logger=e.logger||function(){},this._preloadManager=t,this.player=t.player;let{handlers:n,predictInst:a,readyPromise:o}=i;this._predictInst=a,this._handlers=n,this._predictInstReadyPromise=o,this._toLoadList=[],this.retryCount=0,this._cachedHandler=r,this._cachedDataHandler=s,this.cnt=0}start(){let e=new ek;return this._handlers.start(this.options).then(t=>{t.onObtain().then(i=>{this._predictInstReadyPromise.then(()=>{this._predictInst.updateMediaInfos(i);let r=this._predictInst.preloadPredict(this.options),{cachedData:s}=this._predictInst;this._cachedDataHandler(Object.assign({vid:this.options.vid},{data:s}));let n=Object.assign(r,this.options);t.onTransform(n).then(t=>{this._toLoadList=t,e.resolve(t)})})})}).catch(()=>{e.reject(Error("preload unit start error"))}),e}preloadSeg(){if(0===this._toLoadList.length){this.state=eL.FINISH,this.emit(eC,!0);return}this.state="PRELOADING";let e=this._toLoadList.shift();this._handlers.onRequest(e,t=>{let i=Object.assign({},e.extData,t);this._cachedHandler(i)}).then(()=>{this.state=eL.IDLE,this.emit(eC)}).catch(()=>{this.requestError(),this.emit(eC,!1)})}requestError(){this.retryCount++,this.state=eL.IDLE,this.retryCount>=10&&(this.state=eL.FINISH),this.emit(eD),this.logger("preload request error")}cancelLoading(){this._toLoadList=[]}destroy(){this.removeAllListeners()}}let eN=function(){try{if("u">typeof indexedDB)return indexedDB}catch{}}();function eU(e,t){t||(t=()=>{}),t&&e.then(function(e){t(null,e)},function(e){t(e)})}function eF(e){return"string"!=typeof e&&(console.warn(`${e} used as a key, but it is not a string.`),e=String(e)),e}let eV={},e$="readonly",ez="readwrite";function ej(e){let t=eV[e.name],i={};i.promise=new Promise(function(e,t){i.resolve=e,i.reject=t}),t.deferredOperations.push(i),t.dbReady?t.dbReady=t.dbReady.then(function(){return i.promise}):t.dbReady=i.promise}function eG(e,t){return new Promise(function(i,r){if(eV[e.name]=eV[e.name]||eq(),e.db)if(!t)return i(e.db);else ej(e),e.db.close();let s=[e.name];t&&s.push(e.version);let n=null==eN?void 0:eN.open.apply(eN,s);t&&(n.onupgradeneeded=function(t){let i=n.result;try{i.createObjectStore(e.storeName)}catch(t){if("ConstraintError"===t.name){let{oldVersion:i,newVersion:r}=t;console.warn(`The database "${e.name}" has been upgraded from version ${i} to
            version ${r}, but the storage "${e.storeName}" already exists.`)}else throw t}}),n.onerror=function(e){e.preventDefault(),r(n.error)},n.onsuccess=function(){i(n.result),function(e){let t=eV[e.name].deferredOperations.pop();t&&(t.resolve(),t.promise)}(e)}})}function eH(e,t){if(!e.db)return!0;let i=!e.db.objectStoreNames.contains(e.storeName),r=e.version<e.db.version,s=e.version>e.db.version;if(r&&(e.version!==t&&console.warn(`The database "${e.name}" can't be downgraded from version ${e.db.version} to
      version ${e.version}.`),e.version=e.db.version),s||i){if(i){let t=e.db.version+1;t>e.version&&(e.version=t)}return!0}return!1}function eW(e,t,i,r){var s;void 0===r&&(r=1);try{let r=null==(s=e.db)?void 0:s.transaction(e.storeName,t);i(null,r)}catch(s){if(r>0&&(!e.db||"InvalidStateError"===s.name||"NotFoundError"===s.name))return Promise.resolve().then(()=>{if(!e.db||"NotFoundError"===s.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),eG(e,!0)}).then(()=>(function(e){ej(e);let t=eV[e.name],{forages:i}=t;for(let e=0;e<i.length;e++){let t=i[e];t._dbInfo.db&&(t._dbInfo.db.close(),t._dbInfo.db=null)}return e.db=null,eG(e,!1).then(t=>(e.db=t,eH(e)?eG(e,!0):t)).then(r=>{e.db=t.db=r;for(let e=0;e<i.length;e++)i[e]._dbInfo.db=r}).catch(t=>{throw function(e,t){let i=eV[e.name].deferredOperations.pop();i&&(i.reject(t),i.promise)}(e,t),t})})(e).then(()=>{eW(e,t,i,r-1)})).catch(i);i(s)}}function eq(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}class eK{ready(){return this._ready}_initStorage(e){let t=this;t._defaultConfig=e;let i={db:null,name:"",version:"",storeName:""};if(e)for(let t in e)i[t]=e[t];let r=eV[i.name];r||(r=eq(),eV[i.name]=r),r.forages.push(t),t._initReady||(t._initReady=t.ready,t._ready=t._fullyReady);let s=[];function n(){return Promise.resolve()}for(let e=0;e<r.forages.length;e++){let i=r.forages[e];i!==t&&s.push(i._initReady().catch(n))}let a=r.forages.slice(0);return t._ready=Promise.all(s).then(function(){return i.db=r.db,eG(i,!1)}).then(function(e){return i.db=e,eH(i,t._defaultConfig.version)?eG(i,!0):e}).then(function(e){i.db=r.db=e,t._dbInfo=i;for(let e=0;e<a.length;e++){let r=a[e];r!==t&&(r._dbInfo.db=i.db,r._dbInfo.version=i.version)}}),t._ready}get probeSupport(){try{if(!(null!=eN&&eN.open))return!1;let e=/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||t)&&"u">typeof indexedDB&&"u">typeof IDBKeyRange}catch{return!1}}getItem(e,t){let i=this;e=eF(e);let r=new Promise(function(t,r){i.ready().then(function(){eW(i._dbInfo,e$,function(s,n){if(s)return r(s);try{let s=n.objectStore(i._dbInfo.storeName).get(e);s.onsuccess=function(){let e=s.result;void 0===e&&(e=null),t(e)},s.onerror=function(){r(s.error)}}catch(e){r(e)}})}).catch(r)});return eU(r,t),r}setItem(e,t,i){let r=this;e=eF(e);let s=new Promise(function(i,s){r.ready().then(function(){return r._dbInfo,t}).then(function(t){eW(r._dbInfo,ez,function(n,a){if(n)return s(n);try{let n=a.objectStore(r._dbInfo.storeName);null===t&&(t=void 0);let o=n.put(t,e);a.oncomplete=function(){void 0===t&&(t=null),i(t)},a.onabort=a.onerror=function(){var e;let t=o.error?o.error:null==(e=o.transaction)?void 0:e.error;s(t)}}catch(e){s(e)}})}).catch(s)});return eU(s,i),s}removeItem(e,t){let i=this;e=eF(e);let r=new Promise(function(t,r){i.ready().then(function(){eW(i._dbInfo,ez,function(s,n){if(s)return r(s);try{let s=n.objectStore(i._dbInfo.storeName).delete(e);n.oncomplete=function(){t()},n.onerror=function(){r(s.error)},n.onabort=function(){var e;let t=s.error?s.error:null==(e=s.transaction)?void 0:e.error;r(t)}}catch(e){r(e)}})}).catch(r)});return eU(r,t),r}clear(e){let t=this,i=new Promise(function(e,i){t.ready().then(function(){eW(t._dbInfo,ez,function(r,s){if(r)return i(r);try{let r=s.objectStore(t._dbInfo.storeName).clear();s.oncomplete=function(){e()},s.onabort=s.onerror=function(){var e;let t=r.error?r.error:null==(e=r.transaction)?void 0:e.error;i(t)}}catch(e){i(e)}})}).catch(i)});return eU(i,e),i}length(e){let t=this,i=new Promise(function(e,i){t.ready().then(function(){eW(t._dbInfo,e$,function(r,s){if(r)return i(r);try{let r=s.objectStore(t._dbInfo.storeName).count();r.onsuccess=function(){e(r.result)},r.onerror=function(){i(r.error)}}catch(e){i(e)}})}).catch(i)});return eU(i,e),i}all(e){let t=this,i=new Promise(function(e,i){t.ready().then(function(){eW(t._dbInfo,e$,function(r,s){if(r)return i(r);try{let r=s.objectStore(t._dbInfo.storeName).openCursor(),n=[];r.onsuccess=function(){let t=r.result;if(!t)return void e(n);n.push({key:t.key,value:t.value}),t.continue()},r.onerror=function(){i(r.error)}}catch(e){i(e)}})}).catch(i)});return eU(i,e),i}_fullyReady(e){let t=this,i=t._initReady().then(function(){let e=eV[t._dbInfo.name];if(null!=e&&e.dbReady)return e.dbReady});return"function"==typeof e&&i.then(e),"function"==typeof e&&i.catch(e),i}}class eY{constructor(){this.key="",this.store={}}_initStorage(e){let{name:t}=e,{storeName:i}=e,r=`${t}_${i}`;return this.key=r,window[r]&&"object"==typeof window[r]||(window[r]={}),this.store=window[r],Promise.resolve()}getItem(e,t){let i=this.store[e];return void 0===i&&(i=null),this._internalPromise(t,i)}setItem(e,t,i){return this.store[e]=t,this._internalPromise(i)}removeItem(e,t){return delete this.store[e],this._internalPromise(t)}clear(e){return this.store={},window[this.key]={},this._internalPromise(e)}length(e){let t=Object.keys(this.store).length;return this._internalPromise(e,t)}_internalPromise(e,t){let i=t?Promise.resolve(t):Promise.resolve();return eU(i,e),i}all(e){let t=[],i=Object.keys(this.store);for(let e=0;e<i.length;e++){let r=i[e];t.push({key:r,value:this.store[r]})}return this._internalPromise(e,t)}probeSupport(){return!0}}let eX={description:"",name:"__PRE_CACHE__",storeName:"keyvaluepairs",version:1},eQ="__PRE_CACHE__KEYS";class eJ{constructor(e,t){let i=t===eI.MEMORY?eY:eK;this._driver=new i,this._driver._initStorage(eX).catch(()=>{}),this._hasIdbForbidden=!1,this._maxCache=!e||e<=0?200:e,this.setMaxCache(this._maxCache),this._allCachedKeys={},this._allCachedTimeKeys={},this.getCachedKeysFromLocal(),this._readyPromise=new ek,this.init()}getCachedKeysFromLocal(){let e=eE.getItem(eQ);if(e){let t=e.split("|");for(let e=0;e<t.length;e++){let i=t[e],{time:r,cachedKey:s}=this._getCacheKeyInfos(i);this._allCachedKeys[s]=1,this._allCachedTimeKeys[s]=r}}}_getCacheKeyInfos(e){let t,i=e.split("$");return 2===i.length&&(t=i[0],e=i[1]),{time:t,cachedKey:e}}writeCachedKeysToLocal(e){let t=[];this._allCachedKeys={},this._allCachedTimeKeys={};for(let i=0;i<e.length;i++){let r=e[i].key,{time:s,cachedKey:n}=this._getCacheKeyInfos(r);this._allCachedKeys[n]=1,this._allCachedTimeKeys[n]=s,t.push(r)}let i=t.join("|");eE.setItem(eQ,i)}init(){this._driver.setItem("test","test").then(()=>{}).catch(()=>{this._hasIdbForbidden=!0}).finally(()=>{this._driver.removeItem("test").catch(()=>{}),this._hasIdbForbidden&&(this._driver=new eY,this._driver._initStorage(eX)),this._getAll(),this._readyPromise.resolve()})}_getAll(){this._driver.all().then(e=>{let t=e.length-this._maxCache,i=e;if(t>0){let r=e.slice(0,t);i=e.slice(t);for(let e=0;e<r.length;e++)this.removeItem(r[e].key).then(()=>{})}this.writeCachedKeysToLocal(i)}).catch(()=>{})}getItem(e,t){if(!this.hasItem(e))return Promise.resolve(!1);let{timeKey:i}=this._getTimeKey(e);return this._driver.getItem(i,t)}setItem(e,t,i){let{timeKey:r}=this._getTimeKey(e);r&&this.removeItem(e);let s=new Date().getTime();this._allCachedKeys[e]=1,this._allCachedTimeKeys[e]=s;let n=this._genTimeKey(e,s);return i=i?()=>{this._getAll(),i()}:()=>{this._getAll()},this._driver.setItem(n,t,i)}_getTimeKey(e){let t=this._allCachedTimeKeys[e],i=e;return t&&(i=this._genTimeKey(e,t)),{timeKey:i,time:t}}_genTimeKey(e,t){return`${t}$${e}`}removeItem(e,t){let{timeKey:i}=this._getTimeKey(e),r=this._driver.removeItem(i,t);return delete this._allCachedKeys[e],delete this._allCachedTimeKeys[e],r}hasItem(e){return!!this._allCachedKeys[e]}clear(e){return this._driver.clear(e)}length(e){return this._driver.length(e)}setMaxCache(e){"number"==typeof e&&e>0&&(this._maxCache=e)}}let eZ=class e extends eA{constructor(e,t,i=null){super(),this._preloadDataList=[],this._currentPreloadInst=null,this.autoPreload=e.autoPreload||!1,this._autoCheck=e.autoCheck||{enable:!1,interval:1e3},this._onPreloadNext=this.onPreloadNextReady.bind(this),this.on(ex,this._onPreloadNext),this._preloaderConfigs={},this.update(e,t,i),this._cacheInst=new eJ(e.preloadMaxCacheCount,e.preloadCacheType||0),this._preloadCacheProgress={},this._ptag_=!0,this._cachedDatas={},this._taskIntervalId=null}setMaxCache(e){var t;null==(t=this._cacheInst)||t.setMaxCache(e)}startCheckTask(){let{_autoCheck:e,_preloadDataList:t}=this;this._taskIntervalId&&(window.clearTimeout(this._taskIntervalId),this._taskIntervalId=null),0!==t.length&&(this._checkIfCanPreload()&&this.onPreloadNext(),this._taskIntervalId=window.setTimeout(()=>{this.startCheckTask()},e.interval||1e3))}stopCheckTask(){this._taskIntervalId&&(window.clearTimeout(this._taskIntervalId),this._taskIntervalId=null)}_checkIfCanPreload(){if(null==this._currentPreloadInst&&this._preloadDataList.length>0){let e=this._preloadDataList[0].data;if(e.payload){let t=this._getPreloaderKey(e),i=this._preloaderConfigs[t];if(null==i||!i.handlers)return console.warn("need to set vtype, no preloader",e),this.stopCheckTask(),!1;{let{checkIfCanPreload:t}=i.handlers;return t?t(e):(this.stopCheckTask(),!1)}}}return!1}_getPreloaderKey(e){return e.vtype?e.vtype:"DEFAULT"}update(e,t,i){if(!i)throw Error("PreloaderManager predictInst is null");let r=this._getPreloaderKey(e);this._preloaderConfigs[r]={predictInst:i,readyPromise:i.init(e),handlers:t}}get cachedDatas(){return this._cachedDatas}onCacheSegment(e){let{vid:t,format:i,cacheKey:r,total:s,loaded:n,isInitSegment:a,mediaType:o}=e,l=this.getProgressCacheKey(t,i,o),h=this._preloadCacheProgress[l];h||(h=this._preloadCacheProgress[l]={}),h[r]={total:s,loaded:n,isInitSegment:a}}onCachePredict(e){let{vid:t,data:i}=e;t&&i&&(this._cachedDatas[t]=i)}getProgressCacheKey(e,t,i){return`${e}-${t}-${i}`}onPreloadNextReady(){this.onPreloadNext()}onPreloadSegDone(){this.autoPreload&&this.emit(ex)}onPreloadNext(){if(null==this._currentPreloadInst&&this._preloadDataList.length>0){if(this._preloadDataList.length>0){let e=this._preloadDataList.shift(),t=null==e?void 0:e.data;if(null!=t&&t.payload){let e=this._getPreloaderKey(t),i=this._preloaderConfigs[e];if(!i)return void console.warn("need to set vtype, no preloader",t);this._currentPreloadInst=new eB(t,this,i,e=>{this.onCacheSegment(e)},e=>{this.onCachePredict(e)}),this._currentPreloadInst.on(eC,this.onPreloadSegDone.bind(this)),this._currentPreloadInst.start().then(()=>{this._currentPreloadInst.preloadSeg()}).catch(()=>{this._currentPreloadInst=null})}}}else null!=this._currentPreloadInst&&(this._currentPreloadInst.state===eL.IDLE?this._currentPreloadInst.preloadSeg():this._currentPreloadInst.state===eL.FINISH?(this._currentPreloadInst.destroy(),this._currentPreloadInst=null):this._currentPreloadInst.state===eL.PREPARE&&(this._currentPreloadInst.cnt++,this._currentPreloadInst.cnt>2&&(this._currentPreloadInst.destroy(),this._currentPreloadInst=null)))}addDashPreloader(e){e.data&&(this._preloadDataList.push(e),this.sort(this._preloadDataList),this.autoPreload&&this.emit(ex),this._autoCheck.enable&&!this._taskIntervalId&&this.startCheckTask())}_addDashPreloader(e){e.data&&this._preloadDataList.push(e)}addDashPreloaderList(e=[]){this.sort(e);for(let t=0;t<e.length;t++)this._addDashPreloader(e[t]);this._autoCheck.enable&&!this._taskIntervalId&&this.startCheckTask()}sort(e){e.sort((e,t)=>void 0===e.order&&void 0===e.order||"number"==typeof e.order&&"number"==typeof t.order&&e.order<t.order?-1:1)}destroy(){this.off(ex,this._onPreloadNext)}cancelLoading(){this._currentPreloadInst&&(this._currentPreloadInst.cancelLoading(),this._currentPreloadInst=null),this._preloadDataList=[]}static getInstance(t,i,r=null){let s=e.GLOBAL_KEY+(t.globalKey?t.globalKey:""),n=window[s];if(null!=n&&n._ptag_)return n.update(t,i,r),n;let a=new e(t,i,r);return window[s]=a,a}preloadCacheProgress(e){let{vid:t,format:i,mediaType:r,prelaodType:s,bitrate:n,set_duration:a,set_size:o,media_type:l,start_time:h}=e,d=this.getProgressCacheKey(t,i,r),u=this._preloadCacheProgress[d];if(u){let e=Object.values(u),t=0,i=0,r=0,d=0,c=0;for(let s=0;s<e.length;s++){let n=e[s];n.isInitSegment&&(t=n.total,r=n.loaded,d=n.loaded===n.total?eR.SUCCESS:eR.DOWNLOADING),i+=n.total,c+=n.loaded}let p=c===i?eR.SUCCESS:eR.DOWNLOADING;return{media_type:l,preload_type:s,stream_bitrate:n,header_size:t,content_total_size:i,start_time:h||-1,state_info:{set_duration:a,set_size:o,current_header_download_size:r,current_content_download_size:c,header_download_state:d,content_download_state:p}}}return null}getPreloadTaskInfos(){}getItem(e,t){return this._cacheInst.getItem(e,t)}setItem(e,t,i){return this._cacheInst.setItem(e,t,i)}removeItem(e,t){return this._cacheInst.removeItem(e,t)}};eZ.GLOBAL_KEY="__preloadcontext__";class e0 extends eA{constructor(e){super(),this.options=e,this.promisePolyfill(),this.before(),this.check(),this._preloadManager=eZ.getInstance(e,this.handlers,this.predictInst),this.loadingTasks=[]}promisePolyfill(){Promise.prototype.finally||(Promise.prototype.finally=({finally(e){let t=t=>Promise.resolve(e()).then(t);return this.then(e=>t(()=>e),e=>t(()=>Promise.reject(e)))}}).finally)}before(){throw Error("need")}check(){if(this.handlers){if(!this.handlers.start||!this.handlers.onRequest)throw Error("handlers callback null")}else throw Error("handlers null");if(!this.predictInst)throw Error("predictInst null");if(!this.predictInst.__p__)throw Error("predictInst need extends predictbase")}preloadNext(){this._preloadManager.emit(ex)}get preloadManager(){return this._preloadManager}start(){throw Error("start need implment, return Promise")}cancelLoading(){for(let e=0;e<this.loadingTasks.length;e++)try{let t=this.loadingTasks[e];"function"==typeof t.cancel&&t.cancel()}catch{}this.loadingTasks=[],this._preloadManager.cancelLoading()}addTasker(e){this.loadingTasks.push(e)}removeTasker(e){setTimeout(()=>{for(let t=this.loadingTasks.length-1;t>-1;t--)if(this.loadingTasks[t]===e){this.loadingTasks.splice(t,1);break}})}addDashPreloader(e){this._preloadManager.addDashPreloader(e)}addDashPreloaderList(e=[]){this._preloadManager.addDashPreloaderList(e)}}class e1{constructor(){this.bandwidth2item={},this._mediaInfos=void 0,this.__p__=!0}init(){throw Error("init func not implement, return promise")}preloadPredict(e){throw Error(`preloadPredict error: ${e}`)}updateMediaInfos(e){if(this._mediaInfos=e,this.bandwidth2item={},this.dynamic_video=e.dynamic_video_list,this.dynamic_video.length>0)for(let e=0;e<this.dynamic_video.length;e++){let t=this.dynamic_video[e],i=(null==t?void 0:t.bitrate)||(null==t?void 0:t.bandwidth);this.bandwidth2item[i]=t}}getIdx(e,t){let i=0;return e.forEach((e,r)=>{e.definition===t&&(i=r)}),i}get cachedData(){return null}}var e2=i(87118);function e4(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=Array(t);i<t;i++)r[i]=e[i];return r}function e8(e,t,i,r,s,n,a){try{var o=e[n](a),l=o.value}catch(e){return void i(e)}o.done?t(l):Promise.resolve(l).then(r,s)}function e5(e){return function(){var t=this,i=arguments;return new Promise(function(r,s){var n=e.apply(t,i);function a(e){e8(n,r,s,a,o,"next",e)}function o(e){e8(n,r,s,a,o,"throw",e)}a(void 0)})}}function e3(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function e6(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,th(r.key),r)}}function e9(e,t,i){return t&&e6(e.prototype,t),i&&e6(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function e7(e,t,i){return(t=th(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function te(e){return(te=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function tt(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(e){}return(tt=function(){return!!e})()}function ti(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,r)}return i}function tr(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ti(Object(i),!0).forEach(function(t){e7(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ti(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function ts(e){throw TypeError('"'+e+'" is read-only')}function tn(){var e,t,i="function"==typeof Symbol?Symbol:{},r=i.iterator||"@@iterator",s=i.toStringTag||"@@toStringTag";function n(i,r,s,n){var l=Object.create((r&&r.prototype instanceof o?r:o).prototype);return ta(l,"_invoke",function(i,r,s){var n,o,l,h=0,d=s||[],u=!1,c={p:0,n:0,v:e,a:p,f:p.bind(e,4),d:function(t,i){return n=t,o=0,l=e,c.n=i,a}};function p(i,r){for(o=i,l=r,t=0;!u&&h&&!s&&t<d.length;t++){var s,n=d[t],p=c.p,f=n[2];i>3?(s=f===r)&&(l=n[(o=n[4])?5:(o=3,3)],n[4]=n[5]=e):n[0]<=p&&((s=i<2&&p<n[1])?(o=0,c.v=r,c.n=n[1]):p<f&&(s=i<3||n[0]>r||r>f)&&(n[4]=i,n[5]=r,c.n=f,o=0))}if(s||i>1)return a;throw u=!0,r}return function(s,d,f){if(h>1)throw TypeError("Generator is already running");for(u&&1===d&&p(d,f),o=d,l=f;(t=o<2?e:l)||!u;){n||(o?o<3?(o>1&&(c.n=-1),p(o,l)):c.n=l:c.v=l);try{if(h=2,n){if(o||(s="next"),t=n[s]){if(!(t=t.call(n,l)))throw TypeError("iterator result is not an object");if(!t.done)return t;l=t.value,o<2&&(o=0)}else 1===o&&(t=n.return)&&t.call(n),o<2&&(l=TypeError("The iterator does not provide a '"+s+"' method"),o=1);n=e}else if((t=(u=c.n<0)?l:i.call(r,c))!==a)break}catch(t){n=e,o=1,l=t}finally{h=1}}return{value:t,done:u}}}(i,s,n),!0),l}var a={};function o(){}function l(){}function h(){}t=Object.getPrototypeOf;var d=h.prototype=o.prototype=Object.create([][r]?t(t([][r]())):(ta(t={},r,function(){return this}),t));function u(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,ta(e,s,"GeneratorFunction")),e.prototype=Object.create(d),e}return l.prototype=h,ta(d,"constructor",h),ta(h,"constructor",l),l.displayName="GeneratorFunction",ta(h,s,"GeneratorFunction"),ta(d),ta(d,s,"Generator"),ta(d,r,function(){return this}),ta(d,"toString",function(){return"[object Generator]"}),(tn=function(){return{w:n,m:u}})()}function ta(e,t,i,r){var s=Object.defineProperty;try{s({},"",{})}catch(e){s=0}(ta=function(e,t,i,r){if(t)s?s(e,t,{value:i,enumerable:!r,configurable:!r,writable:!r}):e[t]=i;else{let t=function(t,i){ta(e,t,function(e){return this._invoke(t,i,e)})};t("next",0),t("throw",1),t("return",2)}})(e,t,i,r)}function to(e,t){return(to=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function tl(e){return function(e){if(Array.isArray(e))return e4(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||td(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function th(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function td(e,t){if(e){if("string"==typeof e)return e4(e,t);var i=({}).toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?e4(e,t):void 0}}var tu=i(7787),tc="fetch",tp="arraybuffer",tf="text",tm=function(e){function t(e,i,r,s){var n;return(0,tu.xs)(this,t),n=(0,tu.qW)(this,t,[s]),(0,tu.n8)(n,"retryCount",0),(0,tu.n8)(n,"isTimeout",!1),(0,tu.n8)(n,"loaderType",tc),(0,tu.n8)(n,"startTime",0),(0,tu.n8)(n,"endTime",0),(0,tu.n8)(n,"options",{}),n.url=e,n.request=i,n.response=r,n}return(0,tu.B)(t,e),(0,tu.j6)(t)}((0,tu.Xx)(Error)),tg=Object.prototype.toString;function t_(e){if("[object Object]"!==tg.call(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function tv(e){if(e&&null!==e[0]&&void 0!==e[0]&&(0!==e[0]||null!==e[1]&&void 0!==e[1])){var t="bytes="+e[0]+"-";return e[1]&&(t+=e[1]),t}}function ty(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function tA(e,t){if(e){if(!t)return e;var i,r=Object.keys(t).map(function(e){if(null!=(i=t[e]))return Array.isArray(i)?e+="[]":i=[i],i.map(function(t){var i,r;return(i=t,"[object Date]"===tg.call(i))?t=t.toISOString():null!==(r=t)&&"object"===(0,tu.uk)(r)&&(t=JSON.stringify(t)),"".concat(ty(e),"=").concat(ty(t))}).join("&")}).filter(Boolean).join("&");if(r){var s=e.indexOf("#");-1!==s&&(e=e.slice(0,s)),e+=(-1===e.indexOf("?")?"?":"&")+r}return e}}function tT(e,t,i,r,s,n,a,o,l,h,d){return s=null!=s?parseFloat(s):null,Number.isNaN(r=parseInt(r||"0",10))&&(r=0),{data:e,done:t,options:{range:l,vid:h,index:o,contentLength:r,age:s,startTime:n,firstByteTime:a,endTime:Date.now(),priOptions:d},response:i}}function tb(e,t){return Math.round(8*e*1e3/t/1024)}var tS="real_time_speed",tE=function(e){var t;function i(){var e;return(0,tu.xs)(this,i),e=(0,tu.qW)(this,i),(0,tu.n8)(e,"_abortController",null),(0,tu.n8)(e,"_timeoutTimer",null),(0,tu.n8)(e,"_reader",null),(0,tu.n8)(e,"_response",null),(0,tu.n8)(e,"_aborted",!1),(0,tu.n8)(e,"_index",-1),(0,tu.n8)(e,"_range",null),(0,tu.n8)(e,"_receivedLength",0),(0,tu.n8)(e,"_running",!1),(0,tu.n8)(e,"_logger",null),(0,tu.n8)(e,"_vid",""),(0,tu.n8)(e,"_onProcessMinLen",0),(0,tu.n8)(e,"_onCancel",null),(0,tu.n8)(e,"_priOptions",null),(0,tu.n8)(e,"_processMaxGapTime",1/0),e}return(0,tu.B)(i,e),(0,tu.j6)(i,[{key:"load",value:function(e){var t,i=this,r=e.url,s=e.vid,n=e.timeout,a=e.responseType,o=e.onProgress,l=e.index,h=e.onTimeout,d=e.onCancel,u=e.range,c=e.transformResponse,p=e.request,f=e.params,m=e.logger,g=e.method,_=e.headers,v=e.body,y=e.mode,A=e.credentials,T=e.cache,b=e.redirect,S=e.referrer,E=e.referrerPolicy,k=e.onProcessMinLen,P=e.processMaxGapTime,w=e.priOptions;this._logger=m,this._aborted=!1,this._onProcessMinLen=k,this._onCancel=d,this._abortController="undefined"!=typeof AbortController&&new AbortController,this._running=!0,this._receivedLength=0,this._index=l,this._range=u||[0,0],this._vid=s||r,this._priOptions=w||{},this._processMaxGapTime=P;var x={method:g,headers:_,body:v,mode:y,credentials:A,cache:T,redirect:b,referrer:S,referrerPolicy:E,signal:null==(t=this._abortController)?void 0:t.signal},C=!1;clearTimeout(this._timeoutTimer),r=tA(r,f);var L=tv(u);L&&(_=p?p.headers:x.headers=x.headers||(Headers?new Headers:{}),Headers&&_ instanceof Headers?_.append("Range",L):_.Range=L),n&&(this._timeoutTimer=setTimeout((0,tu.Rx)((0,tu.Ld)().m(function e(){var t;return(0,tu.Ld)().w(function(e){for(;;)switch(e.n){case 0:return C=!0,e.n=1,i.cancel();case 1:h&&((t=new tm(r,x,null,"timeout")).isTimeout=!0,h(t,{index:i._index,range:i._range,vid:i._vid,priOptions:i._priOptions}));case 2:return e.a(2)}},e)})),n));var D=Date.now();return this._logger.debug("[fetch load start], index,",l,",range,",u),new Promise(function(e,t){var s;fetch(p||r,p?void 0:x).then((s=(0,tu.Rx)((0,tu.Ld)().m(function s(n){var h,d,p,f;return(0,tu.Ld)().w(function(s){for(;;)switch(s.n){case 0:if(clearTimeout(i._timeoutTimer),i._response=n,!(i._aborted||!i._running)){s.n=1;break}return s.a(2);case 1:if(c&&(n=c(n,r)||n),n.ok){s.n=2;break}throw new tm(r,x,n,"bad network response");case 2:if(h=Date.now(),a!==tf){s.n=4;break}return s.n=3,n.text();case 3:case 5:d=s.v,i._running=!1,s.n=9;break;case 4:if("json"!==a){s.n=6;break}return s.n=5,n.json();case 6:if(!o){s.n=7;break}return i.resolve=e,i.reject=t,i._loadChunk(n,o,D,h),s.a(2);case 7:return s.n=8,n.arrayBuffer();case 8:d=new Uint8Array(d=s.v),i._running=!1,p=Date.now()-D,f=tb(d.byteLength,p),i.emit(tS,{speed:f,len:d.byteLength,time:p,vid:i._vid,index:i._index,range:i._range,priOptions:i._priOptions});case 9:i._logger.debug("[fetch load end], index,",l,",range,",u),e(tT(d,!0,n,n.headers.get("Content-Length"),n.headers.get("age"),D,h,l,u,i._vid,i._priOptions));case 10:return s.a(2)}},s)})),function(e){return s.apply(this,arguments)})).catch(function(e){var s;clearTimeout(i._timeoutTimer),i._running=!1,(!i._aborted||C)&&((e=e instanceof tm?e:new tm(r,x,null,null==(s=e)?void 0:s.message)).startTime=D,e.endTime=Date.now(),e.isTimeout=C,e.options={index:i._index,range:i._range,vid:i._vid,priOptions:i._priOptions},t(e))})})}},{key:"cancel",value:(t=(0,tu.Rx)((0,tu.Ld)().m(function e(){return(0,tu.Ld)().w(function(e){for(;;)switch(e.n){case 0:if(!this._aborted){e.n=1;break}return e.a(2);case 1:if(this._aborted=!0,this._running=!1,!this._response){e.n=6;break}if(e.p=2,!this._reader){e.n=3;break}return e.n=3,this._reader.cancel();case 3:e.n=5;break;case 4:e.p=4,e.v;case 5:this._response=this._reader=null;case 6:if(this._abortController){try{this._abortController.abort()}catch(e){}this._abortController=null}this._onCancel&&this._onCancel({index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions});case 7:return e.a(2)}},e,this,[[2,4]])})),function(){return t.apply(this,arguments)})},{key:"_loadChunk",value:function(e,t,i,r){var s,n,a,o,l=this;if(!e.body||!e.body.getReader){this._running=!1;var h=new tm(e.url,"",e,"onProgress of bad response.body.getReader");h.options={index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions},this.reject(h);return}this._onProcessMinLen>0&&(this._cache=new Uint8Array(2097152),this._writeIdx=0);var d=this._reader=e.body.getReader(),u=Date.now(),c=(s=(0,tu.Rx)((0,tu.Ld)().m(function s(){var h,p,f,m,g,_,v,y,A,T;return(0,tu.Ld)().w(function(s){for(;;)switch(s.n){case 0:return a=Date.now(),s.p=1,s.n=2,d.read();case 2:n=s.v,o=Date.now(),s.n=4;break;case 3:return s.p=3,T=s.v,o=Date.now(),l._aborted||(l._running=!1,T.options={index:l._index,range:l._range,vid:l._vid,priOptions:l._priOptions},l.reject(T)),s.a(2);case 4:if(f=(p=(null==(h=l._range)?void 0:h.length)>0?l._range[0]:0)+l._receivedLength,!l._aborted){s.n=5;break}return l._running=!1,t(void 0,!1,{range:[f,f],vid:l._vid,index:l._index,startTime:a,endTime:o,st:i,firstByteTime:r,priOptions:l._priOptions},e),s.a(2);case 5:if(m=n.value?n.value.byteLength:0,l._receivedLength+=m,l._onProcessMinLen>0?l._writeIdx+m>=l._onProcessMinLen||n.done?((g=new Uint8Array(l._writeIdx+m)).set(l._cache.subarray(0,l._writeIdx),0),m>0&&g.set(n.value,l._writeIdx),l._writeIdx=0,l._logger.debug("\u3010fetchLoader,onProgress enough\u3011,done,",n.done,",len,",g.byteLength,", writeIdx,",l._writeIdx)):m>0&&l._writeIdx+m<2097152?(l._cache.set(n.value,l._writeIdx),l._writeIdx+=m,l._logger.debug("\u3010fetchLoader,onProgress cache\u3011,len,",m,", writeIdx,",l._writeIdx)):m>0&&(_=new Uint8Array(l._writeIdx+m+2048),l._logger.debug("\u3010fetchLoader,onProgress extra start\u3011,size,",l._writeIdx+m+2048,", datalen,",m,", writeIdx,",l._writeIdx),_.set(l._cache.subarray(0,l._writeIdx),0),m>0&&_.set(n.value,l._writeIdx),l._writeIdx+=m,delete l._cache,l._cache=_,l._logger.debug("\u3010fetchLoader,onProgress extra end\u3011,len,",m,", writeIdx,",l._writeIdx)):g=n.value,!(g&&g.byteLength>0||n.done)){s.n=6;break}l._logger.debug("\u3010fetchLoader,onProgress call\u3011,task,",l._range,", start,",f,", end,",p+l._receivedLength,", done,",n.done,i),t(g,n.done,{range:[l._range[0]+l._receivedLength-(g?g.byteLength:0),l._range[0]+l._receivedLength],vid:l._vid,index:l._index,startTime:a,endTime:o,st:i,firstByteTime:r,priOptions:l._priOptions},e),u=Date.now(),s.n=8;break;case 6:if(!(Date.now()-u>=l._processMaxGapTime)){s.n=8;break}return l._logger.debug("[onProgress timeout],task: ".concat(JSON.stringify(l._range)," done: ").concat(n.done," processMaxGapTime: ").concat(l._processMaxGapTime)),(v=new tm(e.url,null,e,"process timeout")).options={index:l._index,range:l._range,vid:l._vid,priOptions:l._priOptions},l.running=!1,s.n=7,l.cancel();case 7:return l.reject(v),s.a(2);case 8:n.done?(y=Date.now()-i,A=tb(l._receivedLength,y),l.emit(tS,{speed:A,len:l._receivedLength,time:y,vid:l._vid,index:l._index,range:l._range,priOptions:l._priOptions}),l._running=!1,l._logger.debug("[fetchLoader onProgress end],task,",l._range,",done,",n.done),l.resolve(tT(n,!0,e,e.headers.get("Content-Length"),e.headers.get("age"),i,r,l._index,l._range,l._vid,l._priOptions))):c();case 9:return s.a(2)}},s,null,[[1,3]])})),function(){return s.apply(this,arguments)});c()}},{key:"receiveLen",get:function(){return this._receivedLength}},{key:"running",get:function(){return this._running},set:function(e){this._running=e}}],[{key:"isSupported",value:function(){return"undefined"!=typeof fetch}}])}(eT()),tk=function(e){function t(){var e;return(0,tu.xs)(this,t),e=(0,tu.qW)(this,t),(0,tu.n8)(e,"_xhr",null),(0,tu.n8)(e,"_aborted",!1),(0,tu.n8)(e,"_timeoutTimer",null),(0,tu.n8)(e,"_range",null),(0,tu.n8)(e,"_receivedLength",0),(0,tu.n8)(e,"_url",null),(0,tu.n8)(e,"_onProgress",null),(0,tu.n8)(e,"_index",-1),(0,tu.n8)(e,"_headers",null),(0,tu.n8)(e,"_currentChunkSizeKB",384),(0,tu.n8)(e,"_timeout",null),(0,tu.n8)(e,"_xhr",null),(0,tu.n8)(e,"_withCredentials",null),(0,tu.n8)(e,"_startTime",-1),(0,tu.n8)(e,"_loadCompleteResolve",null),(0,tu.n8)(e,"_loadCompleteReject",null),(0,tu.n8)(e,"_runing",!1),(0,tu.n8)(e,"_logger",!1),(0,tu.n8)(e,"_vid",""),(0,tu.n8)(e,"_responseType",void 0),(0,tu.n8)(e,"_credentials",void 0),(0,tu.n8)(e,"_method",void 0),(0,tu.n8)(e,"_transformResponse",void 0),(0,tu.n8)(e,"_firstRtt",void 0),(0,tu.n8)(e,"_onCancel",null),(0,tu.n8)(e,"_priOptions",null),e}return(0,tu.B)(t,e),(0,tu.j6)(t,[{key:"load",value:function(e){var t=this;clearTimeout(this._timeoutTimer),this._logger=e.logger,this._range=e.range,this._onProgress=e.onProgress,this._index=e.index,this._headers=e.headers,this._withCredentials="include"===e.credentials||"same-origin"===e.credentials,this._body=e.body||null,e.method&&(this._method=e.method),this._timeout=e.timeout||null,this._runing=!0,this._vid=e.vid||e.url,this._responseType=e.responseType,this._firstRtt=-1,this._onTimeout=e.onTimeout,this._onCancel=e.onCancel,this._request=e.request,this._priOptions=e.priOptions||{},this._logger.debug("\u3010xhrLoader task\u3011, range",this._range),this._url=tA(e.url,e.params);var i=Date.now();return new Promise(function(e,i){t._loadCompleteResolve=e,t._loadCompleteReject=i,t._startLoad()}).catch(function(e){if(clearTimeout(t._timeoutTimer),t._runing=!1,!t._aborted)throw(e=e instanceof tm?e:new tm(t._url,t._request)).startTime=i,e.endTime=Date.now(),e.options={index:t._index,vid:t._vid,priOptions:t._priOptions},e})}},{key:"_startLoad",value:function(){var e=null;if(this._responseType===tp&&this._range&&this._range.length>1)if(this._onProgress){this._firstRtt=-1;var t=1024*this._currentChunkSizeKB,i=this._range[0]+this._receivedLength,r=this._range[1];t<this._range[1]-i&&(r=i+t),e=[i,r],this._logger.debug("[xhr_loader->],tast :",this._range,", SubRange, ",e)}else e=this._range,this._logger.debug("[xhr_loader->],tast :",this._range,", allRange, ",e);this._internalOpen(e)}},{key:"_internalOpen",value:function(e){var t=this;try{this._startTime=Date.now();var i=this._xhr=new XMLHttpRequest;i.open(this._method||"GET",this._url,!0),i.responseType=this._responseType,this._timeout&&(i.timeout=this._timeout),i.withCredentials=this._withCredentials,i.onload=this._onLoad.bind(this),i.onreadystatechange=this._onReadyStatechange.bind(this),i.onerror=function(e){t._running=!1;var i,r,s,n=new tm(t._url,t._request,null==e||null==(i=e.currentTarget)?void 0:i.response,"xhr.onerror.status:"+(null==e||null==(r=e.currentTarget)?void 0:r.status)+",statusText,"+(null==e||null==(s=e.currentTarget)?void 0:s.statusText));n.options={index:t._index,range:t._range,vid:t._vid,priOptions:t._priOptions},t._loadCompleteReject(n)},i.ontimeout=function(e){t.cancel();var i=new tm(t._url,t._request,{status:408},"timeout");t._onTimeout&&(i.isTimeout=!0,t._onTimeout(i,{index:t._index,range:t._range,vid:t._vid,priOptions:t._priOptions})),i.options={index:t._index,range:t._range,vid:t._vid,priOptions:t._priOptions},t._loadCompleteReject(i)};var r=this._headers||{},s=tv(e);s&&(r.Range=s),r&&Object.keys(r).forEach(function(e){i.setRequestHeader(e,r[e])}),this._logger.debug("[xhr.send->] tast,",this._range,",load sub range, ",e),i.send(this._body)}catch(t){t.options={index:this._index,range:e,vid:this._vid,priOptions:this._priOptions},this._loadCompleteReject(t)}}},{key:"_onReadyStatechange",value:function(e){2===e.target.readyState&&this._firstRtt<0&&(this._firstRtt=Date.now())}},{key:"_onLoad",value:function(e){var t=e.target.status;if(t<200||t>299){var i=new tm(this._url,null,(0,tu.T1)((0,tu.T1)({},e.target.response),{},{status:t}),"bad response,status:"+t);return i.options={index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions},this._loadCompleteReject(i)}var r=null,s=!1,n=(null==(a=this._range)?void 0:a.length)>0?this._range[0]:0;if(this._responseType===tp){var a,o,l,h=new Uint8Array(e.target.response);if(o=n+this._receivedLength,h&&h.byteLength>0){this._receivedLength+=h.byteLength;var d=Date.now()-this._startTime,u=tb(this._receivedLength,d);this.emit(tS,{speed:u,len:this._receivedLength,time:d,vid:this._vid,index:this._index,range:[o,n+this._receivedLength],priOptions:this._priOptions})}r=h,s=!((null==(l=this._range)?void 0:l.length)>1)||!this._range[1]||!(this._receivedLength<this._range[1]-this._range[0]),this._logger.debug("[xhr load done->], tast :",this._range,", start",o,"end ",n+this._receivedLength,",dataLen,",h?h.byteLength:0,",receivedLength",this._receivedLength,",index,",this._index,", done,",s)}else s=!0,r=e.target.response;var c={ok:t>=200&&t<300,status:t,statusText:this._xhr.statusText,url:this._xhr.responseURL,headers:this._getHeaders(this._xhr),body:this._xhr.response};this._transformResponse&&(c=this._transformResponse(c,this._url)||c),this._onProgress&&this._onProgress(r,s,{index:this._index,vid:this._vid,range:[o,n+this._receivedLength],startTime:this._startTime,endTime:Date.now(),priOptions:this._priOptions},c),s?(this._runing=!1,this._loadCompleteResolve&&this._loadCompleteResolve(tT(this._onProgress?null:r,s,c,c.headers["content-length"],c.headers.age,this._startTime,this._firstRtt,this._index,this._range,this._vid,this._priOptions))):this._startLoad()}},{key:"cancel",value:function(){if(!this._aborted&&(this._aborted=!0,this._runing=!1,(0,tu.hz)(t,"removeAllListeners",this,3)([]),this._onCancel&&this._onCancel({index:this._index,range:this._range,vid:this._vid,priOptions:this._priOptions}),this._xhr))return this._xhr.abort()}},{key:"receiveLen",get:function(){return this._receivedLength}},{key:"running",get:function(){return this._running},set:function(e){this._running=e}},{key:"_getHeaders",value:function(e){var t,i=e.getAllResponseHeaders().trim().split("\r\n"),r={},s=(0,tu.vG)(i);try{for(s.s();!(t=s.n()).done;){var n=t.value.split(": ");r[n[0].toLowerCase()]=n.slice(1).join(": ")}}catch(e){s.e(e)}finally{s.f()}return r}}],[{key:"isSupported",value:function(){return"undefined"!=typeof XMLHttpRequest}}])}(eT()),tP=i(4024),tw=["retry","retryDelay","onRetryError","transformError"],tx=(0,tu.j6)(function e(t,i){(0,tu.xs)(this,e),this.promise=(0,tP.$f)(),this.alive=!!i.onProgress,i.logger||(i.logger=new ev.V("Loader")),this._loaderType=t,this._loader=t===tc&&"undefined"!=typeof fetch?new tE:new tk,this._config=i,this._retryCount=0,this._retryTimer=null,this._canceled=!1,this._retryCheckFunc=i.retryCheckFunc,this._logger=i.logger},[{key:"exec",value:function(){var e,t=this,i=this._config,r=i.retry,s=i.retryDelay,n=i.onRetryError,a=i.transformError,o=(0,tu.$i)(i,tw),l=(e=(0,tu.Rx)((0,tu.Ld)().m(function e(){var i,h,d,u;return(0,tu.Ld)().w(function(e){for(;;)switch(e.n){case 0:return e.p=0,e.n=1,t._loader.load(o);case 1:i=e.v,t.promise.resolve(i),e.n=5;break;case 2:if(e.p=2,u=e.v,t._loader.running=!1,t._logger.debug("[task request catch err]",u),!t._canceled){e.n=3;break}return e.a(2);case 3:if(u.loaderType=t._loaderType,u.retryCount=t._retryCount,h=u,a&&(h=a(h)||h),n&&t._retryCount>0&&n(h,t._retryCount,{index:o.index,vid:o.vid,range:o.range,priOptions:o.priOptions}),t._retryCount++,d=!0,t._retryCheckFunc&&(d=t._retryCheckFunc(u)),!(d&&t._retryCount<=r)){e.n=4;break}return clearTimeout(t._retryTimer),t._logger.debug("[task request setTimeout],retry",t._retryCount,",retry range,",o.range),t._retryTimer=setTimeout(l,s),e.a(2);case 4:t.promise.reject(h);case 5:return e.a(2)}},e,null,[[0,2]])})),function(){return e.apply(this,arguments)});return l(),this.promise}},{key:"cancel",value:(n=(0,tu.Rx)((0,tu.Ld)().m(function e(){return(0,tu.Ld)().w(function(e){for(;;)if(0===e.n)return clearTimeout(this._retryTimer),this._canceled=!0,this._loader.running=!1,e.a(2,this._loader.cancel())},e,this)})),function(){return n.apply(this,arguments)})},{key:"running",get:function(){return this._loader&&this._loader.running}},{key:"loader",get:function(){return this._loader}}]);function tC(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];if((t=t.filter(Boolean)).length<2)return t[0];var r=tL(t.reduce(function(e,t){return e+t.byteLength},0)),s=0;return t.forEach(function(e){r.set(e,s),s+=e.byteLength}),r}function tL(e){for(var t,i=0;i<10;)try{if((t=new Uint8Array(e)).byteLength>0)break;i++}catch(e){if(i<10)i++;else throw Error("new array failed final,".concat(null==e?void 0:e.message))}return t}var tD=function(e){var t;function i(e){var t;return(0,tu.xs)(this,i),t=(0,tu.qW)(this,i,[e]),(0,tu.n8)(t,"type",tc),(0,tu.n8)(t,"_queue",[]),(0,tu.n8)(t,"_alive",[]),(0,tu.n8)(t,"_currentTask",null),(0,tu.n8)(t,"_finnalUrl",""),(0,tu.n8)(t,"_config",void 0),t._config=(0,tu.T1)({loaderType:tc,retry:0,retryDelay:0,timeout:0,request:null,onTimeout:void 0,onProgress:void 0,onRetryError:void 0,transformRequest:void 0,transformResponse:void 0,transformError:void 0,responseType:tf,range:void 0,url:"",params:void 0,method:"GET",headers:{},body:void 0,mode:void 0,credentials:void 0,cache:void 0,redirect:void 0,referrer:void 0,referrerPolicy:void 0,integrity:void 0,onProcessMinLen:0,processMaxGapTime:1/0},e),"xhr"!==t._config.loaderType&&tE.isSupported()||(t.type="xhr"),t.log=e.logger,t}return(0,tu.B)(i,e),(0,tu.j6)(i,[{key:"isFetch",value:function(){return this.type===tc}},{key:"load",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};"string"!=typeof e&&e?i=e:i.url=e||i.url||this._config.url,(i=Object.assign({},this._config,i)).params&&(i.params=Object.assign({},i.params)),i.headers&&t_(i.headers)&&(i.headers=Object.assign({},i.headers)),i.body&&t_(i.body)&&(i.body=Object.assign({},i.body)),i.transformRequest&&(i=i.transformRequest(i)||i),i.logger=this.log;var r=new tx(this.type,i);return r.loader.on(tS,function(e){t.emit(tS,e)}),this._queue.push(r),1!==this._queue.length||this._currentTask&&this._currentTask.running||this._processTask(),r.promise}},{key:"cancel",value:(t=(0,tu.Rx)((0,tu.Ld)().m(function e(){var t;return(0,tu.Ld)().w(function(e){for(;;)switch(e.n){case 0:return t=this._queue.map(function(e){return e.cancel()}).concat(this._alive.map(function(e){return e.cancel()})),this._currentTask&&t.push(this._currentTask.cancel()),this._queue=[],this._alive=[],e.n=1,Promise.all(t);case 1:return e.n=2,function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise(function(t){return setTimeout(t,e)})}();case 2:return e.a(2)}},e,this)})),function(){return t.apply(this,arguments)})},{key:"_processTask",value:function(){var e=this;if(this._currentTask=this._queue.shift(),this._currentTask){this._currentTask.alive&&this._alive.push(this._currentTask);var t=this._currentTask.exec().catch(function(e){});t&&"function"==typeof t.finally&&t.finally(function(){var t,i;null!=(t=e._currentTask)&&t.alive&&(null==(i=e._alive)?void 0:i.length)>0&&(e._alive=e._alive.filter(function(t){return t&&t!==e._currentTask})),e._processTask()})}}}],[{key:"isFetchSupport",value:function(){return tE.isSupported()}}])}(eT()),tI=i(63847),tR=i(55355),tO="undefined"!=typeof window,tM=tO&&"undefined"!=typeof navigator&&navigator.userAgent.toLocaleLowerCase();tO&&/^((?!chrome|android).)*safari/.test(tM);var tB=tO&&tM.includes("firefox"),tN=tO&&tM.includes("android"),tU=function(){function e(){(0,tI.xs)(this,e)}return(0,tI.j6)(e,null,[{key:"getRateIndexByRate",value:function(t){return e.FREQ.indexOf(t)}},{key:"parseADTS",value:function(t,i){for(var r,s,n=t.length,a=0;a+2<n&&(255!==t[a]||(246&t[a+1])!=240);)a++;if(!(a>=n)){var o=a,l=[],h=(60&t[a+2])>>>2,d=e.FREQ[h];if(!d)throw Error("Invalid sampling index: ".concat(h));for(var u=((192&t[a+2])>>>6)+1,c=(1&t[a+2])<<2|(192&t[a+3])>>>6,p=e._getConfig(h,c,u),f=p.config,m=p.codec,g=0,_=e.getFrameDuration(d);a+7<n;){if(255!==t[a]||(246&t[a+1])!=240){a++;continue}if(!(s=(3&t[a+3])<<11|t[a+4]<<3|(224&t[a+5])>>5)||n-a<s)break;r=(1&~t[a+1])*2,l.push({pts:i+g*_,data:t.subarray(a+7+r,a+s)}),g++,a+=s}return{skip:o,remaining:a>=n?void 0:t.subarray(a),frames:l,samplingFrequencyIndex:h,sampleRate:d,objectType:u,channelCount:c,codec:m,config:f,originCodec:"mp4a.40.".concat(u)}}}},{key:"parseAudioSpecificConfig",value:function(t){if(t.length){var i=t[0]>>>3,r=(7&t[0])<<1|t[1]>>>7,s=(120&t[1])>>>3,n=e.FREQ[r];if(n){var a=e._getConfig(r,s,i),o=a.config,l=a.codec;return t.length>=4&&695==(t[2]<<3|(224&t[3])>>5)&&(128&t[4])>>7&&(i=31&t[3]),{samplingFrequencyIndex:r,sampleRate:n,objectType:i,channelCount:s,config:o,codec:l,originCodec:"mp4a.40.".concat(i)}}}}},{key:"getFrameDuration",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9e4;return 1024*t/e}},{key:"_getConfig",value:function(e,t,i){var r,s,n=[];return tB?e>=6?(r=5,s=e-3):(r=2,s=e):tN?(r=2,s=e):(r=2===i||5===i?i:5,s=e,e>=6?s=e-3:1===t&&(r=2,s=e)),n[0]=r<<3,n[0]|=(14&e)>>1,n[1]=(1&e)<<7,n[1]|=t<<3,5===r&&(n[1]|=(14&s)>>1,n[2]=(1&s)<<7,n[2]|=8,n[3]=0),{config:n,codec:"mp4a.40.".concat(r)}}},{key:"getSilentFrame",value:function(e,t,i){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if("mp4a.40.5"===e&&2===t&&22050===i)return new Uint8Array([33,17,69,0,20,80,1,70,173,200,65,117,0,0,0,28,96,24,13,230,66,20,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,188]);if("mp40.40.5"===e&&2===t&&24e3===i)return new Uint8Array([33,17,69,0,20,80,1,70,173,200,65,117,0,0,0,28,96,24,13,229,98,20,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,180,188]);if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t||3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}])}();(0,tI.n8)(tU,"FREQ",[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]);var tF=(0,tI.j6)(function e(t){if((0,tI.xs)(this,e),(0,tI.n8)(this,"_bytesAvailable",void 0),(0,tI.n8)(this,"_bitsAvailable",0),(0,tI.n8)(this,"_word",0),!t)throw Error("ExpGolomb data params is required");this._data=t,this._bytesAvailable=t.byteLength,this._bytesAvailable&&this._loadWord()},[{key:"_loadWord",value:function(){var e=this._data.byteLength-this._bytesAvailable,t=Math.min(4,this._bytesAvailable);if(0===t)throw Error("No bytes available");var i=new Uint8Array(4);i.set(this._data.subarray(e,e+t)),this._word=new DataView(i.buffer).getUint32(0),this._bitsAvailable=8*t,this._bytesAvailable-=t}},{key:"bitsPos",value:function(){return 8*this._bytesAvailable-this._bitsAvailable}},{key:"bitsLeft",value:function(){return 8*this._data.length-this.bitsPos()}},{key:"byteAligned",value:function(){return 0===this.bitsPos()||this.bitsPos()%8==0}},{key:"skipBits",value:function(e){if(this._bitsAvailable>e)this._word<<=e,this._bitsAvailable-=e;else{var t=Math.floor((e-=this._bitsAvailable)/8);e-=8*t,this._bytesAvailable-=t,this._loadWord(),this._word<<=e,this._bitsAvailable-=e}}},{key:"readBits",value:function(e){if(e>32)throw Error("Cannot read more than 32 bits");var t=Math.min(this._bitsAvailable,e),i=this._word>>>32-t;return(this._bitsAvailable-=t,this._bitsAvailable>0?this._word<<=t:this._bytesAvailable>0&&this._loadWord(),(t=e-t)>0&&this._bitsAvailable)?i<<t|this.readBits(t):i}},{key:"skipLZ",value:function(){var e;for(e=0;e<this._bitsAvailable;++e)if((this._word&0x80000000>>>e)!=0)return this._word<<=e,this._bitsAvailable-=e,e;return this._loadWord(),e+this.skipLZ()}},{key:"skipUEG",value:function(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function(){var e=this.skipLZ();return this.readBits(e+1)-1}},{key:"readEG",value:function(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readUByte",value:function(){return this.readBits(8)}},{key:"skipScalingList",value:function(e){for(var t=8,i=8,r=0;r<e;r++)0!==i&&(i=(t+this.readEG()+256)%256),t=0===i?t:i}}]),tV=(0,tI.j6)(function e(t){(0,tI.xs)(this,e),this._buffer=t,this._offset=0,this._heldBits=0,this._numHeldBits=0},[{key:"readUint8",value:function(){return this._buffer[this._offset++]}},{key:"readUint16",value:function(){return this._buffer[this._offset++]<<8|this._buffer[this._offset++]}},{key:"readUint32",value:function(){return this._buffer[this._offset++]<<24|this._buffer[this._offset++]<<16|this._buffer[this._offset++]<<8|this._buffer[this._offset++]}},{key:"readUint8Array",value:function(e){var t=this._buffer.slice(this._offset,this._offset+e);return this._offset+=e,t}},{key:"streamRead1Bytes",value:function(){this._heldBits=this.readUint8(),this._numHeldBits=8}},{key:"streamRead2Bytes",value:function(){this._heldBits=this.readUint16(),this._numHeldBits=16}},{key:"extractBits",value:function(e){var t=this._heldBits>>this._numHeldBits-e&(1<<e)-1;return this._numHeldBits-=e,t}}]),t$=function(){function e(){(0,tI.xs)(this,e)}return(0,tI.j6)(e,null,[{key:"parseVVCDecoderConfigurationRecord",value:function(t){var i,r,s,n,a,o,l,h,d=new tV(t),u=d.readUint8();d.streamRead1Bytes(),d.extractBits(5);var c=d.extractBits(2)+1,p=d.extractBits(1),f={};p&&(d.streamRead2Bytes(),n=d.extractBits(2),a=d.extractBits(3),r=d.extractBits(3),s=d.extractBits(2),d.extractBits(6),f=e.parseVVCPTLRecord(d,r),i=d.readUint16(),o=d.readUint16(),l=d.readUint16(),h=d.readUint16());for(var m=d.readUint8(),g=[],_=[],v=[],y=null,A=0;A<m;A++){d.streamRead1Bytes(),d.extractBits(1),d.extractBits(2);var T=d.extractBits(5),b=1;13!==T&&12!==T&&(b=d.readUint16());for(var S=0;S<b;S++){var E=d.readUint16();switch(T){case 14:g.push(d.readUint8Array(E));break;case 15:var k=d.readUint8Array(E);y||(y=e.parseSPS(e.removeEPB(k))),_.push(k);break;case 16:v.push(d.readUint8Array(E))}}}return{data:t,configurationVersion:u,codec:"bvc2.1.6.L93.B0",nalUnitSize:c,ptlPresentFlag:p,olsIdx:i,numSublayers:r,constantFrameRate:s,chromaFormatIdc:n,bitDepthLumaMinus8:a,ptlRecord:f,width:o,height:l,sampleRate:h,numOfArrays:m,vps:g,sps:_,pps:v,spsParsed:y}}},{key:"parseVVCPTLRecord",value:function(e,t){e.streamRead2Bytes(),e.extractBits(2);var i=e.extractBits(6),r=e.extractBits(7),s=e.extractBits(1),n=e.readUint8();e.streamRead1Bytes();var a=e.extractBits(1),o=e.extractBits(1),l=new Uint8Array(i);if(i){for(var h=0;h<i-1;h++){var d=e.extractBits(6);e.streamRead1Bytes();var u=e.extractBits(2);l[h]=d<<2|u}l[i-1]=e.extractBits(6)}else e.extractBits(6);var c=[];if(t>1){e.streamRead1Bytes();for(var p=0,f=t-2;f>=0;--f)p|=e.extractBits(1)<<f;for(var m=t;m<=8&&t>1;++m)e.extractBits(1);for(var g=t-2;g>=0;--g)p&1<<g&&(c[g]=e.readUint8())}var _=e.readUint8(),v=[];if(_)for(var y=0;y<_;y++)v.push(e.readUint32());return{generalProfileIdc:r,generalTierFlag:s,generalLevelIdc:n,ptlFrameOnlyConstraintFlag:a,ptlMultilayerEnabledFlag:o,generalConstraintInfo:l,subLayerLevelIdc:c,generalSubProfileIdc:v,ptlNumSubProfiles:_,numBytesConstraintInfo:i}}},{key:"getAvccNals",value:function(e){for(var t=[];e.position<e.length-4;){var i=e.dataview.getInt32(e.dataview.position);if(e.length-e.position>=i){var r=e.buffer.slice(e.position,e.position+4);e.skip(4);var s=new Uint8Array(e.buffer.slice(e.position,e.position+i));e.skip(i),t.push({header:r,body:s});continue}break}return t}},{key:"analyseNal",value:function(e){var t=(248&e.body[1])>>3;switch(e.type=t,t){case 23:case 24:break;case 7:case 8:e.key=!0;break;case 14:e.vps=!0;break;case 15:e.sps=!0;break;case 16:e.pps=!0;break;case 17:e.aps=!0}}},{key:"removeEPB",value:function(e){for(var t=e.byteLength,i=[],r=1;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(i.push(r+2),r+=2):r++;if(!i.length)return e;var s=t-i.length,n=new Uint8Array(s),a=0;for(r=0;r<s;a++,r++)a===i[0]&&(a++,i.shift()),n[r]=e[a];return n}},{key:"parseVps",value:function(){}},{key:"parseSPS",value:function(t){var i=new tF(t);i.readUByte(),i.readUByte(),i.skipBits(4);var r=i.readBits(4),s=i.readBits(3),n=i.readBits(2),a=420;n<=3&&(a=[0,420,422,444][n]),i.readBits(2),i.readBits(1);var o=e._parseProfileTierLevel(i,1,s);return i.readBits(1),i.readBits(1)&&i.readBits(1),{width:i.readUEG(),height:i.readUEG(),spsMaxSubLayerMinus1:s,spsVideoParameterSetId:r,chromaFormatIdc:n,chromaFormat:a,ptlInfo:o}}},{key:"_parseProfileTierLevel",value:function(t,i,r){var s,n=t.readBits(7),a=t.readBits(1),o=t.readBits(8),l=t.readBits(1),h=t.readBits(1);i&&(s=e._parseGeneralConstraintsInfo(t));for(var d=r-1,u=[],c=[],p=[],f=d;f>=0;--f)u[f]=t.readBits(1);for(;!t.byteAligned();)t.readBits(1);for(var m=d;m>=0;--m)u[m]&&(c[m]=t.readUByte());if(i)for(var g=t.readUByte(),_=0;_<g;_++)p[_]=t.readBits(32);return{generalProfileIdc:n,generalTierFlag:a,generalLevelIdc:o,ptlFrameOnlyConstraintFlag:l,ptlMultilayerEnabledFlag:h,ptlSublayerLevelPresentFlags:u,ptlSublayerLevelIdcs:c,ptlSubProfileIdcs:p,gciInfo:s}}},{key:"_parseGeneralConstraintsInfo",value:function(e){var t=e.readBits(1);if(t){e.skipBits(71);var i=e.readBits(8);i&&e.skipBits(i)}var r=8-e.bitsPos()%8;return e.skipBits(r),{gciPresentFlag:t}}}])}(),tz=i(85274),tj=function(){function e(t,i,r){(0,tI.xs)(this,e),this.dv=new DataView(t),this.start=this.offset=i||this.dv.byteOffset,this.end=r?this.start+r:this.start+this.dv.byteLength}return(0,tI.j6)(e,[{key:"buffer",get:function(){return this.dv.buffer}},{key:"unreadLength",get:function(){return Math.max(this.end-this.offset,0)}},{key:"size",get:function(){return this.end-this.start}},{key:"readFloat",value:function(e){var t=0;switch(e){case 4:t=this.dv.getFloat32(this.offset);break;case 8:t=this.dv.getFloat64(this.offset);break;default:throw Error("read ".concat(e,"-byte float is not supported"))}return this.offset+=e,t}},{key:"back",value:function(e){this.offset-=e}},{key:"skip",value:function(e){this.offset+=e}},{key:"readInt",value:function(e){var t=this.offset;switch(this.offset+=e,e){case 1:return this.dv.getInt8(t);case 2:return this.dv.getInt16(t);case 4:return this.dv.getInt32(t);default:throw Error("read ".concat(e,"-byte integers is not supported"))}}},{key:"read",value:function(e){var t=this.offset;switch(this.offset+=e,e){case 1:return this.dv.getUint8(t);case 2:return this.dv.getUint16(t);case 3:return(this.dv.getUint16(t)<<8)+this.dv.getUint8(t+2);case 4:return this.dv.getUint32(t);default:return this.back(e-4),this.read(e-4)+this.dv.getUint32(t)*Math.pow(256,e-4)}}},{key:"write",value:function(e,t){var i=this.offset;switch(this.offset+=e,e){case 1:return this.dv.setUint8(i,t);case 2:return this.dv.setUint16(i,t);case 3:return this.dv.setUint8(i,t>>>16),this.dv.setUint16(i+1,65535&t);case 4:return this.dv.setUint32(i,t);default:throw Error("write ".concat(e,"-byte integers is not supported"))}}},{key:"readToBuffer",value:function(e){var t;return t=this.offset||e?this.dv.buffer.slice(this.offset,e?this.offset+e:this.end):this.dv.buffer,this.offset+=t.byteLength,t}},{key:"readToUint8",value:function(e){var t=new Uint8Array(this.dv.buffer,this.offset,e||this.unreadLength);return this.offset+=t.byteLength,t}},{key:"readString",value:function(e){for(var t=0,i="";t<e;t++)i+=String.fromCharCode(this.dv.getUint8(this.offset)),this.offset++;return i}}],[{key:"fromUint8",value:function(t){return new e(t.buffer,t.byteOffset,t.byteLength)}},{key:"concatUint8s",value:function(e){var t=new Uint8Array(e.reduce(function(e,t){return e+t.byteLength},0)),i=0;return e.forEach(function(e){t.set(e,i),i+=e.byteLength}),t}},{key:"concatUint8",value:function(){for(var e=arguments.length,t=Array(e),i=0;i<e;i++)t[i]=arguments[i];return this.concatUint8s(t)}}])}(),tG=function(){function e(t,i){(0,tI.xs)(this,e),this.offset=0,this.val=t,this.size=i}return(0,tI.j6)(e,[{key:"skip",value:function(e){this.offset+=e}},{key:"read",value:function(e){var t=this.size-this.offset-e;if(t>=0){var i=0,r=0;if(this.offset+=e,this.size>31){for(;r<e;r++)i+=Math.pow(2,r);return this.val/Math.pow(2,t)&i}for(;r<e;r++)i+=1<<r;return this.val>>>t&i}throw Error("the number of the read operation exceeds the total length limit of bits")}}],[{key:"fromByte",value:function(t,i){return new e(t.read(i),i<<3)}}])}(),tH=function(){function e(){(0,tI.xs)(this,e)}return(0,tI.j6)(e,null,[{key:"findBox",value:function(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=[];if(!t)return s;for(var n=0,a="",o=0;t.length>7;){if(n=(0,tR.kl)(t),a=String.fromCharCode.apply(null,t.subarray(4,8)),o=8,1===n?(n=(0,tR.xV)(t,8),o+=8):n||(n=t.length),!i[0]||a===i[0]){var l=t.subarray(0,n);if(!(i.length<2))return e.findBox(l.subarray(o),i.slice(1),r+o);s.push({start:r,size:n,headerSize:o,type:a,data:l})}r+=n,t=t.subarray(n)}return s}},{key:"tfhd",value:function(e){return tY(e,!0,function(e,t){e.trackId=(0,tR.kl)(t);var i=4,r=255&e.flags&1,s=255&e.flags&2,n=255&e.flags&8,a=255&e.flags&16,o=255&e.flags&32;r&&(i+=4,e.baseDataOffset=(0,tR.kl)(t,i),i+=4),s&&(e.sampleDescriptionIndex=(0,tR.kl)(t,i),i+=4),n&&(e.defaultSampleDuration=(0,tR.kl)(t,i),i+=4),a&&(e.defaultSampleSize=(0,tR.kl)(t,i),i+=4),o&&(e.defaultSampleFlags=(0,tR.kl)(t,i))})}},{key:"sidx",value:function(e){return tY(e,!0,function(e,t){var i=0;e.reference_ID=(0,tR.kl)(t,i),i+=4,e.timescale=(0,tR.kl)(t,i),i+=4,0===e.version?(e.earliest_presentation_time=(0,tR.kl)(t,i),i+=4,e.first_offset=(0,tR.kl)(t,i),i+=4):(e.earliest_presentation_time=(0,tR.xV)(t,i),i+=8,e.first_offset=(0,tR.xV)(t,i),i+=8),i+=2,e.references=[];var r=(0,tR.e$)(t,i);i+=2;for(var s=0;s<r;s++){var n={};e.references.push(n);var a=(0,tR.kl)(t,i);i+=4,n.reference_type=a>>31&1,n.referenced_size=0x7fffffff&a,n.subsegment_duration=(0,tR.kl)(t,i),i+=4,a=(0,tR.kl)(t,i),i+=4,n.starts_with_SAP=a>>31&1,n.SAP_type=a>>28&7,n.SAP_delta_time=0xfffffff&a}})}},{key:"moov",value:function(t){return tY(t,!1,function(t,i,r){t.mvhd=e.mvhd(e.findBox(i,["mvhd"],r)[0]),t.trak=e.findBox(i,["trak"],r).map(function(t){return e.trak(t)}),t.pssh=e.pssh(e.findBox(i,["pssh"],r)[0])})}},{key:"mvhd",value:function(e){return tY(e,!0,function(e,t){var i=0;1===e.version?(e.timescale=(0,tR.kl)(t,16),e.duration=(0,tR.xV)(t,20),i+=28):(e.timescale=(0,tR.kl)(t,8),e.duration=(0,tR.kl)(t,12),i+=16),e.nextTrackId=(0,tR.kl)(t,i+76)})}},{key:"trak",value:function(t){return tY(t,!1,function(t,i,r){t.tkhd=e.tkhd(e.findBox(i,["tkhd"],r)[0]),t.mdia=e.mdia(e.findBox(i,["mdia"],r)[0]),t.edts=e.edts(e.findBox(i,["edts"],r)[0])})}},{key:"tkhd",value:function(e){return tY(e,!0,function(e,t){var i=tj.fromUint8(t);1===e.version?(i.read(8),i.read(8),e.trackId=i.read(4),i.read(4),e.duration=i.read(8)):(i.read(4),i.read(4),e.trackId=i.read(4),i.read(4),e.duration=i.read(4)),i.skip(16),e.matrix=[];for(var r=0;r<36;r++)e.matrix.push(i.read(1));i.back(36);for(var s,n=[],a=0;a<3;a++)n.push((0,tR.ZT)(i.readInt(2),i.readInt(2))),n.push((0,tR.ZT)(i.readInt(2),i.readInt(2))),s=i.readInt(4),n.push((0,tR.ZT)(s>>30,0x3fffffff&s));e.rotation=(0,tR.ct)(n),e.width=i.read(4),e.height=i.read(4)})}},{key:"mdia",value:function(t){return tY(t,!1,function(t,i,r){t.mdhd=e.mdhd(e.findBox(i,["mdhd"],r)[0]),t.hdlr=e.hdlr(e.findBox(i,["hdlr"],r)[0]),t.minf=e.minf(e.findBox(i,["minf"],r)[0])})}},{key:"edts",value:function(t){return tY(t,!1,function(t,i,r){t.elst=e.elst(e.findBox(i,["elst"],r)[0])})}},{key:"elst",value:function(e){return tY(e,!0,function(e,t,i){e.entries=[],e.entriesData=t;var r=0,s=(0,tR.kl)(t,r);r+=4;for(var n=0;n<s;n++){var a={};e.entries.push(a),1===e.version?(a.segment_duration=(0,tR.xV)(t,r),r+=8,a.media_time=(0,tR.OU)(t,r),r+=8):(a.segment_duration=(0,tR.kl)(t,r),r+=4,a.media_time=(0,tR.p1)(t,r),r+=4),a.media_rate_integer=(0,tR.e$)(t,r),r+=2,a.media_rate_fraction=(0,tR.e$)(t,i),r+=2}})}},{key:"mdhd",value:function(e){return tY(e,!0,function(e,t){var i=0;1===e.version?(e.timescale=(0,tR.kl)(t,16),e.duration=(0,tR.xV)(t,20),i+=28):(e.timescale=(0,tR.kl)(t,8),e.duration=(0,tR.kl)(t,12),i+=16);var r=(0,tR.e$)(t,i);e.language=String.fromCharCode((r>>10&31)+96,(r>>5&31)+96,(31&r)+96)})}},{key:"hdlr",value:function(e){return tY(e,!0,function(e,t){0===e.version&&(e.handlerType=String.fromCharCode.apply(null,t.subarray(4,8)))})}},{key:"minf",value:function(t){return tY(t,!1,function(t,i,r){t.vmhd=e.vmhd(e.findBox(i,["vmhd"],r)[0]),t.smhd=e.smhd(e.findBox(i,["smhd"],r)[0]),t.stbl=e.stbl(e.findBox(i,["stbl"],r)[0])})}},{key:"vmhd",value:function(e){return tY(e,!0,function(e,t){e.graphicsmode=(0,tR.e$)(t),e.opcolor=[(0,tR.e$)(t,2),(0,tR.e$)(t,4),(0,tR.e$)(t,6)]})}},{key:"smhd",value:function(e){return tY(e,!0,function(e,t){e.balance=(0,tR.e$)(t)})}},{key:"stbl",value:function(t){return tY(t,!1,function(t,i,r){t.stsd=e.stsd(e.findBox(i,["stsd"],r)[0]),t.stts=e.stts(e.findBox(i,["stts"],r)[0]),t.ctts=e.ctts(e.findBox(i,["ctts"],r)[0]),t.stsc=e.stsc(e.findBox(i,["stsc"],r)[0]),t.stsz=e.stsz(e.findBox(i,["stsz"],r)[0]),t.stco=e.stco(e.findBox(i,["stco"],r)[0]),t.stco||(t.co64=e.co64(e.findBox(i,["co64"],r)[0]),t.stco=t.co64);var s,n=null==(s=t.stsd.entries[0])||null==(s=s.sinf)||null==(s=s.schi)?void 0:s.tenc.default_IV_size;t.stss=e.stss(e.findBox(i,["stss"],r)[0]),t.senc=e.senc(e.findBox(i,["senc"],r)[0],n)})}},{key:"senc",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8;return tY(e,!0,function(e,i){var r=0,s=(0,tR.kl)(i,r);r+=4,e.samples=[];for(var n=0;n<s;n++){var a={};a.InitializationVector=[];for(var o=0;o<t;o++)a.InitializationVector[o]=i[r+o];if(r+=t,2&e.flags){a.subsamples=[];var l=(0,tR.e$)(i,r);r+=2;for(var h=0;h<l;h++){var d={};d.BytesOfClearData=(0,tR.e$)(i,r),r+=2,d.BytesOfProtectedData=(0,tR.kl)(i,r),r+=4,a.subsamples.push(d)}}e.samples.push(a)}})}},{key:"pssh",value:function(e){return tY(e,!0,function(e,t){for(var i=[],r=[],s=0,n=0;n<16;n++)r.push(tQ(t[s+n]));if(s+=16,e.version>0){var a=(0,tR.kl)(t,s);s+=4;for(var o=0;o<(""+a).length;o++)for(var l=0;l<16;l++){var h=t[s];s+=1,i.push(tQ(h))}}e.data_size=(0,tR.kl)(t,s),s+=4,e.kid=i,e.system_id=r,e.buffer=t})}},{key:"bvc2",value:function(t){return tY(t,!1,function(t,i,r){var s=tq(t,i),n=i.subarray(s);r+=s,t.vvcC=e.bv2C(e.findBox(n,["bv2C"],r)[0]),t.pasp=e.pasp(e.findBox(n,["pasp"],r)[0])})}},{key:"bv2C",value:function(e){return tY(e,!1,function(e,t,i){var r=t$.parseVVCDecoderConfigurationRecord(t);for(var s in r)Object.prototype.hasOwnProperty.call(r,s)&&(e[s]=r[s])})}},{key:"stsd",value:function(t){return tY(t,!0,function(t,i,r){t.entryCount=(0,tR.kl)(i),t.entries=e.findBox(i.subarray(4),[],r+4).map(function(t){switch(t.type){case"av01":return e.av01(t);case"avc1":case"avc2":case"avc3":case"avc4":return e.avc1(t);case"hvc1":case"hev1":return e.hvc1(t);case"bvc2":return e.bvc2(t);case"mp4a":return e.mp4a(t);case"alaw":case"ulaw":return e.alaw(t);case"enca":return tY(t,!1,function(t,i,r){t.channelCount=(0,tR.e$)(i,16),t.samplesize=(0,tR.e$)(i,18),t.sampleRate=(0,tR.kl)(i,24)/65536,i=i.subarray(28),t.sinf=e.sinf(e.findBox(i,["sinf"],r)[0]),t.esds=e.esds(e.findBox(i,["esds"],r)[0])});case"encv":return tY(t,!1,function(t,i,r){t.width=(0,tR.e$)(i,24),t.height=(0,tR.e$)(i,26),t.horizresolution=(0,tR.kl)(i,28),t.vertresolution=(0,tR.kl)(i,32),i=i.subarray(78),t.sinf=e.sinf(e.findBox(i,["sinf"],r)[0]),t.avcC=e.avcC(e.findBox(i,["avcC"],r)[0]),t.hvcC=e.hvcC(e.findBox(i,["hvcC"],r)[0]),t.pasp=e.pasp(e.findBox(i,["pasp"],r)[0])})}}).filter(Boolean)})}},{key:"tenc",value:function(e){return tY(e,!1,function(e,t){var i=6;e.default_IsEncrypted=t[6],e.default_IV_size=t[i+=1],i+=1,e.default_KID=[];for(var r=0;r<16;r++)e.default_KID.push(tQ(t[i])),i+=1})}},{key:"schi",value:function(t){return tY(t,!1,function(t,i,r){t.tenc=e.tenc(e.findBox(i,["tenc"],r)[0])})}},{key:"sinf",value:function(t){return tY(t,!1,function(t,i,r){t.schi=e.schi(e.findBox(i,["schi"],r)[0]),t.frma=e.frma(e.findBox(i,["frma"],r)[0])})}},{key:"frma",value:function(e){return tY(e,!1,function(e,t){e.data_format="";for(var i=0;i<4;i++)e.data_format+=String.fromCharCode(t[i])})}},{key:"colr",value:function(e){return tY(e,!1,function(t,i){var r=tj.fromUint8(i);t.data=e.data,t.colorType=r.readString(4),"nclx"===t.colorType?(t.colorPrimaries=r.read(2),t.transferCharacteristics=r.read(2),t.matrixCoefficients=r.read(2),t.fullRangeFlag=r.read(1)>>7):("rICC"===t.colorType||"prof"===t.colorType)&&(t.iccProfile=i.readToUint8())})}},{key:"av01",value:function(t){return tY(t,!1,function(t,i,r){var s=tq(t,i),n=i.subarray(s);r+=s,t.av1C=e.av1C(e.findBox(n,["av1C"],r)[0]),t.colr=e.colr(e.findBox(n,["colr"],r)[0])})}},{key:"av1C",value:function(e){return tY(e,!1,function(t,i){t.data=e.data;var r,s=tj.fromUint8(i),n=tG.fromByte(s,4);t.marker=n.read(1),t.version=n.read(7),t.seqProfile=n.read(3),t.seqLevelIdx0=n.read(5),t.seqTier0=n.read(1),t.highBitdepth=n.read(1),t.twelveBit=n.read(1),t.monochrome=n.read(1),t.chromaSubsamplingX=n.read(1),t.chromaSubsamplingY=n.read(1),t.chromaSamplePosition=n.read(2),t.reserved=n.read(3),t.initialPresentationDelayPresent=n.read(1),t.initialPresentationDelayPresent?t.initialPresentationDelayMinusOne=n.read(4):t.initialPresentationDelayMinusOne=0,t.configOBUs=s.readToUint8(),2===t.seqLevelIdx0&&1===t.highBitdepth?r=1===t.twelveBit?"12":"10":t.seqProfile<=2&&(r=1===t.highBitdepth?"10":"08"),t.codec=["av01",t.seqProfile,(t.seqLevelIdx0<10?"0"+t.seqLevelIdx0:t.seqLevelIdx0)+(t.seqTier0?"H":"M"),r].join(".")})}},{key:"avc1",value:function(t){return tY(t,!1,function(t,i,r){var s=tq(t,i),n=i.subarray(s);r+=s,t.avcC=e.avcC(e.findBox(n,["avcC"],r)[0]),t.pasp=e.pasp(e.findBox(n,["pasp"],r)[0])})}},{key:"avcC",value:function(e){return tY(e,!1,function(t,i){t.data=e.data,t.configurationVersion=i[0],t.AVCProfileIndication=i[1],t.profileCompatibility=i[2],t.AVCLevelIndication=i[3],t.codec=(0,tR.hy)([i[1],i[2],i[3]]),t.lengthSizeMinusOne=3&i[4],t.spsLength=31&i[5],t.sps=[];for(var r=6,s=0;s<t.spsLength;s++){var n=(0,tR.e$)(i,r);r+=2,t.sps.push(i.subarray(r,r+n)),r+=n}t.ppsLength=i[r],r+=1,t.pps=[];for(var a=0;a<t.ppsLength;a++){var o=(0,tR.e$)(i,r);r+=2,t.pps.push(i.subarray(r,r+=o)),r+=o}})}},{key:"hvc1",value:function(t){return tY(t,!1,function(t,i,r){var s=tq(t,i),n=i.subarray(s);r+=s,t.hvcC=e.hvcC(e.findBox(n,["hvcC"],r)[0]),t.pasp=e.pasp(e.findBox(n,["pasp"],r)[0])})}},{key:"hvcC",value:function(e){return tY(e,!1,function(t,i){t.data=e.data,t.codec="hev1.1.6.L93.B0",t.configurationVersion=i[0];var r=i[1];t.generalProfileSpace=r>>6,t.generalTierFlag=(32&r)>>5,t.generalProfileIdc=31&r,t.generalProfileCompatibility=(0,tR.kl)(i,2),t.generalConstraintIndicatorFlags=i.subarray(6,12),t.generalLevelIdc=i[12],t.avgFrameRate=(0,tR.e$)(i,19),t.numOfArrays=i[22],t.vps=[],t.sps=[],t.pps=[];for(var s=23,n=0,a=0,o=0,l=0;l<t.numOfArrays;l++){n=63&i[s],a=(0,tR.e$)(i,s+1),s+=3;for(var h,d,u,c=[],p=0;p<a;p++)o=(0,tR.e$)(i,s),s+=2,c.push(i.subarray(s,s+o)),s+=o;32===n?(h=t.vps).push.apply(h,c):33===n?(d=t.sps).push.apply(d,c):34===n&&(u=t.pps).push.apply(u,c)}})}},{key:"pasp",value:function(e){return tY(e,!1,function(e,t){e.hSpacing=(0,tR.kl)(t),e.vSpacing=(0,tR.kl)(t,4)})}},{key:"mp4a",value:function(t){return tY(t,!1,function(t,i,r){var s=tK(t,i);t.esds=e.esds(e.findBox(i.subarray(s),["esds"],r+s)[0])})}},{key:"esds",value:function(e){return tY(e,!0,function(e,t){e.codec="mp4a.";for(var i=0,r=0,s=0,n=0;t.length;){for(n=t[i=0],r=t[i+1],i+=2;128&r;)s=(127&r)<<7,r=t[i],i+=1;if(s+=127&r,3===n)t=t.subarray(i+3);else if(4===n)e.codec+=(t[i].toString(16)+".").padStart(3,"0"),t=t.subarray(i+13);else if(5===n){var a=e.config=t.subarray(i,i+s),o=(248&a[0])>>3;31===o&&a.length>=2&&(o=32+((7&a[0])<<3)+((224&a[1])>>5)),e.objectType=o,e.codec+=o.toString(16),"."===e.codec[e.codec.length-1]&&(e.codec=e.codec.substring(0,e.codec.length-1));return}else{"."===e.codec[e.codec.length-1]&&(e.codec=e.codec.substring(0,e.codec.length-1));return}}})}},{key:"alaw",value:function(e){return tY(e,!1,function(e,t){tK(e,t)})}},{key:"stts",value:function(e){return tY(e,!0,function(e,t){for(var i=(0,tR.kl)(t),r=[],s=4,n=0;n<i;n++)r.push({count:(0,tR.kl)(t,s),delta:(0,tR.kl)(t,s+4)}),s+=8;e.entryCount=i,e.entries=r})}},{key:"ctts",value:function(e){return tY(e,!0,function(e,t){var i=(0,tR.kl)(t),r=[],s=4;if(1===e.version)for(var n=0;n<i;n++)r.push({count:(0,tR.kl)(t,s),offset:(0,tR.kl)(t,s+4)}),s+=8;else for(var a=0;a<i;a++)r.push({count:(0,tR.kl)(t,s),offset:-(~(0,tR.kl)(t,s+4)+1)}),s+=8;e.entryCount=i,e.entries=r})}},{key:"stsc",value:function(e){return tY(e,!0,function(e,t){for(var i=(0,tR.kl)(t),r=Array(i),s=4,n=0;n<i;n++)r[n]={firstChunk:(0,tR.kl)(t,s),samplesPerChunk:(0,tR.kl)(t,s+4),sampleDescriptionIndex:(0,tR.kl)(t,s+8)},s+=12;e.entryCount=i,e.entries=r})}},{key:"stsz",value:function(e){return tY(e,!0,function(e,t){var i=(0,tR.kl)(t),r=(0,tR.kl)(t,4),s=Array(r);if(!i)for(var n=8,a=0;a<r;a++)s[a]=(0,tR.kl)(t,n),n+=4;e.sampleSize=i,e.sampleCount=r,e.entrySizes=s})}},{key:"stco",value:function(e){return tY(e,!0,function(e,t){for(var i=(0,tR.kl)(t),r=Array(i),s=4,n=0;n<i;n++)r[n]=(0,tR.kl)(t,s),s+=4;e.entryCount=i,e.entries=r})}},{key:"co64",value:function(e){return tY(e,!0,function(e,t){for(var i=(0,tR.kl)(t),r=Array(i),s=4,n=0;n<i;n++)r[n]=(0,tR.xV)(t,s),s+=8;e.entryCount=i,e.entries=r})}},{key:"stss",value:function(e){return tY(e,!0,function(e,t){for(var i=(0,tR.kl)(t),r=Array(i),s=4,n=0;n<i;n++)r[n]=(0,tR.kl)(t,s),s+=4;e.entryCount=i,e.entries=r})}},{key:"moof",value:function(t){return tY(t,!1,function(t,i,r){t.mfhd=e.mfhd(e.findBox(i,["mfhd"],r)[0]),t.traf=e.findBox(i,["traf"],r).map(function(t){return e.traf(t)})})}},{key:"mfhd",value:function(e){return tY(e,!0,function(e,t){e.sequenceNumber=(0,tR.kl)(t)})}},{key:"traf",value:function(t){return tY(t,!1,function(t,i,r){t.tfhd=e.tfhd(e.findBox(i,["tfhd"],r)[0]),t.tfdt=e.tfdt(e.findBox(i,["tfdt"],r)[0]),t.trun=e.trun(e.findBox(i,["trun"],r)[0])})}},{key:"trun",value:function(e){return tY(e,!0,function(e,t){var i=e.version,r=e.flags,s=t.length,n=e.sampleCount=(0,tR.kl)(t),a=4;if(s>4&&1&r&&(e.dataOffset=-(~(0,tR.kl)(t,a)+1),a+=4),s>a&&4&r&&(e.firstSampleFlags=(0,tR.kl)(t,a),a+=4),s>a){e.samples=Array(n);for(var o,l=0;l<n;l++)o={},256&r&&(o.duration=(0,tR.kl)(t,a),a+=4),512&r&&(o.size=(0,tR.kl)(t,a),a+=4),1024&r&&(o.flags=(0,tR.kl)(t,a),a+=4),2048&r&&(i?o.cts=-(~(0,tR.kl)(t,a+4)+1):o.cts=(0,tR.kl)(t,a),a+=4),e.samples[l]=o}})}},{key:"tfdt",value:function(e){return tY(e,!0,function(e,t){1===e.version?e.baseMediaDecodeTime=(0,tR.xV)(t):e.baseMediaDecodeTime=(0,tR.kl)(t)})}},{key:"probe",value:function(t){return!!e.findBox(t,["ftyp"])}},{key:"parseSampleFlags",value:function(e){return{isLeading:(12&e[0])>>>2,dependsOn:3&e[0],isDependedOn:(192&e[1])>>>6,hasRedundancy:(48&e[1])>>>4,paddingValue:(14&e[1])>>>1,isNonSyncSample:1&e[1],degradationPriority:e[2]<<8|e[3]}}},{key:"moovToTrack",value:function(e,t,i){var r=e.trak;if(r&&r.length){var s=r.find(function(e){var t;return(null==(t=e.mdia)||null==(t=t.hdlr)?void 0:t.handlerType)==="vide"}),n=r.find(function(e){var t;return(null==(t=e.mdia)||null==(t=t.hdlr)?void 0:t.handlerType)==="soun"});if(s&&t){null!=(null==(l=s.tkhd)?void 0:l.trackId)&&(t.id=s.tkhd.trackId),t.tkhdDuration=s.tkhd.duration,t.mvhdDurtion=e.mvhd.duration,t.mvhdTimecale=e.mvhd.timescale,t.timescale=t.formatTimescale=s.mdia.mdhd.timescale,t.duration=s.mdia.mdhd.duration||t.mvhdDurtion/t.mvhdTimecale*t.timescale,t.rotation=s.tkhd.rotation,t.matrix=s.tkhd.matrix,null!=(h=s.edts)&&h.elst&&(t.editList=s.edts.elst,t.editListApplied=s.editListApplied);var a,o,l,h,d,u,c,p,f,m,g=s.mdia.minf.stbl.stsd.entries[0];if(t.width=g.width,t.height=g.height,g.pasp&&(t.sarRatio=[g.pasp.hSpacing,g.pasp.vSpacing]),g.av1C)t.codecType=tz.mT.AV1,t.codec=g.av1C.codec,t.av1C=g.av1C.data,t.colr=g.colr.data;else if(g.hvcC)t.codecType=tz.mT.HEVC,t.codec=g.hvcC.codec,t.vps=g.hvcC.vps,t.sps=g.hvcC.sps,t.pps=g.hvcC.pps,t.hvcC=g.hvcC.data;else if(g.avcC)t.codec=g.avcC.codec,t.sps=g.avcC.sps,t.pps=g.avcC.pps;else if(g.vvcC)t.codecType=tz.mT.VVCC,t.codec=g.vvcC.codec,t.sps=g.vvcC.sps,t.pps=g.vvcC.pps,t.vps=g.vvcC.vps,t.vvcC=g.vvcC.data;else throw Error("unknown video stsd entry");t.present=!0,t.ext={},t.ext.stss=null==(d=s.mdia)||null==(d=d.minf)||null==(d=d.stbl)?void 0:d.stss,t.ext.ctts=null==(u=s.mdia)||null==(u=u.minf)||null==(u=u.stbl)?void 0:u.ctts,g&&"encv"===g.type&&(t.isVideoEncryption=!0,g.default_KID=null==(c=g.sinf)||null==(c=c.schi)?void 0:c.tenc.default_KID,g.default_IsEncrypted=null==(p=g.sinf)||null==(p=p.schi)?void 0:p.tenc.default_IsEncrypted,g.default_IV_size=null==(f=g.sinf)||null==(f=f.schi)?void 0:f.tenc.default_IV_size,t.videoSenc=s.mdia.minf.stbl.senc&&s.mdia.minf.stbl.senc.samples,g.data_format=null==(m=g.sinf)||null==(m=m.frma)?void 0:m.data_format,t.useEME=e.useEME,t.kidValue=e.kidValue,t.pssh=e.pssh,t.encv=g)}if(n&&i){null!=(null==(_=n.tkhd)?void 0:_.trackId)&&(i.id=n.tkhd.trackId),i.tkhdDuration=n.tkhd.duration,i.mvhdDurtion=e.mvhd.duration,i.mvhdTimecale=e.mvhd.timescale,i.timescale=i.formatTimescale=n.mdia.mdhd.timescale,i.duration=n.mdia.mdhd.duration||i.mvhdDurtion/i.mvhdTimecale*i.timescale,null!=(v=n.edts)&&v.elst&&(i.editList=n.edts.elst,i.editListApplied=n.editListApplied);var _,v,y,A,T,b,S,E,k,P,w=n.mdia.minf.stbl.stsd.entries[0];switch(i.sampleSize=w.sampleSize,i.sampleRate=w.sampleRate,i.channelCount=w.channelCount,i.present=!0,w.type){case"alaw":i.codecType=i.codec=tz.VE.G711PCMA,i.sampleRate=8e3;break;case"ulaw":i.codecType=i.codec=tz.VE.G711PCMU,i.sampleRate=8e3;break;default:i.sampleDuration=tU.getFrameDuration(i.sampleRate,i.timescale),i.sampleRateIndex=tU.getRateIndexByRate(i.sampleRate),i.objectType=(null==(a=w.esds)?void 0:a.objectType)||2,w.esds&&(i.config=Array.from(w.esds.config)),i.codec=(null==(o=w.esds)?void 0:o.codec)||"mp4a.40.2"}i.sampleDuration=tU.getFrameDuration(i.sampleRate,i.timescale),i.objectType=(null==(y=w.esds)?void 0:y.objectType)||2,w.esds&&(w.esds.config?i.config=Array.from(w.esds.config):console.warn("esds config is null")),i.codec=(null==(A=w.esds)?void 0:A.codec)||"mp4a.40.2",i.sampleRateIndex=tU.getRateIndexByRate(i.sampleRate),i.ext={},i.ext.stss=null==(T=n.mdia)||null==(T=T.minf)||null==(T=T.stbl)?void 0:T.stss,i.ext.ctts=null==(b=n.mdia)||null==(b=b.minf)||null==(b=b.stbl)?void 0:b.ctts,i.present=!0,w&&"enca"===w.type&&(i.isAudioEncryption=!0,w.data_format=null==(S=w.sinf)||null==(S=S.frma)?void 0:S.data_format,w.default_KID=null==(E=w.sinf)||null==(E=E.schi)?void 0:E.tenc.default_KID,w.default_IsEncrypted=null==(k=w.sinf)||null==(k=k.schi)?void 0:k.tenc.default_IsEncrypted,w.default_IV_size=null==(P=w.sinf)||null==(P=P.schi)?void 0:P.tenc.default_IV_size,i.audioSenc=n.mdia.minf.stbl.senc&&n.mdia.minf.stbl.senc.samples,i.useEME=e.useEME,i.kidValue=e.kidValue,i.enca=w)}if(i&&(i.isVideoEncryption=!!t&&t.isVideoEncryption),t&&(t.isAudioEncryption=!!i&&i.isAudioEncryption),null!=t&&t.encv||null!=i&&i.enca){var x,C,L=null==t||null==(x=t.encv)?void 0:x.default_KID,D=null==i||null==(C=i.enca)?void 0:C.default_KID,I=L||D?(L||D).join(""):null;t&&(t.kid=I),i&&(i.kid=I)}return t&&(t.flags=3841),i&&(i.flags=1793),{videoTrack:t,audioTrack:i}}}},{key:"evaluateDefaultDuration",value:function(e,t,i){var r,s=null==t||null==(r=t.samples)?void 0:r.length;return s?1024*s/t.timescale*e.timescale/i:1024}},{key:"moofToSamples",value:function(t,i,r){var s={};return t.mfhd&&(i&&(i.sequenceNumber=t.mfhd.sequenceNumber),r&&(r.sequenceNumber=t.mfhd.sequenceNumber)),t.traf.forEach(function(t){var n=t.tfhd,a=t.tfdt,o=t.trun;if(n&&o){a&&(i&&i.id===n.trackId&&(i.baseMediaDecodeTime=a.baseMediaDecodeTime),r&&r.id===n.trackId&&(r.baseMediaDecodeTime=a.baseMediaDecodeTime));var l=n.defaultSampleSize||0,h=n.defaultSampleDuration||e.evaluateDefaultDuration(i,r,o.samples.length||o.sampleCount),d=o.dataOffset||0,u=0,c=-1;if(!o.samples.length&&o.sampleCount){s[n.trackId]=Array(o.sampleCount);for(var p=0;p<o.sampleCount;p++)s[n.trackId][p]={offset:d,dts:u,duration:h,size:l},u+=h,d+=l}else s[n.trackId]=o.samples.map(function(e,t){return(e={offset:d,dts:u,pts:u+(e.cts||0),duration:e.duration||h,size:e.size||l,gopId:c,keyframe:0===t||null!==e.flags&&void 0!==e.flags&&(65536&e.flags)>>>0!=65536}).keyframe&&(c++,e.gopId=c),u+=e.duration,d+=e.size,e})}}),s}},{key:"moovToSamples",value:function(e){var t=e.trak;if(t&&t.length){var i=t.find(function(e){var t;return(null==(t=e.mdia)||null==(t=t.hdlr)?void 0:t.handlerType)==="vide"}),r=t.find(function(e){var t;return(null==(t=e.mdia)||null==(t=t.hdlr)?void 0:t.handlerType)==="soun"});if(i||r){if(i){var s,n,a,o=null==(a=i.mdia)||null==(a=a.minf)?void 0:a.stbl;if(!o)return;var l=o.stts,h=o.stsc,d=o.stsz,u=o.stco,c=o.stss,p=o.ctts;if(!l||!h||!d||!u||!c)return;s=tW(l,h,d,u,p,c)}if(r){var f,m,g=null==(f=r.mdia)||null==(f=f.minf)?void 0:f.stbl;if(!g)return;var _=null==(m=r.mdia.mdhd)?void 0:m.timescale,v=g.stts,y=g.stsc,A=g.stsz,T=g.stco;if(!_||!v||!y||!A||!T)return;n=tW(v,y,A,T)}return{videoSamples:s,audioSamples:n}}}}}])}();function tW(e,t,i,r,s,n){var a,o,l,h=[],d=null==s?void 0:s.entries,u=t.entries,c=r.entries,p=i.entrySizes,f=null==n?void 0:n.entries;f&&(a={},f.forEach(function(e){a[e-1]=!0})),d&&(o=[],d.forEach(function(e){for(var t=e.count,i=e.offset,r=0;r<t;r++)o.push(i)}));var m=-1,g=0,_=0,v=0,y=0,A=0,T=u[0].samplesPerChunk,b=u[1]?u[1].firstChunk-1:1/0;return e.entries.forEach(function(e){for(var t=e.count,r=e.delta,s=0;s<t;s++)l={dts:g,duration:r,size:p[_]||i.sampleSize,offset:c[v]+A,index:_},f&&(l.keyframe=a[_],l.keyframe&&m++,l.gopId=m),o&&_<o.length&&(l.pts=l.dts+o[_]),h.push(l),g+=r,++_<T?A+=l.size:(v++,A=0,v>=b&&(b=u[++y+1]?u[y+1].firstChunk-1:1/0),T+=u[y].samplesPerChunk)}),h}function tq(e,t){return e.dataReferenceIndex=(0,tR.e$)(t,6),e.width=(0,tR.e$)(t,24),e.height=(0,tR.e$)(t,26),e.horizresolution=(0,tR.kl)(t,28),e.vertresolution=(0,tR.kl)(t,32),e.frameCount=(0,tR.e$)(t,40),e.depth=(0,tR.e$)(t,74),78}function tK(e,t){return e.dataReferenceIndex=(0,tR.e$)(t,6),e.channelCount=(0,tR.e$)(t,16),e.sampleSize=(0,tR.e$)(t,18),e.sampleRate=(0,tR.kl)(t,24)/65536,28}function tY(e,t,i){if(e){if(e.size!==e.data.length)throw Error("box ".concat(e.type," size !== data.length"));var r={start:e.start,size:e.size,headerSize:e.headerSize,type:e.type};return t&&(r.version=e.data[e.headerSize],r.flags=(0,tR.nO)(e.data,e.headerSize+1),r.headerSize+=4),i(r,e.data.subarray(r.headerSize),r.start+r.headerSize),r}}var tX=function(e,t,i){for(var r=String(i),s=0|t,n=Math.ceil(s/r.length),a=[],o=String(e);n--;)a.push(r);return a.join("").substring(0,s-o.length)+o},tQ=function(){for(var e=[],t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];return i.forEach(function(t){e.push(tX(Number(t).toString(16),2,0))}),e[0]},tJ=e9(function e(t,i){e3(this,e),this.type="file",this.message=t,this.data=i}),tZ=e9(function e(){e3(this,e),e7(this,"_data",Object.create(null))},[{key:"set",value:function(e,t){this._data[e]=t}},{key:"get",value:function(e){return this._data[e]}},{key:"clear",value:function(){this._data=Object.create(null)}}]),t0=e9(function e(){e3(this,e),this.frames=[],this.dur=0,this.minPts=Number.MAX_VALUE,this.maxPts=0},[{key:"appendFrame",value:function(e){this.frames.push(e),this.dur+=e.duration}},{key:"calMinMaxPts",value:function(e){e.pts<this.minPts&&(this.minPts=e.pts);var t=e.pts+e.duration;t>this.maxPts&&(this.maxPts=t)}}]);function t1(e,t){var i=e.trak;if(i&&i.length){var r=i.find(function(e){var t;return(null==(t=e.mdia)||null==(t=t.hdlr)?void 0:t.handlerType)==="vide"}),s=i.find(function(e){var t;return(null==(t=e.mdia)||null==(t=t.hdlr)?void 0:t.handlerType)==="soun"});if(r||s){var n=[],a=[];if(t){var o=[],l=0,h=t.start+t.size;t.references.forEach(function(e,i){o.push({index:i,startTime:l,endTime:l+e.subsegment_duration/t.timescale,duration:e.subsegment_duration/t.timescale,range:[h,h+e.referenced_size],frames:[]}),l+=e.subsegment_duration/t.timescale,h+=e.referenced_size}),n=o,a=o}else{var d,u,c=function(t){return t?[{index:0,startTime:0,endTime:t.duration/t.timescale,duration:t.duration/t.timescale,range:[e.start+e.size,""],frames:[]}]:[]};a=c(e.mvhd.duration?e.mvhd:null==(d=r.mdia)?void 0:d.mdhd),n=c(e.mvhd.duration?e.mvhd:null==(u=s.mdia)?void 0:u.mdhd)}return{videoSegments:a,audioSegments:n}}}}function t2(e,t){var i,r=t.segmentDuration,s=e.trak;if(s&&s.length){var n=s.find(function(e){var t;return(null==(t=e.mdia)||null==(t=t.hdlr)?void 0:t.handlerType)==="vide"}),a=s.find(function(e){var t;return(null==(t=e.mdia)||null==(t=t.hdlr)?void 0:t.handlerType)==="soun"});if(n||a){var o=[],l=[];return n&&(i=(o=t4("video",n,r,t)).map(function(e){return e.duration})),a&&(l=t4("audio",a,r,t,i,o)),{videoSegments:o,audioSegments:l}}}}function t4(e,t,i,r){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],n=arguments.length>5?arguments[5]:void 0,a=r.fixEditListOffset,o=r.fixEditListOffsetThreshold,l=r.audioGroupingStrategy,h=r.memoryOpt,d=null==(J=t.mdia)||null==(J=J.minf)?void 0:J.stbl;if(!d)return[];var u=null==(Z=t.mdia.mdhd)?void 0:Z.timescale,c=d.stts,p=d.stsc,f=d.stsz,m=d.stco,g=d.stss,_=d.ctts;if(!u||!c||!p||!f||!m||"video"===e&&!g)return[];var v=0,y=null==(ee=t.edts)||null==(ee=ee.elst)?void 0:ee.entries;if(a&&function(){var e=!0,t=navigator.userAgent||"";if(/Chrome/gi.test(t)&&!/Edge\//gi.test(t)){var i=t.match(/Chrome\/(\d+)/i),r=i?parseInt(i[1],10):0;e=!!r&&r>=75}return e}()&&Array.isArray(y)&&y.length>0){var A=y[0].media_time;A>0&&A<(o?o*u:5*u)&&(v=A)}var T=[],b=[],S=[],E=[],k=[],P=p.entries,w=m.entries,x=f.entrySizes,C=null==g?void 0:g.entries,L=null==_?void 0:_.entries,D=[],I={};!h&&(L&&L.forEach(function(e){for(var t=e.count,i=e.offset,r=0;r<t;r++)D.push(i)}),C&&C.forEach(function(e){I[e-1]=!0}));var R=0,O=0,M=0,B=0,N=P.length>0?P[0].samplesPerChunk:0,U=P.length>1&&P[1]?P[1].firstChunk-1:1/0,F=0,V=-1,$=!1,z={};(null==L?void 0:L.length)>0&&v>0&&(F-=v,$=!0),t.editListApplied=$,h&&(ei=null==C?void 0:C.shift()),c.entries.forEach(function(e){for(var t=e.count,i=e.delta,r=0;r<t;r++){if(et={dts:F,duration:i,size:x[R]||f.sampleSize,offset:w[O]+B,index:R},L&&(h?(function(e,t,i){i.offset=0;var r=(null==i?void 0:i.beforeFrameNum)||0,s=(null==i?void 0:i.usedCttsIdx)||0;if(!e||(null==e?void 0:e.length)<=0||(null==i?void 0:i.usedCttsIdx)>=e.length)i.offset=0,i.usedCttsIdx=s,i.beforeFrameNum=r;else{var n=e[s];if(t<r+((null==n?void 0:n.count)||1))i.offset=(null==n?void 0:n.offset)||0;else{var a=e[++s];a?(i.offset=a.offset||0,i.beforeFrameNum=r+n.count):(i.offset=0,i.beforeFrameNum=r+1),i.usedCttsIdx=s}}}(L,R,z),et.pts=F+((null==z?void 0:z.offset)||0)):D&&R<D.length&&(et.pts=F+D[R])),0===v&&0===R&&(et.pts=0),void 0===et.pts&&(et.pts=et.dts),C){if(h?R+1===ei&&(et.keyframe=!0,ei=C.shift()):et.keyframe=I[R],et.keyframe)if(V++,h){var s=new t0;s.appendFrame(et),b.push(s)}else b.push([et]),S.push(et.duration);else h?b[b.length-1].appendFrame(et):(b[b.length-1].push(et),S[b.length-1]+=et.duration);et.gopId=V,h&&b[b.length-1].calMinMaxPts(et)}if(!h){if(et.keyframe?E[E.length]=et.pts:et.pts<E[b.length-1]&&(E[b.length-1]=et.pts),et.keyframe)k[k.length]=et.index;else if(b.length>0&&void 0!==k[b.length-1]){var n,a=null==(n=T[k[b.length-1]])?void 0:n.pts;void 0!==a&&et.pts>a&&(k[b.length-1]=et.index)}}T[T.length]=et,F+=i,++R<N?B+=et.size:(O++,B=0,O>=U&&(U=P[++M+1]?P[M+1].firstChunk-1:1/0),N+=P[M].samplesPerChunk)}});var j=T.length;if(!j||g&&!T[0].keyframe)return[];var G=[],H=[],W=0,q=0,K=0,Y=0,X=function(e,t,i){er=H[H.length-1],h?(K=(null==b?void 0:b.length)>0?b[t].minPts:H[0].pts,Y=(null==b?void 0:b.length)>0?b[i].maxPts:er.pts+er.duration):(K=E[t],Y=(es=T[k[i]]).pts+es.duration),0===G.length&&(e=(Y-K)/u),G.push({index:G.length,startTime:K/u,endTime:Y/u,duration:e,range:[H[0].offset,er.offset+er.size-1],frames:H}),1!==l&&(W=0),H=[]},Q=0;if(g)for(var J,Z,ee,et,ei,er,es,en,ea,eo=i*u,el=0,eh=b.length;el<eh;el++)h?(W+=b[el].dur,(en=H).push.apply(en,tl(b[el].frames))):(W+=S[el],(ea=H).push.apply(ea,tl(b[el]))),el+1<eh?(0===el||W>eo)&&(X(W/u,Q,el),W=0,Q=el+1):(X(W/u,Q,el),W=0,Q=el+1);else{h||(E=[],k=[]);var ed=s[0]||i;if(1===l)for(var eu,ec=0;ec<j;ec++){var ep=T[ec],ef=T[ec+1],em=ec===j-1;H.push(ep),W+=ep.duration;var eg=eu||W/u;eu=(ef?W+ef.duration:0)/u,(em||(n[G.length]?eu>n[G.length].endTime:eu-H[0].pts/u>=ed))&&(h||(E.push(H[0].pts),k.push(H[H.length-1].index)),X(eg,G.length,G.length),ed=s[G.length]||i)}else for(var e_,ev=0;ev<j;ev++){var ey=T[ev],eA=T[ev+1],eT=ev===j-1;H.push(ey),W+=ey.duration;var eb=e_||W/u;e_=(eA?W+eA.duration:0)/u,(eT||e_+q>=ed)&&(2===l?q+=W/u-ed:q+=e_-ed,h||(E.push(H[0].pts),k.push(H[H.length-1].index)),X(eb,G.length,G.length),ed=s[G.length]||i)}}return G}function t8(e,t){var i="",r="",s=0,n=0,a=0,o=0,l=0,h=0,d=0;e.mvhd&&(l=e.mvhd.duration/e.mvhd.timescale);var u=e.trak;if(u){var c,p,f,m,g,_,v,y,A,T=u.find(function(e){var t;return(null==(t=e.mdia)||null==(t=t.hdlr)?void 0:t.handlerType)==="vide"}),b=u.find(function(e){var t;return(null==(t=e.mdia)||null==(t=t.hdlr)?void 0:t.handlerType)==="soun"}),S=null;return T&&(S=null==(p=T.mdia)||null==(p=p.minf)||null==(p=p.stbl)?void 0:p.stsd.entries[0])&&(s=S.width,n=S.height,h=null==(f=T.mdia)||null==(f=f.mdhd)?void 0:f.timescale,i=null==(m=S.avcC||S.hvcC||S.av1C||S.vvcC)?void 0:m.codec,"encv"===S.type&&(c=null==(g=S.sinf)||null==(g=g.schi)?void 0:g.tenc.default_KID)),b&&(S=null==(_=b.mdia)||null==(_=_.minf)||null==(_=_.stbl)?void 0:_.stsd.entries[0])&&(a=S.channelCount,o=S.sampleRate,r=null==(v=S.esds)?void 0:v.codec,d=null==(y=b.mdia)||null==(y=y.mdhd)?void 0:y.timescale,"enca"===S.type&&(c=c||(null==(A=S.sinf)||null==(A=A.schi)?void 0:A.tenc.default_KID))),{kid:c?c.join(""):null,videoCodec:i,audioCodec:r,width:s,height:n,videoTimescale:h,audioChannelCount:a,audioSampleRate:o,duration:l,audioTimescale:d,moov:e,isFragmentMP4:t}}}function t5(e){return"number"==typeof e&&!Number.isNaN(e)}function t3(e){if(!e)return!1;var t=e.audioSegments,i=e.videoSegments,r=!i||0===i.length,s=!t||0===t.length;return!r||!s}var t6=["vid","cache"],t9=function(e){var t,i,r,s,n,a,o,l,h,d,u;function c(e){e3(this,c),t=te(t=c),e7(r=function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(this,tt()?Reflect.construct(t,[],te(this).constructor):t.apply(this,i)),"vid",""),e7(r,"url",""),e7(r,"meta",{}),e7(r,"downloadInfo",[]),e7(r,"videoSegments",[]),e7(r,"audioSegments",[]),e7(r,"cache",null),e7(r,"_currentSegmentIndex",-1),e7(r,"_currentLoadingSegmentIndex",-1),e7(r,"buffer",void 0),e7(r,"bufferDataLen",0),e7(r,"_error",void 0),e7(r,"_transformError",function(e){return e}),"boolean"!=typeof e.fixEditListOffset&&delete e.fixEditListOffset,r._config=tr({vid:"",moovEnd:8e4,segmentDuration:2,maxDownloadInfoSize:30,responseType:"arraybuffer",fixEditListOffset:!0,cache:null},e);var t,i,r,s=r._config,n=s.vid,a=s.cache,o=function(e,t){if(null==e)return{};var i,r,s=function(e,t){if(null==e)return{};var i={};for(var r in e)if(({}).hasOwnProperty.call(e,r)){if(-1!==t.indexOf(r))continue;i[r]=e[r]}return i}(e,t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);for(r=0;r<n.length;r++)i=n[r],-1===t.indexOf(i)&&({}).propertyIsEnumerable.call(e,i)&&(s[i]=e[i])}return s}(s,t6);return r.cache=a||new tZ,r.vid=n||o.url,r.url=o.url,o.transformError=r._transformError,r.logger=new ev.V("MP4Loader_"+r.vid),e.openLog&&ev.V.enable(),o.logger=r.logger,r._loader=new tD(o),r._loader.on(tS,function(e){r.emit(tS,e)}),r}if("function"!=typeof e&&null!==e)throw TypeError("Super expression must either be null or a function");return c.prototype=Object.create(e&&e.prototype,{constructor:{value:c,writable:!0,configurable:!0}}),Object.defineProperty(c,"prototype",{writable:!1}),e&&to(c,e),e9(c,[{key:"isMetaLoaded",get:function(){return this.videoSegments.length||this.audioSegments.length}},{key:"setCurrentSegment",value:function(e){t5(e)&&(this._currentSegmentIndex=e)}},{key:"isLastSegment",value:function(e){if(t5(e)){var t,i;return e>=((null==(t=this.videoSegments[this.videoSegments.length-1])?void 0:t.index)||(null==(i=this.audioSegments[this.audioSegments.length-1])?void 0:i.index)||0)}return!1}},{key:"isSegmentLoading",value:function(e){return e===this._currentLoadingSegmentIndex}},{key:"changeUrl",value:(t=e5(tn().m(function e(t){var i,r,s,n=arguments;return tn().w(function(e){for(;;)switch(e.n){case 0:return i=n.length>1&&void 0!==n[1]?n[1]:t,r=n.length>2?n[2]:void 0,s=n.length>3?n[3]:void 0,e.n=1,this.reset(s);case 1:t&&(this.url=t),i&&(this.vid=i),r&&(this._config.moovEnd=r);case 2:return e.a(2)}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"getOrLoadMeta",value:(i=e5(tn().m(function e(t){return tn().w(function(e){for(;;)switch(e.n){case 0:if(this.isMetaLoaded){e.n=1;break}return e.n=1,this.loadMeta(t);case 1:return e.a(2,this.meta)}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"newBufferArray",value:function(e,t){var i;if(this.buffer){if(t||(null==(i=this.buffer)?void 0:i.byteLength)<e){var r,s=this.buffer.subarray(0,this.bufferDataLen),n=tL(((null==(r=this.buffer)?void 0:r.byteLength)||0)+e);n.set(s,0),delete this.buffer,this.buffer=n}}else this.buffer=tL(e),this.bufferDataLen=0}},{key:"loadMetaProcess",value:(r=e5(tn().m(function e(t,i,r){var s,n,a,o,l,h,d=this,u=arguments;return tn().w(function(e){for(;;)switch(e.n){case 0:if(a=(n=function(e){if(Array.isArray(e))return e}(i)||function(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var r,s,n,a,o=[],l=!0,h=!1;try{n=(i=i.call(e)).next,!1;for(;!(l=(r=n.call(i)).done)&&(o.push(r.value),o.length!==t);l=!0);}catch(e){h=!0,s=e}finally{try{if(!l&&null!=i.return&&(a=i.return(),Object(a)!==a))return}finally{if(h)throw s}}return o}}(i,2)||td(i,2)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())[0],o=n[1],l=u.length>3&&void 0!==u[3]?u[3]:{},this._error=!1,this.logger.debug("[loadMetaProcess start], range,",[a,o]),null!=(s=this._config)&&s.memoryOpt&&(!this.buffer||null!=l&&l.isExp))try{this.newBufferArray(o-a+1,null==l?void 0:l.isExp)}catch(e){r(null,!0,{},new tJ(null==e?void 0:e.message),{})}return h=function(){var e=e5(tn().m(function e(i,s,n,h){var u,c,p,f,m,g,_,v,y,A,T,b,S,E,k,P,w;return tn().w(function(e){for(;;)switch(e.n){case 0:if(d.meta&&null!=n&&n.range&&n.range.length>0&&n.range[1]>=o&&(s=!0,d.logger.debug("[loadMetaProcess],data done,setstate true,[",a,o,"]")),s&&null!=n&&n.range&&n.range.length>0&&n.range[1]<o&&(s=!1,d.logger.debug("[loadMetaProcess],data not done,setstate false,[",a,o,"]")),d.logger.debug("[loadMetaProcess],task,[",a,o,"], range,",n.range,",dataLen,",i?i.byteLength:void 0,", state,",s,",err,",d._error),!d._error&&i&&i.byteLength>0&&r(i,s,n,null,h),!(d.meta.moov||d._error)){e.n=1;break}return e.a(2);case 1:if(!(i&&i.byteLength>0)){e.n=13;break}e.p=2,null!=(c=d._config)&&c.memoryOpt?(d.buffer.set(i,d.bufferDataLen),d.bufferDataLen+=(null==i?void 0:i.byteLength)||0,u=d.buffer.subarray(0,d.bufferDataLen)):(d.buffer=tC(d.buffer,i),u=d.buffer),e.n=4;break;case 3:return e.p=3,w=e.v,r(null,s,n,new tJ(null==w?void 0:w.message),h),e.a(2);case 4:if((p=tH.findBox(u,["moov"])[0])||(f=tH.findBox(u,["mdat"])[0],!s)){e.n=7;break}if(f){e.n=5;break}return d._error=!0,r(null,s,n,new tJ("cannot find moov or mdat box"),h),e.a(2);case 5:return m=f.start+f.size,e.n=6,d.loadData([m,""],t,l);case 6:(g=e.v)&&(p=tH.findBox(g.data,["moov"])[0]);case 7:if(!(p&&s&&p.size>p.data.length)){e.n=8;break}return d.logger.debug("[loadMetaProcess],moov not all, range,",n.range[1],",dataLen,",d.bufferDataLen,", state,",s),e.n=8,d.loadMetaProcess(t,[n.range[1],p.start+p.size-1],r,{isExp:!0});case 8:if(!(p&&p.size<=p.data.length&&!d.meta.moov)){e.n=13;break}if(v=tH.moov(p)){e.n=9;break}return d._error=!0,r(null,s,n,new tJ("cannot parse moov box"),h),e.a(2);case 9:if(y=t2(v,d._config),A=function(){var e=e5(tn().m(function e(i){var r,s;return tn().w(function(e){for(;;)switch(e.n){case 0:if(!(r=tH.findBox(d.buffer,[i])[0])){e.n=4;break}if(!(r.size>r.data.length)){e.n=3;break}return e.n=1,d.loadData([r.start,r.start+r.size-1],t,l);case 1:if(!(s=e.v)){e.n=2;break}return e.a(2,tH.findBox(s.data,[i])[0]);case 2:e.n=4;break;case 3:return e.a(2,r);case 4:return e.a(2)}},e)}));return function(t){return e.apply(this,arguments)}}(),T=!1,y&&y.videoSegments.length&&y.audioSegments.length){e.n=11;break}return e.n=10,A("sidx");case 10:(b=e.v)&&(S=tH.sidx(b))&&(t1(v,S),ts("segments"),T=!0);case 11:if(t3(y)){e.n=12;break}return d._error=!0,r(null,s,n,new tJ("cannot parse segments"),h),e.a(2);case 12:d.meta=t8(v,T),k=(E=y).videoSegments,P=E.audioSegments,d.videoSegments=k,d.audioSegments=P,null!=(_=d._config)&&_.memoryOpt&&(delete d.buffer,d.bufferDataLen=0),d.logger.debug("[loadMetaProcess] moov ok"),r(void 0,s,{meta:{meta:d.meta,videoSegments:k,audioSegments:P}},null,h);case 13:return e.a(2)}},e,null,[[2,3]])}));return function(t,i,r,s){return e.apply(this,arguments)}}(),e.n=1,this.loadData([a,o||this._config.moovEnd],t,tr({onProgress:h},l));case 1:return e.a(2)}},e,this)})),function(e,t,i){return r.apply(this,arguments)})},{key:"loadMeta",value:(s=e5(tn().m(function e(t,i){var r,s,n,a,o,l,h,d,u,c,p,f,m,g,_,v=arguments;return tn().w(function(e){for(;;)switch(e.n){case 0:return r=v.length>2&&void 0!==v[2]?v[2]:{},s=[],this.logger.debug("[loadMeta start]"),e.n=1,this.loadData([0,i||this._config.moovEnd],t,r);case 1:if(n=e.v){e.n=2;break}return e.a(2);case 2:if(s.push(n),a=tH.findBox(n.data,["moov"])[0]){e.n=6;break}if(o=tH.findBox(n.data,["mdat"])[0]){e.n=3;break}throw new tJ("cannot find moov or mdat box",n.data);case 3:return l=o.start+o.size,e.n=4,this.loadData([l],t,r);case 4:if(n=e.v){e.n=5;break}return e.a(2);case 5:if(s.push(n),a=tH.findBox(n.data,["moov"],l)[0]){e.n=6;break}throw new tJ("cannot find moov box",n.data);case 6:if(!(a.size>a.data.length)){e.n=9;break}return e.n=7,this.loadData([n.data.length,a.start+a.size-1],t,r);case 7:if(n=e.v){e.n=8;break}return e.a(2);case 8:s.push(n),a.data=tC(a.data,n.data);case 9:if(h=tH.moov(a)){e.n=10;break}throw new tJ("cannot parse moov box",a.data);case 10:if(t3(d=t2(h,this._config))){e.n=11;break}throw new tJ("cannot parse segments",a.data);case 11:return!(d.videoSegments.length&&d.audioSegments.length)&&(c=tH.findBox(this.buffer,["moof"])[0],p=tH.findBox(this.buffer,["sidx"])[0],c&&c.size<=c.data.length&&p&&(f=tH.moof(c),u=tH.sidx(p),f&&u&&(t1(h,u),ts("segments")))),this.meta=t8(h,u),g=(m=d).videoSegments,_=m.audioSegments,this.videoSegments=g,this.audioSegments=_,delete this.buffer,this.bufferDataLen=0,this.logger.debug("[load moov end!!!!!]"),e.a(2,{meta:this.meta,videoSegments:g,audioSegments:_,responses:s})}},e,this)})),function(e,t){return s.apply(this,arguments)})},{key:"loadCacheMeta",value:function(e,t){var i=t2(e.moov,this._config),r=i.videoSegments,s=i.audioSegments;this.videoSegments=r,this.audioSegments=s,this._currentSegmentIndex=t,this.meta=e}},{key:"getSegmentByTime",value:function(e){var t,i;return this.videoSegments.length?(t=this.videoSegments.find(function(t){return t.startTime<=e&&t.endTime>e}))&&(i=this.audioSegments[t.index]):i=this.audioSegments.find(function(t){return t.startTime<=e&&t.endTime>e}),{video:t,audio:i}}},{key:"loadSegmentByTime",value:(n=e5(tn().m(function e(t,i){var r,s,n,a,o,l=arguments;return tn().w(function(e){for(;;)switch(e.n){case 0:if(r=!(l.length>2)||void 0===l[2]||l[2],s=l.length>3&&void 0!==l[3]?l[3]:{},this.isMetaLoaded){e.n=1;break}return e.n=1,this.loadMeta(i);case 1:return a=(n=this.getSegmentByTime(t)).video,o=n.audio,e.a(2,this._loadSegment(a,o,i,r,s))}},e,this)})),function(e,t){return n.apply(this,arguments)})},{key:"loadNextSegment",value:(a=e5(tn().m(function e(t){var i,r,s,n,a=arguments;return tn().w(function(e){for(;;)switch(e.n){case 0:if(i=!(a.length>1)||void 0===a[1]||a[1],r=a.length>2&&void 0!==a[2]?a[2]:{},this.isMetaLoaded){e.n=1;break}return e.n=1,this.loadMeta();case 1:return s=this.videoSegments[this._currentSegmentIndex+1],n=this.audioSegments[this._currentSegmentIndex+1],e.a(2,this._loadSegment(s,n,t,i,r))}},e,this)})),function(e){return a.apply(this,arguments)})},{key:"preload",value:(o=e5(tn().m(function e(t){var i,r,s,n,a,o,l,h=this;return tn().w(function(e){for(;;)switch(e.n){case 0:if(this.isMetaLoaded){e.n=1;break}return e.n=1,this.loadMeta(!0);case 1:if(!(!t||t<0)){e.n=2;break}return e.a(2);case 2:if(r=(i=this.getSegmentByTime(t)).video,s=i.audio,n=Math.max((null==r?void 0:r.index)||0,(null==s?void 0:s.index)||0)){e.n=3;break}return e.a(2);case 3:return a=this.videoSegments.slice(0,n),o=this.audioSegments.slice(0,n),l=function(){var e=e5(tn().m(function e(t){return tn().w(function(e){for(;;)switch(e.n){case 0:if(!(t>n)){e.n=1;break}return e.a(2);case 1:return e.n=2,h._loadSegment(a[t],o[t],!0,!1);case 2:return e.n=3,l(t+1);case 3:return e.a(2)}},e)}));return function(t){return e.apply(this,arguments)}}(),e.n=4,l(0);case 4:return e.a(2)}},e,this)})),function(e){return o.apply(this,arguments)})},{key:"cancel",value:function(){return this._loader.cancel()}},{key:"reset",value:(l=e5(tn().m(function e(){var t,i=arguments;return tn().w(function(e){for(;;)switch(e.n){case 0:if(i.length>0&&void 0!==i[0]&&i[0]){e.n=1;break}return this.logger.debug("[MP4loader reset func call loader.cancel]"),e.n=1,this._loader.cancel();case 1:this.vid=this.url="",this.meta={},this.downloadInfo=[],this.videoSegments=[],this.audioSegments=[],this._currentSegmentIndex=-1,this._currentLoadingSegmentIndex=-1,null!=(t=this._config)&&t.memoryOpt&&(delete this.buffer,this.bufferDataLen=0);case 2:return e.a(2)}},e,this)})),function(){return l.apply(this,arguments)})},{key:"destroy",value:(h=e5(tn().m(function e(){return tn().w(function(e){for(;;)switch(e.n){case 0:return e.n=1,this.reset();case 1:this.cache.clear();case 2:return e.a(2)}},e,this)})),function(){return h.apply(this,arguments)})},{key:"_loadSegment",value:(d=e5(tn().m(function e(t,i,r,s,n){var a,o;return tn().w(function(e){for(;;)switch(e.n){case 0:if(!(!t&&!i)){e.n=1;break}return e.a(2);case 1:return a=(null==t?void 0:t.index)||(null==i?void 0:i.index)||0,this._currentLoadingSegmentIndex=a,e.p=2,e.n=3,this.loadData([Math.min((null==t?void 0:t.range[0])||1/0,(null==i?void 0:i.range[0])||1/0),Math.max((null==t?void 0:t.range[1])||0,(null==i?void 0:i.range[1])||0)],r,n);case 3:o=e.v;case 4:return e.p=4,this._currentLoadingSegmentIndex=-1,e.f(4);case 5:if(o){e.n=6;break}return e.a(2);case 6:return s&&(this._currentSegmentIndex=a),o.video=t,o.audio=i,e.a(2,o)}},e,this,[[2,,4,5]])})),function(e,t,i,r,s){return d.apply(this,arguments)})},{key:"loadData",value:(u=e5(tn().m(function e(t,i){var r,s,n,a,o,l=arguments;return tn().w(function(e){for(;;)switch(e.n){case 0:return r=l.length>2&&void 0!==l[2]?l[2]:{},s=this._getCacheKey(t),e.n=1,this.cache.get(s);case 1:if(n=e.v){e.n=3;break}return o=null!=r&&r.url?r.url:this.url,e.n=2,this._loader.load(o,tr({range:t,vid:this.vid},r));case 2:a=e.v,e.n=4;break;case 3:a={data:n,state:!0,options:{fromCache:!0,range:t,vid:this.vid}};case 4:if(a){e.n=5;break}return e.a(2);case 5:return!n&&(a.data&&this.downloadInfo.push({startTime:a.startTime,endTime:a.endTime,size:a.data.byteLength,range:t}),this.downloadInfo&&this.downloadInfo.length>this._config.maxDownloadInfoSize&&(this.downloadInfo=this.downloadInfo.slice(-this._config.maxDownloadInfoSize))),e.a(2,a)}},e,this)})),function(e,t){return u.apply(this,arguments)})},{key:"_getCacheKey",value:function(e){return(this.vid||this.url)+":"+e}}])}(eT()),t7=i(86775),ie=(0,tI.j6)(function e(){(0,tI.xs)(this,e),(0,tI.n8)(this,"id",1),(0,tI.n8)(this,"type",tz.S.VIDEO),(0,tI.n8)(this,"codecType",tz.mT.AVC),(0,tI.n8)(this,"pid",-1),(0,tI.n8)(this,"hvcC",void 0),(0,tI.n8)(this,"codec",""),(0,tI.n8)(this,"timescale",0),(0,tI.n8)(this,"formatTimescale",0),(0,tI.n8)(this,"sequenceNumber",0),(0,tI.n8)(this,"baseMediaDecodeTime",0),(0,tI.n8)(this,"baseDts",0),(0,tI.n8)(this,"duration",0),(0,tI.n8)(this,"warnings",[]),(0,tI.n8)(this,"samples",[]),(0,tI.n8)(this,"pps",[]),(0,tI.n8)(this,"sps",[]),(0,tI.n8)(this,"vps",[]),(0,tI.n8)(this,"fpsNum",0),(0,tI.n8)(this,"fpsDen",0),(0,tI.n8)(this,"sarRatio",[]),(0,tI.n8)(this,"width",0),(0,tI.n8)(this,"height",0),(0,tI.n8)(this,"nalUnitSize",4),(0,tI.n8)(this,"present",!1),(0,tI.n8)(this,"isVideoEncryption",!1),(0,tI.n8)(this,"isAudioEncryption",!1),(0,tI.n8)(this,"isVideo",!0),(0,tI.n8)(this,"kid",null),(0,tI.n8)(this,"pssh",null),(0,tI.n8)(this,"ext",void 0)},[{key:"reset",value:function(){this.sequenceNumber=this.width=this.height=this.fpsDen=this.fpsNum=this.duration=this.baseMediaDecodeTime=this.timescale=0,this.codec="",this.present=!1,this.pid=-1,this.pps=[],this.sps=[],this.vps=[],this.sarRatio=[],this.samples=[],this.warnings=[],this.hvcC=null}},{key:"firstDts",get:function(){return this.samples.length?this.samples[0].dts:null}},{key:"firstPts",get:function(){return this.samples.length?this.samples[0].pts:null}},{key:"samplesDuration",get:function(){if(this.samples.length>0){var e=this.samples[0],t=this.samples[this.samples.length-1];return t.dts-e.dts+t.duration}return 0}},{key:"exist",value:function(){return!!/av01/.test(this.codec)||!!(this.pps.length&&this.sps.length&&this.codec)}},{key:"hasSample",value:function(){return!!this.samples.length}},{key:"isEncryption",get:function(){return this.isVideoEncryption}}]),it=(0,tI.j6)(function e(){(0,tI.xs)(this,e),(0,tI.n8)(this,"id",2),(0,tI.n8)(this,"type",tz.S.AUDIO),(0,tI.n8)(this,"codecType",tz.VE.AAC),(0,tI.n8)(this,"pid",-1),(0,tI.n8)(this,"codec",""),(0,tI.n8)(this,"sequenceNumber",0),(0,tI.n8)(this,"sampleDuration",0),(0,tI.n8)(this,"timescale",0),(0,tI.n8)(this,"formatTimescale",0),(0,tI.n8)(this,"baseMediaDecodeTime",0),(0,tI.n8)(this,"duration",0),(0,tI.n8)(this,"warnings",[]),(0,tI.n8)(this,"samples",[]),(0,tI.n8)(this,"baseDts",0),(0,tI.n8)(this,"sampleSize",16),(0,tI.n8)(this,"sampleRate",0),(0,tI.n8)(this,"channelCount",0),(0,tI.n8)(this,"objectType",0),(0,tI.n8)(this,"sampleRateIndex",0),(0,tI.n8)(this,"config",[]),(0,tI.n8)(this,"present",!1),(0,tI.n8)(this,"isVideoEncryption",!1),(0,tI.n8)(this,"isAudioEncryption",!1),(0,tI.n8)(this,"kid",null),(0,tI.n8)(this,"isHeAACExt",!1),(0,tI.n8)(this,"ext",void 0)},[{key:"reset",value:function(){this.sequenceNumber=0,this.timescale=0,this.sampleDuration=0,this.sampleRate=0,this.channelCount=0,this.baseMediaDecodeTime=0,this.present=!1,this.isHeAACExt=!1,this.pid=-1,this.codec="",this.samples=[],this.config=[],this.warnings=[]}},{key:"exist",value:function(){return!!(this.sampleRate&&this.channelCount&&this.codec&&this.codecType===tz.VE.AAC)}},{key:"hasSample",value:function(){return!!this.samples.length}},{key:"isEncryption",get:function(){return this.isAudioEncryption}},{key:"firstDts",get:function(){return this.samples.length?this.samples[0].dts:null}},{key:"firstPts",get:function(){return this.samples.length?this.samples[0].pts:null}},{key:"samplesDuration",get:function(){if(this.samples.length>0){var e=this.samples[0],t=this.samples[this.samples.length-1];return t.dts-e.dts+t.duration}return 0}}]),ii=(0,tI.j6)(function e(t,i,r){(0,tI.xs)(this,e),(0,tI.n8)(this,"flag",{}),(0,tI.n8)(this,"keyframe",!1),(0,tI.n8)(this,"gopId",0),(0,tI.n8)(this,"duration",0),(0,tI.n8)(this,"size",0),(0,tI.n8)(this,"units",[]),(0,tI.n8)(this,"chromaFormat",420),this.originPts=this.pts=t,this.originDts=this.dts=i,r&&(this.units=r)},[{key:"cts",get:function(){return this.pts-this.dts}},{key:"setToKeyframe",value:function(){this.keyframe=!0,this.flag.dependsOn=2,this.flag.isNonSyncSample=0}}]),ir=(0,tI.j6)(function e(t,i,r,s){(0,tI.xs)(this,e),(0,tI.n8)(this,"duration",1024),(0,tI.n8)(this,"flag",{dependsOn:2,isNonSyncSample:0}),(0,tI.n8)(this,"keyframe",!0),this.originPts=this.pts=this.dts=t,this.data=i,this.size=i.byteLength,this.sampleOffset=s,r&&(this.duration=r)}),is=(0,tI.j6)(function e(){(0,tI.xs)(this,e),(0,tI.n8)(this,"id",3),(0,tI.n8)(this,"type",tz.S.METADATA),(0,tI.n8)(this,"timescale",0),(0,tI.n8)(this,"flvScriptSamples",[]),(0,tI.n8)(this,"seiSamples",[])},[{key:"exist",value:function(){return!!((this.flvScriptSamples.length||this.seiSamples.length)&&this.timescale)}},{key:"reset",value:function(){this.timescale=0,this.flvScriptSamples=[],this.seiSamples=[]}},{key:"hasSample",value:function(){return!!(this.flvScriptSamples.length||this.seiSamples.length)}}]),ia=i(9633),io=null,il=["stts","stsc","stsz","stco","co64","stss","ctts"],ih=function(){function e(t,i,r,s){var n,a,o=this;if((0,tI.xs)(this,e),(0,tI.n8)(this,"_videoSamples",[]),(0,tI.n8)(this,"_audioSamples",[]),(0,tI.n8)(this,"_lastRemainBuffer",[]),(0,tI.n8)(this,"_lastRemainBufferStartPos",0),(0,tI.n8)(this,"videoMaxFrameIdx",-1),(0,tI.n8)(this,"audioMaxFrameIdx",-1),this.videoTrack=new ie,this.audioTrack=new it,this.metadataTrack=r||new is,this.videoSegmnents=t,this.audioSegmnents=i,this.log=new ia.V("MP4Demuxer",!s||!s.openLog||!s.openLog),this.memoryOpt=null==s?void 0:s.memoryOpt,!this.memoryOpt&&(t&&t.forEach(function(e){var t;(t=o._videoSamples).push.apply(t,(0,tI.Og)(e.frames))}),i&&i.forEach(function(e){var t;(t=o._audioSamples).push.apply(t,(0,tI.Og)(e.frames))})),(null==(n=this.videoSegmnents)?void 0:n.length)>0){var l=this.videoSegmnents[this.videoSegmnents.length-1].frames;this.videoMaxFrameIdx=l[l.length-1].index}if((null==(a=this.audioSegmnents)?void 0:a.length)>0){var h=this.audioSegmnents[this.audioSegmnents.length-1].frames;this.audioMaxFrameIdx=h[h.length-1].index}}return(0,tI.j6)(e,[{key:"parseSamples",value:function(e){if(!e)throw Error("moov is required");this.videoTrack.codec||this.audioTrack.codec||(tH.moovToTrack(e,this.videoTrack,this.audioTrack),this.videoSenc=this.videoTrack.videoSenc,this.audioSenc=this.audioTrack.audioSenc,this.memoryOpt&&this.clearBoxEntries(e))}},{key:"demux",value:function(e,t,i,r,s){this.parseSamples(s);var n=this.videoTrack,a=this.audioTrack;n.samples=[],a.samples=[];var o={};if(i){var l,h,d,u,c=0;if(this.memoryOpt&&this.videoSegmnents&&!(o=this.getFramePosByIdx("video",i[0])))throw Error("cannot found video frame #".concat(i[0]));for(var p=o,f=p.frameIdx,m=p.segmentIdx,g=i[0],_=i[1];g<=_;g++){if(!this._videoSamples.length&&this.videoSegmnents){var v=this.getFrameInfo("video",m,f);l=v.sample,m=v.segmentIdx,f=v.frameIdx}else l=this._videoSamples[g];if(!l)throw Error("cannot found video frame #".concat(g));d=l.offset-t,h=e.subarray(d,d+l.size),(u=new ii("number"==typeof l.pts?l.pts:l.dts,l.dts)).duration=l.duration,u.gopId=l.gopId,l.keyframe&&u.setToKeyframe();for(var y=0,A=h.length-1;y<A;)c=(0,tR.kl)(h,y),y+=4,u.units.push(h.subarray(y,y+c)),y+=c;n.samples.push(u)}n.baseMediaDecodeTime=n.samples[0].dts}if(o={},r){if(this.memoryOpt&&this.audioSegmnents&&!(o=this.getFramePosByIdx("audio",r[0])))throw Error("cannot found video frame #".concat(r[0]));for(var T=o,b=T.frameIdx,S=T.segmentIdx,E=r[0],k=r[1];E<=k;E++){if(!this._audioSamples.length&&this.audioSegmnents){var P=this.getFrameInfo("audio",S,b);l=P.sample,S=P.segmentIdx,b=P.frameIdx}else l=this._audioSamples[E];if(!l)throw Error("cannot found video frame #".concat(E));d=l.offset-t,h=e.subarray(d,d+l.size),a.samples.push(new ir(l.dts,h,l.duration))}a.baseMediaDecodeTime=a.samples[0].dts}return{videoTrack:n,audioTrack:a,metadataTrack:this.metadataTrack}}},{key:"demuxPart",value:function(e,t,i,r,s,n,a,o){if(this.parseSamples(s),this.videoTrack.useEME=n,this.audioTrack.useEME=n,this._lastRemainBuffer&&this._lastRemainBuffer.byteLength>0&&t>this._lastRemainBufferStartPos&&t<=this._lastRemainBufferStartPos+this._lastRemainBuffer.byteLength)for(var l=0;l<20;)try{var h=this._lastRemainBuffer.subarray(0,t-this._lastRemainBufferStartPos),d=new Uint8Array(e.byteLength+h.byteLength);d.set(h,0),d.set(new Uint8Array(e),h.byteLength),e=d,t-=h.byteLength,this._lastRemainBuffer=null,this._lastRemainBufferStartPos=0;break}catch(e){if(l<20)l++;else throw Error("new Uint8Array error:,"+e.errorMessage)}var u=this.videoTrack,c=this.audioTrack;u.samples=[],c.samples=[],u.videoSenc=null,c.audioSenc=null,(null==i?void 0:i[1])>this.videoMaxFrameIdx&&this.videoMaxFrameIdx>0&&(i[1]=this.videoMaxFrameIdx),(null==r?void 0:r[1])>this.audioMaxFrameIdx&&this.audioMaxFrameIdx>0&&(r[1]=this.audioMaxFrameIdx);var p=0,f=0,m={},g=e.byteLength+t;if(i.length>0){if(this.memoryOpt&&this.videoSegmnents&&!(m=this.getFramePosByIdx("video",i[0])))throw Error("cannot found video frame #".concat(i[0]));for(var _,v,y,A,T=m,b=T.frameIdx,S=T.segmentIdx,E=i[0];E<=i[1];E++){if(!this._videoSamples.length&&this.videoSegmnents){var k=this.getFrameInfo("video",S,b);_=k.sample,S=k.segmentIdx,b=k.frameIdx}else _=this._videoSamples[E];if(!_)throw Error("cannot found video frame #".concat(E));if(this.memoryOpt&&_.offset+_.size>g)break;_.offset>=t&&_.offset+_.size<=g&&(p=(y=_.offset-t)+_.size,v=e.subarray(y,p),(A=new ii("number"==typeof _.pts?_.pts:_.dts,_.dts)).duration=_.duration,A.gopId=_.gopId,A.sampleOffset=_.index,_.keyframe&&A.setToKeyframe(),A.data=v,A.size=_.size,u.samples.push(A))}u.samples.length>0&&(u.gopId=u.samples[0].gopId,u.baseMediaDecodeTime=u.samples[0].dts,u.startPts=u.samples[0].pts/u.timescale,u.endPts=u.samples[u.samples.length-1].pts/u.timescale,u.startDts=u.samples[0].dts/u.timescale,u.endDts=u.samples[u.samples.length-1].dts/u.timescale,this.videoSenc&&(u.videoSenc=this.videoSenc.slice(u.samples[0].sampleOffset,u.samples[0].sampleOffset+u.samples.length),u.kidValue=a))}if(r.length>0){if(this.memoryOpt&&this.audioSegmnents&&!(m=this.getFramePosByIdx("audio",r[0])))throw Error("cannot found video frame #".concat(r[0]));for(var P=m,w=P.frameIdx,x=P.segmentIdx,C=r[0];C<=r[1];C++){if(!this._audioSamples.length&&this.audioSegmnents){var L=this.getFrameInfo("audio",x,w);_=L.sample,x=L.segmentIdx,w=L.frameIdx}else _=this._audioSamples[C];if(!_)throw Error("cannot found video frame #".concat(C));if(this.memoryOpt&&_.offset+_.size>g)break;_.offset>=t&&_.offset+_.size<=g&&(f=(y=_.offset-t)+_.size,v=e.subarray(y,f),c.samples.push(new ir(_.dts,v,_.duration,_.index)))}c.samples.length>0&&(c.gopId=c.samples[0].gopId||u.gopId,c.baseMediaDecodeTime=c.samples[0].dts,c.startPts=c.samples[0].pts/c.timescale,c.endPts=c.samples[c.samples.length-1].pts/c.timescale,this.audioSenc&&(c.audioSenc=this.audioSenc.slice(c.samples[0].sampleOffset,c.samples[0].sampleOffset+c.samples.length),c.kidValue=a))}this.decoderData(u,c,o);for(var D=0,I=0;I<u.samples.length;I++)for(var R=0,O=u.samples[I].data,M=O.length-1;R<M;)D=(0,tR.kl)(O,R),R+=4,u.samples[I].units.push(O.subarray(R,R+D)),R+=D;var B=Math.max(p,f);return this._lastRemainBuffer=e.subarray(B),this._lastRemainBuffer.byteLength>0?this._lastRemainBufferStartPos=t+e.byteLength-this._lastRemainBuffer.byteLength:this._lastRemainBufferStartPos=0,{videoTrack:u,audioTrack:c,metadataTrack:this.metadataTrack,lastRemainBufferInfo:{data:this._lastRemainBuffer,pos:this._lastRemainBufferStartPos}}}},{key:"setLastRemainBufferInfo",value:function(e,t){this._lastRemainBuffer=e,this._lastRemainBufferStartPos=t}},{key:"reset",value:function(){this._lastRemainBuffer=null,this._lastRemainBufferStartPos=0,this.videoTrack.reset(),this.audioTrack.reset(),this.metadataTrack.reset()}},{key:"decoderData",value:function(t,i,r){if(!t.useEME&&!i.useEME&&(null!=t&&t.videoSenc||null!=i&&i.audioSenc)){if(!e.Crypto)throw Error("Crypto is not defined");e.Crypto.decoderAESCTRData(t,i,r)}}},{key:"getFramePosByIdx",value:function(e,t){var i,r,s,n="video"===e?this.videoSegmnents:this.audioSegmnents;if(!n||!(null!=n&&n.length))return null;for(var a=0,o=0;o<n.length;o++)if(i=n[o].frames,t<=(null==(r=n[o].frames)?void 0:r[(null==(s=i)?void 0:s.length)-1].index)){a=o;break}return{frameIdx:i.findIndex(function(e){return e.index===t}),segmentIdx:a}}},{key:"getFrameInfo",value:function(e,t,i){var r,s,n,a="video"===e?this.videoSegmnents:this.audioSegmnents;return a?i<(null==(r=a[t])||null==(r=r.frames)?void 0:r.length)?{sample:null==(s=a[t])?void 0:s.frames[i],segmentIdx:t,frameIdx:i+1}:{sample:null==(n=a[t+1])?void 0:n.frames[0],segmentIdx:t+1,frameIdx:1}:{}}},{key:"clearBoxEntries",value:function(e){this.memoryOpt&&e.trak.forEach(function(e){il.forEach(function(t){var i=e.mdia.minf.stbl[t];i&&(i.entries&&(i.entries=null),i.entrySizes&&(i.entrySizes=null))})})}}],[{key:"Crypto",get:function(){return io},set:function(e){io=e}},{key:"probe",value:function(e){return tH.probe(e)}}])}(),id=i(32239),iu=Object.defineProperty,ic=(e,t,i)=>{let r;return(r="symbol"!=typeof t?t+"":t)in e?iu(e,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[r]=i};let ip={MEDIA_EXPIRED:"MEDIA_EXPIRED",INIT_FAIL:"INIT_FAIL",PARSE_ERROR:"PARSE_ERROR",PLAYER_LOG:"PLAYER_LOG",BUFFERED_RESET:"BUFFERED_RESET"},im="real_time_speed",ig="is unsupported",i_="buffer_control",iv="pcdn",iy=new Map,iA=new Map,iT=new Map,ib="size",iS={BUFFER_CONTROLS:"buffer_control"},iE="timer_update",ik="h264",iP="h265",iw="h266",ix="0.3.46",iC={416:t7.sn[t7.sJ.NETWROK_RANGE_NOT_SATISFIABLE],403:t7.sn[t7.sJ.NETWORK_FORBIDDEN],404:t7.sn[t7.sJ.NETWORK_NOTFOUND],timeout:t7.sn[t7.sJ.NETWORK_TIMEOUT],"4xx":`${t7.sn[t7.sJ.NETWORK]}4XX`,"5xx":`${t7.sn[t7.sJ.NETWORK]}5XX`,networkError:t7.sn[t7.sJ.NETWORK],contentError:`${t7.sn[t7.sJ.NETWORK]}contentError`,mse:t7.sn[t7.sJ.MEDIA][t7.sJ.SUB_TYPES.MSE_OTHER],mseOpen:t7.sn[t7.sJ.MEDIA][t7.sJ.SUB_TYPES.MSE_ADD_SB],mseAppend:t7.sn[t7.sJ.MEDIA][t7.sJ.SUB_TYPES.MSE_APPEND_BUFFER],mse_hijack:t7.sn[t7.sJ.MEDIA][t7.sJ.SUB_TYPES.MSE_HIJACK],eme_hijack:t7.sn[t7.sJ.MEDIA][t7.sJ.SUB_TYPES.EME_HIJACK],metaError:t7.sn[t7.sJ.DEMUX][t7.sJ.SUB_TYPES.MP4],muxError:t7.sn[t7.sJ.REMUX][t7.sJ.SUB_TYPES.FMP4],other:t7.sn[t7.sJ.OTHER],waitTimeout:t7.sn[t7.sJ.RUNTIME][t7.sJ.SUB_TYPES.BUFFERBREAK_ERROR],waitTimeoutWithHidden:t7.sn[t7.sJ.RUNTIME][t7.sJ.SUB_TYPES.WAITING_TIMEOUT_ERROR],drm:t7.sn[t7.sJ.DRM][t7.sJ.SUB_TYPES.LICENSE]},iL=t7.sJ;class iD{constructor(e,t,i){let r=0,s=0;i&&i.range&&i.range.length>1&&(r=i.range[0],s=i.range[1]);let n=function(e){return iC[e]||e}(t);return{errorCode:n,errorType:e,errorMessage:(null==i?void 0:i.httpText)||(null==i?void 0:i.message),url:null==i?void 0:i.url,httpCode:t,version:ix,rangeStart:r,rangeEnd:s,ext:i,mediaError:{code:n,message:(null==i?void 0:i.httpText)||(null==i?void 0:i.message)}}}}class iI{constructor(e,t,i){return{errorCode:t,errorType:e,version:ix,errorMessage:i.msg,ext:i,mediaError:{code:t,message:i.msg}}}}let iR=[{range:[0,90],size:614400},{range:[90,120],size:819200},{range:[120,Number.MAX_VALUE],size:1024e3}];function iO(e,t,i){let r=i>51200?Math.min(i,t):t;if(!e)return r;for(let s=0;s<iR.length;s++)if(e>=iR[s].range[0]&&e<iR[s].range[1]){r=Math.min(Math.max(r,iR[s].size),i>0?i:t);break}return r}let iM=function(){try{return"u">typeof localStorage&&"setItem"in window.localStorage&&!!window.localStorage.setItem}catch{return!1}}()&&!function(){let e="_localstorage_support_test";try{return window.localStorage.setItem(e,!0),window.localStorage.removeItem(e),!1}catch{return!0}}(),iB=iF(),iN=function(){if(iM)try{return!!window.localStorage.getItem("playertestlog")}catch{}return!1}(),iU={1:"debug",2:"log",3:"warn",4:"error"};function iF(){if(iM)try{return!!window.localStorage.getItem("playerlog")}catch{}return!1}function iV(e,t,i,...r){let s=iU[t];s&&e&&e[s]&&e[s](i,...r)}function i$(e="div",t="",i={},r=""){let s=document.createElement(e);return s.className=r,s.innerHTML=t,Object.keys(i).forEach(t=>{let r=i[t];"video"===e||"audio"===e||"live-video"===e?r&&s.setAttribute(t,r):s.setAttribute(t,r)}),s}function iz(e){return Object.prototype.toString.call(e).match(/([^\s.*]+)(?=]$)/g)[0]}function ij(){try{return parseInt(performance.now(),10)}catch{return new Date().getTime()}}function iG(e,t){try{let i=e.indexOf("?");return i<0?Object.keys(t).forEach((i,r)=>{0===r?e+=`?${i}=${t[i]}`:e+=`&${i}=${t[i]}`}):Object.keys(t).forEach(r=>{i===e.length-1?e+=`${r}=${t[r]}`:e+=`&${r}=${t[r]}`}),e}catch{return e}}function iH(e,t){return Object.keys(t).forEach(i=>{let r=iz(t[i]),s=iz(e[i]);"Array"===r?("Array"!==s&&(e[i]=[]),e[i].push(...t[i])):"Object"===r?("Object"!==s&&(e[i]={}),iH(e[i],t[i])):e[i]=t[i]}),e}function iW(e,t){try{return e&&t?parseInt(t*e/8,10):0}catch{return 0}}function iq(e,t){let i=[],r=0;e&&i.push(e),t&&i.push(t),i.every(e=>(e&&(r+=e.byteLength),!0));let s=new Uint8Array(r),n=0;return i.every(e=>(e&&(s.set(e,n),n+=e.byteLength),!0)),s}function iK(e,t,i){let r=null,s=null;return r=e<t.length-1?t[e]:t[t.length-1],s=e<i.length-1?i[e]:i[i.length-1],[Math.min((null==r?void 0:r.range[0])||1/0,(null==s?void 0:s.range[0])||1/0),Math.max(null==r?void 0:r.range[1],null==s?void 0:s.range[1])]}function iY(e){if("String"!==iz(e)||!e)return"";let t=e.split("/"),i="";return t.length>3&&t[2]&&(i=t[2]),i}function iX(e){let t=0,i;for(;t<10;)try{if((i=new Uint8Array(e)).byteLength>0)break;t++}catch{t<10?t++:console.error("repeat data cache  new array failed final",10)}return i}let iQ={playBtnClick:(e,t,i,r)=>{e.paused||e.waitingMoreBuffer&&(e.waitingMoreBuffer=!1),r.call(e,t,i)}},iJ={waiting:(e,t)=>{let{player:i,eventName:r}=e;i.waitingMoreBuffer=!0,t(r,e)},play:(e,t)=>{let{player:i,eventName:r}=e;i.waitingMoreBuffer||t(r,e)},pause:(e,t)=>{let{player:i,eventName:r}=e;i.waitingMoreBuffer||t(r,e)},seeking:(e,t)=>{let{player:i,eventName:r}=e;i.isSeekingStart=!0,t(r,e)},progress:(e,t)=>{iV(">>>>progress");let{player:i,eventName:r}=e;if(i.waitingMoreBuffer){let e=i.getBufferedRange(i.buffered2);0===e[0]&&0===e[1]||(void 0===i.inWaitingStart||i.isSeekingStart?(iV("progress startplay or seek ended"),e[1]-i.currentTime>=(i.config.canplayWaterLevel||1)||e[1]>i.duration-1?(iV("progress out bufferWaterLevel"),i.play()):(iV("progress not out bufferWaterLevel"),i.emit("waiting"))):(iV("progress video waiting end"),e[1]-i.currentTime>=(i.config.bufferWaterLevel||5)||e[1]>i.duration-1?(iV("progress out bufferWaterLevel"),i.play()):(iV("progress not out bufferWaterLevel"),i.emit("waiting"))))}t(r,e)},playing:(e,t)=>{let{player:i,eventName:r}=e;iV("playing");let s=i.getBufferedRange(i.buffered2);if(0===s[0]&&0===s[1]){iV("playing currentTime no buffer, not out bufferWaterLevel"),i.waitingMoreBuffer=!0,i.pause(),t.call("waiting",e);return}void 0===i.inWaitingStart||i.isSeekingStart?(iV("playing startplay or seek ended"),s[1]-i.currentTime>=(i.config.canplayWaterLevel||1)||s[1]>i.duration-1?(iV("playing out bufferWaterLevel"),i.waitingMoreBuffer=!1,i.isSeekingStart=!1,t(r,e)):(iV("playing not out bufferWaterLevel"),i.waitingMoreBuffer=!0,i.pause(),t.call("waiting",e))):(iV("playing video waiting ended"),s[1]-i.currentTime>=(i.config.bufferWaterLevel||5)||s[1]>i.duration-1?(iV("playing out bufferWaterLevel"),i.waitingMoreBuffer=!1,t(r,e)):(iV("playing not out bufferWaterLevel"),i.waitingMoreBuffer=!0,i.pause(),t.call("waiting",e)))}};function iZ(e,t){return Math.round(8*e*1e3/t/1024)}function i0(e){var t,i;return!((null==(t=null==e?void 0:e.message)?void 0:t.indexOf("Failed to fetch"))>=0||null!=e&&e.response&&(null==(i=e.response)?void 0:i.status)>=400&&e.response.status<=599)}function i1(e,t,i){e.video&&e.video.addEventListener(t,i)}function i2(e,t,i){e.video&&e.video.removeEventListener(t,i)}function i4(e){return e&&e.video&&"function"==typeof e.video.getStats?e.video.getStats():null}function i8(e){let{kid:t,drmKeyToken:i,secretKey:r,keyValue:s,drm:n}=e;return t||i||r||s||n}function i5(e){let{cachedBufferDur:t,loadTarDuration:i,loadDuration:r,forceSetMin:s}=e,{PCDNInBuffer:n,PCDNOutBuffer:a,loadSize:o}=e;return{buffer_dur:t||-1,load_tar_dur:i||-1,load_dur:r||-1,force_set_min:s,in_buf:n||-1,out_buf:a||-1,load_size:o||-1}}let i3={"x-cache":"x_cache","x-response-sinfo":"server_ip","x-response-cinfo":"x-response-cinfo","content-range":"content-range","content-length":"content-length","content-type":"content-type"};function i6(e){let t={};return e&&e.get&&Object.keys(i3).forEach(i=>{let r=i3[i];e.get(i)&&(t[r]=e.get(i))}),t}function i9(e){let t=i3["content-range"];if(e&&e.get&&e.get(t)){let i=e.get(t).split("/");if((null==i?void 0:i.length)===2)return i[1]}return null}let i7="error",re="metaReady",rt="moov_request_Progress",ri="progress_event",rr="updateEME",rs="init_MSE",rn="chaneg_url",ra="update_load_fragmentIdx",ro="remove_pcdn_node",rl="load_error",rh="cancel_loaded_len",rd="load_len_not_match_error",ru="close",rc="forbidden",rp={},rf=class e extends eA{constructor(t,i,r,s=[],n){var a;super(),ic(this,"markErrHost",e=>{e&&(rp[e]=!0,this.log(ev.f.WARN,"[mp4loader markErrHost]",e))}),ic(this,"onprogressDataArrive",async(e,t,i,r)=>{var s;let n=(null==(s=null==i?void 0:i.priOptions)?void 0:s.type)||"cdn",a=this.adaptTimeRange[i.index].range;if(e&&e.byteLength>0?(this._optionDataLenInfo[n]||(this._optionDataLenInfo[n]=0),this._optionDataLenInfo[n]+=e.byteLength,this._receiveDataPos=null==i?void 0:i.range[1],a&&i.range[1]>a[1]&&!t&&(t=!0,this.log(ev.f.LOG,"[onprogressDataArrive] receive data, check state set true >>> index,",i.index,",range,",JSON.stringify(i.range))),this.cacheRepeatData(this.adaptTimeRange[i.index].repeatRange,i.range,e),this.log(ev.f.LOG,"[onprogressDataArrive] receive data, >>> index,",i.index,",range,",JSON.stringify(i.range),", dataLen,",e.byteLength,",loadType,",n,t),this._mux(e,i.range[0],i.index,t)):this.log(ev.f.LOG,"[onprogressDataArrive] receive data null, >>> index,",i.index,",range,",JSON.stringify(i.range),", dataLen,",null==e?void 0:e.byteLength,",loadType,",n,t),t){this._optionDataLenInfo[n]=0;let e=i6(r.headers);this.totalSize||(this.totalSize=function(e){try{let t=Object.keys(e).filter(e=>"content-range"===e);if(t.length>0){let i=e[t[0]].split("/");if((null==i?void 0:i.length)===2)return parseInt(i[1],10)}return 0}catch(e){return console.error(e),0}}(e));let t=a&&a.length>=0?Number(a[1]):0;if((null==a?void 0:a.length)>0&&(!t||t&&((null==i?void 0:i.range[1])===t+1||this.totalSize===t)))this.adaptTimeRange[i.index].downloaded=!0,this.log(ev.f.LOG,"[FragLoadDowned],fragmentIdx,",i.index,",rangeEnd,",i.range[1]);else{await this.cancelLoading();let{startTime:t,endTime:s}=this.adaptTimeRange[i.index];this.emit(rd,[t,s]);let o="cdn"===n?this.url:this._pcdnNodeList[0].url,l=iY(o);this.emit(rl,{src:o,host:l,errorCode:iC.contentError,message:"progress dataLen not match",range:JSON.stringify(a),headers:e}),this.log(ev.f.LOG,"[FragLoadDowned check false, len is not match],fragmentIdx,",i.index,",rangeEnd,",i.range[1],JSON.stringify(a),JSON.stringify(e),o,null==r?void 0:r.url),await this.loadAllFragmentData(this._curLoadSegIdx,this._loadSuccessCallBack)}}}),this.timeRecord={startMuxTime:-1,startLoadTime:-1,newMP4Time:ij(),startLoadMetaTime:-1},this.updateUrl(t,s||[]),this._bitRate=i||0,this.options=e.getDefaultConfig(),Object.keys(r).map(e=>{void 0!==r[e]&&null!==r[e]&&(this.options[e]=r[e])}),this.logger=r.logger,this.timeRange=[],this.adaptTimeRange=[],this.firstFrameTime=n||{},this.fileSize=null==r?void 0:r.fileSize,this.totalSize=0,this.CHUNK_SIZE=(null==(a=this.options)?void 0:a.firstLoadSize)||iO(r.duration,this.options.chunkSize,this.fileSize),this._firstLoadSize=this.CHUNK_SIZE,this.log(ev.f.LOG,"[getFirstLoadSize], firstLoadSize ",this._firstLoadSize,",dur,",r.duration,",chunkSize,",this.CHUNK_SIZE,",fileSize,",this.fileSize),this._repeatInfo={startPos:-1,curDataPos:0,usedPos:0,data:iX(1048576)},this.meta=null,this.preloadCache=null,this.videoTrak=null,this.audioTrak=null,this._loadSuccessCallBack=null,this._isPending=!1,this.metaLoading=!1,this.MP4Loader=new t9({url:t,vid:`${r.vid}-${i}`,retry:r.retryCount||2,retryDelay:r.retryDelay||1e3,timeout:r.timeout||3e3,segmentDuration:r.segmentDuration,fixEditListOffset:r.fixEditListOffset,...r.reqOptions,loaderType:r.loaderType,retryCheckFunc:i0,openLog:iB}),this.MP4Demuxer=null,this.FMP4Remuxer=null,this._needInitSegment=!0,this._bitRateInfoMap=new Map,this._switchBitRate=!1,this._segmentToBitRateMap=new Map,this.useEME=!1,this.secretKey=null,this.decryptKey=null,this.keyValue=null,this.initTransMuxWorker(),this.seekTime=-1,this.changeBitRateTime=-1,this._PCDNState=ru,this._pcdnNodeList=[],this.loadInfo={},this.pcdnTraceInfo=null,this._loadedDataState=!1,this._PCDNSwitchCnt=0,this._isUseCDN=!0,this._curLoadSegIdx=0,this._receiveDataPos=-1,this._optionDataLenInfo={},this._lastPCDNUrl="",this._lastTargetDur=0,this.pcdnVVStat=this.resetPCDNVVStat(),this.pSCCancelCnt=0,this._lastDemuxSampleIdxRange={video:0,audio:0},this._mediaEndTime=-1}static get pcdnDownLoadReqCnt(){let{pcdn_download_request_cnt:t,pcdn_download_failed_cnt:i}=e;return e.pcdn_download_request_cnt=0,e.pcdn_download_failed_cnt=0,{pcdn_download_request_cnt:t,pcdn_download_failed_cnt:i}}static getDefaultConfig(){return{onProcessMinLen:1024,xhrSetup:null,chunkSize:8e5,isCache:!1,playerId:"",vid:"",afterLoadeddataCallBackLen:0,ext:{}}}get size(){return this.fileSize}initTransMuxWorker(){}updateSecretKey(e,t,i,r){var s;this.useEME=e,!e&&t?(this.log(ev.f.LOG,"[updateSecretKey] ,force enableWorker"),this.options.enableWorker=!0,this.transmuxerWorkerControl||this.initTransMuxWorker()):!e&&r&&(this.keyValue=r),this.log(ev.f.LOG,"[updateSecretKey] ,useEME, ",e,",secretKey,",t,",decryptKey",i),null==(s=this.transmuxerWorkerControl)||s.updateValue({secretKey:t,decryptKey:i})}updateLoadedDataDone(){this._loadedDataState=!0}get PCDNSwitchCnt(){return this._PCDNSwitchCnt}updateLoadInfo(e,t){this.loadInfo||(this.loadInfo={}),this.loadInfo[e]||(this.loadInfo[e]={},this.loadInfo[e].loadLen=0),this.loadInfo[e].loadLen+=t}async updatePCDNState(e){if(this._PCDNState!==rc&&this._PCDNState!==e&&this.log(ev.f.LOG,"[pcdn state update]",this._PCDNState," - ",e),e===rc)this._PCDNState=e;else if(this._PCDNState!==rc&&this._PCDNState!==e){if(this._isUseCDN||e!==ru)this._PCDNState=e;else{if(this._PCDNState=e,this.adaptTimeRange[this._curLoadSegIdx].downloaded||this._switchBitRate)return void this.log(ev.f.LOG,"[pcdn] switch cdn ",this._curLoadSegIdx,"downloaded",",switchBitRate, ",this._switchBitRate);await this.cancelLoading(),this.pSCCancelCnt++;let t=this._curLoadSegIdx;this.log(ev.f.LOG,"[pcdn] cancelLoading ",t,"switch cdn load");let i=this.getFragRange(t);if(this._receiveDataPos&&this._receiveDataPos>=i[0]&&this._receiveDataPos<=i[1]){let e=i[0];i[0]=this._receiveDataPos,this.log(ev.f.LOG,"[pcdn] switch cdn, adject range",t,JSON.stringify(i),",oldRange,",`${e} - ${i[1]}`)}this._receiveDataPos=-1,await this.startLoad(i,t)}this.log(ev.f.LOG,"[pcdn] openPCDN ",e)}}updateNode(e){if(e&&e.length>0){let t=e.filter(e=>{if(!Object.prototype.hasOwnProperty.call(rp,iY(null==e?void 0:e.url)))return e});this._pcdnNodeList=t}}clearPCDNNodeList(){this.log(ev.f.LOG,"[pcdn] clearPCDNNodeList"),this._pcdnNodeList=[]}get isUpdateNode(){return!this._pcdnNodeList||!this._pcdnNodeList.length}isUsePCDN(){var e;return"open"===this._PCDNState&&(null==(e=this._pcdnNodeList)?void 0:e.length)>0}async changeBitRate(e){e.bitrate!==this._bitRate&&(this.updateUrl(e._mainURL,e._backupURL),this._bitRate=e.bitrate,this._receiveDataPos=-1,await this.MP4Loader.changeUrl(this.url,`${this.options.vid}-${this._bitRate}`,this.CHUNK_SIZE),this._pcdnNodeList=null,this.emit(rn,this.url),this._switchBitRate=!0,this._mediaEndTime=-1,this.log(ev.f.LOG,"[switchBitrate] changeUrl, bitRate,",this._bitRate,"url",this.url))}_getByPreload(e,t,i,r){try{if(e&&e.byteLength>=t){let s={endTime:new Date().getTime(),startTime:new Date().getTime(),index:r,range:[],vid:this.options.vid,from:"local"};if(i<=e.byteLength){let r=e.slice(t,i);return s.range=[t,i],s.state=!0,{buffer:r,context:s,state:!0}}{let i=e.byteLength-1,r=e.slice(t,i);return s.range=[t,i],{context:s,buffer:r,state:!1}}}return null}catch(e){return console.error("[MP4] _getByPreload",t,i,e),null}}log(e,t,...i){let{options:r}=this,s=r&&r.vid?`[MP4]${this._logTag} ${r.vid} ${t}`:`[MP4]${this._logTag} ${t}`;iV(this.logger,e,s,...i)}async errorHandler(e,t,i={}){let{response:r,message:s}=e,n=this.options?this.options.vid:"",a=null;if(this._isPending=!0,r){let o=i6(r.headers);if(a=new iD("network",r.status,{httpText:r.httpText,message:s,url:r.url,range:i.range,headers:o}),this.log(ev.f.LOG,`[MP4] [${n}] errorHandler error state:[${t}],
          _isPending:[${this._isPending}] `,null==r?void 0:r.status,s),this.backUrl&&this.backUrl.length>0){let r=this.backUrl.shift();if(this.updateUrl(r,this.backUrl),this.log(ev.f.LOG,`[${n}] errorHandler start backUpUrl retry`,this.backUrl.length,r),this._isPending=!1,this.MP4Loader&&(await this.MP4Loader.changeUrl(this.url,`${this.url}-${this._bitRate}`,this.CHUNK_SIZE),this.emit(rn,this.url)),this.emit(ri,{type:"error",error:e}),"getMetaInfo"===t)return void this.getMetaInfo();if("loadFragment"===t){let{fragIndex:e,range:t}=i;if(null!==e&&e>=0&&t){this.resetFragmentLoadState(e),this.loadFragment(e,t);return}}}a.context=i,a.response=r,this.log(ev.f.LOG,`errorHandler end, ${JSON.stringify(i)}`),this.emit(i7,a,t)}else this.log(ev.f.LOG,`errorHandler other end, ${t},${null==r?void 0:r.status}, ${s}`),(a=e).context=i,this.emit(i7,a,t)}async init(e){var t,i,r;this.url&&await this.MP4Loader.changeUrl(this.url,`${this.options.vid}-${this._bitRate}`,this.CHUNK_SIZE),this.emit(rn,this.url),this.meta=null;let{meta:s,mediaSegList:n,buffer:a,fileSize:o,initSeg:l,bitrate:h,adaptTimeRange:d,repeatData:u}=e;if(s&&s.ext){o&&(this.fileSize=o),this.meta=s,this.videoTrak=s.ext.videoTrak,this.audioTrak=s.ext.audioTrak,this.meta.videoSamplesLen=this.videoTrak.reduce((e,t)=>e+t.frames.length,0),this.meta.audioSamplesLen=this.audioTrak.reduce((e,t)=>e+t.frames.length,0),this._bitRate=h,this.timeRange=this.getTimeRange(),this.adaptTimeRange=function(e){let t=[];if(!e||!e.length||0===e.length)return t;for(let i=0;i<e.length;i++){let r=e[i],s={};for(let e in r)Object.prototype.hasOwnProperty.call(r,e)&&(s[e]=r[e]);t.push(s)}return t}(d),n?(this.preloadCache={segList:n||[],initSeg:l},(null==(t=this.adaptTimeRange)?void 0:t.length)>0&&(null==u?void 0:u.byteLength)>0&&this.cacheRepeatData(this.adaptTimeRange[0].repeatRange,this.adaptTimeRange[0].repeatRange,u)):a&&(null==(i=this.adaptTimeRange)?void 0:i.length)>0&&(null==a?void 0:a.byteLength)>0&&this.cacheRepeatData(this.adaptTimeRange[0].range,this.adaptTimeRange[0].range,a),this.adaptTimeRange.map(e=>{e.downloaded=!1,e.isLoading=!1});for(let e=0;e<this.adaptTimeRange.length;e++)null==(r=this.updateTimeRangeInAdaptTimeRangeIdx)||r.call(this,this.adaptTimeRange[e].timeRangeIdx,e);let e={meta:s,videoSegments:s.ext.videoTrak,audioSegments:s.ext.audioTrak,bufferLoaded:a||null};this._bitRateInfoMap.set(this._bitRate,e),this.emit(re,this.meta)}else await this.getMetaInfo()}getTimeRange(){let e=[],t=null;for(let i=0;this.videoTrak&&i<this.videoTrak.length;i++){let{startTime:r}=this.videoTrak[i],{endTime:s}=this.videoTrak[i];t={startTime:r,endTime:s,duration:s-r,downloaded:!1,isLoading:!1},e.push(t)}if(this.audioTrak&&this.audioTrak.length>e.length)for(let i=e.length;i<this.audioTrak.length;i++){let r=Math.max(this.audioTrak[i].startTime,t?t.endTime:0),s=Math.max(this.audioTrak[i].endTime,t?t.endTime:0);t={startTime:r,endTime:s,duration:s-r,downloaded:!1,isLoading:!1},e.push(t)}return e}async getMetaInfo(e=!0){var t;try{let t=ij();this.metaLoading=!0,this.log(ev.f.LOG,"getMetaInfo start, bitRate,",this._bitRate,",url,",this.MP4Loader.url),this.resetRepeatInfo();let i=async(i,r,s,n,a)=>{var o;if(n){await this.cancelLoading();let e=new iI(iL.DEMUX,iC.metaError,{msg:JSON.stringify(n)});this.errorHandler(e,"getMetaInfo",{range:[0,this._firstLoadSize]});return}!this.fileSize&&a&&(this.fileSize=Number(i9(a.headers)));let l=(null==(o=null==s?void 0:s.priOptions)?void 0:o.type)||"cdn";if(i&&(this.cacheRepeatData([0,this._firstLoadSize],s.range,i),this._optionDataLenInfo[l]||(this._optionDataLenInfo[l]=0),this._optionDataLenInfo[l]+=i.byteLength),r&&this._optionDataLenInfo[l]&&(this._optionDataLenInfo[l]=0),s.meta&&!this.meta){this.firstFrameTime.metaload=ij()-t;let i=s.meta;this.videoTrak=i.videoSegments,this.audioTrak=i.audioSegments,this.timeRange=this.getTimeRange();let r=this.videoTrak.reduce((e,t)=>e+t.frames.length,0),n=this.audioTrak.reduce((e,t)=>e+t.frames.length,0);this.meta={...i.meta,ext:{videoTrak:this.videoTrak,audioTrak:this.audioTrak},videoSamplesLen:r,audioSamplesLen:n,fileSize:this.fileSize},this._bitRateInfoMap.set(this._bitRate,i),this.log(ev.f.LOG,"meta reach, bitRate,",this._bitRate,this._repeatInfo.curDataPos),e&&this.emit(re,this.meta)}if(this.meta&&r&&(this.log(ev.f.LOG,"[getMetaInfo req end]",this._repeatInfo.curDataPos),this.metaLoading=!1),this._loadedDataState){let e=!1;this._repeatInfo.curDataPos-this._repeatInfo.usedPos>=this.options.afterLoadeddataCallBackLen&&(e=!0),this.meta&&(e||r)&&(this.log(ev.f.LOG,"emit moov_req_progress loadeddata after",JSON.stringify(s.range)),this.emit(rt))}else this.meta&&(i||r)&&(this.log(ev.f.LOG,"emit moov_req_progress loadeddata before",JSON.stringify(s.range)),this.emit(rt))},r=this._firstLoadSize-1;await this.MP4Loader.loadMetaProcess(this.MP4Loader.cache,[0,r],i)}catch(e){this.log(ev.f.ERROR,"[MP4] trigger errorHandler getMetaInfo",null==(t=null==e?void 0:e.response)?void 0:t.status,null==e?void 0:e.message),this.loadError(e,"getMetaInfo",!1,{url:e.url||this.url,range:[0,this._firstLoadSize]})}}getFragmentIdx(e){let t,i;if(!this.videoTrak.length)return(i=this.audioTrak.find(t=>t.startTime<=e&&t.endTime>e))?i.index:0;if(t=this.videoTrak.find(t=>t.startTime<=e&&t.endTime>e),i=this.audioTrak.find(t=>t.startTime<=e&&t.endTime>e),t&&i)return Math.min(t.index,i.index);if(t||i)return t?t.index:i.index;{let e=Number.MAX_VALUE;return this.videoTrak&&this.videoTrak.length>0&&(e=this.videoTrak.length-1),this.audioTrak&&this.audioTrak.length>0&&(e=Math.min(this.audioTrak.length-1,e)),e}}async _checkHasMeta(){var e,t,i,r;let s=this._bitRateInfoMap.get(this._bitRate);if(s)this.log(ev.f.LOG,"[switchBitrate], not need load InitSegment, bitRate, ",this._bitRate),this.meta=s.meta;else{this.log(ev.f.LOG,"[switchBitrate], need load InitSegment, bitRate, ",this._bitRate),this.metaLoading=!0;let r=await this.MP4Loader.loadMeta(this.MP4Loader.cache,Math.round(this.CHUNK_SIZE/2));this.log(ev.f.LOG,"[switchBitrate], loadMeta end, ",this._bitRate),this.metaLoading=!1;let{videoTrak:n,audioTrak:a}=this,o=n.reduce((e,t)=>e+t.frames.length,0),l=a.reduce((e,t)=>e+t.frames.length,0),h=Number(i9(null==(i=null==(t=null==(e=null==r?void 0:r.responses)?void 0:e[0])?void 0:t.response)?void 0:i.headers));this.fileSize=h,this.log(ev.f.LOG,"[switchBitrate], fileSize set , ",h),this.meta={...r.meta,ext:{videoTrak:r.videoSegments,audioTrak:r.videoSegments},videoSamplesLen:o,audioSamplesLen:l,fileSize:h},(s=r).fileSize=h,this._bitRateInfoMap.set(this._bitRate,r)}this.videoTrak=s.videoSegments,this.audioTrak=s.audioSegments,this.fileSize=s.fileSize,this.emit(rr,this.meta),this.emit(rs,this.meta),this.timeRange=this.getTimeRange();for(let e=0;e<this.adaptTimeRange.length;e++)null==(r=this.updateTimeRangeInAdaptTimeRangeIdx)||r.call(this,this.adaptTimeRange[e].timeRangeIdx,e);return this._firstLoadSize=0,!0}async load(e,t){var i;if(this._loadSuccessCallBack=t,this._switchBitRate&&!this.metaLoading){this.log(ev.f.LOG,"[switchBitrate], switch bitRate start load, bitRate,",this._bitRate,", fragIndex,",e);let t=await this._checkHasMeta();if(this.changeBitRateTime>0){this.resetFragmentLoadState(e,!0),this.resetRepeatInfo();let t=this.getFragmentIdx(this.changeBitRateTime),i=e;if((e=this.getAdaptIdxBySrcIdx(t))<0)return void this.log(ev.f.ERROR,"[switchBitrate] start new bitrate fragIndex error");i!==e&&this.resetFragmentLoadState(e),this._curLoadSegIdx=e;let r=this.adaptTimeRange[e];this.log(ev.f.LOG,"[switchBitrate], need update load fragIndex",e,",oldFragIndex",i,",stTime,",this.changeBitRateTime,",newBitrateadaptTimeRange,",r.startTime,"-",r.endTime),this.emit(ra,e),this.seekTime=this.changeBitRateTime,this.changeBitRateTime=-1}this.log(ev.f.LOG,"[switchBitrate], reset adaptTimeRange state,",e),this._needInitSegment=!0,this.resetTansmuxer(),t&&(this._switchBitRate=!1)}if(this._switchBitRate&&this.metaLoading)return;let r=this.getFragRange(e),s=this.getFragmentFromCache(e,r);if(s&&this._needInitSegment&&!s.initSeg&&(s=null,this.log(ev.f.LOG,"[mp4.load], segment ,",e,"Data In Cache but not has init, so not use cacheData")),s){let{video:t,audio:i}=s.muxSampleIdxRange;this._lastDemuxSampleIdxRange.video=t,this._lastDemuxSampleIdxRange.audio=i,this.log(ev.f.LOG,"[mp4.load], segment ,",e,"Data In Cache",JSON.stringify(r),", needInit,",this._needInitSegment,",muxSampleIdxRange,",JSON.stringify(s.muxSampleIdxRange));let n=this.adaptTimeRange[e];n.downloaded=!0,n.isLoading=!0,this._needInitSegment=!1,this._loadSuccessCallBack&&this._loadSuccessCallBack(s)}else if(this.log(ev.f.LOG,"loadFragment,",e,",bitRate,",this._bitRate,",range,",JSON.stringify(r)),this.seekTime>0){let t=this.getSubRange(e,this.seekTime,r);null==(i=this.resetDemuxSampleIdx)||i.call(this,this.seekTime,t),this.loadFragment(e,t),this.seekTime=-1}else this.loadFragment(e,r)}getFragmentFromCache(e,t){let{preloadCache:i}=this;if(!i||!i.segList)return null;let r=-1,{segList:s,initSeg:n}=i;for(let t=0;t<s.length;t++)if(s[t].index===e){r=t;break}if(r<0)return null;{let i=s[r];if(!(i.range[1]>=t[1]))return null;{let{startTime:r=0,endTime:s=0}=this.adaptTimeRange[e],a=[r,s];return{buffer:i.buffer,range:t,muxSampleIdxRange:i.muxSampleIdxRange,context:{range:t,fragIndex:e,state:!0,adaptTimeRange:[a[0],a[1]]},state:!0,initSeg:this._needInitSegment?n:void 0}}}}cacheRepeatData(e,t,i){var r;if(!(!e||!(null!=e&&e.length)||!(null!=(r=this._repeatInfo.data)&&r.byteLength))&&(this._repeatInfo.startPos<0&&t[0]+i.byteLength>=e[0]&&t[0]+i.byteLength<=e[1]+1&&(this._repeatInfo.startPos=e[0]),this._repeatInfo.startPos>=0&&t[0]+i.byteLength>=e[0]&&t[0]+i.byteLength<=e[1]+1)){let r=this._repeatInfo.startPos+this._repeatInfo.curDataPos-t[0];if(r<0)return;let s=i.slice(r);if(this._repeatInfo.curDataPos+s.byteLength<this._repeatInfo.data.byteLength)this._repeatInfo.data.set(s,this._repeatInfo.curDataPos),this._repeatInfo.curDataPos+=s.byteLength,this.log(ev.f.LOG,", repeatInfo,startPos,",this._repeatInfo.startPos,", curDataPos,",this._repeatInfo.startPos+this._repeatInfo.curDataPos,",curAppendLen,",s.byteLength);else try{let t=Math.max(2*this._repeatInfo.data.byteLength,(e[1]-e[0])*2),i=iX(t);if(!i)return;i.set(this._repeatInfo.data.slice(0,this._repeatInfo.curDataPos),0),i.set(s,this._repeatInfo.curDataPos),this._repeatInfo.curDataPos+=s.byteLength,delete this._repeatInfo.data,this._repeatInfo.data=i,this.log(ev.f.LOG,"_repeatInfo,startPos,",this._repeatInfo.startPos,", curDataPos,",this._repeatInfo.curDataPos)}catch{console.error("repeat data cache  new array failed")}}}_mux(e,t,i,r){let{firstFrameTime:s,timeRecord:n}=this;s.firstmux<0&&n.startMuxTime<0&&(this.timeRecord.startMuxTime=ij(),s.startMuxTime=ij()-n.startLoadTime);let a=this.getSamplesRange(i,"video"),o=this.getSamplesRange(i,"audio");this.log(ev.f.LOG,"mux videoSampleRange,",a,o);let l=[t,t+e.byteLength];if(this.transmuxerWorkerControl){let s={range:l,state:r,fragIndex:i};this.log(ev.f.LOG,"[transmuxerworker start] ,range, ",JSON.stringify(l),",dataLen,",e.byteLength,s),this.transmuxerWorkerControl.transmux(this.workerSequence,e,t,a,o,this.meta.moov,this.useEME,this.secretKey,s)}else try{let h;this.MP4Demuxer||(this.MP4Demuxer=new ih(this.videoTrak,this.audioTrak,null,{openLog:iB}));let d=this.MP4Demuxer.demuxPart(e,t,a,o,this.meta.moov,this.useEME,this.keyValue);this.FMP4Remuxer||this.checkCodecH265()&&!this.options.supportHevc||(this.FMP4Remuxer=new id.s(this.MP4Demuxer.videoTrack,this.MP4Demuxer.audioTrack,{openLog:iB}));let{videoTrack:u,audioTrack:c}=d,p=null==u?void 0:u.samples,f=(null==p?void 0:p.length)>0?p[0].sampleOffset:-1,m=(null==p?void 0:p.length)>0?p[p.length-1].sampleOffset:-1,g=null==c?void 0:c.samples,_=(null==g?void 0:g.length)>0?g[0].sampleOffset:-1,v=(null==g?void 0:g.length)>0?g[g.length-1].sampleOffset:-1;this.updateDemuxSampleIdxRange([f,m],[_,v]),this.log(ev.f.LOG,"[mux],videoTimeRange,",null==u?void 0:u.startPts,"-",null==u?void 0:u.endPts,",videoSampleIdx",f,"-",m,",audioTimeRange,",null==c?void 0:c.startPts,"-",null==c?void 0:c.endPts,",audioSampleIdx",_,"-",v,i,JSON.stringify(l),r);let y=r||(null==p?void 0:p.length)>0?null==u?void 0:u.startPts:-1,A=r||(null==p?void 0:p.length)>0?null==u?void 0:u.endPts:-1,T=r||(null==g?void 0:g.length)>0?null==c?void 0:c.startPts:-1,b=r||(null==g?void 0:g.length)>0?null==c?void 0:c.endPts:-1,S=[Math.min(y,T),Math.max(A,b)];if(this.FMP4Remuxer){let e=this.FMP4Remuxer.remux(this._needInitSegment,{initMerge:!0,range:l});e.initSegment&&(this._needInitSegment=!1),h={buffer:iq(e.audioSegment,e.videoSegment),range:l,state:r,context:{range:l,fragIndex:i,timeRange:S},initSeg:e.initSegment}}else h={videoTrack:u,audioTrack:c,buffer:null,range:l,state:r,context:{range:l,fragIndex:i,timeRange:S}};s.firstmux<0&&n.startMuxTime>0&&(s.firstmux=ij()-n.startMuxTime),this._loadSuccessCallBack&&this._loadSuccessCallBack(h)}catch(n){let r=null==n?void 0:n.message;this.log(ev.f.ERROR,"mux err:",r);let s=new iI(iL.REMUX,iC.muxError,{msg:r});this.errorHandler(s,"mux",{fragIndex:i,range:[t,t+e.byteLength]})}}updateDemuxSampleIdxRange(e,t){(null==e?void 0:e[1])>=0&&(this._lastDemuxSampleIdxRange.video=e[1]),(null==t?void 0:t[1])>=0&&(this._lastDemuxSampleIdxRange.audio=t[1]),this.log(ev.f.LOG,"updateDemuxSampleIdxRange",JSON.stringify(this._lastDemuxSampleIdxRange))}async loadFragment(e,t){this._curLoadSegIdx=e;let i=this.adaptTimeRange[e];if(this._isPending||(null==t?void 0:t[1])===0||!i||i.isLoading||(null==t?void 0:t.length)===0)return;this._segmentToBitRateMap.set(e,this._bitRate),this.timeRecord.startLoadTime<0&&(this.timeRecord.startLoadTime=ij());let{startPos:r,curDataPos:s}=this._repeatInfo,{usedPos:n}=this._repeatInfo;if(t.length>=2&&t[1]&&t[1]>0&&t[0]>=r&&t[1]<r+s){i.isLoading=!0;let a=Math.max(t[0],r+n),o=new Uint8Array(this._repeatInfo.data.slice(a-r,t[1]-r+1));if(this.log(ev.f.LOG,"[mp4.loadFragment] has all data: ",a,t[1]),this.log(ev.f.LOG,"[mp4.loadFragment] ",",repeatInfo, startPos,",r,", usedPos,",r+n,",curDataPos, ",r+s),i.downloaded=!0,this.metaLoading||0===r)this._repeatInfo.usedPos=0,this.log(ev.f.LOG,"[mp4.loadFragment] has all data set repeatInfo.usedPos = 0");else{let e=i.range[0]-r,t=i.range[1]+1-r,s=new Uint8Array(this._repeatInfo.data.slice(e,t));this.resetRepeatInfo(),this.cacheRepeatData(i.repeatRange,i.range,s)}this._mux(o,a,e,!0)}else if(t.length>=2&&t[0]&&t[0]>=r&&t[0]<=r+s){if(!i.isLoading){let a=Math.max(t[0],r+n),o=Math.min(t[1]+1,r+s),l=new Uint8Array(this._repeatInfo.data.slice(a-r,o-r));if(l.byteLength>0){this._repeatInfo.usedPos=o-this._repeatInfo.startPos;let i=this._repeatInfo.usedPos;this.log(ev.f.LOG,"[mp4.loadFragment] has part data: ",a,a+l.byteLength),this.log(ev.f.LOG,"[mp4.loadFragment] ",",repeatInfo, startPos,",r,", usedPos,",r+i,",curDataPos, ",r+s),this._mux(l,a,e,t[1]<=r+i);return}if(!this.metaLoading&&!i.isLoading){this.log(ev.f.LOG,"[mp4.loadFragment] load part data >>> ",r+s,t[1]),i.isLoading=!0;let a=[r+n,t[1]],o=null==i?void 0:i.repeatRange;if(o&&o[0]<a[0]){let e=[i.repeatRange[0],a[0]],{startPos:t,curDataPos:r,data:s}=this._repeatInfo,n=s.slice(e[0]-t,r);this.resetRepeatInfo(),this.cacheRepeatData(i.repeatRange,e,n)}else this.resetRepeatInfo();await this.startLoad(a,e)}}}else this.metaLoading&&!(t[0]>r)||i.isLoading||(i.isLoading=!0,this.log(ev.f.LOG,"[mp4.loadFragment],ready to load all data ,segmentIdx, ",e,",range >>> ",t),this.resetRepeatInfo(),await this.startLoad(t,e))}resetRepeatInfo(){this.log(ev.f.LOG,", resetRepeatInfo"),this._repeatInfo.startPos=-1,this._repeatInfo.curDataPos=0,this._repeatInfo.usedPos=0}setSwitchPCDNCallBack(e){this._switchPCDNCallBack=e}updateChangeBitRateTime(e){this.changeBitRateTime=e}async startLoad(t,i,r=!1){var s,n,a,o;let{firstFrameTime:l}=this;0===i&&(null==l?void 0:l.first_gop_req_cnt)<0?l.first_gop_req_cnt=1:i>0&&(null==l?void 0:l.first_gop_req_cnt)<0&&(l.first_gop_req_cnt=0);let h=this.selectedPCDN(r),d=h||this.url;this.log(ev.f.LOG,"[startLoad], ",i,JSON.stringify(t),d);try{await this.MP4Loader.loadData(t,this.MP4Loader.cache,{index:i,onProgress:this.onprogressDataArrive,onProcessMinLen:this.options.onProcessMinLen,url:d,headers:h?{"X-Origin-Server-Host":this._domain}:null,priOptions:{type:h?iv:"cdn"}})}catch(u){let r=(null==(n=null==(s=null==u?void 0:u.options)?void 0:s.priOptions)?void 0:n.type)===iv||!!h,l=null,d=u.url||(r?h:this.url);r?(this.pcdnVVStat.conn_fail_num++,e.pcdn_download_failed_cnt++,l=this._pcdnNodeList.shift(),this.emit(ro,l),this.log(ev.f.ERROR,"pcdn load err, retry use cdn,range",t,",fragIndex",i,(null==u?void 0:u.isTimeout)||(null==(a=null==u?void 0:u.response)?void 0:a.status),null==u?void 0:u.message,d),await this.startLoad(t,i,!0)):this.log(ev.f.ERROR,"cdn load err,range",JSON.stringify(t),",fragIndex",i,(null==u?void 0:u.isTimeout)||(null==(o=null==u?void 0:u.response)?void 0:o.status),null==u?void 0:u.message,d),this.loadError(u,"loadFragment",r,{range:t,fragIndex:i,url:d})}}loadError(e,t,i,r){var s,n;e.response||(e.response={}),e.isTimeout?e.response.status=iC.timeout:null!=(s=null==e?void 0:e.response)&&s.status||(e.response.status=iC.networkError);let a=iY(null==r?void 0:r.url);this.markErrHost(a),this.emit(rl,{src:null==r?void 0:r.url,host:a,errorCode:null==(n=null==e?void 0:e.response)?void 0:n.status,message:null==e?void 0:e.message,range:(null==r?void 0:r.range)&&JSON.stringify(r.range),headers:null==r?void 0:r.headers}),i||this.errorHandler(e,t,r)}async loadAllFragmentData(t,i,r,s=!1){var n,a,o,l,h,d;if(this.hasDestroyed)return;this.resetRepeatInfo();let u=(null==(n=this.adaptTimeRange[t])?void 0:n.range)||this.getFragRange(t);this._curLoadSegIdx=t;let c=this.selectedPCDN(s),p=iG(c||this.url,{__rand:new Date().getTime()});try{this.log(ev.f.LOG,",[loadAllFragmentData], index,",t,",rang,",JSON.stringify(u),", use-pcdn,",!!c);let e=await this.MP4Loader.loadData(u,this.MP4Loader.cache,{index:t,url:p,headers:c?{"X-Origin-Server-Host":this._domain}:null,priOptions:{type:c?iv:"cdn"}});if(this.log(ev.f.LOG,"loadAllFragmentData after",t,JSON.stringify(u)),!e||!e.data){let e=Error("response null");r?r(e):this.loadError(e,"loadFragment",!!c,{range:u,fragIndex:t,url:c||this.url});return}let{data:s}=e;if((null==s?void 0:s.byteLength)>0&&u&&u.length>=2)this._receiveDataPos=u[0]+(null==s?void 0:s.byteLength),this._loadSuccessCallBack=i,this.adaptTimeRange[t].downloaded=!0,this.cacheRepeatData(this.adaptTimeRange[t].repeatRange,u,s),this._mux(s,u[0],t,!0);else{let i=i6(null==(a=null==e?void 0:e.response)?void 0:a.headers);this.log(ev.f.LOG,"[FragLoadDowned check false, retry load],fragmentIdx,",t,",dataLen,",null==s?void 0:s.byteLength,JSON.stringify(u),JSON.stringify(i),p);let r=Error("dataLen not match");this.resetRepeatInfo();let n=this.adaptTimeRange[t];this.emit(rd,[n.startTime,n.endTime]),this.loadError(r,"loadFragment",!!c,{range:u,fragIndex:t,url:p,headers:i})}}catch(n){let s=(null==(l=null==(o=null==n?void 0:n.options)?void 0:o.priOptions)?void 0:l.type)===iv||!!c;s?(e.pcdn_download_failed_cnt++,this._pcdnNodeList.shift(),this.log(ev.f.ERROR,"[loadAllFragmentData] ,pcdn load err, retry use cdn,fragIndex",t,n.isTimeout||(null==(h=null==n?void 0:n.response)?void 0:h.status),null==n?void 0:n.message),await this.loadAllFragmentData(t,i,r,!0)):this.log(ev.f.ERROR,"[MP4] loadAllFragmentData error",{fragIndex:t,range:JSON.stringify(u)},n.isTimeout||(null==(d=null==n?void 0:n.response)?void 0:d.status),null==n?void 0:n.message),this.loadError(n,"loadFragment",s,{range:u,fragIndex:t,url:n.url||(s?c:this.url)})}}currentLoadUseUrl(){var e;return this._isUseCDN?this.url:(null==(e=this._pcdnNodeList)?void 0:e.length)>0?this._pcdnNodeList[0].url:""}getCurSwitchPCDNCnt(){return this._PCDNSwitchCnt}selectedPCDN(t){let i;if(this._PCDNState===rc||t){this._isUseCDN=!0;return}if(this.isUsePCDN()){if(this._isUseCDN){if(this._switchPCDNCallBack){let e=this._switchPCDNCallBack();e>0&&(this.options.switchPCDNMaxCnt=e)}if(this._PCDNSwitchCnt>=this.options.switchPCDNMaxCnt)return this._isUseCDN=!0,this.log(ev.f.LOG,"cdn switch pcdn outlimit, curSwitchCnt ,",this._PCDNSwitchCnt,",maxCnt,",this.options.switchPCDNMaxCnt),null;this._PCDNSwitchCnt++,this.log(ev.f.LOG,"cdn switch pcdn, curSwitchCnt,",this._PCDNSwitchCnt,",maxCnt,",this.options.switchPCDNMaxCnt)}this._isUseCDN=!1,i=iG(this._pcdnNodeList[0].url,{__vid:this.options.vid}),this._lastPCDNUrl!==i&&(this.emit(rn,i),this._lastPCDNUrl=i,this.pcdnVVStat.conn_req_num+=1),e.pcdn_download_request_cnt++}else this._isUseCDN||(this.log(ev.f.LOG,"pcdn switch cdn PCDNSwitchCnt,",this._PCDNSwitchCnt,",maxCnt,",this.options.switchPCDNMaxCnt),this.pcdnVVStat.conn_jump_num+=1),this._isUseCDN=!0;return i}async cancelLoading(){this.MP4Loader&&await this.MP4Loader.cancel(),this._optionDataLenInfo[iv]&&this._optionDataLenInfo[iv]>0&&(this.emit(rh,{load_type:iv,len:this._optionDataLenInfo[iv]}),this._optionDataLenInfo[iv]=0),this._optionDataLenInfo.cdn&&this._optionDataLenInfo.cdn>0&&(this.emit(rh,{load_type:"cdn",len:this._optionDataLenInfo.cdn}),this._optionDataLenInfo.cdn=0)}updateUrl(e,t){let i=iY(e);this._defaultDomain||(this._defaultDomain=i),0>i.indexOf("www.")?this._domain=i:this._domain=this._defaultDomain,this.url=e,this.backUrl=t||[]}getDataBitRate(e){return this._segmentToBitRateMap.get(e)}checkCodecH265(){return this.meta&&(this.meta.videoCodec.indexOf("hvc1")>-1||this.meta.videoCodec.indexOf("hev1")>-1)}checkCodecH266(){return this.meta&&this.meta.videoCodec.indexOf("bvc2")>-1}destroy(){this.hasDestroyed||(this.resetTansmuxer(),this.transmuxerWorkerControl&&this.transmuxerWorkerControl.destroy(),this.fileSize=0,this.totalSize=0,this._isPending=!1,this.metaLoading=!1,this.resetRepeatInfo(),delete this._repeatInfo.data,this._bitRateInfoMap.clear(),this._segmentToBitRateMap.clear(),this.MP4Loader&&(this.MP4Loader.cancel(),this.MP4Loader.destroy()),this.removeAllListeners(),this.hasDestroyed=!0,this.pcdnVVStat=this.resetPCDNVVStat())}resetPCDNVVStat(){return{try_req_node:0,req_node_succ:0,has_ret_node:0,conn_req_num:0,conn_fail_num:0,conn_jump_num:0}}resetTansmuxer(){var e;null==(e=this.resetDemuxSampleIdx)||e.call(this),this.MP4Demuxer&&this.MP4Demuxer.reset(),this.MP4Demuxer=null,this.FMP4Remuxer&&this.FMP4Remuxer.reset(),this.FMP4Remuxer=null,this.transmuxerWorkerControl&&this.transmuxerWorkerControl.reset()}getMediaEndTime(){if(this._mediaEndTime>0)return this._mediaEndTime;let{videoTrak:e,audioTrak:t}=this;if((null==e?void 0:e.length)>0){let{endTime:t}=e[e.length-1];this._mediaEndTime=this._mediaEndTime<0?t:Math.min(t,this._mediaEndTime)}if((null==t?void 0:t.length)>0){let{endTime:e}=t[t.length-1];this._mediaEndTime=this._mediaEndTime<0?e:Math.min(e,this._mediaEndTime)}return this._mediaEndTime}};ic(rf,"pcdn_download_request_cnt",0),ic(rf,"pcdn_download_failed_cnt",0);let rm=rf;class rg extends rm{constructor(e,t,i,r=[],s,n){super(e,t,i,r,s,n),this._logTag=`${n}_gop`}updateAdaptTimeRange(e,t){this._lastTargetDur=t;let i=this.adaptTimeRange;for(let r=0;r<i.length;r++){let{timeRangeIdx:s}=i[r];if(e>=s[0]&&e<s[1])return this.log(ev.f.LOG,"has adaptTimeRange,startSrcIdx, ",e,",adaptTimeRangeIdx",r,", dur,",t,JSON.stringify(i[r])),r}let r=i.length>0?i[i.length-1].timeRangeIdx[1]:0;if(r>=this.timeRange.length)return i.length-1;for(;r<e;){let{startTime:e}=this.timeRange[r],{endTime:t}=this.timeRange[r],i={startTime:e,endTime:t,timeRangeIdx:[r,r+1],duration:t-e,downloaded:!1,isLoading:!1};this.adaptTimeRange.push(i),this.updateTimeRangeInAdaptTimeRangeIdx(i.timeRangeIdx,this.adaptTimeRange.length-1),this.log(ev.f.LOG,"gap adaptTimeRange,adaptTimeRangeIdx, ",this.adaptTimeRange.length-1,JSON.stringify(i)),r++}let s=0,n=r,a=r;for(;a<this.timeRange.length;a++)if(s<t)s+=this.timeRange[a].endTime-this.timeRange[a].startTime;else{n=a;break}a===this.timeRange.length&&(n=this.timeRange.length);let o=[r,n],{startTime:l}=this.timeRange[o[0]],h=o[1]===this.timeRange.length?this.timeRange[o[1]-1].endTime:this.timeRange[o[1]].startTime,d={startTime:l,endTime:h,timeRangeIdx:o,duration:h-l,downloaded:!1,isLoading:!1};return this.log(ev.f.LOG,"update adaptTimeRange,startIdx,",o[0],", dur,",t,JSON.stringify(d)),this.adaptTimeRange.push(d),this.updateTimeRangeInAdaptTimeRangeIdx(o,this.adaptTimeRange.length-1),this.adaptTimeRange.length-1}updateTimeRangeInAdaptTimeRangeIdx(e,t){for(let i=e[0];i<e[1];i++)i<this.timeRange.length&&(this.timeRange[i].adaptTimeRangeIdx=t)}getAdaptIdxBySrcIdx(e,t){var i;let r=this.adaptTimeRange.length;if(!t&&e>=(null==(i=this.adaptTimeRange[r-1])?void 0:i.timeRangeIdx[1])){let t=this._lastTargetDur||5;this.updateAdaptTimeRange(e,t)}for(let t=0;t<this.adaptTimeRange.length;t++){let{timeRangeIdx:i}=this.adaptTimeRange[t];if(i&&e>=i[0]&&e<i[1])return t}return -1}getFragmentIdx(e){let t,i;if(!this.videoTrak.length)return(i=this.audioTrak.find(t=>t.startTime<=e&&t.endTime>e))?i.index:0;if(t=this.videoTrak.find(t=>t.startTime<=e&&t.endTime>e),i=this.audioTrak.find(t=>t.startTime<=e&&t.endTime>e),t&&i)return Math.min(t.index,i.index);if(t||i)return t?t.index:i.index;{let e=Number.MAX_VALUE;return this.videoTrak&&this.videoTrak.length>0&&(e=this.videoTrak.length-1),this.audioTrak&&this.audioTrak.length>0&&(e=Math.min(this.audioTrak.length-1,e)),e}}resetFragmentLoadState(e,t=!1){this.log(ev.f.LOG,", resetFragmentLoadState, fragIndex, ",e,",changeBitrate,",t);for(let i=0;i<this.adaptTimeRange.length;i++)if(i<e?(this.adaptTimeRange[i].downloaded=!0,this.adaptTimeRange[i].isLoading=!0):(this.adaptTimeRange[i].downloaded=!1,this.adaptTimeRange[i].isLoading=!1),t){this.adaptTimeRange[i].range=null;let{timeRangeIdx:t}=this.adaptTimeRange[i];if(t[0]>=this.timeRange.length){this.log(ev.f.WARN,"fix adaptTimeRange fragIndex",e," ,timeRangeIdx[0] >= this.timeRange.length, so end",t[0],this.timeRange.length,",endFragment,",i),this.adaptTimeRange=this.adaptTimeRange.slice(0,i);break}t[1]>=this.timeRange.length&&(this.log(ev.f.WARN,"fix adaptTimeRange fragIndex",e," ,timeRangeIdx[1],",t[1],">>>>",this.timeRange.length,",endFragment,",i),t[1]=this.timeRange.length,this.adaptTimeRange=this.adaptTimeRange.slice(0,i+1)),this.adaptTimeRange[i].startTime=this.timeRange[t[0]].startTime,this.adaptTimeRange[i].endTime=t[1]>=this.timeRange.length?this.timeRange[this.timeRange.length-1].endTime:this.timeRange[t[1]].endTime,this.adaptTimeRange[i].range=this.getFragRange(i)}}calculateRange(e){let t=null,i=null,r=null,s=null,n=e<this.adaptTimeRange.length?this.adaptTimeRange[e].timeRangeIdx:null;if(!n)return this.log(ev.f.warn,"calculateRange err",e,JSON.stringify(this.adaptTimeRange)),[];let a=n[0],o=n[1];this.log(ev.f.LOG,"getFragRange, timeRangeIdx,",JSON.stringify(n));let l=this.videoTrak;l&&(t=a<l.length?l[a]:l[l.length-1],i=o<l.length?l[o-1]:l[l.length-1]);let h=this.audioTrak;h&&(r=a<h.length?h[a]:h[h.length-1],s=o<h.length?h[o-1]:h[h.length-1]);let d=Math.min((null==t?void 0:t.range[0])||1/0,(null==r?void 0:r.range[0])||1/0),u=Math.max(d,(null==i?void 0:i.range[1])||0,(null==s?void 0:s.range[1])||0),c=[d,u];return this.log(ev.f.LOG,"calculateRange",e,c[0],"-",c[1]),c}getTimeRangeByIdx(e){let t=null,i=this.videoTrak;i&&(t=e<i.length?i[e]:i[i.length-1]);let r=null,s=this.audioTrak;return s&&(r=e<s.length?s[e]:s[s.length-1]),[Math.min((null==t?void 0:t.range[0])||1/0,(null==r?void 0:r.range[0])||1/0),Math.max((null==t?void 0:t.range[1])-1||0,(null==r?void 0:r.range[1])-1||0)]}getFragRange(e){var t;if(e<this.adaptTimeRange.length&&null!=(t=this.adaptTimeRange[e])&&t.range)return this.log(ev.f.LOG,"getFragRange exist",e,JSON.stringify(this.adaptTimeRange[e].range)),this.adaptTimeRange[e].range;let i=this.calculateRange(e);if(e<this.adaptTimeRange.length){this.adaptTimeRange[e].range=i;let t=this.adaptTimeRange[e].timeRangeIdx[1];if(t<this.timeRange.length){let r=this.getTimeRangeByIdx(t);(null==r?void 0:r.length)>1&&r[0]<r[1]&&i[1]>r[0]&&(this.adaptTimeRange[e].repeatRange=[r[0],i[1]])}}return i}getSubRange(e,t,i){let r=this.adaptTimeRange[e].timeRangeIdx,s=r[0];for(let e=r[0];e<r[1];e++)if(t>=this.timeRange[e].startTime&&t<this.timeRange[e].endTime){s=e;break}let n=[this.getSrcFragRange(s)[0],i[1]];return this.log(ev.f.LOG,">>>>>getSubRange finalRange ",JSON.stringify(n),",oldRange,",JSON.stringify(i)),n}getSrcFragRange(e){let t=null,i=null;this.log(ev.f.LOG,"getFragRange, timeRangeIdx, srcFragment,",JSON.stringify(e));let r=this.videoTrak;r&&(t=e<r.length?r[e]:r[r.length-1]);let s=this.audioTrak;s&&(i=e<s.length?s[e]:s[s.length-1]);let n=[Math.min((null==t?void 0:t.range[0])||1/0,(null==i?void 0:i.range[0])||1/0),Math.max((null==t?void 0:t.range[1])-1||0,(null==i?void 0:i.range[1])-1||0)];return this.log(ev.f.LOG,",getSrcFragRange",e,n),n}getSamplesRange(e,t){let i=[],r=this.adaptTimeRange[e].timeRangeIdx;switch(t){case"video":if(this.videoTrak&&r[0]<this.videoTrak.length){let{frames:e}=this.videoTrak[r[0]];i.push(e[0].index);let t=this.videoTrak.length,s=r[1]-1,n=s<t?this.videoTrak[s].frames:this.videoTrak[t-1].frames;i.push(n[n.length-1].index)}break;case"audio":if(this.audioTrak&&r[0]<this.audioTrak.length){let{frames:e}=this.audioTrak[r[0]];i.push(e[0].index);let t=this.audioTrak.length,s=r[1]-1,n=s<t?this.audioTrak[s].frames:this.audioTrak[t-1].frames;i.push(n[n.length-1].index)}break;default:console.warn("[getSamplesRange] type ",t," is invalid")}return i}}function r_(){let e=window.navigator.userAgent,t=e.indexOf("MSIE "),i=e.indexOf("Trident/");return t>0||i>0}function rv(){return!!navigator.requestMediaKeySystemAccess&&!function(){let e=/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent),t=r_(),i=function(){let{mimeTypes:e}=navigator,t=navigator.userAgent,i=!1;return e&&t.indexOf("Chrome")>1&&(i=Object.keys(e).some(t=>!!(e[t].type&&e[t].type.indexOf("360")>-1||e[t].type&&e[t].type.indexOf("application/vnd.chromium.remoting-viewer")>-1||e[t].description&&e[t].description.indexOf("360")>-1))),i}(),r=navigator.userAgent.indexOf("Firefox")>0,s=navigator.userAgent.indexOf("Edge")>0;return e||t||i||r||s}()}function ry(){try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){let e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){console.log(e)}return!1}function rA(){let e=window.MediaSource=window.MediaSource||window.WebKitMediaSource;return e&&"function"==typeof e.isTypeSupported}class rT{constructor(){let e,t,i=new Promise((i,r)=>{e=i,t=r});return i.id=`${new Date().getTime()}_${parseInt(100*Math.random())}`,i.resolve=function(t){e(t),i.state="fulfilled"},i.reject=function(e){t(e),i.state="rejected",i.isBreak="DESTROYED"===e},i.state="pending",i}resolve(e){}reject(e){}}class rb extends e1{init(){return Promise.resolve()}preloadPredict(e){return e}}let rS="h264";function rE(e){let{mediaType:t,definition:i,codecType:r,vtype:s}=e,{vid:n}=e;return t=t||"video",i=i||"-1",r=r||rS,s=s||eO.MP4,n?`${n}#${t}#${r}#${s}#${i}`:null}function rk(e,t){return function(e,t){let i=-1;for(let r=0;r<e.length;r++)if(t===e[r].data.vid){i=r;break}return i}(e,t)>=0}function rP(e,t){for(let i=0;i<e.length;i++)if(e[i]===t)return i;return -1}let{PRELOAD_TYPES:rw}=eM,rx="preload_ended",rC=0,rL=!0,rD=null;class rI extends e0{constructor(e,t){var i;let r=rI.getDefaultConfig(e);Object.keys(e).forEach(t=>{r[t]=e[t]}),super(r),ic(this,"_updateRealTimeSpeed",e=>{rC=e.speed,this.emit(im,e)}),this.video=null,this._mp4=null,this._pendingPromise=null,this.playerId=t.playerId||"default",this._nextPreloadCount=0,this.isActive=!0,this.MP4Loader=null,this.playingVids=[],this.playingVids1=[],this.loadingCount=0;let{logCacheLevel:s,logMaxSize:n}=this.options.logCacheConfig;this.logger=new ev.V("[Mp4Preloader]",{logCacheLevel:s,logMaxSize:n}),void 0===e.supportHevc&&!(typeof MediaSource>"u")&&MediaSource.isTypeSupported&&(MediaSource.isTypeSupported('video/mp4;codecs="hev1.1.6.L120.90"')||MediaSource.isTypeSupported('video/mp4;codecs="hev1.2.4.L120.90"')||MediaSource.isTypeSupported('video/mp4;codecs="hev1.3.E.L120.90"')||MediaSource.isTypeSupported('video/mp4;codecs="hev1.4.10.L120.90"'))&&(this.options.supportHevc=!0),this.loadRangeType=(null==(i=this.options)?void 0:i.loadRangeType)||"gop",iV(ev.f.DEBUG,"[Preloader] new preloader, playerId",this.playerId),this.update({preloadMaxCacheCount:this.options.preloadMaxCacheCount})}static get PRELOAD_TYPES(){return rw}static get BitRateAdapter(){return rD}static set BitRateAdapter(e){rD=e}static getDefaultConfig(){return{supportHevc:!1,preloadTime:5,preloadSize:0,preloadType:0,segmentMinDuration:5,vtype:"MP4",codecType:"h264",preloadCacheType:1,preloadMaxCacheCount:5,globalKey:null,autoPreload:!1,reqOptions:null,getRequestOptionsCallback:null,minBufferLength:5,timeout:3e3,autoCheck:{enable:!0,interval:1e3},logCacheConfig:{logCacheLevel:2,logMaxSize:204800},pcdnConfig:{openPreloadPCDN:!1,enterMinBuffer:10,outMaxBuffer:5,pcdn_duration:2,pcdn_open:!0,openPCDN:!0,minDuration:25,trackerUrl:""},switchPCDNMaxCnt:2,retryCount:1,retryDelay:1e3,loaderType:"fetch"}}static registerPreloader(e,t){return e.vtype=eO.MP4,rI.BitRateAdapter=t,new rI(e,this)}static getInfoByUniqueKey(e){let t=e.split("#"),i=["vid","mediaType","codecType","vtype","definition"],r={};return t.forEach((e,t)=>{r[i[t]]=e}),r}static generateUniqueKey(e){return rE(e)}static disable(){rL=!1}static enable(){rL=!0}set codecType(e){this.options.codecType=e}get codecType(){return this.options.codecType}get vtype(){return this.options.vtype}log(e,t,...i){iV(this.logger,e,t,...i)}update(e){Object.keys(e).forEach(t=>{this.options[t]=e[t]}),this.preloadManager.setMaxCache?this.preloadManager.setMaxCache(this.options.preloadMaxCacheCount):this.preloadManager._cacheInst._maxCache=this.options.preloadMaxCacheCount}get currentPreloadInst(){return this.preloadManager._currentPreloadInst}startCheckTask(){this.preloadManager.startCheckTask()}stopCheckTask(){this.preloadManager.stopCheckTask()}getPreloadMetaByVid(e){let{allCachedKeys:t,allCachedTimeKeys:i}=this;return function(e,t,i){let r=[],s="";Object.keys(t).forEach(t=>{let i=function(e){if(!e)throw Error(`key ${e} is empty`);let t=e.split("#");if(t.length<5)throw Error(`key ${e} is not right format`);let i=t[0],r=t[1],s=t[2];return{vid:i,mediaType:r,codecType:s,vtype:t[3],definition:t[4],order:-1,timeStamp:0,total:0}}(t);i.vid===e&&(r.push(i),s=t)});let n=null;if(s){let e=function(e){let t=[];return Object.keys(e).forEach(i=>{t.push(Number(e[i]))}),t.sort((e,t)=>e-t)}(i),t=Number(i[s]),a=function(e,t){for(let i=0;i<e.length;i++)if(e[i]===t)return i;return -1}(e,t);(n=r[0]).timeStamp=t,n.order=a,n.total=e.length}return n}(e,t,i)}async getPreloadMemoryInfo(){let{allCachedKeys:e}=this,t=0,i=0;for(let r in e)if(e.hasOwnProperty(r)){i++;try{let e=await this.getPreLoadData(r);t+=(null==e?void 0:e.memory)||0}catch{}}return{memory:t,cnt:i}}getPreloadUnuseInfo(){let e=[];for(let[t,i]of iA)if(iT.get(t))iA.delete(t);else{let r=t.split("#"),s=(null==r?void 0:r.length)>0?r[0]:t;e.push({vid:s,bw:(null==i?void 0:i.bw)||0,pbw:(null==i?void 0:i.pbw)||0})}return e}generateUniqueKey(e){return rE(e)}addPlayingItem(e,t){let i=this.checkPlaying("_playerId",e);i>-1?this.playingVids[i].vid=t:this.playingVids.push({vid:t,_playerId:e}),this.log(ev.f.LOG,"addPlayingItem",i,e,t,this.playingVids)}delPlayingItem(e){let t=this.checkPlaying("_playerId",e);this.log(ev.f.LOG,"delPlayingItem",t,e,this.playingVids),t>-1&&this.playingVids.splice(t,1)}checkPlaying(e,t){let i=this.playingVids;for(let r=0;r<i.length;r++)if(t===i[r][e])return r;return -1}before(){this.handlers={checkIfCanPreload:()=>this.checkIfCanPreload(),start:e=>{let t=e.payload||[];if(0===t.length)return Promise.reject(Error("preload_is_null"));let{vid:i}=e,r=e.vtype||eO.MP4,s=e.codecType||rS,n=this.getUserSelectDefinition(),a=this.checkCacheKey(i,t,n,r,s);if(this.log(ev.f.LOG,`${this.playerId} ${i}`,`codecType:${s} vtype:${r} hasCache:${a}`),a||"MP3"===r)return Promise.reject(Error(`vtype_${r}`));let o=this.getInitDefinition(t,this.options.definition,n);if(this.log(ev.f.LOG,` ${this.playerId} ${i} getInitDefinition`,null==o?void 0:o.definition),!o)return Promise.reject(Error("definition_error"));let{definition:l,orgDefinition:h}=o,d=o.vtype||r,u=o.codecType||s,c=e.preloadTime||this.options.preloadTime,p=e.preloadSize||this.options.preloadSize||390624,f=this.generateUniqueKey({vid:i,definition:l,vtype:d,codecType:u});this._nextPreloadCount>0&&this._nextPreloadCount--,iV(ev.f.LOG,`${i} start duration:${o.duration} preloadTime:${c} cacheKey:${f},playerId:${this.playerId}`);let m={vid:i,definition:l,orgDefinition:h,preloadTime:c,preloadSize:p,cacheKey:f,codecType:u,vtype:d,...o};return e.reqOptions&&(m.reqOptions=e.reqOptions),this.loadingCount++,this.log(ev.f.LOG,`start preload,${i} loadingCount:${this.loadingCount},playerId:${this.playerId}`),this.start(m)},onRequest:({url:e,range:t,extData:i},r)=>this.getData(e,t,i,r)},this.loggerConfig={logger:()=>{},openLog:!1},this.predictInst=new rb(this.loggerConfig)}start(e){let t={mediaInfos:{dynamic_video_list:[],dynamic_audio_list:[]},onObtain:()=>{let e=new rT;return e.resolve(t.mediaInfos),e},onTransform:()=>{let t=new rT;this._pendingPromise=t;let{preloadType:i}=this.options;return this.emit("preload_start",{...e,type:i}),i===rw.DURATION?this.loadByPreloadTime(e,t):this.loadByChunkSize(e,t),t}};return Promise.resolve(t)}getInitDefinition(e,t,i=null){let r=null;return rI.BitRateAdapter?(r=rI.BitRateAdapter.select(e,{codec:this.codecType,format:this.vtype},"Mp4Preloader"),this.log(ev.f.DEBUG,"Mp4Preloader.BitRateAdapter",null==r?void 0:r.type,null==r?void 0:r.definition,null==r?void 0:r.bitrate)):r=function(e,t){let i=null;if(!e||e.length<1)return i;for(let r=0;r<e.length;r++){let s=e[r];if(s.definition===t){i=s;break}}return i||(i=e[0]),i}(e,t),r||(r=e[0]),r}getPreLoadData(e){let t=new rT;return this.getItemSameVid(e).then(e=>{if(this.log(ev.f.DEBUG,"[Preloader] getPreLoadData",!!e.value),e.value){let{mediaSegList:i,meta:r,type:s,buffer:n,preloadTime:a,vid:o,cacheKey:l,definition:h,orgDefinition:d,byteLength:u,duration:c,fileSize:p,from:f,vtype:m,codecType:g,initSeg:_,bitrate:v,adaptTimeRange:y,repeatData:A,memory:T}=e.value,b={vid:o,type:s,vtype:m,codecType:g,definition:h,orgDefinition:d,bitrate:v,cacheKey:l,duration:c||0,byteLength:u,from:f,adaptTimeRange:y,repeatData:A,memory:T,meta:r,preloadTime:a};s===rw.SIZE?(b.buffer=n,b.fileSize=p||0):(b.mediaSegList=i,b.fileSize=p||0,b.initSeg=_),t.resolve(b)}else t.resolve(null)}).catch(e=>{t.reject(e)}),t}async setPreLoadData(e,t){var i,r;let s=new rT,{mediaSegList:n,meta:a,vid:o,definition:l,orgDefinition:h,type:d,buffer:u,duration:c,byteLength:p,preloadTime:f,fileSize:m,from:g,vtype:_,codecType:v,initSeg:y,bitrate:A,adaptTimeRange:T,repeatData:b}=t,S={codecType:v,vtype:_,vid:o,definition:l,orgDefinition:h,cacheKey:e,type:d,from:g,meta:a,fileSize:m,adaptTimeRange:T,repeatData:b,bitrate:A};if(S.memory=0,S.memory+=(null==b?void 0:b.byteLength)||0,d===rw.SIZE)S.buffer=u,S.byteLength=p||0,S.preloadSize=p||0,S.preloadTime=f||0,S.fileSize=m,S.buffer&&S.buffer.byteLength>0&&(S.memory+=(null==u?void 0:u.byteLength)||0,this.setItem(e,S),s.resolve(!0));else if(S.mediaSegList=[],S.duration=c,S.byteLength=p||0,S.preloadTime=f||0,S.initSeg=y,S.memory+=(null==y?void 0:y.byteLength)||0,S.fileSize=m,n.forEach(e=>{var t;S.memory+=(null==(t=null==e?void 0:e.buffer)?void 0:t.byteLength)||0,S.mediaSegList.push(e)}),a&&0===n.length)this.log(ev.f.LOG,"[Preloader] meta setPreLoadData1 success",e,null==(i=null==S?void 0:S.mediaSegList)?void 0:i.length),this.setItem(e,S),s.resolve(!0);else{let t=n.every(e=>!!e.buffer&&e.state);this.log(ev.f.LOG,"[Preloader] mediaSegList setPreLoadData1 success",e,null==(r=null==S?void 0:S.mediaSegList)?void 0:r.length,t),t||s.resolve(!1),this.setItem(e,S).then(()=>{this.log(ev.f.LOG,"[Preloader] setPreLoadData1 success",e)}),s.resolve(!0)}return s}getInitCacheData(e,t){let i={type:e,meta:null,byteLength:0,fileSize:0,bitrate:0,preloadTime:0};return e===rw.DURATION?(i.mediaSegList=[],i.initSeg=null,i.duration=0):i.buffer=null,Object.keys(t).map(e=>{i[e]=t[e]}),i}updatePreCacheData(e,t,i,r,s,n,a,o,l){let{mediaSegList:h,type:d}=e;if(d===rw.SIZE||-1===s)return e.buffer=e2(Uint8Array,e.buffer.buffer||[],new Uint8Array(t)),e;let u=-1;for(let e=0;e<h.length;e++)if(h[e].index===s){u=e;break}let c=n||[0,0];if(u>-1)t&&(h[u].buffer=e2(Uint8Array,h[u].buffer||[],new Uint8Array(t))),i.length>1&&(h[u].range.length>1?h[u].range[1]=i[1]:h[u].range=i),-1!==a[1]&&(r=h[u].range[1]>=a[1]),h[u].state=r;else{let{video:l,audio:d}=o;e.duration=c[1],h.push({buffer:t,range:i||[],index:s,totalRange:a||[],timeRange:[c[0],c[1]],muxSampleIdxRange:{video:l,audio:d},state:r});let u=`${null==t?void 0:t.byteLength},${JSON.stringify(i)},${s},${JSON.stringify(a)},${JSON.stringify(n)}`;this.log(ev.f.DEBUG,`[Preloader] ${e.cacheKey} mediaSegList set, dataLen`,u)}return r&&(e.byteLength+=i[1]-i[0],e.preloadTime+=l),r}checkCacheKey(e,t,i,r=eO.MP4,s=rS){let n=this.getPreloadMetaByVid(e);if(n)return this.generateUniqueKey(n);if(i){let t=this.generateUniqueKey({vid:e,definition:i,vtype:r,codecType:s});return this.hasItemSameVid(t)?t:null}for(let i=0;i<t.length;i++){let n=this.generateUniqueKey({vid:e,definition:t[i].definition,vtype:r,codecType:s});if(this.hasItemSameVid(n))return n}return null}attachPlayer(e){this.video=e.video?e.video:e}detachPlayer(){this.video=null}checkIfCanPreload(){let e;if(!rL||this.loadingCount>=1||!this.isActive)return!1;if(this.video){let{minBufferLength:t,startPreloadControl:i,startPreloadMinBuffer:r,startPreloadMinPosTime:s}=this.options;e=function(e,t){if(!e)return!1;let i=function(e,t){let i=[0,0];if(e)for(let r=0,s=e.length;r<s&&(i[0]=e.start(r),i[1]=e.end(r),!(i[0]<=t&&t<=i[1]));r++);return i[0]-t<=0&&t-i[1]<=0?i:[0,0]}(e.buffered,e.currentTime),{startPreloadControl:r,startPreloadMinBuffer:s,startPreloadMinPosTime:n,minBufferLength:a}=t;if(r){let t=Math.max(i[1]-e.currentTime,0);if(t>s){if(e.currentTime>n||e.currentTime>e.duration/2)return!0}else if(e.currentTime+s+1>e.duration&&e.currentTime+t>e.duration-1)return!0}else{let t=e.duration>a+5?a:e.duration/2,r=Math.min(e.currentTime+a,e.duration),s=i[1]-r;if(e.currentTime>t&&(s>0||1>Math.abs(s)))return!0}return!1}(this.video,{startPreloadControl:i,startPreloadMinBuffer:r,startPreloadMinPosTime:s,minBufferLength:t})}else e=this._nextPreloadCount>0;return iV(ev.f.DEBUG,"[Preloader] checkIfCanPreload",!!this.video,`nextPreloadCount:${this._nextPreloadCount} ret:${e}`),e}startPreloadNext(e=1){let t=!0;return this._nextPreloadCount=e,(this.loadingCount>=1||!this.isActive)&&(t=!1),t&&this.preloadNext(),t}get realTimeSpeed(){return rC}getRequestOption(e){let{getRequestOptionsCallback:t,reqOptions:i}=this.options;return(e.reqOptions?e.reqOptions:"Function"===iz(t)?t(e):i)||{}}loadByPreloadTime(e,t){var i;let{vid:r,cacheKey:s,preloadTime:n,definition:a,orgDefinition:o,duration:l,bitrate:h}=e,{codecType:d,vtype:u,size:c}=e,p="Array"===iz(e.url)?e.url[0].src:e.url;if(!p)return void this._endLoadFragments();p=iG(p,{__vid:r});let{segmentMinDuration:f}=this.options,m=n>=f?f:n,g=this.getRequestOption({...e,url:p});this.log(ev.f.DEBUG,"[Preloader] loadByPreloadTime",`${e.cacheKey}, definition:${e.definition},segmentMinDuration:${m}`);let _=c||iW(h,l),v=null==(i=null==e?void 0:e.pktOffsetMap)?void 0:i.find(e=>{var t;return(null==e?void 0:e.time)===((null==(t=this.options)?void 0:t.firstLoadTimePos)||5)}),y=null==v?void 0:v.offset;this._mp4=new rg(p,h,{segmentDuration:m,codecType:this.codecType,chunkSize:this.options.preloadSize,firstLoadSize:y,duration:l,fileSize:_,playerId:this.playerId,vid:r,useUrlRange:!1,retryCount:1,retryDelay:1e3,supportHevc:this.options.supportHevc,retryCheckFunc:i0,switchPCDNMaxCnt:Number.MAX_VALUE,logger:this.logger,reqOptions:g,fixEditListOffset:this.options.fixEditListOffset},[],this.firstFrameTime,"[Preloader]");let A=this.getInitCacheData(rw.DURATION,{vid:r,definition:a,orgDefinition:o,cacheKey:s,codecType:d,vtype:u,bitrate:h||0});this._mp4.once("metaReady",async i=>{var n;let a=this._mp4;a&&(this.log(ev.f.DEBUG,`[Preloader] ${r} metaReady ${null==(n=null==A?void 0:A.mediaSegList)?void 0:n.length}`),A.meta=i,A.from=2,A.fileSize=a.size,await a.cancelLoading(),!a.hasDestroyed&&(a.metaLoading=!1,this.emit("prf_meta_ready",{...A}),await this.setPreLoadData(s,A),a.hasDestroyed||this.startLoadByFragments(A,e,t)))}),this._mp4.on(i7,e=>{this.log(ev.f.ERROR,`[Preloader] ${r} loadByPreloadTime error`),this._endLoadFragments(),this.emit("error",e)}),this._mp4.on(rh,e=>{this.bwEventEmit(r,e.load_type,e.len,null,s,e)}),this._mp4.MP4Loader.on(im,e=>{var t;if((null==e?void 0:e.len)>0){let i=(null==(t=null==e?void 0:e.priOptions)?void 0:t.type)||"cdn",n=iZ(e.len,e.time);this.bwEventEmit(r,i,e.len,n,s,e)}}),this._mp4.init({})}bwEventEmit(e,t,i,r,s,n){let a=iA.get(s)||{bw:0,pbw:0};t&&"cdn"!==t||(a.bw=a.bw+i,this.emit("prf_data_size",{vid:e,task_type:2,cdn_size:i,cdn_speed:r,...n})),iA.set(s,a),this._updateRealTimeSpeed({speed:r,type:t||"cdn"})}async loadByChunkSize(e){var t;let{vid:i,cacheKey:r,definition:s,orgDefinition:n,duration:a,bitrate:o,codecType:l,vtype:h,size:d}=e,{options:u}=this,c="Array"===iz(e.url)?e.url[0].src:e.url;if(!c)return void this._endLoadChunk();c=iG(c,{__vid:i});let p=d||iW(o,a),f=null==(t=null==e?void 0:e.pktOffsetMap)?void 0:t.find(e=>(null==e?void 0:e.time)===((null==u?void 0:u.firstLoadTimePos)||5)),m=null==f?void 0:f.offset,g=iO(a,8e5,p);this.log(ev.f.LOG,`${i} loadByChunkSize`,e.cacheKey,e.definition,m||g);let _=this.getInitCacheData(rw.SIZE,{vid:i,definition:s,orgDefinition:n,cacheKey:r,codecType:l,vtype:h,fileSize:d,bitrate:o||0}),v=this.getRequestOption({...e,url:c});this.MP4Loader=new t9({url:c,vid:`${i}-${o}`,retry:u.retryCount||2,retryDelay:u.retryDelay||1e3,timeout:u.timeout||3e3,...v,loaderType:u.loaderType,retryCheckFunc:i0,openLog:iF(),fixEditListOffset:u.fixEditListOffset}),this.MP4Loader.on(im,e=>{var t;if((null==e?void 0:e.len)>0){let s=(null==(t=null==e?void 0:e.priOptions)?void 0:t.type)||"cdn",n=iZ(e.len,e.time);this.bwEventEmit(i,s,e.len,n,r)}});try{let e=new Uint8Array(0),t=0,s=null,n=async(n,a,o,l,h)=>{var d;if(_.fileSize||(_.fileSize=Number(i9(h.headers))),n&&o.range&&o.range[0]===t&&(e=e2(Uint8Array,e,new Uint8Array(n)),t+=n.byteLength),o.meta){await this.MP4Loader.cancel();let l=(null==(d=null==n?void 0:n.priOptions)?void 0:d.type)||"cdn";this.bwEventEmit(i,l,e.byteLength,null,r);let h=o.meta,u=h.videoSegments,p=h.audioSegments;_.meta={...h.meta,ext:{videoTrak:u,audioTrak:p}},s=iK(0,u,p),_.buffer=e.slice(s[0]),_.byteLength=_.buffer.byteLength;let f=iK(1,u,p),m=[];f[0]<f[1]&&s[1]>f[0]&&(m=[f[0],s[1]]);let g=(null==u?void 0:u.length)>0?u:p,{startTime:v}=g[0],{endTime:y}=g[0],A={startTime:v,endTime:y,range:[...s],repeatRange:m,duration:y-v,downloaded:!1,isLoading:!1};A.timeRangeIdx=[0,1],_.adaptTimeRange=[A],this.log(ev.f.LOG,`${i} loadMetaProcess ret`,r,e.byteLength,JSON.stringify(s),_.buffer.byteLength,JSON.stringify(m)),this.setPreLoadData(r,_);let T=[t,s[1]];this.log(ev.f.LOG,`${r} loadMetaProcess end, loadOneChunk start`,a,JSON.stringify(T),t,e.byteLength),this._loadOneChunk(_,T,c,A.duration)}};await this.MP4Loader.loadMetaProcess(this.MP4Loader.cache,[0,m||g],n)}catch(e){console.error(`[Preloader] ${r} loadByChunkSize error`,e),this._endLoadChunk()}}async _loadOneChunk(e,t,i,r){if((null==t?void 0:t.length)>0&&t[0]>=t[1]){this._endLoadChunk(),this.emit(rx,e);return}let{vid:s,cacheKey:n,buffer:a}=e;try{let o=await this.MP4Loader.loadData(t,this.MP4Loader.cache,{index:0,url:i,priOptions:{}});this.log(ev.f.LOG,`${s} _loadOneChunk`,JSON.stringify(t),n);let{response:l,data:h}=o;if(h){if(this._endLoadChunk(),l&&l.headers){let t=iW(l.headers);t&&(e.fileSize=t)}e.buffer=iq(a,h),e.byteLength=e.buffer.byteLength,e.preloadTime+=r,this.log(ev.f.LOG,`${s} _loadOneChunk ret`,n,e.buffer.byteLength,null==h?void 0:h.byteLength),e.from=4,this.setPreLoadData(n,e)}else this._endLoadChunk()}catch(e){this.log(ev.f.ERROR,`[Preloader] ${s} loadByChunkSize error`,null==e?void 0:e.message),this._endLoadChunk()}}_endLoadChunk(){this.log(ev.f.LOG,`_endLoadChunk loadingCount:${this.loadingCount}`,this._pendingPromise?this._pendingPromise.state:null),this._pendingPromise&&(this._pendingPromise.resolve(),this._pendingPromise=null),this.loadingCount>0&&this.loadingCount--,this.MP4Loader&&(this.MP4Loader.cancel(),this.MP4Loader.destroy(),this.MP4Loader=null)}getAdaptRanges(e,t){let{timeRange:i}=e;for(let r=0;r<i.length&&i[r].startTime<=t;r++)e.updateAdaptTimeRange(r,1),e.getFragRange(r);return this._mp4.adaptTimeRange}async startLoadByFragments(e,t){let{preloadTime:i,vid:r}=t;this.log(ev.f.LOG,`[Preloader] ${r} startLoadByFragments`,t);let s=this.getAdaptRanges(this._mp4,i),n=e=>{this.log(ev.f.ERROR,`[Preloader] ${r} _failedCallback error`,null==e?void 0:e.message),this.emit("error",e),this._endLoadFragments()},a=async t=>{var i;if(!this._mp4)return;let{buffer:r,context:o,state:l,initSeg:h}=t,{fragIndex:d,range:u,timeRange:c}=o,{_repeatInfo:p,adaptTimeRange:f}=this._mp4,m=f[d],g=null==m?void 0:m.range,_=null==m?void 0:m.duration;!e.initSeg&&h&&(e.initSeg=h,e.adaptTimeRange=f);let v=this._mp4._lastDemuxSampleIdxRange;e.repeatData=(null==(i=p.data)?void 0:i.slice(0,p.curDataPos))||[];let y=this.updatePreCacheData(e,r,u,l,d,c,g,v,_);this.log(ev.f.LOG,`[Preloader] ${e.cacheKey} _successCallback`,d,l,y,e),e.from=3,y&&(await this.setPreLoadData(e.cacheKey,e),d>=s.length-1?(this.log(ev.f.LOG,`[Preloader] ${e.cacheKey} mp4.load end`,d),this.emit(rx,e),this._endLoadFragments()):(this.log(ev.f.LOG,`[Preloader] ${e.cacheKey} mp4.load start`,d+1),await this._mp4.loadAllFragmentData(d+1,a,n)))};await this._mp4.loadAllFragmentData(0,a,n)}_endLoadFragments(){this.log(ev.f.LOG,`[Preloader] _endLoadFragments loadingCount:${this.loadingCount},${this.playerId}`,this._pendingPromise?this._pendingPromise.state:null),this._pendingPromise&&(this._pendingPromise.resolve(),this._pendingPromise=null),this.loadingCount>0&&this.loadingCount--,this._mp4&&(this._mp4.cancelLoading(),this._mp4.destroy(),this._mp4=null)}getFragment(e,t,i,r,s,n={}){let a=new rT;return this.getData(e,t,n,!1).then(e=>{r.createFragment(new Uint8Array(e.res),t[0]-r.mdatStart,i,{range:t,context:e.context}).then(e=>{a.resolve(e)})}),a}getPreloadUrl({url:e,range:t,definition:i,vid:r}){return[{url:e,range:t,extData:{cacheKey:rI.generateUniqueKey({vid:r,start:t[0],end:t[1],definition:i}),vid:r,format:"mp4"}}]}getRangeList(e){let{allCachedKeys:t}=this,i={timeRange:[],contentRange:[]};for(let r in t)if(t.hasOwnProperty(r)&&r.indexOf(e)>-1){let e=r.split("#");0===e[2].indexOf("pretime")?i.timeRange.push([0,parseFloat(e[2].slice(7))]):i.contentRange.push([parseInt(e[2]),parseInt(e[3])])}return i}hasItemSameVid(e){if(!e)return null;let t=e.split("#"),i=Object.keys(this.allCachedKeys);for(let r=0;r<i.length;r++){let s=i[r];if(s===e)return s;let n=s.split("#");if(n.length>=4&&t.length>=4&&n[0]===t[0]){if(0===n[2].indexOf("pretime")&&0===t[2].indexOf("pretime"))return s;{let e=[parseInt(n[2]),parseInt(n[3])],i=[parseInt(t[2]),parseInt(t[3])];if(i[0]>=e[0]&&i[1]>i[0]&&i[1]<=e[1])return s}}}return null}removeOthers(e=[]){let{allCachedKeys:t}=this;for(let i in t)if(t.hasOwnProperty(i)&&i.split("#").length>=1){let t=i.split("#")[0];e.every(e=>e.split("#").length>=1&&e.split("#")[0]!==t)&&(this.log(ev.f.LOG,`remove cache:${i}`),this.cacheInst.removeItem(i))}}removeAll(){let{allCachedKeys:e}=this;for(let t in e)e.hasOwnProperty(t)&&(this.log(ev.f.DEBUG,`remove cache:${t}`),this.cacheInst.removeItem(t))}removeAllPreloadTask(){this.preloadManager._preloadDataList=[],this.playingVids=[]}getItemSameVid(e,t){let i=this.hasItemSameVid(e);return this.log(ev.f.DEBUG,`getItemSameVid: key:${e} checkResult:${i}`),i?this.cacheInst.getItem(i,t).then(e=>({value:e,key:i})):Promise.resolve({})}setItem(e,t){return this.cacheInst.setItem(e,t)}removeItem(e,t){return this.cacheInst.removeItem(e,t)}get allCachedKeys(){return this.cacheInst._allCachedKeys||{}}get allCachedTimeKeys(){return this.cacheInst._allCachedTimeKeys||{}}get cacheInst(){return this.preloadManager._cacheInst}get preloadQueueList(){return this.preloadManager._preloadDataList||[]}cancelPreloadByVid(e,t){if(!e)return;let{_preloadDataList:i}=this.preloadManager,r=[];for(let t=0;t<i.length;t++){let{data:s}=i[t];s.vid!==e?r.push(i[t]):this.log(ev.f.LOG,"cancelPreloadByVid",e)}this.preloadManager._preloadDataList=r;let s=this.currentPreloadInst,n=s&&s.options?s.options:{};this.log(ev.f.LOG,"cancelPreloadByVid",e,t,e===n.vid,n),n.vid===e&&this.cancelLoading(),this.addPlayingItem(t,e)}addPlayingVid(e){if(!e)return;let{_preloadDataList:t}=this.preloadManager,i=t.filter(t=>t.data.vid!==e);this.preloadManager._preloadDataList=i;let r=this.currentPreloadInst,s=r&&r.options?r.options:{};this.log(ev.f.LOG,"cancelPreloadByVid",e,e===s.vid,s),s.vid===e&&this.cancelLoading(),rP(this.playingVids1,e)>=0||this.playingVids1.push(e)}removePlayingVid(e){let t=rP(this.playingVids1,e);t>=0&&this.playingVids1.splice(t,1)}cancelLoading(){this.log(ev.f.LOG,"cancelLoading"),this._endLoadFragments(),this._endLoadChunk()}clearTaskItem(e){let{preloadManager:t}=this;if(t._currentPreloadInst){let{_toLoadList:i}=t._currentPreloadInst,r=[];i.map(t=>(t._playerId!==e&&r.push(t),t)),t._currentPreloadInst._toLoadList=r}let i=[],r=[];this.log(ev.f.LOG,"clearTaskItem before",e,t._preloadDataList.length),t._preloadDataList.map(t=>(t._playerId!==e?i.push(t):r.push(t.data.vid),t)),this.log(ev.f.LOG,"clearTaskItem",e,r.join(","),t._preloadDataList.length),t._preloadDataList=i}clearTask(){let{preloadManager:e}=this;e._preloadDataList=[]}addPreloader(e){if(!e.data)return;let{_preloadDataList:t}=this.preloadManager,{vid:i}=e.data,r=rk(t||[],i),s=rP(this.playingVids1,i)>=0;if(this.log(ev.f.LOG,"[Preloader] addPreloader checkIfVidInList",i,r),r||s)return;let n=iH({},e);n.vtype||(n.vtype=eO.MP4),this.addDashPreloader(n)}addPreloaderList(e=[]){let t=[],{_preloadDataList:i}=this.preloadManager;for(let r=0;r<e.length;r++){let{vid:s,vtype:n}=e[r].data,a=rk(i||[],s),o=rP(this.playingVids1,s)>=0;if(this.log(ev.f.LOG,"[Preloader] addPreloaderList checkIfVidInList",s,a,o),a||o)continue;let l=iH({},e[r]);n||(l.data.vtype=eO.MP4),t.push(l)}return this.log(ev.f.LOG,`[Preloader] addPreloaderList length is ${t.length}`),this.addDashPreloaderList(t),t}setUserSelectDefinition(e){this.preloadManager&&(this.preloadManager.userDefinition=e)}getUserSelectDefinition(){return this.preloadManager.userDefinition||null}cancel(e){this.clearTaskItem(e),this.delPlayingItem(e,null)}destroy(e){this.cancelLoading(),this.clearTaskItem(e),this.delPlayingItem(e,null)}on(e,t,...i){super.on(e,t,...i)}off(e,t,...i){super.off(e,t,...i)}}var rR=Object.defineProperty,rO=(e,t,i)=>{let r;return(r="symbol"!=typeof t?t+"":t)in e?rR(e,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[r]=i};function rM(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=Array(t);i<t;i++)r[i]=e[i];return r}function rB(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function rN(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,rz(r.key),r)}}function rU(e,t,i){return t&&rN(e.prototype,t),i&&rN(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function rF(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,r)}return i}function rV(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?rF(Object(i),!0).forEach(function(t){var r,s;r=t,s=i[t],(r=rz(r))in e?Object.defineProperty(e,r,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[r]=s}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):rF(Object(i)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}function r$(e){return function(e){if(Array.isArray(e))return rM(e)}(e)||function(e){if("u">typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return rM(e,void 0);var i=({}).toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?rM(e,t):void 0}}(e)||function(){throw TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}()}function rz(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t);if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e,"string");return"symbol"==typeof t?t:t+""}function rj(e){return(rj="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var rG="u">typeof window&&window.location&&window.location.href.indexOf("xgplayerdebugger=1")>-1,rH="%c[xgplayer]",rW={config:{debug:3*!!rG},logInfo:function(e){for(var t,i=arguments.length,r=Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];this.config.debug>=3&&(t=console).log.apply(t,[rH,"color: #525252; background-color: #90ee90;",e].concat(r))},logWarn:function(e){for(var t,i=arguments.length,r=Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];this.config.debug>=1&&(t=console).warn.apply(t,[rH,"color: #525252; background-color: yellow; ",e].concat(r))},logError:function(e){var t;if(!(this.config.debug<1)){for(var i=this.config.debug>=2?"trace":"error",r=arguments.length,s=Array(r>1?r-1:0),n=1;n<r;n++)s[n-1]=arguments[n];(t=console)[i].apply(t,[rH,"color: #525252; background-color: red;",e].concat(s))}}},rq=rU(function e(t){rB(this,e),this.bufferedList=t},[{key:"start",value:function(e){return this.bufferedList[e].start}},{key:"end",value:function(e){return this.bufferedList[e].end}},{key:"length",get:function(){return this.bufferedList.length}}]),rK={};rK.createDom=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"div",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",s=document.createElement(e);return s.className=r,s.innerHTML=t,Object.keys(i).forEach(function(t){var r=i[t];"video"===e||"audio"===e||"live-video"===e?r&&s.setAttribute(t,r):s.setAttribute(t,r)}),s},rK.createDomFromHtml=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";try{var r=document.createElement("div");r.innerHTML=e;var s=r.children;return r=null,s.length>0?(s=s[0],i&&rK.addClass(s,i),t&&Object.keys(t).forEach(function(e){s.setAttribute(e,t[e])}),s):null}catch(e){return rW.logError("util.createDomFromHtml",e),null}},rK.hasClass=function(e,t){if(!e||!t)return!1;try{return Array.prototype.some.call(e.classList,function(e){return e===t})}catch{var i=e.className&&"object"===rj(e.className)?e.getAttribute("class"):e.className;return i&&!!i.match(RegExp("(\\s|^)"+t+"(\\s|$)"))}},rK.addClass=function(e,t){if(!(!e||!t))try{t.replace(/(^\s+|\s+$)/g,"").split(/\s+/g).forEach(function(t){t&&e.classList.add(t)})}catch{rK.hasClass(e,t)||(e.className&&"object"===rj(e.className)?e.setAttribute("class",e.getAttribute("class")+" "+t):e.className+=" "+t)}},rK.removeClass=function(e,t){if(!(!e||!t))try{t.replace(/(^\s+|\s+$)/g,"").split(/\s+/g).forEach(function(t){t&&e.classList.remove(t)})}catch{rK.hasClass(e,t)&&t.split(/\s+/g).forEach(function(t){var i=RegExp("(\\s|^)"+t+"(\\s|$)");e.className&&"object"===rj(e.className)?e.setAttribute("class",e.getAttribute("class").replace(i," ")):e.className=e.className.replace(i," ")})}},rK.toggleClass=function(e,t){e&&t.split(/\s+/g).forEach(function(t){rK.hasClass(e,t)?rK.removeClass(e,t):rK.addClass(e,t)})},rK.classNames=function(){for(var e=arguments,t=[],i=function(i){"String"===rK.typeOf(e[i])?t.push(e[i]):"Object"===rK.typeOf(e[i])&&Object.keys(e[i]).map(function(r){e[i][r]&&t.push(r)})},r=0;r<arguments.length;r++)i(r);return t.join(" ")},rK.findDom=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document,i=arguments.length>1?arguments[1]:void 0;try{e=t.querySelector(i)}catch(r){rW.logError("util.findDom",r),0===i.indexOf("#")&&(e=t.getElementById(i.slice(1)))}return e},rK.getCss=function(e,t){return e.currentStyle?e.currentStyle[t]:document.defaultView.getComputedStyle(e,!1)[t]},rK.padStart=function(e,t,i){for(var r=String(i),s=0|t,n=Math.ceil(s/r.length),a=[],o=String(e);n--;)a.push(r);return a.join("").substring(0,s-o.length)+o},rK.format=function(e){if(window.isNaN(e))return"";e=Math.round(e);var t=rK.padStart(Math.floor(e/3600),2,0),i=rK.padStart(Math.floor((e-3600*t)/60),2,0),r=rK.padStart(Math.floor(e-3600*t-60*i),2,0);return("00"===t?[i,r]:[t,i,r]).join(":")},rK.event=function(e){if(e.touches){var t=e.touches[0]||e.changedTouches[0];e.clientX=t.clientX||0,e.clientY=t.clientY||0,e.offsetX=t.pageX-t.target.offsetLeft,e.offsetY=t.pageY-t.target.offsetTop}e._target=e.target||e.srcElement},rK.typeOf=function(e){return Object.prototype.toString.call(e).match(/([^\s.*]+)(?=]$)/g)[0]},rK.deepCopy=function(e,t){if("Object"===rK.typeOf(t)&&"Object"===rK.typeOf(e))return Object.keys(t).forEach(function(i){"Object"!==rK.typeOf(t[i])||t[i]instanceof Node?"Array"===rK.typeOf(t[i])?e[i]="Array"===rK.typeOf(e[i])?e[i].concat(t[i]):t[i]:e[i]=t[i]:void 0===e[i]||void 0===e[i]?e[i]=t[i]:rK.deepCopy(e[i],t[i])}),e},rK.deepMerge=function(e,t){return Object.keys(t).map(function(i){if("Array"===rK.typeOf(t[i])&&"Array"===rK.typeOf(e[i])){if("Array"===rK.typeOf(e[i])){var r;(r=e[i]).push.apply(r,r$(t[i]))}}else rK.typeOf(e[i])!==rK.typeOf(t[i])||null===e[i]||"Object"!==rK.typeOf(e[i])||t[i]instanceof window.Node?null!==t[i]&&(e[i]=t[i]):rK.deepMerge(e[i],t[i])}),e},rK.getBgImage=function(e){var t=(e.currentStyle||window.getComputedStyle(e,null)).backgroundImage;if(!t||"none"===t)return"";var i=document.createElement("a");return i.href=t.replace(/url\("|"\)/g,""),i.href},rK.copyDom=function(e){if(!e||1!==e.nodeType)return"";var t=document.createElement(e.tagName);return Array.prototype.forEach.call(e.attributes,function(e){t.setAttribute(e.name,e.value)}),e.innerHTML&&(t.innerHTML=e.innerHTML),t},rK.setInterval=function(e,t,i,r){e._interval[t]||(e._interval[t]=window.setInterval(i.bind(e),r))},rK.clearInterval=function(e,t){clearInterval(e._interval[t]),e._interval[t]=null},rK.setTimeout=function(e,t,i){e._timers||(e._timers=[]);var r=setTimeout(function(){t(),rK.clearTimeout(e,r)},i);return e._timers.push(r),r},rK.clearTimeout=function(e,t){var i=e._timers;if("Array"===rK.typeOf(i)){for(var r=0;r<i.length;r++)if(i[r]===t){i.splice(r,1),clearTimeout(t);break}}else clearTimeout(t)},rK.clearAllTimers=function(e){var t=e._timers;"Array"===rK.typeOf(t)&&(t.map(function(e){clearTimeout(e)}),e._timerIds=[])},rK.createImgBtn=function(e,t,i,r){var s,n,a,o=rK.createDom("xg-".concat(e),"",{},"xgplayer-".concat(e,"-img"));return o.style.backgroundImage='url("'.concat(t,'")'),i&&r&&(["px","rem","em","pt","dp","vw","vh","vm","%"].every(function(e){return!(i.indexOf(e)>-1&&r.indexOf(e)>-1)||(s=parseFloat(i.slice(0,i.indexOf(e)).trim()),n=parseFloat(r.slice(0,r.indexOf(e)).trim()),a=e,!1)}),o.style.width="".concat(s).concat(a),o.style.height="".concat(n).concat(a),o.style.backgroundSize="".concat(s).concat(a," ").concat(n).concat(a),"start"===e?o.style.margin="-".concat(n/2).concat(a," auto auto -").concat(s/2).concat(a):o.style.margin="auto 5px auto 5px"),o},rK.Hex2RGBA=function(e,t){var i=[];if(/^\#[0-9A-F]{3}$/i.test(e)){var r="#";e.replace(/[0-9A-F]/ig,function(e){r+=e+e}),e=r}return/^#[0-9A-F]{6}$/i.test(e)?(e.replace(/[0-9A-F]{2}/ig,function(e){i.push(parseInt(e,16))}),"rgba(".concat(i.join(","),", ").concat(t,")")):"rgba(255, 255, 255, 0.1)"},rK.getFullScreenEl=function(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement},rK.checkIsFunction=function(e){return e&&"function"==typeof e},rK.checkIsObject=function(e){return null!==e&&"object"===rj(e)},rK.hide=function(e){e.style.display="none"},rK.show=function(e,t){e.style.display=t||"block"},rK.isUndefined=function(e){if(typeof e>"u"||null===e)return!0},rK.isNotNull=function(e){return null!=e},rK.setStyleFromCsstext=function(e,t){t&&("String"===rK.typeOf(t)?t.replace(/\s+/g,"").split(";").map(function(t){if(t){var i=t.split(":");i.length>1&&(e.style[i[0]]=i[1])}}):Object.keys(t).map(function(i){e.style[i]=t[i]}))},rK.filterStyleFromText=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["width","height","top","left","bottom","right","position","z-index","padding","margin","transform"],i=e.style.cssText;if(!i)return{};var r=i.replace(/\s+/g,"").split(";"),s={},n={};return r.map(function(e){if(e){var i=e.split(":");i.length>1&&(function(e,t){for(var i=0,r=t.length;i<r;i++)if(e.indexOf(t[i])>-1)return!0;return!1}(i[0],t)?s[i[0]]=i[1]:n[i[0]]=i[1])}}),e.setAttribute("style",""),Object.keys(n).map(function(t){e.style[t]=n[t]}),s},rK.getStyleFromCsstext=function(e){var t=e.style.cssText;if(!t)return{};var i=t.replace(/\s+/g,"").split(";"),r={};return i.map(function(e){if(e){var t=e.split(":");t.length>1&&(r[t[0]]=t[1])}}),r},rK.preloadImg=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){};if(e){var r=new window.Image;r.onload=function(e){r=null,t&&t(e)},r.onerror=function(e){r=null,i&&i(e)},r.src=e}},rK.stopPropagation=function(e){e&&e.stopPropagation()},rK.scrollTop=function(){return window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0},rK.scrollLeft=function(){return window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0},rK.checkTouchSupport=function(){return"ontouchstart"in window},rK.getBuffered2=function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.5,i=[],r=0;r<e.length;r++)i.push({start:.5>e.start(r)?0:e.start(r),end:e.end(r)});i.sort(function(e,t){return e.start-t.start||t.end-e.end});var s=[];if(t)for(var n=0;n<i.length;n++){var a=s.length;if(a){var o=s[a-1].end;i[n].start-o<t?i[n].end>o&&(s[a-1].end=i[n].end):s.push(i[n])}else s.push(i[n])}else s=i;return new rq(s)},rK.getEventPos=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return e.touches&&e.touches.length>0&&(e=e.touches[0]),{x:e.x/t,y:e.y/t,clientX:e.clientX/t,clientY:e.clientY/t,offsetX:e.offsetX/t,offsetY:e.offsetY/t,pageX:e.pageX/t,pageY:e.pageY/t}},rK.requestAnimationFrame=function(e){var t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;if(t)return t(e)},rK.getHostFromUrl=function(e){if("String"!==rK.typeOf(e))return"";var t=e.split("/"),i="";return t.length>3&&t[2]&&(i=t[2]),i},rK.cancelAnimationFrame=function(e){var t=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.cancelRequestAnimationFrame;t&&t(e)},rK.isMSE=function(e){return e.media&&(e=e.media),!!e&&e instanceof HTMLMediaElement&&(/^blob/.test(e.currentSrc)||/^blob/.test(e.src))},rK.isBlob=function(e){return"string"==typeof e&&/^blob/.test(e)},rK.generateSessionId=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=new Date().getTime();try{e=parseInt(e)}catch{e=0}return t+=e,window.performance&&"function"==typeof window.performance.now&&(t+=parseInt(window.performance.now())),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?i:3&i|8).toString(16)})},rK.createEvent=function(e){var t;return"function"==typeof window.Event?t=new Event(e):(t=document.createEvent("Event")).initEvent(e,!0,!0),t},rK.adjustTimeByDuration=function(e,t,i){return t&&e&&(e>t||i&&e<t)?t:e},rK.createPositionBar=function(e,t){var i=rK.createDom("xg-bar","",{"data-index":-1},e);return t.appendChild(i),i},rK.getTransformStyle=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{x:0,y:0,scale:1,rotate:0},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i={scale:"".concat(e.scale||1),translate:"".concat(e.x||0,"%, ").concat(e.y||0,"%"),rotate:"".concat(e.rotate||0,"deg")};return Object.keys(i).forEach(function(e){var r=RegExp("".concat(e,"\\([^\\(]+\\)"),"g"),s="".concat(e,"(").concat(i[e],")");r.test(t)?(r.lastIndex=-1,t=t.replace(r,s)):t+="".concat(s," ")}),t},rK.convertDeg=function(e){return 1>=Math.abs(e)?360*e:e%360},rK.getCurrentTimeByOffset=function(e,t){var i=-1;if(!t||t.length<0)return e;for(var r=0;r<t.length;r++)if(e<=t[r].duration){i=r;break}if(-1!==i){var s=t[i].start;return i-1<0?s+e:s+(e-t[i-1].duration)}return e},rK.getIndexByTime=function(e,t){var i=t.length,r=-1;if(i<1)return r;if(e<=t[0].end||i<2)r=0;else if(e>t[i-1].end)r=i-1;else for(var s=1;s<i;s++)if(e>t[s-1].end&&e<=t[s].end){r=s;break}return r},rK.getOffsetCurrentTime=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,r=-1;if((r=i>=0&&i<t.length?i:rK.getIndexByTime(e,t))<0)return -1;var s=t.length,n=t[r],a=n.start,o=n.end,l=n.cTime,h=n.offset;return e<a?l:e>=a&&e<=o?e-h:e>o&&r>=s-1?o-h:-1};var rY=/(Android)\s([\d.]+)/,rX=/(Version)\/([\d.]+)/,rQ=["avc1.42E01E, mp4a.40.2","avc1.58A01E, mp4a.40.2","avc1.4D401E, mp4a.40.2","avc1.64001E, mp4a.40.2","avc1.42E01E","mp4v.20.8","mp4v.20.8, mp4a.40.2","mp4v.20.240, mp4a.40.2"],rJ={get device(){return rJ.os.isPc?"pc":"mobile"},get browser(){if(typeof navigator>"u")return"";var rZ=navigator.userAgent.toLowerCase(),r0={ie:/rv:([\d.]+)\) like gecko/,firefox:/firefox\/([\d.]+)/,chrome:/chrome\/([\d.]+)/,opera:/opera.([\d.]+)/,safari:/version\/([\d.]+).*safari/};return[].concat(Object.keys(r0).filter(function(e){return r0[e].test(rZ)}))[0]},get os(){if(typeof navigator>"u")return{};var r1=navigator.userAgent,r2=/(?:Windows Phone)/.test(r1),r4=/(?:SymbianOS)/.test(r1)||r2,r8=/(?:Android)/.test(r1),r5=/(?:Firefox)/.test(r1),r3=/(?:iPad|PlayBook)/.test(r1)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1,r6=r3||r8&&!/(?:Mobile)/.test(r1)||r5&&/(?:Tablet)/.test(r1),r9=/(?:iPhone)/.test(r1)&&!r6;return{isTablet:r6,isPhone:r9,isIpad:r3,isIos:r9||r3,isAndroid:r8,isPc:!r9&&!r8&&!r4&&!r6,isSymbian:r4,isWindowsPhone:r2,isFireFox:r5}},get osVersion(){if(typeof navigator>"u")return 0;var r7=navigator.userAgent,se="",st=(se=/(?:iPhone)|(?:iPad|PlayBook)/.test(r7)?rX:rY)?se.exec(r7):[];if(st&&st.length>=3){var si=st[2].split(".");return si.length>0?parseInt(si[0]):0}return 0},get isWeixin(){if(typeof navigator>"u")return!1;return!!/(micromessenger)\/([\d.]+)/.exec(navigator.userAgent.toLocaleLowerCase())},isSupportMP4:function(){var e={isSupport:!1,mime:""};if(typeof document>"u")return e;if(this.supportResult)return this.supportResult;var t=document.createElement("video");return"function"==typeof t.canPlayType&&rQ.map(function(i){"probably"===t.canPlayType('video/mp4; codecs="'.concat(i,'"'))&&(e.isSupport=!0,e.mime+="||".concat(i))}),this.supportResult=e,t=null,e},isMSESupport:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:'video/mp4; codecs="avc1.42E01E,mp4a.40.2"';if(typeof MediaSource>"u"||!MediaSource)return!1;try{return MediaSource.isTypeSupported(e)}catch(t){return this._logger.error(e,t),!1}},isHevcSupported:function(){return!(typeof MediaSource>"u")&&!!MediaSource.isTypeSupported&&(MediaSource.isTypeSupported('video/mp4;codecs="hev1.1.6.L120.90"')||MediaSource.isTypeSupported('video/mp4;codecs="hev1.2.4.L120.90"')||MediaSource.isTypeSupported('video/mp4;codecs="hev1.3.E.L120.90"')||MediaSource.isTypeSupported('video/mp4;codecs="hev1.4.10.L120.90"'))},probeConfigSupported:function(e){var t={supported:!1,smooth:!1,powerEfficient:!1};if(!e||typeof navigator>"u")return Promise.resolve(t);if(navigator.mediaCapabilities&&navigator.mediaCapabilities.decodingInfo)return navigator.mediaCapabilities.decodingInfo(e);var i=e.video||{},r=e.audio||{};try{var s=MediaSource.isTypeSupported(i.contentType),n=MediaSource.isTypeSupported(r.contentType);return Promise.resolve({supported:s&&n,smooth:!1,powerEfficient:!1})}catch{return Promise.resolve(t)}}},sr="3.0.30",ss={1:5101,2:5102,3:5103,4:5104,5:5105,6:5106},sn=rU(function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{errorType:"",errorCode:0,errorMessage:"",originError:"",ext:{},mediaError:null};rB(this,e);var r=t&&t.i18n?t.i18n.ERROR_TYPES:null;if(t.media){var s=i.mediaError?i.mediaError:t.media.error||{},n=t.duration,a=t.currentTime,o=t.ended,l=t.src,h=t.currentSrc,d=t.media,u=d.readyState,c=d.networkState,p=i.errorCode||s.code;ss[p]&&(p=ss[p]);var f={playerVersion:sr,currentTime:a,duration:n,ended:o,readyState:u,networkState:c,src:l||h,errorType:i.errorType,errorCode:p,message:i.errorMessage||s.message,mediaError:s,originError:i.originError?i.originError.stack:"",host:rK.getHostFromUrl(l||h)};return i.ext&&Object.keys(i.ext).map(function(e){f[e]=i.ext[e]}),f}if(arguments.length>1){for(var m={playerVersion:sr,domain:document.domain},g=["errorType","currentTime","duration","networkState","readyState","src","currentSrc","ended","errd","errorCode","mediaError"],_=0;_<arguments.length;_++)m[g[_]]=arguments[_];return m.ex=r?(r[arguments[0]]||{}).msg:"",m}}),sa="loadeddata",so="loadstart",sl="definition_change",sh="after_definition_change";function sd(e,t,i){for(var r=arguments.length,s=Array(r>3?r-3:0),n=3;n<r;n++)s[n-3]=arguments[n];var a=t.call.apply(t,[e].concat(s));i&&"function"==typeof i&&(a&&a.then?a.then(function(){for(var t=arguments.length,r=Array(t),s=0;s<t;s++)r[s]=arguments[s];i.call.apply(i,[e].concat(r))}):i.call.apply(i,[e].concat(s)))}function su(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{pre:null,next:null};return this.__hooks||(this.__hooks={}),this.__hooks[e]||(this.__hooks[e]=null),(function(){var r=arguments,s=this;if(i.pre)try{(n=i.pre).call.apply(n,[this].concat(Array.prototype.slice.call(arguments)))}catch(t){throw t.message="[pluginName: ".concat(this.pluginName,":").concat(e,":pre error] >> ").concat(t.message),t}if(this.__hooks&&this.__hooks[e])try{var n,a,o=(a=this.__hooks[e]).call.apply(a,[this,this].concat(Array.prototype.slice.call(arguments)));o?o.then?o.then(function(e){!1!==e&&sd.apply(void 0,[s,t,i.next].concat(r$(r)))}).catch(function(e){throw e}):sd.apply(void 0,[this,t,i.next].concat(Array.prototype.slice.call(arguments))):void 0===o&&sd.apply(void 0,[this,t,i.next].concat(Array.prototype.slice.call(arguments)))}catch(t){throw t.message="[pluginName: ".concat(this.pluginName,":").concat(e,"] >> ").concat(t.message),t}else sd.apply(void 0,[this,t,i.next].concat(Array.prototype.slice.call(arguments)))}).bind(this)}function sc(e,t){var i=this.__hooks;if(i)return i.hasOwnProperty(e)?(i&&(i[e]=t),!0):(console.warn("has no supported hook which name [".concat(e,"]")),!1)}function sp(e,t){var i=this.__hooks;i&&delete i[e]}function sf(e,t){rW.logError("[".concat(e,"] event or callback cant be undefined or null when call ").concat(t))}var sm=rU(function e(t){rB(this,e),rK.checkIsFunction(this.beforeCreate)&&this.beforeCreate(t),function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];e.__hooks={},t&&t.map(function(t){e.__hooks[t]=null}),Object.defineProperty(e,"hooks",{get:function(){return e.__hooks&&Object.keys(e.__hooks).map(function(t){if(e.__hooks[t])return t})}})}(this),this.__args=t,this.__events={},this.__onceEvents={},this.config=t.config||{},this.player=null,this.playerConfig={},this.pluginName="",this.__init(t)},[{key:"beforeCreate",value:function(e){}},{key:"afterCreate",value:function(){}},{key:"beforePlayerInit",value:function(){}},{key:"onPluginsReady",value:function(){}},{key:"afterPlayerInit",value:function(){}},{key:"destroy",value:function(){}},{key:"__init",value:function(e){this.player=e.player,this.playerConfig=e.player&&e.player.config,this.pluginName=e.pluginName?e.pluginName.toLowerCase():this.constructor.pluginName.toLowerCase(),this.logger=e.player&&e.player.logger}},{key:"updateLang",value:function(e){e||(e=this.lang)}},{key:"lang",get:function(){return this.player.lang}},{key:"i18n",get:function(){return this.player.i18n}},{key:"i18nKeys",get:function(){return this.player.i18nKeys}},{key:"domEventType",get:function(){var e=rK.checkTouchSupport()?"touch":"mouse";return this.playerConfig&&("touch"===this.playerConfig.domEventType||"mouse"===this.playerConfig.domEventType)&&(e=this.playerConfig.domEventType),e}},{key:"on",value:function(e,t){var i=this;if(!e||!t||!this.player)return void sf(this.pluginName,"plugin.on(event, callback)");"string"==typeof e?(this.__events[e]=t,this.player.on(e,t)):Array.isArray(e)&&e.forEach(function(e){i.__events[e]=t,i.player.on(e,t)})}},{key:"once",value:function(e,t){var i=this;if(!e||!t||!this.player)return void sf(this.pluginName,"plugin.once(event, callback)");"string"==typeof e?(this.__onceEvents[e]=t,this.player.once(e,t)):Array.isArray(e)&&e.forEach(function(r){i.__onceEvents[r]=t,i.player.once(e,t)})}},{key:"off",value:function(e,t){var i=this;if(!e||!t||!this.player)return void sf(this.pluginName,"plugin.off(event, callback)");"string"==typeof e?(delete this.__events[e],this.player.off(e,t)):Array.isArray(e)&&e.forEach(function(r){delete i.__events[e],i.player.off(r,t)})}},{key:"offAll",value:function(){var e=this;["__events","__onceEvents"].forEach(function(t){Object.keys(e[t]).forEach(function(i){e[t][i]&&e.off(i,e[t][i]),i&&delete e[t][i]})}),this.__events={},this.__onceEvents={}}},{key:"emit",value:function(e){var t;if(this.player){for(var i=arguments.length,r=Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];(t=this.player).emit.apply(t,[e].concat(r))}}},{key:"emitUserAction",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this.player){var r=rV(rV({},i),{},{pluginName:this.pluginName});this.player.emitUserAction(e,t,r)}}},{key:"hook",value:function(e,t){return su.call.apply(su,[this].concat(Array.prototype.slice.call(arguments)))}},{key:"useHooks",value:function(e,t){for(var i=arguments.length,r=Array(i>2?i-2:0),s=2;s<i;s++)r[s-2]=arguments[s];return sc.call.apply(sc,[this].concat(Array.prototype.slice.call(arguments)))}},{key:"removeHooks",value:function(e,t){for(var i=arguments.length,r=Array(i>2?i-2:0),s=2;s<i;s++)r[s-2]=arguments[s];return sp.call.apply(sp,[this].concat(Array.prototype.slice.call(arguments)))}},{key:"registerPlugin",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";if(this.player)return i&&(t.pluginName=i),this.player.registerPlugin({plugin:e,options:t})}},{key:"getPlugin",value:function(e){return this.player?this.player.getPlugin(e):null}},{key:"__destroy",value:function(){var e=this,t=this.player,i=this.pluginName;this.offAll(),rK.clearAllTimers(this),rK.checkIsFunction(this.destroy)&&this.destroy(),["player","playerConfig","pluginName","logger","__args","__hooks"].map(function(t){e[t]=null}),t.unRegisterPlugin(i),this.__hooks=null}}],[{key:"defineGetterOrSetter",value:function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&Object.defineProperty(e,i,t[i])}},{key:"defaultConfig",get:function(){return{}}},{key:"pluginName",get:function(){return"pluginName"}}]);class sg{constructor(e){rO(this,"onTick",e=>{this&&(this.cancelPending&&this.cancelPending(),this.alive&&(this.onTick_&&this.onTick_(),e&&e()))}),this.onTick_=e,this.timeoutId=null,this.alive=!0}tickAfter(e,t=null){return this.cancelPending?this.cancelPending():this.cancelPending=()=>{clearTimeout(this.timeoutId),this.timeoutId=null},this.alive=!0,this.timeoutId=setTimeout(this.onTick,1e3*e,t),this}tickEvery(e){this.tickAfter(e,()=>{this.tickEvery(e)})}stop(){this.alive=!1,this.cancelPending&&(this.cancelPending(),this.cancelPending=null)}}class s_ extends eA.EventEmitter{constructor(e){super(),this.masterTimer=void 0,this.onVisibleChange=()=>{let e=this.masterTimer||this.workerTimer;this.stop(),e&&this.start()},this.options=e,document.addEventListener("visibilitychange",this.onVisibleChange)}start(){let{frequency:e}=this.options,t=()=>{try{(this.masterTimer||this.workerTimer)&&this.emit(iE)}catch{}};this.stop(),this.masterTimer=new sg(t),this.masterTimer.tickEvery(e)}stop(){this.workerTimer&&(this.workerTimer=void 0),this.masterTimer&&(this.masterTimer.stop(),this.masterTimer=void 0)}destroy(){this.removeAllListeners(),document.removeEventListener("visibilitychange",this.onVisibleChange),this.stop()}}let sv="DESTROYED",sy="xglog_cache",sA="degrade",sT="fps_stuck",sb=null,sS=null,sE=null,sk=null,sP=null,sw=0,sx=null;class sC extends sm{constructor(e){var t,i;super(e),rO(this,"_onChangeConfig",e=>{if(e){let t=e.nextBufferLength===this.config.minBufferLength;if(this.setConfig(e),e.nextBufferLength&&!t)try{this._onTimeUpdate()}catch{}}}),rO(this,"fpsStuckHandle",e=>{let{player:t,mse:i}=this;if(this.fpsStuckTime||(this.fpsStuckTime=e.currentTime,this.log(ev.f.LOG,"fpsStuckHandle, currentTime,",e.currentTime)),this.fpsStuckTime>0){let e=t.bufferedPoint;i.clearOpQueues(ey.Ub.VIDEO),this.log(ev.f.LOG,"fpsStuckHandle, remove,",e.start,"-",e.end,",seekTime,",this.fpsStuckTime),null==i||i.remove(ey.Ub.VIDEO,e.start,e.end).then(()=>{t.currentTime=this.fpsStuckTime,this.fpsStuckTime=null})}}),rO(this,"_retryHook",()=>{let{player:e,playerConfig:t}=this,{paused:i}=e;this.softDecode?e.vtype="MP4_MSE_SOFT":e.vtype="MP4_MSE",this._defInited=!1;let r=e.currentTime||0;this.log(ev.f.LOG,"retryHook ",t.vid,this.codecType,r);let s=()=>{r&&(e.currentTime=r,this.log(ev.f.LOG,"retryHook update currentTime",t.vid,this.codecType,r)),i?e.pause():e.play(),this._removeMetaDataEvent()};return this._addMetaDataEvent(s),this.destroyMSE(),this._reset(),this.playerStartInit(t.url),!1}),rO(this,"_playHook",(e,...t)=>{this._usePaused=!1,this._canceLoading=!1,this.log(ev.f.LOG,"playHook"),this._startProgress()}),rO(this,"_pauseHook",(e,...t)=>{var i;this._usePaused=!0,this.log(ev.f.LOG,"pauseHook",t[0],null==(i=this.player)?void 0:i.currentTime),0>t.indexOf(null==iS?void 0:iS.BUFFER_CONTROLS)&&(clearTimeout(this.checkResumePlayTimer),this.checkResumePlayTimer=null,this.log(ev.f.LOG,"pause hook clear buffer_control state")),this._loadStuckCheck()}),rO(this,"abrSwitchURL",async e=>{let{playerConfig:t}=this,i=t.definition.list,r=0;for(let t=0;t<i.length;t++)if(e.definition===i[t].definition){r=t;break}let s=this.player.curDefinition;this.changeDefinition(i[r],s,!0)}),rO(this,"timerHandle",()=>{this._requestTimer&&this._onTimeUpdate()}),rO(this,"changeDefineCanPlay",(e,t,i,r)=>{let{player:s}=this;if(s.ended){s.currentTime=0;return}let{_changeDefState:n}=this;s.currentTime=n?n.currentTime:e,(n?n.paused:t)?s.pause():s.play(),this._changeDefState=null,s.emit(sh,{from:i,to:r})}),rO(this,"changeDefinition",(e,t,i)=>{var r,s;let{player:n,playerConfig:a,mp4:o,config:l}=this;if(t||(t=n.curDefinition),this._MSEError=!1,this._isReceiveEndedEvent=!1,this.useVideoLoad){"__auto__"===e.url&&(e.url=a.definition.list[0].url),sE.call(this.player,e,t);return}let{definitionList:h}=n,d=h.filter(t=>t.definition===e.definition);d.length>0&&(e=d[0]);let u=this._handlerUrl(e.url);if(!u)return;if(l._mainURL=u.main,l._backupURL=u.backup,e._mainURL=l._mainURL,e._backupURL=l._backupURL,l.switchBitRateWay&&!i)return void this.oldChangeDefinition(e,t);let c="\u81EA\u52A8"===e.definition||"auto"===e.definition;if(i)this.log(ev.f.LOG,"[switchBitrate:ABR], ready to switch bitRate, ",e.bitrate,e.definition);else{let i=!1;if(c)this._abrService&&this._abrService.enable(),i=!0;else{this._abrService&&this._abrService.disable();let i=null==(r=a.definition)?void 0:r.list;if(i&&(!e.bitrate||!e.uri||!e.size||!e.duration)){for(let r=0;r<i.length;r++)if(e.definition===i[r].definition){e.bitrate=i[r].bitrate,e.uri=i[r].uri||t.uri,e.size=i[r].size||iW(e.bitrate,a.duration),e.duration=i[r].duration||this.playerConfig.duration;break}}}null==(s=this.adaptRange)||s.updateBitrate(e.bitrate),n.emit(sl,{from:t,to:e}),setTimeout(()=>{this._abrService&&this._abrService.updateAutoDefiDesc(n.curDefinition.definition,!c)}),i&&(e=n.curDefinition),this.log(ev.f.LOG,"[switchBitrate:CBS],switch bitRate, ",e.bitrate,e.definition)}if(n.curDefinition=e,this.mp4.clearPCDNNodeList(),this.checkPCDN(),!o)return;["keyValue","kid","secretKey","drm","getLicenseUrl","drmKeyToken","sessionId"].forEach(t=>{l[t]=e[t]});let p=null;i8(this.config)?(this._initSecret(),p=this._secretkey.getLicenseSecret()):(p=new rT).resolve(),p.then(async r=>{var s;null!=r&&r.secretKey&&(l.keyValue||(l.secretKey=r.secretKey),l.decryptKey=r.decryptKey),a.url=e.url;let h=0,d=!1;if(this._abrService&&this._abrService.isCurrentInAbr()){let e=n.getBufferedRange(n.buffered2);(h=e[1])<n.currentTime&&(h=n.currentTime,this.log(ev.f.LOG,"abr,bufferRange is invalid, adjust",e,",timeStart,",h))}else h=n.currentTime,d=!0;let u=o.getFragmentIdx(h),c=this.getAdaptTimeRangeIdx(u);c<0&&(c=this._curLoadSegmentIdx),this.log(ev.f.LOG,`switchBitrate point: ${c}`,`startTime: ${o.adaptTimeRange[c].startTime}`,`currentTime: ${n.currentTime}, timeStart: ${h}`),d&&n.emit("definitionSwitchTime",o.adaptTimeRange[c].startTime+1);let p=Math.max(o.adaptTimeRange[c].startTime,n.currentTime);this._definitionChangePointInfo={changeStartTime:p,changeInfo:{from:t,to:e}},this.changeState("changeDefinition",{abr:i,fragIndex:c,startTime:o.adaptTimeRange[c].startTime,currentTime:n.currentTime}),o&&(o.updateChangeBitRateTime(h),this.canDownload=!1,await o.cancelLoading(),o.metaLoading&&(o.metaLoading=!1)),this._removeBuffeEndTime=o.adaptTimeRange[c].startTime,this._isChangeDefinition=!0;let f=n.getBufferedRange(n.buffered),m=null==(s=this._abrService)?void 0:s.isCurrentInAbr();f[1]>0&&f[1]-n.currentTime>5&&(!this._abrService||!m)&&(this.mse.clearOpQueues(ey.Ub.VIDEO),this.removeBuffer(ey.Ub.VIDEO,n.currentTime+5,f[1])),this.log(ev.f.LOG,"switchBitrate: resetFragmentLoadState,",c),o.resetFragmentLoadState(c),this._curLoadSegmentIdx=c,await this.mp4.changeBitRate(e),this._setCurrentDefinition(e.bitrate),this._emitDefinitionChangeDetailEvent(h),this.canDownload=!0,this._onTimeUpdate();let g={width:e.width||e.vwidth,height:e.height||e.vheight};n.emit("RESOLUTION_UPDATE",g)}).catch(t=>{this.log(ev.f.ERROR,"switchBitrate: GET_LICENSE_ERROR,",null==t?void 0:t.message);let i=new sn(this.player,{errorType:iL.DRM,errorCode:iC.drm,errorMessage:(null==t?void 0:t.message)||"GET_LICENSE_ERROR",vid:a.vid});t.errorType="GET_LICENSE_ERROR",this.emit("GET_LICENSE_ERROR",i),this.changeState("LICENSE_ERROR",{d:e.definition})})}),rO(this,"_onVideoError",e=>{var t,i,r,s;let{player:n}=this;this.changeState("video_error",{code:e.code||(null==(i=null==(t=null==n?void 0:n.video)?void 0:t.error)?void 0:i.code),message:e.message||(null==(s=null==(r=null==n?void 0:n.video)?void 0:r.error)?void 0:s.message),videoType:this.useVideoLoad})}),rO(this,"removeBuffer",(e,t,i,r)=>{var s;let n=this.getBufferDur();null==(s=this.mse)||s.remove(e,t,i).then(()=>{let e=n-this.getBufferDur();e>0&&(this.emit("removeBuffer",{removeDur:e}),this.log(ev.f.LOG,"removeBuffer dur,",e)),r&&r()})}),rO(this,"_onPause",()=>{this._loadStuckCheck()}),rO(this,"_onPlaying",()=>{var e,t;this.changeState("playing",{curtime:this.player.currentTime,buffer:JSON.stringify(null==(t=null==(e=this.player)?void 0:e.buffered2)?void 0:t.bufferedList)}),this._waitAdjustTimeCnt>0&&this._waitInBufferTimer&&(this._waitAdjustTimeCnt-=1,this.changeState("waitInBuffer_resume"),this.log(ev.f.WARN,"[waitInBuffer resume play], waitAdjustTimeCnt,",this._waitAdjustTimeCnt)),clearTimeout(this._waitInBufferTimer),this._waitInBufferTimer=null;let{mp4:i,player:r}=this,{resumePlayWaterLevel:s}=this.config;if(!i){this.checkResumePlayTimer>0&&(clearTimeout(this.checkResumePlayTimer),this.checkResumePlayTimer=null,r.isBufferControlPaused&&(r.isBufferControlPaused=!1),r.paused&&r.play());return}if(!(i&&i.meta&&i.meta.duration-r.currentTime<=s)&&(this.waitLevelStartTime<0&&(this.waitLevelStartTime=r.currentTime),this.playFlag||(this.playFlag=!0),s>0&&r.currentTime-this.waitLevelStartTime>=2)){let e=r.getBufferedRange(r.buffered2);e[1]>0&&e[1]-r.currentTime<s?(r.paused||(this.emit(i_,{type:"waiting"}),r.pause(null==iS?void 0:iS.BUFFER_CONTROLS),this.log(ev.f.LOG,"[!!!!!buffer not rich, pause],currentTime, ",r.currentTime,", bufferEnd,",e[1])),clearTimeout(this.checkResumePlayTimer),this.checkResumePlayTimer=setTimeout(this._onPlaying,s/2*1e3)):r.isBufferControlPaused&&r.paused&&(this.log(ev.f.LOG,"[!!!!!buffer rich, play],, currentTime, ",r.currentTime,", bufferEnd,",e[1]),clearTimeout(this.checkResumePlayTimer),this.checkResumePlayTimer=null,r.isBufferControlPaused=!1,this.emit(i_,{type:"playing"}),r.play())}}),rO(this,"_lowDecoder",e=>{var t,i;let r=i4(this.player);this.log(ev.f.WARN,`H265 lowdecode: ${this.playerConfig.vid} `,r,", h265Degrade, ",this.config.h265Degrade),this.config.h265Degrade&&this._onDegrade({errorCode:null==(t=null==e?void 0:e.detail)?void 0:t.code,errorMessage:null==(i=null==e?void 0:e.detail)?void 0:i.message,...e.detail})}),rO(this,"_onError",e=>{this._onDegrade(e)}),rO(this,"_onDegrade",(e,t=!1)=>{var i;let{player:r,playerConfig:s,config:n}=this;i2(r,"warning",this._onDegrade),i2(r,"error",this._onError),null==(i=this.mp4)||i.destroy();let{currentTime:a}=r;this.log(ev.f.WARN,"[h265 degrade], vid,",s.vid,",currtime,",a);let o=(null==e?void 0:e.errorCode)||-1;if(this.emit(sA,{errorCode:o,errorMessage:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),codecType:this.codecType,mediaType:s.mediaType,passive:+!!t,isSoftWareDecodeError:o>1e4}),null!=n&&n.H264Config){let{H264Config:e}=n;["drm","getLicenseUrl","kid","keyValue","secretKey","isEncrypt","useEME"].forEach(t=>{n[t]=e[t]||null})}let l=(null==s?void 0:s.H264DefinitionList)||[];if(l.length>0){s.definition.list=l,s.url=l[0].url,s.defaultBitrate=l[0].bitrate,s.defaultDefinition=l[0].definition,this.config.needPreloadCheck=!0,this.isH265DegradeH264=!0,r.playNext({mp4encryptplayer:n,mediaType:"video",codecType:ik},!1);let e=()=>{r.currentTime=a,this.isH265DegradeH264=!1,this.log(ev.f.LOG,"H265DegradeH264 update currentTime",a),this._removeMetaDataEvent()};this._addMetaDataEvent(e)}else r.pause(),this._reset(),this.checkReUseMSE(!1),this.log(ev.f.ERROR,"H265 error,degrade h264 but no h264 url"),this.emit("error",e)}),rO(this,"_onMp4MetaReady",e=>{var t,i;if(!this.mp4)return;let r=this.firstFrameTime;r.metaload=this.mp4.firstFrameTime.metaload,r.bitrate=this.player.curDefinition.bitrate;let s=this._checkMetaInfo(e);if(this.emit(re,{...e,error:s,timeRange:(null==(t=this.mp4)?void 0:t.timeRange)||[]}),s)return void this._errorHandler(s);try{this._initEME(this.mp4,e),this.softDecode?(this.log(ev.f.LOG,"initH265MseProxy"),this._initH265MseProxy()):this.player.video instanceof HTMLVideoElement&&(this.log(ev.f.LOG,"initMse"),this._initMse(e)),null==(i=this._initPromise)||i.resolve()}catch(e){this._errorHandler(new sn(this.player,{errorType:iL.MEDIA,errorCode:iC.eme_hijack,errorMessage:(null==e?void 0:e.message)||"eme or mse catch err",vid:this.playerConfig.vid}));return}if(this.mp4&&this.mp4.timeRange){let e=[];this.mp4.timeRange.every(t=>(e.push({startTime:t.startTime,endTime:t.endTime}),!0)),this.emit("KEYFRAMETIME",e)}this._loadData()}),rO(this,"_onMp4Error",async(e,t)=>{let{vid:i}=this.playerConfig;console.error("[Index] _onMp4Error",i,e),this.changeState("MP4_ERROR",{state:t,errmsg:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),errorType:null==e?void 0:e.errorType,code:null==e?void 0:e.errorCode,httpCode:null==e?void 0:e.httpCode}),this._errorHandler(e)}),rO(this,"_onMp4Progress",e=>{this.emit("progress_event",e)}),rO(this,"_onMp4DataCallBack",()=>{this._isMseInit&&this._onTimeUpdate()}),rO(this,"_updateDrmConfig",e=>{let{config:t,mp4:i}=this;i.updateSecretKey(t.useEME,t.secretKey,t.decryptKey,t.keyValue),this._secretkey&&e.kid&&this._secretkey.updateKid(e.kid)}),rO(this,"_updateMSE",e=>{let{player:t}=this;t.video instanceof HTMLVideoElement&&(this.log(ev.f.LOG,"updateMse",e.videoCodec),this._initMse(e))}),rO(this,"_onVideoTimeUpdate",()=>{var e,t;let{mse:i,player:r}=this;this.waitLevelStartTime<0&&(this.waitLevelStartTime=r.currentTime),this.checkReStartTimer(),this._isEnded(),r.isSeeking&&(r.isSeeking=!1),!this.useVideoLoad&&i&&this._removeBuffeEndTime>0&&r.currentTime>this._removeBuffeEndTime+1&&(this.log(ev.f.LOG,"remove old bitrate buffer",this._removeBuffeEndTime),this.removeBuffer(ey.Ub.VIDEO,0,this._removeBuffeEndTime-1),this._removeBuffeEndTime=0);let s=this._definitionChangePointInfo;if(s&&r.currentTime>s.changeStartTime){r.emit(sh,s.changeInfo);let i=s.changeInfo||{};this.log(ev.f.LOG,sh,", currentTime,",r.currentTime,",from ",null==(e=null==i?void 0:i.from)?void 0:e.definition," to ",null==(t=null==i?void 0:i.to)?void 0:t.definition),this._definitionChangePointInfo=null}this.useVideoLoad||null!==this._requestTimer||this._offineLine||this._canceLoading||this._startProgress()}),rO(this,"_onBufferedReset",()=>{this.mp4&&this.mp4.videoTrak&&this.mp4.resetFragmentLoadState(0)}),rO(this,"_onOnlineHandler",()=>{this._offineLine=!1;let{playerConfig:e,player:t}=this,{currentTime:i,paused:r}=t;if(this.log(ev.f.LOG,"online useVideoLoad:",this.useVideoLoad,this._hasStartProgressBack),this.useVideoLoad){let s=()=>{i&&(t.currentTime=i),this.log(ev.f.LOG,"onOnlineHandler update currentTime",e.vid,this.codecType,this._currentTime),r?t.pause():t.play(),this._removeMetaDataEvent()};this._addMetaDataEvent(s),this._setPlayerSrc(e.url)}else this._hasStartProgressBack&&this._startProgress(),this._hasStartProgressBack=!1}),rO(this,"_onOfflineHandler",()=>{this._offineLine=!0,this.log(ev.f.LOG,"offline, ",this._hasStartProgress),this._hasStartProgress&&(this._stopProgress(),this._hasStartProgressBack=!0)}),rO(this,"_loadDataSuccess",e=>{var t,i,r;if(this.isDestroy||!this.mse&&!this.mseProxy)return;let s=this.firstFrameTime;if(s.startload_stmux<0){let{startMuxTime:e,firstmux:t}=this.mp4.firstFrameTime;s.startload_stmux=e,s.firstmux=t}s.loadst_loadeddata<0&&(s.loaddata=ij()-this.loadstart);try{e.initSeg&&(this._appendInitSeg(e.initSeg),(!e.buffer||e.buffer.byteLength<1)&&this._onTimeUpdate());let{buffer:s,state:n,context:a,videoTrack:o,audioTrack:l}=e;this.debugInfo.loadIndx=a?a.fragIndex:-1;let h=null==(r=null==(i=null==(t=this.mp4)?void 0:t.adaptTimeRange[a.fragIndex])?void 0:i.timeRangeIdx)?void 0:r[1];if(this.mse&&n&&(!s||s.byteLength<=0)&&h>=this.mp4.timeRange.length){let{buffered:e}=this.player;e&&(null==e?void 0:e.length)>0&&(this.bufferEndTime=e.end(e.length-1)),this._isEnded(),this.log(ev.f.LOG,"loaded ended !!!==>>>",JSON.stringify(a.range),", fragIndex,",a.fragIndex,", bufferEndTime,",this.bufferEndTime,",meta_duration,",this.mp4.meta.duration)}if(s&&this.mse){if(s&&s.byteLength>0){this._appendBuffer(ey.Ub.VIDEO,s,a,n);let e=this.getDataBitRate(a.fragIndex);this.player.emit("addVideoBufferEnd",{start:Math.floor(a.startPts),end:a.endPts,bandwidth:e.bitrate})}}else this.mseProxy&&(o&&o.samples.length>0||l&&l.samples.length>0)&&(this.log(ev.f.LOG,"[livevideo] append,index,",a.fragIndex,",range,",JSON.stringify(e.context.range),", timeRange,",a.timeRange),this.mseProxy.appendBuffer(o,l))}catch(t){this.changeState("APPEND_DATA_ERROR",{errMsg:null==t?void 0:t.message});let e=new sn(this.player,{errorType:iL.MEDIA,errorCode:iC.mseAppend,vid:this.playerConfig.vid,errorMessage:t.message,mediaError:{code:iC.mseAppend,message:t.message}});this._errorHandler(e)}null!=e&&e.state&&this._onTimeUpdate()}),rO(this,"_onResumePlaying",()=>{this._resumePlay=!0}),rO(this,"_seekOnce",e=>{let{player:t}=this;t&&(t.currentTime=e+.1*Math.pow(2,this._currentSeekTimes||0),this._currentSeekTimes++,this.log(ev.f.LOG,`\u{5F53}\u{524D}\u{7B2C}${this._currentSeekTimes}\u{6B21}Seek\u{FF0C}currentTime=${null==t?void 0:t.currentTime}`))}),rO(this,"_onWaiting",()=>{var e,t,i;this.checkReStartTimer(),this._isEnded();let r=null==(t=null==(e=this.player)?void 0:e.buffered2)?void 0:t.bufferedList;this.changeState("waiting",{curtime:this.player.currentTime,buffer:JSON.stringify(r)});let{player:s,config:n,playerConfig:a,mp4:o}=this;clearTimeout(this._waitInBufferTimer),this._waitInBufferTimer=null;let l=s.currentTime;this.log(ev.f.LOG,",[onWaiting],curTime, ",l,",buffer,",JSON.stringify(r),",dur,",null==(i=null==o?void 0:o.meta)?void 0:i.duration);let h=s.bufferedPoint;h.end>0&&h.end-l>=2?this._waitAdjustTimeCnt<n.waitJampBufferMaxCnt?this._waitInBufferTimer=setTimeout(()=>{this._waitAdjustTimeCnt++,this.changeState("waitInBuffer_seek",{waitAdjustTimeCnt:this._waitAdjustTimeCnt,curTime:l}),s.currentTime=s.currentTime+.5},n.waitingInBufferTimeOut):this._errorHandler(new sn(this.player,{errorType:iL.RUNTIME,errorCode:iC.waitTimeout,errorMessage:"onWaitTimeout_in_buffer",vid:a.vid})):this._loadStuckCheck()}),rO(this,"_onEnded",()=>{this.log(ev.f.LOG,"[player.onEnded], stopProgress"),this._stopProgress()}),rO(this,"_errorHandler",e=>{let{player:t,playerConfig:i,preLoadData:r}=this;if(!t||this.useVideoLoad)return;if(e.errorCode===iC["403"]&&this._emitExpireEvent(e)&&this.config.urlExpireDisableErrorEvent){this.log(ev.f.LOG,"_errorHandler urlExpireDisableErrorEvent",this.config.urlExpireDisableErrorEvent,",errorCode,",e.errorCode),this._stopProgress(),this.emit(sy);return}if("object"!=typeof e){let t={};t.err=e,e=t}e.ext||(e.ext={});let s=t.paused;if(e.ext.vid=i.vid,e.ext.preloadHit=+!!this.hitpreload,e.ext.preloadCached=r?r.duration:0,e.ext.timerStep=Math.max(...this.timerStepList),e.ext.codectype=this.codecType,e.errorMessage=e.message,e=new sn(t,e),this.log(ev.f.ERROR,"_errorHandle",`preState is ${s}`,null==e?void 0:e.errorCode,(null==e?void 0:e.message)||(null==e?void 0:e.errorMessage)),e.url||(e.url=t.src),e.errd&&"object"==typeof e.errd&&this.mp4&&(e.errd.url=this.mp4.url,e.url=this.mp4.url),this.player.emit("playCatch",this.player.vtype,e),this.emit("DATA_REPORT",e),this.mp4&&this.mp4.cancelLoading(),this._abrService&&this._abrService.disable(),this.canDownload=!1,this.mp4&&this.mp4.bufferCache&&this.mp4.bufferCache.clear(),this.checkIsDegraded(e))this.player.vtype="MP4_2",this._initPromise&&this.removeAndRejectInitPromise(e),this.startDegradedPlayback(e,s);else{this.log(ev.f.ERROR,"final error !!!!, ",i.vid,null==e?void 0:e.errorCode,(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message)),this.player.pause(),this._reset();let{currentTime:r}=t;this.destroyMSE(),t.currentTime=r,this.emit("error",e)}this.emit(sy)}),rO(this,"_onSeeking",async()=>{var e,t,i;if(this._isReceiveEndedEvent=!1,this.useVideoLoad)return;let{player:r,mp4:s}=this;this.waitLevelStartTime=r.currentTime;let n=r.currentTime;if(this.changeState("seeking",{curTime:n}),this.log(ev.f.LOG,"[seeking], curTime,",n,",buffer,",JSON.stringify(r.buffered2.bufferedList)),!s||!s.meta)return;this._startProgress(),this.endofstream=!1,s.bufferUsedPos=0,s.metaLoading=!1,this._definitionChangePointInfo&&(this._definitionChangePointInfo.changeStartTime=n,this.log("[seeking update definitionChangePointInfo.changeStartTime]",n)),s.changeBitRateTime>0&&(s.updateChangeBitRateTime(n),this.log("[seeking update changeBitRateTime]",n));let a=r.bufferedPoint,o=!1,l=0;if(a.end>0){if(o=!0,s.meta.duration-a.end<.5)return void this.log("[seeking in buffered range], buffer end,",a.end,", duration,",null==(e=null==s?void 0:s.meta)?void 0:e.duration);let t=s.getFragmentIdx(a.end);l=this.getAdaptTimeRangeIdx(t),s.seekTime=a.end,l<0&&(l=this._curLoadSegmentIdx),this.log(ev.f.LOG,"[seeking in buffered range], seekTime ",n,",bufferRange,",a.start,"-",a.end,", fragIndex,",l)}if(!o){s.seekTime=n;let e=s.getFragmentIdx(n);l=this.getAdaptTimeRangeIdx(e),this.log(ev.f.LOG,"[seekTime out buffer range], srcFragIndex,",e,", fragIndex,",l),l<0&&(l=this._curLoadSegmentIdx),this.log(ev.f.LOG,"[seekTime out buffer range], curTime,",n,", srcFragIndex,",e,", adaptIdx,",l);let{mse:t}=this;if(t&&null!=t&&t.isFull()){let e=r.buffered2.bufferedList,t=e[e.length-1];this._checkRemoveSourceBuffer([t.start,t.end],r.currentTime,!0,!0)}}if(this._curLoadSegmentIdx===l&&null!=(t=s.adaptTimeRange[l])&&t.isLoading)return void this.log(ev.f.LOG,"[seeking in buffered range], seek fragIndex is current load segmentIdx",l);s.canDownload=!1,await s.cancelLoading(),s.resetFragmentLoadState(l),this.log(ev.f.LOG,"[seekTime resetFragmentLoadState],adaptIdx,",l,"mp4.seekTime",s.seekTime,JSON.stringify(s.adaptTimeRange)),null==(i=this.mse)||i.clearOpQueues(ey.Ub.VIDEO),this._curLoadSegmentIdx=l,this.canDownload=!0,this._onTimeUpdate(),this._isEnded()}),this.initLog(null==(i=null==(t=this.player.playerId)?void 0:t.toString())?void 0:i.slice(-4)),this._pendingPromises=[],this._allInitPromise=new rT,this._isInit=!1,this._isEventInit=!1,this.playerId=this.player.playerId,this.preloader=null,this.log(ev.f.LOG,"playerId",this.playerId,this.playerConfig.vid),this._useVideoLoad=!1,this.mse=null,this.mp4=null,this.eme=null,this._isMseInit=!1,this._corePromise=null,this._initPromise=null,this._hasStartProgress=!1,this._hasStartProgressBack=!1,this._curLoadSegmentIdx=0,this._abrService=null,this._checkRemoveBufferLastTime=ij(),this.playFlag=!1,this.config.resumePlayWaterLevel=Math.min(this.config.minBufferLength,this.config.resumePlayWaterLevel),this.checkResumePlayTimer=null,this._MSEError=!1,this.loadstart=-1,this._loadStartEventTime=-1,this._waitAdjustTimeCnt=0,this._waitInBufferTimer=null,this.codecType=this.playerConfig.codecType?this.playerConfig.codecType.toLowerCase():ik,this.playerConfig.vtype&&(this._vtype=this.playerConfig.vtype.toUpperCase()),this.isActive=!0,this.firstFrameTime={newplayer:ij(),initmse_sbopen:-1,mseopen:-1,metaload:-1,metaready_initsegend:-1,startload_stmux:-1,firstmux:-1,apcnt:0,aplen:0,data_ap:-1,loaded_data:-1,loadst_loadeddata:-1,new_loadeddata:-1,bitrate:-1,hitpreload:-1,first_gop_req_cnt:-1},this.debugInfo={},this.states=[],this.removeVideoList=[],this._lastCheckTime=ij(),this._lastCheckLagTime=ij(),this._changeDefState=null,this._defInited=!1,this._removeBuffeEndTime=0,this._isChangeDefinition=!1,this._lastTimeupdateTime2=0,this.waitLevelStartTime=-1,this.preLoadData=null,this.forPreloadTimeCache=null,this._usePaused=!1,this.endofstream=!1,this.bufferEndTime=-1,this.hitpreload=!1,this.isH265DegradeH264=!1,this.loadstartTimer=null,this.loadeddataTimer=null,this.canplayTimer=null,this.adaptRangeRes=[],this._isReceiveEndedEvent=!1,this._checkEndedTimer=null,this._definitionChangePointInfo=null,sP&&(this.player.preloader=sP),this._lastTimeupdateTime2=0,this.waitLevelStartTime=-1,this.timerStepList=[],window&&window.location.href.indexOf("playerInstance=true")>-1&&(void 0===window.mp4PlayerInstanceList&&(window.mp4PlayerInstanceList=[]),window.mp4PlayerInstanceList.push(void 0)),this._isH265SoftDecoder=!1,this._beforeLoadStartCostTime=0,this._requestTimer=null,this.mseEndInfo={mseEndType:0,mseEndTime:0}}static get pluginName(){return"Mp4EncryptPlayer"}static get defaultConfig(){return{onlyInit:!1,useWaterLevel:!1,maxBufferLength:10,minBufferLength:5,tickInSeconds:.2,getLicenseUrl:"",xhrSetup:{},chunkSize:209715,retryCount:1,retryDelay:1e3,timeout:3e3,needPreloadCheck:!1,needAutoBitrate:!0,keyValue:null,drm:null,switchBitRateWay:!1,enableWorker:!1,bufferThreshold:10,removeBufferLen:60,focusUserDefinition:!1,resumePlayWaterLevel:2,waitJampBufferMaxCnt:3,waitingInBufferTimeOut:5e3,waitingTimeOut:1e4,notDegradeErrorList:[],h265Degrade:!1,forceVideoPlay:!1,segmentMinDuration:3,supportHevc:void 0,H264Config:null,reqOptions:{},rangeMaxDuration:15,getRequestOptionsCallback:null,closeDowngrade:!1,loaderType:"fetch",reUseMSE:!1,urlExpireDisableErrorEvent:!1,logCacheConfig:{logCacheLevel:ev.f.LOG,logMaxSize:204800},noPreloadAddBufferLen:0,enableFPSStuckHandle:!1,loadRangeType:"gop",timerInWorker:!1}}static registerPreloader(e){sP=e}static set ENCRYPT_SECRET(e){sx=e}static get speed(){return sw}static get realTimeSpeed(){return sw}static get version(){return ix}setConfig(e){this.config=Object.assign(this.config,e)}initLog(e){let{logCacheLevel:t,logMaxSize:i}=this.config.logCacheConfig;this.logger=new ev.V(sC.pluginName+e,{logCacheLevel:t,logMaxSize:i}),iB&&ev.V.enable()}playerlogger(e){e?ev.V.enable():ev.V.disable()}afterCreate(){let{playerConfig:e,config:t,player:i}=this;t.width=e.width||0,t.height=e.height||0,e.vid=e.vid||t.vid,ey.Ub.isSupported('video/mp4; codecs="avc1.64001f, mp4a.40.5"')&&!r_()&&(void 0===t.supportHevc&&null!=rJ&&rJ.isHevcSupported&&rJ.isHevcSupported()&&this.player.video instanceof HTMLVideoElement&&(t.supportHevc=!0),t.supportVvcc=!(typeof MediaSource>"u")&&!!MediaSource.isTypeSupported&&MediaSource.isTypeSupported("video/mp4;codecs=bvc2.1.6.L93.B0"),this.softDecode?i.vtype="MP4_MSE_SOFT":i.vtype="MP4_MSE",(!rv()||this.softDecode)&&(t.useEME=!1),t.useEME=!1!==t.useEME,this.checkConfig(),t.onlyInit&&(e.autoplay=!1,e.videoInit=!1,this._hasStartProgress=!1,this._hasStartProgressBack=!1),e.useWaterLevel&&(e.userGestureEventMiddleware||(e.userGestureEventMiddleware=iQ),e.videoEventMiddleware||i.setEventsMiddleware(iJ)),this._proxyPlayer(),i.useHooks("play",this._playHook),i.useHooks("pause",this._pauseHook),i.useHooks("retry",this._retryHook),i1(i,ip.BUFFERED_RESET,this._onBufferedReset),this._bindNetworkStateChange(),this.on("timeupdate",this._onVideoTimeUpdate),this.on(sa,()=>{var e;this.changeState("LOADED_DATA"),this.deleteVideo(),this.mp4&&this.mp4.updateLoadedDataDone(),this._firstFrameTime(),this._onTimeUpdate(),this.firstFrameTime.loaded_data=this._loadStartEventTime>0?ij()-this._loadStartEventTime:-1,null!=(e=this.config)&&e.enableFPSStuckHandle&&this.on(sT,this.fpsStuckHandle)}),this.on(so,()=>{this.changeState("LOAD_START"),this._loadStartEventTime=ij(),this._beforeLoadStartCostTime=new Date().getTime()-this._tm,this.codecType!==iP||this.config.supportHevc||(this._isMseInit=!0,this._onTimeUpdate())}),this.on("ended",()=>{this.log(ev.f.LOG,"mp4plugin receive player video ended event"),this._onEnded()}),this.on("pause",()=>{this._usePaused=!0}),this.on("play",()=>{this._usePaused=!1}),this.on("xglog",e=>{if("firstFrame"===e.eventType){let t=this.preLoadData&&this.preLoadData.definition?this.preLoadData.definition:-1,{player:i,firstFrameTime:r}=this;iB&&console.log(`[xgplayer-encrypt-mp4]>>>>firstFrame ${this.playerConfig.vid}, ${e.fvt}, codecType: ${this.codecType}`,`hitPreload: ${this.hitpreload}, video: ${this._useVideoLoad}, preloadBitrate: ${t}`,` metaLoad: ${r.metaload}, mseOpen: ${r.mseopen}`,`curDefinition: ${i.curDefinition.definition},appendInit: ${r.metaready_initsegend}`)}}),i.mp4MseFlag=!0)}_startBufferCheck(){let{player:e}=this;if(!e.video)return;let t=[];if(e.video.buffered){for(let i=0,r=e.video.buffered.length;i<r;i++)t.push([e.video.buffered.start(i),e.video.buffered.end(i)]);t.toString()!==this.lastBuffer&&(this.lastBuffer=t.toString(),this._onBufferReachThreshold())}}_onBufferReachThreshold(){let{player:e,config:t}=this;if(e.video){let i=e.video.buffered,{currentTime:r}=e.video,s=0,n=0;for(let e=0;e<i.length&&(s=i.start(e),n=i.end(e),!(s<=r&&r<=n));e++);n-r>=t.bufferThreshold&&!this._hasTriggerBufferThreshold&&(this._hasTriggerBufferThreshold=!0,e.emit("BUFFER_THRESHOLD",n-r))}}_startUrlExpiredCheck(){let{definition:e}=this.playerConfig;e&&e.list&&e.list.length>0&&(this.urlExpireTimestamp=e.list[0].url_expire||0,this._handleUrlExpire())}async cancelLoading(){this.mp4&&(this._canceLoading=!0,this.log(ev.f.LOG,"player cancelLoading",this.playerConfig.vid),this._stopProgress(),this.cancelPreloadTask(),await this.mp4.cancelLoading())}checkConfig(){let{playerConfig:e,config:t}=this,i=e.defaultDefinition,r=e.defaultBitrate;if(!i){let{definition:e}=this.playerConfig;i=e&&e.defaultDefinition?e.defaultDefinition:t.definition}!r&&t.bitrate&&(r=t.bitrate),e.defaultDefinition=i,e.defaultBitrate=r}_addMetaDataEvent(e){let{player:t}=this;this.__mHandler=e,i1(t,"loadedmetadata",this.__mHandler)}_removeMetaDataEvent(){if(!this.__mHandler)return;let{player:e}=this;i2(e,"loadedmetadata",this.__mHandler),this.__mHandler=null}beforePlayerInit(){let{player:e}=this,t=this;this._isInit||(sm.defineGetterOrSetter(e,{__url:{get:()=>t.mse?t.mse.url:e.config.url,configurable:!0},downloadSpeed:{get:()=>sw/8,configurable:!0},playerVersion:{get:()=>ix,configurable:!0},menuCodeType:{get:()=>t.mp4&&t.mp4.meta?t.mp4.meta.videoCodec:t.codecType===ik?"avc":"hevc",configurable:!0},playerType:{get:()=>"MP4",configurable:!0},supportMenus:{get:()=>({speed:null==e?void 0:e.mp4MseFlag,cdn:null==e?void 0:e.mp4MseFlag,resolution:null==e?void 0:e.mp4MseFlag}),configurable:!0},preloadActive:{get:()=>this.isActive,set:e=>{this.isActive=e,this.isActive&&this._startProgress()},configurable:!0},performance:{get:()=>this.firstFrameTime,configurable:!0},domain:{get:()=>t.domain,configurable:!0},loadURL:{get:()=>t.loadURL,configurable:!0},abrInstance:{get:()=>t.abrInstance,configurable:!0},pcdnReq:{get:()=>{},configurable:!0},retryInfo:{get:()=>rp,configurable:!0},softDecoder:{get:()=>this._isH265SoftDecoder,configurable:!0},logCache:{get:()=>{if(t.logger)return t.log(ev.f.LOG,`,version:${ix},timerStepList,`,JSON.stringify(this.timerStepList)),t.logger.getLogCache()},configurable:!0},pcdnVVStat:{get:()=>{var e;let{mp4:i,pcdn:r}=t;return i?{...i.pcdnVVStat,trace_id:null==(e=i.pcdnTraceInfo)?void 0:e.trace_id,cancelCnt:(null==i?void 0:i.pSCCancelCnt)||0,is_try_open:+!!r}:null},configurable:!0},beforeLoadStartCostTime:{get:()=>this.useVideoLoad?0:this._beforeLoadStartCostTime,configurable:!0},bandwidth:{get:()=>{let{mp4:e,playerConfig:i}=t,r=null==i?void 0:i.vid,s=e?e.loadInfo:null,n=s?s.cdn:null,a=s?s[iv]:null;return{vid:r,cdn:{speed:null==n?void 0:n.loadSpeed,size:n?n.loadLen:0},pcdn:{size:a?a.loadLen:0,...null==e?void 0:e.pcdnTraceInfo}}},configurable:!0},ext:{get:()=>t?function(e){var t,i;let r=[],{video:s,currentTime:n,duration:a}=e.player,{playerConfig:o,mp4:l,mse:h,debugInfo:d,_curLoadSegmentIdx:u,states:c,_requestTimer:p,timerStepList:f}=e,m=s?s.buffered:[];if(m.length>0)for(let e=0,t=(null==m?void 0:m.length)||0;e<t;e++)r.push([m.start(e),m.end(e)]);return{type:"MP4",usevideo:+!!e.useVideoLoad,curTime:n,duration:(null==(t=null==l?void 0:l.meta)?void 0:t.duration)||a,loadIdx:u,curload:null!=l&&l.adaptTimeRange?l.adaptTimeRange[u]:{},buffer:r,speed:null==d?void 0:d.speed,states:c,msequeLen:(null==h?void 0:h.opQueues)&&(null==(i=h.opQueues.video)?void 0:i.length),timer:!!p,timerlist:JSON.stringify(f),maxtimerstep:Math.max(...f),url:null==o?void 0:o.url}}(this):{},configurable:!0},currentDefitionFromPlayer:{get:()=>t.abrInstance&&t.abrInstance.isCurrentInAbr?e._currentDefitionFromPlayer:e.curDefinition,configurable:!0}}),this._isInit=!0)}destroy(){var e,t;let{player:i}=this;i.preloader&&i.preloader.cancel(this.playerId),i.removeHooks("play",this._playHook),i.removeHooks("pause",this._pauseHook),i.removeHooks("retry",this._retryHook),null==(e=this._requestTimer)||e.destroy(),this._requestTimer=null,this._reset(),this.checkReUseMSE(!1),this._secretkey&&sx.destroySecretKey(this._secretkey,this._errorHandler),this.player.playNext=sb,this.player._startInit=sS,this.player.changeDefinition=sE,this.player.switchURL=sk,this._unbindNetworkStateChange(),this._unbindEvents(),i2(i,ip.BUFFERED_RESET,this._onBufferedReset),this._bufferCheckTimer&&clearInterval(this._bufferCheckTimer),this._removeBufferTimer&&(clearTimeout(this._removeBufferTimer),this._removeBufferTimer=null),null!=(t=this.logger)&&t.reset&&this.logger.reset(),this._removeMetaDataEvent(),this.timerStepList=[]}_proxyPlayer(){"function"==typeof this.player.playNext&&(sb=this.player.playNext),this.player.playNext=(...e)=>{this.playNext(...e)},sS=this.player._startInit,sk=this.player.switchURL,sE=this.player.changeDefinition,this.player._startInit=this.playerStartInit.bind(this),this.player.switchURL=this.switchURL.bind(this),this.player.changeDefinition=this.changeDefinition.bind(this)}getInitBitrate(){let{player:e,config:t,playerConfig:i}=this,r=null,{definitionList:s}=e;if(s&&s.length>0){let{preloader:n}=e;n&&s.forEach(e=>{let t=n.generateUniqueKey({vid:i.vid,definition:e.definition||-1,vtype:i.vtype,codecType:i.codecType});e.cacheKey=t,t&&!r&&n&&n.hasItemSameVid(t)&&((r=e).type="preload")});let{userSelectDefinition:a}=i;r&&a&&t.focusUserDefinition&&i.userSelectDefinition!==r.definition&&(r=null),!r&&this.bitRateAdapter&&(this.bitRateAdapter.speed=rm.speed,(r=this.getDefinitonFromAdapter(s,a))&&(r.type="bitRateAdapter"))}if(!r||!r.url){let{url:e,definition:t,defaultDefinition:n}=i,a=(null==t?void 0:t.defaultDefinition)||n;if("Array"===iz(e)&&e.length>0||"String"===iz(e)&&e){let t=this._getDefinitionItem(a),s=i.defaultBitrate||i.bitrate||(null==t?void 0:t.bitrate);r={url:e,definition:(null==t?void 0:t.definition)||a||-1,duration:(null==t?void 0:t.duration)||i.duration||this.config.duration||0,bitrate:s,uri:i.uri||(null==t?void 0:t.uri),file_id:null==t?void 0:t.file_id,size:(null==t?void 0:t.size)||i.size,type:"default"}}else r=s[s.length-1]}return r&&(i.url=r.url,r.networkSpeed=rm.speed),e.curDefinition=r,r}_setPlayerSrc(e){let{player:t}=this;this._removeVideoSource(),"Array"===iz(e)?(t.video.removeAttribute("src"),t._detachSourceEvents||e.forEach(e=>{t.video.appendChild(i$("source","",{src:`${e.src}`,type:`${e.type||""}`}))}),t._attachSourceEvents(t.video,e)):t.video.src=e,t.play(),t.mp4MseFlag=!1,t.emit("playertypechange")}_removeVideoSource(e){let{player:t}=this,{children:i}=e=e||t.video;if(i.length>0)for(t._detachSourceEvents(e);i.length>0;)e.removeChild(i[0])}_getDefinitionItem(e){let{definition:t}=this.playerConfig;if(!t||!t.list)return null;for(let i=0;i<t.list.length;i++){let r=t.list[i];if(r.definition===e)return r}return null}async _initAbrService(){}_initSecret(){sx&&(this._secretkey?this._secretkey.updateConfig(this.config):this._secretkey=sx.createSecretKey(this.config,this._errorHandler))}_initMp4Kernel(){let{playerConfig:e,config:t}=this,i=new rT;try{let r=this.player.curDefinition;this.log(ev.f.LOG,`[_initMp4Kernel] ${e.vid} curDefinition`,null==r?void 0:r.definition);let s=this._handlerUrl(e.url);if(!s)return this.log(ev.f.LOG,"emptyUrl"),i.reject(Error("emptyUrl")),i;if(t._mainURL=s.main,t._backupURL=s.backup,t.forceVideoPlay&&(this.codecType===ik||t.supportHevc))return this.useVideoLoad=!0,this.log(ev.f.LOG,"forceVideoPlay"),i.reject(Error("forceVideoPlay")),i;let n=[];this._secretkey&&n.push(this._secretkey.getLicenseSecret()),n.push(this._checkPreloader()),Promise.all(n).then(e=>{if(this.isDestroy)return void i.reject(Error("destroy"));let s=null;if(e&&e.length>0&&(e.length>1&&(t.keyValue||(t.secretKey=e[0].secretKey),t.decryptKey=e[0].decryptKey),s=e[e.length-1].data,this.firstFrameTime&&(this.firstFrameTime.hitpreload=+!!s)),!s&&t.needPreloadCheck&&(this.codecType!==iP||t.supportHevc))this.useVideoLoad=!0,this.log(ev.f.LOG,"no_preload"),i.reject(Error("no_preload"));else if(this._vtype&&"MP3"===this._vtype)this.useVideoLoad=!0,this.log(ev.f.LOG,"vtype_not_MP4"),i.reject(Error("vtype_not_MP4"));else{let e=t._mainURL;this.player.rawSrc=e,this._initMp4(e,s,{fileSize:r?r.size:0}),this.updateLoadInfo(null==s?void 0:s.cacheKey),this.checkPCDN(),this.initAdaptRange(),this._initAbrService()}}).catch(t=>{this.log(ev.f.ERROR,"getLicense or checkPreloader reject",null==t?void 0:t.message);let s=new sn(this.player,{errorType:iL.DRM,errorCode:iC.drm,errorMessage:(null==t?void 0:t.message)||"getLicense or checkPreloader reject",vid:e.vid});this.emit("GET_LICENSE_ERROR",s),this.changeState("LICENSE_ERROR",{d:r?r.definition:0}),i.reject(s)})}catch(e){i.reject(e)}return i}updateLoadInfo(e){e&&this.mp4&&(this.mp4.loadInfo=iy.get(e),iy.delete(e))}initAdaptRange(){let{config:e,player:t,playerConfig:i}=this,{bitrate:r,duration:s}=t.curDefinition;if(null!=e&&e.adaptRange){let n=null;n=(null==e?void 0:e.loadRangeType)===ib?h:l,this.adaptRange=new n(t,r,s||i.duration,e.adaptRange)}}checkPCDN(){let{config:e,player:t,playerConfig:i}=this;t.curDefinition,this.pcdn=null}isOpenPCDN(e){}_pcdnReqSuccess(e,t){let{playerConfig:i,player:r,mp4:s}=this;if(!s||!e)return;let n=null.getPCDNReqId(r.curDefinition,i.vid);if(e.req_id&&n!==e.req_id)return void this.log(ev.f.LOG,`,${t} is not match curDefinition reqId', reqId, ', pcdnRet.req_id`,e.req_id);let a=e.nodes||[];this.log(ev.f.LOG,`${i.vid} get peer end,pcdn node update,`,a.length),s.updateNode(a),s.pcdnTraceInfo={uri:e.vid,fid:e.fid,trace_id:e.trace_id},s.pcdnVVStat&&(s.pcdnVVStat.try_req_node+=1,s.pcdnVVStat.req_node_succ+=1,s.pcdnVVStat.has_ret_node+=+(a.length>0))}_pcdnReqFail(e,t){let{mp4:i}=this;null!=i&&i.pcdnVVStat&&(i.pcdnVVStat.try_req_node+=1),this.checkURLExpired(e,t)}initTimer(){if(!this._requestTimer){let{timerInWorker:e,tickInSeconds:t}=this.config;this._requestTimer=new s_({frequency:t,timerInWorker:e}),this._requestTimer.on(iE,this.timerHandle)}}playerStartInit(e){var t;if(this.log(ev.f.LOG,"playerStartInit",this.player.hasStart,this.playerId,e),this.isDestroy)return;let{playerConfig:i,player:r}=this;if(this._usePaused=!1,this.isActive&&(null==r?void 0:r.currentTime)!==0&&!this.config.frameFreeze&&(this.log(ev.f.LOG,"[playerStartInit] reset current  = 0 ,buffer,",JSON.stringify(null==(t=null==r?void 0:r.buffered2)?void 0:t.bufferedList)),this.player.currentTime=0),this._isH265SoftDecoder=this.softDecode,this.config.reUseMSE&&this.mse&&"String"===iz(e)&&/^blob/.test(e)&&e!==this.mse.url&&(e=i.url,this.destroyMSE()),!e||"__auto__"===e||"anytext"===e){let{definition:e}=i,t=function(e){let t="",i=null,r=e?e.list:[];if(r&&r.length>0&&e.defaultDefinition&&(r.forEach(r=>{r.definition===e.defaultDefinition&&(t=r.url,i=r)}),!t)){let s=r[0];t=s.url,e.defaultDefinition=s.definition,i=s}return i}(e);t&&(i.url=t.url,e.defaultDefinition=t.definition,r.curDefinition=t)}let s=this._defInited?null:this.getInitBitrate();if(i.nullUrlStart&&!s&&!i.url)return;this.initTimer(),i8(this.config)?this._initSecret():this._secretkey=null,this._defInited=!0,this.log(ev.f.LOG,`[playerStartInit] ${i.vid} curDefinition`,s||this.player.curDefinition);let{config:n}=this,{preloader:a}=this.player;a&&a.addPlayingVid(i.vid);let o=!this.softDecode;if(n.needPreloadCheck&&o&&!this._secretkey){let e=!1,t,{curDefinition:r}=this.player;if(a&&r&&(t=r.cacheKey?r.cacheKey:a.generateUniqueKey({vid:i.vid,definition:r.definition||-1,vtype:i.vtype,codecType:i.codecType}),e=a.hasItemSameVid(t)),!e){this.useVideoLoad=!0,this.player.vtype="MP4_0",this.log(ev.f.LOG,`[playerStartInit] ${i.vid} no_preload`,!!a,t);let e=new sn(this.player,{errorType:"runtime",errorTypeCode:iL.runtime,errorCode:iC.other,vid:this.playerConfig.vid,errorMessage:"no preload"});this.player.emit("playCatch",this.player.vtype,e)}}if(this.useVideoLoad){if(e=this.playerConfig.url,n.closeDowngrade)return;this._sTime=ij(),sS.call(this.player,e),this._startProgress();return}if(this.isDestroy)return;if(this.player.mp4MseFlag=!0,this.bufferEndTime=-1,this._tm=new Date().getTime(),this._initPromise&&"pending"===this._initPromise.state){let e=this._handlerUrl(i.url);if(e&&e.main===n._mainURL)return}this._reset();let{vid:l}=this.playerConfig;this.changeState("PLAYER_START_INIT");let h=this._initMp4Kernel();this._initPromise=h,this._addPendingPromise(this._initPromise),h.then(()=>{this.isDestroy||(this.mse&&(e=this.mse.url),this.changeState("PLAY_INIT_OK"),this._bindEvents(),this._startProgress())}).catch(t=>{let i=!1;if(this._initPromise&&(i=this._initPromise.id!==h.id||this._initPromise.isBreak),this.isDestroy||i||t===sv)return;if(this.log(ev.f.LOG,`_initMp4Kernel.catch: ${l} isDestroy:${this.isDestroy},
          errorCode:${(null==t?void 0:t.errorCode)||iC.other},errMsg:${(null==t?void 0:t.errorMessage)||(null==t?void 0:t.message)}`),(null==t?void 0:t.errorCode)===iC["403"]&&this._emitExpireEvent(t)&&n.urlExpireDisableErrorEvent){this._initPromise=null,this.log(ev.f.LOG,"initMp4Kernel urlExpireDisableErrorEvent",n.urlExpireDisableErrorEvent,",errorCode,",t.errorCode),this._stopProgress(),this.emit(sy);return}let r=t;r.errorCode||((r=new sn(this.player,{errorType:iL.RUNTIME,errorCode:(null==t?void 0:t.errorCode)||iC.other,vid:this.playerConfig.vid,errorMessage:(null==t?void 0:t.errorMessage)||(null==t?void 0:t.message),mediaError:{code:(null==t?void 0:t.httpCode)||iC.other,message:(null==t?void 0:t.errorMessage)||(null==t?void 0:t.message),errorType:null==t?void 0:t.errorType}})).url=e),this.changeState("PLAY_INIT_CATCH",{c:r.errorCode,m:(null==t?void 0:t.errorMessage)||(null==t?void 0:t.message),t:null==t?void 0:t.errorType}),this.useVideoLoad=!0,this.player.vtype="MP4_1",this.player.emit("playCatch",this.player.vtype,r);let s=this.checkIsDegraded(r);if(this.log(ev.f.WARN,"PLAY_INIT_CATCH final error !!!!, ",l,null==r?void 0:r.errorCode,null==r?void 0:r.errorMessage,",degrade:",s),this.emit(sy),!s){this.player.pause(),this._reset(),this.emit("error",r),this._initPromise=null;return}}).finally(()=>{var t;if(!this._initPromise)return;let{isBreak:i,id:r}=this._initPromise;if(r!==h.id)return;this._removePendingPromise(this._initPromise),this._initPromise=null,this._usePaused&&(this.playerConfig.autoplay=!1),this.softDecode&&"Array"===iz(e)&&(e=e[0].src),"String"!==iz(e)||/^blob/.test(e)||this.config.frameFreeze||this.destroyMSE();let s=(null==(t=this.player)?void 0:t.currentSrc)===e;this.changeState("PLAY_INIT_FINALLY",{isDestroy:this.isDestroy,isBreak:i,reUseSrc:s}),this.isDestroy||i||sS.call(this.player,e),this.reUseMSEEmitEvents(s),this._abrService&&this._abrService.isCurrentInAbr()&&(this._abrService.enable(),this._abrService.execute())})}async destroyMSE(){var e;await (null==(e=this.mse)?void 0:e.unbindMedia()),this.mse&&this.log(ev.f.LOG,"destroyMSE ",this.playerConfig.vid),this.mse=null}reUseMSEEmitEvents(e){var t;e&&/^blob/.test(null==(t=this.player)?void 0:t.currentSrc)&&(clearTimeout(this.loadstartTimer),clearTimeout(this.loadeddataTimer),clearTimeout(this.canplayTimer),this.loadstartTimer=setTimeout(()=>{clearTimeout(this.loadstartTimer),this.loadstartTimer=null,this.emit(so),this.log(ev.f.LOG,"reUseMSE add emit loadstart event")},10),this.loadeddataTimer=setTimeout(()=>{clearTimeout(this.loadeddataTimer),this.loadeddataTimer=null,this.emit(sa),this.log(ev.f.LOG,"reUseMSE add emit loadeddataevent")},50),this.canplayTimer=setTimeout(()=>{clearTimeout(this.canplayTimer),this.canplayTimer=null,this.emit("canplay"),this.log(ev.f.LOG,"reUseMSE add emit canplayevent")},90))}playNext(e,t=!0){let{player:i}=this,r=!!this.isActive;r&&(e.autoplay=r),this._defInited=!1,this._hasTriggerBufferThreshold=!1,i.resetState(),i._currentTime=0,i._duration=0,i.isPlaying=!1,this.preloader&&this.preloader.clearTask(),this._useVideoLoad=!1,this._MSEError=!1;let s=this.softDecode;i.pause(),this._reset(),e.vtype&&(this._vtype=e.vtype.toUpperCase()),i.setConfig(e),this.config.frameFreeze||this.checkReUseMSE(this.config.reUseMSE,!0),this.softDecode?i.vtype="MP4_MSE_SOFT":i.vtype="MP4_MSE";let{codecType:n,mediaType:a}=this.playerConfig;if(this.codecType=n?n.toLowerCase():ik,s!==this.softDecode&&this.h265_h264_switch(a||"video"),this.checkConfig(),this.log(ev.f.LOG,"[Index] playNext",e.vtype,e.vid),i.resetState(),i.start(),i.play(),this.config.reUseMSE&&!this.isH265DegradeH264){let e=()=>{this.log(ev.f.LOG,"[Index] playNext metadata update currentTime = 0"),0!==i.currentTime&&(i.currentTime=0),this._removeMetaDataEvent()};this._addMetaDataEvent(e)}t&&this.emit("playnext")}h265_h264_switch(e){this.log(ev.f.LOG,"[Index],h265_switch_h264",e);let{player:t}=this,{mediaConfig:i}=t,r=i$(e,"",i,`xgplayer-${e}-img`),s=t.media.parentElement;this.removeVideoList.push(t.media),t.detachVideoEvents(t.media);let{muted:n,volume:a}=t.media;r.muted=n,r.volume=a,r.setAttribute("media_type","video"),t.media=r,t.attachVideoEvents(r),s.appendChild(r)}next(e){this.playNext(e)}oldChangeDefinition(e,t){let{config:i,player:r,playerConfig:s}=this;r.emit(sl,{from:t,to:e}),r.emit("waiting");let n=r.definitionList,a=n.filter(t=>t.definition===e.definition||t.definition===Number(e.definition)),o=n.filter(e=>e.definition===t.definition||e.definition===Number(t.definition));if(o.length>0&&(o[0].selected=!1),!(a.length>0))return;(e=a[0]).selected=!0,r.curDefinition=e,this.log(ev.f.LOG,"[oldChangeDefinition],currentTime,",r.currentTime,",from,",t,",to,",e);let{currentTime:l,paused:h}=r;this._changeDefState||(this._changeDefState={currentTime:l,paused:h}),i.definition=e.definition,["keyValue","kid","secretKey","drm","getLicenseUrl","drmKeyToken","sessionId"].forEach(t=>{i[t]=e[t]}),s.url=e.url,s.userSelectDefinition=e.definition,s.defaultDefinition=e.definition,i.focusUserDefinition=!0,r.currentTime=0,r.pause(),this._reset(),this.checkReUseMSE(),this._isMseInit=!1,this.eme=null;let d=this._handlerUrl(e.url);i._mainURL=d.main,i._backupURL=d.backup,this._changeDefineCanPlay&&r.off("canplay",this._changeDefineCanPlay),this._changeDefineCanPlay=()=>{this.changeDefineCanPlay(l,h,t,e),this._changeDefineCanPlay=null},r.once("canplay",this._changeDefineCanPlay),this.player.video.load(),this.playerStartInit(s.url)}_emitDefinitionChangeDetailEvent(e){let{bitrate:t,definition:i,file_id:r,width:s,vwidth:n,height:a,vheight:o}=this._currDefinition;this.player.emit("definitionChangeDetail",{start:e,bitrate:t,definition:i,mediaType:"video",url:this.config._mainURL,fileid:r}),this.player.emit("RESOLUTION_UPDATE",{width:s||n,height:a||o})}_setCurrentDefinition(e){let{config:t}=this.player;if(t.definition&&t.definition.list){let i=t.definition.list.filter(t=>t.bitrate===e);this._currDefinition=i&&i[0]}this._currDefinition||(this._currDefinition={bitrate:e}),e&&(this._currDefinition.bitrate=e)}switchURL(e){if(this.useVideoLoad)return void sk.call(this.player,e);let{player:t,playerConfig:i,config:r}=this;i.definition.list=[e],i.url=e.url,i.defaultBitrate=e.bitrate,i.defaultDefinition=e.definition,["keyValue","kid","secretKey","drm","getLicenseUrl","drmKeyToken","sessionId"].forEach(t=>{r[t]=e[t]});let s=()=>{t.currentTime=0,this._removeMetaDataEvent()};this._addMetaDataEvent(s),this.playNext(r)}_handlerUrl(e){let t,{playerConfig:i}=this;if(!e)return null;let r=[];if("String"===iz(e))t=e,i.backupURL&&r.push(i.backupURL);else if("Array"===iz(e)&&e.length>0&&(t=e[0].src,e.length>1))for(let t=1;t<e.length;t++)r.push(iG(e[t].src,{__vid:i.vid}));return(!!t||0!==r.length)&&{main:iG(t,{__vid:i.vid}),backup:r}}_firstFrameTime(){let{firstFrameTime:e,player:t,config:i,loadstart:r}=this,s={supportHevc:i.supportHevc,firstmux:this.mp4?this.mp4.firstFrameTime.firstmux:-1,stats:i4(t),loadstart:r};this.firstFrameTime=function(e,t,i={supportHevc:!1,loadstart:0,firstmux:-1,stats:{}}){var r;if(t===ik||i.supportHevc)return e.new_loadeddata<0&&(e.loadst_loadeddata=ij()-i.loadstart,e.new_loadeddata=ij()-e.newplayer),e;if(t===iP){let{stats:t,firstmux:s}=i,{metaload:n,startMuxTime:a}=e,o={};for(let e=0;e<(null==(r=null==t?void 0:t.bootStats)?void 0:r.length);e++)o[t.bootStats[e].action]=t.bootStats[e].dot;let l={...t,metaload:n,startload_stmux:a,firstmux:s,...o};return delete l.bootStats,l}}(e,this.codecType,s)}_bindEvents(){this.log(ev.f.LOG,"bindEvents,",this._isEventInit);let{config:e,player:t}=this;this._isEventInit||(this.on("seeking",this._onSeeking),this.on("waiting",this._onWaiting),this.on("error",this._onVideoError),this.on("playing",this._onPlaying),this.on("pause",this._onPause),this.on("detectGap",()=>{e.gapDegrade&&e.useEME&&(e.useEME=!1,this._replay())}),this.on(d.CHANGE_FLYING_PLUGIN_CONFIG,this._onChangeConfig),t.setEventsMiddleware({error:(e,i)=>{var r;let s=null==e?void 0:e.error,n={errorCode:null==s?void 0:s.code,errorMessage:null==s?void 0:s.message,videoType:this.useVideoLoad};if(this.changeState("video_error.Middleware",n),this.codecType===iP&&(null==s?void 0:s.message.indexOf("video decoder initialization failed"))>=0&&this.emit("DECODER_FAILED",{codecType:this.config.codecType,vid:this.playerConfig.vid}),this.log(ev.f.ERROR,"error middleware",JSON.stringify(n),", isDegrade,",!this._MSEError&&!this.useVideoLoad,t.currentTime),!this._MSEError&&!this.useVideoLoad){t.vtype="MP4_2",this._MSEError=!0,null==(r=this.mp4)||r.cancelLoading(),this.startDegradedPlayback(n,t.paused),this.emit(sy);return}this.emit(sy),this.useVideoLoad&&i(e.eventName,null==e?void 0:e.error)}})),this._isEventInit=!0}getBufferDur(){var e;if(!(null!=(e=this.player)&&e.buffered))return 0;let{buffered:t}=this.player,i=0;for(let e=0,r=t.length;e<r;e++)i+=t.end(e)-t.start(e);return i}deleteVideo(){var e;if((null==(e=this.removeVideoList)?void 0:e.length)>0){for(let e=0;e<this.removeVideoList.length;e++){let t=this.removeVideoList[e],i=t.parentNode;i&&i.removeChild(t),this.log(ev.f.WARN,"[_removeVideoSource]")}this.removeVideoList=[]}}_unbindEvents(){var e;this.log(ev.f.LOG,"unbindEvents,",this._isEventInit),this.off("seeking",this._onSeeking),this.off("waiting",this._onWaiting),this.off("ended",this._onEnded),this.off("error",this._onError),this.off("playing",this._onPlaying),this.off("pause",this._onPause),this.off(d.CHANGE_FLYING_PLUGIN_CONFIG,this._onChangeConfig),this._isEventInit=!1,null!=(e=this.config)&&e.enableFPSStuckHandle&&this.off(sT,this.fpsStuckHandle)}changeState(e,t={}){this._pTime||(this._pTime=ij());let i=ij()-this._pTime,r=ij()-this._sTime;this.log(ev.f.LOG,`>>>changeState[${e}]`,i,r,JSON.stringify(t)),this.states.push({state:e,t1:i,t2:r,data:t}),this._pTime=ij()}get softDecode(){var e,t;return(null==(t=null==(e=this.player)?void 0:e.config)?void 0:t.mediaType)==="tt-video"}_initH265MseProxy(){let{player:e}=this;e.video instanceof HTMLVideoElement&&this.h265_h264_switch(this.playerConfig.mediaType);let t=e.video;this.softDecode&&t.setPlayMode&&t.setPlayMode("VOD"),this.mseProxy=t,this.softDecode&&(e.forceDegradeToVideo=()=>{},i1(e,"warning",this._lowDecoder),i1(e,"error",this._onError))}notSupportError(e){return this.log(ev.f.LOG,e,ig),new sn(this.player,{errorType:iL.MEDIA,errorCode:iC.mse,errorMessage:`${e} ${ig}`,vid:this.playerConfig.vid})}removeAndRejectInitPromise(e){this._initPromise&&(this._removePendingPromise(this._initPromise),this._initPromise.reject(e))}_initMp4(e,t={},i={}){var r,s,n,a,o,l,h;let{config:d,player:u,playerConfig:c}=this;this.mp4&&(this.mp4.destroy(),this.mp4=null),this.changeState("MP4_NEW",{});let p=0;null!=(r=null==d?void 0:d.pcdnConfig)&&r.openPCDN&&(p=(null==(s=null==d?void 0:d.pcdnConfig)?void 0:s.switchPCDNMaxCnt)||2),null!=(n=null==d?void 0:d.pcdnConfig)&&n.adaptPCDNConfig&&(p=0),this._setCurrentDefinition(u.curDefinition.bitrate),null==d||d.loadRangeType;let f=null==(o=null==(a=u.curDefinition)?void 0:a.pktOffsetMap)?void 0:o.find(e=>(null==e?void 0:e.time)===((null==d?void 0:d.firstLoadTimePos)||5)),m=null==f?void 0:f.offset,g=function(e,t){let{getRequestOptionsCallback:i,reqOptions:r}=e,s=null;return s=t.reqOptions?t.reqOptions:"Function"===iz(i)?i(t):r,{...r,...s}}(this.config,{url:e});this.mp4=new rg(e,u.curDefinition.bitrate,{segmentDuration:d.segmentMinDuration,enableWorker:d.enableWorker,codecType:this.codecType,chunkSize:d.chunkSize,firstLoadSize:m,duration:c.duration||0,fileSize:i.fileSize||0,playerId:this.playerId,vid:c.vid,useUrlRange:d.useUrlRange,retryCount:d.retryCount,retryDelay:d.retryDelay,timeout:d.timeout,onProcessMinLen:d.onProcessMinLen,supportHevc:d.supportHevc,afterLoadeddataCallBackLen:d.afterLoadeddataCallBackLen,firstLoadBuffer:d.firstLoadBuffer,logger:this.logger,switchPCDNMaxCnt:p,reqOptions:g,fixEditListOffset:d.fixEditListOffset},this.config._backupURL,this.firstFrameTime,""),this.mp4.once(re,this._onMp4MetaReady),this.mp4.on(i7,this._onMp4Error),this.mp4.on(rr,this._updateDrmConfig),this.mp4.on(rs,this._updateMSE),this.mp4.on(ri,this._onMp4Progress),this.mp4.on(rt,this._onMp4DataCallBack),this.mp4.on(rl,e=>{this.player&&this.player.emit("source_error",e)}),this.mp4.on(rd,e=>{var t,i;let{player:r,config:s}=this;this.emit(sy),this.log(ev.f.LOG,"not match remove buffer start,buffer,",JSON.stringify(null==(t=null==r?void 0:r.buffered2)?void 0:t.bufferedList),", removeRange,",JSON.stringify(e)),null==(i=this.mse)||i.remove(ey.Ub.VIDEO,e[0]+.1,e[1]-.1).then(()=>{var e;this.log(ev.f.LOG,"not match remove buffer end,",JSON.stringify(null==(e=null==r?void 0:r.buffered2)?void 0:e.bufferedList));let{currentTime:t}=r;(null==s?void 0:s.loadRangeType)===ib&&(r.currentTime=t,this.log(ev.f.LOG,"not match remove buffer end, fix currentTime",r.currentTime))}).catch(()=>{})}),this.mp4.on(ro,e=>{this.pcdn&&e&&this.pcdn.removePCDNNode(e.vid,e.bitrate,e.url)}),this.mp4.on(rn,e=>{this.player&&(this.player.rawSrc=e,this.player.emit("initialUrl",{url:e}),this.player.emit("changeHost",iY(e)))}),this.mp4.on(ra,async e=>{var t;await (null==(t=this.mp4)?void 0:t.cancelLoading()),this._curLoadSegmentIdx=e,this.log(ev.f.LOG,"[update curLoadSegmentIdx]",e)}),this.mp4.on(rh,e=>{var t,i,r;if(!this.player)return;let{vid:s}=c,n={vid:s,taskType:1,changeCnt:null==(t=this.mp4)?void 0:t.getCurSwitchPCDNCnt(),traceId:null==(r=null==(i=this.mp4)?void 0:i.pcdnTraceInfo)?void 0:r.trace_id},a=function(e,t,i={}){let{vid:r,taskType:s,changeCnt:n,traceId:a}=i,{bitrate:o,definition:l,file_id:h}=t,d=(null==e?void 0:e.load_type)||"cdn",u={vid:r,task_type:s,change_cnt:n,definition:l,bitrate:o,fileid:h};return"cdn"===d?u.cdn_size=e.len:(u.pcdn_size=e.len,u.trace_id=a),u}(e,this._currDefinition,n);this.player.emit("prf_data_size",a);let o=(null==e?void 0:e.load_type)||"cdn";this.mp4&&this.mp4.updateLoadInfo(o,e.len),iN&&console.log("prf_data_size emit, vid,",s,",loadType,",o,", task_type, 1",",len,",e.len)}),this.mp4.MP4Loader.on(im,e=>{var t,i,r,s,n,a,o,l,h,d;sw=e.speed,function(e,t){e.speed||(e.speed=[]);let{speed:i}=e;i.push(t),i.length>10&&i.shift()}(this.debugInfo,e.speed);let u=(null==(t=null==e?void 0:e.priOptions)?void 0:t.type)||"cdn";this.emit(im,{speed:e.speed,type:u,...e});let c=(null==(i=this.playerConfig)?void 0:i.vid)||(null==e?void 0:e.vid);if((null==e?void 0:e.len)>0){if(!this.player)return;let t=(null==(r=null==e?void 0:e.priOptions)?void 0:r.type)||"cdn",i=(null==(s=this.adaptRangeRes)?void 0:s.length)>0?this.adaptRangeRes.shift():{},u=null==(n=this.mp4)?void 0:n.getCurSwitchPCDNCnt(),{bitrate:p,definition:f,file_id:m}=this._currDefinition,g={vid:c,task_type:1,change_cnt:u,bitrate:p,definition:f,fileid:m},_=i5(i),v=function(e,t){let i=iZ(t.len,t.time),r={cdn_size:0,cdn_speed:0,pcdn_size:0,pcdn_speed:0};return"cdn"===e?(r.cdn_size=t.len,r.cdn_speed=i):(r.pcdn_size=t.len,r.pcdn_speed=i),r.time=t.time,r}(t,e),y={...g,..._,...v},{idx:A}=i;this.player.emit("prf_data_size",y),iN&&console.log("prf_data_size emit,",A,JSON.stringify(y));let T=e.index?null==(l=null==(o=null==(a=this.mp4)?void 0:a.adaptTimeRange[e.index])?void 0:o.timeRangeIdx)?void 0:l[1]:null;if(T&&T>=this.mp4.timeRange.length-1)for(;(null==(h=this.adaptRangeRes)?void 0:h.length)>0;){let e=this.adaptRangeRes.shift(),t=null==(d=this.mp4)?void 0:d.getCurSwitchPCDNCnt(),i={...g,...v,...i5(e)};i.change_cnt=t,this.player.emit("prf_data_size",i),iN&&console.log("prf_data_size emit,",A,JSON.stringify(i))}this.mp4&&this.mp4.updateLoadInfo(t,e.len)}}),null!=(l=null==d?void 0:d.pcdnConfig)&&l.adaptPCDNConfig&&(null==(h=this.mp4)||h.setSwitchPCDNCallBack(()=>{let{pcdn:e}=this;if(!e)return -1;let t=e.getPCDNChangeCnt()||-1;return this.log(ev.f.LOG,"[updateSwitchPCDNMaxCnt]",t),t})),this.changeState("MP4_INIT",{}),this.emit("loadstart_mse"),t||(t={}),this.mp4.init(t),this._emitDefinitionChangeDetailEvent(0)}_checkPreloader(){let{playerConfig:e}=this,t=new rT,i={method:"checkPreloader",success:0,type:"error",cacheKey:""};this.changeState("CHECK_PRELOAD");let{curDefinition:r,preloader:s}=this.player;if(!s)return this.changeState("PRELOAD_ERROR",{t:2}),i.success=0,i.error=Error("no_preloader"),t.resolve(i),t;let n=r.cacheKey?r.cacheKey:s.generateUniqueKey({vid:e.vid,definition:r.definition||-1,vtype:e.vtype,codecType:e.codecType});return i.cacheKey=n,n?s.getPreLoadData(n).then(e=>{if(e){let{bitrate:s,orgDefinition:a}=e;if(s&&r.bitrate&&s!==r.bitrate){this.preLoadData=null,i.success=0,i.error=Error(`bitrate_not_match_cut_${r.bitrate}_cache_${s}`),this.changeState("PRELOAD_ERROR",{bitrate:s,ck:n}),t.resolve(i),this.log(ev.f.LOG,`>>>check Preloader bitrate_not_match cacheKey${n}
                curDefinition:${r.bitrate}  cache:${s}`);return}r.orgDefinition=a,iB&&console.log(">>>>[mp4]check Preloader result",n,e),this.preLoadData=e,this.emit("PRELOAD_INFO",this.preLoadData),this.emit("hitCache",e),i.success=1,i.data=e,iT.set(n,!0),this.changeState("PRELOAD_OK",{l:this.preLoadData.byteLength,ck:n}),e.mediaSegList&&e.mediaSegList.length>0||e.buffer&&e.buffer.byteLength>0?this.hitpreload=!0:this.hitpreload=!1,t.resolve(i)}else this.preLoadData=null,this.changeState("PRELOAD_ERROR",{t:0}),i.success=0,i.error=Error("none_preload"),t.resolve(i)}):(this.changeState("PRELOAD_ERROR",{t:2}),i.success=0,i.error=Error("none_preload"),t.resolve(i)),t}_initEME(e,t){var i,r;let s=i8(this.config),{useEME:n}=this.config;if(s&&n&&!sx.checkEMEValid()){this.log(ev.f.ERROR,"checkEMEInValid"),this._errorHandler(new sn(this.player,{errorType:iL.MEDIA,errorCode:iC.eme_hijack,errorMessage:"checkEMEInValid",vid:this.playerConfig.vid}));return}let{player:a,config:o}=this;this._updateDrmConfig(t),this.log(ev.f.LOG,"useEME: ",o.useEME),null==(i=this._secretkey)||i.setOptions('video/mp4; codecs="avc1.64001E"','audio/mp4; codecs="mp4a.40.2"'),null==(r=this._secretkey)||r.setupEME(a.video)}async _initMse(e,t=!1){var i;let r,{useEME:s}=this.config;if(i8(this.config)&&s&&!sx.checkMSEValid()){this.log(ev.f.ERROR,"checkMSEInValid "),this._errorHandler(new sn(this.player,{errorType:iL.MEDIA,errorCode:iC.mse_hijack,errorMessage:"checkMSEInValid",vid:this.playerConfig.vid}));return}if(null==(i=this.player)||i.emit("codecsupdate",e.videoCodec),this.config.frameFreeze){if(this.log(ev.f.LOG,"release freezed frame"),this.mse){let e=this.mse;this.mse=null,await e.unbindMedia()}this.player&&this.player.src&&(this.player.removeAttribute("src"),this.player.load())}else this.updateMSEDuration();let n=function(e,t){let i=e&&e.checkCodecH265(),r=e&&e.checkCodecH266(),s=!!t.videoCodec,n=!!t.audioCodec;return s&&n?i?'video/mp4; codecs="hev1.1.6.L93.B0, mp4a.40.5"':r?'video/mp4; codecs="bvc2.1.6.L93.B0, mp4a.40.5"':'video/mp4; codecs="avc1.64001E, mp4a.40.5"':s?i?'video/mp4; codecs="hev1.1.6.L93.B0"':r?'video/mp4; codecs="bvc2.1.6.L93.B0"':'video/mp4; codecs="avc1.64001E"':'video/mp4; codecs="mp4a.40.5"'}(this.mp4,e),a={[ey.Ub.VIDEO]:{mimeType:"video/mp4",codec:n}};this.mse?(this.log(ev.f.LOG,"MSE exit"),(r=new rT).resolve()):(this.log(ev.f.LOG,"new MSE"),this.mse=new ey.Ub,r=this.mse.bindMedia(this.player.video)),r.then(e=>{var i;this.changeState("MSE_OPEN");let{firstFrameTime:r}=this;r.initmse_sbopen=null==e?void 0:e.costtime,this._loadStartEventTime>0&&(r.mseopen=ij()-this._loadStartEventTime);let s=Object.keys(a);try{for(let e=0;e<s.length;e++){let r=s[e];null==(i=this.mse)||i.createOrChangeSource(r,a[r].codec).then(()=>{this.changeState("MSE_OPEN_DONE"),this._isMseInit=!0,this._onTimeUpdate()}).catch(async e=>{var i;this.config.reUseMSE=!1,this.log(ev.f.WARN,"MSE createOrChangeSource catch err: ",null==e?void 0:e.message),await (null==(i=this.mse)?void 0:i.unbindMedia()),this.mse=null,this._isMseInit=!1,t?this.MSEErrorHandle(e):this._initMse(this.mp4.meta,!0)})}}catch(e){this.MSEErrorHandle(e)}}).catch(e=>this.MSEErrorHandle(e)),this.changeState("MSE_INIT")}MSEErrorHandle(e){let t=new sn(this.player,{errorType:iL.mse,errorCode:iC.mse,vid:this.playerConfig.vid,errorMessage:e.message,mediaError:{code:iC.mse,message:e.message}});this.log(ev.f.ERROR,"initMse error: ",null==e?void 0:e.message),this._errorHandler(t)}_appendInitSeg(e){!this.mse||this._MSEError||(this.changeState("MSE_INITSEG"),this.mse.append(ey.Ub.VIDEO,e,{vid:this.playerConfig.vid,range:null,dataLen:e.byteLength,isinit:!0}).then(e=>{this.firstFrameTime.metaready_initsegend=null==e?void 0:e.costtime,this.changeState("MSE_INITSEG_OK",{costtime:null==e?void 0:e.costtime})}),this.config.useEME&&this._secretkey&&this._secretkey.encryptHandle())}_checkMetaInfo(e){if(!e)return new sn(this.player,{errorType:iL.DEMUX,errorCode:iC.metaError,errorMessage:"meta is null",vid:this.playerConfig.vid});let t=this.mp4.checkCodecH265(),i=this.mp4.checkCodecH266();return this.changeState("MP4_META_READY",{isH265:t,isH266:i}),!t||(this.codecType!==iP&&(this.codecType=iP,this.log(ev.f.LOG,"codecType fix ",this.codecType)),this.softDecode||this.config.supportHevc)?i&&(this.codecType!==iw&&(this.codecType=iw,this.log(ev.f.LOG,"codecType fix ",this.codecType)),!this.config.supportVvcc)?this.notSupportError(this.codecType):null:this.notSupportError(this.codecType)}_stopProgress(){this.log(ev.f.LOG,"stopProgress",this._hasStartProgress),this._hasStartProgress=!1,this._requestTimer&&this._requestTimer.stop(),this._bufferBreakTimer&&(clearTimeout(this._bufferBreakTimer),this._bufferBreakTimer=null,this._bufferBreakFlag=void 0),this._seekResumTimer&&(clearTimeout(this._seekResumTimer),this._seekResumTimer=null)}checkReStartTimer(){let e=ij()-this._lastTimeupdateTime2;e>2*this.config.tickInSeconds*1e3&&!this._offineLine&&(this.log(ev.f.LOG,"checkReStartTimer reStart timer",e,ij()),this._stopProgress(),this._startProgress(),this._lastTimeupdateTime2=ij())}_bindNetworkStateChange(){window.addEventListener("online",this._onOnlineHandler),window.addEventListener("offline",this._onOfflineHandler)}_unbindNetworkStateChange(){window.removeEventListener("online",this._onOnlineHandler),window.removeEventListener("offline",this._onOfflineHandler)}_onSuperStart(e){let{player:t}=this;iV(`_onSuperStart:${e}`,this.mse),t.video.src=e,this.once("canplay",()=>{t.play(),this.on("waiting",this._onWaiting)})}_appendBuffer(e,t,i={},r){let{mse:s,playerConfig:n,player:a}=this,{vid:o}=n;if(this.log(ev.f.LOG,"appendStart",o,i.fragIndex,JSON.stringify(i.range)),this._MSEError)return void this.log(ev.f.ERROR,"_MSEError, not append return");s.append(e,t,{vid:o,fragIndex:i.fragIndex,range:i.range,dataLen:t.byteLength,state:r}).then(e=>{var t,s,n,o,l,h,d;let u=a.getBufferedRange();this.log(ev.f.LOG,"appendEnd ",null==(t=null==e?void 0:e.context)?void 0:t.fragIndex,JSON.stringify(null==(s=null==e?void 0:e.context)?void 0:s.range),null==(n=null==e?void 0:e.context)?void 0:n.dataLen,", costTime,",null==e?void 0:e.costtime,", opt,",null==e?void 0:e.name,",buffer,",JSON.stringify(u),a.currentTime),this.checkBufferArriveEndTime();let c=this.firstFrameTime;if(c.loadst_loadeddata<0){c.apcnt++;let t=(null==(o=null==e?void 0:e.context)?void 0:o.dataLen)||0,i=(null==e?void 0:e.costtime)||0;c.aplen+=t,c.data_ap+=i;let r=!1;for(let e=this.states.length-1;e>=0;e--)if("APPEND_DATA_OK"===this.states[e].state){this.states[e].data.cnt+=1,this.states[e].data.costime+=i,this.states[e].data.dataLen+=t,r=!0;break}r||this.changeState("APPEND_DATA_OK",{costime:i,dataLen:t,cnt:1})}let p=null==(d=null==(h=null==(l=this.mp4)?void 0:l.adaptTimeRange[i.fragIndex])?void 0:h.timeRangeIdx)?void 0:d[1];if(this.mse&&r&&p>=this.mp4.timeRange.length){let{buffered:e}=this.player;e&&(null==e?void 0:e.length)>0&&(this.bufferEndTime=e.end(e.length-1)),this._isEnded(),this.log(ev.f.LOG,"loaded ended !!!==>>>",JSON.stringify(i.range),", fragIndex,",i.fragIndex,", bufferEndTime,",this.bufferEndTime,",meta_duration,",this.mp4.meta.duration)}}).catch(e=>{let{player:t,mse:r}=this;if(this._MSEError||!t)return;let s=t.media||t.video;if(e&&null!=r&&r.isFull()){this.log(ev.f.WARN,"[MSE is full]");let e=t.getBufferedRange(t.buffered2);this._checkRemoveSourceBuffer(e,t.currentTime,!0)}else{let r=`${null!=s&&s.error?[s.error.code,s.error.message].join("-"):"MEDIA_EMPTY"}`,n=`${(null==e?void 0:e.errorCode)||""}-${(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message)||"MSE_EMPTY"}|${r}`;this._MSEError=!0,this.changeState("_MSEError",{fragIndex:null==i?void 0:i.fragIndex,range:null==i?void 0:i.range}),this.log(ev.f.LOG,"MSE append error",null==i?void 0:i.fragIndex,null==i?void 0:i.range);let a=new sn(t,{errorType:iL.MEDIA,errorCode:iC.mseAppend,vid:o,errorMessage:n,mediaError:{code:iC.mseAppend,message:n}});this._errorHandler(a)}})}async _loadData(){if(!(!this.mp4||!this._isMseInit)){this.loadstart<0&&(this.loadstart=ij());try{await this.mp4.load(this._curLoadSegmentIdx,this._loadDataSuccess)}catch(e){this.log(ev.f.ERROR,"[Index] _loadData error",this.playerConfig.vid,null==e?void 0:e.message)}}}getDataBitRate(e){let{mp4:t,playerConfig:i}=this,{definition:r}=i;if(!t||!r||r.list)return 0;let s=t.getDataBitRate(e),{list:n}=r,a=0;for(let e=0;n&&e<n.length;e++)if(n[e].bitrate===s){a=n[e];break}return a}_loadStuckCheck(){var e;let{config:t,player:i}=this;if(!t.disableBufferBreakCheck){let r=i.isUserActive;if(i.currentTime-(this._lastCurrentTime||0)>.1||!r&&i.paused||r&&this.playFlag&&i.paused)(1===this._bufferBreakFlag||2===this._bufferBreakFlag)&&(this.log(ev.f.LOG,"\u89C6\u9891\u6CA1\u6709\u5361\u6B7B,\u91CD\u7F6E\u5361\u6B7B\u6807\u8BB0,curtime,",i.currentTime),this._bufferBreakFlag=0,clearTimeout(this._bufferBreakTimer),this._bufferBreakFlag=null);else if(!this._bufferBreakFlag){this._bufferBreakFlag=1;let s=JSON.stringify(null==(e=null==i?void 0:i.buffered2)?void 0:e.bufferedList);this.log(ev.f.LOG,`\u{5361}\u{6B7B}\u{8BA1}\u{65F6}\u{5F00}\u{59CB}! ${t.waitingTimeOut}ms\u{540E}\u{786E}\u{8BA4}\u{5361}\u{6B7B},`,i.currentTime,s),this._bufferBreakTimer=setTimeout(()=>{if(!(this.isDestroy||t.disableInactiveWaitingCheck&&(!r||null!=i&&i.paused))){if(1===this._bufferBreakFlag){let e=i.currentTime,t=i.bufferedPoint;if(t.end>0&&t.end-e>=2)return void this.retrySeekResum(e)}this._bufferBreakFlag=2,this.waitTimeoutDegrade()}},t.waitingTimeOut)}this._lastCurrentTime=i.currentTime}}waitTimeoutDegrade(){var e,t,i;let{player:r}=this;this.changeState("wait_timeout"),this.log(ev.f.LOG,"\u786E\u8BA4\u5361\u6B7B!!!,curtime,",r.currentTime,JSON.stringify(null==(e=null==r?void 0:r.buffered2)?void 0:e.bufferedList),",duration,",null==(i=null==(t=this.mp4)?void 0:t.meta)?void 0:i.duration),this.emit("waittimeout");let s=document.hidden||"hidden"===document.visibilityState,n=new sn(this.player,{errorType:iL.RUNTIME,errorCode:s?iC.waitTimeoutWithHidden:iC.waitTimeout,errorMessage:"wait_timeout",vid:this.playerConfig.vid});this._errorHandler(n)}async retrySeekResum(e){let{player:t,config:i}=this;if(this.changeState("retrySeek"),this.log(ev.f.LOG,"\u5361\u6B7B\u4F46\u6709\u8D85\u8FC72s\u7684buffer,seek\u4E0B!!!"),clearTimeout(this._seekResumTimer),this._resumePlay=!1,i.waitingRetrySeekTimes>0&&i.waitingRetryDuration){let r=Math.min(i.waitingRetrySeekTimes,3);this._currentSeekTimes=0,this.off("playing",this._onResumePlaying),this.once("playing",this._onResumePlaying);let s=()=>{if(!t||this._resumePlay||t.paused)return void this.log(ev.f.LOG,`\u{5F53}\u{524D}\u{64AD}\u{653E}\u{5B9E}\u{4F8B}\u{5DF2}\u{6062}\u{590D}\u{6216}\u{5904}\u{4E8E}\u{6682}\u{505C}\u{72B6}\u{6001}\u{FF0C}\u{9000}\u{51FA}\u{91CD}\u{8BD5} player=${!!t},_resumePlay=${this._resumePlay},paused=${null==t?void 0:t.paused}`);if(this._currentSeekTimes<r){this._seekOnce(e),this._seekResumTimer=setTimeout(s,i.waitingRetryDuration);return}this.waitTimeoutDegrade(),this._seekResumTimer=null};this._seekOnce(e),this._seekResumTimer=setTimeout(s,i.waitingRetryDuration);return}t.currentTime=e+1,this.once("playing",()=>{this._resumePlay=!0}),this._seekResumTimer=setTimeout(()=>{this._resumePlay||this.waitTimeoutDegrade(),this._seekResumTimer=null},Math.ceil(i.waitingTimeOut/2))}_isInBuffer(e,t=0){let i=!1,{buffered:r}=this.player.video;for(let s=0;s<r.length;s++){let n=r.start(s)-t,a=r.end(s)+t;if(n<=e.startTime&&e.endTime<=a){i=!0;break}}return i}_doubleCheckBuffer(e){let{player:t}=this;if(!(e.startTime>t.currentTime)||!t.video||!t.video.buffered)return!0;let{buffered:i}=t.video;return 1===i.length||this._isInBuffer(e,.2)}checkURLExpired(e,t){var i,r,s,n;let a=function(e){if(!e||"String"!==iz(e))return 0;let t=0;try{let i=RegExp("(\\?|&)x-tos-expires=([^&]*)(&|$)"),r=e.match(i);if(null!==r)t=parseInt(r[2],10);else{let i=e.split("/");i.length>5&&8===i[4].length&&(t=parseInt(i[4],16))}if(t>0){let e=parseInt(new Date().getTime()/1e3,10);return t<e?1:2}return 0}catch{return 0}}(this.config._mainURL);1===a&&this.pcdn&&(this.pcdn=null);let o=(null==(i=null==e?void 0:e.response)?void 0:i.url)||(null==(r=this.config.pcdnConfig)?void 0:r.trackerUrl);null==(n=this.player)||n.emit("source_error",{host:iY(o),src:o,errorCode:null==(s=null==e?void 0:e.response)?void 0:s.status,message:`${null==e?void 0:e.message}-${a}${t}`})}pushTimerStep(){var e;(null==(e=this.timerStepList)?void 0:e.length)>10&&this.timerStepList.shift(),this._lastTimeupdateTime2>0&&this.timerStepList.push(ij()-this._lastTimeupdateTime2)}_onTimeUpdate(){this.pushTimerStep(),this._lastTimeupdateTime2=ij();let{mse:e,mp4:t,player:i,config:r}=this;if(!i||this.useVideoLoad||!t)return;this.checkBufferArriveEndTime();let s=i.getBufferedRange();ij()-this._lastCheckTime>1e3&&(this._lastCheckTime=ij(),this._loadStuckCheck(),this._startUrlExpiredCheck(),this._checkRemoveSourceBuffer(s,i.currentTime));let{timeRange:n}=t;if(!(!n||n.length<1)&&(e||this.mseProxy)&&this.canDownload){let e=r.maxBufferLength,t=!1;(this.playFlag&&i.paused||!this.isActive)&&(t=!0);let{nextBufferLength:n,minBufferLength:a,adaptRange:o,noPreloadAddBufferLen:l}=r,h=null==o?void 0:o.targetCacheControl;t?e=i.isInstNext&&n>=0?n:a:h&&(e=this.adaptRange.getAdaptCacheBuffer()),!this.preLoadData&&h&&(e+=l);let d=i.currentTime+e;s[1]-d<0&&(this.isOpenPCDN(s[1]),(null==r?void 0:r.loadRangeType)===ib?this.sizeRangeCheckLoad(t,e,s[1]-i.currentTime):this.gopRangeCheckLoad(t,d,e)),this.playFlag&&!this._hasTriggerBufferThreshold&&this._startBufferCheck()}}sizeRangeCheckLoad(e,t,i){var r,s,n;let{player:a,mp4:o}=this,{adaptTimeRange:l}=o,h=l.length;if(!h||(null==(r=l[h-1])?void 0:r.range[1])<(o.size-1||a.curDefinition.size-1)||!l[h-1].downloaded){let r=l.findIndex(e=>!e.isLoading);if(!(null!=l&&l.length)||r>=0||l[h-1].downloaded){let{adaptRangeRes:h,loadDuration:d}=this.calculateAdaptRange(e,t),u=null==(s=this.adaptRange)?void 0:s.getAdaptRangeSize(d);u>0&&(h.loadSize=u),h.loadDuration=d,r<0?this._curLoadSegmentIdx=o.updateAdaptTimeRange(null,d,u):this._curLoadSegmentIdx=r;let c=this._curLoadSegmentIdx;l[c].downloaded||(c=Math.max(c-1,0));let p=l[c];if(i>0&&(null==p?void 0:p.endTime)-a.currentTime>=t)return;let f=l[this._curLoadSegmentIdx];if(this._curLoadSegmentIdx>=0&&this._isInBuffer(f)&&!this._isChangeDefinition&&this._curLoadSegmentIdx>=0&&f.endTime-f.startTime>1){let e=l[this._curLoadSegmentIdx];e.downloaded=!0,e.isLoading=!0,this.log(ev.f.LOG,`onTimeUpdate, ${this._curLoadSegmentIdx} download segment, has buffer`,f.startTime,f.endTime,a.currentTime),o.seekTime=f.endTime;return}h.idx=this._curLoadSegmentIdx,this.adaptRangeRes.length&&(null==(n=this.adaptRangeRes[h.length-1])?void 0:n.idx)===this._curLoadSegmentIdx||(this.adaptRangeRes.push(h),this.log(ev.f.LOG,"adaptRangeRes>>>>",h)),this.log(ev.f.LOG,"[onTimeUpdate],load index==>>>, ",this._curLoadSegmentIdx,JSON.stringify(l[this._curLoadSegmentIdx])),this._loadData()}}}gopRangeCheckLoad(e,t,i){let{timeRange:r,adaptTimeRange:s}=this.mp4,{player:n}=this;r.every((r,a)=>{var o,l,h,d;if(void 0!==r.adaptTimeRangeIdx&&r.adaptTimeRangeIdx>=0&&s&&s[r.adaptTimeRangeIdx].downloaded)return!0;let u=this.mp4.getAdaptIdxBySrcIdx(a,!0),c=u>=0?s[u]:null,p=u>=0&&this._isInBuffer(c);if(!this._isChangeDefinition&&u>=0&&c.endTime-c.startTime>1&&p)return s[u].downloaded=!0,s[u].isLoading=!0,this.log(ev.f.LOG,`onTimeUpdate, ${u} download segment, has buffer`,c.startTime,c.endTime,n.currentTime),!0;if(r.startTime-n.currentTime<t){if(u<s.length&&null!=(o=s[u])&&o.isLoading)return!1;let{adaptRangeRes:t,loadDuration:r}=this.calculateAdaptRange(e,i);this._curLoadSegmentIdx=this.mp4.updateAdaptTimeRange(a,r),t.idx=this._curLoadSegmentIdx,null!=(h=null==(l=this.config)?void 0:l.adaptRange)&&h.rangeControl&&(t.loadDuration=this.mp4.adaptTimeRange[this._curLoadSegmentIdx].duration),this.adaptRangeRes.length&&(null==(d=this.adaptRangeRes[this.adaptRangeRes.length-1])?void 0:d.idx)===this._curLoadSegmentIdx||(this.adaptRangeRes.push(t),this.log(ev.f.LOG,"adaptRangeRes>>>>",t));let c=s[this._curLoadSegmentIdx];if(this._isInBuffer(c))return c.downloaded=!0,c.isLoading=!0,this.log(ev.f.LOG,`onTimeUpdate_, ${this._curLoadSegmentIdx} download segment, has buffer`,c.startTime,c.endTime,n.currentTime),!0;this.log(ev.f.LOG,"[onTimeUpdate],load index==>>>, ",this._curLoadSegmentIdx,JSON.stringify(this.mp4.adaptTimeRange[this._curLoadSegmentIdx])),this._loadData()}})}checkBufferArriveEndTime(){let{player:e,mse:t,mp4:i}=this;if(!e||!t||!i)return;let r=e.getBufferedRange(),s=i.getMediaEndTime();s>0&&r[1]>=s&&!t.isEnded&&(this.log(ev.f.LOG,"checkBufferArriveEndTime endOfStream, enfTime",s,", bufferRange,",JSON.stringify(r),",currentTime,",e.currentTime),this.mseEndInfo.mseEndType=1,this.mseEndInfo.mseEndTime=parseInt(1e3*s,10),t.endOfStream())}calculateAdaptRange(e,t){var i,r;let s,n={forceSetMin:e};null!=(i=this.pcdn)&&i.isOpenAdaptPCDN&&(n.PCDNInBuffer=this.pcdn.curPCDNInBuffer,n.PCDNOutBuffer=this.pcdn.curPCDNOutBuffer);let a=null==(r=this.config)?void 0:r.adaptRange;return!this.playFlag||e?s=this.config.minBufferLength:null!=a&&a.rangeControl?n.loadTarDuration=s=this.adaptRange.getAdaptLoadDuration():s=this.config.rangeMaxDuration,null!=a&&a.targetCacheControl&&(n.cachedBufferDur=t),!this.playFlag&&null!=a&&a.rangeControl&&(n.loadTarDuration=s),{adaptRangeRes:n,loadDuration:s}}checkReUseMSE(e,t){var i;let{mse:r}=this;if(r)if(e||this.config.reUseMSE){r.clearOpQueues(ey.Ub.VIDEO,t),r.abort(ey.Ub.VIDEO);let e=null==(i=this.player)?void 0:i.buffered;if((null==e?void 0:e.length)>0){let t=e.end(e.length-1);this.log(ev.f.LOG,"reUseMSE remove buffer, 0-",t),this._canUpdateDuration=!1,this.removeBuffer(ey.Ub.VIDEO,0,t,()=>{var e,t;this._canUpdateDuration=!0,null!=(t=null==(e=this.mp4)?void 0:e.meta)&&t.duration&&this.updateMSEDuration()})}}else r.unbindMedia(),this.mse=null,this._unloadVideo()}updateMSEDuration(){var e;let{mse:t,mp4:i}=this,r=null==(e=null==i?void 0:i.meta)?void 0:e.duration;this._canUpdateDuration&&r&&r!==t.duration&&(this.log(ev.f.LOG,"updateMSEDuration ",r,",oldDuration,",t.duration),t.updateDuration(r),this._canUpdateDuration=null)}_reset(){this._definitionChangePointInfo=null,this._isReceiveEndedEvent=!1,this.adaptRangeRes=[],this.states=[],this.hitpreload=!1,this._sTime=ij(),this._isChangeDefinition=!1,this._removeBuffeEndTime=0,this._usePaused=!1,this.useVideoLoad=!1,this._isMseInit=!1,this.endofstream=!1,this._curLoadSegmentIdx=0,this.emitExpireTimestamp=null,this.preLoadData=null,this.forPreloadTimeCache=null,this.playFlag=!1,this.waitLevelStartTime=-1,this._waitAdjustTimeCnt=0,this._initPromise&&"pending"===this._initPromise.state&&this._initPromise.reject(sv),clearTimeout(this.checkResumePlayTimer),this.checkResumePlayTimer=null,this._stopProgress(),this.mp4&&(this.mp4.destroy(),this.mp4=null),this.mseProxy&&(i2(this.player,"warning",this._onDegrade),i2(this.player,this._onError)),this.config.frameFreeze||this._unloadVideo(),this._cancelPendingPromises(),this._abrService&&(this._abrService.destroy(),this._abrService=null);let e=this.firstFrameTime;Object.keys(e).forEach(t=>{"apcnt"===t||"aplen"===t?e[t]=0:"newplayer"===t?e[t]=ij():e[t]=-1}),clearTimeout(this._waitInBufferTimer),this._waitInBufferTimer=null,this.canDownload=!0,this.loadstart=-1,this._loadStartEventTime=-1,this.startLoadData=-1}removeErrorUrls(e,t,i){return e.errorCode===iC["403"]&&this._emitExpireEvent(e),i}checkIsDegraded(e){let{notDegradeErrorList:t}=this.config;return!((null==t?void 0:t.length)>0&&(e.errorCode===iC.timeout&&t.indexOf("timeout")>=0||e.errorCode===iC["403"]&&(t.indexOf(403)>=0||t.indexOf("403")>=0)||e.errorCode===iC["404"]&&(t.indexOf(404)>=0||t.indexOf("404")>=0)))}startDegradedPlayback(e,t,i){this.canDownload=!1;let{player:r,playerConfig:s,config:n}=this;this.endofstream=!1,this._currentTime=r.currentTime||0,this.player.pause(),this._reset(),this._replay=null;let{H264DefinitionList:a}=s;if(this.codecType===iP&&this.softDecode)this.log(ev.f.LOG,"h265 softDecode err,degrade use 264 play",s.vid),this._onDegrade(e,i);else if(this.codecType===ik||n.supportHevc||n.supportVvcc||(null==a?void 0:a.length)>0){let{drm:i,kid:o,drmKeyToken:l,keyValue:h,secretKey:d}=n;if(i||o||l||h||d)i&&Object.keys(i).map(t=>{i&&(e[t]=i[t])}),this.log(ev.f.ERROR,"final error !!!!, ",s.vid,null==e?void 0:e.errorCode,null==e?void 0:e.errorMessage),this.emit("error",e);else{this.log(ev.f.LOG,this.codecType,"MSE degrade video,",s.vid,r.currentTime),this.useVideoLoad=!0,this.destroyMSE();let i=()=>{this._currentTime&&(r.currentTime=this._currentTime),this.log(ev.f.LOG,"DegradedPlayback update currentTime",s.vid,this.codecType,this._currentTime),t?this.player.pause():this.player.play(),this._removeMetaDataEvent()};this._addMetaDataEvent(i);let n=s.url;if((null==a?void 0:a.length)>0){let e=a.length,t=this.player.curDefinition.definition,i=t&&a.find(e=>e.definition===t);i||(s.H264DefinitionList.sort((e,t)=>e.bitrate-t.bitrate),i=s.H264DefinitionList[Math.floor(e/2)]),i&&(n=i.url,this.playerConfig.codecType=ik,this.playerConfig.url=n,this.playerConfig.defaultBitrate=i.bitrate,this.playerConfig.defaultDefinition=i.definition,this.codecType=ik)}this.emit(sA,{errorCode:null==e?void 0:e.errorCode,errorMessage:(null==e?void 0:e.errorMessage)||(null==e?void 0:e.message),codecType:this.codecType,mediaType:s.mediaType}),this._setPlayerSrc(n)}}else this.log(ev.f.ERROR,"degrade player failed"),this.emit("error",e)}getAdaptTimeRangeIdx(e){var t,i;let{config:r,adaptRange:s}=this,n=r.segmentMinDuration;return s&&null!=(t=null==r?void 0:r.adaptRange)&&t.rangeControl&&(n=s.getAdaptLoadDuration()),null==(i=this.mp4)?void 0:i.updateAdaptTimeRange(e,n)}_startProgress(){this.initTimer(),this._requestTimer.start(),this._hasStartProgress=!0}_unloadVideo(){this.log(ev.f.LOG,"unloadVideo");let{player:e}=this;try{e.video&&e.video.src&&!/^blob/.test(e.currentSrc)&&!/^blob/.test(e.video.src)&&(this.log(ev.f.LOG,"unloadVideo src"),e.video.removeAttribute("src"),e.video.load())}catch(e){this.log(ev.f.ERROR,"unloadVideo error",null==e?void 0:e.message)}}_addPendingPromise(e){this._pendingPromises.push(e)}_removePendingPromise(e){this.log(ev.f.LOG,"removePendingPromise",null==e?void 0:e.id);let t=this._pendingPromises.indexOf(e);t>-1&&this._pendingPromises.splice(t,1)}_cancelPendingPromises(){this._pendingPromises.length>0&&this._pendingPromises.forEach(e=>{e.reject(sv)}),this._pendingPromises=[]}_onMediaExpired(){this.log(ev.f.LOG,"MediaExpired stopProgress"),this._stopProgress(),this.emit(ip.MEDIA_EXPIRED)}_isEnded(){var e,t;let{player:i,mp4:r}=this,s=i.bufferedPoint,n=s?s.end:0,a=i.currentTime;a>1&&n>a&&(n-a>=2||i.duration-a<1)&&2===i.video.readyState?ij()-this._lastCheckLagTime>=3e3&&(this.log(ev.f.LOG,"[has buffer but waiting,seek 0.2 adjust],curTime,",a,", bufferend,",n,", duration,",null==(e=null==r?void 0:r.meta)?void 0:e.duration),i.currentTime=a+.2,this._lastCheckLagTime=ij()):this._lastCheckLagTime=ij();let{seeking:o}=i.video;return!this.endofstream&&this.bufferEndTime>0&&this.mse&&!o&&this.bufferEndTime-a<.5&&(this.log(ev.f.LOG,"[isEnded endOfStream],curTime,",i.currentTime,", bufferend,",n,", duration,",null==(t=null==r?void 0:r.meta)?void 0:t.duration),this.endofstream=!0,this.mseEndInfo.mseEndType=2,this.mseEndInfo.mseEndTime=parseInt(1e3*this.bufferEndTime,10),this.mse.endOfStream().then(()=>{})),!!r&&!!r.meta&&!o&&r.meta.duration-a<.5&&(this._stopProgress(),this.log(ev.f.LOG,"[isEnded],stopProgress and endOfStream,curTime, ",i.currentTime,", bufferend,",n,", duration,",r.meta.duration),this.mse&&(this.mseEndInfo.mseEndType=3,this.mseEndInfo.mseEndTime=parseInt(1e3*r.meta.duration,10),this.mse.endOfStream().then(()=>{})),!0)}emitVideoEvent(e){if(this._checkEndedTimer)return;let{player:t,mp4:i}=this;this._checkEndedTimer=setTimeout(()=>{this._checkEndedTimer=null,!this._isReceiveEndedEvent&&i.meta.duration-t.currentTime<.5&&(this.log(ev.f.LOG,"[ do emit video ended event],curTime,",t.currentTime,", bufferend,",e,", duration,",i.meta.duration),this.emit("ended"))},2e3)}_clearMediaKeys(){let{player:e}=this;e.video&&"function"==typeof e.video.setMediaKeys&&e.video.setMediaKeys(null).catch(()=>{})}_checkRemoveSourceBuffer(e,t,i,r){let{mse:s,mp4:n,player:a}=this;if(!(!s||!n||!a)&&(i&&(clearTimeout(this._removeBufferTimer),this._removeBufferTimer=null),e||(e=a.getBufferedRange(a.buffered2)),t||(t=a.currentTime),!(!i&&ij()-this._checkRemoveBufferLastTime<=this.config.removeBufferLen||this.endofstream)&&(this._checkRemoveBufferLastTime=ij(),e&&e[0]>=0&&(t-e[0]>this.config.removeBufferLen||s.isFull())))){let i=r?e[1]:t-15*!s.isFull(),a=n.getFragmentIdx(i);if(a>0&&(r||n.timeRange[a].startTime<t)){let i=Math.floor(Math.min(n.timeRange[a].startTime,e[1])),r=Math.max(n.timeRange[0].endTime+1,e[0]);r<i?(this.log(ev.f.LOG,"[checkremoveSourceBuffer], remove range==>>>",r,i,t),this.removeBuffer(ey.Ub.VIDEO,r,i)):s.isFull()&&!this._removeBufferTimer&&(this._removeBufferTimer=setTimeout(()=>{this._checkRemoveSourceBuffer(null,null,!0)},1e4))}}}onMediaUpdate(e){let{vid:t,kid:i,url:r}=e,{player:s,config:n,playerConfig:a}=this;if(t===a.vid&&i===n.kid&&r){this.playerConfig.url=r;let e=this._handlerUrl(r);n._mainURL=e.main,n._backupURL=e.backup;let t=n._mainURL;return s.rawSrc=r,this.useVideoLoad?s.src=r:this.mp4&&this.mp4.updateUrl(t),!0}return!1}enableAutoBuffer(e){if(e){if(!this._allInitPromise)return void this.log(ev.f.LOG,"player destroyed!!");this._allInitPromise.then(()=>{this.log(ev.f.LOG,"enableAutoBuffer true"),this._startProgress()})}else this._stopProgress(),this.log(ev.f.LOG,"enableAutoBuffer false")}get bitRateAdapter(){if(!this.player||!this.player.plugins)return null;if(this.config.needAutoBitrate){let{bitrateselector:e}=this.player.plugins;return e}return null}getDefinitonFromAdapter(e,t){if(!this.bitRateAdapter)return null;let i=this.bitRateAdapter;return i.getSuitableBitrate?i.getSuitableBitrate(e,t):i.bitRateAdapter?i.bitRateAdapter.select(e):null}addPreloader(e={}){e.playerId=this.playerId;let{preloader:t}=this.player;t?t.addPreloader(e,this.playerConfig.vid,this.playerId):this.log(ev.f.LOG,"preloader has destroyed")}addPreloaderList(e=[]){let{preloader:t}=this.player;t?t.addPreloaderList(e,this.playerConfig.vid,this.playerId):this.log(ev.f.LOG,"preloader has destroyed")}log(e,t,...i){let{vid:r}=this.playerConfig||{},s=r?`[Index]${r} ${t}`:`[Index] ${t}`;iV(this.logger,e,s,...i)}_emitInitFail(e){this.log(ev.f.ERROR,"initFail, reason:",e),this.emit(ip.INIT_FAIL,e)}set useVideoLoad(e){this._useVideoLoad=e}get useVideoLoad(){return this._useVideoLoad}get ready(){return this._allInitPromise}get speed(){return parseInt(rm.speed,10)}get version(){return ix}get realTimeSpeed(){return sw}get opQueueLen(){let e=this.mse&&this.mse._queue?this.mse._queue[ey.Ub.VIDEO]:[];return e?e.length:0}get loadSegmentTimeRange(){if(!this.mp4)return[0,0,0,0];let e=this.mp4.adaptTimeRange;if(e&&e.length>0&&this._curLoadSegmentIdx>=0&&this._curLoadSegmentIdx<e.length){let t=e[this._curLoadSegmentIdx];if(t.isLoading){let e=t.range;return[Number(t.startTime),Number(t.endTime),...e]}}return[0,0,0,0]}get preloadState(){return this.player.preloader&&this.player.preloader.loadingCount}get moovSize(){return 0}get isDestroy(){return!this.player}cancelPreloadTask(){this.preloader&&this.preloader.cancelLoading(this.player.playerId)}removeAllPreloadData(){this.preloader&&this.preloader.removeAll()}removeAllPreloadTask(){this.preloader&&this.preloader.removeAllPreloadTask()}get domain(){return iY(this.loadURL)}get loadURL(){let{player:e}=this,t=e.currentSrc;return/^blob/.test(e.currentSrc)&&(t=this.mp4.currentLoadUseUrl()),t}get abrInstance(){return this._abrService?this._abrService.abrInstance:null}_handleUrlExpire(){let{config:e,player:t}=this,{paused:i}=t;new Date().getTime()/1e3>=this.urlExpireTimestamp&&this.urlExpireTimestamp>0&&!i&&e.getServerTime&&(t.serverTimeDiffPromise=t.serverTimeDiffPromise||e.getServerTime().catch(()=>0),t.serverTimeDiffPromise.then(e=>{if(e&&(t.serverTimeDiff=new Date().getTime()/1e3-e),new Date().getTime()/1e3>=this.urlExpireTimestamp+t.serverTimeDiff){this.urlExpireTimestamp=new Date().getTime()/1e3+86400;let e=new iD("network",iC["403"]);this._emitExpireEvent(e)}}))}_emitExpireEvent(e){let{player:t}=this,i=new Date().getTime()/1e3;return this.emitExpireTimestamp?i-this.emitExpireTimestamp>300&&(this.emitExpireTimestamp=i,t.emit("MEDIA_EXPIRED",e),!0):(this.emitExpireTimestamp=i,t.emit("MEDIA_EXPIRED",e),!0)}reportBugPostPlayerLog(){this.emit(sy)}}sC.isSupported=function(){return rA()&&ry()&&!r_()},sC.isEMESupported=rv,sC.isSupportedWithXgmse=function(){return ry()&&!r_()},sC.isMediaSourceSupported=rA,sC.isWebAssemblySupported=ry,sC.CUSTOM_EVENTS=ip},64455:function(e,t,i){"use strict";let r;i.d(t,{$b:function(){return f},HZ:function(){return p},Hg:function(){return h},MD:function(){return w},bk:function(){return C},vB:function(){return s},vV:function(){return c},z7:function(){return L}});let s=Object.freeze(Object.defineProperty({__proto__:null,getFilename:function(e){let t,i=e.split("?")[0],r=i&&i.split("/");for(;r&&r.length;)if(t=r.pop())return t}},Symbol.toStringTag,{value:"Module"})),n=e=>e<10?"0"+e:e,a=(e,t=!1)=>{let i=[],r=Math.floor(e/1e3),s=Math.floor(r/60),a=Math.floor(s/24);return r-=60*s,s-=24*a,a&&i.push(n(a)),i.push(n(s)),i.push(n(r)),t?i.join(":")+"."+(e/1e3).toFixed(3).split(".").pop():i.join(":")},o=Date.now(),l=()=>window.performance?performance.now():Date.now()-o,h=Object.freeze(Object.defineProperty({__proto__:null,format:n,getPerformanceNow:l,toHHMMSSDuration:a},Symbol.toStringTag,{value:"Module"})),d=e=>"[object Object]"===Object.prototype.toString.call(e),u=(e,t)=>{let i=Object.assign({},e);return Object.keys(t).forEach(r=>{if(void 0===e[r]){let e=t[r];d(i[r])&&d(e)?i[r]=u(i[r],e):i[r]=e}}),i},c=Object.freeze(Object.defineProperty({__proto__:null,combineDefaultOptions:u,isNumber:e=>"number"==typeof e,isObject:d,isString:e=>"string"==typeof e},Symbol.toStringTag,{value:"Module"})),p=()=>!!("u">typeof window&&window.document);var f=((r=f||{})[r.TRACE=0]="TRACE",r[r.DEBUG=1]="DEBUG",r[r.LOG=2]="LOG",r[r.INFO=3]="INFO",r[r.WARN=4]="WARN",r[r.ERROR=5]="ERROR",r);let m={trace:0,debug:1,log:2,info:3,warn:4,error:5},g={0:"",1:"gray",2:"",3:"lightblue",4:"",5:""},_=[],v=4,y=0,A=!1,T=2e3,b=[],S=0,E=Object.keys(m),k=new Map;class P{constructor(e,t){this.__level=v,this.__mode=y,this.__styled=A,this.__name=e,"number"==typeof t?this.__id=t:(this.__id=(k.get(e)||0)+1,k.set(e,this.__id)),this.__apply(),_.push(this)}formatArgs(e,t,i){if(!this.__styled)return i.unshift(t),i;let r=[`%c${t}`],s=[`color:${g[e]}`];return i.forEach(e=>{"number"==typeof e?(e%1==0?r.push("\x1b[35;2;200;80;244m%d\x1b[39m"):r.push("\x1b[35;2;200;80;244m%f\x1b[39m"),s.push(e)):e instanceof Node?(r.push("%o"),s.push(e)):"object"==typeof e?(r.push("%O"),s.push(e)):r.push(e)}),s.unshift(r.join(" ")),s}__apply(){1===this.__mode?E.forEach(e=>{m[e]>=this.__level&&(this[e]=(...t)=>{let i=`[${a(l(),!0)}][${e}][${this.__name}:${this.__id}]`;b.push({id:S++,level:e,name:this.__name,prefix:i,timestamp:Date.now(),message:t.join(" ")}),b.length>T&&b.shift()})}):0===this.__mode&&E.forEach(e=>{let t=m[e];t>=this.__level&&(this[e]=(...i)=>{var r;let s=`[${a(l(),!0)}][${e}][${this.__name}](${this.__id})`;null==(r=console[e])||r.apply(console,this.formatArgs(t,s,i))})})}getLevel(){return this.__level}trace(){}debug(){}log(){}info(){}warn(){}error(){}setName(e){this.__name=e}setMode(e){this.__mode=e,this.__apply()}setLevel(e){this.__level=e,this.__apply()}setStyled(e){this.__styled=e}reset(){this.__level=4,this.__mode=0}}let w={createLogger:(e,t)=>new P(e,t),getLogs:()=>b,setSize(e){T=e},setMode(e){y=e,_.forEach(t=>t.setMode(e))},setLevel(e){v=e,_.forEach(t=>t.setLevel(e))},setStyled(e){A=e,_.forEach(t=>t.setStyled(e))},reset(){_.forEach(e=>e.reset()),b=[]}};try{let e=p(),t=e?localStorage.getItem("ttplayer_logger_level"):"",i=e?localStorage.getItem("ttplayer_logger_mode"):"",r=e?localStorage.getItem("ttplayer_logger_styled"):"";"string"==typeof t&&w.setLevel(parseInt(t,10)),"string"==typeof i&&w.setMode(parseInt(i,10)),("1"===r||"true"===r)&&w.setStyled(!0)}catch{}let x=class{constructor(){this._eventMap=new Map,this._blockMap=new Map}emit(e,...t){let i=this._eventMap.get(e),r=!0;if(i)for(let e=0,s=i.length;e<s;e++)!1===i[e].apply(this,t)&&(r=!1);return r}once(e,t){let i=(...r)=>(this.off(e,i),t.apply(this,r));this.on(e,i)}dedup(e,t){let i=this._eventMap.get(e);i?i.every(e=>e!==t)&&i.push(t):this._eventMap.set(e,[t])}on(e,t){this._eventMap.has(e)?this._eventMap.get(e).push(t):this._eventMap.set(e,[t])}off(e,t){this._eventMap.has(e)&&(t?this._eventMap.set(e,this._eventMap.get(e).filter(e=>e!==t)):this._eventMap.delete(e)),this._blockMap.has(e)&&(t?this._blockMap.set(e,this._blockMap.get(e).filter(e=>e!==t)):this._blockMap.delete(e))}removeAllListeners(){this._eventMap.clear(),this._blockMap.clear()}block(...e){e.forEach(e=>{let t=this._eventMap.get(e);t&&(this._blockMap.set(e,t),this._eventMap.delete(e))})}unblock(...e){e.forEach(e=>{let t=this._blockMap.get(e);t&&(this._eventMap.set(e,t),this._blockMap.delete(e))})}};x.remap=(e,t,i)=>Object.keys(i).map(r=>{let s=(...e)=>t.emit(i[r],...e);return e.on(r,s),()=>e.off(r,s)}),x.throttle=(e,t,i,r)=>{let s,n,a=new Map;t.forEach(t=>{e.on(t,()=>{s!==t&&(i.includes(t)?void 0!==(n=a.get(t))?a.set(t,n+1):(a.set(t,1),r("dedup:"+t)):(a.clear(),r(t))),s=t})})};let C=x;class L extends C{constructor(e={}){super(),this._lastUpdateTime=0,this._cacheSpeeds=[],this._logger=w.createLogger("network-speed"),this._timeout=6e5,this._unit=1024,this._timeout=e.timeout||this._timeout}_calculateSpeed(e,t){let i=e/this._unit/t;if(i<=0||i===1/0)return void this._logger.debug(`invalid speed: ${i}`);this._cacheSpeeds.push(i),this._cacheSpeeds.length>10&&this._cacheSpeeds.shift(),this.emit("downloaded",{byteSpeed:i,byteLength:e,duration:t,timescale:1})}start(){this._lastUpdateTime=l()}download(e){let t=l(),i=(t-this._lastUpdateTime)/1e3;if(this._lastUpdateTime=t,i>this._timeout)return void this._logger.warn(`time diff: ${i}`);this._calculateSpeed(e,i)}getAverageSpeed(){return this._cacheSpeeds.reduce((e,t)=>e+t,0)/this._cacheSpeeds.length}getLatestSpeed(){return this._cacheSpeeds[this._cacheSpeeds.length-1]}reset(){this._cacheSpeeds=[],this._lastUpdateTime=0}}},37265:function(e,t,i){"use strict";let r,s,n,a,o,l,h,d,u,c,p,f,m,g,_,v,y,A,T;i.d(t,{Lw:function(){return e6},RC:function(){return te},WT:function(){return e5},_s:function(){return M},cD:function(){return tl},hV:function(){return e4},ln:function(){return e2},o8:function(){return Y},rE:function(){return th},rP:function(){return P},t8:function(){return E}});var b=i(64455),S=i(10067);let E=new class{constructor(){this._config={maxCount:0,maxByteSize:0x1400000},this._logger=b.MD.createLogger("cache"),this._currByteSize=0,this.infoMap=new Map,this.segMap=new Map}_checkSizeAndShift(){let{maxCount:e,maxByteSize:t}=this._config;for(;e>0&&this.segMap.size>e||t>0&&this._currByteSize>t;){let e=this.segMap.keys().next().value;e&&this.extract(e)}}setConfig(e){Object.assign(this._config,e)}extract(e){let t=this.segMap.get(e);return t&&(this.infoMap.delete(e),this.segMap.delete(e),this._currByteSize-=t.reduce((e,t)=>e+t.data.buffer.byteLength,0)),t}getCacheKeys(){return Array.from(this.segMap.keys())}getSegments(e,t,i=1/0){let r=this.segMap.get(e),s=[];if(!r)return s;if(void 0===t)return r;if(t>=i||0===r.length)return s;let n=0,a=r.length-1,o=-1;for(;n<=a;){let e=n+Math.floor((a-n)/2),i=r[e],s=i.pos+i.data.length;if(t>=i.pos&&t<s){o=e;break}t<i.pos?a=e-1:n=e+1}if(-1===o)return s;let l=o,h=i-t,d=t-r[o].pos;for(let e=l;e<r.length;e++){let n=r[e];if(n.pos>i)break;if(n.pos<t)d=t-n.pos,s.push({...n,pos:t,data:n.data.subarray(d,d+h)});else if(n.pos+n.data.byteLength>i+1){s.push({...n,data:n.data.subarray(0,n.pos+n.data.byteLength-(i+1))});break}else s.push(n)}return s}getSegmentsBySrc(e){if(b.vV.isString(e)||!e.entries||!e.entries.length)return this.getSegments(S.n9.getCacheKey(e));{let t=[];return e.entries.forEach(e=>{this.getSegments(S.n9.getCacheKey(e)).forEach(e=>t.push(e))}),t}}get(e){return{segments:this.segMap.get(e),info:this.infoMap.get(e)}}has(e){return this.segMap.has(e)}add(e,t){let i=this.segMap.get(e);if(i){let r=i[i.length-1];r&&r.pos+r.data.byteLength!==t.pos?(this.segMap.delete(e),this.segMap.set(e,i)):(i.push(t),this._currByteSize+=t.data.buffer.byteLength)}else e&&(0===t.pos?(this.segMap.set(e,[t]),this._currByteSize+=t.data.buffer.byteLength,this._checkSizeAndShift()):this._logger.warn("invalid first data segment pos: expected 0, got",t.pos))}setCacheInfo(e,t){this.infoMap.set(e,t)}getCacheInfo(e){return this.infoMap.get(e)}remove(e){this.extract(e)}clearAll(){this.segMap.clear(),this.infoMap.clear(),this._currByteSize=0}};(0,b.HZ)()&&"1"===localStorage.getItem("ttplayer_cache_debug")&&(window.__TTPlayerGlobalCache__=E);var k=((r=k||{})[r.IDLE=0]="IDLE",r[r.LOAD_STARTED=1]="LOAD_STARTED",r[r.LOAD_COMPLETED=2]="LOAD_COMPLETED",r[r.SUSPENDED=3]="SUSPENDED",r[r.ERROR=4]="ERROR",r),P=((s=P||{})[s.DEFAULT=0]="DEFAULT",s[s.PRELOAD=1]="PRELOAD",s);class w extends b.bk{constructor(e={}){super(),this._status=0,this._tickTimer=-1,this.$src="",this.$srcIndex=0,this.network=new b.z7,this.pos=0,this.loadedCacheSize=0,this.store=e=>{let t=S.n9.getCacheKey(this.$src);E.getCacheInfo(t)||E.setCacheInfo(t,{total:this.total,extra:S.n9.getProps(this.$src).extra}),E.add(t,e)},this.$options=b.vV.combineDefaultOptions(e,{origin:0,timeout:6e4,recovery:!0,splitRequest:!1}),this.total=e.total||1/0,b.bk.remap(this.network,this,{downloaded:"downloaded"})}get currentSrcIndex(){return this.$srcIndex}get currentUrl(){return S.n9.getUrl(this.$src,this.$srcIndex)}$processErrorAndFallback(e,t){if("AbortError"===e.name)return void this.$changeStatus(2);this.$cancel();let i=new S.Mk(e.code||S.Mk.Code.NETWORK,e.message,e.extra);if(!1!==this.$options.recovery&&S.n9.isMultiple(this.$src)&&this.$srcIndex<this.$src.urls.length-1&&this.pos<this.total)return this.$srcIndex++,this.$logger.warn(e),this.emit("exception",i),this.$changeStatus(0),this.loadRange(this.pos,t.end,t.unStreaming);this.$changeStatus(4),this.$logger.error(e),this.emit("error",i)}$loadInitSegmentCache(e,t){let i=S.n9.getCacheKey(this.$src),r=E.getSegments(i,e,t);if(r&&r.length){let e=E.getCacheInfo(i);e&&(this.total=e.total);let s=!0,n=0;0===r[0].pos&&(this.loadedCacheSize=0);for(let e=0;e<r.length;e++){let i=r[e];if(n+=i.data.byteLength,this.pos=i.pos+i.data.byteLength,this.emit("loadeddata",i),this.pos>=t||this.pos>=this.total?(this.$changeStatus(2),this.emit("loadend"),s=!1):s=1===this.status,!s)break}return this.$logger.info("load hitcache, pos=",this.pos,"cachesize=",n),this.loadedCacheSize+=n,{loading:s,loadedCacheSize:n}}}$waitForNextTick(e=0){return new Promise(t=>{this._tickTimer=window.setTimeout(t,e)})}$changeStatus(e){this.status!==e&&(this.$logger.info(`loader status, ${k[this.status]} -> ${k[e]}`),this._status=e)}$getFinalRequestParams(e,t){let{onBeforeRequest:i}=this.$options;if(i){let r=i(this.currentUrl,t);r&&(e=r.url||e,t=r.params||t)}return{requestURL:e,requestParams:t}}changeOptions(e){e&&(this.$options=b.vV.combineDefaultOptions(e,this.$options))}getOptions(){return this.$options}get status(){return this._status}jump(e){this.pos=e}load(e,t,i,r){return this.reset(),this.$src=e,this.loadRange(t,i,r)}reset(){this.abort(),window.clearTimeout(this._tickTimer),this.pos=0,this.total=1/0,this.$src="",this.$srcIndex=0,this.network.reset(),this.loadedCacheSize=0}destroy(){this.network.removeAllListeners(),this.removeAllListeners(),this.reset()}}let x=512e3,C="fetch",L=class extends w{constructor(){super(...arguments),this.$logger=b.MD.createLogger(C),this.__timeoutTimer=-1,this.fetching=!1,this.__uint8=async(e,t)=>{let i=await e.arrayBuffer(),r=new Uint8Array(i),s=this.pos;return this.pos+=r.byteLength,this.network.download(r.byteLength),this.emit("loadeddata",{origin:this.$options.origin,pos:s,data:new Uint8Array(i)}),this.__loadEnd(t),!0},this.__read=async(e,t)=>{for(this.__reader=e;;){let i=await e.read();if(!this.__reader)return;if(i.done)return void this.__loadEnd(t);{let e=this.pos;this.pos+=i.value.byteLength,this.network.download(i.value.byteLength),this.emit("loadeddata",{origin:this.$options.origin,pos:e,data:i.value})}}},this.__splitFetch=async(e,t,i)=>{var r;let s=this.$options.resetFetchingWhenCanceled,n={},a=e>0||t<1/0,o=this.total-1,l=Math.min(o,t);a&&(n.Range=`bytes=${e}-${l===o?"":l}`);let{timeout:h,credentials:d}=this.$options,{requestURL:u,requestParams:c}=this.$getFinalRequestParams(this.currentUrl,{method:"GET",headers:n,credentials:d}),p=s?null==(r=this.__scope)?void 0:r.fetching:this.fetching;if(this.$logger.info(`load asyncinfo, status=${k[this.status]}, fetching=${p}`),this.status!==k.LOAD_STARTED||p)return;this.__abortController=new AbortController,c.signal=this.__abortController.signal,this.network.start(),this.$logger.info(`load start, range=${n.Range||""}, total=${this.total}, credentials=${c.credentials}, cacheKey:${S.n9.getCacheKey(this.$src)}, filename=${b.vB.getFilename(u)}, url=${u}`),this.emit("loadstart");let f={url:u,reqHeaders:n,resHeaders:{}},m=[];void 0!==h&&m.push(new Promise((e,t)=>{this.__timeoutTimer=window.setTimeout(()=>{t(new S.Mk(S.Mk.Code.NETWORK_TIMEOUT,"Request timed out, please try again",f))},h)})),this.__scope={fetching:!0};let g=s?this.__scope:this,_=fetch(u,c);return s||(_=_.finally(()=>{g.fetching=!1,window.clearTimeout(this.__timeoutTimer)})),m.push(_=_.then(t=>{var r;if(window.clearTimeout(this.__timeoutTimer),f.resHeaders=t.headers,403===t.status)throw new S.Mk(S.Mk.Code.NETWORK_FORBIDDEN,t.statusText,f);if(a&&(416===t.status||200===t.status)&&this.total===1/0)this.$logger.warn(`loadRange, ${t.status}, pos=${this.pos}`),this.total=this.pos,this.emit("loadeddata",{origin:this.$options.origin,pos:this.pos,data:new Uint8Array}),this.__loadEnd(i.isLastSplit);else if(t.status>=200&&t.status<300){if(this.pos=e,a){let i=t.headers.get("Content-Range");if(i)this.total=Number(null==(r=i.split("/"))?void 0:r[1])||this.total;else if(this.$options.autoCaculateTotal){let i=Number(t.headers.get("Content-Length"));i<l-e+1&&(this.total=e+i)}}else this.total=Number(t.headers.get("Content-Length"))||this.total;if(t.body)return i.unStreaming?this.__uint8(t,i.isLastSplit):this.__read(t.body.getReader(),i.isLastSplit);throw new S.Mk(S.Mk.Code.NETWORK,"media stream data does not exist",f)}else throw new S.Mk(S.Mk.Code.NETWORK,t.statusText,f)})),s?Promise.race(m).finally(()=>{window.clearTimeout(this.__timeoutTimer),g.fetching=!1}):Promise.race(m)},this.__splitRequest=async(e,t,i=x)=>{let r=e;for(;;){if(r>=t)return;let e=Math.min(t,r+i-1);if(await this.__splitFetch(r,e,{isLastSplit:e>=t}),r===this.pos||this.pos>=t||this.pos>=this.total||(r=this.pos,await this.$waitForNextTick(10),this.status!==k.LOAD_STARTED))return}}}static isSupported(){return"u">typeof AbortController&&"u">typeof ReadableStream}$cancel(){this.$options.resetFetchingWhenCanceled&&(this.__scope=void 0,this.fetching=!1),clearTimeout(this.__timeoutTimer),this.__reader&&(this.__reader.cancel(),this.__reader=void 0),this.__abortController&&(this.__abortController.abort(),this.__abortController=void 0)}__loadEnd(e){this.__reader=void 0,this.__abortController=void 0,e&&(this.$changeStatus(k.LOAD_COMPLETED),this.emit("loadend"))}async loadRange(e=0,t=1/0,i){if(this.status===k.LOAD_STARTED)return;if(e>this.total)return void this.$logger.warn(`loadRange, start > total, start=${e} total=${this.total}`);if(e===this.total)return;this.$logger.info(`load before, start=${e}, end=${t}`),this.$changeStatus(k.LOAD_STARTED);let r=this.$loadInitSegmentCache(e,t);if(r)if(!r.loading)return!0;else r.loadedCacheSize>0&&(e=this.pos);let{splitRequest:s}=this.$options;return(!i&&(!0===s||b.vV.isNumber(s)&&s>0)?!0===s?this.__splitRequest(e,t):this.__splitRequest(e,t,s):this.__splitFetch(e,t,{unStreaming:i,isLastSplit:!0})).catch(e=>this.$processErrorAndFallback(e,{end:t,unStreaming:i}))}changeName(e){this.$logger.setName(e+"."+C)}resume(){return this.status===k.SUSPENDED||this.status===k.LOAD_COMPLETED?this.loadRange(this.pos):Promise.resolve()}suspend(){this.status===k.LOAD_STARTED&&(this.$logger.info(`suspend, cacheKey=${S.n9.getCacheKey(this.$src)}, url=${this.currentUrl}`),this.$cancel(),this.$changeStatus(k.SUSPENDED))}abort(){this.status!==k.IDLE&&(this.$logger.info(`abort, cacheKey=${S.n9.getCacheKey(this.$src)}, url=${this.currentUrl}`),this.$cancel(),this.$changeStatus(k.IDLE))}};L.loaderName=C;let D=class extends w{constructor(){super(...arguments),this.$logger=b.MD.createLogger("xhr"),this.__ajax=(e,t,i)=>{this.__fetching=!1;let{credentials:r,timeout:s}=this.$options,n=e>0||t<1/0,a={};if(n){let i=this.total-1,r=Math.min(i,t);a.Range=`bytes=${e}-${r===i?"":r}`}let{requestURL:o,requestParams:l}=this.$getFinalRequestParams(this.currentUrl,{credentials:r,headers:a}),h={url:o,reqHeaders:a,resHeaders:{}};return new Promise((e,t)=>{if(this.$logger.info(`load asyncinfo, status=${k[this.status]}, fetching=${this.__fetching}`),this.status!==k.LOAD_STARTED||this.__fetching)return;this.$logger.info(`load start, range=${a.Range||""}, credentials=${l.credentials}, cacheKey:${S.n9.getCacheKey(this.$src)}, filename=${b.vB.getFilename(o)}, url=${o}`);let r=this.__xhr=new XMLHttpRequest;r.open("GET",o,!0),r.withCredentials="include"===l.credentials,r.responseType="arraybuffer",r.onreadystatechange=()=>{var e,i;r.readyState===XMLHttpRequest.HEADERS_RECEIVED&&(r.status>=200&&r.status<300?this.total===1/0&&(n?this.total=Number(null==(i=null==(e=r.getResponseHeader("Content-Range"))?void 0:e.split("/"))?void 0:i[1])||this.total:this.total=Number(r.getResponseHeader("Content-Length"))||this.total):403===r.status?t(new S.Mk(S.Mk.Code.NETWORK_FORBIDDEN,r.statusText,h)):t(new S.Mk(S.Mk.Code.NETWORK,r.statusText,h)))},r.onload=()=>{h.resHeaders=(e=>{let t={};return e.split(`
`).forEach(e=>{let[i,r]=e.split(": ");t[i]=(r||"").trim()}),t})(r.getAllResponseHeaders()),e(new Uint8Array(r.response))},r.onerror=()=>{t(new S.Mk(S.Mk.Code.NETWORK,r.statusText,h))},r.ontimeout=()=>{t(new S.Mk(S.Mk.Code.NETWORK_TIMEOUT,"Request timed out, please try again",h))},r.onabort=()=>{let e=Error("Request aborted");e.name="AbortError",t(e)},r.onloadend=()=>{i&&this.$changeStatus(k.LOAD_COMPLETED),this.emit("loadend")},r.timeout=s||0,this.network.start(),this.__fetching=!0,this.emit("loadstart"),Object.keys(a).forEach(e=>r.setRequestHeader(e,a[e])),r.send()})},this.__splitRequest=async(e,t,i)=>{let{splitRequest:r}=this.$options,s=b.vV.isNumber(r)&&r>0?r:512e3,n=i?t-e-1:s,a=e;for(;;){if(a>=t)return;let e=Math.min(t,a+n-1),i=await this.__ajax(a,e,e>=t);if(!this.__xhr)return;if(this.network.download(i.byteLength),a+=i.byteLength,this.total===1/0&&i.byteLength<n&&(this.total=a),this.pos=a,this.emit("loadeddata",{origin:this.$options.origin,pos:a-i.byteLength,data:i}),a>=this.total||a>=t||0===i.byteLength)return!0;if(await this.$waitForNextTick(10),this.status!==k.LOAD_STARTED)return}}}$cancel(){this.__xhr&&(this.$options.resetFetchingWhenCanceled&&(this.__fetching=!1),this.__xhr.abort(),this.__xhr=void 0)}async loadRange(e=0,t=1/0,i){if(this.status===k.LOAD_STARTED)return;if(e>this.total)return void this.$logger.warn(`loadRange, start > total, start=${e} total=${this.total}`);if(e===this.total)return;this.$logger.info(`load before, start=${e}, end=${t}`),this.$changeStatus(k.LOAD_STARTED);let r=this.$loadInitSegmentCache(e,t);if(r)if(!r.loading)return;else r.loadedCacheSize>0&&(e=this.pos);return this.__splitRequest(e,t,i).catch(i=>this.$processErrorAndFallback(i,{start:e,end:t}))}changeName(e){this.$logger.setName(e+".xhr")}resume(){return this.status===k.SUSPENDED||this.status===k.LOAD_COMPLETED?this.loadRange(this.pos):Promise.resolve()}suspend(){this.status===k.LOAD_STARTED&&(this.$logger.info(`suspend, url=${this.currentUrl}`),this.$cancel(),this.$changeStatus(k.SUSPENDED))}abort(){this.status!==k.IDLE&&(this.$logger.info(`abort, url=${this.currentUrl}`),this.$cancel(),this.$changeStatus(k.IDLE))}};D.loaderName="xhr";let I=L.isSupported()?L:D,R=I,O=e=>{R=e||I},M=()=>R.loaderName,B=b.MD.createLogger("mutex",1/0),N=[],U=(0,b.HZ)()&&"1"===localStorage.getItem("ttplayer_mutex_debug");U&&(window.__TTPlayerMutexList__=N);class F{constructor(e){this._resolves=[],this._rejects=[],this.name=e,U&&N.push(this)}get locked(){return this._resolves.length>0}lock(){return new Promise((e,t)=>{this._resolves.push(e),this._rejects.push(t)})}unlock(e){this._resolves.length&&(this._rejects.shift(),this._resolves.shift()(e))}unlockAll(e){for(;this._resolves.length;)this._rejects.shift(),this._resolves.shift()(e)}throw(e){this._rejects.length&&(this._resolves.shift(),this._rejects.shift()(e))}releaseLock(){this._resolves.length&&B.log(`releaseLock, name=${this.name}`),this._resolves=[],this._rejects=[]}}var V=((n=V||{})[n.EMPTY=0]="EMPTY",n[n.LOW=1]="LOW",n[n.NORMAL=2]="NORMAL",n[n.HIGH=3]="HIGH",n[n.FULL=4]="FULL",n);class $ extends b.bk{constructor(e,t){super(),this._currSize=0,this._queue=[],this._changeLevel=e=>{if(this.level!==e){let t=this.level;this.level=e,this.emit("levelchange",e,t)}},this._estimatedMaxSize=t,this.level=0,this._readMutex=new F(e+".queue.read"),this._writeMutex=new F(e+".queue.write")}static caculateLevel(e,t,i){return i?e>=t?4:e>=.7*t?3:e>=.3*t?2:+(e>0):e<1e-5?0:e<=.3*t?1:e<=.7*t?2:e<t?3:4}_calculateLevel(e,t){this._eachSizeAlgorithm?(t?this._currSize+=this._eachSizeAlgorithm(e):this._currSize-=this._eachSizeAlgorithm(e),this._changeLevel($.caculateLevel(this._currSize,this._estimatedMaxSize,t))):this._changeLevel($.caculateLevel(this._queue.length,this._estimatedMaxSize,t))}get size(){return this._eachSizeAlgorithm?this._currSize:this._queue.length}setMaxSize(e){this._estimatedMaxSize=e}setEachSizeAlgorithm(e){this._eachSizeAlgorithm=e}write(e){if(this._readMutex.locked)this._readMutex.unlock(e);else if(this._queue.push(e),this._calculateLevel(e,!0),4===this.level)return this._writeMutex.lock()}first(){return this._queue[0]}getAll(){return this._queue}read(){this._writeMutex.unlock();let e=this._queue.shift();return e&&this._calculateLevel(e,!1),e||this._readMutex.lock()}clear(){this._queue=[],this._currSize=0,this._changeLevel(0),this._writeMutex.unlock()}releaseRead(){this._readMutex.releaseLock()}releaseWrite(){this._writeMutex.releaseLock()}releaseLock(){this._writeMutex.releaseLock(),this._readMutex.releaseLock()}reset(){this.clear(),this.releaseLock()}}let z=(0,b.HZ)()&&window.queueMicrotask?window.queueMicrotask.bind(window):e=>Promise.resolve().then(e),j=0;class G{static microTask(e){return z(e)}static create(e){let{type:t="macro",title:i,onLoop:r,onError:s}=e,n=!0,a=-1,o=j++,l=b.MD.createLogger("coroutine",j),h={title:i,id:o,get running(){return n},cancel(){l.log(i,a,"canceled"),n=!1,window.clearTimeout(a)}},d=e=>{h.cancel(),l.error(i,a,"onLoop error",e),e instanceof S.Mk?s(e):s(new S.Mk(S.Mk.Code.OTHER,e.message))};return"macro"===t?(l.log(i,"created with macro task"),function e(){n&&(a=window.setTimeout(()=>r(h).then(e).catch(d),0))}()):(l.log(i,"created with micro task"),function e(){n&&z(()=>r(h).then(e).catch(d))}()),h}}class H extends b.bk{constructor(e){super(),this._pipeTargets=[],this.name=e}changeName(e){this.name=e}_unsetPipeCoroutine(){var e;null==(e=this._pipeCoroutine)||e.cancel(),this._pipeCoroutine=void 0}pipe(e,t){return this._pipeTargets.push(e),this._pipeCoroutine||(this._pipeCoroutine=G.create({title:this.name+" --pipe--\x3e "+this._pipeTargets.map(e=>e.name).join("/"),onLoop:async()=>{let e=await this.read();for(let i of this._pipeTargets)await i.write(t?t(e):e)},onError:e=>this.emit("error",e)})),e}unpipe(e){return this._pipeTargets=this._pipeTargets.filter(t=>t!==e),0===this._pipeTargets.length&&this._unsetPipeCoroutine(),e}destroy(){this.removeAllListeners(),this._pipeTargets=[],this._unsetPipeCoroutine()}}let W=class extends H{constructor(e){super(e),this.size=1,this.stdout=new $(this.name,this.size)}read(){return this.stdout.read()}flush(){this.stdout.clear()}destroy(){super.destroy(),this.stdout.removeAllListeners(),this.stdout.reset(),this.flush()}};class q extends b.bk{constructor(e){super(),this.size=1,this.name=e,this.stdin=new $(this.name,this.size)}write(e){return this.stdin.write(e)}flush(){this.stdin.clear()}destroy(){this.removeAllListeners(),this.stdin.removeAllListeners(),this.stdin.reset(),this.flush()}}class K extends H{constructor(e){super(e),this.size=1,this.stdin=new $(this.name,this.size),this.stdout=new $(this.name,this.size)}_unsetCoroutine(){var e;null==(e=this._coroutine)||e.cancel(),this._coroutine=void 0}write(e){return this.stdin.write(e)}read(){return this.stdout.read()}suspend(){this.stdin.releaseRead(),this.stdout.releaseWrite(),this._unsetCoroutine()}resume(){this._unsetCoroutine(),this._coroutine=G.create({title:this.name+".transform",onLoop:async()=>{let e=await this.stdin.read(),t=await this.$transform(e);t&&await this.stdout.write(t)},onError:e=>this.emit("error",e)})}flush(){this.stdin.clear(),this.stdout.clear()}destroy(){super.destroy(),this.stdin.removeAllListeners(),this.stdout.removeAllListeners(),this.stdin.reset(),this.stdout.reset(),this._unsetCoroutine(),this.flush()}}var Y=((a=Y||{}).FLV="FLV",a.MP4="MP4",a.HLS="HLS",a.DASH="DASH",a),X=((o=X||{}).VIDEO="video",o.AUDIO="audio",o.UNKNOWN="unknown",o),Q=((l=Q||{}).LoadedMetadata="loadedmetadata",l.LoadedPackets="loadedpacket",l);class J{constructor(e,t,i){this.dv=new DataView(e),this.start=this.offset=t||this.dv.byteOffset,this.end=i?this.start+i:this.dv.byteLength}static fromUint8(e){return new J(e.buffer,e.byteOffset,e.byteLength)}static concatUint8s(e){let t=new Uint8Array(e.reduce((e,t)=>e+t.byteLength,0)),i=0;return e.forEach(e=>{t.set(e,i),i+=e.byteLength}),t}static concatUint8(...e){return this.concatUint8s(e)}get delta(){return this.offset-this.start}get buffer(){return this.dv.buffer}get unreadLength(){return Math.max(this.end-this.offset,0)}get size(){return this.end-this.start}readFloat(e){let t=0;switch(e){case 4:t=this.dv.getFloat32(this.offset);break;case 8:t=this.dv.getFloat64(this.offset);break;default:throw Error(`read ${e}-byte float is not supported`)}return this.offset+=e,t}back(e){this.offset-=e}skip(e){this.offset+=e}readInt(e){let t=this.offset;switch(this.offset+=e,e){case 1:return this.dv.getInt8(t);case 2:return this.dv.getInt16(t);case 4:return this.dv.getInt32(t);default:throw Error(`read ${e}-byte integers is not supported`)}}read(e){let t=this.offset;switch(this.offset+=e,e){case 1:return this.dv.getUint8(t);case 2:return this.dv.getUint16(t);case 3:return(this.dv.getUint16(t)<<8)+this.dv.getUint8(t+2);case 4:return this.dv.getUint32(t);default:return this.back(e-4),this.read(e-4)+this.dv.getUint32(t)*Math.pow(256,e-4)}}write(e,t){let i=this.offset;switch(this.offset+=e,e){case 1:return this.dv.setUint8(i,t);case 2:return this.dv.setUint16(i,t);case 3:return this.dv.setUint8(i,t>>>16),this.dv.setUint16(i+1,65535&t);case 4:return this.dv.setUint32(i,t);default:throw Error(`write ${e}-byte integers is not supported`)}}writeString(e){let t=e.length;for(let i=0;i<t;i++)this.dv.setUint8(this.offset+i,e.charCodeAt(i));this.offset+=t}readToBuffer(e){let t;return t=this.offset||e?this.dv.buffer.slice(this.offset,e?this.offset+e:this.end):this.dv.buffer,this.offset+=t.byteLength,t}readToUint8(e){let t=new Uint8Array(this.dv.buffer,this.offset,e||this.unreadLength);return this.offset+=t.byteLength,t}readString(e){let t=0,i="";for(;t<e;t++)i+=String.fromCharCode(this.dv.getUint8(this.offset)),this.offset++;return i}}class Z extends W{constructor(e){var t;super(e.name),this._parsers=[],this._reservedSeekTime=0,this._reservedSegs=[],this._parserOffCallbacks=[],this._handleLevelChange=(e,t)=>{this._logger.info(`demux levelchange: ${t} -> ${e}`),e===V.FULL?this.suspend():e===V.EMPTY&&this.resume()},this._setupOptions=()=>{let e=this._options.maxBufferDuration||0;e>0&&(this.stdout.dedup("levelchange",this._handleLevelChange),this.stdout.setMaxSize(e),this.stdout.setEachSizeAlgorithm(e=>{let t=e.value;return t&&t.type===Q.LoadedPackets?t.payload.reduce((e,t)=>t.type===X.VIDEO?e+t.duration/t.timescale:e,0):0}))},this._handleFirstLoadData=e=>{if(this._reservedSegs.push(e),this._reservedSegs.reduce((e,t)=>e+t.data.byteLength,0)<this._parsers.reduce((e,t)=>Math.max(e,t.maxProbeSize),0))return;this._loader.off("loadeddata",this._handleFirstLoadData);let t=1===this._reservedSegs.length?this._reservedSegs[0]:{...this._reservedSegs[0],data:J.concatUint8s(this._reservedSegs.map(e=>e.data))};this._reservedSegs=[];let i=this._parsers.find(e=>e.probe(t.data));this._setupParser(i)&&(i.setLoader(this._loader),i.parse(t))},this._handleParserLoadedMetadata=e=>{this._logger.info("metadata loaded",e),this.stdout.write({done:!1,value:{type:Q.LoadedMetadata,payload:e}})},this._handleParserLoadedPacket=({data:e})=>{this.stdout.write({done:!1,value:{type:Q.LoadedPackets,payload:e}})},this._handleParserEos=()=>{this.stdout.write({done:!0})},this._options=e,this._logger=b.MD.createLogger(e.name),null!=(t=e.loaderOptions)&&t.resetFetchingWhenCanceled?(this._loader=this._createLoader(),this._parsers=e.parsers):(this._loader=new R(e.loaderOptions),this._loader.changeName(e.name),this._parsers=e.parsers,this._resetLoaderEventListeners()),this._setupOptions()}_setupParser(e){var t;if(e)return this._activeParser?this._activeParser.constructor===e.constructor||(this._logger.info(`parserchange, ${(null==(t=this._activeParser)?void 0:t.name)||"N/A"} -> ${e.name}`),this._unbindParserEvents(this._activeParser),this._bindParserEvents(e)):this._bindParserEvents(e),this._activeParser=e,this._reservedSeekTime>0&&(this._activeParser.seek(this._reservedSeekTime),this._reservedSeekTime=0),!0;{let e="no parser can probe the data";return this._logger.error(e),this.emit("error",new S.Mk(S.Mk.Code.DEMUX_MP4,e)),!1}}_resetLoaderEventListeners(){this._loader.removeAllListeners(),this._loader.on("loadeddata",this._handleFirstLoadData),b.bk.remap(this._loader,this,{error:"error",downloaded:"downloaded",exception:"exception"})}_createLoader(){let e=new R(this._options.loaderOptions);return e.on("loadeddata",this._handleFirstLoadData),e.changeName(this._options.name),b.bk.remap(e,this,{error:"error",downloaded:"downloaded",exception:"exception"}),e}_bindParserEvents(e){e.on("eos",this._handleParserEos),e.on("loadedpackets",this._handleParserLoadedPacket),e.on("loadedmetadata",this._handleParserLoadedMetadata),this._parserOffCallbacks=b.bk.remap(e,this,{cachedone:"cachedone",error:"error",subloaderdownloaded:"downloaded",subloaderexception:"exception"})}_unbindParserEvents(e){this._parserOffCallbacks.forEach(e=>e()),e.off("eos",this._handleParserEos),e.off("loadedpackets",this._handleParserLoadedPacket),e.off("loadedmetadata",this._handleParserLoadedMetadata)}changeName(e){super.changeName(e),this._options.name=e,this._loader.changeName(e),this._logger.setName(e)}changeOptions(e){this._options={...this._options,...e},this._parsers=e.parsers||this._parsers,this._loader.changeOptions(e.loaderOptions),this._setupOptions()}getCacheStats(){var e;return null==(e=this._activeParser)?void 0:e.getCacheStats()}getCurrentSrcIndex(){return this._loader.currentSrcIndex}getCurrentUrl(){return this._loader.currentUrl}getStatus(){return this._activeParser?this._activeParser.status:this._loader.status}load(e){var t;this.flush(),this._reservedSegs=[],this._reservedSeekTime=0,this._activeParser&&(this._activeParser.setLoader(void 0),this._activeParser.reset()),null!=(t=this._options.loaderOptions)&&t.resetFetchingWhenCanceled?(this._loader.destroy(),this._loader=this._createLoader()):this._resetLoaderEventListeners();let i=this._parsers.find(t=>t.match(e));"string"!=typeof e&&"json"===e.dataType?this._setupParser(i)&&(i.setLoader(this._loader),this.emit("loadstart"),i.loadJsonSource(e)):(this.emit("loadstart"),this._loader.load(e))}seek(e){this._activeParser?this._activeParser.seek(e):this._reservedSeekTime=e}suspend(e){this._activeParser?this._activeParser.suspend(e):this._loader.suspend()}resume(){this._activeParser?this._activeParser.resume():this._loader.resume()}abort(){this._activeParser?this._activeParser.abort():this._loader.abort()}flush(){super.flush()}reset(){this.flush(),this._reservedSegs=[],this._reservedSeekTime=0,this._loader.reset()}destroy(){super.destroy(),this.reset(),this._activeParser&&(this._activeParser.destroy(),this._activeParser=void 0),this._parsers.forEach(e=>e.destroy()),this._loader.destroy()}}class ee{constructor(e,t){this.offset=0,this.val=e,this.size=t}static fromByte(e,t){return new ee(e.read(t),t<<3)}toUint8(){let e=this.size/8,t=new Uint8Array(e),i=this.offset;this.offset=0;for(let i=0;i<e;i++)t[i]=this.read(8);return this.offset=i,t}skip(e){this.offset+=e}read(e){let t=this.size-this.offset-e;if(t>=0){let i=0,r=0;if(this.offset+=e,this.size>31){for(;r<e;r++)i+=Math.pow(2,r);return this.val/Math.pow(2,t)&i}for(;r<e;r++)i+=1<<r;return this.val>>>t&i}throw Error("the number of the read operation exceeds the total length limit of bits")}write(e,t){let i=this.size-this.offset-e;if(i>=0)this.offset+=e,this.size>31?this.val+=t<<i:this.val+=t*Math.pow(2,i);else throw Error("the number of the write operation exceeds the total length limit of bits")}}var et=((h=et||{})[h.UNUSED=0]="UNUSED",h[h.NON_IDR_SLICE=1]="NON_IDR_SLICE",h[h.DP_A=2]="DP_A",h[h.DP_B=3]="DP_B",h[h.DP_C=4]="DP_C",h[h.IDR=5]="IDR",h[h.SEI=6]="SEI",h[h.SPS=7]="SPS",h[h.PPS=8]="PPS",h[h.DIVIDER=9]="DIVIDER",h[h.SEQUENCE_END=10]="SEQUENCE_END",h[h.STREAM_END=11]="STREAM_END",h[h.FILL=12]="FILL",h);class ei{constructor(e){let t=ee.fromByte(e,1);this.forbiddenZeroBit=t.read(1),this.refIdc=t.read(2),this.type=t.read(5)}static extractType(e,t=0){return 31&e[t]}static isSlice(e){let t=this.extractType(e);return t>=1&&t<=5}}var er=((d=er||{})[d.TRAIL_N=0]="TRAIL_N",d[d.TRAIL_R=1]="TRAIL_R",d[d.TSA_N=2]="TSA_N",d[d.TSA_R=3]="TSA_R",d[d.STSA_N=4]="STSA_N",d[d.STSA_R=5]="STSA_R",d[d.RADL_N=6]="RADL_N",d[d.RADL_R=7]="RADL_R",d[d.RASL_N=8]="RASL_N",d[d.RASL_R=9]="RASL_R",d[d.VCL_N10=10]="VCL_N10",d[d.VCL_R11=11]="VCL_R11",d[d.VCL_N12=12]="VCL_N12",d[d.VCL_R13=13]="VCL_R13",d[d.VCL_N14=14]="VCL_N14",d[d.VCL_R15=15]="VCL_R15",d[d.BLA_W_LP=16]="BLA_W_LP",d[d.BLA_W_RADL=17]="BLA_W_RADL",d[d.BLA_N_LP=18]="BLA_N_LP",d[d.IDR_W_RADL=19]="IDR_W_RADL",d[d.IDR_N_LP=20]="IDR_N_LP",d[d.CRA=21]="CRA",d[d.VPS=32]="VPS",d[d.SPS=33]="SPS",d[d.PPS=34]="PPS",d[d.ACCESS_UNIT_DELIMITER=35]="ACCESS_UNIT_DELIMITER",d[d.EOS=36]="EOS",d[d.EOB=37]="EOB",d[d.FILLER_DATA=38]="FILLER_DATA",d[d.SEI=39]="SEI",d[d.SEI_SUFFIX=40]="SEI_SUFFIX",d[d.INVALID=64]="INVALID",d);class es{constructor(e){let t=ee.fromByte(e,2);this.forbiddenZeroBit=t.read(1),this.type=t.read(6),this.nuhLayerId=t.read(6),this.temporalId=t.read(3)-1}static extractType(e,t=0){return(126&e[t])>>1}static isSlice(e){let t=this.extractType(e);return t>=0&&t<=21}}class en{create(e,...t){let i=new Uint8Array(8),r=J.fromUint8(i),s=[i,...t.map(e=>new Uint8Array(e))],n=s.reduce((e,t)=>e+t.byteLength,0);return r.write(4,n),r.writeString(e),J.concatUint8s(s)}avc1(e){let t=e.sar,i=e.naluDatas.some(e=>es.extractType(e)===er.VPS),r=new ArrayBuffer(78),s=new J(r);s.write(4,0),s.write(2,0),s.write(2,1),s.write(4,0),s.write(4,0),s.write(4,0),s.write(4,0),s.write(2,e.width),s.write(2,e.height),s.write(4,4718592),s.write(4,4718592),s.write(4,0),s.write(2,1);let n="@byted/ttplayer";s.write(1,n.length),s.writeString(n),s.skip(32-(n.length+1)),s.write(2,24),s.write(2,65535);let a=2===t.length?this.pasp(t[0],t[1]):new Uint8Array;return i?this.create("hvc1",r,this.hvcC(e),a):this.create("avc1",r,this.avcC(e),a)}avcC(e){let{naluDatas:t}=e,i=[],r=[];t.forEach(e=>{let t=ei.extractType(e);t===et.SPS?i.push(e):t===et.PPS&&r.push(e)});let s=e=>{let t=[e.length];return e.forEach(e=>{t.push(e.byteLength>>>8&255),t.push(255&e.byteLength),e.forEach(e=>t.push(e))}),t},n=s(i),a=s(r),o=i[0]||[],l=new ArrayBuffer(5),h=new J(l);return h.write(1,1),h.write(1,o[1]||0),h.write(1,o[2]||0),h.write(1,o[3]||0),h.write(1,255),this.create("avcC",l,n,a)}btrt(){let e=new ArrayBuffer(12),t=new J(e);return t.write(4,1875072),t.write(4,3e6),t.write(4,3e6),this.create("btrt",e)}pasp(e,t){let i=new ArrayBuffer(8),r=new J(i);return r.write(4,e),r.write(4,t),this.create("pasp",i)}dinf(){return this.create("dinf",this.dref())}dref(){let e=new ArrayBuffer(8),t=new J(e);return t.write(4,0),t.write(4,1),this.create("dref",e,this.url())}esds(e){let{dsiData:t=new Uint8Array}=e,i=new ArrayBuffer(29+t.byteLength),r=new J(i);return r.write(4,0),r.write(1,3),r.write(1,23+t.byteLength),r.write(2,1),r.write(1,0),r.write(1,4),r.write(1,15+t.byteLength),r.write(1,64),r.write(1,21),r.write(3,0),r.write(4,96e3),r.write(4,96e3),t.byteLength>0&&(r.write(1,5),r.write(1,t.byteLength),t.forEach(e=>r.write(1,e))),r.write(1,6),r.write(1,1),r.write(1,2),this.create("esds",i)}ftyp(){let e=new ArrayBuffer(16),t=new J(e);return t.writeString("isom"),t.write(4,1),t.writeString("isom"),t.writeString("avc1"),this.create("ftyp",e)}hdlr(e){let t=new ArrayBuffer(37),i=new J(t);return i.skip(8),e===X.VIDEO?i.writeString("vide"):e===X.AUDIO&&i.writeString("soun"),i.skip(12),e===X.VIDEO?i.writeString("VideoHandler"):e===X.AUDIO&&i.writeString("SoundHandler"),i.write(1,0),this.create("hdlr",t)}hvcC(e){let{naluDatas:t}=e,i=[],r=[],s=[];t.forEach(e=>{let t=es.extractType(e);t===er.VPS?i.push(e):t===er.SPS?r.push(e):t===er.PPS&&s.push(e)});let n=(e,t)=>{let i=[128|e,t.length>>>8&255,255&t.length];return t.forEach(e=>{i.push(e.byteLength>>>8&255),i.push(255&e.byteLength),e.forEach(e=>i.push(e))}),i},a=n(er.VPS,i),o=n(er.SPS,r),l=n(er.PPS,s),h=new ArrayBuffer(23),d=new J(h),u=r.length?r[0]:[];d.write(1,1);for(let e=1;e<17;e++)d.write(1,u[e]||0);return d.write(1,248),d.write(1,248),d.write(2,0),d.write(1,15),d.write(1,3),this.create("hvcC",h,a,o,l)}mdat(e){return this.create("mdat",e)}mdhd(e){let t=new ArrayBuffer(24),i=new J(t);return i.write(4,0),i.write(4,0),i.write(4,0),i.write(4,e.timescale),i.write(4,0),i.write(2,21956),i.write(2,0),this.create("mdhd",t)}mdia(e){return this.create("mdia",this.mdhd(e),this.hdlr(e.type),this.minf(e))}mfhd(e){let t=new ArrayBuffer(8),i=new J(t);return i.write(4,0),i.write(4,e),this.create("mfhd",t)}minf(e){let t=e.type===X.VIDEO?this.vmhd():this.smhd();return this.create("minf",t,this.dinf(),this.stbl(e))}moof(e,t,i){let r=this.mfhd(t),s=new Map,n=0;e.tracks.forEach(e=>s.set(e.type,[])),i.forEach(e=>{let t=s.get(e.type);t&&(t.push(e),n++)});let a=Array.from(s.values()).reduce((e,t)=>t.length?e+1:e,0),o=8+r.byteLength+60*a+16*n+8,l=e.tracks.map(e=>{let t=s.get(e.type);if(t&&t.length){let i=this.traf(e,t,o);return o+=t.reduce((e,t)=>e+t.data.byteLength,0),i}}).filter(e=>!!e);return this.create("moof",r,...l)}moov(e){let t=e.tracks.map(e=>this.trak(e));return this.create("moov",this.mvhd(e),...t,this.mvex(e))}mp4a(e){let t=new ArrayBuffer(28),i=new J(t);return i.write(4,0),i.write(2,0),i.write(2,1),i.write(4,0),i.write(4,0),i.write(2,e.channelCount),i.write(2,e.sampleSize),i.write(4,0),i.write(2,e.sampleRate),i.write(2,0),this.create("mp4a",t,this.esds(e))}mvex(e){return this.create("mvex",...e.tracks.map(e=>this.trex(e)))}mvhd(e){let t=new ArrayBuffer(100),i=new J(t);return i.write(4,0),i.write(4,0),i.write(4,0),i.write(4,e.timescale),i.write(4,e.duration),i.write(2,1),i.skip(2),i.write(1,1),i.skip(1),i.skip(10),[0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0].forEach(e=>i.write(1,e)),i.skip(24),i.write(4,0xffffffff),this.create("mvhd",t)}sdtp(e){let t=e.length,i=new ArrayBuffer(4+t),r=new J(i);r.write(4,0);for(let i=0;i<t;i++)r.write(1,e[i].flag);return this.create("sdtp",i)}smhd(){let e=new ArrayBuffer(8),t=new J(e);return t.write(4,0),t.write(4,0),this.create("smhd",e)}stbl(e){return this.create("stbl",this.stsd(e),this.stts(),this.stsc(),this.stsz(),this.stco())}stco(){let e=new ArrayBuffer(8),t=new J(e);return t.write(4,0),t.write(4,0),this.create("stco",e)}stsc(){let e=new ArrayBuffer(8),t=new J(e);return t.write(4,0),t.write(4,0),this.create("stsc",e)}stsd(e){let t=new ArrayBuffer(8),i=new J(t);return i.write(4,0),i.write(4,1),e.type===X.VIDEO?this.create("stsd",t,this.avc1(e)):e.type===X.AUDIO?this.create("stsd",t,this.mp4a(e)):this.create("stsd",t)}stsz(){let e=new ArrayBuffer(12),t=new J(e);return t.write(4,0),t.write(4,0),t.write(4,0),this.create("stsz",e)}stts(){let e=new ArrayBuffer(8),t=new J(e);return t.write(4,0),t.write(4,0),this.create("stts",e)}tkhd(e){let{width:t=0,height:i=0}=e,r=new ArrayBuffer(84),s=new J(r);return s.write(4,7),s.write(4,0),s.write(4,0),s.write(4,e.id),s.write(4,0),s.write(4,0),s.write(4,0),s.write(4,0),s.write(4,0),s.write(1,0),s.write(1,0),s.write(2,0),[0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0].forEach(e=>s.write(1,e)),s.write(2,t),s.write(2,0),s.write(2,i),s.write(2,0),this.create("tkhd",r)}tfdt(e){let t=new ArrayBuffer(8),i=new J(t);return i.write(4,0),i.write(4,e),this.create("tfdt",t)}tfhd(e){let t=new ArrayBuffer(8),i=new J(t);return i.write(4,0),i.write(4,e),this.create("tfhd",t)}traf(e,t,i){let r=t.length?t[0].dts:0;return this.create("traf",this.tfhd(e.id),this.tfdt(r),this.trun(t,i))}trak(e){return this.create("trak",this.tkhd(e),this.mdia(e))}trex(e){let t=new ArrayBuffer(24),i=new J(t);return i.write(4,0),i.write(4,e.id),i.write(4,1),i.write(4,0),i.write(4,0),i.write(4,65535),this.create("trex",t)}trun(e,t){let i=e.length,r=new ArrayBuffer(12+16*i),s=new J(r);s.write(4,3841),s.write(4,e.length),s.write(4,t);for(let t=0;t<i;t++){let i=e[t];s.write(4,i.duration),s.write(4,i.data.byteLength),s.write(4,i.flag),s.write(4,i.pts-i.dts)}return this.create("trun",r)}vmhd(){let e=new ArrayBuffer(12),t=new J(e);return t.write(4,1),t.write(2,0),t.write(2,0),t.write(2,0),t.write(2,0),this.create("vmhd",e)}url(){let e=new ArrayBuffer(4);return new J(e).write(4,1),this.create("url ",e)}}var ea=((u=ea||{}).InitSegmentCreated="init-segment-created",u.DataSegmentCreated="data-segment-created",u);let eo=()=>({format:Y.MP4,tracks:[],timescale:1e3,duration:0});class el extends K{constructor(e){super(e.name),this._generator=new en,this._metadata=eo(),this._sequenceNumber=0,this._logger=b.MD.createLogger(e.name)}_patchMetadata(e){this._metadata=Object.assign(this._metadata,e)}_getMetadataWithOneTrack(e){let t=this._metadata.tracks.find(t=>t.type===e);if(t)return Object.assign({},this._metadata,{tracks:[t]})}_createInitSegment(e){return J.concatUint8(this._generator.ftyp(),this._generator.moov(e))}_createDataSegment(e,t){let i=[],r=e.tracks.map(e=>t.filter(t=>t.type===e.type)),s=Array.prototype.concat.apply([],r);return i.push(this._generator.moof(e,++this._sequenceNumber,s)),i.push(this._generator.mdat(J.concatUint8s(s.map(e=>e.data)))),J.concatUint8s(i)}_getVideoRandomAccessPoints(e){let t=[];return e.forEach(e=>{e.isKeyframe&&e.type===X.VIDEO&&t.push(e.pts/e.timescale)}),t}createDataSegmentAction(e){return{type:ea.DataSegmentCreated,payloads:this._metadata.tracks.map(t=>{let i=e.filter(e=>e.type===t.type);if(!i.length)return;let r=i[0],s=i[i.length-1],n=r?r.dts/r.timescale:0,a=s?(s.dts+s.duration)/s.timescale:r?r.dts+r.duration/r.timescale:0;return this._logger.debug("$transform, actype:",ea.DataSegmentCreated,t.type,n,"-",a),t.type===X.VIDEO?{type:X.VIDEO,raps:this._getVideoRandomAccessPoints(i),sdt:n,edt:a,data:this._createDataSegment(this._getMetadataWithOneTrack(t.type),i)}:{type:t.type,sdt:n,edt:a,data:this._createDataSegment(this._getMetadataWithOneTrack(t.type),i)}}).filter(e=>!!e)}}$transform(e){let t,{value:i,done:r}=e;if(r)return{done:r};if(i)switch(i.type){case Q.LoadedMetadata:{this._patchMetadata(i.payload);let e=this._metadata.tracks.filter(e=>e.type===X.VIDEO||e.type===X.AUDIO);t={type:ea.InitSegmentCreated,metadata:this._metadata,payloads:e.map(e=>({type:e.type,codec:e.codec,data:this._createInitSegment(this._getMetadataWithOneTrack(e.type))}))},this._logger.debug("$transform, type:",t.type);break}case Q.LoadedPackets:t=this.createDataSegmentAction(i.payload)}if(t)return{done:r,value:t}}changeName(e){super.changeName(e),this._logger.setName(e)}flush(){super.flush()}reset(){this.flush(),this._sequenceNumber=0,this._metadata=eo()}}function eh(e,t){let i=e.length;if(0!==i){for(let r=0,s,n;r<i;r++)if(s=e.start(r),n=e.end(r),s<=t&&n>=t)return{start:s,end:n}}}function ed(e,t){let i=e.length;if(0!==i){let r,s;for(let n=0;n<i;n++)if(r=e.start(n),s=e.end(n),r>t||s>t)return{start:r,end:s}}}function eu(e){let t=e.tracks.find(e=>e.type===X.VIDEO);return t?t.codec.split(".")[0]:NaN}function ec(e){let t=e.tracks.find(e=>e.type===X.VIDEO);return t?t.width/t.height:NaN}class ep{constructor(){this._bufs=[],this._timer=-1,this._called=!1}append(e){this._bufs.push(e)}download(e,t){this._called||(window.clearTimeout(this._timer),this._timer=window.setTimeout(()=>{let t=new Blob(this._bufs),i=window.URL.createObjectURL(t),r=document.createElement("a");r.href=i,r.download=e,r.click(),window.URL.revokeObjectURL(i)},t),this._called=!0)}}let ef="u">typeof SourceBuffer&&!!SourceBuffer.prototype.changeType,em=!!(0,b.HZ)()&&"1"===localStorage.getItem("ttplayer_download_debug")&&location.search.indexOf("debug_download")>-1;class eg extends b.bk{constructor(e,t){super(),this._logger=b.MD.createLogger("sbp"),this._pendingOperates=[],this._asyncOperateMutexes=[],this._asyncOperateCallbacks=[],this._allUpdatedCallbacks=[],this._handleError=e=>{this._emitError(new S.Mk(S.Mk.Code.MEDIA_MSE_OTHER,"mse source buffer error"))},this._emitError=e=>{this._logger.error(e),G.microTask(()=>this.emit("error",e))},this._handleUpdateEnd=()=>{try{if(!this._sb.updating){for(;this._asyncOperateMutexes.length;)this._asyncOperateMutexes.shift().unlock();for(;this._asyncOperateCallbacks.length;)this._asyncOperateCallbacks.shift()();if(!this._pendingOperates.length)for(;this._allUpdatedCallbacks.length;)this._allUpdatedCallbacks.shift()()}}catch(e){e instanceof S.Mk?this._emitError(e):this._emitError(new S.Mk(S.Mk.Code.MEDIA_MSE_OTHER,e.message||"unknown error"));return}this._prepareOperate(),this.emit("updateend")},this._processAsyncOpereateProperties=e=>{let{mutex:t,callback:i}=e;t&&this._asyncOperateMutexes.push(t),i&&this._asyncOperateCallbacks.push(i)},this._processSyncOpereateProperties=e=>{let{mutex:t,callback:i}=e;t&&t.unlock(),i&&i()},this._prepareOperate=()=>{var e;if(this._sb.updating||null!=(e=this._video)&&e.error)return;let t=this._pendingOperates.shift();if(t){let{mutex:e,type:i}=t;this._runningOperateType=i;try{switch(t.type){case"append":this._prepareAppend(t);break;case"flush":case"remove":this._prepareRemoveOrFlush(t);break;case"changeType":this._prepareChangeType(t);break;case"timestampOffset":this._prepareTimestampOffset(t)}}catch(t){null!=e&&e.locked?e.throw(t):this._emitError(new S.Mk(S.Mk.Code.MEDIA_MSE_OTHER,t.message))}}},this._prepareRemoveOrFlush=e=>{let{start:t,end:i}=e;try{this._processAsyncOpereateProperties(e),this._logger.debug("remove buffer:",t,"-",i),this._sb.remove(t,i)}catch(e){throw new S.Mk(S.Mk.Code.MEDIA_MSE_SB_REMOVE,e.message)}},this._prepareAppend=e=>{let{data:t,extra:i}=e;try{this._processAsyncOpereateProperties(e),this._logger.debug("append buffer:",t.byteLength,i,this.mimeType),this._sb.appendBuffer(t.buffer),this.downloader&&(this.downloader.append(t.buffer),this.downloader.download(this.mimeType+".mp4",5e3))}catch(e){throw new S.Mk(S.Mk.Code.MEDIA_MSE_SB_APPEND,e.message)}},this._prepareChangeType=e=>{let{mimeType:t}=e;try{this._sb.changeType(t),this._logger.info(`mimeType changed, ${this._extra.mimeType} -> ${t}`),this._processSyncOpereateProperties(e),this._extra={mimeType:t}}catch(e){throw new S.Mk(S.Mk.Code.MEDIA_MSE_SB_CHANGE_TYPE,e.message)}},this._prepareTimestampOffset=e=>{let{timestampOffset:t}=e;try{this._sb.timestampOffset=t,this._processSyncOpereateProperties(e)}catch(e){throw new S.Mk(S.Mk.Code.MEDIA_MSE_OTHER,e.message)}},this._sb=e,this._extra={mimeType:t},em&&(this.downloader=new ep),this._sb.addEventListener("updateend",this._handleUpdateEnd),this._sb.addEventListener("error",this._handleError)}static isSupportChangeType(){return ef}get mimeType(){return this._extra.mimeType}getSourceBuffer(){return this._sb}abort(){if(this._sb.updating&&"append"===this._runningOperateType)try{this._sb.abort()}catch(e){this._logger.warn(e)}}seek(e){let t=!!eh(this._sb.buffered,e);t||(this._pendingOperates=[]);let i=this._sb.buffered;for(let t=0,r=i.length,s,n;t<r;t++)s=i.start(t),n=i.end(t),(e<s||e>n)&&this._pendingOperates.push({type:"remove",start:s,end:n});return this._prepareOperate(),t}remove(e,t,i){let r=new F("sbp.remove"),s=r.lock();return this._pendingOperates.push({type:"remove",start:e,end:t,mutex:r,callback:i}),this._prepareOperate(),s}append(e,t,i){let r=new F("sbp.append"),s=r.lock();return this._pendingOperates.push({type:"append",data:e,mutex:r,callback:t,extra:i}),this._prepareOperate(),s}changeMimeType(e,t){let i=new F("sbp.changeType"),r=i.lock();return this._pendingOperates.push({type:"changeType",mimeType:e,mutex:i,callback:t}),this._prepareOperate(),r}setTimestampOffset(e,t){this.abort();let i=new F("sbp.setTimestampOffset"),r=i.lock();return this._pendingOperates.push({type:"timestampOffset",timestampOffset:e,mutex:i,callback:t}),this._prepareOperate(),r}async flush(){let e;this.abort();try{e=this._sb.buffered}catch{}if(e&&e.length){this._logger.info("buffered range:",0,"-",e.end(e.length-1));let t=new F("sbp.flush"),i=t.lock();return this._pendingOperates.push({type:"flush",mutex:t,start:0,end:1/0}),this._prepareOperate(),i}}waitForAllUpdated(e){this._sb.updating||this._pendingOperates.length?this._allUpdatedCallbacks.push(e):e()}clearWaitOperates(){this._logger.info("clear wait operates",this._pendingOperates.length,this._pendingOperates.map(e=>e.type).join(",")),this._pendingOperates=this._pendingOperates.filter(e=>"flush"===e.type),this._asyncOperateCallbacks=[],this._asyncOperateMutexes=[],this._allUpdatedCallbacks=[],this._prepareOperate()}releaseLock(){this._pendingOperates.forEach(e=>{var t;return null==(t=e.mutex)?void 0:t.releaseLock()})}attach(e){this._video=e}detach(){this._video=void 0}destroy(){this.detach(),this._sb.removeEventListener("updateend",this._handleUpdateEnd),this.removeAllListeners(),this.clearWaitOperates(),this.releaseLock()}}var e_=((c=e_||{})[c.LOW=0]="LOW",c[c.NORMAL=1]="NORMAL",c[c.HIGH=2]="HIGH",c),ev=((p=ev||{})[p.LOOP=0]="LOOP",p[p.TIMEUPDATE=1]="TIMEUPDATE",p[p.UPDATEEND=2]="UPDATEEND",p[p.PROGRESS=3]="PROGRESS",p);class ey extends b.bk{constructor(e,t){super(),this._startupRap=0,this._level=0,this._autoLevelCheck=!1,this._bcTimer=-1,this.startPolling=()=>{let{bufferCheckingInterval:e}=this._options;e>0&&(this.dispatch(0),window.clearTimeout(this._bcTimer),this._bcTimer=window.setTimeout(this.startPolling,e))},this.stopPolling=()=>{window.clearTimeout(this._bcTimer)},this._offTriggers=()=>{this._video.removeEventListener("timeupdate",this._handleTimeupdate),this._video.removeEventListener("progress",this._handleProgress)},this._handleProgress=()=>{this._checkBuffer(3)},this._handleLoop=()=>{this._checkBuffer(0)},this._handleTimeupdate=()=>{this._checkBuffer(1),this._checkBufferOverflow()},this._handleUpdateEnd=()=>{this._checkBuffer(2),this._checkBufferChanged()},this._video=e,this._options=b.vV.combineDefaultOptions(t,{bufferCheckingInterval:0,maxBackwardBufferDuration:10,minBackwardBufferDuration:5,maxForwardBufferDuration:10,minForwardBufferDuration:5})}get level(){return this._level}setTriggers(e){this._offTriggers(),e.forEach(e=>{switch(e){case 3:return this._video.addEventListener("progress",this._handleProgress);case 1:return this._video.addEventListener("timeupdate",this._handleTimeupdate)}})}dispatch(e){switch(e){case 2:return this._handleUpdateEnd();case 0:return this._handleLoop()}}setAutoLevelCheck(e){this._autoLevelCheck=e}_changeWaterLevel(e){if(this._level!==e){let t=this._level;this._level=e,this.emit("levelchange",e,t)}}_checkBuffer(e){if(!this._autoLevelCheck)return;let{maxForwardBufferDuration:t,minForwardBufferDuration:i}=this._options,{currentTime:r,buffered:s}=this._video,n=eh(s,this.getRefineCurrentTime(r));n&&(n.end-r>t?this._changeWaterLevel(2):n.end-r>i?this._changeWaterLevel(1):this._changeWaterLevel(0),this.emit("bufferchecking",e,n))}_checkBufferOverflow(){let{minBackwardBufferDuration:e,maxBackwardBufferDuration:t}=this._options,{currentTime:i,buffered:r}=this._video,s=[];for(let n=0,a,o,l=r.length;n<l;n++)i-(a=r.start(n))>t&&(o=i-e,s.push({start:a,end:o}));s.length&&this.emit("bufferoverflow",s)}_checkBufferChanged(){let{buffered:e,currentTime:t}=this._video;if(!e.length)return;let i=function(e,t){let i=e.length;if(0!==i){let r,s;for(let n=0;n<i&&(r=e.start(n),s=e.end(n),!(r>t));n++);if(void 0!==r)return{start:r,end:s}}}(e,this.getRefineCurrentTime(t));i&&this._lastHitRange&&this._lastHitRange.end===i.end&&this._lastHitRange.start===i.start||this.emit("bufferchange"),this._lastHitRange=i}getRefineCurrentTime(e){return this._startupRap>0&&e<this._startupRap?this._startupRap:e}setStartupRandomAccessPoint(e){this._startupRap=e}forceEmpty(){this._changeWaterLevel(0)}reset(){this._offTriggers(),this._autoLevelCheck=!1,this._level=0,this._startupRap=0,this._lastHitRange=void 0}destroy(){window.clearTimeout(this._bcTimer),this.removeAllListeners(),this._offTriggers()}}var eA=((f=eA||{}).DEFAULT="default",f.NEXT_VIDEO_READY="next-video-ready",f),eT=((m=eT||{}).DEFAULT="default",m.REUSE="reuse",m.REUSE_EXCEPT_CODEC_CHANGE="reuse-except-codec-change",m);class eb extends q{constructor(e={}){super("ms.stream"),this._logger=b.MD.createLogger("mse"),this._rapSet=new Set,this._firstRap=-1,this._eos=!1,this._skipSeeking=!1,this._clearIsPending=!1,this._metadataAppended=!1,this._autoSeekCount=0,this._forceAutoSeekWhenWaiting=!1,this._startupSeeked=!1,this._handleBufferOverflow=e=>{let t=this._activeMse.sbpMap;t.size||e.forEach(({start:e,end:i})=>{let r=this._findBackwardRandomAccessPoint(i);r-.1>e&&!this._eos&&t.forEach(t=>t.remove(e,r-.1))})},this._handleSeeking=()=>{var e;if(this._logger.info("seeking event is fired, currenTime=",null==(e=this._video)?void 0:e.currentTime,"skipSeeking=",this._skipSeeking),this._skipSeeking){this._skipSeeking=!1;return}let t=this._activeMse.sbpMap,i=this._video;if(!t.size||!i||!this._metadataAppended)return;let r=this._detector?this._detector.getRefineCurrentTime(i.currentTime):i.currentTime;Array.from(t.values()).every(e=>e.seek(r))||this.emit("msestalled")},this._checkVideoStartup=()=>{let e=this._video;if(e&&0===e.currentTime&&this._autoSeekCount<3){let t=ed(e.buffered,0);t&&t.start>0&&.5>Math.abs(t.start-Math.max(this._firstRap,0))?(this._autoSeekCount++,this._logger.info("seek to the first frame at",t.start,e.duration),this._internalSeek(t.start)):this._firstRap>0&&(this._autoSeekCount++,this._logger.info("seek to the first rap at",this._firstRap,e.duration),this._internalSeek(this._firstRap))}},this._handleTimeupdate=()=>{let e=this._video;if(e&&this._options.eosFallback&&!this._eos){let t=this.metadata?this.metadata.duration/this.metadata.timescale:e.duration,i=this._detector?this._detector.getRefineCurrentTime(e.currentTime):e.currentTime;(t-i<.5||e.buffered.length&&e.buffered.end(e.buffered.length-1)-i<.5)&&(this._logger.info("endOfStream is not called, so fallback call at",i,t),this._endOfStream())}},this._seekToValidNextRap=e=>{if(this._autoSeekCount>2)return!1;let t=this._video;if(!t)return!1;let i=ed(t.buffered,0);return!!i&&i.start>t.currentTime&&i.start-t.currentTime<.5&&(this._autoSeekCount++,this._logger.info(`${e}, auto seek to`,i.start,t.duration),this._internalSeek(i.start),!0)},this._handleWaiting=()=>{this._options.autoSeekWhenWaiting||this._forceAutoSeekWhenWaiting?this._seekToValidNextRap("waiting"):this._checkVideoStartup()},this._handleSbpUpdateEnd=()=>{var e;this._options.autoSeekWhenWaiting||this._forceAutoSeekWhenWaiting?this._startupSeeked||(this._startupSeeked=this._seekToValidNextRap("startup")):this._checkVideoStartup(),null==(e=this._detector)||e.dispatch(ev.UPDATEEND)},this._handleSbpError=e=>{this.emit("error",e),this.suspend()},this._processLoop=async()=>{var e,t;let i=await this.stdin.read();if(this._clearIsPending){let r;if((null==(e=i.value)?void 0:e.type)===ea.InitSegmentCreated)r=i;else do r=await this.stdin.read();while((null==(t=r.value)?void 0:t.type)!==ea.InitSegmentCreated);r&&(i=r,this._clearIsPending=!1,this._clearImmediately(this._options.clearStrategy))}if(i.done){if(this._eos)return void this._logger.debug("already endOfStream");let e=this._activeMse.sbpMap.size,t=0;Array.from(this._activeMse.sbpMap.values()).map(i=>{i.waitForAllUpdated(()=>{++t<e||this._endOfStream()})})}else if(i.value){let e=i.value;switch(e.type){case ea.InitSegmentCreated:return this._processInitSegment(e);case ea.DataSegmentCreated:return this._processDataSegment(e)}}},this._options=b.vV.combineDefaultOptions(e,{clearStrategy:"default"}),this._activeMse=this._createMse(),"default"===this._options.clearStrategy&&(this._backupMse=this._createMse())}static isBlob(e){return 0===e.indexOf("blob:")}_findBackwardRandomAccessPoint(e){let t=-1;for(let i of this._rapSet)if(i<e)t=i;else break;return t}_createMse(){let e=new MediaSource,t=URL.createObjectURL(e),i=new F("mse.open"),r={used:!1,mediaSource:e,url:t,mutex:i,destroy:()=>{},sbpMap:new Map},s=()=>{this._logger.info("mse sourceclose")},n=()=>{this._logger.info("mse sourceopen"),i.unlockAll()};return e.addEventListener("sourceopen",n),e.addEventListener("sourceclose",s),r.destroy=()=>{i.releaseLock(),URL.revokeObjectURL(t),e.removeEventListener("sourceopen",n),e.removeEventListener("sourceclose",s)},r}_destroyMse(e){let t=this._activeMse.sbpMap;if(t.size){t.forEach(e=>e.destroy());try{t.forEach(t=>e.mediaSource.removeSourceBuffer(t.getSourceBuffer()))}catch{}}e.destroy()}_reallocMse(){let e=this._video,t=this._activeMse;return(t.sbpMap.size||e&&e.src!==t.url&&t.used)&&(this._destroyMse(t),this._backupMse?(this._activeMse=this._backupMse,this._backupMse=this._createMse()):this._activeMse=this._createMse()),e&&e.src!==this._activeMse.url&&(this._logger.info(`change to mse, ${e.src||"empty"} -> ${this._activeMse.url}`),e.src=this._activeMse.url,this._activeMse.used=!0),this._activeMse}_setMseDuration(e){try{this._activeMse.mediaSource.duration=e,this._logger.info("mse duration changed to",e,"successfully")}catch(e){this.emit("error",new S.Mk(S.Mk.Code.MEDIA_MSE_OTHER,e.message))}}_endOfStream(){this._eos||(this._activeMse.mediaSource.endOfStream(),this._eos=!0,this._logger.info("endOfStream"))}_printMetadata(e){e.tracks.forEach(e=>{e.type===X.AUDIO?this._logger.info(`track:${e.type}(${e.id})`,"codec:",e.codec,"duration:",e.duration,"timescale:",e.timescale,"objectType:",e.audioObjectType,"channels:",e.channelCount,"sampleRate:",e.sampleRate,"sampleSize:",e.sampleSize):e.type===X.VIDEO&&this._logger.info(`track:${e.type}(${e.id})`,"codec:",e.codec,"duration:",e.duration,"timescale:",e.timescale,"width:",e.width,"height:",e.height,"rotation:",e.rotation)})}async _processInitSegment(e){this._logger.debug("$mss, actype:",e.type,e.payloads),this._printMetadata(e.metadata),this._metadata=e.metadata;let{clearStrategy:t}=this._options,i=e.metadata.duration/e.metadata.timescale,r=!1,s=()=>{if(r||"open"!==this._activeMse.mediaSource.readyState)return;let e=Array.from(this._activeMse.sbpMap.values());(!e.length||e.every(e=>!e.getSourceBuffer().updating))&&(r=!0,this._setMseDuration(i))};s();let n=[];for(let s of e.payloads){let e=`video/mp4; codecs="${s.codec}"`;if(s.type===X.VIDEO&&"reuse-except-codec-change"===t){let t=this._activeMse.sbpMap.get(X.VIDEO);t&&t.mimeType!==e&&(this._reallocMse(),"open"!==this._activeMse.mediaSource.readyState&&await this._activeMse.mutex.lock(),this._setMseDuration(i),r=!0,this._logger.info("realloc mse, codec changed"))}let a=this._activeMse.sbpMap.get(s.type);if(a)a.abort(),await a.flush(),eg.isSupportChangeType()&&await a.changeMimeType(e),n.push(a.append(s.data));else{let t;"open"!==this._activeMse.mediaSource.readyState&&(await this._activeMse.mutex.lock(),this._setMseDuration(i),r=!0);try{t=this._activeMse.mediaSource.addSourceBuffer(e)}catch(e){throw new S.Mk(S.Mk.Code.MEDIA_MSE_ADD_SB,e.message)}let a=new eg(t,e);a.attach(this._video),a.on("error",this._handleSbpError),a.on("updateend",this._handleSbpUpdateEnd),this._activeMse.sbpMap.set(s.type,a),n.push(a.append(s.data))}}return Promise.all(n).then(()=>{s(),this._metadataAppended=!0})}async _processDataSegment(e){var t,i;let r=this._video,s=[];for(let n of e.payloads){let a=this._activeMse.sbpMap.get(n.type),o={sdt:n.sdt,edt:n.edt};if(a){if(this._logger.debug("$mss, actype:",e.type,n.type,n.data.byteLength,",",n.sdt,"-",n.edt),n.type===X.VIDEO){if(n.raps.forEach(e=>this._rapSet.add(e)),this._eos){this._logger.warn("append cannot be called after endOfStream");break}this._firstRap<0&&n.raps.length&&(this._firstRap=n.raps[0],this._options.autoSeekWhenWaiting||this._forceAutoSeekWhenWaiting?r&&0===r.currentTime&&(null==(t=this._detector)||t.setStartupRandomAccessPoint(this._firstRap)):null==(i=this._detector)||i.setStartupRandomAccessPoint(this._firstRap)),n.raps.length&&(o.raps=n.raps)}s.push(a.append(n.data,void 0,o))}else throw new S.Mk(S.Mk.Code.MEDIA_MSE_SB_APPEND,"no sourcebuffer")}return Promise.all(s)}_internalSeek(e){let t=this._video;t&&(this._skipSeeking=!0,t.currentTime=e)}_resetContinuityStates(){this._autoSeekCount=0,this._startupSeeked=!1,this._skipSeeking=!1,this._eos=!1}_resetAllStates(){this._rapSet.clear(),this._metadata=void 0,this._metadataAppended=!1,this._forceAutoSeekWhenWaiting=!1,this._firstRap=-1,this._resetContinuityStates()}_clearImmediately(e){if(super.flush(),this._resetAllStates(),"reuse"===e||"reuse-except-codec-change"===e){let e=this._activeMse.sbpMap;e.size&&(e.forEach(e=>{e.abort(),e.clearWaitOperates()}),Promise.all(Array.from(e.values()).map(e=>e.flush())).then(()=>{let e=this._video;e&&e.autoplay&&e.paused&&(e.play(),this._logger.log("automatically resume the previously paused playback state due to autoplay=true"))}))}else this._reallocMse()}setForceAutoSeekWhenWaiting(e){this._forceAutoSeekWhenWaiting=e}get metadata(){return this._metadata}get url(){return this._activeMse.url}attach(e,t){this._video!==e&&(this.detach(),t.on("bufferoverflow",this._handleBufferOverflow),e.addEventListener("seeking",this._handleSeeking),e.addEventListener("waiting",this._handleWaiting),e.addEventListener("timeupdate",this._handleTimeupdate),this._detector=t,this._video=e,this._reallocMse())}detach(){this._activeMse.sbpMap.forEach(e=>e.detach()),this._video&&(this._video.removeEventListener("seeking",this._handleSeeking),this._video.removeEventListener("waiting",this._handleWaiting),this._video.removeEventListener("timeupdate",this._handleTimeupdate),this._video=void 0),this._detector&&(this._detector.off("bufferoverflow",this._handleBufferOverflow),this._detector=void 0)}suspend(){var e;this._activeMse.sbpMap.forEach(e=>e.releaseLock()),this.stdin.releaseRead(),this._activeMse.mutex.releaseLock(),null==(e=this._coroutine)||e.cancel(),this._coroutine=void 0}resume(){this._coroutine||(this._coroutine=G.create({title:"mse.stream",onLoop:this._processLoop,onError:e=>this.emit("error",e)}))}async flush(){super.flush(),this._resetContinuityStates();let e=this._activeMse.sbpMap;if(e.size)return e.forEach(e=>e.abort()),Promise.all(Array.from(e.values()).map(e=>e.flush()))}reset(e){var t;if(this.suspend(),null!=(t=this._video)&&t.error&&this._reallocMse(),"next-video-ready"===((null==e?void 0:e.clearTiming)||this._options.clearTiming))this._clearIsPending=!0;else{let t=(null==e?void 0:e.clearStrategy)||this._options.clearStrategy;this._clearImmediately(t)}}destroy(){super.destroy(),this.reset({clearStrategy:"default",clearTiming:"default"}),this.suspend(),this._destroyMse(this._activeMse),this._backupMse&&this._destroyMse(this._backupMse)}}let eS=class{constructor(e,t){let i=e.offset;this.pos=t,this.size=e.read(4),this.type=String.fromCharCode(e.read(1),e.read(1),e.read(1),e.read(1)).trim(),1===this.size&&(this.size=e.read(8)),this.headerSize=e.offset-i}};eS.MIN_SIZE=8;class eE{}class ek extends eE{constructor(e){super(),this.version=e.read(1),this.flag=e.read(3)}}class eP extends eE{constructor(e){super(),this.isContainer=!1,this.data=e.readToUint8()}}var ew=((g=ew||{}).Video="vide",g.Audio="soun",g.Hint="hint",g),ex=((_=ex||{})[_.BASE_DATA_OFFSET=1]="BASE_DATA_OFFSET",_[_.SAMPLE_DESC=2]="SAMPLE_DESC",_[_.SAMPLE_DUR=8]="SAMPLE_DUR",_[_.SAMPLE_SIZE=16]="SAMPLE_SIZE",_[_.SAMPLE_FLAGS=32]="SAMPLE_FLAGS",_[_.DUR_EMPTY=65536]="DUR_EMPTY",_[_.DEFAULT_BASE_IS_MOOF=131072]="DEFAULT_BASE_IS_MOOF",_),eC=((v=eC||{})[v.DATA_OFFSET=1]="DATA_OFFSET",v[v.FIRST_FLAG=4]="FIRST_FLAG",v[v.DURATION=256]="DURATION",v[v.SIZE=512]="SIZE",v[v.FLAG=1024]="FLAG",v[v.CTS_OFFSET=2048]="CTS_OFFSET",v);class eL{constructor(e){this._logger=b.MD.createLogger("mp4-track"),this._samples=[],this._nextSampleIndex=0,this._meta=this.__createMetadata(e),(e=>{var t,i,r;let{mdia:s}=e||{},n=(null==(t=null==s?void 0:s.minf)?void 0:t.stbl)||{},{stts:a,stsc:o,stsz:l,stss:h,ctts:d}=n,u=n.stco||n.co64,c=[];if(a&&o&&l&&u){let e={};null==h||h.sampleNumbers.forEach(t=>e[t-1]=!0);let t=[];if(d)for(let e=0,i,r;e<d.sampleCounts.length;e++){i=d.sampleCounts[e],r=d.sampleOffsets[e];for(let e=0;e<i;e++)t.push(r)}let s=o.entries,n=(null==(i=s[0])?void 0:i.samplePerChunk)||1/0,p=(null==(r=s[1])?void 0:r.firstChunk)-1||1/0,f=0,m=0,g=0,_=0,v=0,y=0;a.sampleCounts.forEach((i,r)=>{var o;for(let A=0;A<i;A++){let i={},A=a.sampleDurations[r];i.index=y,i.size=l.sampleSizes[y]||l.sampleSize,i.pos=u.chunkOffsets[m]+f,i.cts=d?t[y]:0,i.isKeyframe=!h||!!e[y],i.duration=A,i.dts=_,i.flag=i.isKeyframe?0x2000000:0x1010000,_+=A,i.isKeyframe&&v++,i.gopId=v,c.push(i),++y<n?f+=i.size:(m++,f=0,m>=p&&(p=(null==(o=s[++g+1])?void 0:o.firstChunk)-1||1/0),n+=s[g].samplePerChunk)}})}return c})(e).forEach(e=>{this.addSample(e)})}__createMetadata(e){let{mdia:t}=e,{mdhd:i,hdlr:r,minf:s}=t||{},{stbl:n}=s||{},{stsd:a}=n||{},o=e.tkhd||{},l={id:o.trackId||0,timescale:(i||{}).timescale||1e3,duration:o.duration||0};switch((r||{}).handlerType){case ew.Video:return Object.assign(l,this.__createExtraVideoMetadata(a,e.tkhd));case ew.Audio:return Object.assign(l,this.__createExtraAudioMetadata(a));default:return Object.assign(l,this.__createUnknownTrackMetadata())}}__createUnknownTrackMetadata(){return{type:X.UNKNOWN}}__createExtraAudioMetadata(e){var t;let{mp4a:i}=e||{},r=i||{},s=(null==i?void 0:i.esds)||(null==(t=null==i?void 0:i.wave)?void 0:t.esds)||{};return{type:X.AUDIO,codec:s.codec||"",audioObjectType:s.audioObjectType||0,dsiData:s.dsiData,sampleRate:r.sampleRate||0,channelCount:r.channelCount||0,sampleSize:r.sampleSize||0}}__createExtraVideoMetadata(e,t){var i,r,s;let{rotation:n}=t||{},{avc1:a,hev1:o,hvc1:l}=e||{},h=(null==a?void 0:a.avcC)||(null==o?void 0:o.hvcC)||(null==l?void 0:l.hvcC),d=(null==h?void 0:h.nalus)||[],u=(null==(i=null==a?void 0:a.avcC)?void 0:i.spsList)||(null==(r=null==o?void 0:o.hvcC)?void 0:r.spsList)||(null==(s=null==l?void 0:l.hvcC)?void 0:s.spsList),{sar:c,width:p,height:f,codec:m}=(null==u?void 0:u[0])||{};return{type:X.VIDEO,naluDatas:d.map(e=>e.data),rotation:n||0,codec:m||"",sps:u||[],sar:c||[],width:p||0,height:f||0}}getMetadata(){return this._meta}getSamples(){return this._samples}getNextSampleIndex(){return this._nextSampleIndex}getNextSample(){return this._samples[this._nextSampleIndex]}getNextSampleSize(){return this._nextSampleIndex<this._samples.length?this._samples[this._nextSampleIndex].size:0}getNextSamplePos(){if(this._nextSampleIndex<this._samples.length)return this._samples[this._nextSampleIndex].pos;if(!this._samples.length)return -1;{let e=this._samples[this._samples.length-1];return e.pos+e.size}}addSample(e){this._samples.push(e)}addFragment(e,t,i=0){(function(e,t,i){let{tfhd:r,trun:s,tfdt:n}=e,a=[];if(!(n&&s&&n&&r))return a;let{sampleCTSs:o,sampleCount:l,sampleFlags:h,sampleDurations:d,sampleSizes:u,flag:c}=s,{flag:p}=r,f=p&ex.SAMPLE_DUR?r.defaultSampleDuration:(null==t?void 0:t.defaultSampleDuration)||0,m=p&ex.SAMPLE_SIZE?r.defaultSampleSize:(null==t?void 0:t.defaultSampleSize)||0,g=p&ex.SAMPLE_FLAGS?r.defaultSampleFlag:(null==t?void 0:t.defaultSampleFlag)||0,_=(p&ex.BASE_DATA_OFFSET?r.baseDataOffset:p&ex.DEFAULT_BASE_IS_MOOF?i:0)+s.dataOffset;for(let e=0,t=0,i=_,r=0;r<l;r++){let l={};l.index=r,l.size=c&eC.SIZE?u[r]:m,l.duration=c&eC.DURATION?d[r]:f,l.dts=e>0?e:n?n.baseMediaDecodeTime:0,l.cts=o[r]||0,e=l.dts+l.duration;let p=g;c&eC.FLAG?p=h[r]:0===r&&c&eC.FIRST_FLAG&&(p=s.firstSampleFlag),l.flag=p,l.isKeyframe=!(0x1010000&p),l.isKeyframe&&t++,l.gopId=t,l.pos=i,i+=l.size,a.push(l)}return a})(e,t,i).forEach(e=>{this.addSample(e)})}__convertSampleToPacket(e,t,i=0){let r=e.pos-i;if(r>=0&&e.pos+e.size<=t.byteLength+i)return{index:e.index,pos:e.pos,duration:e.duration,flag:e.flag,dts:e.dts,pts:e.dts+e.cts,isKeyframe:e.isKeyframe,timescale:this._meta.timescale,type:this._meta.type,codec:this._meta.codec||"",data:t.subarray(r,r+e.size)}}processPackets(e,t=0){let i=[];for(let r=this._nextSampleIndex,s=this._samples.length;r<s;r++){let s=this.__convertSampleToPacket(this._samples[r],e,t);if(s)this._nextSampleIndex++,i.push(s);else break}return i}seek(e){let t,i=e*this._meta.timescale,r=this._samples.length;if(r){if((t=this._samples[0]).dts+t.cts>i)return this._nextSampleIndex=0,t;if((t=this._samples[this._samples.length-1]).dts+t.cts+t.duration<i)return void this._logger.warn("seek out of range");{let e=-1;for(let s=0;s<r&&!((t=this._samples[s]).dts+t.cts>i);s++)t.isKeyframe&&(e=s);if(e>-1)return this._nextSampleIndex=e,this._samples[e];this._logger.warn("seek out of range")}}else this._logger.warn("no samples")}resetSamples(){this._nextSampleIndex=0,this._samples=[]}}class eD{constructor(e){this.__tracks=[];let{trak:t,mvhd:i}=e,r=i||{},s=new Map;(t||[]).forEach(e=>{var t,i;let r=null==(i=null==(t=e.mdia)?void 0:t.hdlr)?void 0:i.handlerType;r&&(s.has(r)||this.__tracks.push(new eL(e)),s.set(r,!0))}),this.__tracks=this.__tracks.filter(e=>e.getMetadata().type!==X.UNKNOWN),this.__meta={format:Y.MP4,duration:r.duration||0,timescale:r.timescale||0,tracks:this.__tracks.map(e=>e.getMetadata()).filter(e=>e.type!==X.UNKNOWN)}}getTrackById(e){return this.__tracks.find(t=>t.getMetadata().id===e)}getTracks(){return this.__tracks}getMetadata(){return this.__meta}}class eI extends b.bk{constructor(e={}){super(),this._onLoad=e=>{this.parse(e)},this.__options=e,this.setLoader(e.loader)}get loader(){return this.__customLoader||this.__backupLoader}load(e){return this.loader.load(e)}loadJsonSource(e){}setLoader(e){this.loader&&this.loader.off("loadeddata",this._onLoad),this.__customLoader=e,this.__customLoader||this.__backupLoader||(this.__backupLoader=new R(this.__options.loaderOptions||{})),this.loader.on("loadeddata",this._onLoad)}suspend(e){return this.loader.suspend()}resume(){return this.loader.resume()}abort(){return this.loader.abort()}reset(){var e,t;null==(e=this.__customLoader)||e.reset(),null==(t=this.__backupLoader)||t.reset()}destroy(){this.__customLoader=void 0,this.removeAllListeners(),this.reset(),this.__backupLoader&&(this.__backupLoader.removeAllListeners(),this.__backupLoader.destroy())}}class eR extends ek{constructor(e){super(e),this.isContainer=!0,e.skip(2),this.bitReferenceId=e.read(2),this.codeStreamVersion=e.read(4),e.skip(4),e.skip(8),this.width=e.read(2),this.height=e.read(2),this.horizontalResolution=e.read(4),this.verticalResolution=e.read(4),e.skip(4),this.frameCount=e.read(2);let t=Math.min(e.read(1),32);this.compressorName=e.readString(t),e.skip(32-(t+1)),this.depth=e.read(2),e.skip(2)}}function eO(e){return e.toString(16).padStart(2,"0")}let eM=new Date("1904-01-01T00:00:00Z").getTime();function eB(e){return e&&e+1e3*eM}class eN{constructor(e){this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){let e=this.data,t=this.bytesAvailable,i=e.byteLength-t,r=new Uint8Array(4),s=Math.min(4,t);if(0===s)throw Error("no bytes available");r.set(e.subarray(i,i+s)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*s,this.bytesAvailable-=s}skipBits(e){let t;this.bitsAvailable>e||(e-=this.bitsAvailable,t=e>>3,e-=8*t,this.bytesAvailable-=t,this.loadWord()),this.word<<=e,this.bitsAvailable-=e}readBits(e){let t=Math.min(this.bitsAvailable,e),i=this.word>>>32-t;if(e>32)throw Error("Cannot read more than 32 bits at a time");return this.bitsAvailable-=t,this.bitsAvailable>0?this.word<<=t:this.bytesAvailable>0&&this.loadWord(),(t=e-t)>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&0x80000000>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){let e=this.skipLZ();return this.readBits(e+1)-1}readEG(){let e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t=8,i=8,r;for(r=0;r<e;r++)0!==i&&(i=(t+this.readEG()+256)%256),t=0===i?t:i}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}function eU(e){let t=e.byteLength,i=[],r=1;for(;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(i.push(r+2),r+=2):r++;if(0===i.length)return e;let s=t-i.length,n=new Uint8Array(s),a=0;for(r=0;r<s;a++,r++)a===i[0]&&(a++,i.shift()),n[r]=e[a];return n}let eF=[100,110,122,244,44,83,86,118,128,138,144],eV=[[0,1],[1,1],[12,11],[10,11],[16,11],[40,33],[24,11],[20,11],[32,11],[80,33],[18,11],[15,11],[64,33],[160,99],[4,3],[3,2],[2,1]],e$=[1,2,2,1],ez=[1,2,1,1];class ej{constructor(){this.videoFormat=0,this.videoFullRangeFlag=0,this.colourDescriptionPresentFlag=0,this.colourPrimaries=0,this.transferCharacteristics=0,this.matrixCoeffs=0,this.sar=[]}decodeVuiParams(e){if(e.readBits(1)){let t=e.readUByte();255===t?(this.sar[0]=e.readUByte()<<8|e.readUByte(),this.sar[1]=e.readUByte()<<8|e.readUByte()):this.sar=eV[t]}e.readBits(1)&&e.skipBits(1),e.readBits(1)&&(this.videoFormat=e.readBits(3),this.videoFullRangeFlag=e.readBits(1),this.colourDescriptionPresentFlag=e.readBits(1),this.colourDescriptionPresentFlag&&(this.colourPrimaries=e.readUByte(),this.transferCharacteristics=e.readUByte(),this.matrixCoeffs=e.readUByte()))}}class eG extends ej{constructor(e){super(),this.generalProfileSpace=0,this.generalTierFlag=0,this.cropLeft=0,this.cropRight=0,this.cropTop=0,this.cropBottom=0;let t=new eN(eU(e.subarray(1)));if(this.generalProfileIdc=t.readUByte(),this.generalProfileCompatibility=t.readUByte(),this.generalLevelIdc=t.readUByte(),this.spsId=t.readUEG(),this.codec=this.__generateCodec(),eF.indexOf(this.generalProfileIdc)>-1){if(this.chromaFormatIdc=t.readUEG(),3===this.chromaFormatIdc&&t.skipBits(1),this.bitDepthLuma=t.readUEG()+8,this.bitDepthChroma=t.readUEG()+8,t.skipBits(1),t.readBits(1))for(let e=0,i=3!==this.chromaFormatIdc?8:12;e<i;e++)t.readBits(1)&&(e<6?t.skipScalingList(16):t.skipScalingList(64))}else this.chromaFormatIdc=1,this.bitDepthLuma=8,this.bitDepthChroma=8;t.skipUEG();let i=t.readUEG();if(0===i)t.skipUEG();else if(1===i){t.skipBits(1),t.skipEG(),t.skipEG();for(let e=0,i=t.readUEG();e<i;e++)t.skipEG()}t.skipUEG(),t.skipBits(1);let r=t.readUEG()+1,s=t.readUEG()+1,n=t.readBits(1);if(n||t.skipBits(1),t.skipBits(1),this.crop=t.readBits(1),this.crop){let e=+(1===this.chromaFormatIdc||2===this.chromaFormatIdc),i=+(1===this.chromaFormatIdc),r=1<<e,s=2-n<<i;this.cropLeft=t.readUEG()*r,this.cropRight=t.readUEG()*r,this.cropTop=t.readUEG()*s,this.cropBottom=t.readUEG()*s}this.width=16*r-(this.cropRight+this.cropLeft),this.height=16*s-(this.cropTop+this.cropBottom),t.readBits(1)&&this.decodeVuiParams(t)}__generateCodec(){return"avc1."+[this.generalProfileIdc,this.generalProfileCompatibility,this.generalLevelIdc].map(e=>eO(e)).join("")}}class eH{constructor(e){let t;this.generalProfileCompatibilityFlags=[],this.generalConstraintIndicatorFlags=[],this.separateColourPlaneFlag=0,this.checkProfileIdc=0,this.maxSubLayersMinus1=0,this.sar=[],this.__generateCodec=()=>{let e=["hvc1"],t=this.generalProfileSpace;e.push((t>0&&t<4?String.fromCharCode(64+t):"")+this.generalProfileIdc.toString()),e.push(this.generalProfileCompatibilityFlags.reverse().reduce((e,t)=>e<<1|t,0).toString(16)),e.push((this.generalTierFlag?"H":"L")+this.generalLevelIdc);let i=[];for(let e=!1,t=5;t>=0;t--){let r=this.generalConstraintIndicatorFlags[t];(r||e)&&(i.unshift(r.toString(16)),e=!0)}return e.concat(i).join(".")};let i=new eN(eU(e.subarray(2)));for(this.vpsId=i.readBits(4),this.maxSubLayersMinus1=i.readBits(3),this.temporalIdNested=i.readBits(1),this.generalProfileSpace=i.readBits(2),this.generalTierFlag=i.readBits(1),this.generalProfileIdc=i.readBits(5),t=0;t<32;t++)this.generalProfileCompatibilityFlags[t]=i.readBits(1),0===this.generalProfileIdc&&t>0&&this.generalProfileCompatibilityFlags[t]&&(this.generalProfileIdc=t);for(t=0;t<6;t++)this.generalConstraintIndicatorFlags.push(i.readUByte());this.generalLevelIdc=i.readUByte();let r=[],s=[];for(t=0;t<this.maxSubLayersMinus1;t++)r[t]=i.readBits(1),s[t]=i.readBits(1);if(this.maxSubLayersMinus1>0)for(i.skipBits((8-this.maxSubLayersMinus1)*2),t=0;t<this.maxSubLayersMinus1;t++)r[t]&&(i.skipBits(16),i.skipBits(16),i.skipBits(16),i.skipBits(16),i.skipBits(24)),s[t]&&i.skipBits(8);if(this.spsId=i.readUEG(),this.codec=this.__generateCodec(),this.chromaFormatIdc=i.readUEG(),3===this.chromaFormatIdc&&(this.separateColourPlaneFlag=i.readBits(1),this.separateColourPlaneFlag&&(this.chromaFormatIdc=0)),this.width=i.readUEG(),this.height=i.readUEG(),i.readBits(1)){let e=e$[this.chromaFormatIdc],t=ez[this.chromaFormatIdc];this.width-=i.readUEG()*e+i.readUEG()*e,this.height-=i.readUEG()*t+i.readUEG()*t}}}var eW=((y=eW||{})[y.OD=1]="OD",y[y.IOD=2]="IOD",y[y.ESD=3]="ESD",y[y.DCD=4]="DCD",y[y.DSI=5]="DSI",y[y.SLCD=6]="SLCD",y);class eq{constructor(e){this.tag=e.read(1),this.size=0;let t=e.read(1);for(;128&t;)this.size=(127&t)<<7,t=e.read(1);this.size+=127&t}static extractDescriptors(e){let t,i,r,s=[];for(;e.unreadLength>2&&!((t=new eq(e)).size<=0);){switch(r=new J(e.buffer,e.offset,t.size),e.skip(t.size),t.tag){case 3:i=new eY(t,r);break;case 4:i=new eX(t,r);break;case 5:i=new eQ(t,r);break;case 6:i=new eJ(t,r);break;default:i=null}i&&(r.unreadLength&&(i.children=eq.extractDescriptors(r)),s.push(i))}return s}}class eK{constructor(e){this.probe=e,this.children=[]}static findDescriptor(e,t){let i;return e.some(e=>!!(i=e.probe.tag===t?e:eK.findDescriptor(e.children,t))),i}}class eY extends eK{constructor(e,t){super(e),this.streamDependenceFlag=0,this.URLFlag=0,this.OCRStreamFlag=0,this.esId=t.read(2),this.esFlag=t.read(1),128&this.esFlag&&(this.streamDependenceFlag=t.read(2)),64&this.esFlag&&(this.URLFlag=t.read(1),t.skip(this.URLFlag)),32&this.esFlag&&(this.OCRStreamFlag=t.read(2))}}class eX extends eK{constructor(e,t){super(e),this.mpeg4Audio=t.read(1),this.audioStream=t.read(1),this.bufferSize=t.read(3),this.maxBitrate=t.read(4),this.avgBitrate=t.read(4)}}class eQ extends eK{constructor(e,t){super(e),this.data=t.readToUint8(),t.back(this.data.byteLength);let i=ee.fromByte(t,2);this.objectType=i.read(5),31===this.objectType&&(this.objectType=32+i.read(6))}}class eJ extends eK{constructor(e,t){super(e),this.esId=t.read(2)}}let eZ=Object.freeze(Object.defineProperty({__proto__:null,BoxBody:eE,BoxHeader:eS,FullBoxBody:ek,UnknownBoxBody:eP,avc1:eR,avcC:class extends eE{constructor(e){super(),this.isContainer=!1,this.spsList=[],this.nalus=[],this.configVersion=e.read(1),this.generalProfileIdc=e.read(1),this.generalProfileCompatibility=e.read(1),this.generalLevelIdc=e.read(1),this.lengthSizeMinusOne=3&e.read(1),this.numOfSequenceParameterSets=31&e.read(1);for(let t=0;t<this.numOfSequenceParameterSets;t++){let t=e.read(2),i=e.readToUint8(t);this.spsList.push(new eG(i)),this.nalus.push({type:et.SPS,data:i})}this.numOfPictureParameterSets=31&e.read(1);for(let t=0;t<this.numOfPictureParameterSets;t++){let t=e.read(2);this.nalus.push({type:et.SPS,data:e.readToUint8(t)})}}},btrt:class extends eE{constructor(e){super(),this.isContainer=!0,this.bufferSizeDB=e.read(4),this.maxBitrate=e.read(4),this.avgBitrate=e.read(4)}},chan:eE,co64:class extends ek{constructor(e){super(e),this.isContainer=!1,this.chunkOffsets=[];for(let t=e.read(4),i=0;i<t;i++)this.chunkOffsets.push(e.read(8))}},colr:class extends eE{constructor(e){super(),this.isContainer=!1,this.colorPrimaries=0,this.transferCharacteristics=0,this.matrixCoefficients=0,this.fullRangeFlag=0,this.colorType=e.readString(4),"nclx"===this.colorType?(this.colorPrimaries=e.read(2),this.transferCharacteristics=e.read(2),this.matrixCoefficients=e.read(2),this.fullRangeFlag=e.read(1)>>7,this.iccProfile=new Uint8Array):"rICC"===this.colorType||"prof"===this.colorType?this.iccProfile=e.readToUint8():this.iccProfile=new Uint8Array}},ctts:class extends ek{constructor(e){super(e),this.isContainer=!1,this.sampleCounts=[],this.sampleOffsets=[];for(let t=e.read(4),i=0;i<t;i++)this.sampleCounts[i]=e.read(4),this.sampleOffsets[i]=e.read(4)}},dinf:class extends eE{constructor(){super(...arguments),this.isContainer=!0}},dref:class extends ek{constructor(e){super(e),this.isContainer=!0,this.entryCount=e.read(4)}},edts:class extends eE{constructor(){super(...arguments),this.isContainer=!0}},elst:class extends ek{constructor(e){super(e),this.isContainer=!1,this.entries=[];let t=e.read(4),i=1===this.version;for(let r=0;r<t;r++)this.entries.push({segmentDuration:e.read(i?8:4),mediaTime:e.read(i?8:4),mediaRateInteger:e.read(2),mediaRateFraction:e.read(2)})}},esds:class extends ek{constructor(e){super(e),this.isContainer=!1,this.codec="",this.descriptors=[],this.audioObjectType=0,this.descriptors=eq.extractDescriptors(e);let t=eK.findDescriptor(this.descriptors,eW.DCD),i=eK.findDescriptor(this.descriptors,eW.DSI);i&&(this.audioObjectType=i.objectType,this.dsiData=i.data,t&&(this.codec="mp4a."+t.mpeg4Audio.toString(16)+"."+i.objectType))}},fiel:eE,free:eE,frma:class extends eE{constructor(e){super(),this.isContainer=!1,this.dataFormat=e.readString(4)}},ftyp:class extends eE{constructor(e){for(super(),this.isContainer=!1,this.majorBrand=e.readString(4).trim(),this.minorVersion=e.read(4),this.compatibleBrands=[];e.unreadLength>3;)this.compatibleBrands.push(e.readString(4))}},hdlr:class extends ek{constructor(e){super(e),this.isContainer=!1,this.name="",this.preDefined="",this.handlerType="",0===this.version&&(this.preDefined=e.readString(4).trim(),this.handlerType=e.readString(4).trim(),e.skip(12),this.name=e.readString(e.unreadLength).trim())}},hvc1:class extends eR{},hvcC:class extends eE{constructor(e){let t;super(),this.isContainer=!1,this.generalProfileCompatibilityFlags=[],this.generalConstraintIndicatorFlags=[],this.spsList=[],this.nalus=[],this.configVersion=e.read(1),t=ee.fromByte(e,1),this.generalProfileSpace=t.read(2),this.generalTierFlag=t.read(1),this.generalProfileIdc=t.read(5),t=ee.fromByte(e,4),this.generalProfileCompatibilityFlags=Array.from(Array(32)).map(()=>t.read(1)),this.generalConstraintIndicatorFlags=Array.from(Array(6)).map(()=>e.read(1)),this.generalLevelIdc=e.read(1),this.minSpatialSegmentationIdc=4095&e.read(2),this.parallelismType=3&e.read(1),this.chromaFormatIdc=3&e.read(1),this.bitDepthLumaMinus8=7&e.read(1),this.bitDepthChromaMinus8=7&e.read(1),this.avgFrameRate=e.read(2),t=ee.fromByte(e,1),this.constantFrameRate=t.read(2),this.numTemporalLayers=t.read(3),this.temporalIdNested=t.read(1),this.lengthSizeMinusOne=t.read(2);let i=e.read(1);for(let t=0;t<i;t++){let t=ee.fromByte(e,1),i=t.read(1);t.skip(1);let r=t.read(6),s=e.read(2);for(let t=0;t<s;t++){let t=new Uint8Array(e.read(2)).map(()=>e.read(1));this.nalus.push({completeness:i,type:r,data:t}),r===er.SPS&&this.spsList.push(new eH(t))}}}},ilst:eE,keys:eE,mdhd:class extends ek{constructor(e){super(e),this.isContainer=!1,1===this.version?(this.createTime=eB(e.read(8)),this.modifyTime=eB(e.read(8)),this.timescale=e.read(4),this.duration=e.read(8)):(this.createTime=eB(e.read(4)),this.modifyTime=eB(e.read(4)),this.timescale=e.read(4),this.duration=e.read(4));let t=e.read(2);this.language=String.fromCharCode(31&(t>>10)+96,31&(t>>5)+96,31&t+96).trim(),this.quality=+(e.readInt(1)+"."+e.readInt(1))}},mdia:class extends eE{constructor(){super(...arguments),this.isContainer=!0}},mehd:eE,meta:eE,mfhd:class extends ek{constructor(e){super(e),this.isContainer=!1,this.sequenceNumber=e.read(4)}},mfra:eE,minf:class extends eE{constructor(){super(...arguments),this.isContainer=!0}},moof:class extends eE{constructor(){super(...arguments),this.isContainer=!0,this.traf=[]}},moov:class extends eE{constructor(){super(...arguments),this.isContainer=!0,this.trak=[]}},mp4a:class extends eE{constructor(e){if(super(),this.isContainer=!0,this.dataReferenceIndex=0,this.channelCount=0,this.sampleSize=0,this.sampleRate=0,e.unreadLength<28)return;e.skip(6),this.dataReferenceIndex=e.read(2);let t=e.read(2);e.skip(6),this.channelCount=e.read(2),this.sampleSize=e.read(2),e.skip(4),this.sampleRate=e.read(4)>>>16,1===t?(e.skip(4),e.skip(4),e.skip(4),e.skip(4)):2==t&&(e.skip(4),this.sampleRate=e.read(8),this.channelCount=e.read(4),e.skip(4),this.sampleSize=e.read(4),e.skip(4),e.skip(4),e.skip(4))}},mvex:class extends eE{constructor(){super(...arguments),this.isContainer=!0}},mvhd:class extends ek{constructor(e){super(e),this.isContainer=!1,this.matrix=[],this.createTime=eB(e.read(4)),this.modifyTime=eB(e.read(4)),this.timescale=e.read(4),this.duration=e.read(4),this.rate=+(e.read(2)+"."+e.read(2)),this.volume=+(e.read(1)+"."+e.read(1)),e.skip(10);for(let t=0;t<9;t++)this.matrix.push(+(e.read(2)+"."+e.read(2)));e.skip(24),this.nextTrackId=e.read(4)}},pasp:class extends eE{constructor(e){super(),this.isContainer=!1,this.hSpacing=e.read(4),this.vSpacing=e.read(4)}},pssh:class extends ek{constructor(e){super(e),this.isContainer=!1,this.systemIds=[],this.keyIds=[];for(let t=0;t<16;t++)this.systemIds.push(eO(e.read(1)));if(this.version>0){let t=e.read(4);for(let i=0;i<t;i++){let t=Array.from(Array(16)).map(()=>eO(e.read(1))).join("");this.keyIds.push(t)}}let t=e.read(4);this.data=e.readToUint8(t)}},sbgp:class extends ek{constructor(e){super(e),this.isContainer=!0,this.entries=[],this.groupingType=e.readString(4),1===this.version?this.groupingTypeParameter=e.read(4):this.groupingTypeParameter=0;let t=e.read(4);for(let i=0;i<t;i++)this.entries.push({sampleCount:e.readInt(4),groupDescriptionIndex:e.readInt(4)})}},schi:class extends eE{constructor(){super(...arguments),this.isContainer=!0}},senc:class extends ek{constructor(e){super(e),this.isContainer=!1,this.samples=[],this.sampleCount=e.read(4),this.byte=e}caculateSamples(e=8){for(let t=0;t<this.sampleCount;t++){let t=[];for(let i=0;i<e;i++)t.push(this.byte.read(1));let i=this.byte.read(2),r=[];for(let e=0;e<i;e++)r.push({bytesOfClearData:this.byte.read(2),bytesOfProtectedData:this.byte.read(4)});this.samples.push({initializationVector:t,subsamples:r})}}},sgpd:eE,sidx:class extends ek{constructor(e){super(e),this.isContainer=!1,this.references=[],this.trackId=e.read(4),this.timescale=e.read(4),0===this.version?(this.pts=e.read(4),this.offset=e.read(4)):(this.pts=e.read(8),this.offset=e.read(8)),e.skip(2);let t=e.read(2);for(let i=0;i<t;i++){let t=ee.fromByte(e,4),i=e.read(4),r=ee.fromByte(e,4);this.references.push({type:t.read(1),size:t.read(31),duration:i,startWithSap:r.read(1),sapType:r.read(3),sapDeltaTime:r.read(28)})}}},sinf:class extends eE{constructor(){super(...arguments),this.isContainer=!0}},smhd:class extends ek{constructor(e){super(e),this.isContainer=!1,this.balance=e.read(2)}},stbl:class extends eE{constructor(){super(...arguments),this.isContainer=!0}},stco:class extends ek{constructor(e){super(e),this.isContainer=!1,this.chunkOffsets=[];for(let t=e.read(4),i=0;i<t;i++)this.chunkOffsets.push(e.read(4))}},stsc:class extends ek{constructor(e){super(e),this.isContainer=!1,this.entries=[];for(let t=e.read(4),i=0;i<t;i++)this.entries.push({firstChunk:e.read(4),samplePerChunk:e.read(4),sampleDescriptionIndex:e.read(4)})}},stsd:class extends ek{constructor(e){super(e),this.isContainer=!0,e.skip(4)}},stss:class extends ek{constructor(e){super(e),this.isContainer=!1,this.sampleNumbers=[];for(let t=e.read(4),i=0;i<t;i++)this.sampleNumbers.push(e.read(4))}},stsz:class extends ek{constructor(e){super(e),this.isContainer=!1,this.sampleSizes=[],this.sampleSize=e.read(4);for(let t=e.read(4),i=0;i<t;i++)0===this.sampleSize?this.sampleSizes.push(e.read(4)):this.sampleSizes.push(this.sampleSize)}},stts:class extends ek{constructor(e){super(e),this.isContainer=!1,this.sampleCounts=[],this.sampleDurations=[];for(let t=e.read(4),i=0;i<t;i++)this.sampleCounts[i]=e.read(4),this.sampleDurations[i]=e.read(4)}},tenc:class extends ek{constructor(e){if(super(e),this.isContainer=!1,e.skip(1),0===this.version)e.skip(1),this.cryptByteBlock=0,this.skipByteBlock=0;else{let t=e.read(1);this.cryptByteBlock=t>>4,this.skipByteBlock=15&t}this.isProtected=e.read(1),this.perSampleIvSize=e.read(1),this.isProtected&&!this.perSampleIvSize?this.keyId=Array.from(Array(16)).map(()=>eO(e.read(1))).join(""):this.keyId=""}},tfdt:class extends ek{constructor(e){super(e),this.isContainer=!1,1===this.version?this.baseMediaDecodeTime=e.read(8):this.baseMediaDecodeTime=e.read(4)}},tfhd:class extends ek{constructor(e){super(e),this.isContainer=!1,this.baseDataOffset=0,this.defaultSampleDescriptionIndex=0,this.defaultSampleDuration=0,this.defaultSampleSize=0,this.defaultSampleFlag=0,this.trackId=e.read(4),1&this.flag&&(this.baseDataOffset=e.read(8)),2&this.flag&&(this.defaultSampleDescriptionIndex=e.read(4)),8&this.flag&&(this.defaultSampleDuration=e.read(4)),16&this.flag&&(this.defaultSampleSize=e.read(4)),32&this.flag&&(this.defaultSampleFlag=e.read(4))}},tkhd:class extends ek{constructor(e){super(e),this.isContainer=!1,this.matrix=[],this.createTime=eB(e.read(4)),this.modifyTime=eB(e.read(4)),this.trackId=e.read(4),e.skip(4),this.duration=e.read(4),e.skip(8),this.layer=e.read(2),this.alternateGroup=e.read(2),this.volume=+(e.read(1)+"."+e.read(1)),e.skip(2),this.matrix=[];for(let t=0;t<36;t++)this.matrix.push(e.read(1));e.back(36);let t=[];for(let i=0,r;i<3;i++)t.push(+(e.readInt(2)+"."+e.readInt(2))),t.push(+(e.readInt(2)+"."+e.readInt(2))),r=e.readInt(4),t.push(+((r>>30)+"."+(0x3fffffff&r)));this.rotation=function(e){if(e.length<5)return 0;let t=Math.hypot(e[0],e[3]),i=Math.hypot(e[1],e[4]);return 0===t||0===i?0:180*Math.atan2(e[1]/i,e[0]/t)/Math.PI}(t),this.width=+(e.read(2)+"."+e.read(2)),this.height=+(e.read(2)+"."+e.read(2))}},traf:class extends eE{constructor(){super(...arguments),this.isContainer=!0}},trak:class extends eE{constructor(){super(...arguments),this.isContainer=!0}},trex:class extends ek{constructor(e){super(e),this.isContainer=!1,this.trackId=e.read(4),this.defaultSampleDescriptionIndex=e.read(4),this.defaultSampleDuration=e.read(4),this.defaultSampleSize=e.read(4),this.defaultSampleFlag=e.read(4)}},trun:class extends ek{constructor(e){super(e),this.isContainer=!1,this.sampleDurations=[],this.sampleSizes=[],this.sampleFlags=[],this.sampleCTSs=[],this.sampleCount=e.read(4),1&this.flag?this.dataOffset=e.readInt(4):this.dataOffset=0,4&this.flag?this.firstSampleFlag=e.read(4):this.firstSampleFlag=0;for(let t=0;t<this.sampleCount;t++)256&this.flag&&(this.sampleDurations[t]=e.read(4)),512&this.flag&&(this.sampleSizes[t]=e.read(4)),1024&this.flag&&(this.sampleFlags[t]=e.read(4)),2048&this.flag&&(0===this.version?this.sampleCTSs[t]=e.read(4):this.sampleCTSs[t]=e.readInt(4))}},udta:eE,url:eE,vmhd:class extends ek{constructor(e){super(e),this.isContainer=!1,this.graphicsMode=e.read(2),this.opcolor=[e.read(2),e.read(2),e.read(2)]}},wave:class extends eE{constructor(){super(...arguments),this.isContainer=!0}},wide:eE},Symbol.toStringTag,{value:"Module"})),e0={loader:new R},e1=()=>({done:!1,duration:0,byteSize:0});class e2 extends eI{constructor(e={}){super(e),this._trexBodys=[],this._reservedMdatHeaders=[],this._reservedSeekTime=0,this._cacheStats=e1(),this._logger=b.MD.createLogger("mp4-parser"),this.maxProbeSize=8,this.name="MP4Parser",this._handlebox=e=>{let{header:t,body:i}=e;switch(t.type){case"sidx":this._sidx=e,this._reservedSeekTime>0&&this._media&&(this._mediaSeek(this._media,this._reservedSeekTime),this._reservedSeekTime=0);return;case"moov":return this._logger.log("moov box loaded",e),this._media=new eD(i),this._reservedSeekTime>0&&this._media.getTracks().some(e=>e.getSamples().length>0)&&(this._mediaSeek(this._media,this._reservedSeekTime),this._reservedSeekTime=0),this._media.getMetadata().tracks.some(e=>!!e.codec)?this.emit("loadedmetadata",this._media.getMetadata()):this.emit("error",new S.Mk(S.Mk.Code.DEMUX_MP4,"no valid tracks"));case"trex":this._trexBodys.push(i);return;case"moof":{let e=this._media;if(!e)return;i.traf.forEach(i=>{if(!i.tfhd)return;let r=e.getTrackById(i.tfhd.trackId||-1),s=this._trexBodys.find(e=>e.trackId==e.trackId);r&&(r.addFragment(i,s,t.pos),this._reservedSeekTime>0&&(r.seek(this._reservedSeekTime),this._reservedSeekTime=0))});return}}},this.opts=e,this.on("loadedbox",this._handlebox)}get status(){return this.loader.status}_parseMetaBox(e,t,i){var r;let s=[];for(;e.unreadLength>=eS.MIN_SIZE;){let n=new eS(e,t+e.delta);if(!n.size){let e=`box ${n.type} invalid size ${n.size}`;this._logger.error(e),this.emit("error",new S.Mk(S.Mk.Code.DEMUX_MP4,e));break}if("mdat"===n.type)return e.back(n.headerSize),{break:!1,boxes:s,mdatHeader:n};if("moov"===n.type&&this._media){this._logger.warn("moov box has already loaded");break}let a=n.size-n.headerSize;if(e.unreadLength<a){e.back(n.headerSize);break}{let t,o=new J(e.buffer,e.offset,a);e.skip(a);let l=eZ[n.type];l?t=new l(o):(t=new eP(o),this._logger.warn(`box ${n.type} has no handler`));let h={header:n,body:t};if(t&&t.isContainer){let e=new e2(e0);e[n.type]=t,null==(r=e._parseMetaBox(o,n.pos+n.headerSize,i).boxes)||r.forEach(e=>{let i=e.header.type;Array.isArray(t[i])?t[i].push(e.body):t[i]=e.body})}s.push(h),null==i||i(h)}}return{break:!0,boxes:s}}_parseMdatBox(e,t,i){let{media:r,mdatHeader:s}=i,n=e.delta+t,a=e.size+t,o=e.readToUint8(),l=[],h=[];r.getTracks().filter(e=>e.getMetadata().type!==X.UNKNOWN).forEach(e=>{e.processPackets(o,n).forEach(e=>h.push(e));let t=e.getNextSamplePos();t>=0&&l.push(t),e.getNextSample()}),h.length?this.emit("loadedpackets",{data:h}):this._logger.debug(`no packet found at mdat rangeStart: ${n}, byteSize: ${a-n}, nextSampleSize: ${r.getTracks().map(e=>e.getNextSampleSize())}`),e.back(o.byteLength);let d=Math.min(...l)-n;if(d<0)throw new S.Mk(S.Mk.Code.DEMUX_MP4,"the mdat data does not contain the start position of the next sample");return e.skip(d),h.length&&s.pos+s.size<a?{break:!1,mdatHeader:void 0}:{break:!0,mdatHeader:s}}_loadTailMoovBox(e){let t=e.pos+e.size;return this._logger.info("mdat is ahead of moov box, cancel the current request and load moov box first"),this.loader.abort(),this.loader.loadRange(t).then(()=>{this._logger.info("load moov box success, jump to the start position of mdat box"),this.loader.jump(e.pos),this.loader.status!==k.SUSPENDED?this.loader.loadRange(e.pos,t-1):this._logger.info("because the loader is suspended, subsequent mdat data is not loaded")}),{break:!0,discard:!0}}_parseLoop(e,t){this._currMdatHeader||(this._currMdatHeader=this._reservedMdatHeaders.find(e=>e.pos+e.size>t&&e.pos<t));let i={break:!1};for(;!i.break;)this._currMdatHeader?this._media?(i=this._parseMdatBox(e,t,{mdatHeader:this._currMdatHeader,media:this._media}),this._mdatParsed=!0,this._currMdatHeader=i.mdatHeader):(i=this._loadTailMoovBox(this._currMdatHeader),this._currMdatHeader=void 0):(i=this._parseMetaBox(e,t,this._handlebox),this._currMdatHeader=i.mdatHeader,i.mdatHeader&&this._reservedMdatHeaders.every(e=>e.pos!==i.mdatHeader.pos)&&this._reservedMdatHeaders.push(i.mdatHeader));return i}_mediaSeek(e,t){this.loader.suspend();let i=this._sidx,r=e.getTracks();if(i){let e=i.header.pos+i.header.size,s=0;i.body.references.some((r,n)=>(s+=r.duration)/i.body.timescale>t?(this._logger.info("seek to the sidx segment at",n),!0):(e+=r.size,!1)),r.forEach(e=>e.resetSamples()),this._reservedSeekTime=t,this.loader.loadRange(e)}else{r.forEach(e=>e.seek(t));let e=Math.min(...r.map(e=>e.getNextSamplePos()));this.loader.loadRange(e)}}_reservedSeek(e){this._reservedSeekTime=e,this.loader.status!==k.LOAD_STARTED&&this.loader.loadRange(this.loader.pos)}getMetadata(){var e;return null==(e=this._media)?void 0:e.getMetadata()}getCacheStats(){return this._cacheStats}match(e){return!1}probe(e){return"ftyp"===[...e.subarray(4,8)].map(e=>String.fromCharCode(e)).join("")}parse(e){this._logger.debug("load segment, origin:",e.origin,"pos:",e.pos,"size:",e.data.byteLength);let{data:t,pos:i}=e,r=this.loader.total<=t.byteLength+i;if(t.byteLength){let e=t,r=i;this._reservedUint8&&(e=J.concatUint8(this._reservedUint8,t),r-=this._reservedUint8.byteLength,this._reservedUint8=void 0);let s=J.fromUint8(e);!this._parseLoop(s,r).discard&&s.unreadLength&&(this._reservedUint8=s.readToUint8())}r&&this._mdatParsed&&this.emit("eos");let s=this.opts.cache;if(s&&(s.maxByteSize||s.maxDuration)){let i=this._cacheStats;if(!i.done){if(i.byteSize+=t.byteLength,this._media){let e=this._media.getTracks().map(e=>{let t=e.getSamples(),i=e.getMetadata().timescale,r=0,n,a=0;for(let o=0;o<e.getNextSampleIndex();o++)if(n=t[o]){if(r+=n.duration/i,a=n.pos+n.size,s.maxDuration&&r>s.maxDuration)return{cachedDuration:r,cachedDataSize:a};if(s.maxByteSize&&a>s.maxByteSize)break}return{cachedDuration:r,cachedDataSize:a}});i.byteSize=Math.max(...e.map(e=>e.cachedDataSize)),i.duration=Math.min(...e.map(e=>e.cachedDuration));let t=!!s.maxByteSize&&i.byteSize>s.maxByteSize,n=!!s.maxDuration&&i.duration>s.maxDuration;i.done=n||t||r}else i.duration=0;i.done?(t.byteLength&&this.loader.store({...e,data:i.byteSize>e.pos?t.slice(0,i.byteSize-e.pos):t}),this.emit("cachedone")):this.loader.store(e)}}}seek(e){this._currMdatHeader=void 0,this._reservedUint8=void 0,this._media&&(!(this._trexBodys.length>0)||this._sidx)?this._mediaSeek(this._media,e):this._reservedSeek(e)}reset(){super.reset(),this._sidx=void 0,this._trexBodys=[],this._media=void 0,this._mdatParsed=!1,this._currMdatHeader=void 0,this._reservedSeekTime=0,this._reservedUint8=void 0,this._reservedMdatHeaders=[],this._cacheStats=e1()}destroy(){super.destroy()}}var e4=((A=e4||{}).VIDEO="video",A.AUDIO="audio",A);let e8=b.MD.createLogger("dash");class e5 extends eI{constructor(e={}){var t;super(),this._reservedUint8s=[],this._extendedVideoEntries=[],this._extendedAudioEntries=[],this._videoEntryIndex=0,this._audioEntryIndex=0,this._cacheDoneMap=new Map,this._allParserEventEmittedMap=new Map,this.name="DashParser",this.maxProbeSize=100,this._setTrackParserEventEmitted=(e,t)=>{let i=this._allParserEventEmittedMap.get(e);i||(i=new Map,this._allParserEventEmittedMap.set(e,i)),i.set(t,!0),this._isAllParserEventEmitted(e)&&this.emit(e)},this._handleAudioError=e=>{this._videoMp4Parser.abort(),this.emit("error",e)},this._handleVideoError=e=>{this._audioMp4Parser.abort(),this.emit("error",e)},this._handleAudioCacheDone=()=>{this.emit("cachedone",X.AUDIO),this._setTrackParserEventEmitted("cachedone",X.AUDIO)},this._handleVideoCacheDone=()=>{this.emit("cachedone",X.VIDEO),this._setTrackParserEventEmitted("cachedone",X.VIDEO)},this._handleAudioEos=()=>{this._setTrackParserEventEmitted("eos",X.AUDIO)},this._handleVideoEos=()=>{this._setTrackParserEventEmitted("eos",X.VIDEO)},this._extendEntry=(e,t)=>({...e,...t}),this._options=e;let i={loaderOptions:{resetFetchingWhenCanceled:!0,...null==(t=e.loader)?void 0:t.getOptions()},cache:e.cache};this._audioMp4Parser=new e2(i),this._videoMp4Parser=new e2(i),this._audioMp4Parser.on("cachedone",this._handleAudioCacheDone),this._videoMp4Parser.on("cachedone",this._handleVideoCacheDone),this._audioMp4Parser.on("eos",this._handleAudioEos),this._videoMp4Parser.on("eos",this._handleVideoEos),this._audioMp4Parser.loader.on("error",this._handleAudioError),this._videoMp4Parser.loader.on("error",this._handleVideoError);let r={loadedpackets:"loadedpackets"},s={exception:"subloaderexception",downloaded:"subloaderdownloaded"};b.bk.remap(this._videoMp4Parser.loader,this,s),b.bk.remap(this._audioMp4Parser.loader,this,s),b.bk.remap(this._videoMp4Parser,this,r),b.bk.remap(this._audioMp4Parser,this,r)}get status(){let e=this._getAvailableParsers();return e.some(e=>e.status===k.ERROR)?k.ERROR:e.some(e=>e.status===k.LOAD_STARTED)?k.LOAD_STARTED:e.some(e=>e.status===k.SUSPENDED)?k.SUSPENDED:e.every(e=>e.status===k.LOAD_COMPLETED)?k.LOAD_COMPLETED:k.IDLE}static isMpdTemplate(e){return e.includes("dash:profile")}_getAvailableParsers(){let e=[];return this._extendedVideoEntries.length&&e.push(this._videoMp4Parser),this._extendedAudioEntries.length&&e.push(this._audioMp4Parser),e}_isAllParserEventEmitted(e){let t=this._allParserEventEmittedMap.get(e);if(t){let e=!0;return this._extendedVideoEntries.length&&(e=e&&!!t.get(X.VIDEO)),this._extendedAudioEntries.length&&(e=e&&!!t.get(X.AUDIO)),e}return!1}setLoader(e){if(super.setLoader(e),e){let t=e.getOptions();this._audioMp4Parser.loader.changeOptions(t),this._videoMp4Parser.loader.changeOptions(t)}}_getCurrentEntrySegment(){return{video:this._extendedVideoEntries[this._videoEntryIndex],audio:this._extendedAudioEntries[this._audioEntryIndex]}}_requestMeta(){let{video:e,audio:t}=this._getCurrentEntrySegment(),i=this._videoMp4Parser,r=this._audioMp4Parser;Promise.all([e&&i.loader.load(e,e.metaStart,e.metaEnd,!0),t&&r.loader.load(t,t.metaStart,t.metaEnd,!0)]).then(e=>{if(e.some(e=>!e))return;let t=i.getMetadata(),s=r.getMetadata(),n={format:Y.DASH,tracks:[],timescale:0,duration:0};if(t&&s)t.duration/t.timescale>s.duration/s.duration?(n.duration=t.duration,n.timescale=t.timescale):(n.duration=s.duration,n.timescale=s.timescale),n.tracks=t.tracks.concat(s.tracks);else if(t)n.duration=t.duration,n.timescale=t.timescale,n.tracks=t.tracks;else{if(!s)return void this.emit("error",new S.Mk(S.Mk.Code.DEMUX_DASH,"no metadata"));n.duration=s.duration,n.timescale=s.timescale,n.tracks=s.tracks}this.emit("loadedmetadata",n),this._requestData()})}_requestData(){let{video:e,audio:t}=this._getCurrentEntrySegment(),i=this._videoMp4Parser,r=this._audioMp4Parser;e&&i.loader.loadRange(e.sidxStart),t&&r.loader.loadRange(t.sidxStart)}getCacheStats(){let e=this._audioMp4Parser.getCacheStats(),t=this._videoMp4Parser.getCacheStats();return{done:this._isAllParserEventEmitted("cachedone"),duration:Math.max(e.duration,e.duration),byteSize:e.byteSize+t.byteSize}}match(e){return b.vV.isObject(e)&&e.format===Y.DASH}probe(e){let t=Array.from(e.subarray(0,1e3)).map(e=>String.fromCharCode(e)).join("");return e5.isMpdTemplate(t)}parse(e){let{data:t,pos:i}=e,r=this.loader.total<=t.byteLength+i;if(this._reservedUint8s.push(t),r&&this._reservedUint8s.length>0){let e=new TextDecoder().decode(J.concatUint8s(this._reservedUint8s));this._reservedUint8s=[],e5.isMpdTemplate(e)?this.emit("loadedmpd",e):e8.warn("invalid template")}}loadJsonSource(e){let{entries:t}=e;if(t){let i={extra:e.extra||{}};this._extendedVideoEntries=t.filter(e=>e.type===e4.VIDEO).map(e=>this._extendEntry(e,i)),this._extendedAudioEntries=t.filter(e=>e.type===e4.AUDIO).map(e=>this._extendEntry(e,i)),this._extendedVideoEntries.length||this._extendedAudioEntries.length?this._requestMeta():this.emit("error",new S.Mk(S.Mk.Code.DEMUX_DASH,"invalid entries"))}}seek(e){this._allParserEventEmittedMap.delete("eos"),this._videoMp4Parser.seek(e),this._audioMp4Parser.seek(e)}suspend(e){e?e===X.AUDIO?this._audioMp4Parser.suspend():e===X.VIDEO&&this._videoMp4Parser.suspend():(this._audioMp4Parser.suspend(),this._videoMp4Parser.suspend())}resume(){return Promise.race([this._videoMp4Parser.resume(),this._audioMp4Parser.resume()])}abort(){this._videoMp4Parser.abort(),this._audioMp4Parser.abort()}reset(){this._extendedVideoEntries=[],this._extendedAudioEntries=[],this._videoEntryIndex=0,this._audioEntryIndex=0,this._videoMp4Parser.reset(),this._audioMp4Parser.reset(),this._cacheDoneMap.clear(),this._allParserEventEmittedMap.clear()}destroy(){this.removeAllListeners(),super.destroy(),this._audioMp4Parser.destroy(),this._videoMp4Parser.destroy()}}let e3={ttplayer_record_event:!!(0,b.HZ)()&&!!localStorage.getItem("ttplayer_record_event"),ttplayer_console_autoclean:!!(0,b.HZ)()&&!!localStorage.getItem("ttplayer_console_autoclean")};var e6=((T=e6||{})[T.DEMUX=0]="DEMUX",T[T.BITRATE=1]="BITRATE",T);let e9={done:!1,duration:0,byteSize:0};class e7 extends b.bk{constructor(){super(),this._waitingQueue=[],this._preloadActiveSourceMap=new Map,this._preloadedAllSourceFlatMap=new Map,this._preloadedAllSourceDedupQueue=[],this._logger=b.MD.createLogger("preloader"),this._config={demuxerOptions:null,skipCache:!1,defaultBitrateSize:209715,maxPreloadedCount:6,maxPreloadDuration:10,maxPreloadByteSize:0,maxConcurrency:1,preloadTriggerPlayTime:0,preloadTriggerBufferDuration:3},this._activeTimer=-1,this._checkActiveSourcePriority=()=>{let e=this._waitingQueue[0];e&&(window.clearTimeout(this._activeTimer),this._activeTimer=window.setTimeout(()=>{if(this._preloadActiveSourceMap.size>=this._config.maxConcurrency){let t=this._preloadActiveSourceMap.keys().next().value,i=t&&this._preloadActiveSourceMap.get(t);if(i&&i.config.priority<e.priority){let e=1===i.type,r=(e?i.loader.status:i.demuxStream.getStatus())===k.LOAD_STARTED;e?i.loader.suspend():i.demuxStream.suspend(),this._preloadActiveSourceMap.delete(t),r&&this._preloadNext()}}},0))},this._checkEnableDebugLog()}get triggerPlayTime(){return this._config.preloadTriggerPlayTime}get triggerBufferDuration(){return this._config.preloadTriggerBufferDuration}_checkEnableDebugLog(){e3.ttplayer_record_event&&b.bk.throttle(this,["preloadstart","preloadedmetadata","preloadend","error","drain","added","downloaded"],["downloaded"],e=>{this._logger.log("event emitted 	->	",e)})}_preloadWithBitrate(e){let t=e.onDequeue?e.onDequeue(e):e,i=t.src;if(S.n9.isEmpty(i))return void this.emit("error",new S.Mk(S.Mk.Code.MEDIA_EMPTY_SRC,"no empty src"));let{bitrate:r}=S.n9.getProps(e.src),{maxPreloadDuration:s}=this._config,n=S.n9.getCacheKey(i)||"",a=Math.round(s*(r||this._config.defaultBitrateSize)/8),o=new R(e.loaderOptions),l={done:!1,duration:0,byteSize:0},h={type:1,config:t,loader:o,rangeEnd:a,getCurrentUrl:()=>o.currentUrl,getStats:()=>l},d=!1,u=()=>{d=!0,this.emit("preloadstart",h)};o.on("downloaded",e=>this.emit("downloaded",e)),o.on("loadstart",u),o.on("loadeddata",e=>o.store(e)),o.on("error",e=>{h.error=e,this.emit("error",e),d&&this.emit("preloadend",h),this.remove(n),this._preloadNext()}),o.on("loadend",()=>{l.byteSize=a,l.duration=s,l.done=!0,this.emit("preloadend",h),this._preloadNext(),o.removeAllListeners(),this._preloadActiveSourceMap.delete(n)}),this._preloadActiveSourceMap.set(n,h),o.load(i,0,a,!0)}_preloadWithDemux(e){let t=e.onDequeue?e.onDequeue(e):e,i=t.src;if(S.n9.isEmpty(i))return void this.emit("error",new S.Mk(S.Mk.Code.MEDIA_EMPTY_SRC,"no empty src"));let r=S.n9.getCacheKey(i)||"";this._logger.info("preload next,",`priority=${t.priority}, cacheKey=${r}`);let s=t.loaderOptions?b.vV.combineDefaultOptions(t.loaderOptions,{origin:P.PRELOAD}):void 0,n={cache:{maxDuration:this._config.maxPreloadDuration,maxByteSize:this._config.maxPreloadByteSize}},a=new Z({name:"preload.demux",parsers:[new e2(n),new e5(n)],...this._config.demuxerOptions,loaderOptions:s}),o=!1,l=()=>{o=!0,this.emit("preloadstart",c)},h=e=>{this.emit("downloaded",e)},d=e=>{c.error=e,this.emit("error",e),o&&this.emit("preloadend",c),this.remove(r),this._preloadNext()};a.on("error",d);let u=e=>{a.suspend(e),e||(a.off("cachedone",u),this._preloadActiveSourceMap.delete(r),o&&this.emit("preloadend",c),this._preloadNext())};a.once("loadstart",l),a.on("downloaded",h),a.on("cachedone",u);let c={type:0,config:t,demuxStream:a,getCurrentUrl:()=>a.getCurrentUrl(),getStats:()=>a.getCacheStats()||e9,finish:()=>{a.off("loadstart",l),a.off("downloaded",h),a.off("cachedone",u),a.off("error",d)}};return this._preloadActiveSourceMap.set(r,c),this.addSource(c),a.load(i),c}_preloadNext(){let{maxConcurrency:e,skipCache:t}=this._config;if(this._preloadActiveSourceMap.size>=e)return;let i=this._waitingQueue.shift();if(!i)return void this.emit("drain");let r=this.getSource(i.src),s=1===i.type;return r?r.getStats().done?void 0:r.demuxStream.resume():(t||s)&&E.getSegmentsBySrc(i.src).length?this._preloadNext():s&&"json"!==S.n9.getProps(i.src).dataType?(this.emit("preloadnext",i),this._preloadWithBitrate(i)):(this.emit("preloadnext",i),this._preloadWithDemux(i))}setConfig(e){Object.assign(this._config,e)}preload(){if(!this._waitingQueue.length)return;this._preloadActiveSourceMap.forEach(e=>1!==e.type?e.demuxStream.resume():e.loader.loadRange(e.loader.pos,e.rangeEnd,!0));let{maxConcurrency:e}=this._config,t=Math.min(e,this._waitingQueue.length);for(let e=0;e<t-this._preloadActiveSourceMap.size;e++)this._preloadNext()}suspend(){this._preloadActiveSourceMap.forEach(e=>1!==e.type?e.demuxStream.suspend():e.loader.suspend())}cancel(){this._preloadActiveSourceMap.forEach(e=>1!==e.type?e.demuxStream.suspend():e.loader.suspend()),this._preloadActiveSourceMap.clear()}extract(e){this._logger.info("extract, key=",e),this._waitingQueue=this._waitingQueue.filter(t=>!S.n9.isContainCacheKey(t.src,e));let t=this._preloadedAllSourceFlatMap.get(e);if(this._preloadActiveSourceMap.delete(e),t){let e=S.n9.getCacheKey(t.config.src);this._preloadedAllSourceDedupQueue=this._preloadedAllSourceDedupQueue.filter(t=>!S.n9.isContainCacheKey(t.config.src,e)),this._preloadedAllSourceFlatMap.delete(e)}return t}addSource(e){let t=S.n9.getCacheKey(e.config.src);this._preloadedAllSourceFlatMap.set(t,e);let i=this._preloadedAllSourceDedupQueue;if(i.some(t=>S.n9.isEqual(t.config.src,e.config.src)))return;i.push(e),i.sort((e,t)=>e.config.priority-t.config.priority);let{maxPreloadedCount:r}=this._config;i.length>r&&i.slice(0,i.length-r).forEach(e=>this.remove(S.n9.getCacheKey(e.config.src)))}add(e){let t=this._preloadedAllSourceDedupQueue[0];if(t&&e.priority<t.config.priority)return void this._logger.warn("add failed, sourceConfig priority cannot be lower than min value in the preloaded queue");let i=this.getSource(e.src);i?(this._logger.info("add, source.config already in preloaded queue, config:",i.config,"->",e),i.config=e):(this._logger.info("add, source.config=",e),this._waitingQueue=this._waitingQueue.filter(t=>!S.n9.isEqual(t.src,e.src))),this._waitingQueue.push(e),this._waitingQueue.sort((e,t)=>t.priority-e.priority),this._checkActiveSourcePriority(),this._waitingQueue.length&&this.emit("added",e)}remove(e){let t=this.extract(e);t&&t.demuxStream.destroy()}getWaitQueue(){return this._waitingQueue}getSource(e){return this._preloadedAllSourceFlatMap.get(S.n9.getCacheKey(e))}getCacheKeys(){return Array.from(this._preloadedAllSourceFlatMap.keys())}pull(e){let t=S.n9.getCacheKey(e),i=this.extract(t);if(i)return i.finish(),i}clearWaitQueue(){window.clearTimeout(this._activeTimer);let e=this._waitingQueue.length;this._waitingQueue=[],e&&this.emit("drain")}clearAll(){this.clearWaitQueue(),this.cancel(),this._preloadedAllSourceFlatMap.clear(),this._preloadedAllSourceDedupQueue.forEach(e=>e.demuxStream.destroy()),this._preloadedAllSourceDedupQueue=[]}}let te=new e7;(0,b.HZ)()&&"1"===localStorage.getItem("ttplayer_preloader_debug")&&(window.__TTPlayerGlobalPreloader__=te);class tt extends b.bk{constructor(e,t){super(),this._lastCheckedTimestamp=0,this._lastCurrentTime=0,this._playing=!1,this._logger=b.MD.createLogger("detector"),this._enabled=!1,this._handleVideoTimeupdate=()=>{let e=b.Hg.getPerformanceNow();if(this._playing&&e-this._lastCheckedTimestamp>1e3){this._lastCheckedTimestamp=e;let t=this._video.currentTime;t-this._lastCurrentTime<.1?(this.emit("waiting"),this._startStuckTimer()):this._clearStuckTimer(),this._lastCurrentTime=t}},this._handleVideoEnded=()=>{this._clearStuckTimer()},this._handleVideoWaiting=()=>{this._startStuckTimer()},this._handleVideoPause=()=>{this._playing=!1,this._clearStuckTimer()},this._handleVideoPlay=()=>{this._playing=!0,this._clearStuckTimer(),this._lastCheckedTimestamp=b.Hg.getPerformanceNow(),this._lastCurrentTime=this._video.currentTime},this._logStuckInfo=e=>{this._logger.getLevel()<=b.$b.INFO&&this._logger.info(e,"playing:",this._playing,"currentTime:",this._video.currentTime,"lastCurrentTime:",this._lastCurrentTime,"range:",ed(this._video.buffered,this._video.currentTime))},this._clearStuckTimer=()=>{void 0!==this._waitTimer&&(window.clearTimeout(this._waitTimer),this._waitTimer=void 0,this._logStuckInfo("clear video stuck timer"))},this._startStuckTimer=()=>{let e=this._options.stuckTimeout||0;e>0&&(this._clearStuckTimer(),this._logStuckInfo("start video stuck timer"),this._waitTimer=window.setTimeout(()=>{this._waitTimer=void 0,this._logStuckInfo("video stuck timeout"),this.emit("timeout")},e))},this._video=e,this._options=b.vV.combineDefaultOptions(t,{stuckTimeout:0})}reset(){this._lastCheckedTimestamp=0,this._lastCurrentTime=0,this._playing=!1,this._clearStuckTimer()}attach(){let e=this._video;this._options.stuckTimeout>0&&!this._enabled&&(e.addEventListener("timeupdate",this._handleVideoTimeupdate),e.addEventListener("waiting",this._handleVideoWaiting),e.addEventListener("play",this._handleVideoPlay),e.addEventListener("pause",this._handleVideoPause),e.addEventListener("ended",this._handleVideoEnded),this._enabled=!0)}detach(){let e=this._video;this._enabled&&(e.removeEventListener("timeupdate",this._handleVideoTimeupdate),e.removeEventListener("waiting",this._handleVideoWaiting),e.removeEventListener("play",this._handleVideoPlay),e.removeEventListener("pause",this._handleVideoPause),e.removeEventListener("ended",this._handleVideoEnded),this._enabled=!1,this._clearStuckTimer())}destroy(){this.removeAllListeners(),this.reset(),this.detach()}}let ti=["error"],tr=["progress"],ts="demux",tn={delay:0};class ta extends b.bk{constructor(e,t){super(),this._logger=b.MD.createLogger("multiplex"),this._handleVideoError=()=>{let{error:e,currentSrc:t}=this._video,i={url:t},r=e?S.Mk.fromMediaError(e,i):new S.Mk(S.Mk.Code.OTHER,"unknown video error",i);this._downgrade(r)},this._handleError=e=>{let t=e instanceof S.Mk?e:new S.Mk(S.Mk.Code.OTHER,e.message);this._downgrade(t)},this._handleStuckTimeout=()=>{this._downgrade(new S.Mk(S.Mk.Code.RUNTIME_WAITING_TIMEOUT,"video playback is stuck timeout"))},this._handleException=e=>{this.emit("exception",e)},this._handleDownloaded=e=>{this.emit("downloaded",e)},this._downgrade=e=>{this._prevMeta=void 0;let t=this._demuxStream.getCurrentUrl(),i=this._video;if(!(eb.isBlob(i.src)&&i.src!==t))return void this._controller.processError();let r=i.currentTime,s=this._video.paused,n=this._demuxStream.getCurrentSrcIndex();this._logger.info("downgrade to h5 caused by multiplex error:",e.message),window.clearTimeout(this._levelTimer),this._demuxStream.abort(),this._remuxStream.reset(),this._mediaSourceStream.reset({clearTiming:eA.DEFAULT}),this._mediaSourceStream.detach(),this._controller.enableEvents(tr),this._videoBufferDetector.setTriggers([ev.PROGRESS,ev.TIMEUPDATE]),0===r&&this._controller.getInternalModule(S.Xi.POSTER).show(),this.emit("downgrade",e)&&(this._videoStuckDetector.detach(),this._controller.sourceIndex=n,this._controller.emit("waiting"),i.src=t,i.currentTime=r,s||i.play().catch(e=>this._logger.warn(e)),this._logger.info("downgrade done, currentTime",i.currentTime))},this._handleControllerLoadedMetadata=()=>{this._videoBufferDetector.setAutoLevelCheck(!0)},this._handleVideoBufferChecking=()=>{let e=this._videoBufferDetector;if(e.level===e_.LOW){if(this._demuxStream.stdout.size>0||this._remuxStream.stdin.size>0||this._remuxStream.stdout.size>0||this._mediaSourceStream.stdin.size>0)return;window.clearTimeout(this._levelTimer),this._demuxStream.resume()}else e.level===e_.HIGH&&(window.clearTimeout(this._levelTimer),this._demuxStream.suspend())},this._checkPreload=(e,t)=>{let i=this._preloader;if(!i)return;let r=this._video;if(r.autoplay&&!r.played.length)return;let s=r.currentTime,n=Math.max(t.end-s,0),a=Math.min(i.triggerBufferDuration,r.duration),o=Math.min(i.triggerPlayTime,r.duration/2),l=s+n>=r.duration-1&&s+a>=r.duration-1;n>=a&&s>=o||l?(this.emit("canpreload"),i.preload()):i.suspend(),(e===ev.UPDATEEND||e===ev.PROGRESS)&&this._controller.emit("progress")},this._handlePreloaderAdded=()=>{this._videoBufferDetector.startPolling()},this._handlePreloaderDrain=()=>{this._videoBufferDetector.stopPolling()},this._handleDemuxLevelChange=e=>{this._options.maxDemuxBufferDuration||e===V.FULL&&(window.clearTimeout(this._levelTimer),this._levelTimer=window.setTimeout(()=>{this._demuxStream.stdout.level===V.FULL&&(this._demuxStream.suspend(),this._logger.warn("demux waterlevel change to full, abort request"))},1e3))},this._handleVideoLevelChange=(e,t)=>{let i=this._mediaSourceStream;this._logger.info("video levelchange",t,"->",e),e===e_.HIGH?i.suspend():e===e_.LOW&&i.resume()},this._handleMseStalled=()=>{let e=this._video.currentTime;this._logger.info("video mse seek stalled, currentTime:",e),this.reset(),this._demuxStream.seek(e)},this._options=b.vV.combineDefaultOptions(t,{loaderOptions:{origin:P.DEFAULT}}),this._logger.info("options",this._options),this._context=e;let{parsers:i,loaderOptions:r,maxDemuxBufferDuration:s}=this._options,n=this._controller=e.controller;n.on("loadedmetadata",this._handleControllerLoadedMetadata),this._demuxStream=new Z({name:ts,parsers:i,maxBufferDuration:s,loaderOptions:r}),this._demuxStream.stdout.on("levelchange",this._handleDemuxLevelChange),this._demuxStream.on("error",this._handleError),this._demuxStream.on("exception",this._handleException),this._demuxStream.on("downloaded",this._handleDownloaded),this._remuxStream=new el({name:"remux"}),this._remuxStream.on("error",this._handleError);let a=this._video=n.getElement();a.addEventListener("error",this._handleVideoError);let o=new ey(a,this._options);o.on("levelchange",this._handleVideoLevelChange),s||o.on("bufferchecking",this._handleVideoBufferChecking),o.on("bufferchecking",this._checkPreload),o.on("error",this._handleError),b.bk.remap(o,this._controller,{bufferchange:"progress"}),this._videoBufferDetector=o;let l=new tt(a,this._options);l.on("timeout",this._handleStuckTimeout),b.bk.remap(l,this._controller,{waiting:"waiting"}),this._videoStuckDetector=l;let h=new eb(this._options);h.on("msestalled",this._handleMseStalled),h.on("error",this._handleError),h.attach(a,o),this._mediaSourceStream=h,this._setup()}_customizePosterBehavior(e){let{clearStrategy:t,clearTiming:i}=this._options;return i===eA.NEXT_VIDEO_READY?(e.preventDefault(),t===eT.REUSE?void 0:t===eT.REUSE_EXCEPT_CODEC_CHANGE?t=>{var i;if((null==(i=t.value)?void 0:i.type)===Q.LoadedMetadata){let i=this._prevMeta,r=t.value.payload;i&&eu(r)===eu(i)&&ec(r)===ec(i)||e.show(),this._prevMeta=r}return t}:t=>{var i;return(null==(i=t.value)?void 0:i.type)===Q.LoadedMetadata&&e.show(),t}):t===eT.REUSE?t=>{var i;return(null==(i=t.value)?void 0:i.type)===Q.LoadedMetadata&&e.setTempHideOptions(tn),t}:t===eT.REUSE_EXCEPT_CODEC_CHANGE?t=>{var i;if((null==(i=t.value)?void 0:i.type)===Q.LoadedMetadata){let i=this._prevMeta,r=t.value.payload;i&&eu(r)===eu(i)&&ec(r)===ec(i)&&e.setTempHideOptions(tn),this._prevMeta=r}return t}:void 0}_setup(){let{controller:e}=this._context,t=e.getInternalModule(S.Xi.POSTER),i=this._customizePosterBehavior(t);this._remuxStream.resume(),this._mediaSourceStream.resume(),this._demuxStream.pipe(this._remuxStream,i).pipe(this._mediaSourceStream),e.disableEvents(ti),e.replaceGetter("rawSrc",()=>this._demuxStream.getCurrentUrl()||this._video.currentSrc||""),e.replaceSetter("currentTime",(e,t,i)=>{let r=this._videoBufferDetector.getRefineCurrentTime(i);return this._logger.info("seek refine currentTime",this._video.currentTime,"->",i,"(",r,")"),this._video.currentTime=r}),e.replaceSetter("src",(e,t,i)=>{i!==t&&this._load(i)})}_load(e){var t,i;e3.ttplayer_console_autoclean&&console.clear();let{_video:r,_mediaSourceStream:s,_videoBufferDetector:n,_videoStuckDetector:a}=this,{controller:o}=this._context;if(this._logger.log("------------------------------ divider ------------------------------"),this._logger.info("src changed to",e),S.n9.isEmpty(e))return o.emit("error",new S.Mk(S.Mk.Code.MEDIA_EMPTY_SRC,"no empty src"));let l=S.n9.getUrl(e,0),{inherit:h,format:d}=S.n9.getProps(e);d===Y.DASH?s.setForceAutoSeekWhenWaiting(!0):s.setForceAutoSeekWhenWaiting(!1);let u=o.getInternalModule(S.Xi.POSTER),c=this._customizePosterBehavior(u);window.clearTimeout(this._levelTimer);let p=this._video.currentTime,f=h?{clearTiming:eA.DEFAULT,clearStrategy:eT.REUSE}:void 0;h||o.emit("playnext"),te.suspend();let m=te.pull(e);this._logger.info("preloader pull, source.config=",null==m?void 0:m.config),n.reset(),a.reset();try{let d=null==m?void 0:m.error,g=E.getSegmentsBySrc(e)||[];if(m&&!d){this._logger.info("use mse with preloaded source"),a.attach();let e=m.getStats(),i=e.duration>0,l=g.reduce((e,t)=>e+t.data.byteLength,0);this._logger.info(`preload info, preloadhit:${i}, preloadCacheSize:${l}, done:${e.done}, duration:${e.duration.toFixed(2)}, dataSize:${e.byteSize}`),this._demuxStream.unpipe(this._remuxStream),this._demuxStream.destroy(),this._demuxStream=m.demuxStream,this._demuxStream.stdout.on("levelchange",this._handleDemuxLevelChange),this._demuxStream.changeName(ts),this._demuxStream.changeOptions({loaderOptions:this._options.loaderOptions,maxBufferDuration:this._options.maxDemuxBufferDuration}),this._demuxStream.on("exception",this._handleException),this._demuxStream.on("downloaded",this._handleDownloaded),this._demuxStream.on("error",this._handleError),this._remuxStream.on("error",this._handleError),this._remuxStream.reset(),o.disableEvents(tr),n.setTriggers([ev.UPDATEEND,ev.TIMEUPDATE]),s.reset(f),s.attach(r,n),s.resume(),e.done&&m.demuxStream.stdout.size>0||this._demuxStream.resume(),this.emit("loadstart"),i&&(this.emit("preloadhit",m),this.emit("cachehit",{segments:g,info:{total:l,extra:null==(t=m.config)?void 0:t.src}})),l&&this.emit("localcachehit"),this._demuxStream.pipe(this._remuxStream,c),h&&p>0&&this._demuxStream.seek(p)}else if(g.length||!this._options.fallback||S.n9.getProps(e).entries){this._logger.info("use mse"),a.attach(),this._demuxStream.abort(),this._demuxStream.reset(),this._remuxStream.reset(),o.disableEvents(tr),n.setTriggers([ev.UPDATEEND,ev.TIMEUPDATE]),s.reset(f),s.attach(r,n),s.resume(),this._demuxStream.load(e);let t=g.reduce((e,t)=>e+t.data.byteLength,0);this._logger.info(`cache info, startCacheSize:${t}`),this.emit("loadstart"),t&&(this.emit("cachehit",{segments:g,info:{total:t,extra:null==(i=null==m?void 0:m.config)?void 0:i.src}}),this.emit("localcachehit")),h&&p>0&&this._demuxStream.seek(p)}else d&&this.emit("downgrade",d),this._logger.info("use pure <video />"),a.detach(),this._demuxStream.abort(),this._demuxStream.reset(),this._remuxStream.reset(),s.reset(),s.detach(),n.setTriggers([ev.PROGRESS,ev.TIMEUPDATE]),o.enableEvents(tr),u.show(),m&&(this._controller.sourceIndex=m.demuxStream.getCurrentSrcIndex()),r.src=l,this.emit("loadstart"),h&&p>0&&(r.currentTime=p)}catch(e){e instanceof S.Mk||this._logger.error(e),this._handleError(e)}}setPreloader(e){this._preloader&&(this._preloader.off("added",this._handlePreloaderAdded),this._preloader.off("drain",this._handlePreloaderDrain)),e&&(e.on("added",this._handlePreloaderAdded),e.on("drain",this._handlePreloaderDrain)),this._preloader=e}changeOptions(e){this._options={...this._options,...e},this._demuxStream.changeOptions(this._options)}printDebugMessage(){this._logger.log(`
demux.stdout: 
 `,this._demuxStream.stdout,`
remux.stdin: 
 `,this._remuxStream.stdin,`
remux.stdout: 
 `,this._remuxStream.stdout,`
mss.stdout: 
 `,this._mediaSourceStream.stdin)}suspend(){return this._demuxStream.suspend()}resume(){return this._demuxStream.resume()}getMetadata(){return this._mediaSourceStream.metadata}reset(){window.clearTimeout(this._levelTimer),this._demuxStream.abort(),this._remuxStream.suspend(),this._mediaSourceStream.suspend(),this._demuxStream.flush(),this._remuxStream.flush(),this._mediaSourceStream.flush(),this._mediaSourceStream.resume(),this._remuxStream.resume()}destroy(){let{controller:e}=this._context;this.setPreloader(null),this._prevMeta=void 0,this._video.removeEventListener("error",this._handleVideoError),this._videoBufferDetector.destroy(),this._videoStuckDetector.destroy(),e.replaceGetter("rawSrc",null),e.replaceSetter("currentTime",null),e.replaceSetter("src",null),e.enableEvents(ti),e.enableEvents(tr),window.clearTimeout(this._levelTimer),this._demuxStream.destroy(),this._remuxStream.destroy(),this._mediaSourceStream.destroy()}}let to={canpreload:"canpreload",cachehit:"cachehit",localcachehit:"localcachehit",preloadhit:"preloadhit",downgrade:"downgrade",loadstart:"loadstart",downloaded:"downloaded",exception:"exception"};class tl extends b.bk{constructor(e){super(),this._logger=b.MD.createLogger("mux.plugin"),this._remapOffCallbacks=[],this.name="multiplex",this._options=e,this._checkEnableDebugLog()}install(e){let{loaderOptions:t}=this._options;if(!window.MediaSource)return void this._logger.warn("The browser does not support [MediaSource API], the plugin will disabled");if(t)if("fetch"===t.type){if(!L.isSupported())return void this._logger.warn("The browser does not support [Fetch API], the plugin will disabled when loaderType='fetch'");O(L)}else"xhr"===t.type?O(D):O(null);this.core=new ta(e,this._options),this._preloader&&this.core.setPreloader(this._preloader),this._remapOffCallbacks=b.bk.remap(this.core,this,to)}_checkEnableDebugLog(){if(!e3.ttplayer_record_event)return;let e=Object.keys(to);b.bk.throttle(this,e,["canpreload","downloaded"],e=>{this._logger.log("event emitted 	->	",e)})}changeOptions(e){this.core?this.core.changeOptions(e):this._options=b.vV.combineDefaultOptions(this._options,e)}setPreloader(e){this.core?this.core.setPreloader(e):e&&(this._preloader=e)}getMetadata(){var e;return null==(e=this.core)?void 0:e.getMetadata()}resume(){var e;return null==(e=this.core)?void 0:e.resume()}suspend(){var e;return null==(e=this.core)?void 0:e.suspend()}reset(){var e;return null==(e=this.core)?void 0:e.reset()}uninstall(){var e;null==(e=this.core)||e.destroy(),this._remapOffCallbacks.forEach(e=>e())}}S.n9.isEmpty=e=>{var t;return!(b.vV.isString(e)?e:e&&(e.entries&&e.entries.length>0||(null==(t=e.urls)?void 0:t.length)>0))};let th="0.3.46"},73522:function(e,t,i){"use strict";i.d(t,{N:function(){return P},a:function(){return x},g:function(){return l},i:function(){return ee},j:function(){return M},k:function(){return R},l:function(){return N},m:function(){return I}});var r=i(98363),s=i(37265),n=i(23636),a=i(59650);function o(e,t){var i;let r="";return t&&(r=(null==(i=n.a.get(t))?void 0:i.resolution)||""),r||(Object.keys(n.R).forEach(t=>{let i=n.R[t];!r&&e.indexOf(i)>-1&&(r=t)}),r)}function l(e,t){for(let i=0;i<e.length;i++){let{range:r,disableList:s=[]}=e[i];if(!(!r||r.length<2)&&t>r[0]&&(t<=r[1]||r[1]<0))return s||[]}return[]}let h="auto",d=new class{constructor(){this.resolutionOrder=[],this.config={resolutionOrder:[...n.j]}}setConfig(e){Object.keys(e).forEach(t=>{this.config[t]=e[t]})}getDisableResolution(e,t){let{hevc:i=[],h264:r=[]}=t||{};return e===n.C.H265?i:r}filterByFormatCodec(e,t,i,r){let s=this.getDisableResolution(t,r||{}),n=e.filter(e=>e.codecType===t&&(e.format===i||e.vtype===i));return s&&0!==s.length?n.filter(e=>e.resolution&&!s.includes(e.resolution)):n}filterTargetList(e,t,i,r){let s=this.filterByFormatCodec(e,t,i,r);return 0===s.length&&i!==n.V.MP4&&(s=this.filterByFormatCodec(e,t,n.V.MP4,r)),0===s.length&&t===n.C.H265&&(s=this.filterByFormatCodec(e,n.C.H264,n.V.MP4,r)),s}getLowestBitrate(e,t,i){let r=this.filterTargetList(e,t||n.C.H264,i||n.V.MP4);return r.sort((e,t)=>e.bitrate-t.bitrate),r.length>0?r[0]:null}duplicatesResolution(e){let t=[],i=[];for(let r=0;r<e.length;r++){let s=e[r],n=s.resolution||"";0>t.indexOf(n)&&(t.push(n),i.push(s))}return i}getResolutionList(e,t,i){let r=[],s=[],n=this.getDisableResolution(i,t||{});for(let t=0;t<e.length;t++){let i=e[t],a=i.resolution||"";if(n.includes(a))continue;let o=r.indexOf(a);o<0?(r.push(a),s.push({resolution:a,bitrateList:[i]})):s[o].bitrateList.push(i)}return s}getResolutionKey(e,t){return o(e,t)}addResolutionKey(e){return e.map(e=>{if(e.resolution)return e;let t=o(e.gearName||e.definition||"",e.qualityType);return e.resolution=t,e})}getTargetResolution(e,t,i){let{resolutionOrder:r}=this.config,s=this.getDisableResolution(i,t||{});if(e===h||!s.includes(e))return e;let n=r.findIndex(t=>t===e),a=null;for(let t=n;t>=0;t--)if(r[t]!==e&&!s.includes(r[t])){a=r[t];break}return a||r[0]}filterByFixedDefinition(e,t){if(t.length<0)return null;if(1===t.length)return t[0];let i=t.filter(t=>t.definition===e||t.qualityType===e);return i.length>0?i[0]:null}filterByResolution(e,t){let{resolutionOrder:i}=this.config;if(t.length<1||!e||e===h)return t;let r=i.indexOf(e)||0,s=[];for(;0===s.length&&r>=0;)s=t.filter(e=>e.resolution===i[r]),r--;return s.sort((e,t)=>e.bitrate-t.bitrate),s.length>0?s:[t[0]]}filterByQualityType(e,t){let i=e.filter(e=>e.qualityType===t);return i.length>0?i[0]:null}filter(e,t,i){let{codec:r=n.C.H264,format:s=n.V.MP4,disableResolutions:a}=t;e.sort((e,t)=>e.bitrate-t.bitrate),e=this.addResolutionKey(e);let o=this.filterTargetList(e,r,s,a);return i?this.duplicatesResolution(o):o}},u=!(0,a.i)()&&window.location.href.indexOf("adapterdebug=1")>-1;function c(e){return parseInt(e,10)}function p(e,t,i=0){return 1===i?function(e,t){if(!e)return null;let i=-1,r=1/0,s=-1;for(let n=0;n<e.length;n++)(s=e[n].bitrate-t)>0&&s<r&&(r=s,i=n);return i<0?null:e[i]}(e,t):function(e,t){if(!e)return null;let i=1/0,r;return e.forEach(e=>{let s=Math.abs(e.bitrate-t);i>s&&(r=e,i=s)}),r||null}(e,t)}function f(e,...t){u&&(0,a.l)(`[BitRateAdapter_${e}]`,...t)}class m{constructor(e){this.selectorName="base",this.config={},this.config={...e}}updateConfig(e){Object.keys(e).forEach(t=>{this.config[t]=e[t]})}getTargetBitrate(e,t){return 0}selectByBitrate(e,t,i){let r=null;return e.length>0&&(r=p(e,t,i)||null),f("Base","select",`targetBitrate:${t} selectAlgType:${i} bitrate:${null==r?void 0:r.bitrate} definition:${null==r?void 0:r.definition}`),r}select(e,t,i){return null}}let g="Default";class _ extends m{constructor(e){super(e),this.selectorName="default"}updateConfig(e){f(g,"updateConfig",e),super.updateConfig(e)}selectByBitrate(e,t,i){let r=null;return e.length>0&&(r=p(e,t,i)||null),f(g,"select",`targetBitrate:${t} selectAlgType:${i} bitrate:${null==r?void 0:r.bitrate} definition:${null==r?void 0:r.definition}`),r}select(e,t,i){let r={...this.config,...t},{codec:s=n.C.H264}=i||{},{quality:a=0,hevcQuality:o=0,hevcResolution:l,defaultResolution:h,selectAlgType:u=0}=r,c=s===n.C.H265?l:h,p=s===n.C.H265?o:a,f=null,m=[];if(e.length>0){let t=(m=d.filterByResolution(c,e)).length;t>0?(t>1&&p&&(f=d.filterByQualityType(m,p)),f||(f=0===u?m[t-1]:m[0])):f=e[0]}return f}}let v="BufferRule",y=new class{constructor(e={}){this._queue=[],this._config={},this.setConfig(e)}setConfig(e){this._config=Object.assign({},e)}get records(){return this._queue}appendPlayInfo(e){let{vid:t,duration:i,endBufferTime:r,stalledTime:s,downloadDuration:n,bitrate:a}=e;if(f(v,"appendPlayInfo",t,e),!i||!a||!r)return;let{slidingWindowWeight:o=0,slidingWindowType:l=0,slidingWindowWeightThreshold:h=0,slidingWindowCountThreshold:d=0}=this._config,u=this.getAdjust(this._config,e),p=0;if(p=c(p="time"===o?Math.min(n,i+s):Math.min(n,i)*a),this._queue.push([u,p,e]),"by_weight"===l){this._queue=this._queue.slice(-30);let e=this._queue.reduce((e,t)=>e+t[1],0)-h;for(;e>0;){let t=this._queue.shift();if(!t)break;if(t[1]>e){t[1]-=e,this._queue.unshift(t);break}e-=t[1]}}else this._queue=this._queue.slice(-d)}getAdjust(e,t){let{startBufferTime:i,endBufferTime:r,leaveWithBlock:s,stalledTime:n,pausedTime:a,downloadDuration:o,bitrate:l}=t,{paramBf:h=.3,paramBp:d=.5,paramUpperBl:u=.7,paramUpper:p=1.5}=e,f=1+((r-i)*h-(n+a)*d)/o;return s&&(f=Math.min(f,u)),s&&(f=Math.min(f,u)),c(l*Math.max(p,f))}getDefaultBitrate(e){if(!e||0===e.length)return 0;let{defaultTargetBitrate:t=1e6}=this._config,i=0;for(let r=0;r<e.length;r++)e[r].bitrate<=t&&e[r].bitrate>=i&&(i=e[r].bitrate);return i||(i=e[e.length-1].bitrate),i}getTargetBitrate(e={},t){let{duration:i=0,bandwidth:r=0}=t||{};if(!this._queue.length||!i)return 0;let s={...this._config,...e},{paramVlLower:n=.8,paramVlUpper:a=.9,paramVl1:o=.7,paramVl2:l=1e3,bitrateLower:h=2e5,bitrateUpper:d=2e6,slidingWindowExtraction:u}=s,p=0,m=this._queue.reduce((e,t)=>e+t[1],0);if("weighted_median"===u){let e=m/2,t=1/0,i=0;this._queue.forEach(r=>{let n=this.getAdjust(s,r[2]);(i=Math.abs(e-r[1]))<t&&(p=n,t=i)})}else p=this._queue.reduce((e,t)=>e+t[1]/m*t[0],0);let g=Math.min(a,Math.max(n,o+l/i)),_=c(Math.max(h,Math.min(d,p*g)));return f(v,"getTargetBitrate",`bandwidth:${r} targetBitrate:${_} bitrateLower:${h} bitrateUpper:${d} value:${p} val1:${p*g} adjust:${g} targetBitrate:${_} duration1:${i}`,s),_}};class A extends m{constructor(e){super(e),this.selectorName="buffer-info",this.rule=y,this.rule.setConfig(e)}updateConfig(e){f("BufferInfo","updateConfig",e),super.updateConfig(e),this.rule.setConfig(e)}getTargetBitrate(e,t){return this.rule.getTargetBitrate(e,t)}select(e,t,i){let r=e.length>0?e[0].duration:0,s=(null==t?void 0:t.selectAlgType)||0,n=this.rule.getTargetBitrate(t,{duration:r||0}),a=null;return e.length>0&&(a=p(e,n,s)||null),a}}let T="PlayingInfo",b=[];class S{constructor(e,t={}){this._timer=-1,this._prevPauseTime=0,this.video=null,this._onEmptied=()=>{this.endPlay("onEmptied")},this._onPlay=()=>{this._calcPausedTime()},this._onPause=()=>{this._prevPauseTime=Date.now()},this._onEnded=()=>{!this._info.downloadDuration&&this._info.canPlayTime&&(this._info.downloadDuration=c(Date.now()-this._info.canPlayTime)/1e3),this.endPlay("ended"),this.disable()},this._canPlay=()=>{if(!this.video)return;this._info.canPlayTime=Date.now(),this._info.duration=this.video.duration;let e=this.video.buffered;e.length&&(this._info.startBufferTime=e.end(e.length-1))},this._onProgress=()=>{if(!this.video)return;let e=this.video.buffered;this._info.canPlayTime&&e.length&&e.end(e.length-1)+.8>this.video.duration&&(this._info.downloadDuration=c(Date.now()-this._info.canPlayTime)/1e3)},this._onTick=()=>{let e=this.video;if(!e)return;this._timer=setTimeout(this._onTick,500);let t=e.currentTime;if(e.paused&&!e.ended&&0!==e.playbackRate&&0!==e.readyState){this._prevCurrentTime=t;return}this._prevCurrentTime===t?this._prevStallTime||(this._prevStallTime=Date.now()):this._calcStallTime(),this._prevCurrentTime=t},this.video=e,this.videoId=(null==t?void 0:t.vid)||e.getAttribute("data-xgplayerid")||new Date().getTime(),this._timer=0,this._prevPauseTime=0,this._prevStallTime=0,this._prevCurrentTime=0,this.resetInfo(),this.enable(),null!=t&&t.bitrate&&(this.bitrate=t.bitrate),null!=t&&t.vid&&(this._info.vid=t.vid)}static get videoInfoList(){return b}static checkIsInList(e){for(let t=0;t<b.length;t++)if(b[t].video===e)return t;return -1}static attachVideo(e,t={}){if(f(T,null==t?void 0:t.vid,"attachVideo"),!e)return;let{duration:i}=e,r=S.checkIsInList(e);r<0?b.push({video:e,playInfo:new S(e,{...t,duration:i||0})}):t.bitrate&&(b[r].playInfo.bitrate=t.bitrate)}static detachVideo(e){var t;if(!e)return;let i=S.checkIsInList(e);if(i>=0){let e=b.splice(i,1);e.length>0&&(f(T,null==(t=e[0].playInfo)?void 0:t.videoId,"detachVideo",b.length),e[0].playInfo.destroy())}}get isStalling(){return!!this._prevStallTime}set bitrate(e){this._info.bitrate=e}enable(){this.disable();let e=this.video;e&&(e.addEventListener("play",this._onPlay),e.addEventListener("pause",this._onPause),e.addEventListener("loadeddata",this._canPlay),e.addEventListener("progress",this._onProgress),e.addEventListener("ended",this._onEnded),e.addEventListener("emptied",this._onEmptied),this._timer=setTimeout(this._onTick,500))}disable(){clearTimeout(this._timer),this.resetInfo();let e=this.video;e&&(e.removeEventListener("play",this._onPlay),e.removeEventListener("pause",this._onPause),e.removeEventListener("loadeddata",this._canPlay),e.removeEventListener("progress",this._onProgress),e.removeEventListener("ended",this._onEnded),e.removeEventListener("emptied",this._onEmptied))}endPlay(e){if(!this.video)return;let t=this.video.buffered;if(t.length)try{this._info.endBufferTime=t.end(t.length-1)}catch{}this._info.leaveWithBlock=this.isStalling,this._calcPausedTime(),this._calcStallTime();let{downloadDuration:i,canPlayTime:r}=this._info;!i&&r&&(this._info.downloadDuration=c(Date.now()-r)/1e3),this.updateRuleByPlayInfo(e)}updateRuleByPlayInfo(e){let t=this.getInfo();y.appendPlayInfo({duration:t.duration,bitrate:t.bitrate,downloadDuration:t.downloadDuration,startBufferTime:t.startBufferTime,endBufferTime:t.endBufferTime,pausedTime:t.pausedTime,stalledTime:t.stalledTime,leaveWithBlock:t.leaveWithBlock,vid:t.vid}),f(T,this.videoId,"updateRuleByPlayInfo",e,t,t.bitrate,"stalledTime",t.stalledTime)}getInfo(){return this._info}resetInfo(){this._prevPauseTime=0,this._prevStallTime=0,this._prevCurrentTime=0,this._info={vid:"",duration:0,pausedTime:0,stalledTime:0,downloadDuration:0,startBufferTime:0,endBufferTime:0,canPlayTime:0,leaveWithBlock:!1,bitrate:0}}destroy(){f(T,this.videoId,"destroy"),this.endPlay("destroy"),this.disable(),this.video=null}_calcStallTime(){this._prevStallTime&&(this._info.stalledTime+=c(Date.now()-this._prevStallTime)/1e3,this._prevStallTime=0)}_calcPausedTime(){this._prevPauseTime&&(this._info.pausedTime+=c(Date.now()-this._prevPauseTime)/1e3,this._prevPauseTime=0)}}let E="BandWidth";class k extends m{constructor(e){super(e),this.selectorName="bandwidth"}getTargetBitrate(e,t){let i={...this.config,...e},{paramA:r=0,paramB:s=0,paramC:n=0,paramD:a=0}=i.autoBitrateParams||{},{bandwidth:o=0}=t||{},{defaultBitrate:l=0,bitrateRange:h=[]}=i,d=o<=0||!o?l:Math.round(r*Math.pow(o,3)+s*Math.pow(o,2)+n*o+a),u=function(e,t){if(0===t.length)return e;let[i,r=e]=t;return e<i?i:e>=r?r:e}(d,h);return f(E,"getTargetBitrate",`bandwidth:${o} targetBitrate:${d}`,i),u}updateConfig(e){f(E,"updateConfig",e),super.updateConfig(e)}select(e,t,i){let r=e.length>0?e[0].duration:0,s=(null==t?void 0:t.selectAlgType)||0,n=this.getTargetBitrate(t,{duration:r||0,...i}),a=null;return e.length>0&&(a=p(e,n,s)||null),f(E,"select",`targetBitrate:${n} bandwidth:${null==i?void 0:i.bandwidth} bitrate:${null==a?void 0:a.bitrate} definition:${null==a?void 0:a.definition}`,e,t,this.config,i),a}}let P=new class{constructor(){this._instanceId="",this.config={t1:5,t2:20,minWeight:.2,maxCount:25,minSize:1024,maxSize:0x5000000},this._samples=[];let e=parseInt(1e3*Math.random(),10);this._instanceId=`[network_speed_${e}]`}get instanceId(){return this._instanceId}updateConfig(e){this.config={...this.config,...e}}getHarmonicSpeed(){if(0===this._samples.length)throw Error("\u6CA1\u6709\u53EF\u7528\u7684\u5386\u53F2\u6570\u636E\u8FDB\u884C\u9884\u6D4B");let e=this._samples.reduce((e,t)=>e+1/t.speed,0);return Math.round(this._samples.length/e)}addSample(e,t){let{speed:i,size:r,duration:s}=e,{maxSize:n,minSize:o,maxCount:l}=this.config;!i||r<=0||s<=1||r<o||r>n||(this._samples.push({speed:i,size:r,duration:s,t:Date.now()}),this._samples.length>l&&this._samples.shift(),(0,a.l)(this.instanceId,"addSample",`from:${t}`,`recordCount:${this._samples.length} speedAvg:${this.getAvgSpeed()} speed:${this.getSpeed()} harmonicSpeed:${this.getHarmonicSpeed()}`,e))}getTimeWeight(e,t){let{t1:i=5,t2:r=20,minWeight:s=.2}=this.config,n=Math.round((t-e)/1e3);return n<=i?1:n>=r?s:Math.round((100-100*s)/(r-i)*(r-n))/100}getSpeed(){var e;let t=Date.now(),{_samples:i}=this;if(!i||0===i.length)return 0;let r=0,s=i.map(e=>{let i=e.size*this.getTimeWeight(e.t||0,t);return r+=i,{weight:i,speed:e.speed}});if(0===r)return 0;s.sort((e,t)=>e.speed-t.speed);let n=r/2,a=0;for(let e of s)if((a+=e.weight)>=n)return e.speed;return(null==(e=s[s.length-1])?void 0:e.speed)||0}getAvgSpeed(){let{_samples:e}=this,t=0;for(let i=0;i<e.length;i++)t+=e[i].speed;return e.length>0?Math.round(t/e.length):0}},w="Main",x=new class{constructor(){this.defaultSelector="default";let e={quality:20,hevcQuality:14,hevcResolution:n.i.R_720,defaultResolution:n.i.R_540,minBitrate:0,maxBitrate:0,defaultFormat:n.V.MP4,defaultCodecType:n.C.H264,userSelectResolution:"auto",resolutionOrder:["360P","480P","540P","720P","1080P"],selector:"default",selectConfig:{defaultBitrate:1e6},selectAlgType:0,disableResolutions:{h264:[],hevc:[]},factors:[]},t={selectAlgType:e.selectAlgType,...e.selectConfig};this._selectors={default:new _(t),"buffer-info":new A(t),bandwidth:new k(t)},this.config={...e}}static get PlayingInfo(){return S}get resolutionFilter(){return d}set disableResolutions(e){this.resolutionFilter.config.disableResolutions=e}updateConfig(e){let t=this.getSelector(this.defaultSelector);Object.keys(e).forEach(t=>{this.config[t]=e[t]});let i=function(e){let t={};return["quality","hevcQuality","hevcResolution","defaultResolution","selectAlgType"].forEach(i=>{e[i]&&(t[i]=e[i])}),t}(e);if(null==t||t.updateConfig(i),e.selectConfig){let t=e.selectConfig||{};Object.keys(this._selectors).forEach(e=>{this._selectors[e].updateConfig(t)})}e.filterConfig&&d.setConfig(e.filterConfig)}setUseSelectResolution(e){this.config.useSelectResolution=e}addSelector(e,t,i){this._selectors[e]=new t(i||{})}getSelector(e){let t=this._selectors[e];return t||(t=this._selectors[this.defaultSelector]||this._selectors.defalut),t}getDefaultSelector(){return this._selectors[this.defaultSelector]}getFixedDefinition(e,t){return d.filterByFixedDefinition(e,t)}getLowestBitrate(e,t){let{codec:i=n.C.H264,format:r=n.V.MP4,disableResolutions:s=this.config.disableResolutions}=t||{},a=d.filterTargetList(e,i,r,s);return a.sort((e,t)=>e.bitrate-t.bitrate),a.length>0?a[0]:null}getTargetList(e,t){let{codec:i=n.C.H264,format:r=n.V.MP4,disableResolutions:s}=t;return d.addResolutionKey(e),e.sort((e,t)=>e.bitrate-t.bitrate),d.filterTargetList(e,i,r,s)}getFallbackList(e,t){return d.addResolutionKey(e),e.sort((e,t)=>e.bitrate-t.bitrate),d.filterTargetList(e,n.C.H264,n.V.MP4,t)}getResolutionList(e,t,i){return d.getResolutionList(e,t,i)}filterResolutionList(e,t){let i=e.length>0?e[0].uri:"",r=d.filter(e,t,!0);return f(w,i,"filterResolutionList",t,r),r}getTargetBitrate(e,t,i){let{mixFactor:r}=e,s=0,n=0,a=0;return r?(n=this._selectors["buffer-info"].getTargetBitrate(e,t),a=this._selectors.bandwidth.getTargetBitrate(e,t),r>0&&r<=1?s=Math.round(a*r+n*(1-r)):r<0?s=Math.min(a,n):r>1&&(s=Math.max(a,n))):s=this.getSelector(i).getTargetBitrate(e,t),f(w,"getTargetBitrate",`mixFactor:${r} bufferBitrate:${n} bindWidthBitrate:${a}  targetBitrate:${s} selector:${i}`,e,t),s}filter(e,t){let{codec:i=n.C.H264,format:r=n.V.MP4,disableResolutions:s=this.config.disableResolutions}=t,a=i,o=r,l=this.getTargetList(e,{codec:i,format:r,disableResolutions:s});l.length>0&&(a=l[0].codecType,o=l[0].format);let h=this.getResolutionList(l,s,a);return{fallbackBitrateList:this.getFallbackList(e,s),targetBitrateList:l,codec:a,format:o,resolutionList:h}}select(e,t,i="default",r={}){if(e.length<1)return null;let s=r.selector||this.config.selector||this.defaultSelector,{codec:a,format:o,definition:l,resolution:u,disableResolutions:c=this.config.disableResolutions}=t,p=a||n.C.H264,m=o||n.V.MP4,g=e[0].vid,_=e[0].duration||0,v=e;if(a&&o){let{targetBitrateList:i=[]}=this.filter(e,t);i.length>0&&(p=(v=i)[0].codecType,m=v[0].format)}let y=u||this.config.userSelectResolution||h,A=d.getTargetResolution(y,c,p),T=null,b=0,S=l||"";if(S&&(T=this.getFixedDefinition(S,v),A!==h&&(null==T?void 0:T.resolution)!==A&&(T=null)),!T){let e={quality:this.config.quality,hevcQuality:this.config.hevcQuality,...this.config.selectConfig,...r.config},t=d.filterByResolution(A,v),i={codec:p,format:m,duration:_,bandwidth:P.getAvgSpeed()};b=this.getTargetBitrate(e,i,s)||0;let n=this.getDefaultSelector();T=0===b?n.select(t,e,i):n.selectByBitrate(t,b,e.selectAlgType||0)}return f(w,"select",g,`from:${i}`,`codec:${p} format:${m} selectResolution:${y} targetResolution:${A} selector:[${s}] 
      targetBitrate:${b} bitrate:${null==T?void 0:T.bitrate} definition:${null==T?void 0:T.definition}
      downloadSpeedAvg:${P.getAvgSpeed()} downloadSpeed:${P.getSpeed()}`,e.length,T,v),T&&(T.targetBitrate=b),T}attachVideo(e,t){S.attachVideo(e,t)}detachVideo(e){S.detachVideo(e)}};function C(e,t,i,r="default",s=n.M.VIDEO){return`${e}#${s}#${t}#${i}#${r}`}function L(e){return e?"string"==typeof e?[e]:e:[]}function D(e,t,i){let{url:r,vtype:s,codecType:a,definition:o,mediaExtra:l}=t,h=C(e,a,s,o,n.M.VIDEO);return{type:i,cacheKey:h,urls:L(r),...function(e){let{index_range:t,init_range:i}=e||{};return{sidxStart:(null==t?void 0:t.start)||0,sidxEnd:(null==t?void 0:t.end)||0,metaStart:(null==i?void 0:i.start)||0,metaEnd:(null==i?void 0:i.end)||0}}((null==l?void 0:l.baseRangeInfo)||{})}}function I(e,t,i,r,a,o){let{url:l,vtype:h=n.V.MP4,codecType:d,definition:u}=t,c=C(e,d,h,u),p={...t,vid:e,bitrateList:a||[],audioBitrate:i,targetCodec:(null==o?void 0:o.targetCodec)||t.codecType,targetFormat:(null==o?void 0:o.targetFormat)||t.vtype};return h===n.V.DASH?{format:s.o8.DASH,dataType:"json",cacheKey:c,urls:r?L(r.url):[],entries:function(e,t,i){let r=[];return r.push(D(e,t,s.hV.VIDEO)),i&&r.push(D(e,i,s.hV.AUDIO)),r}(e,t,i),extra:p}:{format:s.o8.MP4,cacheKey:c,urls:L(l),extra:p}}function R(e){var t;if(!e||!e.info)return null;let{info:i,segments:r=[]}=e,a=0,o=0,{codecType:l,vid:h="",vtype:d="",definition:u,bitrate:c,size:p=0,qualityType:f=0}=(null==(t=null==i?void 0:i.extra)?void 0:t.extra)||(null==i?void 0:i.extra)||{};return r.forEach(e=>{let{data:t,origin:i}=e;i===s.rP.PRELOAD?o+=t.byteLength:a+=t.byteLength}),{cacheSize:a,preloadSize:o,dataSize:a+o,codecType:l,vtype:d,vid:h,definition:u,qualityType:f,bitrate:c,size:p,hitType:n.h.UNKNOWN,mediaType:"video",total:p,order:0,timeStamp:0}}function O(e){return R(s.t8.get(e))}function M(e){let t=B(e),i=null;return t&&(i=O(t)),i}function B(e,t=n.M.VIDEO){let i=s.t8.getCacheKeys(),r=function(e,t=n.M.VIDEO){return`${e}#${t}`}(e,t);for(let e=i.length-1;e>=0;e--)if(i[e].includes(r))return i[e];return null}function N(e){return e.length<0?null:(e.sort((e,t)=>t.bitrate-e.bitrate),e[0])}let U={preloadTime:10,segmentMinDuration:10,preloadCacheType:1,preloadMaxCacheCount:5,minBufferLength:10};function F(e){return e===n.P.NEW_TT}function V(e){return"string"==typeof e?e:e.map(e=>({src:e}))}let $="[TTPreloader]";function z(e,t){let{vid:i="",codecType:r,format:s,vtype:n,definition:a,bitrate:o,qualityType:l=0,size:h=0,url:d,duration:u,resolution:c}=e,p={vid:i,codecType:r,vtype:s||n||"MP4",format:s||n||"MP4",definition:a,size:h,bitrate:o,qualityType:l,duration:u,resolution:c};return t?{...p,url:V(d)}:{...p,url:d}}function j(e){var t;let{error:i,config:r}=e,s=e.getStats();if(i)return null;{let{vid:i,codecType:n,vtype:a,qualityType:o=0,definition:l}=(null==(t=r.src)?void 0:t.extra)||{};return{url:e.getCurrentUrl(),vid:i,definition:l,qualityType:o,vtype:a,codecType:n,mediaType:"video",timeStamp:Date.now(),order:r.priority,total:(null==s?void 0:s.byteSize)||0,duration:Math.round(1e3*((null==s?void 0:s.duration)||0))}}}let G=e=>{let t=e.src;if(!t||"string"==typeof t||!t.extra)return e;let{bitrateList:i=[],audioBitrate:r,definition:o,targetCodec:l,targetFormat:h=n.V.MP4,vid:d}=t.extra,u=M(d),c=(null==u?void 0:u.definition)||"";(0,a.l)($,"onDequeue bitrateSelect",d,o,l,h,r,u,i);let p=x.select(i,{codec:l,format:h,definition:c},$);if(p){let t=I(d,p,r);e.src=t,(0,a.l)($,"onDequeue bitrateSelect result",d,`getWaitCount:${s.RC.getWaitQueue().length} cacheDefinition:${c} targetCodec:${l}, targetFormat:${h} df:${o} newDf:${null==p?void 0:p.definition}`,t.cacheKey,e)}return e},H=e=>{var t;(0,a.l)($,"onPreloaderStart",null==(t=j(e))?void 0:t.vid)},W=e=>{(0,a.l)($,"onPreloaderEnded",e)},q=e=>{(0,a.l)($,"onPreloaderError",e)},K=e=>{var t,i,r;(0,a.l)($,"onPreloadNext",`vid:${null==(i=null==(t=e.src)?void 0:t.extra)?void 0:i.vid} priority:${null==e?void 0:e.priority} format:${null==(r=e.src)?void 0:r.format}`)},Y=e=>{let{byteSpeed:t,byteLength:i,duration:r}=e;P.addSample({speed:Math.round(8*t),size:i,duration:Math.round(1e3*r)},$)};function X(e){let t=e.startPreloadControl,i=e.preloadMaxCacheCount||0,r=!e.maxPreloadByteSize||e.maxPreloadByteSize<0?0:e.maxPreloadByteSize;return{demuxerOptions:e.demuxerOptions,maxConcurrency:e.maxConcurrency||1,maxPreloadedCount:e.maxPreloadedCount||i,maxPreloadDuration:e.maxPreloadDuration||e.preloadTime,maxPreloadByteSize:r,preloadTriggerPlayTime:e.preloadTriggerPlayTime||(t?e.startPreloadMinPosTime:0),preloadTriggerBufferDuration:e.preloadTriggerBufferDuration||(t?e.startPreloadMinBuffer:e.minBufferLength),skipCache:e.skipCache||!1}}let Q="[XGPreloader]",J=e=>{let{len:t=0,time:i=0,speed:r=0}=e,s={speed:r,size:t,duration:i};P.addSample(s,Q),(0,a.l)(Q,"onDataDownload",s,P.getAvgSpeed())},Z="[MultiMediaPreloader]",ee=new class{constructor(){if(this.ttPreloader=s.RC,this.type=n.P.XG,this.codecType=n.C.H264,this.format=n.V.MP4,this.open=!1,this.playingVids=[],this.preloadType=s.Lw.DEMUX,this._ttLoaderOptions={},this.ttPriority=1,this.getRequestOptionsCallback=null,typeof window>"u"){this.preloader=null;return}this.preloader=r.y5.registerPreloader({...U}),r.y5.BitRateAdapter=x,this.ttPreloader=s.RC;let e=X({...U});s.RC.setConfig(e),window.globalLoaderCache=s.t8,this.enable()}setType(e){this.type=e}update(e,t){var i;if((0,a.l)(Z,"update",e,U),F(t)){let t=X({...U,...e});(0,a.l)(Z,"ttPreloadConfig",`preloadType:${e.preloadType}`,t),this.ttPreloader.setConfig(t),e.preloadType&&(this.preloadType=e.preloadType)}else null==(i=this.preloader)||i.update(e);e.loaderOptions&&(this.loaderOptions=e.loaderOptions),e.getRequestOptionsCallback&&(this.getRequestOptionsCallback=e.getRequestOptionsCallback)}set loaderOptions(e){Object.keys(e).forEach(t=>{this._ttLoaderOptions[t]=e[t]})}changeCodec(e,t){var i;let r=this.codecType;this.codecType=e,(0,a.l)(Z,"changeCodec",e,r,t),F(t)?(i=this.ttPreloader,i&&r===n.C.H265&&e===n.C.H264&&i.getCacheKeys().forEach(e=>{e.includes(n.C.H265)&&i.remove(e)})):function(e,t){if(e){if(e.codecType===n.C.H265&&t===n.C.H264){let{allCachedKeys:t}=e;for(let i in t)i.includes(n.C.H265)&&e.removeItem(i,e=>{(0,a.l)("[changeCodec] remove success",i,e)})}e.codecType=t}}(this.preloader,e)}changeFormat(e){let t=this.format;(0,a.l)(Z,"changeFormat",t,e),this.format=e}attachPlayer(e,t){var i;F(t)?this.ttPreloader:(i=this.preloader,null==i||i.attachPlayer(e))}detachPlayer(e){var t;if(F(e))return void this.ttPreloader;null==(t=this.preloader)||t.detachPlayer()}addPreloadList(e,t){if(F(t)){let t=function(e,t,i,r){var o,l;let h=r.ttPriority,{codec:d,vtype:u,getRequestOptionsCallback:c,loaderOptions:p,type:f}=r,m=[],g=[];for(let r=t.length-1;r>=0;r--){let _=t[r],{vid:v}=(null==_?void 0:_.data)||{},y=function(e,t){return!!e&&!!t&&e.findIndex(e=>e===t)>-1}(i,v),A=B(v);if(!y&&!A){let t=function(e,t,i,r,o,l,h){let{reqOptions:d,getRequestOptionsCallback:u,data:c}=t,{bitrateList:p=[],audioBitrateList:f=[],vid:m=""}=c;0===p.length&&p.push(z(t.data,!1));let g=x.getLowestBitrate(p,{codec:i,format:r}),_=N(f);if(g){let t=I(m,g,_,null,p,{targetCodec:i,targetFormat:r||n.V.MP4});if(!t)return null;let c=u||o,f={...l,onBeforeRequest:(e,t)=>{let i=null;return c?(i=c({url:e}))&&(t.credentials=i.credentials):d&&(t.credentials=d.credentials),t}},v={type:r===n.V.MP4&&h===s.Lw.BITRATE?s.Lw.BITRATE:s.Lw.DEMUX,src:t,priority:e,loaderOptions:f,onDequeue:G};return(0,a.l)($,"transformTTPreload",i,l,g,v),v}return null}(h++,_,d,u,c,p,f),i=null==(o=null==t?void 0:t.src)?void 0:o.cacheKey,r=null==(l=null==t?void 0:t.src)?void 0:l.extra;(function(e,t){return e.getWaitQueue().findIndex(e=>{var i;return(null==e?void 0:e.src)===t||(null==(i=null==e?void 0:e.src)?void 0:i.cacheKey)===t})>-1})(e,i)||(t&&e.add(t),g.push(`${null==r?void 0:r.vid}_${h}`),m.push(_))}}return(0,a.l)($,"addPreload List",g),m}(this.ttPreloader,e,this.playingVids,{codec:this.codecType,vtype:this.format,type:this.preloadType,getRequestOptionsCallback:this.getRequestOptionsCallback,ttPriority:this.ttPriority,loaderOptions:this._ttLoaderOptions});return t.length>0&&(this.ttPriority+=t.length),(0,a.l)(Z,"addPreloadList TTPreloader1",this.codecType,this.format,`ttPriority:${this.ttPriority}`,`orgLength:${e.length} addLength:${t.length}`),t}var i=this.preloader;let r=e.map(e=>{let{data:t,getRequestOptionsCallback:i,reqOptions:r}=e,{bitrateList:s=[],vid:n=""}=t,a=[];0===s.length?a.push(z(e.data,!0)):a=s.map(e=>({...e,url:V(e.url)}));let o={reqOptions:r,getRequestOptionsCallback:i,payload:a,vid:n};return{order:e.order,data:o}});return(null==i?void 0:i.addPreloaderList(r))||[]}clearTask(e){var t,i;F(e)?null==(t=this.ttPreloader)||t.clearWaitQueue():null==(i=this.preloader)||i.clearTask()}clearAll(e){if(this.clearTask(e),F(e))this.ttPreloader.clearAll();else if(this.preloader){this.preloader.clearTask(),this.preloader.playingVids1=[];let{cacheInst:e}=this.preloader;e&&(e.clear(),e._allCachedKeys={},e._allCachedTimeKeys={})}}getPreloadMeta(e,t){var i;let r=null;return F(t)?r=function(e,t){let i=B(t);if(!i)return null;let r=e.getSource(i)||null;if(r){let e=j(r);return(0,a.l)($,"getPreloadMeta",i,r,e),e}return null}(this.ttPreloader,e):(i=this.preloader,r=(null==i?void 0:i.getPreloadMetaByVid(e))||null),(0,a.l)(Z,"getPreloadMeta",e,t,r),r}addPlayingVid(e,t){var i;(0,a.l)(Z,"addPlayingVids",e,t),F(t)?this.playingVids.push(e):(i=this.preloader,null==i||i.addPlayingVid(e))}getPlayingVid(e){var t;return F(e)?this.playingVids:(t=this.preloader)?t.playingVids1:[]}removePlayingVid(e,t){if(F(t)){let{playingVids:t}=this,i=t.findIndex(t=>t===e);i>-1&&t.splice(i,1)}else{var i;i=this.preloader,null==i||i.removePlayingVid(e)}(0,a.l)(Z,"removePlayingVids",e,t,this.getPlayingVid(t))}on(e,t,i){var r,s;F(i)?null==(r=this.ttPreloader)||r.on(e,t):null==(s=this.preloader)||s.on(e,t)}off(e,t,i){var r,s;F(i)?null==(r=this.ttPreloader)||r.off(e,t):null==(s=this.preloader)||s.off(e,t)}bindXGEvents(){var e;null==(e=this.preloader)||e.on("prf_data_size",J)}unbindXGEvents(){var e;null==(e=this.preloader)||e.off("prf_data_size",J)}bindTTEvents(){this.ttPreloader.on("preloadend",W),this.ttPreloader.on("preloadstart",H),this.ttPreloader.on("error",q),this.ttPreloader.on("preloadnext",K),this.ttPreloader.on("downloaded",Y)}unbindTTEvents(){this.ttPreloader.off("preloadend",W),this.ttPreloader.off("preloadstart",H),this.ttPreloader.off("error",q),this.ttPreloader.off("preloadnext",K),this.ttPreloader.off("downloaded",Y)}disable(){this.open&&(this.open=!1,this.unbindTTEvents(),this.unbindXGEvents())}enable(){this.open||(this.open=!0,this.bindTTEvents(),this.bindXGEvents())}getCore(e){return F(e)?this.ttPreloader:this.preloader}getCacheDataByCacheKey(e){return O(e)}formatCacheData(e){return R(e)}}},71551:function(e,t,i){"use strict";let r,s,n;i.d(t,{SX:function(){return t$},SN:function(){return tB},mx:function(){return tO}});var a=i(28731),o=i(37265),l=i(13823),h=i(50840),d=i(27542),u=i(22626),c=i.n(u),p=Object.defineProperty,f=(e,t,i)=>{let r;return(r="symbol"!=typeof t?t+"":t)in e?p(e,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[r]=i};class m{constructor(){this.__handlers=[],window.ResizeObserver&&(this.observer=new window.ResizeObserver(e=>{this.__trigger(e)}))}addObserver(e,t){if(!this.observer)return;this.observer&&this.observer.observe(e);let{__handlers:i}=this,r=-1;for(let t=0;t<i.length;t++)i[t]&&e===i[t].target&&(r=t);r>-1?this.__handlers[r].handler.push(t):this.__handlers.push({target:e,handler:[t]})}unObserver(e){let t=-1;this.__handlers.map((i,r)=>{e===i.target&&(t=r)}),this.observer&&this.observer.unobserve(e),t>-1&&this.__handlers.splice(t,1)}destroyObserver(){this.observer&&this.observer.disconnect(),this.observer=null,this.__handlers=[]}__runHandler(e,t){let{__handlers:i}=this;for(let r=0;r<i.length;r++)if(i[r]&&e===i[r].target){i[r].handler&&i[r].handler.forEach(i=>{try{i(e,t)}catch(e){console.error(e)}});break}}__trigger(e){e.map(e=>{let t=e.contentRect;this.__runHandler(e.target,t)})}}let g=null,_="change",v="update",y="error",A=[{code:0,msg:"SUCCESS"},{code:1,msg:"LOAD_ERROR",type:"LOAD_ERROR"},{code:2,msg:"PARSER_ERROR",type:"PARSER_ERROR"},{code:3,msg:"FORMAT_NOT_SUPPORTED",type:"FORMAT_NOT_SUPPORTED"},{code:4,msg:"ID_OR_LANGUAGE_NOT_EXIST",type:"ID_OR_LANGUAGE_NOT_EXIST"},{code:5,msg:"PARAMETERS_ERROR",type:"PARAMETERS_ERROR"},{code:6,msg:"ABORT",type:"ABORT"},{code:7,msg:"UNKNOWN",type:"UNKNOWN"},{code:8,msg:"DATA_ERROR:subtitle.url is null",type:"DATA_ERROR"},{code:9,msg:"DATA_ERROR:subtitle.url length is 0",type:"DATA_ERROR"}];class T extends Error{constructor(e,t,i,r){e||(e=A[t||7].msg),super(e),this.message="",this.code=t||7,this.message=e,this.type=A[t||7].msg,this.orgError=i||null,this.data=r||null}}function b(e,t={},i){let r={code:A[e].code,message:A[e].msg,id:"",language:""};return Object.keys(t).map(e=>{r[e]=t[e]}),r}class S{constructor(){let e,t,i=new Promise((i,r)=>{e=i,t=r});return i.resolve=function(t){e(t),i.state="fulfilled"},i.reject=function(e){t(e),i.state="rejected",i.isBreak="DESTROYED"===e},i.state="pending",i}resolve(e){}reject(e){}}function E(e,t){if(!e)return!1;if(e.classList)return Array.prototype.some.call(e.classList,e=>e===t);{let i=e.className&&"object"==typeof e.className?e.getAttribute("class"):e.className;return i&&!!i.match(RegExp("(\\s|^)"+t+"(\\s|$)"))}}function k(e,t){e&&(e.classList?t.replace(/(^\s+|\s+$)/g,"").split(/\s+/g).forEach(t=>{t&&e.classList.add(t)}):E(e,t)||(e.className&&"object"==typeof e.className?e.setAttribute("class",e.getAttribute("class")+" "+t):e.className+=" "+t))}function P(e){let t=Object.prototype.toString.call(e).match(/([^\s.*]+)(?=]$)/g);return t?t[0]:""}function w(e="div",t="",i={},r=""){let s=document.createElement(e);return s.className=r,s.innerHTML=t,Object.keys(i).forEach(t=>{let r=i[t];"video"===e||"audio"===e||"live-video"===e?r&&s.setAttribute(t,r):s.setAttribute(t,r)}),s}function x(e){return e&&e instanceof window.HTMLMediaElement}function C(e){let t=[];if(e&&"String"===P(e))t.push({url:[e],index:0,start:-1,end:-1});else if("Array"===P(e)){if(0===e.length)return t;"String"===P(e[0])?t.push({url:e,index:0,start:-1,end:-1}):e.forEach((e,i)=>{t.push({url:e.url||e.src||"",index:i,start:e.start||-1,end:e.end||-1})})}return t}function L(e,t,i){let r=t.length;if(r<1)return -1;if(t[i=i<0?0:i>=r?r-1:i].start<=e&&e<t[i].end)return i;{let s=t[i].end<=e?i+1:0;for(;s<r;s++){if(t[s].start<=e&&e<t[s].end)return s;if(e>t[s].end&&s+1<r&&e<t[s+1].start||e>t[s].end&&s+1>=r)break}return -1}}function D(e,t,i){let r=t.length;if(r<1)return[];let s=[];if((i=i<0?0:i>=r?r-1:i)<r){let n=t[i].end<=e?i:0;for(;n<r&&(t[n].start<=e&&e<t[n].end&&s.push(n),!(e<t[n].start));n++);}return s}function I(e,t){return!!(e.id&&t.id&&e.id===t.id||e.language&&t.language&&e.language===t.language)}let R=/^WEBVTT/,O=/^STYLE+$/,M=/^\:\:cue/,B=/^}+$/,N=/^\[Script Info\].*/,U=[/[0-9]{1,3}:[0-9]{2}:[0-9]{2}\.[0-9]{1,3}-->[0-9]{1,3}:[0-9]{2}:[0-9]{2}\.[0-9]{1,3}/,/[0-9]{1,3}:[0-9]{2}\.[0-9]{1,3}-->[0-9]{1,3}:[0-9]{2}\.[0-9]{1,3}/,/[0-9]{1,2}\.[0-9]{1,3}-->[0-9]{1,2}\.[0-9]{1,3}/],F=/^Format:\s/,V=/^Style:\s/,$=/^Dialogue:\s/;function z(e){let t=e.length;return 3===t?((60*Number(e[0])+Number(e[1]))*6e4+1e3*Number(e[2]))/1e3:2===t?(60*Number(e[0])*1e3+1e3*Number(e[1]))/1e3:Number(e[0])}function j(e,t){return e>=0&&e<t.length?t[e]:""}class G{static parseJson(e){let t=[],i=0;for(let r=0;r<e.length;r++){if(i>=50&&(i=0),0===i){let i={start:e[r].start,list:[e[r]],end:e[r].end};t.push(i)}else t[t.length-1].list.push(e[r]),t[t.length-1].end=e[r].end;i++}return t}static parse(e,t){let i=G.checkFormat(e);if(!i)return void t({format:"unknown"},new T("unknown_format",3));try{let r={list:[],styles:[]};"ass"===i?r=G.parseASS(e):"vtt"===i&&(r=G.parseVTT(e)),t({format:i,list:r.list,styles:r.styles})}catch(e){console.error(e),t({format:i},new T(`parse_error_${e.message}`,2,e))}}static parseASSItem(e="",t=[]){let i=e.split(","),r={},s="";try{let e=i.length-t.length;return s=(s=e>0?i.splice(t.length-1,e+1).join(",")+"":i[i.length-1]+"").replace(/\\n+/g,""),i[t.length-1]=s,t.map((e,t)=>{"end"===e||"start"===e?r[e]=z(i[t].split(":")):"text"===e?r[e]=[i[t]]:"layer"===e?(r[e]=[i[t]],r.textTag=[i[t]]):"style"===e?r[e]=[i[t]]:r[e]=Number(i[t])?Number(i[t]):i[t]}),r}catch(e){return console.error(e),{}}}static parseASS(e){let t=e.split(`
`),i=[],r=0,s=0,n=[],a=[],o=null;for(;r<t.length;){if(F.test(t[r]))a=(a=t[r].replace(F,"").replace(/\s+/g,"").split(",")).map(e=>e.toLocaleLowerCase());else if(V.test(t[r]))n.push(t[r].replace(V,"").replace(/\s+/g,""));else if($.test(t[r])){let e=G.parseASSItem(t[r].replace($,""),a);if(o&&e.start===o.start&&e.end===o.end)try{let{text:t=[],textTag:i=[],style:r}=o;e.text.length>0&&t.push(e.text[0]),e.textTag.length>0&&i.push(e.textTag[0]),r&&r.push(e.style[0])}catch(e){console.error(e)}else{o=e;let t=null;s%50==0?((t={start:o.start,end:o.end,list:[]}).list.push(o),i.push(t)):((t=i[i.length-1]).end=o.end,t.list.push(o)),s++}}r++}return{list:i,styles:[]}}static parseVTTStyle(e,t){let i=e.split(":");if(i.length>1){let e=i[0].trim().split("-"),r="";e.length>1?e.map((e,t)=>{r+=0===t?e:e.charAt(0).toUpperCase()+e.slice(1)}):r=e[0],t[r]=i[1].trim().replace(/;$/,"")}return t}static parseVTT(e){let t=(e=e.replace(R,"")).split(`
`),i=[],r=0,s=0,n=null,a=!1,o=!1,l=null,h=null,d=[];for(;r<t.length;){let e=j(r,t).trim();if(!e||a&&/^(\-|\+)?\d+(\.\d+)?$/.test(e))a=!e;else if(M.test(e)&&O.test(j(r-1,t).trim())){o=!0;let t=/\((.+?)\)/g.exec(e);h=t?t[1]:"",l=""}else if(o)B.test(e)?(d.push({key:h||"",style:l||""}),l=null,h=null,o=!1):l+=e;else if(e){a=!1;let e=this.checkIsTime(t[r]);if(e){let t=this.parseVttTime(e);if(!n||t.start!==n.start||t.end!==n.end){(n={...t,text:[],textTag:[]}).text=[],n.textTag=[];let e=null;s%50==0?((e={start:n.start,end:n.end,list:[]}).list.push(n),i.push(e)):((e=i[i.length-1]).end=n.end,e.list.push(n)),s++}}else if(n){let{text:e,textTag:i}=n,s=this.parseVttText(t[r]);e.push(s.text),i.push(s.tag)}a=!1}r++}return{list:i,styles:d}}static checkIsTime(e){e=e.replace(/\s+/g,"");let t=0,i=null;for(;t<U.length&&!(i=U[t].exec(e));)t++;return i?i[0]:null}static parseVttText(e){let t=/^(<?.+?>)/g.exec(e),i="",r="default";if(t){r=t[0].replace(/\<|\>|\&/g,"");let s=RegExp(`^<${r}>(([\\s\\S])*?)</${r}>$`).exec(e);s?i=s[1]:(i=e,r="")}else i=e;let s=/<(\w+).(\w+)>/g,n=s.exec(i);for(;n&&n.length>2;)n=s.exec(i=i.replace(n[0],`<${n[1]} class="${n[2]}">`));return{tag:r,text:i.replace(/\\n+/g,"<br/>")}}static parseVttTime(e){let t=e.split("--\x3e"),i=0,r=0;if(2===t.length){let e=t[0].split(":"),s=t[1].split(":");i=z(e),r=z(s)}return{start:i,end:r,time:e}}static isVTT(e){return R.test(e)}static isASS(e){return N.test(e)}static checkFormat(e){return e?R.test(e)?"vtt":N.test(e)?"ass":"":""}}function H(e,t,i){let{url:r="",method:s="GET",type:n="arraybuffer",timeout:a=1e4,data:o={}}=e,l=new window.XMLHttpRequest,h=s.toUpperCase(),d=[];if(n&&(l.responseType=n),a&&(l.timeout=a),Object.keys(o).forEach(e=>{d.push(`k=${o[e]}`)}),l.onload=()=>{200===l.status||206===l.status?i({context:t,res:l,type:"success"}):i({context:t,res:l,type:"error",error:new T(function(e,t){let{status:i="",statusText:r=""}=e;return`${t}_${i}_${r}`}(l,"response_error"),1)})},l.onerror=e=>{i({context:t,res:l,type:"error",error:new T("loaderror",1)})},l.ontimeout=e=>{i({context:t,res:l,type:"error",error:new T("timeout",1)})},l.onabort=()=>{i({context:t,res:l,type:"error",error:new T("abort",1)})},"GET"===h)l.open(h,`${r}`),l.send();else if("post"===h)l.open(h,r),l.setRequestHeader("Content-type","application/x-www-form-urlencoded"),l.send(d.join("&"));else throw i({context:t,res:l,type:"error",error:new T(`xhr ${h} is not supported`,1)}),new T(`xhr ${h} is not supported`,1)}function W(e,t,i){"json"===t?i({styles:[],list:G.parseJson(e),format:"json"}):"string"===t&&G.parse(e,i)}function q(e,t,i){let r=[];i||(i=new S);let s=(r="String"===P(e)?[e]:[...e]).shift()||"",n=e=>{let{res:s,error:a}=e;if(a)r.length>0?H({url:r.shift()||"",type:"text"},t,n):i.reject(a);else if(s){let{response:e}=s;W(e,"string",(e,t)=>{t?i.reject(t):i.resolve(e)})}};return H({url:s,type:"text"},t,n),i}let K=!1;class Y extends u{constructor(e){super(),f(this,"_onPause",()=>{this.stopRender()}),f(this,"_onPlay",()=>{this._curRenderTask.length>0&&this.startRender(-1)}),f(this,"_onTimeupdate",()=>{if(!this._isOpen)return;if(this.config.domRender){let{videoWidth:e,videoHeight:t}=this.player.video?this.player.video:this.player;!this._videoMeta.scale&&e&&t&&this._onResize(this.player.root)}let e=this._getPlayerCurrentTime();200>Math.round(Math.abs(1e3*e-this._ctime))||(this._ctime=1e3*e,this.currentText&&this.currentText.list&&("live"===this.config.updateMode?this._liveUpdate(e):this._update(e)))}),f(this,"_onResize",e=>{let{_videoMeta:t,config:i}=this;if(i.domRender){if(e&&e instanceof window.Element||(e=this.player.root),this._iId&&(window.clearTimeout(this._iId),this._iId=null),!t.scale){if(!this.player.video)return;let{videoWidth:e,videoHeight:i}=this.player.video;if(!e||!i)return;t.videoWidth=e,t.videoHeight=i,t.scale=parseInt(i/e*100,10)}this.__startResize(e)}}),f(this,"_onCoreEvents",e=>{try{switch(e.eventName){case"core.subtitlesegments":this._onSubtitleSegment(e.list||[]);break;case"core.subtitleplaylist":this._onSubtitlePlaylist(e.list||[]);break;case"core.seipayloadtime":this._onCoreSeiintime(e)}}catch(e){console.error(e)}}),f(this,"startRender",e=>{if(e>0&&this._renderIntervalId&&(window.cancelAnimationFrame(this._renderIntervalId),this._renderIntervalId=-1),!this.textTrack)return;let{_curRenderTask:t}=this;this._lastTimeStamp=new Date().getTime();let i=[];t.forEach((t,r)=>{let{lastTime:s,wordList:n,interval:a,dom:o,ids:l}=t;if(e<0||this._lastTimeStamp<0||this._lastTimeStamp-s>=a){let e=n.shift();e&&o.appendData(e),t.lastTime=this._lastTimeStamp}n.length<1&&i.push({index:r,ids:l})}),this._log(">>>>_renderByWords emptyArr",i.length,t.length),i.forEach(e=>{t.splice(e.index,1),this._log(">>>_renderByWords remove emptyArr",e.index,t.length)}),t.length>0&&(this._renderIntervalId=window.requestAnimationFrame(this.startRender))}),f(this,"destroy",()=>{this.detachPlayer(),this.removeAllListeners(),this.player=null,this.textTrack=null,this._curRenderTask=[],this.stopRender()}),K=function(){let e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,r=/(?:Android)/.test(e),s=/(?:Firefox)/.test(e),n=/(?:iPad|PlayBook)/.test(e)||r&&!/(?:Mobile)/.test(e)||s&&/(?:Tablet)/.test(e);return/(?:iPhone)/.test(e)&&!n||r||i||n}(),this.currentText=null,this.currentExtText=null,this.textTrack=[],this._cid=-1,this._gid=-1,this._cids=[],this._iId=null,this._iC=0,this.player=null,this.root=null,this.config={line:"double",bottom:0,mode:"stroke",defaultOpen:!1,baseSizeX:49,baseSizeY:28,minSize:16,minMobileSize:13,fitVideo:!0,offsetBottom:2,fontColor:"#fff",domRender:!1,updateMode:"vod",renderMode:"",debugger:!1},this._ctime=0,this._loadingTrack={},this.seiTime=0,this.lastSeiTime=0,this._curTexts=[],this._curRenderTask=[],this._renderIntervalId=-1,this._lastTimeStamp=-1,Object.keys(this.config).map(t=>{void 0!==e[t]&&null!==e[t]&&(this.config[t]=e[t])}),this._isOpen=this.config.defaultOpen||!1,this._videoMeta={scale:0,videoHeight:0,videoWidth:0,lwidth:0,lheight:0,vWidth:0,vHeight:0,vBottom:0,vLeft:0,marginBottom:0},e.subTitles&&"Array"===P(e.subTitles)&&(e.player&&this.attachPlayer(e.player),this.setSubTitles(e.subTitles,this.config.defaultOpen))}get version(){return"0.2.19"}setSubTitles(e=[],t=!1,i=!0){let r=this._isOpen||t;if(i&&this.innerRoot&&this.switchOff(),!e||e.length<1)return void this.switchOff();this.currentText=null,this.textTrack=[],e.forEach(e=>{let t={};Object.keys(e).map(i=>{t[i]=e[i]}),t.url=C(t.url),t.isDefault&&(this.currentText=t),this.textTrack.push(t)}),this._log("setSubTitles",r,this.textTrack),r&&(this.currentText||(this.currentText=this.textTrack[0]),this.switch().catch(e=>{this.emitError(e),this._log("[switch]",e)})),this._log(">>>this.currentText",r,this.currentText),this.currentText&&this._loadTrack(this.currentText).then(e=>{this.addStyles(e)}).catch(e=>{this.emitError(e),this._log("[_loadTrack] errorsss",e)}),this.emit("reset",{type:"reset",list:this.textTrack,isOpen:r})}updateSubTitle(e){let t=-1;for(let i=0;i<this.textTrack.length;i++)if(I(e,this.textTrack[i])){t=i;break}if(this._log("updateSubTitle",t,e),t>-1){let i=I(this.currentText,this.textTrack[t]);if(this._log("updateSubTitle","_isCurrent",i,"this.isOpen",this.isOpen,this.currentText),!i)return;let r=C(e.url);this.isOpen?(r.forEach(e=>{this.textTrack[t].url.push(e)}),this._log("updateSubTitle _loadTrackUrls",this.textTrack[t]),this._loadTrackUrls(this.currentText,2)):this.textTrack[t].url=r}}addStyles(e){let{styles:t,format:i}=e;t&&"vtt"===i&&(t.map(e=>{e.key||(e.key="xg-text-track-span")}),function(e,t=""){let i="";e.map(e=>{i+=` ${t} ${e.key} {${e.style}}`});let r=document.createElement("style"),s=document.head||document.getElementsByTagName("head")[0];if(r.type="text/css",r.id="ssss",r.styleSheet){let e=function(){try{r.styleSheet.cssText=i}catch{}};r.styleSheet.disabled?setTimeout(e,10):e()}else{let e=document.createTextNode(i);r.appendChild(e)}s.appendChild(r)}(t,"xg-text-track"))}attachPlayer(e){var t,i,r;if(this._log("attachPlayer"),!e||e===this.player)return;this.player&&this.detachPlayer();let{fontColor:s,mode:n,fitVideo:a,domRender:o}=this.config;if(this.player=e,o&&(this.root=document.createElement("xg-text-track"),this.root.className="xg-text-track",this._isOpen||k(this.root,"text-track-hide"),a||k(this.root,"text-track-no-fitvideo"),n&&k(this.root,`text-track-${n}`),this.innerRoot=document.createElement("xg-text-track-inner"),this.root.appendChild(this.innerRoot),s&&(this.root.style.color=s),this.currentText&&["language","id","label"].map(e=>{this.root.setAttribute(`data-${e}`,this.currentText[e]||"")}),this.player.root.appendChild(this.root),i=e.root,r=this._onResize,g||(g=new m),g.addObserver(i,r)),x(this.player))e.addEventListener("timeupdate",this._onTimeupdate),e.addEventListener("pause",this._onPause),e.addEventListener("play",this._onPlay);else{if("function"!=typeof(null==(t=this.player)?void 0:t.on))return;this.player.on("destroy",this.destroy),this.player.on("timeupdate",this._onTimeupdate),this.player.on("pause",this._onPause),this.player.on("play",this._onPlay),this.player.on("core_event",this._onCoreEvents)}this._isOpen&&this.switch().catch(e=>{this._log("[switch]",e)})}detachPlayer(){var e,t;let{player:i,config:r}=this;if(i){if(x(i))i.removeEventListener("timeupdate",this._onTimeupdate),i.removeEventListener("pause",this._onPause),i.removeEventListener("play",this._onPlay);else{if("function"!=typeof(null==(e=this.player)?void 0:e.off))return;this.player.off("destroy",this.destroy),this.player.off("timeupdate",this._onTimeupdate),this.player.off("pause",this._onPause),this.player.off("play",this._onPlay),this.player.off("core_event",this._onCoreEvents)}r.domRender&&(i.root&&(t=i.root,this._onResize,g&&g.unObserver(t),i.root.removeChild(this.root)),this.innerRoot=null,this.root=null),this.player=null}}switch(e={id:"",language:""}){return this._log("switch",e),this._loadingTrack=e,new Promise((t,i)=>{if(!e.id&&!e.language)if(this.currentText){this._loadingTrack={},this._updateCurrent(this.currentText),this.switchOn(),t({message:"switch default subtitle success",code:0});return}else{let e=new T("no default subtitle",5);this.emitError(e),i(e);return}if(this.currentText&&I(e,this.currentText))this._loadingTrack={},this._updateCurrent(this.currentText),this.switchOn(),t(b(0));else{let r=null;this.__removeByTime(this._curTexts,0);for(let t=0;t<this.textTrack.length;t++)if(I(e,this.textTrack[t])){r=this.textTrack[t];break}if(this._log("nextSubtitle",r),r)this._emitPlayerSwitch(this.currentText,r),r.list?(this._loadingTrack={},this._updateCurrent(r),this.switchOn(),t(b(0))):(this._log("this._loadTrack",r),this._updateCurrent(r),this._loadTrack(r).then(s=>{if(this.addStyles(s),this._loadingTrack.id===r.id||this._loadingTrack.language===s.language)this._loadingTrack={},this._updateCurrent(s),this.switchOn(),t(b(0));else{let t=new T(`check _loadingTrack fail id: ${this._loadingTrack.id}  nextSubtitle:${s.id}`,6,null,e);this.emitError(t),i(t)}}).catch(e=>{this.emitError(e),i(e)}));else{let t=new T(`The is no subtitle with id:[{${e.id}}] or language:[${e.language}]`,4,null,e);this.emitError(t),i(t)}}})}switchExt(e={id:"",language:""}){return new Promise((t,i)=>{if(e.id||e.language){let i=null;for(let t=0;t<this.textTrack.length;t++)if(I(e,this.textTrack[t])){i=this.textTrack[t];break}i&&!I(i,this.currentText)&&this._loadTrack(i).then(e=>{this.currentExtText=e,t(b(0))}).catch(e=>{this.emitError(e)})}else this.currentExtText=null,t(b(0))})}emitError(e){this.emit(y,{type:y,error:e})}switchOn(){this._log("switchOn"),this._isOpen=!0,this.show();let{id:e,language:t}=this.currentText;this.emit(_,{type:_,isOpen:!0,id:e,language:t,texts:[]})}switchOff(){if(this._isOpen=!1,this.hide(),!this.currentText)return;let{id:e,language:t}=this.currentText;this.emit("off",{type:"off",id:e,language:t,texts:[],isOpen:!1})}get isOpen(){return this._isOpen}_log(...e){this.config.debugger&&console.log("[xgSubtitle]",...e)}_loadTrack(e){this._log("_loadTrack",e.language,e);let t=new S,i="",r="";if(e.json?(i="json",r=e.json):e.stringContent&&(!e.url||0===e.url.length)&&(i="string",r=e.stringContent),r)return W(r,i,(i,r)=>{r?(this.emitError(r),t.reject(r)):(e.format=i.format,e.styles=i.styles,e.list=i.list,t.resolve(e))}),t;let s=[...e.url];return 0===s.length?t.resolve(e):q(s.splice(0,1)[0].url,e).then(i=>{e.format=i.format,e.styles=i.styles,e.list||(e.list=[]),this._pushList(e.list,i.list),s.length>1&&this._loadTrackUrls(e,2),t.resolve(e)}).catch(e=>{t.reject(e)}),t}_emitPlayerSwitch(e,t){e&&"live"===this.config.updateMode&&(e.list=[],e.url=[]);let i={lang:t.language,...t};this._log("emit subtile_switch ",t,i),this.emit(_,{type:_,error:null})}_loadTrackUrls(e,t,i){let r=e.url.length,s=r>t?e.url.splice(0,t):e.url.splice(0,r),n=s.length;this._log("_loadTrackUrls",e.language,r,s.length,n),s.forEach((t,r)=>{q({...t,index:r}.url,t).then(t=>{e.format=t.format,e.styles=t.format,e.list||(e.list=[]),this._pushList(e.list,t.list),n--}).catch(e=>{n--}).finally(t=>{0===n&&(i&&i.resolve(e),this._loadTrackUrls(e,2))})})}_freshUrl(e,t={url:""}){let i=-1;e.url.forEach((e,r)=>{e.url===t.url&&(i=r)}),i>-1&&e.url.splice(i,1)}_pushList(e,t){let i=t[0].start,r=t[t.length-1].end;if(0===e.length||i>=e[e.length-1].end)t.forEach(t=>{e.push(t)});else{let i=-1;for(let t=0;t<e.length;t++)if(e[t].start>r){i=t;break}i>-1&&t.forEach((t,r)=>{e.splice(i+r,0,t)})}return e}_updateCurrent(e){this.currentText=e,this.config.domRender&&this.root&&(["language","id","label"].map(e=>{this.root.setAttribute(`data-${e}`,this.currentText[e]||"")}),this.__remove(this._cids)),this._cids=[],this._gid=-1,this._cid=-1,this._curTexts=[];let t=this._getPlayerCurrentTime();t&&("live"===this.config.updateMode?this._liveUpdate(t):this._update(t))}__loadAll(){this.textTrack.forEach(e=>{this._loadTrack(e)})}getDelCid(e,t){let i=[];for(let r=0;r<e.length;r++)t.includes(e[r])||i.push(e[r]);return i}getNewCid(e,t){let i=[];for(let r=0;r<t.length;r++)e.includes(t[r])||i.push(t[r]);return i}_liveUpdate(e){if(!this.currentText||!this.currentText.list||!this.currentText.list.length)return;let t=[],i=L(e,this.currentText.list,this._gid);if(i>-1&&(t=D(e,this.currentText.list[i].list,this._cid)),this.__removeByTime(this._curTexts,e),this._log("_liveUpdate",e,i,t,this.currentText.list[0].list[0].start,this.currentText.list[0].list[0].end),t.length>0){let e=function(e,t,i){if(0===e.length||t<0||t>e.length-1)return[];let r=e[t].list;if(0===i.length)return[];let s=r.splice(i[0],i.length);return t>0&&e.splice(0,t),0===r.length&&e.splice(0,1),s}(this.currentText.list,i,t),r=this._curTexts.length,s=r>0?this._curTexts[r-1].index:0;e.forEach((e,t)=>{e.index=t+s,this._curTexts.push(e)}),this.__render(e)}this.emit(v,this.getUpdateData(this._curTexts,0,this.currentText))}_update(e){if(!this.currentText||!this.currentText.list||!this.currentText.list.length)return;let t=L(e,this.currentText.list,this._gid),i=[];if(t>-1&&(i=D(e,this.currentText.list[t].list,this._cid)),this._log("update1",`currentTime:${e}`,t,this._gid,i,this._cids,this._cids.join(",")===i.join(","),t===this._gid),i.length<1){this._cids.length>0&&this.config.domRender&&this.__remove(this._cids),this._cids=[],this._curTexts.length>0&&this.emit(v,this.getUpdateData([],e,this.currentText)),this._curTexts=[];return}if(this._cids.join("")===i.join("")&&t===this._gid)return;this._gid=t,this._cid=i[0];let r=this.getDelCid(this._cids,i),s=this.getNewCid(this._cids,i);this._cids=i,this.config.domRender&&this.__remove(r);let n=[];s.map(e=>{let i=this.currentText.list[t].list[e];i.index=e,n.push(i)}),this.currentExtText&&s.map(e=>{let i=this.currentText.list[t].list[e];i.index=e,n.push(i)}),this._log("update",`currentTime:${e}`,n.length>0?`start:${n[0].start} end:${n[0].end}`:"",`delCids:${r.length} newCids:${s.length}`),this._curTexts=n,this.emit(v,this.getUpdateData(n,e,this.currentText)),this.__render(n,e)}getUpdateData(e,t,i){let{id:r,language:s}=i;return{type:v,currentTime:0|t,id:r,language:s,texts:e,isOpen:this._isOpen}}_getPlayerCurrentTime(){if(!this.player)return 0;let{currentTime:e}=this.player;return parseInt(1e3*e+1e3*this.seiTime-1e3*this.lastSeiTime,10)/1e3}_onSubtitlePlaylist(e){this._log("_onSubtitlePlaylist",e);let t=e.map(e=>({label:e.name,language:e.lang,id:e.id,isDefault:e.default,url:[],mUrl:e.url}));this.setSubTitles(t)}_onSubtitleSegment(e){if(this._log("_onSubtitleSegment",e.length,e[0].lang,e[0].sn,e[e.length-1].sn,e[0].start,e[e.length-1].end),!e||0===e.length)return;let t={language:e[0].lang,url:e.map(e=>({id:e.sn,url:e.url,duration:e.duration,start:e.start,end:e.end}))};I(t,this.currentText)&&this.updateSubTitle(t)}_onCoreSeiintime(e){try{let t=e.time/1e3;this._log("_onCoreSeiintime sei",t,this.seiTime,this.lastSeiTime),this.seiTime=t,this.lastSeiTime=this.player?this.player.currentTime:0}catch{}}resize(e,t){let{baseSizeX:i,baseSizeY:r,minMobileSize:s,minSize:n,fitVideo:a,offsetBottom:o}=this.config,{scale:l}=this._videoMeta;this._videoMeta.lwidth=e,this._videoMeta.lheight=t;let h,d=0;t/e*100>=l?(d=parseInt(l*e,10)/100,h=e):(d=t,h=parseInt(t/l*100,10)),this._videoMeta.vWidth=h,this._videoMeta.vHeight=d;let u=0,c=0;c=l>120?parseInt((u=r)*d/1080,10):parseInt((u=i)*h/1920,10);let p=K?s:n,f={fontSize:c=c<p?p:c>u?u:c},m=parseInt((t-d)/2,10),g=parseInt((e-h)/2,10),_=parseInt(d*o,10)/100;this._videoMeta.vBottom=m,this._videoMeta.vLeft=g,this._videoMeta.marginBottom=_,a&&(f.bottom=m+_,f.left=f.right=g),Object.keys(f).map(e=>{this.root.style[e]=`${f[e]}px`}),this.emit("resize",{vLeft:g,vBottom:m,marginBottom:_,vWidth:h,vHeight:d,fontSize:c,scale:l})}__startResize(e){let t=e.getBoundingClientRect(),{_videoMeta:i}=this,{width:r,height:s}=t;if(this._iId&&(clearTimeout(this._iId),this._iId=null),r>0&&s>0&&(r!==i.lwidth||s!==i.lheight))this._iC=0,this.resize(r,s);else{if(this._iC>=5){this._iC=0;return}this._iC++,this._iId=setTimeout(()=>{this.__startResize(e)},50)}}__removeByTime(e,t){let i=[];for(let r=0;r<e.length;r++)(!t||e[r].end<t)&&i.push(r);0!==i.length&&(e.splice(i[0],i.length),this.config.domRender&&this.__remove(i))}__remove(e){if(!e||e.length<1)return;this._log(">>>>_renderByWords__remove",e);let t=this.innerRoot.children,i=[];for(let r=0;r<t.length;r++){let s=Number(t[r].getAttribute("data-index"));e.includes(s)&&i.push(t[r])}i.map(e=>{this.innerRoot.removeChild(e)})}__render(e=[]){let{renderMode:t,domRender:i}=this.config;e.length>0&&i&&e.forEach(e=>{let i=`text-track-${this.config.line}`;e.text.forEach((r,s)=>{s>0&&(i+=" text-track-deputy");let n={"data-start":e.start,"data-end":e.end,"data-index":e.index},a=w("xg-text-track-span","",n,i);if(this.innerRoot.appendChild(a),"step"===t){let t=w("xg-text-track-span","",n,`${i} text-track-space`);this.innerRoot.appendChild(t),t.innerHTML=r,window.setTimeout(()=>{this._renderByWords(a,s,e.start,e.end,r)},600)}else a.innerHTML=r})})}_renderByWords(e,t,i,r,s){let n=document.createTextNode("");e.appendChild(n);let a=function(e){let t=e.split(""),i=[],r=!1;for(let e=0;e<t.length;e++){let s=t[e];if(null!==s&&""!==s.trim()&&/^[a-zA-Z]+$/.test(s))if(r){let e=i.length-1;i[e]=`${i[e]}${s}`}else i.push(s),r=!0;else if(s.match(/^[ ]*$/)||/[\x21-\x2f\x3a-\x40\x5b-\x60\x7B-\x7F]/.test(s)||/[\u3002|\uff1f|\uff01|\uff0c|\u3001|\uff1b|\uff1a|\u201c|\u201d|\u2018|\u2019|\uff08|\uff09|\u300a|\u300b|\u3008|\u3009|\u3010|\u3011|\u300e|\u300f|\u300c|\u300d|\ufe43|\ufe44|\u3014|\u3015|\u2026|\u2014|\uff5e|\ufe4f|\uffe5]/.test(s)){r=!1;let e=i.length-1;i[e]=`${i[e]}${s}`}else r=!1,i.push(s)}return i}(s),o=this._getPlayerCurrentTime(),l=parseInt((r-o)*1e3,10);if(o>=r)return;i>=o&&(o=i),l>300&&(l-=50);let h=a.length,d={dom:n,ids:t,wordList:a,interval:l/h,start:o,end:r,duration:l,lastTime:0};this._log(">>>>_renderByWords",l,d);let{_curRenderTask:u}=this,c=-1;for(let e=0;e<u.length;e++)if(u[e].ids===t){c=e;break}c>-1&&u.slice(c,1),u.push(d),this.startRender(-1)}stopRender(){this._renderIntervalId&&window.cancelAnimationFrame(this._renderIntervalId)}show(){var e,t;this.config.domRender&&(e=this.root,t="text-track-hide",e&&(e.classList?t.split(/\s+/g).forEach(t=>{e.classList.remove(t)}):E(e,t)&&t.split(/\s+/g).forEach(t=>{let i=RegExp("(\\s|^)"+t+"(\\s|$)");if(e.className&&"object"==typeof e.className){let t=e.getAttribute("class")||"";e.setAttribute("class",t.replace(i," "))}else e.className=e.className.replace(i," ")})))}hide(){this.config.domRender&&(k(this.root,"text-track-hide"),this.innerRoot.innerHTML="")}emit(e,t,...i){super.emit(e,t,...i)}on(e,t,...i){super.on(e,t,...i)}once(e,t,...i){super.once(e,t,...i)}off(e,t,...i){super.off(e,t,...i)}offAll(){super.removeAllListeners()}get marginBottom(){let{bottom:e,marginBottom:t}=this._videoMeta;return this.config.fitVideo?e+t:t}}var X=i(73522),Q=i(23636);let J=Object.freeze(Object.defineProperty({__proto__:null,ABORT:"abort",AUTOPLAY_PREVENTED:"autoplay_was_prevented",AUTOPLAY_STARTED:"autoplay_started",BUFFER_CHANGE:"bufferedChange",CANPLAY:"canplay",CANPLAY_THROUGH:"canplaythrough",DESTROY:"destroy",DURATION_CHANGE:"durationchange",EMPTIED:"emptied",ENDED:"ended",ERROR:"error",LOADED_DATA:"loadeddata",LOADED_METADATA:"loadedmetadata",LOAD_START:"loadstart",PAUSE:"pause",PLAY:"play",PLAYER_FOCUS:"focus",PLAYING:"playing",PROGRESS:"progress",RATE_CHANGE:"ratechange",RELEASE:"release",REPLAY:"replay",SEEKED:"seeked",SEEKING:"seeking",STALLED:"stalled",SUSPEND:"suspend",TIME_UPDATE:"timeupdate",URL_CHANGE:"urlchange",VOLUME_CHANGE:"volumechange",WAITING:"waiting"},Symbol.toStringTag,{value:"Module"}));var Z=i(59650),ee=Object.defineProperty,et=(e,t,i)=>{let r;return(r="symbol"!=typeof t?t+"":t)in e?ee(e,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[r]=i};class ei{constructor(){this._events=[],this._callbacks={}}register(e){this._events.includes(e)||this._events.push(e)}on(e,t){return!!this._events.includes(e)&&(this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e].push(t),!0)}off(e,t){if(!this._events.includes(e)||!this._callbacks[e])return!1;let i=this._callbacks[e].indexOf(t);return this._callbacks[e].splice(i,1),!0}bind(e,t){if(!this._events.includes(e))return!1;this._callbacks[e]=[],this._callbacks[e].push(t)}clear(e){this._callbacks[e]=[]}trigger(e,t){if(!this._callbacks[e]||!this._callbacks[e].length)return!1;let i=null;return this._callbacks[e].forEach((e,r)=>{0==r?i=e(t):e(t)}),i}set events(e){e.forEach(e=>{this.register(e)})}get events(){return this._events}}var er=((s=er||{}).Block="Block",s.BlockStart="BlockStart",s.FirstFrame="FirstFrame",s.PlayEnded="PlayEnded",s.PlayFailed="PlayFailed",s.PlayQuality="PlayQuality",s.VideoDataSize="VideoDataSize",s.VideoRequest="VideoRequest",s.VideoRequestResponse="VideoRequestResponse",s),es=((n=es||{})[n.INIT=0]="INIT",n[n.LOADING=1]="LOADING",n[n.LOADED=2]="LOADED",n[n.PLAYING=3]="PLAYING",n[n.ERROR=5]="ERROR",n[n.WAITING=7]="WAITING",n[n.SEEKING=8]="SEEKING",n);class en{constructor(e,t){this.name=e,t&&this.reset()}startTimer(){this.started=!0,this.startTime=(0,Z.n)()}stopTimer(){this.started&&(this.endTime=(0,Z.n)(),this.duration=this.endTime-this.startTime,this.started=!1)}reset(){this.started=!1,this.startTime=-1,this.endTime=-1,this.duration=0}exportData(){return{duration:this.duration,gpu:"",score:-2,vendor:""}}}class ea extends en{constructor(){super(er.VideoRequest,!0)}}class eo extends en{constructor(){super(er.VideoRequestResponse,!0)}}class el extends en{constructor(){super(er.Block,!0)}setBlockType(e){if(e&&e.element){let{readyState:t,seeking:i}=e.element;t<1?this.blockType=1:this.blockType=2*!!i}}exportData(e,t={blockType:0}){var i;let r=(null==(i=null==e?void 0:e.element)?void 0:i.currentTime)||0;return{...t,blockType:this.blockType,currentTime:r,...super.exportData()}}}class eh extends en{constructor(){super(er.PlayQuality,!0),this.loadedTime=0,this.durationFromLoaded=0,this.durationWithLoaded=0}reset(){super.reset(),this.loadedTime=0,this.durationFromLoaded=0,this.durationWithLoaded=0}}let ed={v360:{width:640,height:360},v480:{width:800,height:480},v540:{width:960,height:540},v720:{width:1280,height:720},v864:{width:1536,height:864},v960:{width:1706,height:960},v1080:{width:1920,height:1080},v2k:{width:2560,height:1440},v4k:{width:3840,height:2160}};class eu{constructor(){this.ladder=null,this._mvmaf="",this._vqscore=0,this.width=0,this.height=0,this.playedDuration=0}set mvmaf(e){if(e)try{this._mvmaf=e;let t=JSON.parse(e);t["v2.0"]&&(this.ladder=t["v2.0"])}catch{}}get mvmaf(){return this._mvmaf}set vqscore(e){e&&(this._vqscore=e)}get vqscore(){return this._vqscore}_findNearestPlaybackScore(){let e=0;if(!this.ladder)return 0;let t=this.width*this.height,i="v540",r=Number.MAX_VALUE;for(let e in ed){let s=ed[e],n=t-s.width*s.height;Math.abs(n)<r&&(r=Math.abs(n),i=e)}let s=ed[i].width*ed[i].height;if(Math.abs(s-t)<=.1*s&&this.ladder&&this.ladder.ori&&this.ladder.ori[i])return this.ladder.ori[i];if(this.ladder&&this.ladder.ori){let t=this.ladder.ori,r=Object.keys(t);if(1==r.length)return t[r[0]];{r.sort();let s=ed[r[0]].width*ed[r[0]].height,n=t[r[0]],a=ed[r[r.length-1]].width*ed[r[r.length-1]].height,o=t[r[r.length-1]],l=ed[i].width*ed[i].height;e=n+((l-s)*o-(l-s)*n)/(a-s)}}return e}exportData(){if(this.playedDuration<=0)return{};let e=this._findNearestPlaybackScore(),t=100-(100-e)*Math.exp(this._vqscore/100-1);return{vqs:this._vqscore,vms:e,vods:t,mvmaf:this._mvmaf,pr:"w:"+this.width+",h:"+this.height+",srf:0,wt:"+this.playedDuration,v:2}}reset(){this._mvmaf="",this._vqscore=0,this.ladder=null,this.width=0,this.height=0,this.playedDuration=0}}function ec(e,t){return e>t?e-t:0}class ep extends en{constructor(e){super(er.PlayEnded,!1),this.videoQualityHelper=new eu,this.currentTime=0,this.status=e,this.playbackState=es.INIT,this.loadedFrames=0,this.costTimes={stay_dur:0,loadstart_dur:0,loaded_dur:0,timeupdate_dur:0,meta_dur:0,playing_dur:0,ff_dur:0},this.reset()}setTimeLine(e){let{start:t,loadstart:i,loaded:r,end:s,timeupdate:n,playing:a,metadata:o,firstFrame:l}=e;this.costTimes={stay_dur:ec(s,t),loadstart_dur:ec(i,t),loaded_dur:ec(r,i),timeupdate_dur:ec(n,i),meta_dur:ec(o,i),playing_dur:ec(a,i),ff_dur:ec(l,i)}}startPauseTimer(){let e=window.performance;this.pauseStartTime=e?e.now():Date.now(),this.paused=!0}stopPauseTimer(){if(this.paused){let e=window.performance;this.pauseStopTime=e?e.now():Date.now(),this.pauseDuration+=this.pauseStopTime-this.pauseStartTime}}reset(){super.reset(),this.paused=!1,this.pauseStartTime=-1,this.pauseStopTime=-1,this.pauseDuration=0,this.currentTime=0,this.videoQualityHelper&&this.videoQualityHelper.reset(),this.loadedFrames=0,this.costTimes={stay_dur:0,loadstart_dur:0,loaded_dur:0,timeupdate_dur:0,meta_dur:0,playing_dur:0,ff_dur:0}}exportData(){let e=super.exportData();this.videoQualityHelper.playedDuration=this.duration-this.pauseDuration;let t=this.videoQualityHelper.exportData();return Object.assign({},e,{pauseDuration:this.pauseDuration,vqm:t,endState:this.playbackState,costTimes:{...this.costTimes}})}copy(e){this.duration=e.duration,this.currentTime=e.currentTime,this.pauseDuration=e.pauseDuration,this.playbackState=e.playbackState,this.costTimes={...e.costTimes,loaded_f:e.loadedFrames},e.videoQualityHelper&&(this.videoQualityHelper.mvmaf=e.videoQualityHelper.mvmaf,this.videoQualityHelper.vqscore=e.videoQualityHelper.vqscore,this.videoQualityHelper.width=e.videoQualityHelper.width,this.videoQualityHelper.height=e.videoQualityHelper.height,this.videoQualityHelper.playedDuration=e.videoQualityHelper.playedDuration)}set mvmaf(e){e&&(this.videoQualityHelper.mvmaf=e)}set vqscore(e){e&&(this.videoQualityHelper.vqscore=e)}set width(e){this.videoQualityHelper.width=e}set height(e){this.videoQualityHelper.height=e}}class ef extends en{constructor(){super(er.PlayFailed,!0),this.loadStartRetry=[]}getRetryData(){return{retryCount:this.loadStartRetry.length,retryList:this.loadStartRetry}}exportData(e,t,i){let r=super.exportData(),s=-1,n="",a=-1,o="";return e&&e.element&&(s=e.element.currentTime,n=e.element.currentSrc,e.element.error&&(a=e.element.error.code,o=e.element.error.message)),t&&(t.url&&(n=t.url),a=t.errorCode,o=t.message),Object.assign({},r,{status:i,code:a,message:o,url:n,isExpired:(0,Z.c)(n),currentTime:s,retryCount:this.loadStartRetry.length,retryList:this.loadStartRetry})}}class em extends en{constructor(){super(er.FirstFrame,!0)}}let eg="[MediaMetrics]";class e_ extends ei{constructor(e,t){super(),et(this,"onVideoFrameCallback",(e,t)=>{var i,r,s;this._renderFrames++,this.log(!0,"VideoFrame",`mediaTime:${(0,Z.f)(t.mediaTime)} presentedFrames:${t.presentedFrames}`),1===this._renderFrames&&(this.timeLine.firstFrame=(0,Z.b)()),this._renderFrames<3&&(null==(s=null==(r=null==(i=this._player)?void 0:i.element)?void 0:r.requestVideoFrameCallback)||s.call(r,this.onVideoFrameCallback))}),et(this,"_onRenderStateChange",e=>{var t;let{state:i,preState:r}=e;this.log(!0,"renderStateChange",`preState:${r} _metricsEvents:${this._metricsEvents.length}`,null==(t=this._player)?void 0:t.readyState),i===Q.b.ACTIVE&&(this.timeLine.start=(0,Z.b)(),this._metricsEvents.forEach(e=>{let{event:t,data:r,timeStamp:s}=e;r.renderState=i,(0,Z.l)(eg,"triggerDelay",t,i,r,s),super.trigger(t,r)}),this._metricsEvents=[])}),et(this,"_onPlay",()=>{var e,t,i;this.setStartTime("play");let r=(null==(t=null==(e=this._player)?void 0:e.element)?void 0:t.readyState)||0,s=null==(i=this._player)?void 0:i.state;this.log(!0,"onPlay",s,`readyState:${r} status: ${this.status}`),this.status<1&&r>2&&(this.trigger(this.videoRequest.name,this.videoRequest.exportData()),this.trigger(this.videoRequestResponse.name,this.videoRequestResponse.exportData()),this.status=1),this.playEnded.paused&&this.playEnded.stopPauseTimer()}),et(this,"_onPause",()=>{this.block.started&&this.block.reset(),this.playEnded.startPauseTimer()}),et(this,"_onPlaying",()=>{if(this.log(!0,"onPlaying"),this.calExtendLoaded(),this.timeLine.playing||(this.timeLine.playing=(0,Z.b)()),this.status>-1&&(this.status=3,this.playbackState=es.PLAYING),this.block.started){this.block.stopTimer();let{blockType:e}=this.block;this.trigger(this.block.name,this.block.exportData(this._player,{blockType:e}))}this._player.element&&(this.playEnded.width=this._player.element.videoWidth,this.playEnded.height=this._player.element.videoHeight)}),et(this,"_onTimeupdate",()=>{if(!this._player||!this._player.element)return;this.setStartTime("timeupdate");let{readyState:e,currentTime:t}=this._player.element;this.playEnded.currentTime=t,this._updateCount>=3||(!this.timeLine.timeupdate&&this.timeLine.loaded>0&&e>=2&&(this.timeLine.timeupdate=(0,Z.b)()),this._updateCount++,this.log(!0,"onTimeupdate"))}),et(this,"_onEnded",()=>{this.status=2}),et(this,"_onWaiting",()=>{this._player&&this._player.element&&3==this._status&&(this._player.element.paused||this._player.state!==Q.b.ACTIVE||(this.block.setBlockType(this._player),this.block.startTimer(),this.playbackState=es.WAITING,this.log(!0,"onWaiting")))}),et(this,"_onError",e=>{this.trigger(this.playFailed.name,this.playFailed.exportData(this._player,e,this._status)),this.playbackState=es.ERROR}),et(this,"_onSourceError",e=>{let{host:t,errorCode:i,message:r,src:s}=e;this.playFailed.loadStartRetry.push({host:t,code:i,message:r,isExpired:(0,Z.c)(s)})}),et(this,"_onLoadstart",()=>{this.setStartTime("loadstart"),this.status=1,this.trigger(this.videoRequest.name,this.videoRequest.exportData()),this.playQuality.startTimer(),this.videoRequestResponse.startTimer(),this.firstFrame.startTimer(),this.playbackState=es.LOADING,this.log(!0,"onLoadstart")}),et(this,"_onSeeking",()=>{var e;this.setStartTime("seeking");let t=this.getFirstBuffer(),i=null==(e=this._player)?void 0:e.state;this.status<1&&t.end>1&&i===Q.b.ACTIVE?(this.trigger(this.videoRequest.name,this.videoRequest.exportData()),this.trigger(this.videoRequestResponse.name,this.videoRequestResponse.exportData()),this.playbackState=es.LOADED,this.status=1):this.playbackState=es.SEEKING,this.log(!0,"onSeeking")}),et(this,"_onSeeked",()=>{var e,t;let i=null==(t=null==(e=this._player)?void 0:e.getVideoPlaybackQuality)?void 0:t.call(e);this.log(!0,"onSeeked",i.totalVideoFrames,this.timeLine.loaded),this.calExtendLoaded()}),et(this,"_onLoadedMetaData",()=>{this.timeLine.metadata||(this.timeLine.metadata=(0,Z.b)()),this.log(!0,"onLoadedMetaData")}),et(this,"_onLoadeddata",()=>{var e;this.videoRequestResponse.stopTimer();let t=(0,Z.b)();this.timeLine.loaded=t,this.playQuality.durationWithLoaded=t-this.playQuality.startTime,this.trigger(this.videoRequestResponse.name,this.videoRequestResponse.exportData()),this.playbackState=es.LOADED,this.log(!0,"onLoadeddata",this.timeLine.timeupdate);let i=null==(e=this._player)?void 0:e.getVideoPlaybackQuality();this.playEnded.loadedFrames=(null==i?void 0:i.totalVideoFrames)||0}),et(this,"_onPlayCatch",()=>{this.xgDowngraded=!0}),et(this,"initEvent",e=>{let t=e||this.event;t&&(t.on(J.PLAY,this._onPlay),t.on(J.PAUSE,this._onPause),t.on(J.PLAYING,this._onPlaying),t.on(J.TIME_UPDATE,this._onTimeupdate),t.on(J.ENDED,this._onEnded),t.on(J.WAITING,this._onWaiting),t.on(J.ERROR,this._onError),t.on("source_error",this._onSourceError),t.on(J.LOAD_START,this._onLoadstart),t.on(J.LOADED_DATA,this._onLoadeddata),t.on("playCatch",this._onPlayCatch),t.on(J.SEEKING,this._onSeeking),t.on(J.SEEKED,this._onSeeked),t.on(J.LOADED_METADATA,this._onLoadedMetaData),t.on("renderStateChange",this._onRenderStateChange))}),et(this,"removeEvent",e=>{let t=e||this.event;t&&(t.off(J.PLAY,this._onPlay),t.off(J.PAUSE,this._onPause),t.off(J.PLAYING,this._onPlaying),t.off(J.TIME_UPDATE,this._onTimeupdate),t.off(J.ENDED,this._onEnded),t.off(J.WAITING,this._onWaiting),t.off(J.ERROR,this._onError),t.off("source_error",this._onSourceError),t.off(J.LOAD_START,this._onLoadstart),t.off(J.LOADED_DATA,this._onLoadeddata),t.off("playCatch",this._onPlayCatch),t.off(J.SEEKING,this._onSeeking),t.off(J.SEEKED,this._onSeeked),t.off(J.LOADED_METADATA,this._onLoadedMetaData),t.off("renderStateChange",this._onRenderStateChange))}),et(this,"stop",()=>{var e;if(this.log(!1,"__stop__",null==(e=this._player)?void 0:e.state,this._status),-1!=this._status){if(this.timeLine.ended||(this.timeLine.ended=(0,Z.b)()),this.reset(),this.lastPlayEnded){let e=this.lastPlayEnded.exportData();this.log(!1,"lastPlayEnded",e),this.trigger(this.lastPlayEnded.name,{...e,stayDuration:(null==e?void 0:e.costTimes.stay_dur)||0}),this.lastPlayEnded=null}this._metricsEvents=[]}}),et(this,"reset",()=>{this.log(!1,"__reset__"),this.playEnded.started&&(this.timeLine.end=(0,Z.b)(),this.playEnded.setTimeLine(this.timeLine),this.playEnded.stopTimer()),this.lastPlayEnded=new ep(this._status),this.lastPlayEnded.copy(this.playEnded),this.status=-1,this.xgDowngraded=!1,this.videoRequest.reset(),this.videoRequestResponse.reset(),this.block.reset(),this.playQuality.reset(),this.playEnded.reset(),this.playFailed.reset(),this.firstFrame.reset(),this._renderFrames=0,this._lastTime=0,this._updateCount=0,this._metricsEvents=[],this.timeLine={start:0,loadstart:0,loaded:0,playing:0,metadata:0,firstFrame:0,timeupdate:0,end:0}}),this._metricsEvents=[],this.event=e,this.config=t,this._status=-1,this.initEvent(),this._player=null,this.xgDowngraded=!1,this.videoRequest=new ea,this.videoRequestResponse=new eo,this.block=new el,this.playQuality=new eh,this.lastPlayEnded=null,this.playEnded=new ep(this._status),this.playFailed=new ef,this.firstFrame=new em,this.events=[this.videoRequest.name,this.videoRequestResponse.name,this.block.name,this.playQuality.name,this.playEnded.name,this.playFailed.name,this.firstFrame.name],this.startInitInfo={},this._renderFrames=0,this._lastTime=0,this._updateCount=0,this.playbackState=es.INIT,this.timeLine={start:0,loadstart:0,loaded:0,playing:0,metadata:0,firstFrame:0,timeupdate:0,end:0}}static get version(){return d.v}log(e,t,...i){if(!(0,Z.a)())return;let r=(0,Z.b)();this._lastTime||(this._lastTime=r);let{readyState:s,currentTime:n,bufferDuration:a,bufferEnd:o,bufferStart:l,renderState:h,totalFrames:d,vid:u,uuid:c}=(e=>{if(!e)return{readyState:-1,bufferEnd:-1,bufferDuration:-1,currentTime:-1,renderState:"",totalFrames:0,dropFrames:0,vid:"",uuid:""};{let{readyState:t,buffered:i,currentTime:r,state:s,vid:n,uuid:a}=e,o=-1,l=0,h=-1;null!=i&&i.length&&i.length>0&&(o=(0,Z.f)(i.end(0)),l=(0,Z.f)(i.end(0)-i.start(0)),h=(0,Z.f)(i.start(0)));let d=e.getVideoPlaybackQuality();return{readyState:t,bufferEnd:o,bufferStart:h,bufferDuration:l,currentTime:(0,Z.f)(r),renderState:s,totalFrames:(null==d?void 0:d.totalVideoFrames)||0,dropFrames:(null==d?void 0:d.droppedVideoFrames)||0,vid:n,uuid:a}}})(this._player),{loadstart:p,loaded:f}=this.timeLine;if(!e)return void(0,Z.l)(eg,c,`[${t}]`,`[${h}|readyState:${s}|status:${this.status}|${u}]`,...i);(0,Z.l)(eg,c,`[${t}]`,`[${h}|readyState:${s}|status:${this.status}|${u}] currentTime:${n} decodeFrames:${d} renderFrames:${this._renderFrames} fromStart:${p>0?r-p:-1} fromLoaded:${f>0?r-f:-1} fromLast:${r-this._lastTime} bufferStart: ${l} bufferEnd:${o} bufferDur:${a}`,...i,this.timeLine),this._lastTime=r}setStartTime(e){var t,i,r;if(!this._player)return;let s=(0,Z.b)();if(this._player.state!==Q.b.ACTIVE||this.timeLine.start||(this.timeLine.start=s),!(this.timeLine.loadstart>0)){this.log(!1,"setStartTime",e),this.timeLine.loadstart=s;try{null==(r=null==(i=null==(t=this._player)?void 0:t.element)?void 0:i.requestVideoFrameCallback)||r.call(i,this.onVideoFrameCallback)}catch(e){console.error(e)}}}getFirstBuffer(){let e=this._player.buffered,t=-1,i=-1;return e&&e.length>0&&(t=e.start(0),i=e.end(0)),{start:t,end:i}}getCommonData(e){var t;let{element:i,config:r,type:s,state:n}=e;return{currentTime:(null==i?void 0:i.currentTime)||0,videoDuration:(null==i?void 0:i.duration)||0,codecType:e.codecType||(null==r?void 0:r.codecType)||"h264",vtype:e.vtype||(null==r?void 0:r.vtype)||"MP4",playerType:s||"default",renderState:n||Q.b.ACTIVE,resolution:null==(t=e.curBitrate)?void 0:t.resolution}}set playbackState(e){this.playEnded&&(this.playEnded.playbackState=e)}calExtendLoaded(){var e,t;if(!(this.timeLine.loaded>0)&&(null==(t=null==(e=this._player)?void 0:e.getVideoPlaybackQuality)?void 0:t.call(e)).totalVideoFrames>10){let e=(0,Z.b)();this.timeLine.loaded=e,this.timeLine.metadata=e}}setConfig(e){e&&e.bitrate&&(this.config.bitrate=e.bitrate)}set player(e){this._player=e,e&&(this._player.mvmaf&&(this.playEnded.mvmaf=this._player.mvmaf),this._player.vqscore&&(this.playEnded.vqscore=this._player.vqscore))}get status(){return this._status}set status(e){if(1===this._status&&3===e){this.playQuality.stopTimer(),this.playEnded.startTimer(),this.firstFrame.stopTimer(),this.playQuality.durationFromLoaded=(0,Z.b)()-this.timeLine.loaded;let{durationWithLoaded:e,durationFromLoaded:t}=this.playQuality,i=this.playQuality.exportData(),r=this.playFailed.getRetryData(),s={...i,...r,durationWithLoaded:e,durationFromLoaded:t};this.trigger(this.playQuality.name,s),this.trigger(this.firstFrame.name,s)}this._status=e}setStartInitInfo(e){this.log(!1,"setStartInitInfo",e),this.startInitInfo=e}trigger(e,t){var i;let r=this.getCommonData(this._player),s=null==(i=this._player)?void 0:i.state,n={...r,...t,startInfo:this.startInitInfo||{}};this.log(!1,`trigger_${e}`,n),s===Q.b.ACTIVE?super.trigger(e,n):this._metricsEvents.push({event:e,timeStamp:(0,Z.n)(),data:n})}release(){this.log(!1,"__release__",this._status);let{_callbacks:e}=this;Object.keys(e).forEach(t=>{(e[t]||[]).forEach(e=>{this.off(t,e)})}),this.stop(),this.removeEvent(),this._player=null,this._events=[],this.event=null,this._metricsEvents=[]}}var ev=i(80249),ey=i(26481),eA=i(94686),eT=i(37545),eb=i(45390),eS=i(57400),eE=i(90882),ek=(0,eA.j6)(function e(t){(0,eA.xs)(this,e),this.config=t.config,this.parent=t.root,this.root=eT.Ay.createDom("ul","",{},"xg-options-list xg-list-slide-scroll ".concat(this.config.className)),t.root.appendChild(this.root);var i=this.config.maxHeight;i&&this.setStyle({maxHeight:i}),this.onItemClick=this.onItemClick.bind(this),this.renderItemList();var r="touch"===this.config.domEventType?"touchend":"click";this._delegates=eS.Ay.delegate.call(this,this.root,"li",r,this.onItemClick)},[{key:"renderItemList",value:function(e){var t=this,i=this.config,r=this.root;e?i.data=e:e=i.data,i.style&&Object.keys(i.style).map(function(e){r.style[e]=i[e]}),e.length>0&&(this.attrKeys=Object.keys(e[0])),this.root.innerHTML="",e.map(function(e,i){var r=e.selected?"option-item selected":"option-item";e["data-index"]=i,t.root.appendChild(eT.Ay.createDom("li","<span>".concat(e.showText,"</span>"),e,r))})}},{key:"onItemClick",value:function(e){e.delegateTarget||(e.delegateTarget=e.target);var t=e.delegateTarget;if(t&&eT.Ay.hasClass(t,"selected"))return!1;var i="function"==typeof this.config.onItemClick?this.config.onItemClick:null,r=this.root.querySelector(".selected");eT.Ay.addClass(t,"selected"),r&&eT.Ay.removeClass(r,"selected"),i(e,{from:r?this.getAttrObj(r,this.attrKeys):null,to:this.getAttrObj(t,this.attrKeys)})}},{key:"getAttrObj",value:function(e,t){if(!e||!t)return{};var i={};t.map(function(t){i[t]=e.getAttribute(t)});var r=e.getAttribute("data-index");return r&&(i.index=Number(r)),i}},{key:"show",value:function(){eT.Ay.removeClass(this.root,"hide"),eT.Ay.addClass(this.root,"active")}},{key:"hide",value:function(){eT.Ay.removeClass(this.root,"active"),eT.Ay.addClass(this.root,"hide")}},{key:"setStyle",value:function(e){var t=this;Object.keys(e).forEach(function(i){t.root.style[i]=e[i]})}},{key:"destroy",value:function(){this._delegates&&(this._delegates.map(function(e){e.destroy&&e.destroy()}),this._delegates=null),this.root.innerHTML=null,this.parent.removeChild(this.root),this.root=null}}]),eP="side",ew="middle",ex="click",eC="mobile"===eE.A.device,eL=function(e){function t(e){var i;return(0,eA.xs)(this,t),i=(0,eA.qW)(this,t,[e]),(0,eA.n8)(i,"onEnter",function(e){e.stopPropagation(),i.emit("icon_mouseenter",{pluginName:i.pluginName}),i.switchActiveState(e)}),(0,eA.n8)(i,"switchActiveState",function(e){e.stopPropagation(),i.config.toggleMode===ex?i.toggle(!i.isActive):i.toggle(!0)}),(0,eA.n8)(i,"onLeave",function(e){e.stopPropagation(),i.emit("icon_mouseleave",{pluginName:i.pluginName}),i.config.listType!==eP&&i.isActive&&i.toggle(!1)}),(0,eA.n8)(i,"onListEnter",function(e){i.enterType=2}),(0,eA.n8)(i,"onListLeave",function(e){i.enterType=0,i.isActive&&i.toggle(!1)}),i.isIcons=!1,i.isActive=!1,i.curValue=null,i.curIndex=0,i}return(0,eA.B)(t,e),(0,eA.j6)(t,[{key:"updateLang",value:function(e){this.renderItemList(this.config.list,this.curIndex)}},{key:"afterCreate",value:function(){var e=this,t=this.config;this.initIcons(),(eC=eC||"touch"===this.domEventType)&&"mobile"===eE.A.device&&"default"===t.listType&&(t.listType=eP),t.hidePortrait&&eT.Ay.addClass(this.root,"portrait"),this.on([eb.F4,eb.Dx],function(){e._resizeList()}),this.once(eb.nQ,function(){t.list&&t.list.length>0&&(e.renderItemList(t.list),e.show())}),eC&&this.on(eb.Rj,function(){e.isActive&&(e.optionsList&&e.optionsList.hide(),e.isActive=!1)}),eC?(t.toggleMode=ex,this.activeEvent="touchend"):this.activeEvent=t.toggleMode===ex?"click":"mouseenter",t.toggleMode===ex?this.bind(this.activeEvent,this.switchActiveState):(this.bind(this.activeEvent,this.onEnter),this.bind("mouseleave",this.onLeave)),this.isIcons&&this.bind("click",this.onIconClick)}},{key:"initIcons",value:function(){var e=this,t=this.icons,i=Object.keys(t),r=!1;i.length>0&&(i.forEach(function(i){e.appendChild(".xgplayer-icon",t[i]),r||(r=t[i])}),this.isIcons=r),r||(this.appendChild(".xgplayer-icon",eT.Ay.createDom("span","",{},"icon-text")),eT.Ay.addClass(this.find(".xgplayer-icon"),"btn-text"))}},{key:"show",value:function(e){this.config.list&&!(this.config.list.length<2)&&eT.Ay.addClass(this.root,"show")}},{key:"hide",value:function(){eT.Ay.removeClass(this.root,"show")}},{key:"getTextByLang",value:function(e,t,i){if(void 0===e)return"";var r=this.config.list;i||(i=this.player.lang),t=!t||eT.Ay.isUndefined(e[t])?"text":t,"number"==typeof e&&(e=r[e]);try{if("object"===(0,eA.uk)(e[t]))return e[t][i]||e[t].en;return e[t]}catch(e){return console.warn(e),""}}},{key:"toggle",value:function(e){if(e!==this.isActive&&!this.config.disable){var t=this.player.controls,i=this.config.listType;e?(i===eP?t.blur():t.focus(),this.optionsList&&this.optionsList.show()):(i===eP?t.focus():t.focusAwhile(),this.optionsList&&this.optionsList.hide()),this.isActive=e}}},{key:"onItemClick",value:function(e,t){e.stopPropagation();var i=this.config,r=i.listType,s=i.list;this.curIndex=t.to.index,this.curItem=s[this.curIndex],this.changeCurrentText(),(this.config.isItemClickHide||eC||r===eP)&&this.toggle(!1)}},{key:"onIconClick",value:function(e){}},{key:"changeCurrentText",value:function(){if(!this.isIcons){var e=this.config.list,t=this.curIndex<e.length?this.curIndex:0,i=e[t];i&&(this.find(".icon-text").innerHTML=this.getTextByLang(i,"iconText"))}}},{key:"renderItemList",value:function(e,t){var i,r,s=this,n=this.config,a=this.optionsList,o=this.player;if("number"==typeof t&&(this.curIndex=t,this.curItem=n.list[t]),a){a.renderItemList(e),this.changeCurrentText();return}var l={config:{data:e||[],className:(i=n.listType,r=n.position,i===eP?r===eS.lP.CONTROLS_LEFT?"xg-side-list xg-left-side":"xg-side-list xg-right-side":""),onItemClick:function(e,t){s.onItemClick(e,t)},domEventType:eC?"touch":"mouse"},root:n.listType===eP?o.innerContainer||o.root:this.root};if(this.config.isShowIcon){var h=this.player.root.getBoundingClientRect().height,d=n.listType===ew?h-50:h;d&&n.heightLimit&&(l.config.maxHeight="".concat(d,"px")),this.optionsList=new ek(l),this.changeCurrentText(),this.show()}this._resizeList()}},{key:"_resizeList",value:function(){if(this.config.heightLimit){var e=this.player.root.getBoundingClientRect().height,t=this.config.listType===ew?e-50:e;this.optionsList&&this.optionsList.setStyle({maxHeight:"".concat(t,"px")})}}},{key:"destroy",value:function(){this.config.toggleMode===ex?this.unbind(this.activeEvent,this.switchActiveState):(this.unbind(this.activeEvent,this.onEnter),this.unbind("mouseleave",this.onLeave)),this.isIcons&&this.unbind("click",this.onIconClick),this.optionsList&&(this.optionsList.destroy(),this.optionsList=null)}},{key:"render",value:function(){if(this.config.isShowIcon)return'<xg-icon class="xg-options-icon '.concat(this.config.className||"",'">\n    <div class="xgplayer-icon">\n    </div>\n   </xg-icon>')}}],[{key:"pluginName",get:function(){return"optionsIcon"}},{key:"defaultConfig",get:function(){return{position:eS.lP.CONTROLS_RIGHT,index:100,list:[],listType:"default",listStyle:{},hidePortrait:!0,isShowIcon:!1,isItemClickHide:!0,toggleMode:"hover",heightLimit:!0}}}])}(eS.Ay),eD=function(e){function t(e){var i;return(0,eA.xs)(this,t),i=(0,eA.qW)(this,t),(0,eA.n8)(i,"_onChange",function(e){var t=i._media.textTracks;if(t&&0!==t.length){for(var r=[],s=[],n=-1,a=0;a<t.length;a++){var o=t[a];"subtitles"===o.kind&&(r.push({id:o.id||o.language,language:o.language,text:o.label,isDefault:"showing"===o.mode}),-1===n&&"showing"===o.mode&&(n=a),s.push(o.language))}s.join("|")!==i._languages?(i._languages=s.join("|"),i.emit("reset",{list:r,isOpen:n>-1})):-1===n?i.emit("off"):i.curIndex!==n&&i.emit("change",r[n]),i.curIndex=n}}),i._media=e,i._list=[],i._languages="",i.curIndex=-1,i._init(),i}return(0,eA.B)(t,e),(0,eA.j6)(t,[{key:"_init",value:function(){this._media.textTracks.addEventListener("change",this._onChange)}},{key:"switch",value:function(e){for(var t=this._media.textTracks,i=0;i<t.length;i++){var r=t[i];r.language===e.language?r.mode="showing":"showing"===r.mode&&(r.mode="disabled")}}},{key:"switchOff",value:function(){for(var e=this._media.textTracks,t=0;t<e.length;t++)e[t].mode="disabled";this.curIndex=-1}},{key:"destroy",value:function(){this._media.textTracks.removeEventListener("change",this._onChange),this._media=null,this._list=[],this._languages="",this.curIndex=-1}}])}(c()),eI="text-close";function eR(e){var t=-1;return e.forEach(function(e,i){e.id||e.language||(e.id=i),e.id=String(e.id),e.url||(e.url=e.src),e.text||(e.text=e.label),e.language||(e.language=e.srclang),void 0===e.isDefault&&(e.isDefault=e.default||!1),(e.isDefault||e.default)&&(t<0?t=i:e.isDefault=e.default=!1)}),t}var eO=function(e){function t(){var e;(0,eA.xs)(this,t);for(var i=arguments.length,r=Array(i),s=0;s<i;s++)r[s]=arguments[s];return e=(0,eA.qW)(this,t,[].concat(r)),(0,eA.n8)(e,"_onOff",function(){e.switchOffSubtitle()}),(0,eA.n8)(e,"_onChange",function(t){var i=e.getSubTitleIndex(e.config.list,t);i<0||e.updateCurItem(i,t)}),(0,eA.n8)(e,"_onListReset",function(t){e.updateList(t)}),(0,eA.n8)(e,"clickSwitch",function(t,i){var r="close"===i.type||i.type===eI;e.subTitles&&(r?e.subTitles.switchOff():e.switchSubTitle({language:i.language,id:i.id}))}),(0,eA.n8)(e,"onIconClick",function(t){e.curItem?e.subTitles.switchOff():e.switchOnSubtitle(t)}),(0,eA.n8)(e,"onPlayerFocus",function(t){e.subTitles&&e.config.style.follow&&e.rePosition()}),(0,eA.n8)(e,"onPlayerBlur",function(t){e.subTitles&&e.config.style.follow&&!e.playerConfig.marginControls&&e.subTitles.root&&(e.subTitles.root.style.transform="translate(0, 0)")}),e}return(0,eA.B)(t,e),(0,eA.j6)(t,[{key:"beforeCreate",value:function(e){var t=e.player.config.texttrack||e.player.config.textTrack;"Array"===eT.Ay.typeOf(t)&&(e.config.list=t)}},{key:"afterCreate",value:function(){var e=this.config,i=e.list,r=e.mode,s=eR(i);(0,eA.hz)(t,"afterCreate",this,3)([]),this.curIndex=-1,this.lastIndex=-1,this.curItem=null,this._nativeTracks=null,this.handlerClickSwitch=this.hook("subtitle_change",this.clickSwitch),"native"===r?this._initNativeSubtitle():s>=0&&this._initExtSubTitle(s)}},{key:"_initNativeSubtitle",value:function(){var e=this.player;e._subTitles||(e._subTitles=new eD(e.media)),this.subTitles=e._subTitles,this.subTitles.on("off",this._onOff),this.subTitles.on("change",this._onChange),this.subTitles.on("reset",this._onListReset)}},{key:"_initExtSubTitle",value:function(e){var t=this.config,i=t.list,r=t.style,s=t.isDefaultOpen,n=t.updateMode,a=t.renderMode;s&&e<0&&i.length>0&&(e=0,i[0].isDefault=!0);var o={subTitles:i,defaultOpen:s,updateMode:n,renderMode:a,debugger:this.config.debugger,domRender:!0};Object.keys(r).map(function(e){o[e]=r[e]}),!this.playerConfig.marginControls&&this.player.controls.root&&(this.on(eb.Rj,this.onPlayerFocus),this.on(eb.m_,this.onPlayerBlur));var l=this.player;l._subTitles?l._subTitles._isOpen&&(e=this.getSubTitleIndex(this.config.list,l._subTitles.currentText)):(l._subTitles=new Y(o),l._subTitles.attachPlayer(this.player)),this.subTitles=l._subTitles,this.subTitles.on("off",this._onOff),this.subTitles.on("change",this._onChange),this.subTitles.on("reset",this._onListReset),r.follow&&this.subTitles.root&&eT.Ay.addClass(this.subTitles.root,"follow-control"),this._renderList(i,s,e)}},{key:"_renderList",value:function(e,t,i){e&&0!==e.length&&(t?(e[i=i<0?0:i].isDefault=!0,this.curIndex=i,this.curItem=e[i],this.switchIconState(!0)):this.switchIconState(!1),this.player.isCanplay&&e.length>0&&(this.renderItemList(e),this.show()))}},{key:"registerIcons",value:function(){return{textTrackOpen:{icon:"",class:"xg-texttrak-open"},textTrackClose:{icon:"",class:"xg-texttrak-close"}}}},{key:"show",value:function(e){this.config.list&&!(this.config.list.length<1)&&eT.Ay.addClass(this.root,"show")}},{key:"getSubTitleIndex",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{id:"",language:""},i=-1;return t&&(t.id||t.language)&&e.forEach(function(e,r){var s,n;s=eT.Ay.isNotNull(e.id)&&eT.Ay.isNotNull(t.id)&&e.id===t.id,n=eT.Ay.isNotNull(e.language)&&eT.Ay.isNotNull(t.language)&&e.language===t.language,(s||n)&&(i=r)}),i}},{key:"updateSubtitles",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=!(arguments.length>1)||void 0===arguments[1]||arguments[1];e&&(this.updateList({list:e}),this.subTitles&&this.subTitles.setSubTitles(this.config.list,this.curIndex>-1,t))}},{key:"updateList",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(e.list){var t=[];e.list.forEach(function(e){t.push(e)});var i=eR(t);e.isOpen?(this.curIndex=i,this.curItem=i>-1?t[i]:null):(this.curIndex=-1,this.curItem=null),this.config.list=t,t.length>0?this.show():(this.switchOffSubtitle(),this.hide()),this.renderItemList()}}},{key:"switchSubTitle",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{id:"",language:""};this.switchIconState(!0),0>this.getSubTitleIndex(this.config.list,e)||this.subTitles.switch(e).catch(function(e){})}},{key:"switchOffSubtitle",value:function(e){this.emit("subtitle_change",{off:!0,isListUpdate:!1,list:[]}),this.lastIndex=this.curIndex,this.curIndex=-1,this.curItem=null,this.switchIconState(!1),this.renderItemList()}},{key:"switchOnSubtitle",value:function(){var e=this.config.list[this.lastIndex>-1?this.lastIndex:0];this.switchIconState(!0),this.switchSubTitle(e)}},{key:"switchIconState",value:function(e){this.setAttr("data-state",e?"open":"close")}},{key:"onItemClick",value:function(e,i){var r=e.delegateTarget,s=r.getAttribute("language"),n=r.getAttribute("data-id"),a=r.getAttribute("data-type");(0,eA.hz)(t,"onItemClick",this,3)(arguments),this.handlerClickSwitch(e,{language:s,id:n,type:a})}},{key:"changeCurrentText",value:function(){if(!this.isIcons){var e=this.config,t=e.list,i=e.closeText,r=this.curIndex;if(r-1<0)this.find(".icon-text").innerHTML=this.getTextByLang(i,"iconText");else if(r-1<t.length){var s=t[r-1];if(!s)return;this.find(".icon-text").innerHTML=this.getTextByLang(s,"iconText")}}}},{key:"updateCurItem",value:function(e,t){this.curIndex=e,this.curItem=this.config.list[e-1],this.renderItemList(),this.emit("subtitle_change",(0,eA.T1)({off:!1,isListUpdate:!1,list:[]},t))}},{key:"renderItemList",value:function(){var e=this,i=this.config,r=i.list,s=i.closeText,n=i.needCloseText,a=[],o=this.curIndex,l=this.curIndex;n&&(a.push({showText:this.getTextByLang(s),"data-type":eI,selected:-1===this.curIndex}),o++),r.map(function(t,i){var r={language:t.language||t.srclang||"","data-id":t.id||""};r.selected=e.curIndex===i,r.showText=e.getTextByLang(t),a.push(r)}),(0,eA.hz)(t,"renderItemList",this,3)([a,o]),this.curIndex=l,this.curItem=r[l]}},{key:"rePosition",value:function(){var e=this.config.style.fitVideo,t=0-this.player.controls.root.getBoundingClientRect().height;if(!e){this.subTitles.root.style.transform="translate(0, ".concat(t,"px)");return}var i=this.player,r=i.video,s=i.root.getBoundingClientRect(),n=s.height,a=s.width,o=parseInt(r.videoHeight/r.videoWidth*100,10)*a/100;o>n&&(o=n);var l=(n-o)/2-t;l<0&&(this.subTitles.root.style.transform="translate(0, ".concat(l,"px)"))}},{key:"destroy",value:function(){this.subTitles&&(this.subTitles.destroy(),this.subTitles=null),(0,eA.hz)(t,"destroy",this,3)([])}}],[{key:"pluginName",get:function(){return"texttrack"}},{key:"defaultConfig",get:function(){return(0,eA.T1)((0,eA.T1)({},eL.defaultConfig),{},{position:eS.lP.CONTROLS_RIGHT,index:6,list:[],isDefaultOpen:!0,style:{follow:!0,mode:"stroke",followBottom:50,fitVideo:!0,offsetBottom:2,baseSizeX:49,baseSizeY:28,minSize:16,minMobileSize:13,line:"double",fontColor:"#fff"},closeText:{text:"\u4E0D\u5F00\u542F",iconText:"\u5B57\u5E55"},needCloseText:!0,className:"xgplayer-texttrack",hidePortrait:!1,isShowIcon:!0,renderMode:"normal",mode:"external",debugger:!1})}}])}(eL),eM=i(98363),eB=i(10067),eN=Object.defineProperty,eU=(e,t,i)=>{let r;return(r="symbol"!=typeof t?t+"":t)in e?eN(e,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[r]=i},eF={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,i="~";function r(){}function s(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function n(e,t,r,n,a){if("function"!=typeof r)throw TypeError("The listener must be a function");var o=new s(r,n||e,a),l=i?i+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(i=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(i?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=i?i+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,n=r.length,a=Array(n);s<n;s++)a[s]=r[s].fn;return a},o.prototype.listenerCount=function(e){var t=i?i+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,n,a){var o=i?i+e:e;if(!this._events[o])return!1;var l,h,d=this._events[o],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,r),!0;case 4:return d.fn.call(d.context,t,r,s),!0;case 5:return d.fn.call(d.context,t,r,s,n),!0;case 6:return d.fn.call(d.context,t,r,s,n,a),!0}for(h=1,l=Array(u-1);h<u;h++)l[h-1]=arguments[h];d.fn.apply(d.context,l)}else{var c,p=d.length;for(h=0;h<p;h++)switch(d[h].once&&this.removeListener(e,d[h].fn,void 0,!0),u){case 1:d[h].fn.call(d[h].context);break;case 2:d[h].fn.call(d[h].context,t);break;case 3:d[h].fn.call(d[h].context,t,r);break;case 4:d[h].fn.call(d[h].context,t,r,s);break;default:if(!l)for(c=1,l=Array(u-1);c<u;c++)l[c-1]=arguments[c];d[h].fn.apply(d[h].context,l)}}return!0},o.prototype.on=function(e,t,i){return n(this,e,t,i,!1)},o.prototype.once=function(e,t,i){return n(this,e,t,i,!0)},o.prototype.removeListener=function(e,t,r,s){var n=i?i+e:e;if(!this._events[n])return this;if(!t)return a(this,n),this;var o=this._events[n];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||a(this,n);else{for(var l=0,h=[],d=o.length;l<d;l++)(o[l].fn!==t||s&&!o[l].once||r&&o[l].context!==r)&&h.push(o[l]);h.length?this._events[n]=1===h.length?h[0]:h:a(this,n)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=i,o.EventEmitter=o,e.exports=o}(eF);var eV=eF.exports;let e$=!1;function ez(e,t="user",i){if(e){i(`call audioCtx.resume step: ${t}`);try{let r=e.resume();return r&&r.then&&r.then(()=>{i("audioCtx.resume success",t)}).catch(e=>{i("audioCtx.resume error",t,e)}),r}catch(e){i("audioCtx.resume error",t,e)}}}try{r="0.0.3"}catch{r="debug-version"}let ej=r,eG={ERROR:"error",META_UPDATE:"metaupdate",META_APPEND:"metaappend",WORKER_READY:"workerready",WORKER_ERROR:"workererror"},eH="running",eW=[],eq=[],eK=null;class eY{constructor(e){eU(this,"loudnessDetect"),eU(this,"ctx"),eU(this,"_onLoudnessDetectEvents",e=>{e.eventName===eG.META_UPDATE&&this.ctx.emit("meta_update",e),e.eventName=`loudness.${e.eventName}`,this.ctx.emit("loudness",e)}),this.ctx=e;let{loudnessDetect:t,logger:i}=this.ctx.config;this.loudnessDetect=new eK({id:this.ctx.playerId,logger:i,...t}),Object.keys(eG).forEach(e=>{var t;null==(t=this.loudnessDetect)||t.on(eG[e],this._onLoudnessDetectEvents)})}}class eX extends eV.EventEmitter{constructor(e={}){super(),eU(this,"media"),eU(this,"config"),eU(this,"playerId"),eU(this,"_isMutedStart",!1),eU(this,"_audioCtx"),eU(this,"_sourceReady",!1),eU(this,"_log",(e,...t)=>{(this.config.logger||"u">typeof window&&window.location&&window.location.href.indexOf("xgplayerdebugger=1")>-1)&&console.log(`[MammonEngine_LOG][${ej}]${this.playerId}  ${e}`,...t)}),eU(this,"_onPlayerError",()=>{}),eU(this,"_onVolumeChange",()=>{var e;if(!this.media||!this._audioCtx)return;let t=this.media.muted,{_source:i}=this.media;if(!t&&this._isMutedStart&&(this._isMutedStart=!1,(null==(e=this._audioCtx)?void 0:e.state)==eH&&!i))return void this._initSource();this._audioCtx.state!==eH&&ez(this._audioCtx,"volumechange",this._log)}),eU(this,"_onTimeupdate",()=>{this.media&&this._audioCtx&&this._loudnessDetect&&this._loudnessDetect.onTimeupdate(this.media.currentTime)}),eU(this,"_onPause",()=>{this.media&&this._log("_onPause")}),eU(this,"_onPlay",()=>{this._audioCtx&&this.media&&(this._log(`_onPlay ${this._audioCtx.state} _sourceReady:${this._sourceReady}`),this._audioCtx.state===eH||this._sourceReady||ez(this._audioCtx,"onplay",this._log))}),eU(this,"_onLoadedData",()=>{var e;this.media&&((null==(e=this._audioCtx)?void 0:e.state)!==eH&&ez(this._audioCtx,"loadeddata",this._log),this._loudnessDetect&&this._loudnessDetect.onTimeupdate(this.media.currentTime))}),eU(this,"_onAudioContextStatechange",()=>{if(!this._audioCtx||!this.media)return;let{state:e}=this._audioCtx,{_source:t}=this.media;this._log(`onAudioContextStatechange state:${e}`),!(e!==eH||this._isMutedStart)&&(t||this._initSource())}),eU(this,"_loudnessDetectContext"),this.config={logger:!1},Object.keys(e).map(t=>{this.config[t]=e[t]}),this._audioCtx=null,this.playerId=new Date().getTime(),this._initLoudnessDetect(),delete this.media}get _effector(){return this.config.effector}get sampleRate(){var e;return(null==(e=this._audioCtx)?void 0:e.sampleRate)||0}attachElement(e,t){var i,r;if(!e||typeof Window>"u"||!(window.AudioContext||window.webkitAudioContext)||this.media===e||(this.media&&this.detachElement(),this.media=e,!this.media))return;if(this._isMutedStart=null==(i=this.media)?void 0:i.muted,!this._checkCrossOrigin(this.media)){let e=this._getError(16,"VALUE_OF_VIDEO[crossOrigin]_IS_INVALID");this.emit("error",e);return}let{_source:s}=this.media;s&&s.context?this._audioCtx=s.context:this._audioCtx=t||eX.popAudioContext(),this._audioCtx&&"running"!==this._audioCtx.state&&this.emit("warn",{type:"ctx_suspend"});let n=function(){if(e$)return e$;let e=new AudioContext,t="running"===e.state;return e.suspend().catch(()=>{}),e.close().catch(()=>{}),e$=t,t}();null==(r=this._audioCtx)||r.addEventListener("statechange",this._onAudioContextStatechange),this._log("attachPlayer",this.playerId,"autoplayPolicy",n,"isMutedStart",this._isMutedStart),n&&!this._isMutedStart&&this._initSource(),this._bindPlayerEvent()}detachElement(){var e,t;if(!this.media)return;let{_loudnessDetect:i}=this;i&&i.reset(),this._log("detachPlayer",this.playerId),null==(e=this._audioCtx)||e.removeEventListener("statechange",this._onAudioContextStatechange),null==(t=this._effector)||t.destroy(),this._audioCtx&&eX.pushAudioContext(this._audioCtx),this._unbindPlayerEvent(),delete this._audioCtx,delete this.media}destroy(){this.offAll(),this.detachElement(),this._loudnessDetect&&this._loudnessDetect.destroy(),delete this.config.effector}_checkCrossOrigin(e){let t=e.getAttribute("crossorigin");return this._log("checkCrossOrigin ",t),e instanceof HTMLMediaElement&&("anonymous"===t||"use-credentials"===t)}_bindPlayerEvent(){var e,t,i,r,s,n;null==(e=this.media)||e.addEventListener("play",this._onPlay),null==(t=this.media)||t.addEventListener("pause",this._onPause),null==(i=this.media)||i.addEventListener("loadeddata",this._onLoadedData),null==(r=this.media)||r.addEventListener("timeupdate",this._onTimeupdate),null==(s=this.media)||s.addEventListener("volumechange",this._onVolumeChange),null==(n=this.media)||n.addEventListener("error",this._onPlayerError)}_unbindPlayerEvent(){var e,t,i,r,s,n;null==(e=this.media)||e.removeEventListener("play",this._onPlay),null==(t=this.media)||t.removeEventListener("pause",this._onPause),null==(i=this.media)||i.removeEventListener("loadeddata",this._onLoadedData),null==(r=this.media)||r.removeEventListener("timeupdate",this._onTimeupdate),null==(s=this.media)||s.removeEventListener("volumechange",this._onVolumeChange),null==(n=this.media)||n.removeEventListener("error",this._onPlayerError)}_initSource(){let{media:e,_audioCtx:t}=this;if(!(!t||!e||this._isMutedStart))try{let i=this._getSource(t,e);if(!i)throw Error("init_or_createMediaElementSource error");if(!this._effector)throw Error("effector is undefined");this._effector.playerId=this.playerId,this._effector.ctx=this,this._effector.create(t,i),this._sourceReady=!0}catch(t){let e=this._getError(21,t.message||"connect_effect_error");this.emit("error",e)}}_getSource(e,t){try{let{_source:i}=t;return i||(i=e.createMediaElementSource(t),t._source=i),i}catch{return null}}_getError(e,t){return{...this._getStateInfo(),error:`${e}_${t}`,code:e}}_getStateInfo(){let{media:e,_audioCtx:t}=this;return{version:ej,state:t?t.state:0,volume:e?e.volume:-1,muted:e?+!!e.muted:-1,currentTime:e?e.currentTime:-1}}emit(e,t,...i){super.emit(e,t,...i)}on(e,t,...i){super.on(e,t,...i)}once(e,t,...i){super.once(e,t,...i)}off(e,t,...i){super.off(e,t,...i)}offAll(){super.removeAllListeners()}static getAudioContext(e){if(typeof window>"u")return null;let t=window.AudioContext||window.webkitAudioContext;if(!t||!eX.isSupported())return null;if(0===eq.length&&eq.push(new t),!e)return eq[0];let i=null;return eW.forEach(t=>{t.sampleRate===e&&(i=t)}),i||(i=new t({sampleRate:e}),eW.push(i)),i}static popAudioContext(){if(typeof window>"u")return null;let e=window.AudioContext||window.webkitAudioContext;if(!e||!eX.isSupported())return null;0===eq.length&&eq.push(new e);let t=null;if((t=eq.shift()||null)&&"suspended"===t.state&&t.resume(),0===eq.length){let t=new e;t.suspend(),eq.push(t)}return t}static async pushAudioContext(e){e.suspend(),eq.push(e)}static isSupported(){return"u">typeof window&&(window.AudioContext||window.webkitAudioContext)}static get __AUDIO_CONTEXT_LIST(){return eW}static get autoSampleRate(){return eW.length>0?eW[0].sampleRate:0}static get version(){return ej}static registerLoudnessDetector(e,t){eK||(eK=e,t&&(eK.workerUrl=t))}get _loudnessDetect(){var e;return null==(e=this._loudnessDetectContext)?void 0:e.loudnessDetect}_initLoudnessDetect(){let{loudnessDetect:e}=this.config;eK&&e.enable&&(this._loudnessDetectContext=new eY(this))}}class eQ extends eV.EventEmitter{constructor(e){super(),eU(this,"config"),eU(this,"ctx",null),eU(this,"playerId",null),this.config=e||{}}destroy(){this.ctx=null,this.playerId=null}}class eJ extends eQ{constructor(){super(...arguments),eU(this,"_ac"),eU(this,"_source"),eU(this,"_gainNode"),eU(this,"_params"),eU(this,"_pendingEqualize",!1),eU(this,"_disabled",!1)}create(e,t){this._ac=e,this._source=t;let i=e.createGain();this._gainNode=i,t.connect(i),i.connect(e.destination),this._pendingEqualize&&this.equalize()}getAudioContext(){return this._ac}getGainValue(){return this._gainNode?this._gainNode.gain.value:1}setGainValue(e,t){this._gainNode&&this._gainNode.gain.value!==e&&(this._gainNode.gain.value=e,this.emit("gainvaluechange",{params:this._params,equalized:t,gainValue:e}))}enable(){this._disabled=!1,this.equalize()}disable(){this._disabled=!0,this._pendingEqualize=!1,this.setGainValue(1,!1)}equalize(){if(this._disabled)return!1;if(!this._gainNode){this._pendingEqualize=!0;return}let e=this._params;if(!e)return this.setGainValue(1,!1),!0;let{loudness:t,targetLufs:i,peak:r=0}=e,s=i-t,n=Math.pow(10,s/20);return r*n>1&&(n=Math.pow(10,Math.min(s,20*Math.log10(1/r))/20)),isNaN(n)?(this.setGainValue(1,!1),!1):(this.setGainValue(n,!0),!0)}setParams(e){this._params=e}destroy(){this._gainNode&&(this._ac&&this._gainNode.disconnect(this._ac.destination),this._source&&this._source.disconnect(this._gainNode)),this._pendingEqualize=!1,this._params=void 0,this._gainNode=void 0,this._source=void 0,this._ac=void 0,this._disabled=!1,this.removeAllListeners()}}var eZ=i(64455);class e0 extends eZ.bk{constructor(){super(...arguments),this.name="audio-equalizer",this._logger=eZ.MD.createLogger(this.name),this._disabled=!1,this._handleGainValueChange=e=>{let t=this.getAudioContext(),i={state:null==t?void 0:t.state,...e};this.emit("gainvaluechange",i),this._logger.log("volume equalize,",e.equalized,e.gainValue,this._params)},this._handleLoadedmetadata=()=>{this._disabled||(this._effector||this._setup(),this._effector&&(this._effector.setParams(this._params),this._effector.equalize()))},this._handleError=e=>{this._effector&&this._effector.disable(),this._logger.error(e),this.emit("error",new eB.Mk(eB.Mk.Code.OTHER,e.error||"unknow audio equailzer error"))},this._setup=()=>{let e=this._controller;e&&(this._effector=new eJ,this._engine=new eX({logger:!1,effector:this._effector}),this._engine.on("error",this._handleError),this._engine.attachElement(e.getElement()),this._effector.on("gainvaluechange",this._handleGainValueChange),this.emit("setup"))}}install(e){let{controller:t}=e;t.on("loadedmetadata",this._handleLoadedmetadata),this._controller=t}getAudioContext(){var e;return(null==(e=this._engine)?void 0:e._audioCtx)||null}getGainValue(){return this._effector?this._effector.getGainValue():1}setParams(e){this._params=e||void 0}disable(){this._disabled=!0,this._effector&&this._effector.disable()}enable(){this._disabled=!1,this._effector&&this._effector.enable()}uninstall(e){let{controller:t}=e;t.off("loadedmetadata",this._handleLoadedmetadata),this._engine&&(this._engine.destroy(),this._engine=void 0),this._effector&&(this.disable(),this._effector.off("gainvaluechange",this._handleGainValueChange),this._effector=void 0),this._params=void 0,this._controller=void 0}}var e1=Object.defineProperty;let e2="multiplex";function e4(){let{regionInfo:e}=h.M,{shortData:t,deviceScore:i,gpuScoreData:r}=h.M.deviceMark;return{playMode:h.M.playMode,tag:h.M.pageName,subtag:h.M.playMode,preTag:h.M.prePageName,preSubtag:h.M.prePlayMode,region:(null==e?void 0:e.region)||"",isLogin:!(null!=e&&e.isLogin),deviceScore:t,d_score:i||0,gpu:r.gpu||"",vendor:r.vendor||""}}function e8(){return h.M.getAbVersions()}function e5(e,t=!0){return!e||e.length<1?-1:t?e.end(e.length-1):e.start(e.length-1)}function e3(e){return e?+!!e.hasStart:-1}function e6(e){return e?+!!e.isPlaying:-1}function e9(e){if(!e)return null;let t=e5(e.buffered);return{buff:t<0?t:(0,Z.d)(t),state:e.state,hasStart:e3(e),playing:e6(e)}}function e7(e,t){return null==e?void 0:e.getPlugin(t)}async function te(e){if(!document.fullscreenElement)return Promise.resolve();for(let e=0;e<Q.E.length;e++){let t=Q.E[e];if("function"==typeof document[t])return await document[t]()}}async function tt(e){if(!e)return Promise.reject(Error("requestFullscreen dom is undefined"));for(let t=0;t<Q.G.length;t++){let i=Q.G[t];if("function"==typeof e[i])return await e[i]()}}function ti(e){return e.state===Q.b.ACTIVE}function tr(e){return e.state===Q.b.RELEASE||e.state===Q.b.DESTROY}function ts(e,t){let i=null;return e.forEach(e=>{e.type===t&&(i=e)}),i}function tn(e){let t=e.vtype||Q.V.MP4;return{definition:e.definition||Q.U,bitrate:e.bitrate||0,codecType:e.codecType||Q.C.H264,vtype:t,format:t,url:e.url,qualityType:(null==e?void 0:e.qualityType)||0,vid:(null==e?void 0:e.vid)||""}}function ta(e){return e?(0,X.j)(e):null}function to(e,t,i,r,s,n){var a;if(e.length<1)return null;let o=(a=null==r?void 0:r.codecType,t!==Q.C.H265||a&&a!==Q.C.H265?Q.C.H264:Q.C.H265),l=(null==r?void 0:r.vtype)||i,h=(null==r?void 0:r.definition)||"",{targetBitrateList:d,fallbackBitrateList:u,codec:c,format:p,resolutionList:f}=X.a.filter(e,{codec:o,format:l});return{curBitrate:X.a.select(d,{codec:c,format:p,definition:h},"player",n?{config:n}:{}),h264Bitrate:X.a.select(u,{definition:h},"player"),targetBitrateList:d,fallbackBitrateList:u,resolutionList:f,codec:c||o,format:p||l,preloadCodec:(null==r?void 0:r.codecType)||null,preloadDefinition:(null==r?void 0:r.definition)||null,preloadFormat:(null==r?void 0:r.vtype)||null}}function tl(e,t){let{H264DefinitionList:i,h264DefinitionList:r}=e.config,s=r||i;if(s&&s.length>0){let i=s[0];return e.emit("playCatch","MP4_3",{errorCode:(null==t?void 0:t.code)||8200,message:(null==t?void 0:t.message)||"width and height is 0"}),e.setConfig({defaultBitrate:i.bitrate,defaultDefinition:i.definition,url:i.url,codecType:i.codecType}),e.src=i.url,e.play(),!0}return!1}function th(e,t){let{minBuffer:i}=t;if(!e||!i)return!0;if(e&&e.length>0){let t=e.end(e.length-1);if((0,Z.d)(t)>=i)return!0}return!1}function td(e){return e&&e.player?+!!e.player.hasStart:-1}function tu(e){return e&&e.player?+!!e.player.isPlaying:-1}function tc(e){if(!e)return null;let t=e5(e.buffered);return{buff:t<0?t:(0,Z.d)(t),state:e.state,hasStart:td(e),playing:tu(e)}}function tp(e){return(null==e?void 0:e.vodLogger)||null}function tf(e){return(null==e?void 0:e.getPlugin("mp4encryptplayer"))||null}function tm(e){let{enableHevcSoftwareDecode:t}=e;return!!t&&(0,Z.j)()}function tg(e){return"string"==typeof e?e:e.map(e=>"object"==typeof e?e:{src:e})}class t_ extends ei{constructor(e=Q.P.XG,t){super(),this.vid=null,this.mediaType=null,this.format=Q.V.MP4,this.uuIndex=h.M.generateInstanceIndex(),this.uuid=h.M.generateUUID(e,this.uuIndex),this.playerType=e,this.player=null,this.forceAutoplay=!1,this.attemptPlayCount=0,this.vqscore=0,this.mvmaf="",this.events=["autoplayPrevented"],this.state=t||Q.b.ACTIVE,this.bitrateList=[],this.curBitrate=null,this.resolutionInfo=null}get element(){return null}get codec(){var e;return null==(e=this.player)?void 0:e.config.codecType}set codec(e){this.player&&(this.player.config.codecType=e)}get type(){return this.playerType}get isActive(){return this.state===Q.b.ACTIVE}style(e,t){this.element&&(this.element.style[e]=t)}set volume(e){this.element&&(this.element.volume=e)}set muted(e){this.element&&(this.element.muted=e)}set objectFit(e){if(!e)return void(0,Z.k)(this.element,"object-fit");this.element&&(this.element.style.objectFit=e)}get readyState(){var e;return(null==(e=this.player)?void 0:e.readyState)||0}get networkState(){var e;return(null==(e=this.player)?void 0:e.networkState)||0}set playbackRate(e){this.element&&(this.element.playbackRate=e)}get currentTime(){return this.element?this.element.currentTime:0}get duration(){return this.element?this.element.duration:0}get width(){return this.element?this.element.videoWidth:0}get height(){return this.element?this.element.videoHeight:0}get paused(){var e;return(null==(e=this.element)?void 0:e.paused)||!1}get ended(){var e;return(null==(e=this.player)?void 0:e.ended)||!1}get error(){return this.element?this.element.error:null}get attributes(){let{element:e}=this;return{error:(null==e?void 0:e.error)||null,src:(null==e?void 0:e.currentSrc)||"",currentTime:(null==e?void 0:e.currentTime)||0,muted:!!(null!=e&&e.muted),duration:(null==e?void 0:e.duration)||0,readyState:(null==e?void 0:e.readyState)||0,networkState:(null==e?void 0:e.networkState)||0,buffered:null==e?void 0:e.buffered,volume:(null==e?void 0:e.volume)||1,ended:!!(null!=e&&e.ended),paused:!!(null!=e&&e.paused),seeking:!!(null!=e&&e.seeking),currentSrc:(null==e?void 0:e.currentSrc)||""}}get isReady(){return!!this.element&&this.element.readyState>=2}get curDefinition(){return{url:"",definition:"",bitrate:-1,duration:-1,codecType:"h264"}}get playbackQuality(){var e,t;return this.element&&"VIDEO"===this.element.tagName&&(null==(t=(e=this.element).getVideoPlaybackQuality)?void 0:t.call(e))||null}getVideoPlaybackQuality(){return this.playbackQuality}proxyOn(e,t){return super.on(e,t)}proxyOff(e,t){return super.off(e,t)}updateConfig(e){}on(e,t){this.element&&this.element.addEventListener(e,t)}off(e,t){this.element&&this.element.removeEventListener(e,t)}once(e,t){}mute(e){this.element&&(this.element.muted=e)}access(){if(this.element)return this.play().then(()=>{this.pause()})}load(e){if(!this.element)return;let t=tg(e),i="";i=t instanceof Array?e.length>0?t[0].src:"":t,this.element.src=i}seek(e){this.element&&(this.element.currentTime=e)}play(){return this.element?this.element.play():Promise.resolve()}replay(){return this.seek(0),this.play()}pause(){this.element&&this.element.pause()}get buffered(){var e;return null==(e=this.element)?void 0:e.buffered}reset(){}release(e){this.attemptPlayCount=0}addSubtitle(e,t){}async enterFullscreen(e){this.element&&(this.element.requestFullscreen?this.element.requestFullscreen():this.element.mozRequestFullScreen?this.element.mozRequestFullScreen():this.element.webkitRequestFullscreen?this.element.webkitRequestFullscreen():this.element.msRequestFullscreen?this.element.msRequestFullscreen():this.element.webkitEnterFullscreen&&this.element.webkitEnterFullscreen())}async exitFullscreen(e){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.webkitExitFullscreen?window.document.webkitExitFullscreen():window.document.msExitFullscreen?window.document.msExitFullscreen():this.element&&this.element.webkitExitFullScreen&&this.element.webkitExitFullScreen()}tryPlay(e){window.setTimeout(()=>{this.attemptPlayCount>=3||(e.message.match(Q.c.LoadInterrupt)||e.message.match(Q.c.Abort)||this.trigger("autoplayPrevented",e),(e.message.match(Q.c.NoInteract)||e.message.match(Q.c.SafariNoInteract)||e.message.match(Q.c.FireFox))&&this.mute(!0),this.play(),this.attemptPlayCount+=1)},0)}initStyle(){this.element&&(this.element.style.width="100%",this.element.style.height="100%",this.element.style.position="absolute",this.element.style.top="0",this.element.style.left="0",this.element.style["::-webkit-media-controls-enclosure"]={display:"none !important"})}initProperty(){this.element&&(this.element.controls=!1,this.element.loop=!1,this.element.muted=!1,this.element.playsInline=!0,this.element.poster="",this.element.preload="auto")}getVideoDesc(){return{videoType:"mp4"}}updatePreloadCodec(e){}changeState(e){this.state=e}changeVideo(e,t,i){}mountDom(e){var t;let i=null==(t=this.player)?void 0:t.root;if(!(!i||!e||i.parentNode===e))try{e.appendChild(i)}catch(e){console.error(e)}}unMountDom(){var e,t;let i=null==(e=this.player)?void 0:e.root;if(i)try{null==(t=null==i?void 0:i.parentElement)||t.removeChild(i)}catch(e){console.error(e)}}isSoftHevc(){return!1}}let tv="[XGplayer]";class ty extends t_{constructor(e,t){super(Q.P.XG),this.useSoftHevc=!1,this._onAutoplayPrevent=()=>{var e;(0,Z.l)(tv,this.uuid,"_onAutoplayPrevent",this.uuid,`forceAutoplay:${this.forceAutoplay}`,this.attemptPlayCount),this.attemptPlayCount>=3||!this.forceAutoplay||(this.mute(!0),null==(e=this.player)||e.play(),this.attemptPlayCount+=1)},this._onAutoplayStart=()=>{var e;(0,Z.l)(tv,this.uuid,"onAutoplayStart",this.uuid),null==(e=this.player)||e.off(J.AUTOPLAY_PREVENTED,this._onAutoplayPrevent)},this._onCanplay=()=>{if(this.state!==Q.b.ACTIVE&&this.player){let e=this.player;e.currentTime>.1&&(e.currentTime=0),null==e||e.pause()}},this._onLoadedData=()=>{var e;let t=this.player;if(!t||!t.media)return;let{videoWidth:i,videoHeight:r}=t.media,{codecType:s,defaultBitrate:n,defaultDefinition:a}=t.config,o=(0,Z.m)((null==(e=this.element)?void 0:e.currentSrc)||"");(0,Z.l)(tv,this.uuid,"_onLoadedData",`isMse:${o} useSoftHevc:${this.useSoftHevc}`,s,i,r,n,a),o||this.useSoftHevc||0!==i||0!==r||"h265"!=t.config.codecType||(h.a.focusDisableHevc({hevcMsg:"width and height is 0",hevcCode:2}),tl(t),this.updatePreloadCodec(Q.C.H264)),this.useSoftHevc&&this.initStyle()},this._onTimeupdate=()=>{var e;this.state!==Q.b.ACTIVE&&(null==(e=this.player)||e.pause())},this._onEmptied=()=>{this.initStyle()},this._onDegrade=e=>{if(!this.player)return;let{errorCode:t,errorMessage:i,mediaType:r,isSoftWareDecodeError:s}=e;r===Q.M.TT_VIDEO&&this.player.on(J.EMPTIED,this._onEmptied),(0,Z.l)(tv,"_onDegrade",`isSoftWareDecodeError:${s}`,r,e),s&&(h.a.forceDisableSoftHevc({code:t,message:i}),X.i.changeCodec(Q.C.H264)),function(e){var t;let{defaultBitrate:i,defaultDefinition:r,codecType:s}=e.config;null==(t=tp(e))||t.update({defaultBitrate:i,defaultDefinition:r,codec_type:s})}(this.player),this.useSoftHevc=!1,this.initStyle()},this._onDownloaded=e=>{if(!e)return;let{cdn_size:t=0,cdn_speed:i=0,time:r}=e;(0,Z.l)(tv,"_onDownloaded",`cdn_speed:${i} cdn_size:${t}`,e),X.N.addSample({speed:i,size:t,duration:r},tv)},this.plugins=[],this.metrics=null,this.event=null,this.config={};let i=t||Q.b.ACTIVE;this.state=i,this.timerId=void 0,this._init(e),this.changeState(i)}getVideoMiddleware(){return{error:(e,t)=>{var i,r;let{player:s}=e;if(s&&this.codec===Q.C.H265)try{let n=tl(s,null==e?void 0:e.error);h.a.focusDisableHevc({hevcMsg:(null==(i=null==e?void 0:e.error)?void 0:i.message)||"un support",hevcCode:(null==(r=null==e?void 0:e.error)?void 0:r.code)||3}),s.setEventsMiddleware({error:null}),n||t("error",e)}catch{t("error",e)}else t("error",e)}}}get element(){var e;return(null==(e=this.player)?void 0:e.media)||null}_init(e){var t,i,r,s;let n={};e||(e={}),e.enableSubtitle&&this._initSubtitle(),e.enablePreloader&&e.preloader?this._initPreloader(e.preloader):X.i.disable(),e.enableLogger&&e.logger&&this._initLoggerBefore(e.logger);let{video:o,logger:l,extra:u,enableHevcSoftwareDecode:c,hevcDisableResolution:p}=e,f=(null==o?void 0:o.autoplay)===void 0||o.autoplay,m=(null==o?void 0:o.muted)!==void 0&&o.muted;m&&(n.muted=m),this.vqscore=(null==o?void 0:o.vqscore)||0;let g=(null==l?void 0:l.line_app_id)||0,_=(null==l?void 0:l.vid)||"",{actualUrl:v,url:y}=u||{actualUrl:void 0,url:""},A=(null==u?void 0:u.vid)||"";this.vid=A;let{bitrateList:T=[]}=e,b=(null==o?void 0:o.codecType)||"h264",S=Q.V.MP4,E=tm(e),{dScore:k}=h.M.getDeviceScore(),P=e.bitrateAdapter||{},w=(0,X.g)(p||[],k),x=E?w||[Q.i.R_1080]:[];P.disableResolutions?P.disableResolutions.hevc=x:P.disableResolutions={hevc:w,h264:[]},this._initAdapter(P),this.bitrateList=T||[];let C=X.i.getPreloadMeta(A),{playSelector:L}=e,D=to(T,b,S,C,A,L),I=(null==D?void 0:D.curBitrate)||null,R=(null==I?void 0:I.codecType)||b,O=tg((null==I?void 0:I.url)||v||y||""),M=null!=D&&D.h264Bitrate?[null==D?void 0:D.h264Bitrate]:(null==u?void 0:u.h264BitrateList)||(o?[{bitrate:null==o?void 0:o.defaultBitrate,definition:null==o?void 0:o.defaultDefinition,url:O,codecType:null==o?void 0:o.codecType,vtype:"MP4",format:"MP4"}]:[]),B=(null==I?void 0:I.bitrate)||(null==o?void 0:o.defaultBitrate)||0,N=(null==I?void 0:I.definition)||(null==o?void 0:o.defaultDefinition)||"";this.mvmaf=(null==I?void 0:I.mvmaf)||(null==o?void 0:o.mvmaf)||"";let U="h265"===R&&E;this.useSoftHevc=U;let F=!!(null!=C&&C.preloadDefinition),V=U?Q.M.TT_VIDEO:Q.M.VIDEO;this.mediaType=V;let $=!(0,Z.h)()&&(0,Z.e)()||U,{preloadDefinition:z=null,preloadCodec:j=null}=D||{};if((0,Z.l)("getInitBitrate",this.uuid,A,$,`hasPreload:${F} preload: ${z}_${j} useSoftHevc:${U} curBitrate: ${null==I?void 0:I.definition} initCodec:${b} initFormat:MP4 codecType:${R} format:MP4`,I,M,this.bitrateList),$?this.plugins.push(eM.Ay):n.preload="auto",this.config={vid:A,isNoRoot:!0,controls:!1,plugins:this.plugins,autoplay:f,codecType:R,width:"100%",height:"100%",videoConfig:n||{},volume:(null==o?void 0:o.volume)||1,playbackRate:(null==o?void 0:o.playbackRate)||1,H264DefinitionList:(M.forEach(e=>{e.url=tg(e.url)}),M),url:O,nullUrlStart:!O,ignores:(null==u?void 0:u.ignores)||[],defaultDefinition:N,defaultBitrate:B,duration:(null==o?void 0:o.duration)||0,videoInit:(null==u?void 0:u.videoInit)===void 0||u.videoInit,autoplayMuted:m,mediaType:V,startTime:(null==u?void 0:u.startTime)||0},this.curBitrate=I,(0,Z.l)(tv,"config",this.uuid,this.state,`videoInit:${this.config.videoInit}`,`addMSEPlugin:${$} needCheck:${null==(t=e.mp4EncryptPlayer)?void 0:t.needCheck}`,e),e.enableLogger){let{logger:t}=e,{ext:s={}}=t||{},n=h.a.getHevcDisableInfo()||{},l={...e4(),codec_type:U?`soft_${R}`:R,decodeFlag:"h265"===R,defaultBitrate:B,defaultDefinition:N,line_app_id:g,vid:_,vtype:"MP4",...t,fIndex:this.uuIndex,playerCoreVersion:eM.Ay.version,pv:ey.A.version,strategyVersion:d.v,ext:{...s,...n,preload_codec:null==C?void 0:C.preloadCodec,preload_def:null==C?void 0:C.preloadDefinition},bitrateAdapter:{userResolution:(null==P?void 0:P.userSelectResolution)||"auto",qualityType:(null==I?void 0:I.qualityType)||0,selector:(null==P?void 0:P.selector)||"default"},closeEvents:(null==t?void 0:t.closeEvents)||[],playerType:"XG",videoInfo:{volumeInfo:{loudness:(null==(i=null==o?void 0:o.volumeInfo)?void 0:i.loudness)||0,peak:(null==(r=null==o?void 0:o.volumeInfo)?void 0:r.peak)||0}}};if(this.config.vodLogOpts=l,this.player){let e=tp(this.player);null==e||e.update(l,a.Tx.RELOAD)}}e.mp4EncryptPlayer&&(this.config.mp4EncryptPlayer=e.mp4EncryptPlayer,U&&(this.config.mp4EncryptPlayer.needCheck=!1,this.config.mp4EncryptPlayer.supportHevc=!1,this.player&&function(e,t){let i=tf(e);null==i||i.setConfig(t)}(this.player,this.config.mp4EncryptPlayer),X.i.update({supportHevc:!1}))),(0,Z.l)(tv,"PlayerInit",this.uuid,this.state,`enableHevcSoftwareDecode:${c}, useSoftHevc:${U} initCodec:${b} codecType:${R} videoInit:${this.config.videoInit}`,`addMSEPlugin:${$} needCheck:${null==(s=e.mp4EncryptPlayer)?void 0:s.needCheck}`,this.config),this.player?((0,Z.l)(tv,"PlayerInit reuse",this.uuid,this.state,this.config),this.player.playNext(this.config),this.player.volume=(null==o?void 0:o.volume)||1,this.player.muted=m,this.player.playbackRate=(null==o?void 0:o.playbackRate)||1):((0,Z.l)(tv,"PlayerInit new",this.uuid,this.state,this.config),this.player=new ey.A(this.config),this.player.uuid=this.uuid),this.codec=this.config.codecType,this.format=Q.V.MP4,this.bindPlayerEvents(this.player),X.a.attachVideo(this.player.media,{bitrate:this.config.defaultBitrate,vid:this.config.vid}),X.i.addPlayingVid(A),$||this.player.setEventsMiddleware(this.getVideoMiddleware()),this.player.preloader=X.i.preloader,this.initStyle(),this.initProperty(),this.resolutionInfo={currentResolution:(null==I?void 0:I.resolution)||"",codecType:R,vtype:S,resolutionList:(null==D?void 0:D.resolutionList)||[],bitrateList:T,targetBitrateList:null==D?void 0:D.targetBitrateList},this._emitResolutionReady()}_emitResolutionReady(){this.timerId&&(window.clearTimeout(this.timerId),this.timerId=void 0),this.timerId=setTimeout(()=>{this.player.emit("resolutionReady",this.resolutionInfo),this.timerId=void 0},0)}_initAdapter(e){e&&X.a.updateConfig(e)}_initSubtitle(){this.plugins.push(eO)}_initPreloader(e){a.DS.attachPreloader(X.i.preloader),X.i.update(e)}_initLoggerBefore(e){a.DS.AB_SDK_VERSION=e8(),a.K.init(ev.Collector,e.channelConfig,{region:e.region,user_unique_id:e.webId,user_is_login:e.isLogin,user_id:e.uid||e.webId}),this.plugins.push(a.Ay)}supportMSE(){return!!tf(this.player)}set objectFit(e){this.player&&this.player.media&&(this.player.config.mediaType===Q.M.TT_VIDEO?this.player.media.objectFit=e:this.player.media.style.objectFit=e)}set volume(e){this.player&&(this.player.volume=e||1)}set muted(e){this.player&&(this.player.muted=e)}set playbackRate(e){this.player&&(this.player.playbackRate=e)}get currentTime(){var e;return null==(e=this.player)?void 0:e.currentTime}get duration(){var e;return(null==(e=this.player)?void 0:e.duration)||0}get attributes(){let{element:e,player:t}=this,i=(null==t?void 0:t.rawSrc)||(null==e?void 0:e.currentSrc)||(null==e?void 0:e.src)||"";return{error:(null==e?void 0:e.error)||null,src:i,currentTime:(null==e?void 0:e.currentTime)||0,muted:!!(null!=e&&e.muted),duration:(null==e?void 0:e.duration)||0,readyState:(null==e?void 0:e.readyState)||0,networkState:(null==e?void 0:e.networkState)||0,buffered:null==e?void 0:e.buffered,volume:(null==e?void 0:e.volume)||1,ended:!!(null!=e&&e.ended),paused:!!(null!=e&&e.paused),seeking:!!(null!=e&&e.seeking),currentSrc:i}}get isReady(){var e;return(null==(e=this.player)?void 0:e.isCanplay)||!1}get volume(){var e;return(null==(e=this.player)?void 0:e.volume)||1}get muted(){var e;return(null==(e=this.player)?void 0:e.muted)||!1}get playbackRate(){var e;return(null==(e=this.player)?void 0:e.playbackRate)||1}get curDefinition(){var e;let t=(null==(e=this.player)?void 0:e.curDefinition)||null,{config:i}=this;return{url:(null==t?void 0:t.url)||"",bitrate:(null==t?void 0:t.bitrate)||i.defaultBitrate||-1,definition:(null==t?void 0:t.definition)||i.defaultDefinition,codecType:(null==t?void 0:t.codecType)||i.codecType||-1,duration:this.duration||0}}setUserAction(e){let t=tp(this.player);null==t||t.setUserAction(e)}changeResolution(e){var t,i,r,s;let n=(null==(t=this.resolutionInfo)?void 0:t.targetBitrateList)||[],a=(null==(i=this.curBitrate)?void 0:i.codecType)||Q.C.H264,{resolution:o}=e;if(!this.player||o===(null==(r=this.curBitrate)?void 0:r.resolution))return;X.a.updateConfig({userSelectResolution:e.resolution});let l=X.a.select(n,{codec:a,format:Q.V.MP4,resolution:e.resolution},"changeResolution");if((0,Z.l)(tv,"changeResolution",this.vid,o,n,l),l){this.curBitrate=l;let e=this.player,t=this.state===Q.b.ACTIVE,i=tg(l.url),r={...l,url:i};if(0>e.currentSrc.indexOf("blob:")||this.useSoftHevc){let i=e.currentTime;e.src=r.url,e.currentTime=i,e.config.url=r.url,t?e.play():e.pause()}else e.changeDefinition(r),t||e.pause();null!=(s=this.resolutionInfo)&&s.currentResolution&&(this.resolutionInfo.currentResolution=l.resolution||""),e.emit("resolutionReady",{...this.resolutionInfo})}}on(e,t,...i){var r;null==(r=this.player)||r.on(e,t,...i)}off(e,t){var i;null==(i=this.player)||i.off(e,t)}once(e,t){var i;null==(i=this.player)||i.once(e,t)}load(e){var t;let i=tg(e);null==(t=this.player)||t.playNext({url:i})}seek(e){this.player&&(this.player.currentTime=e)}play(){return(0,Z.l)(tv,this.uuid,"play"),new Promise(e=>{(!this.player||tr(this))&&e();let t=this.player.play();t||e(),t.then(()=>{e()}).catch(()=>{})})}pause(){return(0,Z.l)(tv,this.uuid,"pause"),this.player.config.autoplay=!1,this.player.pause()}startSoftHevcDegrade(e,t){var i,r;let s=null==(i=this.player)?void 0:i.paused;if((0,Z.l)(tv,"startSoftHevcDegrade",this.uuid,`useSoftHevc:${this.useSoftHevc} paused:${s}`,e),!this.useSoftHevc)return;let n=null==(r=this.player)?void 0:r.plugins.mp4encryptplayer;n&&n.startDegradedPlayback(e,s,t)}unBindPlayerEvents(e){e.off(J.AUTOPLAY_PREVENTED,this._onAutoplayPrevent),e.off(J.AUTOPLAY_STARTED,this._onAutoplayStart),e.off(J.LOADED_METADATA,this._onLoadedData),e.off(J.TIME_UPDATE,this._onTimeupdate),e.off(J.CANPLAY,this._onCanplay),e.off(eM.g8,this._onDegrade),e.off(J.EMPTIED,this._onEmptied),e.off("prf_data_size",this._onDownloaded)}bindPlayerEvents(e){e.on(J.AUTOPLAY_PREVENTED,this._onAutoplayPrevent),e.on(J.AUTOPLAY_STARTED,this._onAutoplayStart),e.on(J.LOADED_METADATA,this._onLoadedData),e.on(J.TIME_UPDATE,this._onTimeupdate),e.on(J.CANPLAY,this._onCanplay),e.on(eM.g8,this._onDegrade),e.on("prf_data_size",this._onDownloaded)}reset(){var e,t,i,r,s,n,a;this.forceAutoplay=!1,this.attemptPlayCount=0,this.bitrateList=[],this.curBitrate=null,this.resolutionInfo=null,null==(e=this.player)||e.pause(),this.vid&&X.i.removePlayingVid(this.vid),window.clearTimeout(this.timerId),this.timerId=void 0,(t=this.player)&&(t.reset(),null==(i=t._detachSourceEvents)||i.call(t,t.media),null==(s=null==(r=t.media)?void 0:r.removeAttribute)||s.call(r,"src"),null==(a=null==(n=t.media)?void 0:n.load)||a.call(n)),this.vid=null}release(){let e=this.player;if((0,Z.l)(tv,this.uuid,"release",this.state,`isPlaying: ${null==e?void 0:e.isPlaying}`),super.release(),this.changeState(Q.b.RELEASE),(0,Z.k)(this.element,"object-fit"),e){X.a.detachVideo(e.media),this.unBindPlayerEvents(e);let t=tp(e);null==t||t.reset(!1),this.unMountDom()}window.clearTimeout(this.timerId),this.timerId=void 0}destroy(){let e=this.player;(0,Z.l)(tv,this.uuid,"destroy",this.state,`isPlaying: ${null==e?void 0:e.isPlaying}`);let{vid:t}=this.config;X.i.removePlayingVid(t),super.release(),this.changeState(Q.b.DESTROY),e&&(X.a.detachVideo(e.media),this.unBindPlayerEvents(e),e.destroy(),this.unMountDom(),this.player=null),window.clearTimeout(this.timerId),this.timerId=void 0}replay(){return this.player.replay()}addSubtitle(e,t){let i=this.player;this.player&&i.plugins&&i.plugins.texttrack&&i.plugins.texttrack.updateSubtitles(e,e=>{t(e.text)})}getVideoDesc(){return this.player?{videoType:this.player.vtype}:super.getVideoDesc()}updatePreloadCodec(e){X.i.changeCodec(e)}updateConfig(e){this.player.setConfig({mp4encryptplayerConfig:{reqOptions:e}})}changeState(e){let t=this.state;if(this.state=e,!this.player)return;let i=this.player,{mp4encryptplayer:r}=i.plugins;e===Q.b.ACTIVE?(X.i.attachPlayer(i),r&&(r.isActive=!0)):r&&(r.isActive=!1),(0,Z.l)(tv,"changeState",this.uuid,e===Q.b.ACTIVE,e,i.isUserActive),i.emit("renderStateChange",{state:e,preState:t})}async enterFullscreen(e){await this.player.getFullscreen(e)}async exitFullscreen(e){await this.player.exitFullscreen(e)}changeVideo(e,t,i=!0){var r,s,n,o;let l=null==(r=null==e?void 0:e.extra)?void 0:r.vid,h=t||Q.b.ACTIVE,{autoplay:d=!1,muted:u=!1,volume:c=1,playbackRate:p=1}=e.video||{},f=l===this.vid&&!i,{startTime:m=0}=e.extra||{};if((0,Z.l)(tv,"changeVideo",this.uuid,`renderState:${t} needReset:${i} vid: ${null==(s=null==e?void 0:e.extra)?void 0:s.vid} sameVid:${this.vid===(null==(n=null==e?void 0:e.extra)?void 0:n.vid)}`,`isContinue:${f} startTime:${m} currentTime:${null==(o=this.player)?void 0:o.currentTime} mediaType: ${this.mediaType}`),this.player&&f){this.changeState(h),this.player.playbackRate=p,this.player.volume=c,this.player.muted=u,this.player.seek(m,d&&this.isActive?"play":"pause"),this.bindPlayerEvents(this.player),X.a.attachVideo(this.player.media,{bitrate:this.config.defaultBitrate,vid:this.config.vid}),X.i.addPlayingVid(l);let e=tp(this.player);e&&(e.reuseType=a.Tx.CONTINUE),this._emitResolutionReady()}else this.reset(),this.changeState(h),this._init(e||this.config)}isSoftHevc(){return!1}}class tA extends ei{constructor(){super(),((e,t,i)=>{let r;return(r="symbol"!=typeof t?t+"":t)in e?e1(e,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[r]=i})(this,"_proxyEvent",e=>"playCatch"==e?(t,i)=>{this.trigger(e,{vtype:t,error:i})}:"prf_data_size"==e?e=>{this.trigger("downloaderChunkReady",{chunkSize:e.cdn_size,speed:e.cdn_speed})}:"PRELOAD_INFO"==e?e=>{this.trigger("preloaderInfoReady",{size:e.byteLength||e.total,duration:e.duration,type:e.type||e.vtype,vid:e.vid})}:t=>{this.trigger(e,t)}),this.currentPlayer=null,this.rawEvents=["loadstart","loadeddata","loadedmetadata","durationchange","timeupdate","error","canplay","canplaythrough","volumechange","pause","playing","waiting","ended","seeking","seeked","stalled","abort","play","progress","downloaderError","downloaderChunkReady","memoryCompleted","playCatch","prf_data_size","PRELOAD_INFO","preloaderInfoReady","source_error","source_success","resolutionReady","exception","renderStateChange","hitcache","autoplay_was_prevented","autoplay_started"],this.extensionEvents=["autoplayPrevented","autoplayStart"],this._callbacks=[],this.events=this.rawEvents.concat(this.extensionEvents)}set player(e){this.remove(),this.currentPlayer=e,this.bind()}remove(){this.currentPlayer&&this._callbacks.forEach((e,t)=>{e()})}bind(){this.currentPlayer&&(this.rawEvents.forEach((e,t)=>{let i=this._proxyEvent(e);this.currentPlayer.bindEvent&&this.currentPlayer.bindEvent(e,i),this.currentPlayer.on&&this.currentPlayer.on(e,i),this._callbacks.push(()=>{this.currentPlayer.removeEvent&&this.currentPlayer.removeEvent(e,i),this.currentPlayer.off&&this.currentPlayer.off(e,i)})}),this.extensionEvents.forEach((e,t)=>{let i=this._proxyEvent(e);this.currentPlayer.proxyOn&&this.currentPlayer.proxyOn(e,i),this._callbacks.push(()=>{this.currentPlayer.proxyOff&&this.currentPlayer.proxyOff(e,i)})}))}release(){this.remove(),this.currentPlayer=null,this._events=[],this.rawEvents=[],this._callbacks=[]}}class tT{constructor(e,t){this.h264Bitrate=null,this.metrics=null,this.event=null,this.forceAutoplay=!1,this.attemptPlayCount=0,this.isPlaying=!1,this.hasStart=!1,this.vid=null,this.mediaType=null,this.format=Q.V.MP4,this.codec=Q.C.H264;let{playerType:i=Q.P.NEW_TT}=e;this.uuIndex=h.M.generateInstanceIndex(),this.uuid=h.M.generateUUID(i,this.uuIndex),this.playerType=i,this.el=null,this.player=null,this.state=t||Q.b.ACTIVE,this.bitrateList=[],this.audioBitrateList=[],this.curBitrate=null,this.curAudioBitrate=null,this.resolutionInfo=null,this.config=e}get type(){return this.playerType}style(e,t){this.element&&(this.element.style[e]=t)}createInnerContainer(){this.el||(this.el=document.createElement("div"))}initStyle(){this.element&&(this.element.style.width="100%",this.element.style.height="100%",this.element.style.position="absolute",this.element.style.top="0",this.element.style.left="0",this.element.style["::-webkit-media-controls-enclosure"]={display:"none !important"})}get element(){return null}set volume(e){this.player&&(this.player.volume=e)}get volume(){var e;return(null==(e=this.player)?void 0:e.volume)||0}get playbackRate(){var e;return(null==(e=this.player)?void 0:e.playbackRate)||1}set playbackRate(e){this.player&&(this.player.playbackRate=e)}set muted(e){this.player&&(this.player.muted=e)}get muted(){var e;return(null==(e=this.player)?void 0:e.muted)||!1}get currentTime(){var e;return(null==(e=this.player)?void 0:e.currentTime)||0}set currentTime(e){this.player&&(this.player.currentTime=e)}get duration(){var e;return(null==(e=this.player)?void 0:e.duration)||0}get buffered(){var e;return null==(e=this.player)?void 0:e.buffered}get paused(){var e;return(null==(e=this.player)?void 0:e.paused)||!0}get ended(){var e;return(null==(e=this.player)?void 0:e.ended)||!1}get readyState(){var e;return(null==(e=this.player)?void 0:e.readyState)||0}get networkState(){var e;return(null==(e=this.player)?void 0:e.networkState)||0}get attributes(){let{element:e}=this;return{error:(null==e?void 0:e.error)||null,src:(null==e?void 0:e.currentSrc)||"",currentTime:(null==e?void 0:e.currentTime)||0,muted:!!(null!=e&&e.muted),duration:(null==e?void 0:e.duration)||0,readyState:(null==e?void 0:e.readyState)||0,networkState:(null==e?void 0:e.networkState)||0,buffered:null==e?void 0:e.buffered,volume:(null==e?void 0:e.volume)||1,ended:!!(null!=e&&e.ended),paused:!!(null!=e&&e.paused),seeking:!!(null!=e&&e.seeking),currentSrc:(null==e?void 0:e.currentSrc)||""}}set objectFit(e){if(!e)return void(0,Z.k)(this.element,"object-fit");this.player&&(this.player.objectFit=e)}get crossOrigin(){var e;return null==(e=this.player)?void 0:e.crossOrigin}changeState(e){this.state=e}startPlay(){var e;null==(e=this.player)||e.play()}play(){return this.player?this.player.play():Promise.resolve()}replay(){return this.seek(0),this.play()}pause(){var e;return null==(e=this.player)?void 0:e.pause()}load(e){}seek(e){this.player&&(this.player.currentTime=e)}tryPlay(){this.paused&&this.play()}addSubtitle(e,t){}get playbackQuality(){var e,t;return this.element&&"VIDEO"===this.element.tagName&&(null==(t=(e=this.element).getVideoPlaybackQuality)?void 0:t.call(e))||null}getVideoPlaybackQuality(){return this.playbackQuality}mountDom(e){let{el:t}=this;if(!(!t||!e||t.parentNode===e))try{e.appendChild(t)}catch(e){console.error(e)}}unMountDom(){var e;let{el:t}=this;if(t)try{null==(e=null==t?void 0:t.parentElement)||e.removeChild(t)}catch(e){console.error(e)}}updatePreloadCodec(e){}get curDefinition(){var e,t,i,r,s;return{url:null==(e=this.curBitrate)?void 0:e.url,definition:null==(t=this.curBitrate)?void 0:t.definition,bitrate:null==(i=this.curBitrate)?void 0:i.bitrate,duration:null==(r=this.curBitrate)?void 0:r.duration,codecType:null==(s=this.curBitrate)?void 0:s.codecType}}async exitFullscreen(e){return te()}async enterFullscreen(e){return tt(e)}isSoftHevc(){return!1}on(e,t,...i){var r;null==(r=this.player)||r.on(e,t,...i)}off(e,t){var i;null==(i=this.player)||i.off(e,t)}once(e,t,...i){var r;null==(r=this.player)||r.once(e,t,...i)}emit(e,...t){var i;null==(i=this.player)||i.emit(e,...t)}}let tb="audio-equalizer";class tS{constructor(e){this.audioCtx=null,this.options=null,this.player=null,this.isEffective=!1,this._onEqualizerError=e=>{var t;(0,Z.l)(tb,"_onEqualizerError",e.code,e.message),null==(t=this.player)||t.emit("equalizer",{error:e})},this._onEqualizerSetup=()=>{var e;(0,Z.l)(tb,"_onEqualizerSetup"),!this.audioCtx&&this.player&&(this.audioCtx=(null==(e=this.getPlugin(this.player))?void 0:e.getAudioContext())||null)},this._onEqualizerGainValueChange=e=>{var t;(0,Z.l)(tb,"_onEqualizerGainValueChange",e),null==(t=this.player)||t.emit("strategy",{type:"equalizer",data:{...e}})},this.options=e||null}setPlayer(e){e!==this.player&&(this.player&&this.unBindEvents(this.player),this.player=e,e&&this.bindEvents(e))}getPlugin(e){return(null==e?void 0:e.getPlugin(tb))||null}getInitData(e){var t;if(!e)return null;this.options=e||null;let i=[];return null!=(t=this.options)&&t.enable&&(i.push(new e0),this.isEffective=!0),{plugins:i}}disable(){var e;null==(e=this.getPlugin(this.player))||e.disable()}enable(){var e;null==(e=this.getPlugin(this.player))||e.enable()}resume(){var e;null==(e=this.audioCtx)||e.resume().then(()=>{(0,Z.l)("resumeAudioCtx","audioCtx resume success")}).catch(e=>{(0,Z.l)("resumeAudioCtx","audioCtx resume error",e)})}update(e,t){let i=this.getPlugin(this.player);if((0,Z.l)(tb,"updateAudioEqualizer",i,`hasInstance:${!!i} loudness:${null==t?void 0:t.loudness} peak:${null==t?void 0:t.peak}`,e),!i)return;if(this.audioCtx||(this.audioCtx=i.getAudioContext()),!e||!e.enable||!e.targetLoudness){null==i||i.disable();return}let{loudness:r=0,peak:s=0}=t||{};if(r&&s){let t={loudness:r,peak:s,targetLufs:e.targetLoudness};i.setParams(t),i.enable()}else i.setParams(null)}release(){this.unBindEvents(this.player),this.player=null}bindEvents(e){let t=this.getPlugin(e);t&&(t.on("gainvaluechange",this._onEqualizerGainValueChange),t.once("setup",this._onEqualizerSetup),t.on("error",this._onEqualizerError))}unBindEvents(e){let t=this.getPlugin(e);t&&(t.off("gainvaluechange",this._onEqualizerGainValueChange),t.off("setup",this._onEqualizerSetup),t.off("error",this._onEqualizerError))}}let tE="[TTPlayer]";class tk extends tT{constructor(e,t){super(e),this.playerConfig={},this.player=null,this.vodCollector=null,this.downloadedSize=0,this.downloadedTime=0,this.loadStartTime=0,this.vid=null,this.preloadMeta=null,this.equalizer=null,this._startTime=-1,this.cacheHitType=Q.h.UNKNOWN,this.preloadTime=0,this._onDownloaded=e=>{var t;let{duration:i,byteLength:r,byteSpeed:s}=e;this.downloadedSize+=r,this.downloadedTime+=1e3*i;let n={speed:Math.round(8*s),size:r,duration:Math.round(1e3*i)};X.N.addSample(n,tE),(0,Z.l)("_onDownloaded",Math.round(1e3*i),r,Math.round(s),n,e),this.emit("prf_data_size",{mediaType:"video",cdn_size:r,pcdn_size:0,bitrate:(null==(t=this.curBitrate)?void 0:t.bitrate)||0})},this._onLoadedMetaData=()=>{var e;if(!this.player)return;let t=null==(e=e7(this.player,e2))?void 0:e.getMetadata();if(t){let e=function(e){let t=ts(e.tracks,"audio"),i=ts(e.tracks,"video");return{duration:e.duration/1e3,formatType:e.format,timescale:e.timescale,audioCodec:(null==t?void 0:t.codec)||"",videoCodec:(null==i?void 0:i.codec)||"",videoDuration:((null==i?void 0:i.duration)||0)/1e3,audioDuration:((null==t?void 0:t.duration)||0)/1e3,sampleRate:(null==t?void 0:t.sampleRate)||0}}(t);this.emit("metaReady",e)}this._startTime>0&&this.isActive&&(this.currentTime=this._startTime,this._startTime=-1)},this._onDowngrade=e=>{var t,i;let{message:r="",code:s=3}=e,n=null==(t=this.resolutionInfo)?void 0:t.codecType;return this.log("_onDowngrade",e.name,e.message,e.code,null==(i=this.player)?void 0:i.rawSrc,n,r.includes("unsupported")),"h265"===n&&r.includes("unsupported")?(this.retryUseH264Source(),this.updatePreloadCodec(Q.C.H264),h.a.focusDisableHevc({hevcMsg:r,hevcCode:s}),this.emit("downgrade",e),!1):(this.emit("downgrade",e),!0)},this._onCachehit=e=>{var t;this.cacheHitType===Q.h.UNKNOWN&&(this.cacheHitType=Q.h.DATA);let i=null!=(t=null==e?void 0:e.info)&&t.extra?(0,X.k)(e):ta(this.vid);i&&(i.hitType=this.cacheHitType||Q.h.DATA,i.duration=this.preloadTime,this.preloadMeta=i,this.emit("hitcache",i),this.log("_onCachehit",this.uuid,this.vid,(0,Z.n)(),this.cacheHitType,`cacheSize:${null==i?void 0:i.cacheSize} preloadSize:${null==i?void 0:i.preloadSize} duration:${null==i?void 0:i.duration}`,i,e))},this._onPreloadHit=e=>{var t;let{duration:i=0,byteSize:r=0}=(null==(t=null==e?void 0:e.getStats)?void 0:t.call(e))||{};this.cacheHitType=Q.h.MULTIPLEX,this.preloadTime=(0,Z.d)(i),this.log("_onPreloadHit",this.uuid,this.vid,(0,Z.n)(),this.cacheHitType,`preloadSize:${r} duration:${this.preloadTime}`,e)},this._onLoadedData=()=>{var e,t;if(!this.player)return;let{videoWidth:i,videoHeight:r}=this.player,s=(null==(e=this.curBitrate)?void 0:e.codecType)||"h264",n=(0,Z.m)((null==(t=this.element)?void 0:t.currentSrc)||"");this.log("_onLoadedData",`isMse:${n} codecType:${s} videoWidth:${i} videoHeight:${r}`),n||s!==Q.C.H265||0!==i||0!==r||(h.a.focusDisableHevc({hevcMsg:"width and height is 0",hevcCode:2}),this.updatePreloadCodec("h264"),this.retryUseH264Source())},this._onLoadStart=()=>{this.log("_onLoadStart",this.uuid,(0,Z.n)(),this.vid),0===this.loadStartTime&&(this.loadStartTime=(0,Z.n)())},this._onError=e=>{var t,i;let r=(0,Z.n)()-this.loadStartTime;(0,Z.l)("_onError",`costTime: ${r}`,`rawSrc:${!!(null!=(t=this.player)&&t.rawSrc)} currentSrc:${null==(i=this.player)?void 0:i.currentSrc}`,e)},this._onException1=e=>{var t,i,r;let s=(0,Z.n)()-this.loadStartTime;(0,Z.l)("_onException1",`costTime: ${s}`,`rawSrc:${!!(null!=(t=this.player)&&t.rawSrc)} currentSrc:${!!(null!=(i=this.player)&&i.currentSrc)}`,null==(r=e.extra)?void 0:r.url)},this._onException=e=>{var t,i,r;let s=(0,Z.n)()-this.loadStartTime;(0,Z.l)("_onException",`costTime: ${s}`,`rawSrc:${!!(null!=(t=this.player)&&t.rawSrc)} currentSrc:${!!(null!=(i=this.player)&&i.currentSrc)}`,null==(r=e.extra)?void 0:r.url),this.emit("exception",e)},this._onCanplay=()=>{if(this.state!==Q.b.ACTIVE&&this.player){let e=this.player;null==e||e.pause()}},this._onceCanplay=()=>{var e,t;this.log("_onceCanplay",`forceAutoplay:${this.forceAutoplay} isActive:${this.isActive} paused:${null==(e=this.player)?void 0:e.paused}`),this.player&&this.forceAutoplay&&this.isActive&&this.player.paused&&this.startPlay(),null==(t=this.player)||t.off(J.CANPLAY,this._onceCanplay)},this._onTimeupdate=()=>{var e;this.state!==Q.b.ACTIVE&&(null==(e=this.player)||e.pause())},this._emitAutoplayPrevent=()=>{(0,Z.l)(tE,this.uuid,"_emitAutoplayPrevent"),this.emit(Q.e)},this._emitAutoplayStart=()=>{(0,Z.l)(tE,this.uuid,"_emitAutoplayStart"),this.emit(Q.A)},this.playerType=Q.P.NEW_TT;let i=t||Q.b.ACTIVE;this.equalizer=new tS,this._init(e),this.changeState(i)}get element(){var e;return(null==(e=this.player)?void 0:e.getElement())||null}get isActive(){return this.state===Q.b.ACTIVE}log(e,...t){(0,Z.l)(tE,this.uuid,e,...t)}changeState(e){var t,i;let r=this.state;if(this.state=e,!this.player)return;let s=this._startTime;e===Q.b.ACTIVE?(this.log("setPreloader",this.uuid,this.state,this.playerType),null==(t=e7(this.player,e2))||t.setPreloader(X.i.getCore(this.playerType)),this._startTime>0&&(this.player.currentTime=this._startTime,this._startTime=-1)):null==(i=e7(this.player,e2))||i.setPreloader(null),(0,Z.l)(tE,"changeState",this.uuid,e===Q.b.ACTIVE,e,`startTime:${s}`),this.emit("renderStateChange",{state:e,preState:r})}getPlugin(e){var t,i;return null==(i=null==(t=this.player)?void 0:t.getPlugin(e))?void 0:i.core}getMultiplexPluginConfig(e,t){let{getRequestOptionsCallback:i,reqOptions:r}=e,{multiplexConfig:s,videoPlayMode:n,mp4ParserConfig:a={},dashParserConfig:l={},loaderOptions:h={},parserOptions:d={}}=t,{mp4:u={},dash:c={}}=d;return{minBackwardBufferDuration:5,maxBackwardBufferDuration:60,minForwardBufferDuration:15,maxForwardBufferDuration:30,eosFallback:!1,fallback:"MSE"!==n,...s,loaderOptions:{onBeforeRequest:(e,t)=>{if(i){let r=i({url:e});r&&(t.credentials=r.credentials)}else r&&(t.credentials=r.credentials);return t},timeout:3e3,...null==s?void 0:s.loaderOptions,...h},parsers:[new o.ln({...a,...u}),new o.WT({...l,...c})]}}getLoggerConfig(e,t,i){var r,s,n,a;let{videoInfo:l,strategyConfig:u={},loggerParams:c,switchPlayerTime:p}=e,{bitrateAdapter:f,audioEqualizer:m}=u,g=this.curBitrate,{ext:_={}}=c||{},v=h.a.getHevcDisableInfo()||{},y=e4(),A={app_id:c.lineAppId,line_app_id:c.lineAppId,...y,codec_type:t,decodeFlag:"h265"===t,defaultBitrate:(null==g?void 0:g.bitrate)||l.bitrate||0,defaultDefinition:(null==g?void 0:g.definition)||l.definition||0,vid:l.id||l.vid,vtype:i||"MP4",fIndex:this.uuIndex,switchPlayerTime:p,...c,playerCoreVersion:o.rE,pv:eB.rE,strategyVersion:d.v,ext:{..._,...v,preload_codec:null==(r=this.preloadMeta)?void 0:r.codecType,preload_def:null==(s=this.preloadMeta)?void 0:s.definition,loader_type:(0,o._s)()},bitrateAdapter:{userResolution:(null==f?void 0:f.userSelectResolution)||"auto",qualityType:(null==g?void 0:g.qualityType)||0,selector:(null==f?void 0:f.selector)||"default"},strategy:{equalizer:m},closeEvents:(null==c?void 0:c.closeEvents)||[],playerType:this.playerType,videoInfo:{volumeInfo:{loudness:(null==(n=null==l?void 0:l.volumeInfo)?void 0:n.loudness)||0,peak:(null==(a=null==l?void 0:l.volumeInfo)?void 0:a.peak)||0}},userAction:(null==c?void 0:c.userAction)||null};return{tea:{init:c.channelConfig,config:{region:c.region,user_unique_id:c.webId,user_is_login:c.isLogin}},config:A,type:"vod"}}_init(e){var t,i,r,s,n,a,l;this.hasStart=!1,this.downloadedSize=0;let{videoInfo:h,playerConfig:d,strategyConfig:u={}}=e;this.createInnerContainer(),this._initPreloader(u),this._initAdapter(u);let c=(null==d?void 0:d.codecType)||Q.C.H264,p=(null==d?void 0:d.format)||Q.V.MP4,f=(null==h?void 0:h.vid)||"";this.bitrateList=(null==h?void 0:h.bitrateList)||[],this.audioBitrateList=(null==h?void 0:h.audioBitrateList)||[],this.vid=f,this.mediaType=Q.M.VIDEO,this.preloadMeta=ta(f);let{playSelector:m}=u,g=to(this.bitrateList,c,p,this.preloadMeta,f,m),{curBitrate:_=null,h264Bitrate:v=null,resolutionList:y}=g||{};this.curBitrate=_||tn(h);let A=(null==(t=this.curBitrate)?void 0:t.codecType)||c,T=(null==(i=this.curBitrate)?void 0:i.format)||p;this.codec=A,this.format=T,this.h264Bitrate=v||tn(h),this.curAudioBitrate=(0,X.l)(this.audioBitrateList),this.resolutionInfo={currentResolution:(null==_?void 0:_.resolution)||"",codecType:A,vtype:T,resolutionList:y||[],bitrateList:this.bitrateList||[],targetBitrateList:(null==g?void 0:g.targetBitrateList)||[]},X.i.addPlayingVid(f,this.playerType);let b=(0,X.m)(f,this.curBitrate,this.curAudioBitrate,this.h264Bitrate),S=!!(null!=g&&g.preloadDefinition),E=(l=u.videoPlayMode||Q.d.H5,!(!(0,Z.e)()||(0,Z.h)())&&(l===Q.d.MSE||l===Q.d.AUTO)),{maxCacheCount:k=0}=e.strategyConfig;k>0&&o.t8.setConfig({maxCount:k});let{preloadDefinition:P=null,preloadCodec:w=null,preloadFormat:x=null}=g||{};this.log("getInitBitrate",this.uuid,f,E,`hasPreload:${S} preload: ${P}_${w}_${x} curBitrate: ${null==(r=this.curBitrate)?void 0:r.definition} initCodec:${c} initFormat:${p} codecType:${A} format:${T}`,b,this.h264Bitrate,this.resolutionInfo),(0,Z.l)(tE,this.uuid,"PlayerInit",!this.player,`autoplay:${d.autoplay} startTime:${d.startTime}`,this.config),this.log("initPlayer",this.uuid,f,E,e),this.player=this._initTTPlayer(e);let{audioEqualizer:C}=u;null==(s=this.equalizer)||s.setPlayer(this.player),null==(n=this.equalizer)||n.update(C,h.volumeInfo),this._initLogger(e,A),this.initStyle(),this.bindPlayerEvents(this.player),this.load(b);let{startTime:L=-1}=d;if(this._startTime=L,d.autoplay&&this.isActive){this.forceAutoplay=!0;let{readyState:e,duration:t}=this.player;e&&t>0?this.startPlay():this.player.on(J.CANPLAY,this._onceCanplay)}X.a.attachVideo(this.element,{bitrate:(null==(a=this.curBitrate)?void 0:a.bitrate)||0,vid:f}),this._emitResolutionReady()}_initTTPlayer(e){var t,i,r;let{playerConfig:s,strategyConfig:n}=e,{player:a}=this,l={container:this.el,src:"",muted:s.muted||!1,autoplay:!1,preload:s.preload?s.preload:"",volume:s.volume||1,playbackRate:s.playbackRate||1};if(a)a.volume=l.volume||1,a.muted=l.muted||!1,a.playbackRate=l.playbackRate||1,null!=(i=this.equalizer)&&i.isEffective&&s.crossOrigin?a.crossOrigin=s.crossOrigin:null==(r=this.equalizer)||r.disable();else{let e=this.getMultiplexPluginConfig(s,n),i=[new o.cD(e)],r=null==(t=this.equalizer)?void 0:t.getInitData(n.audioEqualizer);r&&s.crossOrigin&&(i.push(...r.plugins),l.crossOrigin=s.crossOrigin),l.plugins=i,(a=new eB.yC(l)).uuid=this.uuid}return a}_emitResolutionReady(){this.timerId&&(window.clearTimeout(this.timerId),this.timerId=void 0),this.timerId=setTimeout(()=>{this.emit("resolutionReady",{...this.resolutionInfo}),this.log("PRELOAD_INFO",this.preloadMeta),this.preloadMeta&&this.emit("PRELOAD_INFO",this.preloadMeta)},0)}bindPlayerEvents(e){let t=e7(e,e2);t&&(t.on("preloadhit",this._onPreloadHit),t.on("cachehit",this._onCachehit),t.on("downgrade",this._onDowngrade),t.on("downloaded",this._onDownloaded),t.on("exception",this._onException),this.state===Q.b.ACTIVE&&t.setPreloader(X.i.getCore(this.playerType))),e.on(J.LOADED_METADATA,this._onLoadedMetaData),e.on(J.TIME_UPDATE,this._onTimeupdate),e.on(J.LOADED_DATA,this._onLoadedData),e.on(J.LOAD_START,this._onLoadStart),e.on(J.CANPLAY,this._onCanplay),e.on(J.ERROR,this._onError),e.on("exception",this._onException1)}unBindPlayerEvents(e){let t=e7(e,e2);t&&(t.off("preloadhit",this._onPreloadHit),t.off("cachehit",this._onCachehit),t.off("downgrade",this._onDowngrade),t.off("downloaded",this._onDownloaded),t.off("exception",this._onException)),e.off(J.LOADED_METADATA,this._onLoadedMetaData),e.off(J.TIME_UPDATE,this._onTimeupdate),e.off(J.LOADED_DATA,this._onLoadedData),e.off(J.LOAD_START,this._onLoadStart),e.off(J.CANPLAY,this._onCanplay),e.off(J.CANPLAY,this._onceCanplay),e.off(J.ERROR,this._onError),e.off("exception",this._onException1)}retryUseH264Source(e){var t,i;if(this==null||this.emit("playCatch","MP4_3",{errorCode:(null==e?void 0:e.code)||8200,message:(null==e?void 0:e.message)||"width and height is 0"}),this.log("retryUseH264Source",this.h264Bitrate),null!=(t=this.h264Bitrate)&&t.url){let{vid:e=""}=this.config.videoInfo,t=(0,X.m)(e,this.h264Bitrate);this.load(t),this.isActive&&this.startPlay();let{codecType:r,url:s,bitrate:n,definition:a}=this.h264Bitrate;null==(i=this.vodCollector)||i.update({codec_type:r,url:s,defaultBitrate:n,defaultDefinition:a})}}startPlay(){var e;if(this.log("startPlay",this.state,`isPlaying:${this.isPlaying} currentSrc:${null==(e=this.player)?void 0:e.currentSrc}`),!this.player)return Promise.resolve();let t=this.player.play();return this.startPlayTimerId&&(window.clearTimeout(this.startPlayTimerId),this.startPlayTimerId=void 0),t&&t.then&&t.then(e=>{var t;if(this.player)if(e){if(this.log("startPlay error",`attemptPlayCount:${this.attemptPlayCount} isPlaying:${this.isPlaying} muted:${this.player.muted}`,null==e?void 0:e.name,null==e?void 0:e.message,`currentSrc:${!!(null!=(t=this.player)&&t.currentSrc)}`),!this.player||"NotAllowedError"!==e.name&&"AbortError"!==e.name||!this.forceAutoplay){this.isPlaying=!1,this._emitAutoplayPrevent();return}this.attemptPlayCount<3?(this.player.muted=!0,this.attemptPlayCount++,this.startPlayTimerId=setTimeout(()=>{if(!this.player)return this.player;this.player.muted=!0,this.startPlay()},0)):(this._emitAutoplayPrevent(),this.isPlaying=!1)}else this.log("startPlay success"),this.isPlaying=!0,this._emitAutoplayStart()}).catch(e=>{var t;this.log("startPlay catch",`attemptPlayCount:${this.attemptPlayCount} isPlaying:${this.isPlaying} muted:${this.muted}`,`currentSrc:${!!(null!=(t=this.player)&&t.currentSrc)}`)}),t}play(){var e;if(this.log("call play",this.state,`paused:${this.paused} isPlaying:${this.isPlaying}`),!this.player||tr(this))return Promise.resolve();this.forceAutoplay=!0;let t=this.isPlaying?this.player.play():this.startPlay();return null==(e=this.equalizer)||e.resume(),t}pause(){var e,t;this.log("call pause",this.state,`attemptPlayCount:${this.attemptPlayCount} paused:${this.paused} isPlaying:${this.isPlaying}`),this.forceAutoplay=!1;let i=null==(e=this.player)?void 0:e.pause();return null==(t=this.equalizer)||t.resume(),i}supportMSE(){return!!e7(this.player,e2)}_initAdapter(e){if(!e)return;let{bitrateAdapter:t={},hevcDisableResolution:i=[]}=e,{dScore:r}=h.M.getDeviceScore();t.disableResolutions={hevc:(0,X.g)(i,r),h264:[]},X.a.updateConfig(t)}_initPreloader(e){if(!e)return;a.DS.attachPreloader(X.i.ttPreloader);let{enablePreloader:t=!0,preloaderConfig:i,multiplexConfig:r}=e,s={...i,loaderOptions:null==r?void 0:r.loaderOptions};i&&X.i.update(s,this.playerType),(0,Z.l)(tE,"_initPreloader",s,e,t,i),t?X.i.enable():X.i.disable()}_initLogger(e,t){a.DS.AB_SDK_VERSION=e8();let{loggerParams:i}=e;this.log("initLogger loggerParams",i),a.K.init(ev.Collector,i.channelConfig,{region:i.region,user_unique_id:i.webId,user_is_login:i.isLogin,user_id:i.uid||i.webId});let r=this.getLoggerConfig(e,this.codec,this.format).config;this.vodCollector?this.vodCollector.update(r,a.Tx.RELOAD):this.vodCollector=new a.DS(r),this.vodCollector.attachPlayer(this.player)}load(e){if(!this.player||!e)return void console.warn("load warn","url is null || this.player is null");(0,Z.l)(tE,this.vid,"loadPlayerSource",e),this.player.src=e}updatePreloadCodec(e){this.log("updatePreloadCodec",e),X.i.changeCodec(e,this.playerType)}setUserAction(e){var t;null==(t=this.vodCollector)||t.setUserAction(e)}changeResolution(e){var t,i;let r=this.bitrateList,s=(null==(t=this.curBitrate)?void 0:t.codecType)||Q.C.H264,{resolution:n}=e;if(n===(null==(i=this.curBitrate)?void 0:i.resolution))return;let a=X.a.select(r,{codec:s,format:Q.V.MP4,resolution:e.resolution},"changeResolution");(0,Z.l)(tE,this.uuid,`changeResolution:${n}`,a),a&&(this.curBitrate=a)}reset(){var e;window.clearTimeout(this.timerId),window.clearTimeout(this.startPlayTimerId),this.timerId=void 0,this.startPlayTimerId=void 0,this._startTime=-1,this.vid&&X.i.removePlayingVid(this.vid,this.playerType),this.curBitrate=null,this.bitrateList=[],this.audioBitrateList=[],this.curBitrate=null,this.curAudioBitrate=null,this.resolutionInfo=null,this.downloadedSize=0,this.downloadedTime=0,this.loadStartTime=0,this.preloadMeta=null,this.preloadTime=0,this.cacheHitType=Q.h.UNKNOWN,null==(e=this.player)||e.reset(),this.vid=null,this.format=Q.V.MP4,this.codec=Q.C.H264}release(){var e,t,i;null==(e=this.player)||e.pause(),this.forceAutoplay=!1,this.attemptPlayCount=0,this.log("release",this.state,`isPlaying: ${this.isPlaying}`,this.vid,X.i.playingVids),(0,Z.k)(this.element,"object-fit"),X.a.detachVideo(this.element),null==(t=this.equalizer)||t.release(),this.changeState(Q.b.RELEASE),this.unMountDom(),this.player&&this.unBindPlayerEvents(this.player),null==(i=this.vodCollector)||i.reset(!1),window.clearTimeout(this.timerId),this.timerId=void 0;let r=e7(this.player,e2);null==r||r.suspend()}destroy(){var e,t,i,r;this.log("destroy",this.state,`isPlaying: ${this.isPlaying}`),null==(e=this.player)||e.pause();let s=this.config.videoInfo.vid;s&&X.i.removePlayingVid(s,this.playerType),X.a.detachVideo(this.element),null==(t=this.equalizer)||t.release(),this.player&&this.unBindPlayerEvents(this.player),this.changeState(Q.b.DESTROY),this.emit("destroy"),this.unMountDom(),null==(i=this.player)||i.destroy(),null==(r=this.vodCollector)||r.destroy(),this.player=null,this.vodCollector=null,window.clearTimeout(this.timerId),this.timerId=void 0}changeVideo(e,t,i=!0){var r,s,n;let o=null==(r=null==e?void 0:e.videoInfo)?void 0:r.vid,l=t||Q.b.ACTIVE,h=o===this.vid&&!i,{startTime:d=-1,playbackRate:u=1,volume:c=1,muted:p=!1,autoplay:f=!1}=e.playerConfig||this.config;if(this.log("changeVideo",`renderState:${t} needReset:${i} vid:${o} sameVid:${this.vid===o}`,`isContinue:${h} startTime:${d} currentTime:${null==(s=this.player)?void 0:s.currentTime}`),this.player&&h){let t=e7(this.player,e2);if(null==t||t.resume(),this.changeState(l),this.player.playbackRate=u,this.player.volume=c,this.player.muted=p,this.player.currentTime=d,this.isActive&&f){this.forceAutoplay=!0;let{readyState:e,duration:t}=this.player;this.player.play(),(e<2||t>0)&&this.player.on(J.CANPLAY,this._onceCanplay)}else this.player.pause();this.bindPlayerEvents(this.player),X.a.attachVideo(this.element,{bitrate:(null==(n=this.curBitrate)?void 0:n.bitrate)||0,vid:this.vid}),this._initLogger(e,this.codec),this._initAdapter(e.strategyConfig),this._initPreloader(e.strategyConfig),X.i.addPlayingVid(o);let i=this.vodCollector;i&&(i.reuseType=a.Tx.CONTINUE),this._emitResolutionReady(),this.preloadMeta&&this.emit("hitcache",this.preloadMeta)}else if(this.reset(),this.changeState(l),e&&(this.config=e),this._init(e||this.config),o===this.vid){let e=e7(this.player,e2);null==e||e.resume()}}on(e,t,...i){var r;null==(r=this.player)||r.on(e,t,...i)}off(e,t){var i;null==(i=this.player)||i.off(e,t)}once(e,t){var i;null==(i=this.player)||i.once(e,t)}emit(e,...t){var i;null==(i=this.player)||i.emit(e,...t)}}class tP{constructor(){this._eventemitter=new u}on(e,t,...i){this._eventemitter.on(e,t,...i)}once(e,t,...i){this._eventemitter.once(e,t,...i)}off(e,t,...i){this._eventemitter.off(e,t,...i)}emit(e,t,...i){this._eventemitter.emit(e,t,...i)}offAll(){this._eventemitter.removeAllListeners()}clear(){this._eventemitter.removeAllListeners()}}class tw extends tP{constructor(e){super(),this.playerType=Q.P.XG}setCustomTracker(e){a.DS.setCustomTracker(e)}setPlayerType(e){this.playerType=e}get device(){return l.A.device}get version(){return d.v}}function tx(e,t){return e&&e.playerType===t}let tC="[PlayerQueue]";class tL{constructor(e){this._maxCount=3,this._queue=[],this._resetDelay=1e4,this.stats={totalCount:0,playCount:0,releaseCount:0,activeCount:0,backupCount:0,unMutedCount:0},this.onInstancePlay=e=>{this.stats.playCount++,(0,Z.l)(tC,"onInstancePlay",this.stats.playCount)},this.onInstancePause=e=>{this.stats.playCount--,(0,Z.l)(tC,"onInstancePause",this.stats.playCount)},this.onInstanceVolumeChange=e=>{if(!e||!e.target)return;let t=e.target;t.muted?this.stats.unMutedCount--:this.stats.unMutedCount++,(0,Z.l)(tC,"onInstanceVolumeChange",t.muted,t.volume,this.stats.unMutedCount)},null!=e&&e.maxCount&&(this._maxCount=e.maxCount)}set maxCount(e){e>=0&&(this._maxCount=e)}set resetDelay(e){this._resetDelay=e}add(e){this._queue.push(e),this.bindEvents(e);let t=this._queue.length;if(this._queue.length>this._maxCount){let e=-1,i=-1;for(let r=0;r<t;r++){let t=this._queue[r];if(t.state===Q.b.RELEASE){e=r;break}t.state===Q.b.RETAIN&&(i=r)}let r=e>-1?e:i,s=this.removeByIndex(r);(0,Z.l)(tC,"removePlayer",null==s?void 0:s.uuid),null==s||s.destroy()}}bindEvents(e){if(!e||!e.element)return;let{muted:t,paused:i}=e.element;t||this.stats.unMutedCount++,(0,Z.l)(tC,"bindEvents",`state: ${e.state} muted:${t} paused:${i}`,this.stats),e.element.addEventListener("play",this.onInstancePlay),e.element.addEventListener("pause",this.onInstancePause),e.element.addEventListener("volumechange",this.onInstanceVolumeChange)}unbindEvents(e){if(!e||!e.element)return;let{muted:t,paused:i}=e.element;(0,Z.l)(tC,"unbindEvents",`state: ${e.state} muted:${t} paused:${i}`,this.stats),t||this.stats.unMutedCount--,i&&this.stats.playCount--,e.element.removeEventListener("play",this.onInstancePlay),e.element.removeEventListener("pause",this.onInstancePause),e.element.removeEventListener("volumechange",this.onInstanceVolumeChange)}remove(e){let t=this.getIndex(e);return this.removeByIndex(t)}removeByIndex(e){if(e>=0&&e<this._queue.length){let t=this._queue.splice(e,1);if(t.length>0)return this.unbindEvents(t[0]),t[0]}return null}get length(){return this._queue.length}get(e,t,i){let r=this._queue.length,s=null;(0,Z.l)(tC,"get",e,t,i,this.length,this.getAllIdWithState());for(let n=r-1;n>=0;n--){let r=this._queue[n];if(r.state===Q.b.RELEASE&&tx(r,e)&&(!r.mediaType||r.mediaType===t))if(s=r,i){if(r.vid===i){s=this._queue[n];break}}else break}return s}getByState(e,t){let i=this._queue.length;for(let r=i-1;r>=0;r--)if(tx(this._queue[r],e)&&this._queue[r].state===t)return this._queue[r];return null}getIndex(e){if(!e)return -1;for(let t=0;t<this._queue.length;t++)if(this._queue[t].uuid===e.uuid)return t;return -1}getByIndex(e){return e>0&&e<this._queue.length?this._queue[e]:null}getById(e){for(let t=0;t<this._queue.length;t++)if(this._queue[t].uuid===e)return t;return -1}getAll(e){return e?this._queue.filter(t=>tx(t,e)&&t.state!==Q.b.RELEASE&&t.state!==Q.b.DESTROY):this._queue.filter(e=>e.state!==Q.b.RELEASE&&e.state!==Q.b.DESTROY)}getAllWithState(e,t){return this._queue.filter(i=>tx(i,e)&&i.state===t)}getAllId(){return this._queue.map(e=>e.uuid)}getAllIdWithState(){return this._queue.map(e=>`${e.uuid}_${e.state}_${e.mediaType}`)}getStats(){let e=0,t=0,i=0;return this._queue.forEach(r=>{r.state===Q.b.RELEASE?t++:r.state===Q.b.BACKUP||r.state===Q.b.RETAIN?e++:r.state===Q.b.ACTIVE&&i++}),{...this.stats,totalCount:this.length,releaseCount:t,activeCount:i,backupCount:e,unMutedCount:0}}removeAll(){this._queue.forEach(e=>{this.unbindEvents(e),null==e||e.destroy()}),this._queue=[]}removeByState(e,t){let i=[];this._queue.forEach((r,s)=>{r.state===e&&(!t||tx(r,t))&&i.push(s)}),i.forEach(e=>{let t=this.removeByIndex(e);t&&t.destroy()}),(0,Z.l)(tC,"removeByState",t,i.join("|"))}setResetTimer(e){(0,Z.l)(tC,"setResetTimer",e,this.length,this._resetDelay),this.timerId&&(window.clearTimeout(this.timerId),this.timerId=void 0),this._resetDelay<=0||(this.timerId=window.setTimeout(()=>{let e=[];this._queue.forEach(t=>{t.state===Q.b.RELEASE&&(e.push(t.uuid),t.reset())}),window.clearTimeout(this.timerId),this.timerId=void 0,(0,Z.l)(tC,"resetInstance",e.join("|"))},this._resetDelay))}}let tD=null;function tI(e){return tD||(tD=new tL),null!=e&&e.maxCount&&(tD.maxCount=null==e?void 0:e.maxCount),null!=e&&e.resetDelay&&(tD.resetDelay=null==e?void 0:e.resetDelay),tD}let tR="[MultiplePlayerPool1]";class tO extends tw{constructor(e){super(e),this.playerType=Q.P.NEW_TT,this.queue=tI(),this.currentMuted=!1,this.currentVolume=1,this.onHevcDetect=e=>{if(e){let{open:e}=h.M.checkHevcResult();e&&this.updatePreloadCodec(Q.C.H265)}},this._onAutoplayPrevent=()=>{var e;(0,Z.l)(tR,null==(e=this.currentPlayer)?void 0:e.uuid,"_onAutoplayPrevent"),this.autoplayPrevent=!0},this._onAutoplayStart=()=>{var e,t,i,r,s;(0,Z.l)(tR,null==(e=this.currentPlayer)?void 0:e.uuid,"_onAutoplayStart",null==(t=this.currentPlayer)?void 0:t.muted,null==(r=null==(i=this.currentPlayer)?void 0:i.element)?void 0:r.paused,null==(s=this.currentPlayer)?void 0:s.currentTime,new Date().getTime()),this.autoplayPrevent=!1},this._onActiveLoadedData=()=>{let{currentPlayer:e,currentProps:t}=this;e&&ti(this.currentPlayer)&&(t.muted=e.muted,t.volume=e.volume,this.checkLoadBackUpInstance("onActiveLoadedData"))},this._onActiveProgress=()=>{this.checkLoadBackUpInstance("onActiveProgress")},this._onVolumechange=()=>{var e;if(!this.currentPlayer||!ti(this.currentPlayer))return;let{currentPlayer:t,currentProps:i}=this;(0,Z.l)(tR,null==(e=this.currentPlayer)?void 0:e.uuid,"_onVolumechange",t.muted,t.volume),i.muted=t.muted,i.volume=t.volume},this._onRatechange=()=>{var e;if((0,Z.l)(tR,null==(e=this.currentPlayer)?void 0:e.uuid,"_onRatechange"),!this.currentPlayer)return;let{currentPlayer:t,currentProps:i}=this;i.playbackRate=t.playbackRate},this._onPlayCatch=(e,t)=>{var i;if((0,Z.l)(tR,null==(i=this.currentPlayer)?void 0:i.uuid,"_onPlayCatch",e,t),!t)return;let{message:r="",errorCode:s,errorMessage:n=""}=t;(r||n).includes("is unsupported")&&h.a.focusDisableHevc({hevcCode:s||1,hevcMsg:r})},this._onceCanplay=()=>{var e,t;let i=null==(e=this.currentPlayer)?void 0:e.buffered;(0,Z.l)(tR,null==(t=this.currentPlayer)?void 0:t.uuid,"_onceCanplay",e5(i));let{isTTP:r}=h.M;null!==r&&h.b.asyncMark(r||!1)},this.currentPlayer=null,this.currentProps={playbackRate:1,muted:!1,volume:1},this.autoplayPrevent=!1,this.config={enableReuse:!1,needReset:!0,maxCount:3,enableMultiple:!1,defaultMSE:!1,minBuffer:100,needReuseCheck:!1,...e},this.queue.maxCount=this.config.maxCount,h.a.setDetectCallback(this.onHevcDetect),a.DS.setPlayerPool(this.playerType,this.queue)}setPlayerType(e){this.playerType=e}setCustomTracker(e){a.DS.setCustomTracker(e)}get device(){return l.A.device}get version(){return d.v}checkLoadBackUpInstance(e){var t;(function(e,t){let{minBuffer:i}=t;if(!e||!i)return!0;if(e&&e.length>0){let t=e.end(e.length-1);if((0,Z.d)(t)>=i)return!0}return!1})(null==(t=this.currentPlayer)?void 0:t.buffered,{minBuffer:this.config.minBuffer})&&this.queue.getByState(this.playerType,Q.b.BACKUP)}_bindEvents(e){(0,Z.l)(tR,"_bindEvents",e.uuid)}_unbindEvents(e){(0,Z.l)(tR,"_unbindEvents",e.uuid)}_bindActiveEvents(e){e.on(J.LOADED_DATA,this._onActiveLoadedData),e.on(J.PROGRESS,this._onActiveProgress),e.on(J.RATE_CHANGE,this._onRatechange),e.on(J.VOLUME_CHANGE,this._onVolumechange),e.once(J.CANPLAY,this._onceCanplay),e.on(J.AUTOPLAY_PREVENTED,this._onAutoplayPrevent),e.on(J.AUTOPLAY_STARTED,this._onAutoplayStart),e.on("playCatch",this._onPlayCatch)}_unbindActiveEvents(e){e.off(J.LOADED_DATA,this._onActiveLoadedData),e.off(J.PROGRESS,this._onActiveProgress),e.off(J.RATE_CHANGE,this._onRatechange),e.off(J.VOLUME_CHANGE,this._onVolumechange),e.off(J.CANPLAY,this._onceCanplay),e.off(J.AUTOPLAY_PREVENTED,this._onAutoplayPrevent),e.off(J.AUTOPLAY_STARTED,this._onAutoplayStart),e.off("playCatch",this._onPlayCatch)}_activePlayer(e){var t;let{state:i}=e;i!==Q.b.ACTIVE&&this._bindActiveEvents(e),this.currentPlayer=e;let{currentProps:r}=this,s=e9(e);(0,Z.l)(tR,e.uuid,"_activePlayer",e.uuid,`hasStart:${e.hasStart} preState:${i}`,s,r),e.muted=r.muted,e.volume=r.volume,e.forceAutoplay=!0,null==(t=e.metrics)||t.setStartInitInfo(s),e.changeState(Q.b.ACTIVE),e.hasStart?e.play():e.startPlay()}_retainPlayer(e){var t;(0,Z.l)(tR,e.uuid,"_retainPlayer");let{state:i}=e;i===Q.b.ACTIVE&&(this._unbindActiveEvents(e),null==(t=e.metrics)||t.stop()),e.changeState(Q.b.RETAIN),e.forceAutoplay=!1,e.pause(),e.seek(0),e.muted=!0}checkInstanceCanReuse(e,t){if(!e)return!1;if(!this.config.needReuseCheck)return!0;let i=e.crossOrigin,r=t.playerConfig.crossOrigin;return!(!i||i&&!r)}getInstance(e,t){var i;let r=e.videoInfo.vid,s=this.queue.get(this.playerType,Q.M.VIDEO,r),n=e;t!==Q.b.ACTIVE&&(n=function(e,t,i){let{playerConfig:r,strategyConfig:s}=e;return r.autoplay=!1,t.defaultMSE&&(s.videoPlayMode=Q.d.MSE),e}(e,this.config,null==(i=this.currentPlayer)||i.buffered));let a=this.checkInstanceCanReuse(s,n);if(s&&(0,Z.l)(tR,"getInstance reuse",null==s?void 0:s.uuid,`sameVid: ${r===s.vid} canReuse:${a}`,t,e),s&&a){let{needReset:e}=this.config;s.changeVideo(n,t,e)}else s=new tk(n,t),this.queue.add(s);this._bindEvents(s);let o=new tA,l=s.config,h=new e_(o,{bitrate:l.defaultBitrate,definition:l.defaultDefinition,codecType:l.codecType});return t!==Q.b.ACTIVE&&(s.muted=!0),s.metrics=h,s.event=o,o.player=s,h.player=s,(0,Z.l)(tR,"getInstance new","preloadPlayingIds",X.i.getPlayingVid(this.playerType)),s}setConfig(e){let t=this.config.enableReuse;Object.keys(e).forEach(t=>{this.config[t]=e[t]}),t!==this.config.enableReuse&&this.queue.removeByState(Q.b.RELEASE,this.playerType),this.queue.maxCount=this.config.maxCount}mountDom(e,t){if(!(!e||!t))try{if(!e.el)return;t.appendChild(e.el)}catch(e){console.error(e)}}unMountDom(e){var t;if(e)try{let{el:i}=e;if(!i)return;null==(t=null==i?void 0:i.parentElement)||t.removeChild(i)}catch(e){console.error(e)}}usePlayer(e,t){var i,r;let s=this.getInstance(e,t);return(0,Z.l)(tR,s.uuid,"usePlayer",s.state,t,e),t===Q.b.ACTIVE&&(null==(i=s.metrics)||i.setStartInitInfo(e9(s)),this._bindActiveEvents(s),this.currentPlayer=s),(0,Z.l)(tR,s.uuid,"usePlayer",s.state,t,null==(r=e.playerConfig)?void 0:r.autoplay),s}releasePlayer(e,t=!1){if(!e)return;this.unMountDom(e);let{enableReuse:i}=this.config,{state:r}=e;(0,Z.l)(tR,null==e?void 0:e.uuid,"releasePlayer",r,t||!i),this._unbindActiveEvents(e),e.changeState(Q.b.RELEASE);let{metrics:s,event:n}=e;s&&(s.release(),s.removeEvent(),s.player=null),n&&(n.release(),n.player=null),this._unbindEvents(e),t||!i?(this.queue.remove(e),e.destroy()):(e.release(),this.queue.setResetTimer(this.playerType)),this.queue.removeByState(Q.b.RELEASE,Q.P.XG)}updatePlayer(e,t){let{state:i}=e,{enableReuse:r,enableMultiple:s}=this.config;if((0,Z.l)(tR,e.uuid,"updatePlayer",i,t),!(i===t||!s))switch(t){case Q.b.RELEASE:this.releasePlayer(e,!r);break;case Q.b.ACTIVE:this._activePlayer(e);break;case Q.b.RETAIN:this._retainPlayer(e)}}callPlay(){(0,Z.l)(tR,"callPlay",`autoplayPrevent:${this.autoplayPrevent}`),this.autoplayPrevent&&this.queue.getAllWithState(this.playerType,Q.b.BACKUP).forEach(e=>{if(e.state===Q.b.BACKUP){(0,Z.l)(tR,"callPlay",e.uuid,`isPlaying:${e6(e)} hasStart:${e3(e)}`);let t=()=>{var i;(0,Z.l)(tR,e.uuid,"onAutoplayStart",e.muted,null==(i=e.element)?void 0:i.paused,e.currentTime,new Date().getTime()),e.state===Q.b.BACKUP&&e.pause(),e.off(J.AUTOPLAY_STARTED,t)},i=()=>{var t;(0,Z.l)(tR,e.uuid,"onTimeupdate",e.muted,null==(t=e.element)?void 0:t.paused,e.currentTime,new Date().getTime()),e.off(J.TIME_UPDATE,i)};e.on(J.AUTOPLAY_STARTED,t),e.on(J.TIME_UPDATE,i),e.play()}})}changeResolution(e,t){e&&(e.changeResolution(t),this.queue.getAll(this.playerType).forEach(i=>{i!==e&&i.changeResolution(t)}))}getResolutionInfo(e){return e?e.resolutionInfo:null}getPreloadMeta(e){return X.i.getPreloadMeta(e)}preloadResources(e){if(X.i){X.i.clearTask(this.playerType);let t=X.i.addPreloadList(e,this.playerType);(0,Z.l)(tR,"preloadResources",t)}}updatePreloadConfig(e){X.i.update(e,this.playerType)}updatePreloadCodec(e){X.i.changeCodec(e,this.playerType)}set muted(e){this.currentMuted=e,this.currentProps.muted=e,this.currentPlayer&&(this.currentPlayer.muted=e)}set volume(e){this.currentProps.volume=e,this.currentPlayer&&(this.currentPlayer.volume=e)}}let tM="[MultiplePlayerPool11]";class tB extends tw{constructor(e){super(e),this.playerType=Q.P.XG,this.queue=tI(),this.currentMuted=!1,this.currentVolume=1,this.onHevcDetect=e=>{if(e){let{open:e}=h.M.checkHevcResult();e&&this.updatePreloadCodec(Q.C.H265)}},this._onAutoplayPrevent=()=>{var e;(0,Z.l)(tM,null==(e=this.currentPlayer)?void 0:e.uuid,"_onAutoplayPrevent"),this.autoplayPrevent=!0},this._onAutoplayStart=()=>{var e,t,i,r,s;(0,Z.l)(tM,null==(e=this.currentPlayer)?void 0:e.uuid,"_onAutoplayStart",null==(t=this.currentPlayer)?void 0:t.muted,null==(r=null==(i=this.currentPlayer)?void 0:i.element)?void 0:r.paused,null==(s=this.currentPlayer)?void 0:s.currentTime,new Date().getTime()),this.autoplayPrevent=!1},this._onActiveLoadedData=()=>{let{currentPlayer:e,currentProps:t}=this;e&&ti(e)&&(t.muted=e.muted,t.volume=e.volume,this.checkLoadBackUpInstance("onActiveLoadedData"))},this._onActiveProgress=()=>{this.checkLoadBackUpInstance("onActiveProgress")},this._onActiveDegrade=e=>{(0,Z.l)(tM,"_onActiveDegrade",e),e.isSoftWareDecodeError&&this.queue.getAllWithState(this.playerType,Q.b.BACKUP).forEach(t=>{t.state!==Q.b.ACTIVE&&t.startSoftHevcDegrade(e,!0)})},this._onVolumechange=()=>{var e,t;if((0,Z.l)(tM,null==(e=this.currentPlayer)?void 0:e.uuid,"_onVolumechange"),!this.currentPlayer||!ti(this.currentPlayer))return;let{currentPlayer:i,currentProps:r}=this;(0,Z.l)(tM,null==(t=this.currentPlayer)?void 0:t.uuid,"_onVolumechange",i.muted,i.volume),r.muted=i.muted,r.volume=i.volume},this._onRatechange=()=>{var e;if((0,Z.l)(tM,null==(e=this.currentPlayer)?void 0:e.uuid,"_onRatechange"),!this.currentPlayer)return;let{currentPlayer:t,currentProps:i}=this;i.playbackRate=t.playbackRate},this._onPlayCatch=(e,t)=>{var i;if((0,Z.l)(tM,null==(i=this.currentPlayer)?void 0:i.uuid,"_onPlayCatch",e,t),!t)return;let{message:r="",errorCode:s,errorMessage:n=""}=t;(r||n).includes("is unsupported")&&h.a.focusDisableHevc({hevcCode:s||1,hevcMsg:r})},this._onceCanplay=()=>{var e,t;let i=null==(e=this.currentPlayer)?void 0:e.buffered;(0,Z.l)(tM,null==(t=this.currentPlayer)?void 0:t.uuid,"_onceCanplay",e5(i));let{isTTP:r}=h.M;null!==r&&h.b.asyncMark(r||!1)},this.currentPlayer=null,this.currentProps={playbackRate:1,muted:!1,volume:1},this.autoplayPrevent=!1,this.config={enableReuse:!1,needReset:!1,maxCount:3,enableMultiple:!1,defaultMSE:!1,minBuffer:100,needReuseCheck:!1,...e},this.queue.maxCount=this.config.maxCount,h.a.setDetectCallback(this.onHevcDetect),a.DS.setPlayerPool(this.playerType,this.queue)}setCustomTracker(e){a.DS.setCustomTracker(e)}get device(){return l.A.device}get version(){return d.v}checkLoadBackUpInstance(e){var t,i,r;let s=null==(t=this.currentPlayer)?void 0:t.buffered,n=th(s,{minBuffer:this.config.minBuffer});if(n){let t=this.queue.getByState(this.playerType,Q.b.BACKUP);if(t){let a=td(t);(0,Z.l)(tM,null==(i=this.currentPlayer)?void 0:i.uuid,"checkLoadBackUpInstance",`${e} ifLoadInit:${n} hasStart:${a} end:${e5(s)}`),a<1&&(null==(r=t.player)||r.start())}}}_bindEvents(e){(0,Z.l)(tM,"_bindEvents",e.uuid)}_unbindEvents(e){(0,Z.l)(tM,"_unbindEvents",e.uuid)}_bindActiveEvents(e){e.on(J.LOADED_DATA,this._onActiveLoadedData),e.on(J.PROGRESS,this._onActiveProgress),e.on(J.RATE_CHANGE,this._onRatechange),e.on(J.VOLUME_CHANGE,this._onVolumechange),e.once(J.CANPLAY,this._onceCanplay),e.on(J.AUTOPLAY_PREVENTED,this._onAutoplayPrevent),e.on(J.AUTOPLAY_STARTED,this._onAutoplayStart),e.on("playCatch",this._onPlayCatch),e.on(eM.g8,this._onActiveDegrade)}_unbindActiveEvents(e){e.off(J.LOADED_DATA,this._onActiveLoadedData),e.off(J.PROGRESS,this._onActiveProgress),e.off(J.RATE_CHANGE,this._onRatechange),e.off(J.VOLUME_CHANGE,this._onVolumechange),e.off(J.CANPLAY,this._onceCanplay),e.off(J.AUTOPLAY_PREVENTED,this._onAutoplayPrevent),e.off(J.AUTOPLAY_STARTED,this._onAutoplayStart),e.off("playCatch",this._onPlayCatch),e.off(eM.g8,this._onActiveDegrade)}_activePlayer(e){var t;let{state:i}=e;i!==Q.b.ACTIVE&&this._bindActiveEvents(e),this.currentPlayer=e;let{currentProps:r}=this,s=tc(e);(0,Z.l)(tM,e.uuid,"_activePlayer",e.uuid,`preState:${i}`,s,r),e.muted=r.muted,e.volume=r.volume,e.forceAutoplay=!0,null==(t=e.metrics)||t.setStartInitInfo(s);let n=e.player;n&&(n.config.autoplay=!0),e.changeState(Q.b.ACTIVE),e.play()}_retainPlayer(e){var t;(0,Z.l)(tM,e.uuid,"_retainPlayer");let{state:i}=e;i===Q.b.ACTIVE&&(this._unbindActiveEvents(e),null==(t=e.metrics)||t.stop()),e.changeState(Q.b.RETAIN),e.forceAutoplay=!1,e.pause(),e.seek(0),e.muted=!0}canUseSoftHevc(e){var t;if(!tm(e))return!1;let{extra:i,video:r}=e,s=(null==r?void 0:r.codecType)||Q.C.H264,n=Q.V.MP4,a=X.i.getPreloadMeta((null==i?void 0:i.vid)||""),o=to(e.bitrateList||[],s,n,a,(null==i?void 0:i.vid)||"");return((null==(t=null==o?void 0:o.curBitrate)?void 0:t.codecType)||s)===Q.C.H265}getInstance(e,t){var i,r,s,n;let a=null==(i=e.extra)?void 0:i.vid,o=this.canUseSoftHevc(e),l=this.queue.get(this.playerType,o?Q.M.TT_VIDEO:Q.M.VIDEO,a),{needReset:h}=this.config;l&&(0,Z.l)(tM,"getInstance reuse",l.uuid,a,t,`useSoftHevc:${o}`,e);let d=e;t!==Q.b.ACTIVE&&(d=function(e,t,i){e.autoplay=!1,e.video&&(e.video.autoplay=!1);let r=th(i,{minBuffer:t.minBuffer});return e.extra&&(e.extra.videoInit=r),t.defaultMSE&&e.mp4EncryptPlayer&&(e.mp4EncryptPlayer.needPreloadCheck=!1),e}(e,this.config,null==(r=this.currentPlayer)?void 0:r.buffered)),l?l.changeVideo(d,t,h):(l=new ty(d,t),this.queue.add(l)),this._bindEvents(l);let u=new tA,c=l.config,p=new e_(u,{bitrate:c.defaultBitrate,definition:c.defaultDefinition,codecType:c.codecType});return t!==Q.b.ACTIVE&&(l.muted=!0),l.metrics=p,l.event=u,u.player=l,p.player=l,(0,Z.l)(tM,"getInstance",l.uuid,t,`videoInit:${null==(s=d.extra)?void 0:s.videoInit}  autoplay:${null==(n=d.video)?void 0:n.autoplay} codecType:${c.codecType}  defaultBitrate:${c.defaultBitrate} defaultDefinition:${c.defaultDefinition} useSoftHevc:${o}`),(0,Z.l)(tM,"getInstance","preloadPlayingIds",X.i.getPlayingVid()),l}setConfig(e){let t=this.config.enableReuse;Object.keys(e).forEach(t=>{this.config[t]=e[t]}),t!==this.config.enableReuse&&this.queue.removeByState(Q.b.RELEASE,this.playerType),this.queue.maxCount=this.config.maxCount}mountDom(e,t){if(!(!e||!t))try{if(!e.element)return;t.appendChild(e.element)}catch(e){console.error(e)}}unMountDom(e){var t;if(e)try{let{element:i}=e;if(!i)return;null==(t=null==i?void 0:i.parentElement)||t.removeChild(i)}catch(e){console.error(e)}}usePlayer(e,t){var i,r;let s=this.getInstance(e,t);return t===Q.b.ACTIVE&&(null==(i=s.metrics)||i.setStartInitInfo(tc(s)),this._bindActiveEvents(s),this.currentPlayer=s),(0,Z.l)(tM,s.uuid,"usePlayer",s.state,t,null==(r=e.video)?void 0:r.autoplay),s}releasePlayer(e,t=!1){if(!e)return;this.unMountDom(e);let{enableReuse:i}=this.config,{state:r}=e;(0,Z.l)(tM,null==e?void 0:e.uuid,"releasePlayer",r,`enableReuse:${i} needDestroy:${t}`),this._unbindActiveEvents(e),e.changeState(Q.b.RELEASE);let{metrics:s,event:n}=e;s&&(s.release(),s.removeEvent(),s.player=null),n&&(n.release(),n.player=null),this._unbindEvents(e),t||!i?(this.queue.remove(e),e.destroy()):(e.release(),this.queue.setResetTimer(this.playerType)),this.queue.removeByState(Q.b.RELEASE,Q.P.NEW_TT)}updatePlayer(e,t){let{state:i}=e,{enableReuse:r,enableMultiple:s}=this.config;if((0,Z.l)(tM,e.uuid,"updatePlayer",i,t),!(i===t||!s))switch(t){case Q.b.RELEASE:this.releasePlayer(e,!r);break;case Q.b.ACTIVE:this._activePlayer(e);break;case Q.b.RETAIN:this._retainPlayer(e)}}callPlay(){(0,Z.l)(tM,"callPlay",`autoplayPrevent:${this.autoplayPrevent}`),this.autoplayPrevent&&this.queue.getAllWithState(this.playerType,Q.b.BACKUP).forEach(e=>{if(e.state===Q.b.BACKUP){(0,Z.l)(tM,"callPlay",e.uuid,`isPlaying:${tu(e)} hasStart:${td(e)}`);let t=()=>{var i;(0,Z.l)(tM,e.uuid,"onAutoplayStart",e.muted,null==(i=e.element)?void 0:i.paused,e.currentTime,new Date().getTime()),e.state===Q.b.BACKUP&&e.pause(),e.off(J.AUTOPLAY_STARTED,t)},i=()=>{var t;(0,Z.l)(tM,e.uuid,"onTimeupdate",e.muted,null==(t=e.element)?void 0:t.paused,e.currentTime,new Date().getTime()),e.off(J.TIME_UPDATE,i)};e.on(J.AUTOPLAY_STARTED,t),e.on(J.TIME_UPDATE,i),e.play()}})}changeResolution(e,t){e&&(e.changeResolution(t),this.queue.getAll(this.playerType).forEach(i=>{i!==e&&i.changeResolution(t)}))}getResolutionInfo(e){return e?e.resolutionInfo:null}getPreloadMeta(e){return X.i.getPreloadMeta(e)}preloadResources(e){if(X.i){X.i.clearTask();let t=X.i.addPreloadList(e);(0,Z.l)(tM,"preloadResources",t)}}updatePreloadConfig(e){X.i.update(e)}updatePreloadCodec(e){X.i.changeCodec(e)}set muted(e){this.currentMuted=e,this.currentProps.muted=e,this.currentPlayer&&(this.currentPlayer.muted=e)}set volume(e){this.currentProps.volume=e,this.currentPlayer&&(this.currentPlayer.volume=e)}}let tN="change",tU="update",tF="reset",tV="error";class t${constructor(e){this.handlerEvent=e=>{((e,...t)=>{})(0,e.type,e),this.emit("subtitle_event",e)},this.list=[],e.subTitlesList&&e.subTitlesList.forEach(e=>{this.list.push(e)}),this.player=null,this.xgSubtitle=new Y({subTitles:this.list,domRender:!1,defaultOpen:e.defaultOpen,updateMode:e.updateMode||"vod",debugger:!!e.debugger,renderMode:"normal"}),this.bindEvent()}bindEvent(){this.on(tN,this.handlerEvent),this.on("on",this.handlerEvent),this.on(tU,this.handlerEvent),this.on(tF,this.handlerEvent),this.on(tV,this.handlerEvent)}unBindEvents(){this.off(tN,this.handlerEvent),this.off(tU,this.handlerEvent),this.off(tF,this.handlerEvent),this.off(tV,this.handlerEvent),this.off("on",this.handlerEvent)}attach(e){var t,i;null==(t=this.xgSubtitle)||t.detachPlayer(),null==(i=this.xgSubtitle)||i.attachPlayer(e)}detach(){var e;null==(e=this.xgSubtitle)||e.detachPlayer()}destroy(){var e;this.unBindEvents(),null==(e=this.xgSubtitle)||e.destroy(),this.xgSubtitle=null}switch(e){var t,i;if(e)return null==(i=this.xgSubtitle)?void 0:i.switch(e).catch(e=>{console.error("switch error",e)});null==(t=this.xgSubtitle)||t.switchOff()}switchOff(){var e;return null==(e=this.xgSubtitle)?void 0:e.switchOff()}setSubTitles(e,t=!1){var i;let r=e.map(e=>({...e}));null==(i=this.xgSubtitle)||i.setSubTitles(r,t)}emit(e,t,...i){var r;null==(r=this.xgSubtitle)||r.emit(e,t,...i)}on(e,t,...i){var r;null==(r=this.xgSubtitle)||r.on(e,t,...i)}once(e,t,...i){var r;null==(r=this.xgSubtitle)||r.on(e,t,...i)}off(e,t,...i){var r;null==(r=this.xgSubtitle)||r.off(e,t,...i)}offAll(){var e;this.unBindEvents(),null==(e=this.xgSubtitle)||e.offAll()}}},55301:function(e,t,i){"use strict";let r,s,n,a,o,l;i.d(t,{m:function(){return ei}});let h="tt-video",d={workerUrl:"",maxDecodeSize:200,sampleDtsLargetGap:100,powerfulDecodeFps:60,minDecodeFps:40,forbiddenDuration:6048e5,powerfulFFCost:800,powerfulRenderRate:.6,continuousLowDecodeTime:3e3},u="s_forbi_v",c="s_forbi_t",p=!1;try{p=WebAssembly&&WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]))}catch{}function f(){return typeof CustomElementRegistry>"u"||typeof MediaSource>"u"?-1:p?!0===function(){let e=!1;try{if(e=!!localStorage.getItem(u)){let t=Number(localStorage.getItem(c));Date.now()-t>d.forbiddenDuration&&(e=!1,localStorage.removeItem(u),localStorage.removeItem(c))}}catch{}return e}()?-3:1:-2}var m,g=i(32239),_=i(48890),v=Object.defineProperty,y=(e,t,i)=>{let r;return(r="symbol"!=typeof t?t+"":t)in e?v(e,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[r]=i};let A=class e{constructor(t){y(this,"_open",!1),y(this,"_level",1),y(this,"_clsName",""),y(this,"log"),y(this,"info"),y(this,"warn"),y(this,"error"),y(this,"debug"),y(this,"table"),y(this,"trace"),y(this,"group"),y(this,"groupEnd");try{let e=localStorage.getItem("xgd");this._open=!!e,this._level=parseInt(e||"0")}catch{this._open=!1}this._clsName=t,["group","groupEnd","log","warn","error"].forEach(t=>{this[t]=(i,r,s,n,a,o,l,h,d,u)=>{if(this._open||e.enabled){let e=[i,r,s,n,a,o,l,h,d,u].filter(e=>void 0!==e);console[t](`[${this._clsName}]`,...e)}}})}static setEnable(){e.enabled=!0}get enable(){return this._open}get long(){return 2===this._level}};y(A,"enabled",!1);var T={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,i="~";function r(){}function s(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function n(e,t,r,n,a){if("function"!=typeof r)throw TypeError("The listener must be a function");var o=new s(r,n||e,a),l=i?i+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(i=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(i?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=i?i+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,n=r.length,a=Array(n);s<n;s++)a[s]=r[s].fn;return a},o.prototype.listenerCount=function(e){var t=i?i+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,n,a){var o=i?i+e:e;if(!this._events[o])return!1;var l,h,d=this._events[o],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,r),!0;case 4:return d.fn.call(d.context,t,r,s),!0;case 5:return d.fn.call(d.context,t,r,s,n),!0;case 6:return d.fn.call(d.context,t,r,s,n,a),!0}for(h=1,l=Array(u-1);h<u;h++)l[h-1]=arguments[h];d.fn.apply(d.context,l)}else{var c,p=d.length;for(h=0;h<p;h++)switch(d[h].once&&this.removeListener(e,d[h].fn,void 0,!0),u){case 1:d[h].fn.call(d[h].context);break;case 2:d[h].fn.call(d[h].context,t);break;case 3:d[h].fn.call(d[h].context,t,r);break;case 4:d[h].fn.call(d[h].context,t,r,s);break;default:if(!l)for(c=1,l=Array(u-1);c<u;c++)l[c-1]=arguments[c];d[h].fn.apply(d[h].context,l)}}return!0},o.prototype.on=function(e,t,i){return n(this,e,t,i,!1)},o.prototype.once=function(e,t,i){return n(this,e,t,i,!0)},o.prototype.removeListener=function(e,t,r,s){var n=i?i+e:e;if(!this._events[n])return this;if(!t)return a(this,n),this;var o=this._events[n];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||a(this,n);else{for(var l=0,h=[],d=o.length;l<d;l++)(o[l].fn!==t||s&&!o[l].once||r&&o[l].context!==r)&&h.push(o[l]);h.length?this._events[n]=1===h.length?h[0]:h:a(this,n)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=i,o.EventEmitter=o,e.exports=o}(T);let b=(m=T.exports)&&m.__esModule&&Object.prototype.hasOwnProperty.call(m,"default")?m.default:m;var S=((r=S||{}).LOADSTART="loadstart",r.WAITING="waiting",r.CANPLAY="canplay",r.PLAY="play",r.PLAYING="playing",r.PAUSE="pause",r.SEEKING="seeking",r.SEEKED="seeked",r.LOADEDDATA="loadeddata",r.LOADEDMETADATA="loadedmetadata",r.TIMEUPDATE="timeupdate",r.DURATION_CHANGE="durationchange",r.VOLUME_CHANGE="volumechange",r.PROGRESS="progress",r.ERROR="error",r.ENDED="ended",r.RESIZE="resize",r.WARING="warning",r),E=((s=E||{}).PLAY_EVENT="playevent",s.APPEND_CHUNKS="appendchunks",s.START_RENDER="startrender",s.DO_SEEK="doseek",s.DO_ENDOFSTREAM="doendofstream",s.DESTROY="destroy",s.READY="ready",s.AUDIO_READY="audioready",s.VIDEO_READY="videoready",s.AUDIO_WAITING="audiowaiting",s.AUDIO_PLAYING="audioplaying",s.AUDIO_PLAY="audioplay",s.UPDATE_VIDEO_FILLTYPE="updatevideofilltype",s.SET_PLAYBACKRATE="setplaybackrate",s.UPDATE_VOLUME="updatevolume",s.SET_AUTOPLAY="setautoplay",s.SET_LOOP="setloop",s),k=((n=k||{}).PLAYCONTROL_PLAY="playcontrol.play",n.PLAYCONTROL_PAUSE="playcontrol.pause",n.PLAYCONTROL_SEEK="playcontrol.seek",n.WORKER_CONFIG="worker.config",n.PLAYCONTROL_UPDATETIME="playcontrol.updatetime",n.RENDER_INIT="render.init",n.RENDER_FRAME="render.frame",n.VIDEO_METADATA="video.metadata",n.VIDEO_SAMPLES="video.samples",n.DECODER_CONFIGURE="decoder.configure",n.DECODER_DODECODE="decoder.dodecode",n.RESET_WORKER="reset.worker",n),P=((a=P||{}).FRAME_RESIZE_EVENT="event.resize",a.RENDER_ERROR="render.error",a.DECODER_FIRSTFRAME_READY="decoder.firstframeready",a.DECODER_DECODED="decoder.decoded",a.DECODER_READY="decoder.ready",a.TTVIDEO_ERROR="ttvideo.error",a.EFFICIENCY_INFO="efficiency.info",a);class w extends b{constructor(e){super(),y(this,"_parent"),y(this,"_ready",!1),this._parent=e}_bindEvents(){this._parent.on(E.APPEND_CHUNKS,this._appendChunk.bind(this)),this._parent.on(E.DO_SEEK,this._doSeek.bind(this)),this._parent.on(E.DESTROY,this._destroy.bind(this))}emitPlayEvent(e,t){var i;null==(i=this._parent)||i.emit(E.PLAY_EVENT,e,t)}_appendChunk(e,t){}_doSeek(e){}_destroy(e){}}let x=function(e,t,i){let r,s,n=[];return r=2===i||5===i?i:5,s=e,e>=6?s=e-3:1===t&&(r=2,s=e),n[0]=r<<3,n[0]|=(14&e)>>1,n[1]=(1&e)<<7,n[1]|=t<<3,5===r&&(n[1]|=(14&s)>>1,n[2]=(1&s)<<7,n[2]|=8,n[3]=0),n},C=new A("TTVideo.WakeLock"),L=new class{constructor(){if(y(this,"_running",!1),y(this,"_bgMedia",null),"u">typeof document){this._bgMedia=document.createElement("video"),this._bgMedia.setAttribute("playsinline",""),this._bgMedia.setAttribute("loop","");let e=document.createElement("source");e.src="data:video/mp4;base64,AAAAHGZ0eXBNNFYgAAACAGlzb21pc28yYXZjMQAAAAhmcmVlAAAGF21kYXTeBAAAbGliZmFhYyAxLjI4AABCAJMgBDIARwAAArEGBf//rdxF6b3m2Ui3lizYINkj7u94MjY0IC0gY29yZSAxNDIgcjIgOTU2YzhkOCAtIEguMjY0L01QRUctNCBBVkMgY29kZWMgLSBDb3B5bGVmdCAyMDAzLTIwMTQgLSBodHRwOi8vd3d3LnZpZGVvbGFuLm9yZy94MjY0Lmh0bWwgLSBvcHRpb25zOiBjYWJhYz0wIHJlZj0zIGRlYmxvY2s9MTowOjAgYW5hbHlzZT0weDE6MHgxMTEgbWU9aGV4IHN1Ym1lPTcgcHN5PTEgcHN5X3JkPTEuMDA6MC4wMCBtaXhlZF9yZWY9MSBtZV9yYW5nZT0xNiBjaHJvbWFfbWU9MSB0cmVsbGlzPTEgOHg4ZGN0PTAgY3FtPTAgZGVhZHpvbmU9MjEsMTEgZmFzdF9wc2tpcD0xIGNocm9tYV9xcF9vZmZzZXQ9LTIgdGhyZWFkcz02IGxvb2thaGVhZF90aHJlYWRzPTEgc2xpY2VkX3RocmVhZHM9MCBucj0wIGRlY2ltYXRlPTEgaW50ZXJsYWNlZD0wIGJsdXJheV9jb21wYXQ9MCBjb25zdHJhaW5lZF9pbnRyYT0wIGJmcmFtZXM9MCB3ZWlnaHRwPTAga2V5aW50PTI1MCBrZXlpbnRfbWluPTI1IHNjZW5lY3V0PTQwIGludHJhX3JlZnJlc2g9MCByY19sb29rYWhlYWQ9NDAgcmM9Y3JmIG1idHJlZT0xIGNyZj0yMy4wIHFjb21wPTAuNjAgcXBtaW49MCBxcG1heD02OSBxcHN0ZXA9NCB2YnZfbWF4cmF0ZT03NjggdmJ2X2J1ZnNpemU9MzAwMCBjcmZfbWF4PTAuMCBuYWxfaHJkPW5vbmUgZmlsbGVyPTAgaXBfcmF0aW89MS40MCBhcT0xOjEuMDAAgAAAAFZliIQL8mKAAKvMnJycnJycnJycnXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXiEASZACGQAjgCEASZACGQAjgAAAAAdBmjgX4GSAIQBJkAIZACOAAAAAB0GaVAX4GSAhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGagC/AySEASZACGQAjgAAAAAZBmqAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZrAL8DJIQBJkAIZACOAAAAABkGa4C/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmwAvwMkhAEmQAhkAI4AAAAAGQZsgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGbQC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm2AvwMkhAEmQAhkAI4AAAAAGQZuAL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGboC/AySEASZACGQAjgAAAAAZBm8AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZvgL8DJIQBJkAIZACOAAAAABkGaAC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmiAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZpAL8DJIQBJkAIZACOAAAAABkGaYC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBmoAvwMkhAEmQAhkAI4AAAAAGQZqgL8DJIQBJkAIZACOAIQBJkAIZACOAAAAABkGawC/AySEASZACGQAjgAAAAAZBmuAvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZsAL8DJIQBJkAIZACOAAAAABkGbIC/AySEASZACGQAjgCEASZACGQAjgAAAAAZBm0AvwMkhAEmQAhkAI4AhAEmQAhkAI4AAAAAGQZtgL8DJIQBJkAIZACOAAAAABkGbgCvAySEASZACGQAjgCEASZACGQAjgAAAAAZBm6AnwMkhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AhAEmQAhkAI4AAAAhubW9vdgAAAGxtdmhkAAAAAAAAAAAAAAAAAAAD6AAABDcAAQAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwAAAzB0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAABAAAAAAAAA+kAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAALAAAACQAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAPpAAAAAAABAAAAAAKobWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAB1MAAAdU5VxAAAAAAALWhkbHIAAAAAAAAAAHZpZGUAAAAAAAAAAAAAAABWaWRlb0hhbmRsZXIAAAACU21pbmYAAAAUdm1oZAAAAAEAAAAAAAAAAAAAACRkaW5mAAAAHGRyZWYAAAAAAAAAAQAAAAx1cmwgAAAAAQAAAhNzdGJsAAAAr3N0c2QAAAAAAAAAAQAAAJ9hdmMxAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAALAAkABIAAAASAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGP//AAAALWF2Y0MBQsAN/+EAFWdCwA3ZAsTsBEAAAPpAADqYA8UKkgEABWjLg8sgAAAAHHV1aWRraEDyXyRPxbo5pRvPAyPzAAAAAAAAABhzdHRzAAAAAAAAAAEAAAAeAAAD6QAAABRzdHNzAAAAAAAAAAEAAAABAAAAHHN0c2MAAAAAAAAAAQAAAAEAAAABAAAAAQAAAIxzdHN6AAAAAAAAAAAAAAAeAAADDwAAAAsAAAALAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAACgAAAAoAAAAKAAAAiHN0Y28AAAAAAAAAHgAAAEYAAANnAAADewAAA5gAAAO0AAADxwAAA+MAAAP2AAAEEgAABCUAAARBAAAEXQAABHAAAASMAAAEnwAABLsAAATOAAAE6gAABQYAAAUZAAAFNQAABUgAAAVkAAAFdwAABZMAAAWmAAAFwgAABd4AAAXxAAAGDQAABGh0cmFrAAAAXHRraGQAAAADAAAAAAAAAAAAAAACAAAAAAAABDcAAAAAAAAAAAAAAAEBAAAAAAEAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAkZWR0cwAAABxlbHN0AAAAAAAAAAEAAAQkAAADcAABAAAAAAPgbWRpYQAAACBtZGhkAAAAAAAAAAAAAAAAAAC7gAAAykBVxAAAAAAALWhkbHIAAAAAAAAAAHNvdW4AAAAAAAAAAAAAAABTb3VuZEhhbmRsZXIAAAADi21pbmYAAAAQc21oZAAAAAAAAAAAAAAAJGRpbmYAAAAcZHJlZgAAAAAAAAABAAAADHVybCAAAAABAAADT3N0YmwAAABnc3RzZAAAAAAAAAABAAAAV21wNGEAAAAAAAAAAQAAAAAAAAAAAAIAEAAAAAC7gAAAAAAAM2VzZHMAAAAAA4CAgCIAAgAEgICAFEAVBbjYAAu4AAAADcoFgICAAhGQBoCAgAECAAAAIHN0dHMAAAAAAAAAAgAAADIAAAQAAAAAAQAAAkAAAAFUc3RzYwAAAAAAAAAbAAAAAQAAAAEAAAABAAAAAgAAAAIAAAABAAAAAwAAAAEAAAABAAAABAAAAAIAAAABAAAABgAAAAEAAAABAAAABwAAAAIAAAABAAAACAAAAAEAAAABAAAACQAAAAIAAAABAAAACgAAAAEAAAABAAAACwAAAAIAAAABAAAADQAAAAEAAAABAAAADgAAAAIAAAABAAAADwAAAAEAAAABAAAAEAAAAAIAAAABAAAAEQAAAAEAAAABAAAAEgAAAAIAAAABAAAAFAAAAAEAAAABAAAAFQAAAAIAAAABAAAAFgAAAAEAAAABAAAAFwAAAAIAAAABAAAAGAAAAAEAAAABAAAAGQAAAAIAAAABAAAAGgAAAAEAAAABAAAAGwAAAAIAAAABAAAAHQAAAAEAAAABAAAAHgAAAAIAAAABAAAAHwAAAAQAAAABAAAA4HN0c3oAAAAAAAAAAAAAADMAAAAaAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAAAJAAAACQAAAAkAAACMc3RjbwAAAAAAAAAfAAAALAAAA1UAAANyAAADhgAAA6IAAAO+AAAD0QAAA+0AAAQAAAAEHAAABC8AAARLAAAEZwAABHoAAASWAAAEqQAABMUAAATYAAAE9AAABRAAAAUjAAAFPwAABVIAAAVuAAAFgQAABZ0AAAWwAAAFzAAABegAAAX7AAAGFwAAAGJ1ZHRhAAAAWm1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAALWlsc3QAAAAlqXRvbwAAAB1kYXRhAAAAAQAAAABMYXZmNTUuMzMuMTAw",e.type="video/mp4",this._bgMedia.appendChild(e),this._bgMedia.addEventListener("timeupdate",()=>{this._bgMedia&&this._bgMedia.currentTime>.5&&(this._bgMedia.currentTime=Math.random())})}}get running(){return this._running}enable(){var e;let t=null==(e=this._bgMedia)?void 0:e.play();if(t&&t.then)return t.then(e=>(this._running=!0,C.warn("background video running"),e)).catch(e=>{this._running=!1})}disable(){var e;null==(e=this._bgMedia)||e.pause(),this._running=!1,C.warn("background video paused")}};var D=((o=D||{})[o.WORKER_INIT_ERROR=10001]="WORKER_INIT_ERROR",o[o.WORKER_RUNTIME_ERROR=10002]="WORKER_RUNTIME_ERROR",o[o.RENDER_INIT_ERROR=10003]="RENDER_INIT_ERROR",o[o.RENDER_RUNTIME_ERROR=10004]="RENDER_RUNTIME_ERROR",o[o.DECODER_INIT_ERROR=10005]="DECODER_INIT_ERROR",o[o.DECODER_DECODE_ERROR=10006]="DECODER_DECODE_ERROR",o[o.DECODER_RUNTIME_ERROR=10007]="DECODER_RUNTIME_ERROR",o[o.AUDIO_ERROR=10008]="AUDIO_ERROR",o[o.ELEMENT_USE_ERROR=10009]="ELEMENT_USE_ERROR",o[o.ONLY_SUPPORT_AVEXIST=10010]="ONLY_SUPPORT_AVEXIST",o[o.ONLY_SUPPORT_HEVC=10011]="ONLY_SUPPORT_HEVC",o[o.MOCK_ERROR=10012]="MOCK_ERROR",o),I=((l=I||{})[l.DECODE_FRAME_SLOWLY=20001]="DECODE_FRAME_SLOWLY",l[l.RENDER_FRAME_SLOWLY=20002]="RENDER_FRAME_SLOWLY",l[l.FIRST_FRAME_SHOW_SLOWLY=20003]="FIRST_FRAME_SHOW_SLOWLY",l[l.MOCK_WARNING=20004]="MOCK_WARNING",l);class R extends Error{constructor(e,t){super(t),y(this,"code"),this.code=e}}class O extends Error{constructor(e,t){super(t),y(this,"code"),this.code=e}}let M=new A("TTVideo.AudioRender");class B{constructor(e,t){y(this,"_rafId",0),y(this,"_destroyed",0),y(this,"_media"),y(this,"_updateTime"),y(this,"_raf",()=>{this._destroyed||this._media&&(this._media.ended||(!(this._media.currentTime<.5)&&(this._media.paused||this._media.seeking)||this._updateTime(1e3*this._media.currentTime),this._rafId=requestAnimationFrame(this._raf)))}),this._media=e,this._updateTime=t}get backGroundMedia(){return L._bgMedia}init(){this._rafId&&cancelAnimationFrame(this._rafId),M.log("[VideoDeriver]: init rvf driver for video decoder\u3001render"),this._rafId=requestAnimationFrame(this._raf),L.running||L.enable()}destroy(){this._destroyed=1,this._media=null,L.disable(),cancelAnimationFrame(this._rafId),M.log("[VideoDeriver]: cancelAnimationFrame")}}class N extends w{constructor(e){super(e),y(this,"_media",null),y(this,"_videoDeriver",null),y(this,"_mse",null),y(this,"_remuxer",null),y(this,"_meta",null),y(this,"_sampleQueue",[]),y(this,"_codec",""),y(this,"_sourceCreated",!1),y(this,"_needInitSegment",!0),y(this,"_inProcessing",!1),y(this,"_ended",!1),y(this,"_waiting",!1),y(this,"_onVisibilitychange",()=>{var e,t;if("hidden"===document.visibilityState){M.log("\u540E\u53F0\u4E2D!"),null==(e=this._media)||e.pause();return}M.log("\u524D\u53F0\u4E2D!"),null==(t=this._media)||t.play()}),y(this,"_updatePlayTime",e=>{this._parent.updatePlayTime(e)}),y(this,"_onCanplay",()=>{M.log("audio ON canplay!!!"),this._media&&(this._ready||(this._ended=!1,this._waiting||(M.warn("pause audio play once canplay"),this._media.pause()),this._waiting=!1,this._ready=!0,this.emit(E.AUDIO_READY),this._videoDeriver||(this._videoDeriver=new B(this._media,this._updatePlayTime)),this._videoDeriver.init()))}),y(this,"_onPlaying",()=>{this._media&&(this._ended=!1,M.log("audio ON playing!!"),this._videoDeriver||(this._videoDeriver=new B(this._media,this._updatePlayTime)),this._videoDeriver.init(),this.emit(E.AUDIO_PLAYING))}),y(this,"_onPlay",()=>{M.log("audio ON play!!"),this.emit(E.AUDIO_PLAY)}),y(this,"_onPause",()=>{M.log("audio ON pause!!"),this.emitPlayEvent(S.PAUSE)}),y(this,"_onWaiting",()=>{if(this._media){try{let e=this._media.buffered,t=this._media.currentTime,i=0;for(let r=0,s=e.length;r<s;r++)e.start(r)<t&&e.end(r)>t&&(i=e.end(r)-t);if(Math.abs(i)>.5||this._checkEndOfStreamOrLoop())return}catch{}this._ready=!1,this._waiting=!0,this.emit(E.AUDIO_WAITING)}}),y(this,"_onSeeking",()=>{M.log("audio ON seeking")}),y(this,"_onSeeked",()=>{var e;M.log("seeked","_ready:",this._ready),this._ready||(M.warn("pause audio play once seeked!"),null==(e=this._media)||e.pause(),this._ready=!0,this.emit(E.AUDIO_READY,!0))}),y(this,"_onEnded",()=>{M.log("play ON ended!!"),this.emitPlayEvent(S.ENDED),this._ended=!0}),y(this,"_onProgress",()=>{if(this._media){if(this._media.readyState<=1){let e=this._getBufferGap();e>0&&e<1&&(this._media.currentTime+=e+.05,M.warn("progress, gap=",e))}this.emitPlayEvent(S.PROGRESS)}}),y(this,"_onOnceProgress",()=>{if(this._media&&this._media.buffered.length){let e=this._media.buffered.start(0);e&&(this._media.currentTime=e+.05,M.log("start gap:",e)),this._media.removeEventListener("progress",this._onOnceProgress)}}),y(this,"_onTimeupdate",()=>{this.emitPlayEvent(S.TIMEUPDATE),this._checkEndOfStreamOrLoop()}),y(this,"_onDurationchange",()=>{this.emitPlayEvent(S.DURATION_CHANGE)}),y(this,"_onError",e=>{var t,i;let r=(null==(i=null==(t=this._media)?void 0:t.error)?void 0:i.message)||(null==e?void 0:e.message)||"audio error",s=new R(D.AUDIO_ERROR,r);this.emitPlayEvent(S.ERROR,s)}),y(this,"_appendChunk",async(e,t)=>{if(t.samples.length){if(this._codec||(2!==t.objectType&&5!==t.objectType?this._codec="mp4a.40.5":this._codec=t.codec),t.samples.forEach(e=>{e.baseMediaDecodeTime=t.baseMediaDecodeTime,this._sampleQueue.push(e)}),t.samples=[],!this._meta){this._meta={...t,exist:()=>!0,hasSample:()=>!0,samples:[]},M.warn("audio set metadata",this._meta),t.config.length||(this._meta.config=t.config=x(t.sampleRateIndex,t.channelCount,t.objectType));try{await this._doAppendWrapper()}catch(e){this._onError(e)}return}if(!this._inProcessing&&this._sampleQueue.length)try{await this._doAppendWrapper()}catch(e){this._onError(e)}}}),y(this,"_doAppend",async e=>{var t,i,r;this._remuxer||(this._remuxer=new g.s({samples:[],exist:()=>!1},e,null)),this._sourceCreated||(await (null==(t=this._mse)?void 0:t.open()),this._sourceCreated=!0,M.log(`video/mp4;codecs=${this._codec}`),null==(i=this._mse)||i.createSource(e.type,`video/mp4;codecs=${this._codec}`),M.log("sourcebuffer created!"));let s=null==(r=this._remuxer)?void 0:r.remux(this._needInitSegment);if(this._needInitSegment&&!s.audioInitSegment||!this._mse)return;this._needInitSegment=!1;let n=[];return s.audioInitSegment&&n.push(this._mse.append(e.type,s.audioInitSegment,null)),s.audioSegment&&n.push(this._mse.append(e.type,s.audioSegment,null)),Promise.all(n)}),y(this,"_doSeek",e=>{this._media&&(M.log("doSeek, t=",e),this._ready=!1,this._media.currentTime=e)}),this._initMedia()}static isSupported(){return!!window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="mp4a.40.5"')}get media(){return this._media}get currentTime(){var e;return(null==(e=this._media)?void 0:e.currentTime)||0}get buffered(){var e;return null==(e=this._media)?void 0:e.buffered}get ended(){var e;return null==(e=this._media)?void 0:e.ended}get played(){var e;return null==(e=this._media)?void 0:e.played}get duration(){var e;return null!=(e=this._media)&&e.duration?this._media.duration:this._meta?this._meta.duration/this._meta.formatTimescale:0}set duration(e){this._updateDuration(e)}get readyState(){var e;return(null==(e=this._media)?void 0:e.readyState)||0}_initMedia(){this._media=document.createElement("video"),this._mse=new _.Ub(void 0,null),this._bindEvents(),this._bindMediaEvents(),this._mse.bindMedia(this._media)}_getBufferGap(){let e=this.buffered;if(!e)return 0;for(let t=0,i=e.length;t<i;t++)if(!(e.end(t)<this.currentTime))return e.start(t)-this.currentTime;return 0}resume(){var e,t;return M.log("call audio play() outside!!"),(null!=(e=this._media)&&e.ended||this._ended)&&this._parent.seek(.005),L.running||L.enable(),null==(t=this._media)?void 0:t.play()}pause(){var e;return M.log("call audio pause() outside!!"),L.disable(),null==(e=this._media)?void 0:e.pause()}_bindEvents(){super._bindEvents(),this._parent.on(E.UPDATE_VOLUME,e=>{this._media&&(this._media.volume=e,this.emitPlayEvent(S.VOLUME_CHANGE),L.running||L.enable())}),this._parent.on(E.DO_ENDOFSTREAM,()=>{var e;null==(e=this._mse)||e.endOfStream()}),this._parent.on(E.SET_PLAYBACKRATE,e=>{this._media&&(M.log("set playbackrate",e),this._media.playbackRate=e)}),this._parent.on(E.SET_AUTOPLAY,e=>{this._media&&(M.log("set autoplay",e),this._media.autoplay=e)}),this._parent.on(E.SET_LOOP,e=>{this._media&&(M.log("set loop",e),this._media.loop=e)}),document.addEventListener("visibilitychange",this._onVisibilitychange)}_bindMediaEvents(){this._media&&(this._media.addEventListener("canplay",this._onCanplay),this._media.addEventListener("play",this._onPlay),this._media.addEventListener("playing",this._onPlaying),this._media.addEventListener("pause",this._onPause),this._media.addEventListener("waiting",this._onWaiting),this._media.addEventListener("seeking",this._onSeeking),this._media.addEventListener("seeked",this._onSeeked),this._media.addEventListener("progress",this._onProgress),this._media.addEventListener("ended",this._onEnded),this._media.addEventListener("progress",this._onOnceProgress),this._media.addEventListener("timeupdate",this._onTimeupdate),this._media.addEventListener("durationchange",this._onDurationchange),this._media.addEventListener("error",this._onError))}_checkEndOfStreamOrLoop(){var e;if(this._media)return .3>Math.abs(this._media.duration-this._media.currentTime)&&(this._media.loop?(M.log(`currentTime:${this.currentTime}, duration: ${this.duration}, loop play!`),this._parent.seek(.005)):(M.log("mse do endOfStream()!"),null==(e=this._mse)||e.endOfStream(),this.emitPlayEvent(S.ENDED),this._ended=!0),!0)}async _updateDuration(e){this._mse&&(this._mse.isOpened||await this._mse.open(),this._mse&&(await this._mse.updateDuration(e),M.log("update duration",e)))}async _doAppendWrapper(){var e;this._meta&&(this._meta.samples=this._sampleQueue.slice(),this._meta.baseMediaDecodeTime=(null==(e=this._meta.samples[0])?void 0:e.baseMediaDecodeTime)||0,this._sampleQueue=[],this._inProcessing=!0,await this._doAppend(this._meta),this._inProcessing=!1,this._sampleQueue.length&&await this._doAppendWrapper())}async _destroy(){var e,t,i;M.log("destroy audio render"),this._media&&(this.removeAllListeners(),this._remuxer=null,null==(e=this._videoDeriver)||e.destroy(),document.removeEventListener("visibilitychange",this._onVisibilitychange),this._media.removeEventListener("canplay",this._onCanplay),this._media.removeEventListener("playing",this._onPlaying),this._media.removeEventListener("play",this._onPlay),this._media.removeEventListener("waiting",this._onWaiting),this._media.removeEventListener("seeking",this._onSeeking),this._media.removeEventListener("seeked",this._onSeeked),this._media.removeEventListener("progress",this._onProgress),this._media.removeEventListener("ended",this._onEnded),this._media.removeEventListener("progress",this._onOnceProgress),this._media.removeEventListener("error",this._onError),null==(t=this._mse)||t.endOfStream(),await (null==(i=this._mse)?void 0:i.unbindMedia()),this._mse=null,this._meta=null)}}let U=new A("TTVideo.WorkerInit"),F=new A("TTVideo.WorkerPool"),V=class e{static preloadWorker(){if(F.log("preload worker!"),e.Pools.length)return;let t=e._initWorker();if(!t)return;let i=e=>{t.worker.removeEventListener("message",i),e.data.type===P.DECODER_READY&&(t.workerInfo.ready=!0)};t.worker.addEventListener("message",i),e.Pools.push(t)}static _initWorker(){let e=function(){let e,t=d.workerUrl;if(t)U.log("new Worker by URL!",t),e=new Worker(t);else throw U.log("new Worker by Inline"),Error("no worker url found!");return e}();if(!e)return;let t=document.createElement("canvas"),i=t.transferControlToOffscreen();return t.style.margin="auto",t.style.position="absolute",t.style.pointerEvents="none",e.postMessage({type:k.RENDER_INIT,canvas:i},[i]),F.log("init new worker pairs"),{id:Date.now(),worker:e,cvs:t,offscreenCvs:i,workerInfo:{worker:e,ready:!1}}}static catchWorker(t){F.log("cache worker pairs"),e.Pools.push(t)}static getWorker(){let t=e.Pools.pop();return t?(F.log("use cached worker pairs, ready?",t.workerInfo.ready),t):(e.preloadWorker(),e.Pools.pop()||null)}};y(V,"Pools",[]);let $=new A("TTVideo.Degrade");class z{constructor(){y(this,"_videoFps",0),y(this,"_decodeFpsQueue",[]),y(this,"_totalFps",0),y(this,"_totalDecodeFps",0),y(this,"_totalRenderFrames",0)}get renderRate(){return this._totalFps?Number((this._totalRenderFrames/this._totalFps).toFixed(2)):0}get decodeRate(){return this._totalDecodeFps?Number((this._totalDecodeFps/this._totalFps).toFixed(2)):0}addEfficiInfo(e){this._videoFps=e.fps;let{powerfulDecodeFps:t,powerfulFFCost:i,powerfulRenderRate:r,minDecodeFps:s,continuousLowDecodeTime:n}=d;if(this._totalFps+=e.fps,this._totalDecodeFps+=e.decodeFps,this._totalRenderFrames+=e.renderFps,e.ffCost>i)throw $.warn("slow firstframe decode, cost=",e.ffCost),new O(I.FIRST_FRAME_SHOW_SLOWLY,`${e.ffCost}`);if(this._totalRenderFrames&&this._totalRenderFrames/this._totalFps<r)throw $.warn("slow render"),new O(I.RENDER_FRAME_SLOWLY,`${this._totalRenderFrames/this._totalFps}`);if(e.decodeFps>e.fps+t?this._decodeFpsQueue.pop():this._decodeFpsQueue.push(e.decodeFps),this._decodeFpsQueue.length>=n/1e3){$.warn("slow decode!");let e=this._decodeFpsQueue[0];throw e<s&&($.warn("decode perf really slow, forbidden soft use!"),function(){try{localStorage.setItem(u,"1"),localStorage.setItem(c,Date.now()+"")}catch{}}()),this._decodeFpsQueue=[],new O(I.DECODE_FRAME_SLOWLY,`${e}`)}}}let j=new A("TTVideo.MainSink");class G extends b{constructor(e){super(),y(this,"_workerPairs",null),y(this,"_parent"),y(this,"_nextSample"),y(this,"_preSample"),y(this,"_inDecoding",!1),y(this,"_id",new Date().getMilliseconds()),y(this,"_meta",null),y(this,"_efficiInfo",null),y(this,"_degrade",new z),y(this,"_firstFrame",!1),y(this,"_onWorkerMessage",e=>{this.emit(e.data.type,e.data)}),y(this,"_onWorkerError",e=>{if(null!=e&&e.message)return void this._parent.onError(new R(D.WORKER_RUNTIME_ERROR,(null==e?void 0:e.message)||"worker eror"));this._parent.onError(new R(D.WORKER_INIT_ERROR,(null==e?void 0:e.message)||"worker init error"))}),this._parent=e;try{this._workerPairs=V.getWorker()}catch(e){setTimeout(()=>{this._parent.onError(new R(D.WORKER_INIT_ERROR,null==e?void 0:e.message))})}this._bindWorkerEvent(),j.log("workerPairs",this._workerPairs)}get canvas(){var e;return null==(e=this._workerPairs)?void 0:e.cvs}get worker(){var e,t;return null==(t=null==(e=this._workerPairs)?void 0:e.workerInfo)?void 0:t.worker}get decoderReady(){var e,t;return null==(t=null==(e=this._workerPairs)?void 0:e.workerInfo)?void 0:t.ready}get efficInfo(){return this._efficiInfo}_bindWorkerEvent(){let e=this.worker;e&&(e.addEventListener("message",this._onWorkerMessage),e.addEventListener("error",this._onWorkerError),this._transEventUp(k.PLAYCONTROL_UPDATETIME),this._transEventUp(k.PLAYCONTROL_SEEK),this._transEventUp(k.RESET_WORKER),this._transEventUp(k.VIDEO_METADATA),this._transEventUp(k.WORKER_CONFIG),this._transSamplesUp(),this.on(P.RENDER_ERROR,this._onWorkerError),this.on(P.FRAME_RESIZE_EVENT,this.onFrameResize),this.on(P.DECODER_READY,this.onDecoderReady),this.on(P.EFFICIENCY_INFO,this.onEfficiInfo),this.on(P.DECODER_FIRSTFRAME_READY,this.onDecoderFirstFrameReady),this.on(P.TTVIDEO_ERROR,this.onTTVIDEOError),this.emit(k.WORKER_CONFIG,{logger:j.enable,init:Date.now(),...d}))}_transEventUp(e){this.on(e,t=>{var i,r,s;null==(s=null==(r=null==(i=this._workerPairs)?void 0:i.workerInfo)?void 0:r.worker)||s.postMessage({type:e,...t})})}_transSamplesUp(){this.on(k.VIDEO_SAMPLES,e=>{var t,i,r;null==(r=null==(i=null==(t=this._workerPairs)?void 0:t.workerInfo)?void 0:i.worker)||r.postMessage({type:k.VIDEO_SAMPLES,buffer:e.buffer,list:e.list},[e.buffer.buffer])})}addMetadata(e){var t,i;j.warn("add metadata, decoder ready? ",!!(null!=(i=null==(t=this._workerPairs)?void 0:t.workerInfo)&&i.ready)),this._meta=e,this.emit(k.VIDEO_METADATA,{formatTimescale:e.formatTimescale,duration:e.duration,width:e.width,height:e.height,fpsNum:e.fpsNum,fpsDen:e.fpsDen,vps:e.vps,pps:e.pps,sps:e.sps,codec:e.codec})}appendBuffer(e){this.emit(k.VIDEO_SAMPLES,function(e){let t=e.map(e=>(function(e){let t=new Uint8Array(e.reduce((e,t)=>e+=t.byteLength+4,0)),i=0;return e.forEach(e=>{t.set([0,0,0,1],i),i+=4,t.set(e,i),i+=e.byteLength}),t})(e.units)),i=new Uint8Array(t.reduce((e,t)=>e+=t.byteLength||0,0)),r=0;return t.forEach(e=>{i.set(e,r),r+=e.length}),{buffer:i,list:e.map(e=>({dts:e.dts,pts:e.pts,size:e.data.length,key:+!!e.keyframe}))}}(e))}updatePlayTime(e){this.emit(k.PLAYCONTROL_UPDATETIME,{time:e})}preciseSeek(e){this.emit(k.PLAYCONTROL_SEEK,{time:1e3*e})}destroy(){var e,t;j.log(" do destory!");let i=this.worker;i&&(this.emit(k.RESET_WORKER),i.removeEventListener("message",this._onWorkerMessage),i.removeEventListener("error",this._onWorkerError),null!=(t=null==(e=this._workerPairs)?void 0:e.workerInfo)&&t.ready&&V.catchWorker(this._workerPairs),this._workerPairs=null)}onDecoderReady(){this._workerPairs&&(j.log("worker decoder init ready"),this._workerPairs.workerInfo.ready=!0)}onDecoderFirstFrameReady(){this._parent.emit(E.VIDEO_READY),this._firstFrame||(this._firstFrame=!0,this._parent.emitPlayEvent(S.LOADEDDATA))}onFrameResize(){this._parent.emitPlayEvent(S.RESIZE)}onTTVIDEOError(e){var t,i;this._workerPairs&&(this._workerPairs.workerInfo.ready=!1,null==(t=this._workerPairs.workerInfo.worker)||t.terminate(),j.warn("worker terminate!")),null==(i=this._parent)||i.onError(new R(e.code,e.message))}onEfficiInfo(e){j.log("EfficInfo:",e);try{this._degrade.addEfficiInfo(e)}catch(e){this._parent.emitPlayEvent(S.WARING,e)}this._efficiInfo={...e,renderRate:this._degrade.renderRate,decodeRate:this._degrade.decodeRate}}}let H=new A("TTVideo.VideoRender");class W extends w{constructor(e){super(e),y(this,"_mainSink"),y(this,"_canvas"),y(this,"_worker"),y(this,"_meta",null),y(this,"_recentMeta",null),y(this,"_firstFrame",!1),this._bindEvents(),this._mainSink=new G(this),this._canvas=this._mainSink.canvas,this._worker=this._mainSink.worker}get canvas(){return this._canvas}get efficInfo(){return this._mainSink.efficInfo}_bindEvents(){super._bindEvents();let e=({width:e,height:t},i=0,r=0)=>{let{width:s,height:n}=this._meta||this._canvas,a=t*s/n,o=e*n/s,l=e-a,h=t-o,d=l*i+"px",u=h*r+"px";this._canvas.style.left=d,this._canvas.style.top=u,H.warn(`cvsWidth=${s}, cvsHeight=${n}, scaleCvsWidth=${a}, scaleCvsHeight=${o}`),H.warn(`cover position: deltaX=${l}, deltaY=${h}, width=${e}, height=${t}, pX=${d}, pY=${u}`)};this._parent.on(E.UPDATE_VIDEO_FILLTYPE,(t,{width:i,height:r})=>{let{width:s,height:n}=this._meta||this._canvas,a=!i||i/r>s/n;if(H.warn(`UPDATE_VIDEO_FILLTYPE isGapX = ${a}, objectFit=${t}, cvsWidth:${s}, cvsHeight:${n}, container width:${i}, container height:${r}`),this._canvas.style.maxWidth="initial",this._canvas.style.maxHeight="initial","cover"===t){if(a){this._canvas.style.left="0px",this._canvas.style.top="0px",this._canvas.style.height="auto",this._canvas.style.width="100%",e({width:i,height:r},0,.5);return}this._canvas.style.left="0px",this._canvas.style.top="0px",this._canvas.style.width="auto",this._canvas.style.height="100%",e({width:i,height:r},.5,0);return}if("fill"===t){this._canvas.style.width="100%",this._canvas.style.height="100%";return}this._canvas.style.top="0px",this._canvas.style.bottom="0px",this._canvas.style.left="0px",this._canvas.style.right="0px",this._canvas.style.maxWidth="100%",this._canvas.style.maxHeight="100%",this._canvas.style.width="initial",this._canvas.style.height="initial",s<i&&n<r&&(s/i>n/r?this._canvas.style.width="100%":this._canvas.style.height="100%")})}_appendChunk(e){var t,i,r,s,n;if(this._meta){if((null==(r=this._recentMeta)?void 0:r.width)!==e.width||this._recentMeta.height!==e.height){H.warn(`metadata changed! width: ${null==(s=this._recentMeta)?void 0:s.width} -> ${e.width}, height: ${null==(n=this._recentMeta)?void 0:n.height} -> ${e.height}`);let t=e.samples[0];t&&(this._recentMeta=t.meta=Object.assign({},e,{samples:null}))}}else this.emitPlayEvent(S.LOADEDMETADATA),H.log("emit loadedmetadata event!"),this._recentMeta=this._meta=Object.assign({},e,{samples:null}),H.warn("video set metadata",this._meta),null==(i=null==(t=this._mainSink)?void 0:t.addMetadata)||i.call(t,this._meta);let a=e.samples;e.samples=[],this._mainSink.appendBuffer(a)}_destroy(){var e;H.log("destroy video render"),this.removeAllListeners(),null==(e=this._mainSink)||e.destroy()}updatePlayTime(e){var t;null==(t=this._mainSink)||t.updatePlayTime(e)}ajustSeekTime(e){var t;null==(t=this._mainSink)||t.preciseSeek(e)}onError(e){this.emitPlayEvent(S.ERROR,e)}}let q=new A("TTVideo.TimeLine");class K extends b{constructor(){super(),y(this,"audioRender"),y(this,"videoRender"),y(this,"_readyStatus",{audio:!1,video:!1,seeking:!1}),y(this,"_loadeddata",!1),y(this,"_appendData",!1),y(this,"_initTime",0),y(this,"updatePlayTime",e=>{this.seeking||this.videoRender.updatePlayTime(e)}),this.audioRender=new N(this),this.videoRender=new W(this),this._bindEvent(),this._initTime=performance.now(),q.log("init TIMELINE")}get ready(){return this._readyStatus.video&&this._readyStatus.audio}get played(){return this.audioRender.played}get currentTime(){return this.audioRender.currentTime}get readyState(){return this.audioRender.readyState}get buffered(){return this.audioRender.buffered}get duration(){return this.audioRender.duration}get canvas(){return this.videoRender.canvas}get efficInfo(){return this.videoRender.efficInfo}get seeking(){return this._readyStatus.seeking}_resetReadyStatus(){this._readyStatus.audio=!1,this._readyStatus.video=!1,this._readyStatus.seeking=!0}_bindEvent(){this.audioRender.on(E.AUDIO_READY,e=>{if(q.log("audio ready!!! seeking=",this._readyStatus.seeking,"seeked:",!!e),this._readyStatus.audio=!0,this._readyStatus.seeking)return void this.videoRender.ajustSeekTime(this.currentTime);this._playCtrol()}),this.audioRender.on(E.AUDIO_PLAYING,()=>{this._readyStatus.seeking||this._loadeddata&&(this.emit(E.PLAY_EVENT,S.PLAYING),q.log("emit playing event!"))}),this.audioRender.on(E.AUDIO_PLAY,()=>{this._loadeddata&&(this.emit(E.PLAY_EVENT,S.PLAY),q.log("emit play event!"))}),this.audioRender.on(E.AUDIO_WAITING,()=>{this.currentTime&&(q.log("audio waiting!!! currentTime=",this.currentTime),this.emit(E.PLAY_EVENT,S.WAITING),q.log("emit waiting event!"),this._readyStatus.audio=!1)}),this.videoRender.on(E.VIDEO_READY,()=>{q.log("video ready!!!"),this._loadeddata=!0,this._readyStatus.video=!0,this._playCtrol()}),this.on(E.DESTROY,()=>{this.removeAllListeners()})}_playCtrol(){var e,t,i;q.log(`status: audio=${this._readyStatus.audio}, video=${this._readyStatus.video}, seeking:${this._readyStatus.seeking}`);let{audio:r,video:s,seeking:n}=this._readyStatus;if(!(!r||!s)){if(n){this._readyStatus.seeking=!1,this.emit(E.PLAY_EVENT,S.SEEKED),q.log("emit seeked event!"),this.emit(E.PLAY_EVENT,S.CANPLAY),q.log("emit canplay event!"),null==(e=this.audioRender.resume())||e.catch(e=>{});return}this.emit(E.PLAY_EVENT,S.CANPLAY),q.log("emit canplay event!"),null!=(t=this.audioRender.media)&&t.autoplay&&(null==(i=this.audioRender.resume())||i.catch(e=>{}))}}appendBuffer(e,t){this._appendData||(this._appendData=!0,q.log("fist time appendBuffer, cost=",Math.round(performance.now()-this._initTime))),this.emit(E.APPEND_CHUNKS,e,t)}play(){return this.audioRender.resume()}pause(){return this.audioRender.pause()}seek(e){this._loadeddata&&(e>=this.duration&&(e=this.duration-1),e<0&&(e=0),q.log(`start seek to:${e}, set seeking status=true`),this._resetReadyStatus(),this.emit(E.DO_SEEK,e),this.emit(E.PLAY_EVENT,S.SEEKING),q.log("emit seeking event!"))}}let Y=new A("TTVideo.TTVideo"),X=typeof HTMLElement>"u"?Object:HTMLElement,Q=class e extends X{constructor(){super(),y(this,"_timeline",null),y(this,"_resizeObserver",null),y(this,"_domConnected",!1),y(this,"_err",null),y(this,"_warning",null),y(this,"_seekTimer",0),y(this,"_tempEfficCache",null),this._proxyProps()}_proxyProps(){Object.getOwnPropertyNames(e.prototype).forEach(e=>{/^__/.test(e)&&Object.defineProperty(this,e.replace("__",""),{get:function(){try{return this[e]}catch{}return 0},set:function(t){try{this[e]=t}catch{}}})})}static get version(){return"0.1.6"}static setEleName(t){h=t,typeof customElements>"u"||customElements.get(h)||customElements.define(h,class extends e{})}static updateTTVideoConfig(e){d=Object.assign({},d,e)}static preloadWorker(){try{return V.preloadWorker()}catch{}}addEventListener(e,t,i){super.addEventListener(e,t,i)}removeEventListener(e,t,i){super.removeEventListener(e,t,i)}setAttribute(e,t){super.setAttribute(e,t)}_init(){this._timeline=new K,Y.log("timeline init"),this._bindEvents(),this._timeline&&(this._timeline.emit(E.SET_PLAYBACKRATE,this.playbackRate),this._timeline.emit(E.SET_AUTOPLAY,this.autoplay),this._timeline.emit(E.SET_LOOP,this.loop),this.__muted=this.__muted)}_bindEvents(){var e;null==(e=this._timeline)||e.on(E.PLAY_EVENT,(e,t)=>{e===S.LOADEDDATA&&(this.querySelector("canvas")||(Y.log("ttvideo appendChild canvas"),this.appendChild(this.__canvas)),this.__canvas&&(this.__canvas.style.display="block")),e===S.RESIZE&&this._updateVideoPostion(),e===S.ERROR&&(Y.warn("detect error:",t),this.pause(),this._err=t),e===S.WARING&&(this._warning=t),e===S.ENDED&&this.pause(),this._innerDispatchEvent(e,t)})}disconnectedCallback(){this._domConnected=!1,Y.log("video disconnectedCallback");let e=this.querySelector("canvas");if(e)try{this.removeChild(e),Y.log("remove canvas child")}catch{}this._tempEfficCache=this.getStats(),this.destroy(),this._resizeObserver&&this._resizeObserver.disconnect()}connectedCallback(){var e,t;let i=null==(e=this.childNodes[0])?void 0:e.tagName;if((null==(t=null==i?void 0:i.toLocaleLowerCase)?void 0:t.call(i))==="source"){this._err=new R(D.ELEMENT_USE_ERROR,"not supported source node"),this._innerDispatchEvent("error",this._err);return}if(Y.log("video connected to document"),this._timeline||this._init(),this.style.width="100%",this.style.height="100%",this.style.position="absolute",this.style.left="0px",this.style.top="0px",ResizeObserver){let e=0;this._resizeObserver=new ResizeObserver(()=>{var t;null!=(t=this._timeline)&&t.ready&&(clearTimeout(e),e=setTimeout(()=>{this._updateVideoPostion()},100))}),this._resizeObserver.observe(this)}this._domConnected=!0}play(){var e;return(null==(e=this._timeline)?void 0:e.play())||new Promise(e=>e())}pause(){var e;null==(e=this._timeline)||e.pause()}load(){}endOfStream(){var e;this.__currentTime&&(Y.log("endofstream called!"),null==(e=this._timeline)||e.emit(E.DO_ENDOFSTREAM))}_updateVideoPostion(){var e;this.containerLayout&&(null==(e=this._timeline)||e.emit(E.UPDATE_VIDEO_FILLTYPE,this.objectFit,this.containerLayout))}appendBuffer(e,t){if(!(!this._timeline||this._err)){if("hevc"!==e.codecType){this._err=new R(D.ONLY_SUPPORT_HEVC,"not hevc codec type"),this._innerDispatchEvent("error",this._err);return}if(!e.duration||!t.duration){this._err=new R(D.ONLY_SUPPORT_AVEXIST,"video or audio not exist"),this._innerDispatchEvent("error",this._err);return}e.formatTimescale&&e.samples.forEach(t=>{t.dts=Math.floor(t.dts/e.formatTimescale*1e3),t.pts=Math.floor(t.pts/e.formatTimescale*1e3)}),t.formatTimescale&&t.samples.forEach(e=>{e.dts=Math.floor(e.dts/t.formatTimescale*1e3),e.pts=Math.floor(e.pts/t.formatTimescale*1e3)}),this._timeline.appendBuffer(e,t)}}_innerDispatchEvent(e,t){this.dispatchEvent(new CustomEvent(e,{detail:t}))}destroy(){this._timeline&&(Y.log("call destroy"),this._timeline.emit(E.DESTROY),this._timeline=null,this._err=null)}mockError(){var e;null==(e=this._timeline)||e.emit(E.PLAY_EVENT,S.ERROR,new R(D.MOCK_ERROR,"mock error"))}mockWarning(){var e;null==(e=this._timeline)||e.emit(E.PLAY_EVENT,S.WARING,new O(I.MOCK_WARNING,"mock warning"))}get autoplay(){return"true"===this.getAttribute("autoplay")}set autoplay(e){this.setAttribute("autoplay",e)}get loop(){return"loop"===this.getAttribute("loop")}set loop(e){var t;if(null==(t=this._timeline)||t.emit(E.SET_LOOP,e),e)return void this.setAttribute("loop","loop");this.removeAttribute("loop")}get __canvas(){var e;return null==(e=this._timeline)?void 0:e.canvas}get __ended(){var e;return null==(e=this.audioMedia)?void 0:e.ended}get __videoWidth(){var e;return(null==(e=this.__canvas)?void 0:e.width)||0}get __videoHeight(){var e;return(null==(e=this.__canvas)?void 0:e.height)||0}get __volume(){return Number(this.getAttribute("volume"))}set __volume(e){var t;e<=0&&(e=0),e>=1&&(e=1),this.setAttribute("volume",e),this.__muted||null==(t=this._timeline)||t.emit(E.UPDATE_VOLUME,e)}get __muted(){return"true"===this.getAttribute("muted")}set __muted(e){var t;this.setAttribute("muted",e),null==(t=this._timeline)||t.emit(E.UPDATE_VOLUME,e?0:this.__volume)}get __currentTime(){return this._timeline?Math.min(this._timeline.currentTime,this._timeline.duration):0}set __currentTime(e){this._seek(e)}_seek(e){this._seekTimer&&clearTimeout(this._seekTimer),this._seekTimer=setTimeout(()=>{var t;Y.warn("seek to:",e),null==(t=this._timeline)||t.seek(Number(e))},100)}get __duration(){var e;return(null==(e=this.audioMedia)?void 0:e.duration)||0}get __seeking(){var e;return(null==(e=this.audioMedia)?void 0:e.seeking)||!1}get __paused(){var e;return null==(e=this.audioMedia)?void 0:e.paused}get __readyState(){var e;return(null==(e=this.audioMedia)?void 0:e.readyState)||0}get __buffered(){var e;return(null==(e=this.audioMedia)?void 0:e.buffered)||{length:0}}get __played(){var e;return null==(e=this.audioMedia)?void 0:e.played}get objectFit(){return this.getAttribute("object-fit")}set objectFit(e){this.setAttribute("object-fit",e),this._updateVideoPostion()}get src(){return this.getAttribute("src")||""}get currentSrc(){return this.getAttribute("src")||""}set src(e){var t;Y.log("set src ",e),this.setAttribute("src",e),(!this._domConnected||null!=(t=this.__buffered)&&t.length)&&(this.destroy(),this._timeline||this._init()),this._innerDispatchEvent("loadstart")}set playbackRate(e){var t;this.setAttribute("playbackrate",e),null==(t=this._timeline)||t.emit(E.SET_PLAYBACKRATE,e)}get playbackRate(){return parseFloat(this.getAttribute("playbackrate")||"1")}get networkState(){return 1}get preloadTime(){let e=this.getAttribute("preloadtime");if(e){let t=Number.parseFloat(e);if(t>0&&!Number.isNaN(t))return t}return 1/0}set preloadTime(e){e&&Number(e)>0&&this.setAttribute("preloadtime",e)}get __error(){return this._err}get containerLayout(){let e=this.parentNode;if(!e)return null;let t=e.parentNode;return t?null!=e&&e.clientWidth&&null!=e&&e.clientHeight?{width:null==e?void 0:e.clientWidth,height:null==e?void 0:e.clientHeight}:{width:null==t?void 0:t.clientWidth,height:(null==t?void 0:t.clientHeight)||0}:null}get audioMedia(){var e,t;return null==(t=null==(e=this._timeline)?void 0:e.audioRender)?void 0:t.media}getStats(){var e;if(this._tempEfficCache)return{...this._tempEfficCache};let t=null==(e=this._timeline)?void 0:e.efficInfo;return this._err?{...t,code:this._err.code,message:this._err.message}:this._warning?{...t,code:this._warning.code,message:this._warning.message}:t}};y(Q,"workerUrl","");try{"u">typeof customElements&&(customElements.get(h)||customElements.define(h,Q))}catch{}var J=i(50840),Z=i(46217),ee=i(59650);let et="IHEVCSoftWareDecoder",ei=new class{constructor(){this.enableState=!1,this.checkResult=null,this.h265SoftInfo=null,this.config={workerUrl:"https://www.tiktok.com/webapp-desktop/static/worker/ttvideo-worker-CTvWXoSE.js",maxDecodeSize:1e3,powerfulDecodeFps:10,powerfulFFCost:1e3,continuousLowDecodeTime:1e3},this.state=-1,this.stats={s_open:0,s_support:0,s_enable:0}}setPlayerH265SoftInfo(e){let t=f();if(this.stats.s_support=t,!e||t<1)return!1;this.h265SoftInfo=e;let i=J.M.checkSoftHevcResult(e);this.checkResult=i;let{enableSoftwareH265:r=0,config:s={}}=e;return r>0&&(this.updateConfig(s),this.prefetchSoftwareWorkerJS()),i.open?(this.enableState=!0,!0):(this.enableState=!1,!1)}enable(e){this.setPlayerH265SoftInfo(e),this.enableState=!0}disable(){this.enableState=!1}getStats(){let{open:e=!1,hardware:t=!1,deviceScore:i=!1,playMode:r=!1}=this.checkResult||{};return{worker_state:this.state,s_testopen:+!!e,s_hardware:+!!t,s_score:+!!i,s_playmode:+!!r,...this.stats}}use(){return this.canUse()&&1===this.state}canUse(){let e=!(0,Z.Zo)(),t=J.M.checkSoftHevcResult(this.h265SoftInfo);this.stats.s_enable=+!!this.enableState,this.stats.s_open=+!!t.open;let i=f();return this.stats.s_support=i,e&&this.enableState&&t.open&&i>0}prefetchSoftwareWorkerJS(e){let{state:t}=this;if(t>=0)return;this.state=0,(0,ee.l)(et,Q.version,"prefetchSoftwareWorkerJS ready");let i=e||this.config.workerUrl,r=i?fetch(i).then(e=>e.ok).catch(()=>!1):Promise.resolve(!1);r&&r.then?r.then(e=>{if((0,ee.l)(et,"prefetchSoftwareWorkerJS success",e),!e){this.state=2;return}Q.updateTTVideoConfig({workerUrl:i}),Q.preloadWorker(),this.state=1}).catch(e=>{this.state=2}):this.state=3}updateConfig(e){let t={...this.config,...e};Q.updateTTVideoConfig(t),this.config=t}}},28731:function(e,t,i){"use strict";let r,s,n,a,o,l,h,d,u,c;function p(){return typeof window>"u"||typeof document>"u"}i.d(t,{Ay:function(){return ti},DS:function(){return e9},K:function(){return tt},Tx:function(){return Q}});let f=!p()&&window.location.href.indexOf("loggerdebug")>-1;function m(e,t,...i){f&&console.log(`[logger>${e}]`,t,...i)}function g(){try{return Math.round(window.performance.now())}catch{return new Date().getTime()}}function _(){return new Date().getTime()}function v(e){return Object.prototype.toString.call(e).match(/([^\s.*]+)(?=]$)/g)[0]}function y(e,t=2){let i=Math.pow(10,t);return Math.round(e*i)/i}function A(e){return parseInt((1e3*e).toFixed(0),10)}function T(e){return parseInt(e,10)}function b(e){return e&&e instanceof window.HTMLMediaElement}function S(e){if(!e||"string"!=typeof e)return"";let t=e.split("/"),i="";return t.length>3&&t[2]&&(i=t[2]),i}function E(e){try{return JSON.stringify(e)}catch{return""}}function k(e){return"string"==typeof e&&/^blob/.test(e)}function P(e){return null!=e&&e.media&&(e=e.media),!!e&&e instanceof HTMLMediaElement&&(k(null==e?void 0:e.currentSrc)||k(null==e?void 0:e.src))}function w(e,t,i){return e>0&&t>0?t-e:0}let x=[RegExp("(\\?|&)expire=([^&]*)(&|$)"),RegExp("(\\?|&)x-tos-expires=([^&]*)(&|$)"),RegExp("(\\?|&)x-expires=([^&]*)(&|$)")];function C(e){if(!e||"string"!=typeof e)return 0;let t=0;try{let i=[];if(x.forEach(t=>{let r=e.match(t);r&&i.push(r)}),i.length>0)t=parseInt(i[0][2],10);else{let i=e.split("/");i.length>5&&8===i[4].length&&(t=parseInt(i[4],16))}if(t>0){let e=new Date,i=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),0)/1e3;return t<=i?1:2}return 0}catch{return 0}}function L(e,t){Object.keys(e).forEach(i=>{null==t[i]||(e[i]=t[i])})}let D="0.3.46",I=[{key:"QQBrowser",reg:/(qqbrowser)\/([\d.]+)/},{key:"2345Explorer",reg:/(2345explorer)\/([\d.]+)/},{key:"Wexin",reg:/(micromessenger)\/([\d.]+)/},{key:"Openlanguage",reg:/(openlanguage)\/([\d.]+)/},{key:"NewsArticle",reg:/(newsarticle)\/([\d.]+)/},{key:"VideoArticle",reg:/(videoarticle)\/([\d.]+)/},{key:"Hotsoon",reg:/(live_stream)_([\d.]+)/},{key:"Aweme",reg:/(aweme)_([\d.]+)/},{key:"Lark",reg:/(lark)\/([\d.]+)/},{key:"PlayStation",reg:/(playstation)/},{key:"BingPreview",reg:/(bingpreview)\/([\d.]+)/},{key:"Baiduspider",reg:/(baiduspider-render)\/([\d.]+)/},{key:"YandexBot",reg:/(yandexbot)\/([\d.]+)/},{key:"Chrome",reg:/(chrome)\/([\d.]+)/},{key:"Safari",reg:/(version)\/([\d.]+)\s*(safari)/}],R=[{key:"Trident",reg:/(rv:)([\d.]+)/},{key:"Trident",reg:/(msie)\s*([\d.]+)/}],O=["Baiduspider","YandexBot"],M=!(typeof window>"u"),B={isIOS:!1,isAndroid:!1,isMobile:!1,isPC:!1,isPad:!1,isSpider:!1,isSupportMP4:!0,mime:"",name:"",appVersion:"",isChrome:!1,isSafari:!1};p()||function(e){var t,i;let r;if(!(typeof window>"u"?"":null==(t=window.navigator)?void 0:t.userAgent))return;let s=window.navigator.userAgent.toLocaleLowerCase(),n=/(iphone)/.test(s)||/(ipad)/.test(s),a=/(android)/.test(s),o=/(windows phone)/.test(s),l=n||a||o;e.isIOS=n,e.isAndroid=a,e.isPC=!l,e.isPad=/(ipad)/.test(s);let h=function(){let e={isSupport:!1,mime:""};if(typeof document>"u")return e;let t=document.createElement("video");return"function"==typeof t.canPlayType?["avc1.42E01E, mp4a.40.2","avc1.58A01E, mp4a.40.2","avc1.4D401E, mp4a.40.2","avc1.64001E, mp4a.40.2","avc1.42E01E","mp4v.20.8","avc1.42E01E, mp4a.40.2","avc1.58A01E, mp4a.40.2","avc1.4D401E, mp4a.40.2","avc1.64001E, mp4a.40.2","mp4v.20.8, mp4a.40.2","mp4v.20.240, mp4a.40.2"].map(i=>{(null==t?void 0:t.canPlayType(`video/mp4; codecs="${i}"`))==="probably"&&(e.isSupport=!0,e.mime+=`||${i}`)}):t=null,e}();e.isSupportMP4=h.isSupport,e.mime=h.mime;let d="",u="",c=[],p=I;/trident/.test(s)&&(p=R);for(let e=0;e<p.length;e++)if(c=p[e].reg.exec(s)){d=p[e].key,u=c.length>2?c[2]:"";break}d?(e[`is${d}`]=!0,e.name=d,e.appVersion=u):function(){let{mimeTypes:e}=navigator;if(e){for(let t=0;t<e.length;t++)if(e[t].type&&e[t].type.indexOf("360")>-1||e[t].type&&e[t].type.indexOf("application/vnd.chromium.remoting-viewer")>-1||e[t].description&&e[t].description.indexOf("360")>-1)return!0;return!1}}()&&(e.name="360EE"),e.name&&"Trident"!==e.name&&/(trident)/.exec(s)&&(e.name=e.name?`${e.name}_Trident`:"Trident"),i=e.name,r=!1,O.map(e=>{e===i&&(r=!0)}),/spider/.test(s)&&(r=!0),e.isSpider=r}(B);let N=!(typeof window>"u"||typeof document>"u"),U={sdk_version:D,pc:"",pv:"",sv:"",line_app_id:0,line_user_id:"",app_version:"",platform:B.isPad?"pad":B.isMobile?"mobile":"pc",cpu_core:0,memory_size:0,support:0,absdkVersion:"",d_score:-1,vendor:"",gpu:"",deviceScore:{},ua:""},F="",V=0;function $(e){Object.keys(e).forEach(t=>{void 0!==e[t]&&("playerCoreVersion"===t?U.pc=e[t]:"playerVersion"===t?U.pv=e[t]:"appVersion"===t?U.app_version=e[t]:"strategyVersion"===t?U.sv=e[t]:void 0!==U[t]&&(U[t]=e[t]))})}!function(){var e;let t;if(!N)return;let i=window.navigator,r=i&&i.hardwareConcurrency||0,s=i&&i.deviceMemory||0,n=i&&i.webdriver?1:0,a=i&&i.userAgent||"";U.cpu_core=r,U.memory_size=s,U.webdriver=n,U.ua=a,e=e=>{U.support=e},t=1e4*!!B.isSupportMP4,t=!(typeof MediaSource>"u")&&MediaSource.isTypeSupported&&(MediaSource.isTypeSupported('video/mp4;codecs="hev1.1.6.L120.90"')||MediaSource.isTypeSupported('video/mp4;codecs="hev1.2.4.L120.90"')||MediaSource.isTypeSupported('video/mp4;codecs="hev1.3.E.L120.90"')||MediaSource.isTypeSupported('video/mp4;codecs="hev1.4.10.L120.90"'))?t+1e3:t,(function(e){let t={supported:!1,smooth:!1,powerEfficient:!1};if(!e||p())return Promise.resolve(t);if(navigator.mediaCapabilities&&navigator.mediaCapabilities.decodingInfo)return navigator.mediaCapabilities.decodingInfo(e);{let i=e.video||{contentType:""},r=e.audio||{contentType:""};try{let e=MediaSource.isTypeSupported(i.contentType||""),t=MediaSource.isTypeSupported(r.contentType);return Promise.resolve({supported:e&&t,smooth:!1,powerEfficient:!1})}catch{return Promise.resolve(t)}}})({type:"file",video:{contentType:'video/mp4;codecs="hev1.1.6.L120.90"',width:1920,height:1080,bitrate:1e4,framerate:30}}).then(i=>{i&&i.supported?t+=100:t+=10,e(t)}).catch(i=>{e(t+=1)}),m("CommonData",U)}();var z=((r=z||{}).PLAY="play",r.PAUSE="pause",r.PLAYING="playing",r.WAITING="waiting",r.ENDED="ended",r.SEEKING="seeking",r.SEEKED="seeked",r.LOAD_START="loadstart",r.LOADED_DATA="loadeddata",r.TIMEUPDATE="timeupdate",r.PROGRESS="progress",r.CANPLAY="canplay",r.VOLUME_CHANGE="volumechange",r.RATE_CHANGE="ratechange",r.LOADED_METADATA="loadedmetadata",r.DURATION_CHANGE="durationchange",r.EMPTIED="emptied",r.ERROR="error",r.SUSPEND="suspend",r.ABORT="abort",r.STALLED="stalled",r),j=((s=j||{}).PLAY_CATCH="playCatch",s.AUTOPLAY_PREVENTED="autoplay_was_prevented",s.AUTOPLAY_STARTED="autoplay_started",s.DESTROY="destroy",s.NEXT="playnext",s.RESET="reset",s.SOURCE_ERROR="source_error",s.INITIAL_URL="initialUrl",s.RENDER_STATE_CHANGE="renderStateChange",s.LOADSTART_MSE="loadstart_mse",s.DEFI_CHANGE="definitionChange",s.BEFORE_DEFI_CHANGE="beforeDefinitionChange",s.DEFI_CHANGE_SUCCESS="definitionChangeSuccess",s.XG_LOG_CACHE="xglog_cache",s.DEGRADE="degrade",s.ABR_CHANGE="ABR_CHANGE",s.DEFI_CHANGE_DETAIL="definitionChangeDetail",s.PRF_DATA_SIZE="prf_data_size",s.MEDIA_FORMAT_ERROR="media_format_error",s.META_READY="metaReady",s.HIT_CACHE="hitcache",s.DOWNGRADE="downgrade",s.EXCEPTION="exception",s.STRATEGY="strategy",s),G=((n=G||{}).ONE_PLAY="videoplayer_oneplay",n.ONE_OPERA="videoplayer_oneopera",n.ONE_ERROR="videoplayer_oneerror",n.ONE_EVENT="videoplayer_oneevent",n.ONE_TEMP="videoplayer_onetemp",n.MDL_DATA_SIZE="mdl_video_data_size",n.MDL_PRELOAD="mdl_video_preload",n);let H={videoplayer_oneplay:"play_session_events",mdl_video_preload:"mdl_video_preload"},W="unknown";var q=((a=q||{}).ERROR="error",a.PLAY_CATCH="playcatch",a.SEEKING="seeking",a.PAUSE="pause",a.ENDED="ended",a.WAITING="waiting",a.SWITCH="switch",a.LOG_DESTROY="log_destroy",a.DESTROY="destroy",a.PLAY_NEXT="playnext",a.RESET="reset",a.PAGE_UNLOAD="page_unload",a.DEGRADE="degrade",a.DOWNGRADE="downgrade",a.EXCEPTION="exception",a),K=((o=K||{})[o.INIT=0]="INIT",o[o.LOADING=1]="LOADING",o[o.LOADED=2]="LOADED",o[o.PLAYING=3]="PLAYING",o[o.ERROR=5]="ERROR",o[o.WAITING=7]="WAITING",o[o.SEEKING=8]="SEEKING",o[o.AUTO_PLAY_PREVENTED=9]="AUTO_PLAY_PREVENTED",o[o.LOADED_METADATA=10]="LOADED_METADATA",o),Y=((l=Y||{})[l.INIT=0]="INIT",l[l.LOADSTART=1]="LOADSTART",l[l.META=2]="META",l[l.PLAYABLE=9]="PLAYABLE",l[l.ERROR=10]="ERROR",l[l.STALLED=11]="STALLED",l),X=((h=X||{}).DEFAULT="default",h.ACTIVE="active",h.RETAIN="retain",h.RELEASE="release",h.BACKUP="backup",h.DESTROY="destroy",h),Q=((d=Q||{})[d.NONE=0]="NONE",d[d.RELOAD=1]="RELOAD",d[d.CONTINUE=2]="CONTINUE",d),J=((u=J||{}).STAGE_1="1",u.STAGE_2="2",u.MSE_1="mse_1",u.MSE_2="mse_2",u.SOFT_1="soft_1",u.SOFT_2="soft_2",u.HEVC_1="hevc_1",u.HEVC_2="hevc_2",u);function Z(e,t){let i={startPos:0,endPos:0,include:0,diff:0,cur:t,start:-1,end:-1},r=e?e.length:0;if(r<1)return i;i.start=A(e.start(0)),i.end=A(e.end(r-1));let s=-1,n=-1,a=A(t);for(let t=e.length-1;t>-1;t--){let r=A(e.start(t)),o=A(e.end(t));if(a>=r&&a<=o){i.include=1,i.startPos=r,i.endPos=o,i.diff=o-a;break}a<r&&(s<0||r-a<s)?(s=r-a,n=t):a>o&&(s<0||a-o<s)&&(s=a-o,n=t)}return 1!==i.include&&(n<0&&(n=e.length-1),i.startPos=A(e.start(n)),i.endPos=A(e.end(n))),i}function ee(e){let t=[];if(!e||e.length<1)return t;let i=e.length;for(let r=0;r<i;r++){let i=A(e.start(r))/1e3,s=A(e.end(r))/1e3;t.push({start:i,end:s,diff:T(s-i)})}return t}function et(e,t=0,i=1){if(!e)return!1;t=A(t);for(let r=0;r<e.length;r++){let s=A(e.start(r))+i,n=A(e.end(r))-i;if(t>s&&t<n)return!0}return!1}function ei(e){var t;return b(e)?e:(null==e?void 0:e.media)||(null==e?void 0:e.video)||(null==(t=null==e?void 0:e.getElement)?void 0:t.call(e))||null}function er(e){return e.rawSrc||e.currentSrc||e.src}function es(e){return en(e,["readyState","networkState"])}function en(e,t){let i=ei(e);if(!i)return{};if(!Array.isArray(t))return i[t];{let e={};return t.forEach(t=>{e[t]=i[t]}),e}}function ea(e){var t;return e?(e.vtype?e.vtype:(null==(t=e.config)?void 0:t.vtype)||"")||(e.dash?"DASH":""):""}function eo(e){var t,i;let r=(null==(t=null==e?void 0:e.config)?void 0:t.codecType)||"",s=(null==(i=null==e?void 0:e.config)?void 0:i.mediaType)||"";return r?"tt-video"===s?`soft_${r}`:r:""}function el(e,t){let i=0;return e>0&&t>0&&e<t?(i=parseInt((t-e).toFixed(0),10))>6e4?6e4:i:0}function eh(e){return e&&!!e.coreName}function ed(e,t){var i,r;if((null==(r=null==e?void 0:e.video)?void 0:r.tagName)!=="TT-VIDEO")return null;{let r=null==(i=e.video)?void 0:i.getStats();return{code:(null==t?void 0:t.errorCode)||(null==r?void 0:r.code)||0,message:(null==t?void 0:t.errorMessage)||(null==r?void 0:r.message)||"",passive:(null==t?void 0:t.passive)||0,renderrate:(null==r?void 0:r.renderRate)||0,workercost:(null==r?void 0:r.workerCost)||0,rfps:(null==r?void 0:r.renderFps)||0,dfps:(null==r?void 0:r.decodeFps)||0,fps:(null==r?void 0:r.fps)||0,ffcost:(null==r?void 0:r.ffCost)||0,decoderate:(null==r?void 0:r.decodeRate)||0}}}function eu(e,t){let i=Math.min(e,t);return i>0?i>2160?"8K":i>1792?"4K":i>1216?"2K":i>896?"1080P":i>640?"720P":i>512?"540P":i>416?"480P":i>288?"360P":"240P":W}function ec(e){let t=0;for(let i of e)i.end<0||i.start>i.end||(t+=1e3*i.end-1e3*i.start);return Math.round(t)/1e3}function ep(e,t){return`${e}_${t}`}let ef="Operate";class em{constructor(e){this.suspendCallback=e,this.init()}reset(){this.init()}init(){this.seekCount=0,this.sat=0,this.ops=[],this.seek=this.getOperaInfo("seeked"),this.latestSeek=null,this.firstSeek=null,this.latestSwitch=this.getOperaInfo("switch"),this.firstSwitch=null,this.pauseLog={start:-1,acuTime:0,totalCount:0}}getOperaInfo(e){return{op:e,stateBefore:-1,stateAfter:-1,start:0,end:0,pos:0,inBuffer:!1,intervalId:0,readyState:-1,networkState:-1}}pushOP(e){let{ops:t}=this;t.length>10&&t.splice(0,t.length-10),t.push(e)}clearTimer(){let{seek:e}=this;e.intervalId&&(clearTimeout(e.intervalId),e.intervalId=0)}startSeekTimeout(){let{seek:e}=this;this.clearTimer(),e.intervalId=setTimeout(()=>{e.start&&this.suspendSeek("timeout","timeout"),this.clearTimer()},6e4)}startSeek(e,t){let{seek:i}=this,{readyState:r,networkState:s}=es(e);m(ef,"startSeek",`start1: ${_()-i.start} start:${i.start} currentTime:${e.currentTime} pos:${i.pos}`,r,t),i.start&&_()-i.start>6e3&&this.suspendSeek("seeking","seeking"),i.start||(i.start=_(),i.pos=e.currentTime,i.stateBefore=t,i.inBuffer=et(e.buffered,e.currentTime,1),i.readyState=r,i.networkState=s,m(ef,"startSeek",`start: ${_()-i.start} pos:${i.pos} inBuffer:${i.inBuffer}`,ee(e.buffered)),this.seekCount++,this.startSeekTimeout())}suspendSeek(e,t){let{seek:i}=this;if(!i.start)return;let r=_()-i.start;m(ef,"suspendSeek",`endType:${t} cost: ${r} inBuffer:${i.inBuffer}`);let{latestSeek:s}=this,n={costTime:r,stateBefore:i.stateBefore,stateAfter:e,start:i.start,end:_(),pos:i.pos,inBuffer:i.inBuffer,op:"seek",endType:t,interval:s?i.start-s.start:0,readyState:i.readyState,networkState:i.networkState};this.latestSeek=n,this.firstSeek||(this.firstSeek=n),this.pushOP(n),this.clearTimer(),i.start=0,i.intervalId=0,i.pos=0,i.inBuffer=!1,this.sat+=r,this.suspendCallback&&this.suspendCallback(G.ONE_OPERA,this.latestSeek)}startPause(){let{pauseLog:e}=this;m(ef,`endPause>pauseLog.start:${e.start}`),e.start<0&&(e.start=_(),e.totalCount++)}endPause(){let{pauseLog:e}=this;e.start>0&&(e.acuTime+=_()-e.start,e.start=-1,m(ef,`endPause>pauseLog.acuTime:${e.acuTime}`))}}class eg{constructor(e){this._last=e,this._current=e,this._initVal=e}set initial(e){this._initVal=e}get current(){return this._current}set current(e){let{_current:t}=this;t!==e&&(this._last=this._current,this._current=e)}get last(){return this._last}reset(){this._current=this._initVal,this._last=this._initVal}}class e_{constructor(){this.reset()}reset(){this.t=0,this.t_up=0,this.t_p=0,this.visible=!1,this.fAcc=0,this.bAcc=0,this.acc=0,this.loopAcc=0,this.accTimeupdate=0,this.accPlaying=0}update(e,t){if(this.t){m("ACC","updateACC",e,t,this.t,this.visible);let i=_()-this.t;this.acc+=i,this.t=0,this.visible?this.fAcc+=i:this.bAcc+=i,t&&(this.loopAcc=this.acc)}if(this.t_up){let e=_()-this.t_up;this.accTimeupdate+=e,this.t_up=0}if(this.t_p){let e=_()-this.t_p;this.accPlaying+=e,this.t_p=0}}start(e,t){this.t||(m("ACC","startACC",e,`readyState:${t}`,this.visible,this.t,this.t_up),this.t=_()),this.t_up||"timeupdate"!==e||(this.t_up=_(),m("ACC","startACC_Timeupdate",e,`readyState:${t}`,this.visible,this.t_up-this.t,this.t,this.t_up)),this.t_p||"playing"!==e||(this.t_p=_(),m("ACC","startACC_Playing",e,`readyState:${t}`,this.visible,this.t_p-this.t,this.t,this.t_p))}getWatchDuration(e=0){switch(m("ACC","getWatchDuration",`acc:${this.acc} accTimeupdate:${this.accTimeupdate}`),e){case 1:return this.fAcc;case 2:return this.bAcc;default:return this.acc}}getWatchDurationOffset(){return m("ACC","getWatchDurationOffset",`acc:${this.acc} accTimeupdate:${this.accTimeupdate}`),this.accTimeupdate}}function ev(){return{url:"",ip:"",host:"",resolution:"",definition:"",bitrate:0,width:0,height:0}}function ey(){return{time:0,method:"",count:0,lTime:0,lPos:-1,pos:-1,accTime:0}}function eA(){return{networkState:-1,readyState:-1,pos:-1,inBuffer:!1,start:0,end:0,startDiff:-1,endDiff:-1,rate:0,endType:W,costTime:0,endPos:-1}}var eT=((c=eT||{}).INIT="init",c[c.LOAD_START=z.LOAD_START]="LOAD_START",c[c.LOADED_METADATA=z.LOADED_METADATA]="LOADED_METADATA",c[c.LOADED_DATA=z.LOADED_DATA]="LOADED_DATA",c[c.PLAY=z.PLAY]="PLAY",c[c.PLAYING=z.PLAYING]="PLAYING",c[c.SEEKING=z.SEEKING]="SEEKING",c[c.SEEKED=z.SEEKED]="SEEKED",c[c.TIME_UPDATE=z.TIMEUPDATE]="TIME_UPDATE",c[c.CANPLAY=z.CANPLAY]="CANPLAY",c[c.ERROR=z.ERROR]="ERROR",c[c.META_READY=j.META_READY]="META_READY",c.LEAVE="leave",c.ACTIVE="active",c.FIRST_FRAME="first_frame",c.FRAME_2="frame_2",c.FRAME_5="frame_5",c.START_ERROR="start_error",c.PLAY_ERROR="play_error",c.PREPARE_BEFORE="prepare_before",c.PLAY_TIME="play_time",c.VV_TIME="vv_time",c.ENDED="ended",c);let eb=null;function eS(e,t={}){let{currentTime:i=-1,readyState:r=0,networkState:s=0,duration:n=0,buffered:a=null}=e||{};return{currentTime:i,duration:n,readyState:r,networkState:s,firstBuffer:function(e){if(!e||e.length<1)return{start:0,end:0,diff:0};let t=A(e.start(0)),i=A(e.end(0));return{start:t/1e3,end:i/1e3,diff:(i-t)/1e3}}(a),presentedFrames:0,...t}}class eE{constructor(){this.timeline=new Map,this.t=0,this._pid=""}log(e,...t){let i=g();m("TimeLine",this._pid,`[${e}][${i-this.t}]`,...t),this.t=i}set playerId(e){if("string"==typeof e&&e.length>15){let t=e.split("-");this._pid=t.length>0?t[t.length-1]:e}else this._pid=e}get playerId(){return this._pid}getExtKey(e){return e===eT.ERROR?this.get(eT.LOADED_DATA)?"play_error":"start_error":e}isTimeLineKey(e){return eb||(eb=Object.values(eT)),eb.includes(e)}add(e,t,i=!1){if(!this.isTimeLineKey(e)||(e=this.getExtKey(e),!i&&this.timeline.has(e))||e===eT.TIME_UPDATE&&!this.get(eT.LOADED_DATA))return;let{currentTime:r=0,readyState:s=0,networkState:n=0,firstBuffer:a=null,state:o}=t||{};(e===eT.SEEKING||e===eT.PLAY)&&((null==a?void 0:a.diff)||0)>=1&&[eT.LOAD_START,eT.LOADED_METADATA,eT.LOADED_DATA].forEach(e=>{this.add(e,t)});let l=g(),h=this.getIntervalTime(eT.LOAD_START,l),d=this.getIntervalTime("init",l),u=this.getIntervalTime(eT.LOADED_DATA,l),c=this.getIntervalTime("active",l);this.timeline.set(e,{key:e,time:l,timeStamp:_(),fromInit:d,fromStart:h,fromLoaded:u,fromActive:c,...t}),this.log(e,`state:${o}|readyState:${s}|networkState:${n}|fromInit:${d} fromStart:${h} fromLoaded:${u} fromActive:${c} curTime:${r}`,a)}delete(e){this.timeline.delete(e)}addByPre(e,t,i){this.get(t)&&this.add(e,i)}get(e){return this.timeline.get(e)||null}getTimeStamp(e){var t;return(null==(t=this.timeline.get(e))?void 0:t.timeStamp)||0}getTime(e){var t;return(null==(t=this.timeline.get(e))?void 0:t.time)||0}getIntervalTime(e,t){let i=this.getTime(e);return t<=0||i<=0?-1:t<i?0:t-i}getInterval(e,t){let i=this.getTime(e),r=this.getTime(t);return r<=0||i<=0?-1:r<i?0:r-i}clear(){this.t=0,this.timeline.clear()}getAll(){return this.timeline}getDurations(){return{start_error:this.getInterval(eT.LOAD_START,"start_error"),start_meta:this.getInterval(eT.LOAD_START,eT.LOADED_METADATA),meta_loaded:this.getInterval(eT.LOADED_METADATA,eT.LOADED_DATA),start_loaded:this.getInterval(eT.LOAD_START,eT.LOADED_DATA),start_fframe:this.getInterval(eT.LOAD_START,"first_frame"),loaded_error:this.getInterval(eT.LOADED_DATA,"play_error"),meta_fframe:this.getInterval(eT.LOADED_METADATA,"first_frame"),a_fframe2:this.getInterval("active","frame_2"),init_loaded:this.getInterval("init",eT.LOADED_DATA),loaded_fframe:this.getInterval(eT.LOADED_DATA,"first_frame"),playing_update:this.getInterval(eT.PLAYING,eT.TIME_UPDATE),a_update:this.getInterval("active",eT.TIME_UPDATE),a_leave:this.getInterval("active","leave"),a_seek:this.getInterval("active",eT.SEEKING),a_loaded:this.getInterval("active",eT.LOADED_DATA),a_play:this.getInterval("active",eT.PLAY),loaded_a:this.getInterval(eT.LOADED_DATA,"active"),a_ended:this.getInterval("active","ended")}}}let ek="PlayPerformance";class eP{constructor(e){this.timeline=null,this.vtype="",this.softDecodeInfo={code:0,message:""},this._reuseCount=0,this._reuseType=Q.NONE,this.userAction=null,this.timeline=e,this.switchPlayerTime=0,this._renderState=new eg(X.DEFAULT),this._reuseCount=0,this.init()}updateReuseCount(e){e!==Q.NONE&&this._reuseCount++,this._reuseType=e}get reuseCount(){return this._reuseCount}get reuseType(){return this._reuseType}get isActive(){let{current:e}=this._renderState;return e===X.ACTIVE||e===X.DEFAULT}get renderState(){return this._renderState.current}get preRenderState(){return this._renderState.last}init(){this.isMSE=!1,this.loadState=Y.INIT,this.playbackState=K.INIT,this.seeking=!1,this.ended=!1,this.paused=!1,this.duration=0,this.currentTime=new eg(0),this.playbackRate=new eg(0),this.muted=new eg(!1),this.volume=new eg(1),this.resolution=new eg(""),this.definition=new eg(W),this.bitrate=new eg(0),this.width=0,this.height=0,this.state=new eg(W),this.newTime=_(),this.startLoadTime=0,this.autoplayStart=1,this.playTime=0,this.prepareBeforePlayTime=0,this.loadedTime=0,this.bufferFinishTime=0,this.playCount=0,this.vvTime=0,this.metaTime=0,this.firstUpdateTime=0,this.autoplayTime=0,this.startPlayInfo={bufEnd:0,bufStart:0,vvBuffer:0,startPos:-1,mvt:0,loadedVT:0,updateVT:0,autoPlayVT:0,playVT:0,fplayTime:0,pos:0,loadstartT:0,msestartT:0,activeT:0,loadedT:0,dvt:0,muted:-1,cachetime:0,cachesize:0},this.leave={time:0,method:""},this.exit={time:0,method:""},this.fvt=0,this.nvt=0,this.lpt=0,this.loadvt=0,this.switchPt=0,this.userFvt=0,this.buffFinishTime=0,this.loopCount=0,this.br=ey(),this.visible="visible"===document.visibilityState,this.initialUrl=ev(),this.curUrlInfo=ev(),this.accPlayed=new e_,this.accPlayed.visible=this.visible,this.startStep=0,this.buffered={init:0,list:[],cur:{}},this.buffered=null,this.readyState=-1,this.networkState=-1,this.preloadData={size:0,time:0},this.meta={a_codec:"",v_codec:"",f_time:0}}reset(e,t=!1){m(ek,"reset",e,t,this._renderState.current),e?(this.loopCount++,this.startStep=0,this.playTime=0,this.vvTime=0,this.userAction=null,this.metaTime=0,this.firstUpdateTime=0,this.autoplayTime=0,this.bufferFinishTime=0,this.br=ey(),this.seeking=!1,this.ended=!1,this.accPlayed.reset(),this.autoplayStart=1,this.prepareBeforePlayTime=0,t||(this.startPlayInfo={bufEnd:0,bufStart:0,vvBuffer:0,startPos:0,mvt:0,loadedVT:0,updateVT:0,autoPlayVT:0,pos:0,playVT:0,fplayTime:0,loadstartT:0,msestartT:0,loadedT:0,activeT:0,dvt:0,muted:-1,cachetime:0,cachesize:0})):this.init()}setInitData(e){["playbackRate","volume","currentTime","muted"].forEach(t=>{this.change(t,e[t])})}setMeta(e){e?L(this.meta,e):this.meta={a_codec:"",v_codec:"",f_time:0,a_dur:0,v_dur:0}}setFormat(e){this.vtype=e}setUserAction(e){this.userAction=e||null}updateUrl(e){let{initialUrl:t}=this;t.url||(t.url=e.url||"",t.host=S(e.url)),e.definition&&(t.definition=e.definition),e.ip&&(t.ip=e.ip),e.bitrate&&(t.bitrate=e.bitrate)}updatePState(e,t){let{readyState:i,networkState:r}=es(e);this.readyState=i,this.networkState=r}setLoadStartTime(e){let t=_();e?(this.startLoadTime=t,this.startPlayInfo.msestartT=t,this.switchPt=this.switchPlayerTime?el(this.switchPlayerTime,this.startLoadTime):0):this.startPlayInfo.loadstartT=t}setPlayStartTime(){let{startPlayInfo:e}=this;e.fplayTime||(e.fplayTime=_(),e.playVT=this.prepareBeforePlayTime>0?_()-this.prepareBeforePlayTime:-1)}setPT(e){if(this.prepareBeforePlayTime||(this.prepareBeforePlayTime=_()),!this.isActive)return void m(ek,`setPT>${e} preparePlayTime:${this.prepareBeforePlayTime} renderState:${this.renderState}`);m(ek,`setPT>${e} playTime:${this.playTime} renderState:${this.renderState}`),this.startStep=1,this.startLoadTime||this.setLoadStartTime(!0),this.playTime||(this.playTime=_(),m(ek,"setPT",`init pt:${this.playTime}, document.visibilityState:${this.visible}`))}setVT(e,t,i){if(this.loadedTime||(this.loadedTime=_(),this.startPlayInfo.loadedVT=el(this.prepareBeforePlayTime,this.loadedTime),this.loadvt=this.loadedTime-this.startLoadTime),!this.isActive)return void m(ek,`setVT>${e} renderState:${this.renderState} return`);if(1===this.startStep){if(m(ek,`setVT>${e} renderState:${this.renderState}`),!this.vvTime){let e=_();this.vvTime=e,this.fvt=e-this.playTime,this.nvt=e-this.newTime,this.userFvt=this.switchPlayerTime>0?e-this.switchPlayerTime:this.loadvt;let{startPlayInfo:r,muted:s}=this,{start:n,end:a,endPos:o}=Z(t,0);r.bufEnd=a,r.vvBuffer=o,r.bufStart=n,r.pos=A(i),r.muted=+!!s.current;let l=this.resolution.current;l&&(this.initialUrl.resolution=l),m(ek,"setVT: firstframe inited",`vt-pt:${this.fvt} vt-nt:${this.nvt} loadvt:${this.loadvt} start:${n} end:${a} endPos:${o}`,this.startPlayInfo)}this.startStep=2}}changeRenderState(e,t){let i=this._renderState.current;i!==e&&(this._renderState.current=e);let r="statechange",{startPlayInfo:s}=this;if(m(ek,"changeRenderState setPV",`preState:${i} state:${e}`),this.isActive){let e=Z(t.buffered,t.currentTime),{bitrate:i}=this.initialUrl;this.startPlayInfo.activeT=_(),s.loadstartT&&this.setPT(r),s.cachetime=e.end,s.cachesize=e.end*i/1e3,this.loadedTime&&this.setVT(r,t.buffered,t.currentTime)}}setResolution(e){this.resolution.current=e}setMetaDataInfo(e){if(!this.metaTime){this.metaTime=_();let{startPlayInfo:t}=this;t.mvt=el(t.loadstartT,_()),t.pos=A(e),m(ek,"setMetaTime",`mvt:${t.mvt}`)}}setLoadedData(){let{startPlayInfo:e}=this,t=_();e.loadedT=t,e.dvt=t-e.loadstartT}setBreak(e,t){let{br:i}=this;i.method=e,i.time||(i.time=_(),i.pos=t),i.lTime=_(),i.count++,i.lPos=t}resetBreak(){let{br:e}=this;if(e.time){let t=_();e.accTime+=t-e.time,e.time=0}}setPreload(e){this.preloadData=e}setFirstPlayInfo(e){let{startPlayInfo:t,state:i}=this;if(this.firstUpdateTime>0||"playing"!==i.current)return;let{start:r,end:s}=Z(e.buffered,e.currentTime),n=_();this.firstUpdateTime=n,t.startPos=A(e.currentTime),t.updateVT=el(this.vvTime,n),t.autoPlayVT=el(this.autoplayTime,n),t.bufEnd=s,t.bufStart=r,m(ek,"setFirstPlayInfo",`updateVT:${t.updateVT} autoPlayVT:${t.autoPlayVT} mvt:${t.mvt} fvt: ${this.fvt} start:${r} end:${s}`,t)}updateBuffed(e,t){if(this.bufferFinishTime)return;let i=ee(e);for(let e=i.length-1;e>=0;e--)if(i[e].end>=this.duration-1){this.bufferFinishTime=_();break}}setExit(e,t){let{leave:i,exit:r}=this,{startPos:s,endPos:n,diff:a}=Z(t.buffered,t.currentTime);m(ek,"setExit",`isActive:${this.isActive}`),!this.vvTime&&this.isActive&&(i.method=e,i.time=_(),this.playTime&&(this.lpt=i.time-this.playTime)),r.method=e,r.time=_(),r.bufDiff=a,r.bufStart=s,r.bufEnd=n,r.codec=eo(t),r.ismse=+!!P(t),r.vtype=ea(t),r.endDiff=function(e){let{currentTime:t=0,duration:i=0}=e;return A(i)-A(t)}(t);let o=function(e){var t;let i=(null==(t=e.getPlugin)?void 0:t.call(e,"mp4encryptplayer"))||null;return(null==i?void 0:i.mseEndInfo)||{}}(t);o&&(r.mseEndType=o.mseEndType,r.mseEndTime=o.mseEndTime),r.host=S(er(t)),m(ek,"setExit",e,r)}updateAcc(e,t=!1){this.isActive&&this.accPlayed.update(e,t)}startAccTime(e){this.isActive&&this.accPlayed.start(e,this.readyState)}change(e,t){let i=v(e);"string"==typeof e?this[e]&&(this[e].current=t):"Object"===i&&Object.keys(e).forEach(t=>{"undefined"!==this[t]&&(this[t].current=e[t])})}changeWidthHeight(e,t){if(!e||!t)return;this.width=e,this.height=t;let{current:i}=this.resolution;i||(this.resolution.current=eu(e,t))}getWatchDuration(e=0){return this.accPlayed.getWatchDuration(e)}getWatchDurationOffset(){return this.accPlayed.getWatchDurationOffset()}getWatchDurationPlaying(){return this.accPlayed.accPlaying}setSoftDecodeInfo(e){e&&(this.softDecodeInfo={...this.softDecodeInfo,...e})}get ifFirstTimeUpdate(){return this.firstUpdateTime>0}getUserFvt(){var e,t,i,r,s;let{userAction:n,vvTime:a,timeline:o}=this,l=(null==(e=null==o?void 0:o.get(eT.ACTIVE))?void 0:e.time)||0,h=(null==(t=null==o?void 0:o.get(eT.LOAD_START))?void 0:t.time)||0,d=(null==(i=null==o?void 0:o.get(eT.LOADED_DATA))?void 0:i.time)||0,u=(null==(r=null==o?void 0:o.get(eT.FIRST_FRAME))?void 0:r.time)||0,c=(null==(s=null==o?void 0:o.get(eT.INIT))?void 0:s.time)||0,{switchTime:p=c,switchAction:f="init"}=n||{},g=0;return p>0&&a>0&&(g=Math.max(l,u||d)-p),m(ek,"getUserFvt",`activeTime:${l} startTime:${h} loadedTime:${d} firstFrame:${u} vvTime:${a}`,this.fvt,n),{costTime:T(g),fvt:this.fvt,actionType:f}}}let ew="WaitData";class ex{constructor(e){this.suspendCallback=e,this.init()}reset(){this.init()}init(){this._startTime=-1,this._realStartTime=-1,this._intervalId=0,this._tIntervalId=0,this._startPos=0,this._inBuffer=!1,this._startDiff=0,this._endDiff=0,this._playRate=-1,this.nbc=0,this.dbc=0,this.dAcuTime=0,this.nAcuTime=0,this.firstWait=eA(),this.latestWait=eA(),this.waitList=[]}_clearTimer(e){let t=this[e];t&&(clearTimeout(t),this[e]=void 0)}_startTimeout(e){this._clearTimer("_tIntervalId"),this._tIntervalId=setTimeout(()=>{this.suspendWait("timeout",e),this._clearTimer("_tIntervalId")},6e4)}_realStartWait(e){if(this._startTime>0){this._realStartTime=_();let{buffered:t,currentTime:i,networkState:r,readyState:s}=e,n=et(t,i,1);m(ew,"_realStartWait",`realStartTime:${this._realStartTime-this._startTime}
       startPos:${this._startPos} curPos:${i} isInBuf:${n}`),n?this.dbc++:this.nbc++;let a={networkState:r,readyState:s,pos:this._startPos,inBuffer:this._inBuffer,start:this._startTime,end:0,startDiff:this._startDiff,endDiff:0,rate:this._playRate,endType:W,costTime:0,interval:this.latestWait.end>0?this._startTime-this.latestWait.end:0,endPos:-1};this.latestWait=a,this.firstWait.start||(this.firstWait=a)}}startWait(e){let{readyState:t}=es(e);if(this._startTime>0||t<2)return;this._tIntervalId&&this._clearTimer("_tIntervalId"),this._startTime=_(),this._startPos=e.currentTime;let i=e?Z(e.buffered,this._startPos):null;this._inBuffer=(null==i?void 0:i.include)===1,this._startDiff=(null==i?void 0:i.diff)||0,this._playRate=e.playbackRate,m(ew,`startWait>inBuffer:${this._inBuffer} startDiff:${this._startDiff} startPos:${this._startPos} seeking:${e.seeking}`),this._intervalId=setTimeout(()=>{this._startTime>0&&(this._realStartWait(e),this._startTimeout(e)),this._clearTimer("_intervalId")},200)}suspendWait(e,t){if(this._startTime<0)return;this._clearTimer("_intervalId"),this._clearTimer("_tIntervalId");let i=_(),r=i-this._startTime;if(r=r>6e4?6e4:r,this._realStartTime<0){m(ew,`suspendWait>${e} not realStart cost:${r}`),this._startTime=-1,this._inBuffer=!1,this._startDiff=0;return}let{latestWait:s}=this;this._inBuffer?this.dAcuTime+=r:this.nAcuTime+=r;let n=t?Z(t.buffered,s.pos):null;s.endType=e,s.costTime=r,s.endDiff=(null==n?void 0:n.diff)||0,s.end=i,s.endPos=t.currentTime,m(ew,`suspendWait>inBuffer:${this._inBuffer} endDiff:${s.endDiff} startDiff:${s.startDiff} startPos:${s.pos} realCost:${r} ${e}`),this._startTime=-1,this._realStartTime=-1,this._inBuffer=!1,this._playRate=-1,this.suspendCallback&&this.suspendCallback(G.ONE_EVENT,s)}}class eC{constructor(e){this.codec_type="unknown",this.vtype="default",this.defaultBitrate=0,this.defaultDefinition="unknown",this.play_type=0,this.source_type="dir_url",this.playMode="unknown",this.vid="",this.tag="default",this.subtag="default",this.preSubtag="unknown",this.preTag="unknown",this.envInfo={},this.ext={},this.bitrateSet=null,this.volumeInfo={},this.init(e)}init(e){Object.keys(e).forEach(t=>{Object.prototype.hasOwnProperty.call(this,t)&&null!=e[t]&&(this[t]=e[t])})}reset(e){this.init(e)}}function eL(e){return e.map(e=>{if(!e)return"";if("string"==typeof e)return e;let t=[];return e.qualityType&&t.push(e.qualityType),e.format&&t.push(e.format),e.definition&&t.push(e.definition),e.gearName&&t.push(e.gearName),t.join("|")})}let eD={manifest:1e3,network:2e3,demux:3e3,remux:4e3,media:5e3,drm:7e3,other:8e3,runtime:9e3,no_error_handler:9997,custom_error:9998,notSupport:1005},eI={1:5101,2:5102,3:5103,4:5104,5:5105,6:5106};function eR(e){let t=[];return["errorMessage","message","httpCode"].forEach(i=>{void 0!==e[i]&&t.push(e[i])}),e.response&&t.push(e.response.statusText||""),t.join("_")}class eO{constructor(){this.first=null,this.latest=null,this.final=null,this.errors=[],this.count=0,this.retryCount=0}parseError(e,t){var i,r,s;let n=null;(n=e?b(t)||e.code?{code:eI[e.code]||e.code,type:eD.media,message:e.message}:{code:e.errorCode,type:function(e){let{errorType:t}=e;return eD[t]||("number"==typeof t?t:eD.media)}(e),message:eR(e)}:{code:8101,type:eD.other,message:"error_is_undefined"}).pos=e.currentTime||t.currentTime;let a=null!=e&&e.url?e.url:null!=(r=e.extra)&&r.url?null==(s=e.extra)?void 0:s.url:(null==t?void 0:t.rawSrc)||en(t,"currentSrc");n.isExpired=C(a);let{readyState:o,networkState:l}=es(t),h={...n,cdnUrl:a,cdnHost:S(a),time:_(),readyState:o,networkState:l};return this.first?h.interval=h.time-((null==(i=this.latest)?void 0:i.time)||0):(h.interval=0,this.first=h),m("ERROR","setError",h),(B.isPC&&!B.isSupportMP4||B.isSpider)&&(h.code=eI[5],h.type=eD.notSupport),h.stage=t.currentTime>0?"playing":"beforePlay",h}setError(e,t){this.count++;let i=this.parseError(e,t);this.latest=i,this.errors.length>=5&&this.errors.splice(0,1),this.errors.push(i)}setFinal(e,t){let i=this.parseError(e,t);this.final=i}get errorCodes(){let e=[];return this.errors.forEach(t=>{e.push(t.code)}),e.join(";")}reset(){this.first=null,this.latest=null,this.errors=[],this.count=0}}function eM(e,t,i,r,s){let{source_type:n,codec_type:a,preTag:o,tag:l,subtag:h,preSubtag:d,vid:u,play_type:c,envInfo:p,ext:f,playMode:m}=t,{networkState:g,readyState:v,duration:y,currentTime:T,width:S,height:k,isMSE:P,reuseType:w,vtype:x}=i,C=A(r.currentTime||T.current),L=ea(r)||x,D=eo(r)||a,I=b(r)?c+2:c,R=U.pv?U.pv:r?r.version:"",{deviceScore:O={}}=U,M={local_time:_(),player_sessionid:e,...U,...O,pv:R||W,codec_type:D,play_type:I,source_type:n,v:u,width:S,height:k,vtype:L,tag:l||W,subtag:h||m||W,pre_tag:o,pre_subtag:d,video_net_s:g,video_ready_s:v,vd:A(y),cur_play_pos:C,visible:+!!i.visible,net:navigator.onLine?"online":"offline",is_mse:+!!P,env_info:E(p),ext:E(f),player_type:s.playerType,p_index:s.pIndex||-1,ins_index:s.insIndex||-1,reuse_type:w};return delete M.deviceScore,M}let eB={player_sessionid:"play_sess",p_index:"play_order",vd:"vduration"};function eN(){return{line_app_id:0,line_user_id:"",playerCoreVersion:"",playerVersion:"",app_version:"",channel:"cn",channelDomain:"",absdkVersion:"",maxQueueCount:5,ifSendVVEnded:!1,isTask:!1,vtype:"MP4",codec_type:"",tag:"\u666E\u901A\u89C6\u9891",playType:0,sourceType:"vid",subtag:"",playMode:"",sendLocalCallback:(e,t)=>{},disableLocalCache:!1,closeResolutionLog:!1,closeSeekLog:!1,needXhrCheck:!1,trackerConfig:{},envInfo:{},ext:{},openSizeLog:!0,bitrateAdapter:{}}}class eU{constructor(){this.equalizer=null,this._data={equalizer:null}}update(e){var t;e&&(t=this._data,Object.keys(e).forEach(i=>{t[i]=e[i]}))}updateCallbackData(e){let{type:t,data:i}=e||{};if(t&&i){let e=this._data[t];this._data[t]={...e,...i}}}getStat(){let{equalizer:e}=this._data;if(e&&e.targetLoudness){let{state:t="",gainValue:i=0,error:r,enable:s,equalized:n,targetLoudness:a}=e;return{eq_state:t,eq_val:Number(i.toFixed(3)),eq_error_code:(null==r?void 0:r.code)||0,eq_error_msg:(null==r?void 0:r.message)||"",eq_status:s?n?2:1:0,eq_target:a}}return null}reset(){this._data.equalizer=null}}let eF={autoplay_started:"_onAutoPlayStart",autoplay_was_prevented:"_onAutoPlayPrevented",source_error:"_onSourceError",initialUrl:"_onInitialUrl",renderStateChange:"_onRenderStateChange",destroy:"_onPlayerDestroy",playnext:"_onPlayNext",loadstart_mse:"_onLoadstartMse",definitionChange:"_onDefiChange",beforeDefinitionChange:"_onBeforeDefiChange",definitionChangeSuccess:"_onDefiChangeSuccess",xglog_cache:"_onXgLogCache",degrade:"_onDegrade",downgrade:"_onDowngrade",exception:"_onException",ABR_CHANGE:"_onAbrChange",definitionChangeDetail:"_onDefiChangeDetail",prf_data_size:"_onPrfDataSize",media_format_error:"_onMediaFormatError",metaReady:"_onMetaReady",hitcache:"_onHitcache",strategy:"_onStrategyHandler"};function eV(e,t,i=1){if(!e||!t)return;let r=b(e),s=Object.keys(z).map(e=>z[e]),n=Object.keys(j).map(e=>j[e]);(r?s:[...s,...n]).forEach(s=>{let{handler:n,evt:a}=function(e,t){let i,r=`_on${e.charAt(0).toUpperCase()}${e.slice(1)}`;return i=t[r]?t[r]:t[eF[e]],{evt:e,handler:i}}(s,t);n&&(r?1===i?e.addEventListener(a,n):e.removeEventListener(a,n):1===i?e.on(a,n):e.off(a,n))})}function e$(e,t){e&&e instanceof HTMLVideoElement&&"requestVideoFrameCallback"in HTMLVideoElement.prototype&&e.requestVideoFrameCallback(t)}let ez=[];function ej(e,t,i){ez.push({id:e,name:t,handler:i})}function eG(e,t){let i=-1;for(let r=0;r<ez.length;r++)if(ez[r].id===e&&ez[r].name===t){i=r;break}i>-1&&ez.splice(i,1)}let eH="beforeunload",eW="visibilitychange";function eq(e,t,...i){ez.forEach(r=>{let{name:s,handler:n}=r;s===e&&n(t,...i)})}"u">typeof document&&(m("GLOBAL_EVENTS","bindGlobalEvents",B.isPC,B.isMobile,B.isPad),typeof document>"u"||(B.isPC?window.addEventListener("beforeunload",()=>{eq("beforeunload")}):(B.isMobile||B.isPad)&&window.addEventListener("pagehide",()=>{eq("beforeunload")}),document.addEventListener("visibilitychange",e=>{eq("visibilitychange",document.visibilityState)})));let eK=new class{constructor(){this._instances=0,this._pCount=0}increment(){this._instances++}incrementPlay(){this._pCount++}get instanceCount(){return this._instances}get playCount(){return this._pCount}};function eY(e){let t="";return{cdn_url:(t="Array"===v(e.url)&&e.url.length>0?e.url[0].src||"":e.url||"")||"",cdn_host:S(t)||"",cdn_ip:e.ip||""}}let eX={preload_start:"onLoadStart",preload_ended:"onLoadEnded",error:"onError",prf_data_size:"onPrfDataSize",prf_meta_ready:"onPrfMetaReady",preloadstart:"onLoadStartNew",preloadend:"onLoadEndedNew",preloadedmetadata:"onLoadMetadataNew"},eQ="MDLPreload",eJ="MDLPlayback";class eZ{constructor(e,t){this.opts=t||{openSizeLog:!0},this.suspendCallback=e,this.init()}getInitBitrate(){return{bitrate:0,aBitrate:0,cdnSize:0,cdnVSize:0,pcdnSize:0,pcdnVSize:0,definition:"",fileid:""}}init(){this.played=[],this.playedSize=0,this.cdnSize=0,this.pcdnSize=0,this.cdnVSize=0,this.pcdnVSize=0,this.lastBitrate=null,this.curBitrate=this.getInitBitrate(),this.nextBitrate=null,this.nextStart=-1,this.accDatas={cdnSize:0,cdnVSize:0,pcdnSize:0,pcdnVSize:0,playedSize:0},this.buffers=[]}reset(){this.init()}updatePlayed(e,t,i){let{played:r,curBitrate:s}=this,n=r.length,{bitrate:a,aBitrate:o}=s;if(0===t||n<1){let t=n>0?r[n-1]:null;t&&t.end<0?(t.start=e,t.bitrate=a,t.aBitrate=o):r.push({start:e,end:-1,bitrate:a,aBitrate:o})}else{let t=r[n-1];t.end=e,t.bitrate||(t.bitrate=a,t.aBitrate=o)}}calculateVideoPlaySize(){return 0}getPlayedDuration(){let{played:e}=this;return ec(e)}calculatePlaySize(){let{played:e,curBitrate:t}=this,i=ec(e),r=Math.round((t.aBitrate+t.bitrate)*i/8);return this.playedSize+=r,m(eJ,"calculatePlaySize",`duration: ${i} playedSize:${this.playedSize}`),this.played=[],this.playedSize}calculateCacheSize(){let e,{curBitrate:t,buffers:i}=this,r=(e=0,i.forEach(t=>{t.start<t.end&&(e+=t.end-t.start)}),e),s=Math.round((t.aBitrate+t.bitrate)*r/8);return this.cdnSize=s,this.cdnVSize=s,m(eJ,"calculateCacheSize",`duration: ${r} cdnSize:${this.cdnSize}`,t,i),this.buffers=[],this.cdnSize}updateAccData(){let{accDatas:e}=this;["cdnSize","cdnVSize","pcdnSize","pcdnVSize","playedSize"].forEach(t=>{e[t]+=this[t],this[t]=0})}updateBuffed(e){this.buffers=ee(e)}breakPlaybackData(e,t){P(ei(t))||this.calculateCacheSize(),this.calculatePlaySize();let{cdnSize:i,cdnVSize:r,pcdnSize:s,pcdnVSize:n,accDatas:a}=this;m(eJ,"breakPlaybackData",e,i,r,s,n,a),[i,r,s,n].filter(e=>e>0).length>0&&(this.sendMDLEvent(e,{cdnSize:i,cdnVSize:r,pcdnSize:s,pcdnVSize:n}),this.updateAccData())}getFileSize(e){let{bitrate:t,aBitrate:i}=this.curBitrate;return{audio:Math.round(e*i/8),video:Math.round(e*(t-i)/8),total:Math.round(e*t/8)}}checkNextBitrateStart(e){let{nextBitrate:t,nextStart:i}=this;i>-1&&e>=e&&t&&(this.calculatePlaySize(),m(eJ,"checkNextBitrate",e,e,this.cdnSize),t&&(this.curBitrate={...t}),this.updatePlayed(e,0),this.nextStart=-1,this.nextBitrate=null)}updateDefInfo(e,t){let{mediaType:i,start:r,bitrate:s,definition:n,fileid:a}=e;m(eJ,"updateDefInfo",t,i,e);let o=this.getInitBitrate();"audio"===i?o.aBitrate=s||0:(o.bitrate=s||0,o.definition=n,o.fileid=a,this.updateLastDefInfo(),this.nextStart=null==r?-1:r,-1===this.nextStart&&(this.curBitrate=o))}updateLastDefInfo(){let{curBitrate:e}=this;e.bitrate>0&&(this.lastBitrate={...e})}updateDownload(e){let{cdn_size:t,pcdn_size:i,mediaType:r,bitrate:s}=e,{curBitrate:n,nextBitrate:a}=this,o=t||0,l=i||0,h=0,d=0;"audio"!==r&&(h=o,d=l),this.cdnSize+=o,this.pcdnSize+=l,this.cdnVSize+=h,this.pcdnVSize+=d;let u=this.nextStart>0?a:n;u&&(u.bitrate=s||0,u.cdnSize+=o,u.pcdnSize+=l,u.cdnVSize+=h,u.pcdnVSize+=d)}sendMDLEvent(e,t){let{suspendCallback:i,opts:r}=this;if(!r.openSizeLog||!i)return;let{cdnSize:s,cdnVSize:n,pcdnSize:a,pcdnVSize:o,definition:l}=t,h={vds:s,pvds:a,vvds:n,pvvds:o,df:l,end_type:e};m(eJ,"sendMDLEvent",e,G.MDL_DATA_SIZE,h),i(G.MDL_DATA_SIZE,h)}}let e0=0,e1="Collector";class e2{constructor(e,t){this.timeline=new eE,this._onLoadstartMse=()=>{m(e1,"onLoadstartMse",this.playPerf.startLoadTime),this.playPerf.setLoadStartTime(!0),this._onLoadstart(this.player,j.LOADSTART_MSE),this.playPerf.setMeta(null)},this._onMetaReady=e=>{let{audioCodec:t,videoCodec:i,timeRange:r=[],audioDuration:s=0,videoDuration:n=0}=e;this.addTimeLinePoint(eT.META_READY),this.playPerf.setMeta({v_codec:i||"",a_codec:t||"",f_time:r.length>0?A(r[0].endTime||0):0,a_dur:s,v_dur:n})},this._onRequestVideoFrame=(e,t)=>{let{presentedFrames:i=0}=t||{};if(i>0){let e=1===i?eT.FIRST_FRAME:`frame_${i}`;this.addTimeLinePoint(e,{presentedFrames:(null==t?void 0:t.presentedFrames)||0})}if(i<5){let e=ei(this.player);e&&e$(e,this._onRequestVideoFrame)}},this._onLoadstart=(e,t="loadstart")=>{let{playPerf:i,playMDL:r,player:s,vInfo:n}=this;this.addTimeLinePoint(eT.LOAD_START,eS(this.player));let a=er(s),o=ei(this.player);o&&e$(o,this._onRequestVideoFrame);let l=t!==j.LOADSTART_MSE&&function(e){return!e||window.location.href.indexOf(e)>-1}(a);i.setLoadStartTime(t===j.LOADSTART_MSE),i.isMSE=t===j.LOADSTART_MSE||P(o),i.updateBuffed(s.buffered,t),r.updateBuffed(s.buffered),i.change("state",t),i.loadState=Y.LOADSTART,i.playbackState=K.LOADING,i.setResolution(n.defaultDefinition),i.seeking=!1,i.updatePState(s,t),m(e1,"onLoadstart",`renderState:${i.renderState} startStep:${i.startStep} readyState:${i.readyState}`),eh(s)||i.setPreload(function(e){let{plugins:t}=e||{},i={vtype:W,time:0,size:0,f_size:0,bitrate:0,codec:"UNKNOWN"};if(!t||!t.mp4encryptplayer)return i;let{preLoadData:r}=t.mp4encryptplayer;if(r){let{type:e,fileSize:t,vtype:i,codecType:s,bitrate:n,preloadTime:a,byteLength:o,definition:l}=r;return{vtype:i,time:A(a),size:o,preloadSize:o,f_size:t||0,bitrate:n,definition:l,type:e,codec:s}}return i}(s)),m(e1,"onLoadstart",`startStep:${i.startStep} isSrcEmpty:${l}`),i.setInitData(s);let h={url:a,definition:n.defaultDefinition};this.setInitialUrl(h),r.updateDefInfo(function(e,t){let{curDefinition:i,config:r}=e||{};return i&&i.bitrate?i:r&&r.defaultBitrate?{bitrate:r.defaultBitrate||0,definition:r.defaultDefinition||0}:t?{bitrate:t.defaultBitrate||0,definition:t.defaultDefinition||""}:{bitrate:0,definition:""}}(s,this.vInfo),0),0!==i.startStep||l||i.setPT(t)},this._onDurationchange=()=>{let{player:e,playPerf:t}=this;t.duration=e.duration,m(e1,"onDurationchange",e.duration)},this._onLoadedmetadata=()=>{let e=z.LOADED_METADATA,{playPerf:t,player:i,vInfo:r}=this,s=P(ei(this.player));t.loadState=Y.META,t.updatePState(i,e),t.playbackState=K.LOADED_METADATA,t.setMetaDataInfo(i.currentTime),t.isMSE=s,this.addTimeLinePoint(eT.LOADED_METADATA,eS(this.player));let n={url:er(i),definition:r.defaultDefinition};this.setInitialUrl(n),m(e1,"onLoadedmetadata",`readyState:${t.readyState}`)},this._onLoadeddata=()=>{let{playPerf:e,playMDL:t,player:i}=this,r=z.LOADED_DATA,s=ei(i),n=(null==s?void 0:s.videoWidth)||0,a=(null==s?void 0:s.videoHeight)||0;e.changeWidthHeight(n,a),e.playbackState=K.LOADED,e.change("state",r),this.addTimeLinePoint(eT.LOADED_DATA,eS(this.player)),e.loadState=Y.PLAYABLE,e.updatePState(i,r),e.updateBuffed(i.buffered,r),t.updateBuffed(i.buffered),e.setLoadedData(),e.setVT(r,i.buffered,i.currentTime),m(e1,"onLoadeddata",`readyState:${e.readyState} isMSE:${P(s)}`)},this._onCanplay=()=>{let{playPerf:e,playMDL:t,player:i}=this;m(e1,"onCanplay",`startStep:${e.startStep} vvTime:${e.vvTime} playTime:${e.playTime}`),e.playbackState=K.PLAYING,e.updatePState(i,z.CANPLAY),e.updateBuffed(i.buffered,z.CANPLAY),t.updateBuffed(i.buffered),e.setVT("canplay",i.buffered,i.currentTime)},this._onPause=()=>{let{operate:e,playPerf:t,player:i,playMDL:r}=this;i.error||(m(e1,"onPause",t.state.current),t.change({state:z.PAUSE}),t.paused=!1,t.updateAcc(z.PAUSE),r.updatePlayed(i.currentTime,1),e.startPause())},this._onPlaying=()=>{let{operate:e,playPerf:t,wait:i,player:r,playMDL:s}=this;m(e1,"onPlaying");let n=z.PLAYING;t.paused=!1,t.change("state",n),this.addTimeLinePoint(eT.PLAYING,eS(this.player)),t.startAccTime(n),t.resetBreak(),s.updatePlayed(r.currentTime,1),i.suspendWait(n,r),e.endPause()},this._onWaiting=()=>{let{playPerf:e,wait:t,player:i}=this,{ifFirstTimeUpdate:r,vvTime:s}=e,n=z.WAITING;m(e1,"onWaiting",r,s,e.renderState),!i.seeking&&r&&s&&(t.startWait(i),e.change("state",n),e.playbackState=K.WAITING),e.updatePState(i,n),e.updateAcc(z.WAITING)},this._onSeeking=()=>{let{playPerf:e,wait:t,operate:i,player:r,playMDL:s}=this,{ifFirstTimeUpdate:n,state:a,startStep:o,vvTime:l}=e;m(e1,"onSeeking",r.currentTime,`curState:${a.current} lasteState:${a.last} vvTime:${l} ended1:${r.ended} ifFirstTimeUpdate:${n}`,r.seeking,a.current!==z.ENDED||l&&n);let h=z.SEEKING;if(this.addTimeLinePoint(eT.SEEKING,{},{preKey:eT.ACTIVE}),function(e){return e!==z.ENDED&&e!==z.LOAD_START}(a.current)&&l&&n&&(e.seeking=!0,t.suspendWait(h,r),i.startSeek(r,a.current),e.change("state",h),e.playbackState=K.SEEKING),e.updatePState(r,h),0===o){e.isMSE=P(ei(this.player)),e.setResolution(this.vInfo.defaultDefinition);let t={url:er(r),definition:this.vInfo.defaultDefinition};this.setInitialUrl(t),e.setPT(h)}s.updatePlayed(r.currentTime,0)},this._onSeeked=()=>{let{player:e,playPerf:t,operate:i}=this;m(e1,"onSeeked",e.seeking,e.currentTime),t.updatePState(e,z.SEEKED),t.seeking=!1;let r=e.paused?z.PAUSE:z.PLAYING;t.change("state",r),t.playbackState=K.PLAYING,i.suspendSeek(t.state.current,z.SEEKED)},this._onProgress=()=>{let{player:e,playMDL:t,playPerf:i}=this;i.updatePState(e,z.PROGRESS),i.updateBuffed(e.buffered,z.PROGRESS),t.updateBuffed(e.buffered)},this._onSuspend=()=>{let{player:e,playPerf:t}=this;m(e1,"onSuspend"),t.updatePState(e,z.SUSPEND)},this._onVolumechange=()=>{let{muted:e,volume:t}=this.player;this.playPerf.change({muted:e,volume:t})},this._onRatechange=()=>{this.playPerf.change("playbackRate",this.player.playbackRate)},this._onEmptied=()=>{let{player:e,playPerf:t}=this;t.loadState=Y.INIT,t.updatePState(e,z.EMPTIED),t.updateBuffed(e.buffered,z.EMPTIED),m(e1,"onEmptied")},this._onStalled=()=>{let{player:e,playPerf:t}=this,i=z.STALLED;t.updatePState(e,i),"Safari"===B.name||(t.loadState=Y.STALLED,t.change("state",i)),m(e1,"onStalled")},this._onAbort=()=>{let{player:e,playPerf:t}=this,i=z.ABORT;t.updatePState(e,i),t.change("state",i),m(e1,"onAbort")},this.options=e||{},this.player=t,e0||(e0=function(){try{return parseInt(window.performance.now().toFixed(0),10)}catch{return 0}}()),this.playPerf=new eP(this.timeline),this.operate=new em((e,t)=>{this._suspendStateCallback(e,t)}),this.wait=new ex((e,t)=>{this._suspendStateCallback(e,t)}),this.vInfo=new eC(this.options.videoInfo||{}),this.error=new eO,this.extData={};let i={openSizeLog:this.options.openSizeLog},{ext:r,switchPlayerTime:s}=this.options;this.setExtData(r),this.setSwitchTime(s),this.playMDL=new eZ((e,t)=>this._suspendStateCallback(e,t),i)}_suspendStateCallback(e,t){m(e1,"_suspendStateCallback",e,t)}get performanceNow(){return e0}resetDataOnEnded(){this.reset(!0)}reset(e,t=!1){m(e1,"reset",`isEnded:${e} renderStateChange:${t}`);let{operate:i,playPerf:r,wait:s,error:n,playMDL:a}=this;i.reset(),r.reset(e,t),s.reset(),n.reset(),a.reset(),this.timeline.clear()}setSwitchTime(e){this.playPerf.switchPlayerTime=e||_()}setExtData(e={}){Object.keys(e).forEach(t=>{this.extData[t]=e[t]})}setPlayLeaveInfo(e,t){let i=e||j.RESET,r=t||q.RESET;m(e1,"setPlayLeaveInfo",e);let{playPerf:s,wait:n,operate:a,player:o}=this;s.setExit(r,o),n.suspendWait(i,o),this.addTimeLinePoint(eT.LEAVE,eS(this.player)),a.suspendSeek(s.state.current,i)}setInitialUrl(e){let{playPerf:t,vInfo:i}=this;e.definition||(e.definition=i.defaultDefinition),e.bitrate||(e.bitrate=0|i.defaultBitrate),t.updateUrl(e)}addTimeLinePoint(e,t,i){let{playPerf:r,timeline:s,player:n}=this,a=eS(n,{state:r.renderState,...t}),{preKey:o,coverable:l}=i||{};o?s.addByPre(e,o,a):s.add(e,a,l)}_onPlay(){let{playPerf:e,player:t,options:i}=this;t.error||(m(e1,"onPlay",`startStep :${e.startStep} this.ended:${e.ended}`),e.state.current===z.PAUSE&&e.playCount++,e.setPlayStartTime(),e.ended&&e.loopCount++,i.ifSendVVEnded&&e.ended&&(this.resetDataOnEnded(),e.ended=!1,e.setPT("play")),e.isActive&&e.setPT("play"))}_onEnded(){m(e1,"onEnded");let e=z.ENDED,{playPerf:t,wait:i,player:r,options:s}=this;t.ended=!0,this.addTimeLinePoint(eT.ENDED),t.change("state",e),t.updateAcc(e,!0),i.suspendWait(e,r),s.ifSendVVEnded&&t.setExit(q.ENDED,r)}_onTimeupdate(){let{playPerf:e,playMDL:t,player:i}=this;if(i.error)return;let{currentTime:r}=i;e.change({currentTime:r}),t.updatePlayed(r,1),!(e.readyState<2)&&(e.firstUpdateTime||e.setFirstPlayInfo(i),i.paused||i.ended||e.startAccTime(z.TIMEUPDATE))}_onError(e){m(e1,"onError",e);let t=z.ERROR,{playPerf:i,playMDL:r,wait:s,operate:n,error:a,player:o}=this;e||(e=this.player.error),a.setFinal(e,o),i.updatePState(o,t),i.updateBuffed(o.buffered,t),r.updateBuffed(o.buffered),i.change("state",t),i.loadState=Y.ERROR,i.playbackState=K.ERROR,i.setExit(q.ERROR,o),i.seeking=!1,i.updateAcc(t),s.suspendWait(t,o),r.breakPlaybackData(t,o),n.suspendSeek(i.state.current,t)}_onPlayCatch(e,t){let{playPerf:i,wait:r,operate:s,playMDL:n,player:a}=this,o=j.PLAY_CATCH;i.setFormat(e),i.updatePState(a,o),i.change("state",o),i.seeking=!1,i.updateAcc(o),i.setBreak(o,i.currentTime.current),r.suspendWait(o,a),n.breakPlaybackData(o,a),s.suspendSeek(i.state.current,o)}_onPlayerDestroy(){let{playPerf:e,playMDL:t,wait:i,operate:r,player:s}=this,n=j.DESTROY;e.setExit(q.DESTROY,s),e.updateAcc(n),i.suspendWait(n,s),t.breakPlaybackData(n,s),r.suspendSeek(e.state.current,n)}_onAutoPlayStart(){m(e1,"onAutoPlayStart");let{playPerf:e}=this;e.autoplayTime||(e.autoplayTime=_())}_onAutoPlayPrevented(){m(e1,"onAutoPlayPrevented");let{playPerf:e}=this;e.playbackState=K.AUTO_PLAY_PREVENTED,e.autoplayStart=0}sendEvent(e,t){}}let e4="Collector",e8=null,e5={},e3=new class e{constructor(e){this.onLoadStartNew=e=>{let{getCurrentUrl:t}=e||{},i=function(e){var t,i;if(!e)return null;let{config:r}=e,s=null==(t=null==e?void 0:e.getStats)?void 0:t.call(e),{src:n,priority:a=-1}=r,{vid:o="",definition:l="",codecType:h="",qualityType:d=0,vtype:u="",width:c=0,height:p=0,bitrate:f=0}="string"==typeof n?{}:(null==n?void 0:n.extra)||{};return{url:null==(i=null==e?void 0:e.getCurrentUrl)?void 0:i.call(e),vid:o,definition:l,qualityType:d,vtype:u,codecType:h,mediaType:"video",order:a,width:c,height:p,bitrate:f,preloadSize:(null==s?void 0:s.byteSize)||0,preloadTime:Math.round(1e3*((null==s?void 0:s.duration)||0))/1e3,errc:0,err_msg:""}}(e),r=(null==i?void 0:i.vid)||"",s=eY({url:(null==t?void 0:t())||""});m(eQ,"onLoadStartNew",r,e,i);let{data:n}=this,a=W,{width:o,height:l}=i||{};a=o&&l?eu(o,l):null==i?void 0:i.definition;let h={...n,...s,v:r,codec_type:(null==i?void 0:i.codecType)||"",vtype:(null==i?void 0:i.vtype)||"MP4",bitrate:null==i?void 0:i.bitrate,fileid:(null==i?void 0:i.fileid)||"",df:a,task_type:0,errc:0,vds:0,pvds:0,vvds:0,pvvds:0,player_type:"NEW_TT"};this.vid=r,this.data=h,this.meta={a_codec:"",v_codec:""},this.startTime=_(),this.state="start"},this.onLoadStart=e=>{m(eQ,"onPreloadStart",e.cacheKey,e);let{codecType:t,vtype:i,vid:r,width:s,height:n,bitrate:a,file_id:o,definition:l,type:h}=e,{data:d}=this,u=eY(e),c=W;c=s&&n?eu(s,n):l;let p={...d,...u,v:r,codec_type:t,vtype:i,bitrate:a,fileid:o||"",df:c,task_type:null==h?-1:h,player_type:"XG"};this.vid=r,this.data=p,this.meta={a_codec:"",v_codec:"",f_time:0,f_size:0},this.startTime=_(),this.state="start",m(eQ,"onPreloadStart",r,this.data)},this.onLoadEndedNew=e=>{m(eQ,"onLoadEndedNew",e);let{getCurrentUrl:t,getStats:i,error:r}=e,s=eY({url:t()}),n=i(),a=_()-this.startTime,o=n.byteSize,l=y(n.duration,2),{data:h}=this;r&&(h.errc=r.code||-1,h.err_msg=r.message),h.cdn_url=s.cdn_url,h.cdn_host=s.cdn_host,h.isexpired=C(s.cdn_url),h.cost_time=a,h.vpls=o,h.vplt=l,h.vvds=o,h.vds=o,m(eQ,"onLoadEndedNew END",h),this.sendMDLEvent("loadended",h),this._reInit()},this.onLoadEnded=e=>{if(m(eQ,"onPreloadEnded",e.cacheKey,e),this.vid&&this.vid===e.vid){let t=eY(e),i=_()-this.startTime,r=this.data.vds;this.setMetaFirst(e);let s={...this.data,vplt:y(e.preloadTime,2),vpls:r||e.preloadSize,cost_time:e.costTime||i,bitrate:e.bitrate,fileid:e.file_id||"",isexpired:C(t.cdn_url)};m(eQ,"onPreloadEnded1",e.cacheKey,s),this.sendMDLEvent("loadended",s)}else console.warn(eQ,"onLoadEnded","cacheKey_not_match",this.vid,e.cacheKey);this._reInit()},this.onError=e=>{if(m(eQ,"onError",this.data,e),this.vid){let{context:t}=e,i=_()-this.startTime,r=t?eY(t||{}):null,s={...this.data,errc:e.errorCode||-1,err_msg:eR(e),cost_time:e.costTime||i,fileid:e.file_id||"",isexpired:C((null==r?void 0:r.cdn_url)||this.data.cdn_url),...r};m(eQ,"loaderror",JSON.stringify(s),e.code,e.message),this.sendMDLEvent("loaderror",s)}this._reInit()},this.onPrfDataSize=e=>{if(this.vid){let{cdn_size:t,pcdn_size:i,mediaType:r}=e,{data:s}=this,n=t||0,a=i||0,o=0,l=0;"audio"!==r&&(o=n,l=a),s.vds+=n,s.pvds+=a,s.vvds+=o,s.pvvds+=l}this.state="load"},this.onLoadMetadataNew=e=>{m(eQ,"onLoadMetadataNew",e);let{tracks:t=[]}=e;t.forEach(e=>{"audio"===e.type?this.meta.a_codec=e.codec:this.meta.v_codec=e.codec})},this.onPrfMetaReady=e=>{this.setMetaFirst(e)},this.eventCallback=e,this.init()}init(){this.emptyCount=0,this.data=this.getInitData(),this.vid="",this.extData={tag:W,subtag:W,preSubtag:W,preTag:W,pIndex:-1,insIndex:-1,log_id:"",isMSE:!1,player_type:"",ext:{}},this.meta={a_codec:"",v_codec:"",f_time:0,f_size:0},this.state="init"}getInitData(){return{codec_type:W,v:"",vtype:W,errc:0,err_msg:"",vplt:0,vpls:0,vds:0,pvds:0,vvds:0,pvvds:0,cdn_host:"",cdn_ip:"",cost_time:0,df:W,bitrate:0,fileid:"",task_type:-1,isexpired:0}}_reInit(){this.vid="",this.startTime=0,this.data=this.getInitData(),this.state="suspend"}setMetaFirst(e){let{mediaSegList:t=[],meta:i}=e||{},{timeRange:r=[],totalRange:s=[]}=t.length>0?t[0]:{timeRange:[],totalRange:[]};this.meta.f_size=s.length>1?s[1]:0,this.meta.f_time=r.length>1?A(r[1]):0,this.meta.v_codec=(null==i?void 0:i.videoCodec)||"",this.meta.a_codec=(null==i?void 0:i.audioCodec)||""}reset(){this.init()}setExtData(e){e&&L(this.extData,e)}attach(e){this.preload!==e&&(m(eQ,"attach"),this.preload&&this.detach(),this.preload=e,Object.keys(eX).forEach(e=>{this.preload.on(e,this[eX[e]])}))}detach(){m(eQ,"attach "),this.preload&&Object.keys(eX).forEach(e=>{this.preload.off(e,this[eX[e]])}),this.reset(),this.preload=null}sendMDLEvent(e,t){var i,r;let{eventCallback:s,extData:n}=this,a={...U,...t,task_type:function(e){switch(e){case 0:return"duration";case 1:return"size";default:return W}}(t.task_type),empty_c:0,tag:n.tag||W,subtag:n.subtag||W,pre_tag:n.preTag||W,pre_subtag:n.preSubtag||W,p_index:n.pIndex,ins_index:n.insIndex,is_mse:+!!n.isMSE,meta:E(this.meta),ext:E({log_id:(null==(i=n.ext)?void 0:i.log_id)||"",is_ad:(null==(r=n.ext)?void 0:r.is_ad)||0})};m(eQ,"sendMDLEvent",e,G.MDL_PRELOAD,a),s&&s(G.MDL_PRELOAD,a)}}((e,t)=>{e8&&e8.event(e,t)}),e6=null;class e9 extends e2{constructor(e,t){if(super(function(e){let t=eN();return Object.keys(e).forEach(i=>{t[i]=e[i]}),t}(e),t),this.pIndex=0,this.insIndex=0,this._onTimeupdate=()=>{let{playPerf:e}=this;e.isActive&&e.readyState>2&&!this.timeline.get(eT.TIME_UPDATE)&&this.addTimeLinePoint(eT.TIME_UPDATE,{},{preKey:eT.LOADED_DATA}),super._onTimeupdate()},this._onPlay=()=>{let{ended:e,state:t,isMSE:i,isActive:r}=this.playPerf;e&&(this.isSendOnePlay=!1),r&&(this.addTimeLinePoint(eT.PLAY,{},{preKey:eT.ACTIVE}),e3.setExtData({isMSE:i,pIndex:this.pIndex,insIndex:this.insIndex})),super._onPlay(),m(e4,"onPlay",t.current,t.last)},this._onEnded=()=>{super._onEnded();let{ifSendVVEnded:e}=this.options;this.playPerf.setSoftDecodeInfo(ed(this.player)),e&&this._trackOnePlay("ended")},this._onError=e=>{super._onError(e);let{final:t}=this.error,{playPerf:i}=this;if(m(e4,"onError",e,t),!("dash"===this.player.type&&this.player.replayRunning)){if(i.playTime||i.setPT("error"),(null==t?void 0:t.code)===eI[5]){this._trackOneError("error",t),this.isSendOnePlay=!0;return}this.playPerf.setSoftDecodeInfo(ed(this.player)),this._trackOneError("error",t),this._trackOnePlay("error",t)}},this._onPlayerDestroy=()=>{super._onPlayerDestroy();let{playTime:e}=this.playPerf;this.playPerf.setSoftDecodeInfo(ed(this.player)),m(e4,"onPlayerDestroy",this.sessionId,e),this._trackOnePlay("player_destroy"),this.reset(!1),this._unBindEvt()},this._onStrategyHandler=e=>{m(e4,"onStrategyHandler",e.type,e),this.strategyData.updateCallbackData(e)},this._onPlayNext=()=>{var e,t,i,r;m(e4,"onPlayNext1",this.sessionId,(null==(t=null==(e=this.player)?void 0:e.getCore)?void 0:t.call(e))||B.isIOS),(null!=(r=null==(i=this.player)?void 0:i.getCore)&&r.call(i)||B.isIOS)&&(m(e4,"onPlayNext",this.sessionId),this._onPlayerReset("next"))},this._onPlayerReset=e=>{let{playPerf:t}=this;m(e4,"onPlayerReset",this.sessionId,`type:${e} playTime:${t.playTime}`),this.playMDL.breakPlaybackData(q.RESET,this.player),t.updateAcc("reset"),this.playPerf.setSoftDecodeInfo(ed(this.player)),t.playTime>0&&(this.setPlayLeaveInfo(j.RESET,q.RESET),this._trackOnePlay(e||j.RESET)),this.reset(!1)},this._onAutoPlayStart=()=>{super._onAutoPlayStart()},this._onAutoPlayPrevented=()=>{super._onAutoPlayPrevented()},this._onVisibilityChange=e=>{m(e4,"onVisibilityChange",e);let{playPerf:t}=this;t.visible="visible"===e,t.updateAcc("visible",!1)},this._onInitialUrl=e=>{m(e4,"onInitialUrl",e),this.setInitialUrl(e)},this._onRenderStateChange=e=>{let{playPerf:t,player:i}=this,r="statechange";e.state===t.renderState||e.state===X.DESTROY||(m(e4,"_onRenderStateChange1",this.playerId,_(),t.renderState,e.state),t.renderState===X.ACTIVE&&(e.state===X.RETAIN||e.state===X.RELEASE)?(t.setExit(r,i),t.updateAcc(r),this.setPlayLeaveInfo(r),this.playPerf.setSoftDecodeInfo(ed(this.player)),this._trackOnePlay(r),this.reset(!1,e.state!==X.RELEASE)):e.state===X.ACTIVE&&this.addTimeLinePoint(eT.ACTIVE),function(e,t){return e===X.RELEASE&&(t===X.BACKUP||t===X.ACTIVE)}(t.renderState,e.state)&&this.addTimeLinePoint(eT.INIT),t.switchPlayerTime=_(),t.changeRenderState(e.state,i))},this._onBeforeDefiChange=e=>{m(e4,"onBeforeDefinitionChange",e)},this._onDefiChange=e=>{m(e4,"onDefinitionChange",e)},this._onDefiChangeSuccess=()=>{m(e4,"onDefiChangeSuccess")},this._onDefiChangeDetail=e=>{m(e4,"onDefiChangeDetail",e);let{playMDL:t,player:i}=this;t.updateDefInfo(e,i.currentTime);let{lastBitrate:r}=t;r&&e.mediaType},this._onPrfDataSize=e=>{this.playMDL.updateDownload(e)},this._onXgLogCache=()=>{let e=function(e){return(null==e?void 0:e.logCache)||(null==e?void 0:e.getLogCache)}(this.player);e&&(this.templog={vtype:ea(this.player),log:e})},this._onSourceError=e=>{m(e4,"onSourceError",e);let{playPerf:t}=this;t.setFormat(ep(this.vInfo.vtype,J.STAGE_1)),this.breakPlayback(e,"SourceError")},this._onPlayCatch=(e,t)=>{m(e4,"onPlayCatch",e,t);let i=t?t.message:"";if(!t||"MP4_0"===e&&"no preload"===i)return;let{playPerf:r}=this;super._onPlayCatch(e,t);let{initialUrl:s}=r;k(t.url)&&(t.url=s.url);let n=q.PLAY_CATCH;this.breakPlayback(t,n)},this._onDegrade=e=>{(null==e?void 0:e.mediaType)==="tt-video"&&super._onPlayCatch("MP4_MSE_SOFT_1",e);let t=q.DEGRADE,{playPerf:i}=this,{initialUrl:r}=i;k(e.url)&&(e.url=r.url),i.setSoftDecodeInfo(ed(this.player,e)),this.breakPlayback(e,t),m(e4,"onDegrade",e)},this._onDowngrade=e=>{if(m(e4,"_onDowngrade",eh(this.player),e),!eh(this.player))return;let{timeline:t,playPerf:i}=this,r=t.getTime(eT.LOADED_DATA),s="";s=r<=0?ep(this.vInfo.vtype,J.MSE_1):ep(this.vInfo.vtype,J.MSE_2),i.setFormat(s),this.breakPlayback(e,"downgrade")},this._onException=e=>{if(m(e4,"_onException",eh(this.player),e),!eh(this.player))return;let{playPerf:t}=this,i=ep(this.vInfo.vtype,J.STAGE_1);t.setFormat(i),this.breakPlayback(e,"exception")},this._onAbrChange=()=>{m(e4,"onAbrChange")},this._onMediaFormatError=e=>{m(e4,"onMediaFormatError",e)},this._onPageUnload=()=>{let{playTime:e}=this.playPerf;if(m(e4,"onPageUnload",this.sessionId,e),e>0){let e=q.PAGE_UNLOAD;this.setPlayLeaveInfo(e,e),this.playMDL.breakPlaybackData(e,this.player),this.playPerf.setSoftDecodeInfo(ed(this.player)),this._trackOnePlay(q.PAGE_UNLOAD)}},this._onHitcache=e=>{if(m(e4,"_onHitcache",this.sessionId,e),!e)return;let{playPerf:t}=this;t.setPreload({vtype:e.vtype||"MP4",codec:e.codec,time:e.duration,size:e.dataSize,preloadSize:e.preloadSize,cacheSize:e.cacheSize,type:e.hitType,bitrate:e.bitrate,definition:e.definition})},this.strategyData=new eU,!e||!e.line_app_id)return void console.warn("player.config.vodLogOpts.line_app_id is necessary for plugin xgVodLogger");this.isSendOnePlay=!1,this.sessionId="",this.init(e),this.player&&(this._bindEvt(this.player),this.timeline.playerId=this.player.uuid||this.player.playerId),eK.increment(),this.insIndex=eK.instanceCount,this.addTimeLinePoint(eT.INIT)}static get version(){return D}static get preloadMDL(){return e3}static setCustomTracker(e){m(e4,"setCustomTracker",e),e6=e}static set Tracker(e){e8=e}static get Tracker(){return e8}static sendEvent(e,t){e8&&e8.event(e,t)}static setPlayerPool(e,t){e5[e]=t}static set commonData(e){$(e)}static set TEA_ID(e){V=e,F=`__tea_cache_tokens_${V}`}static get TEA_ID(){return V}static set AB_SDK_VERSION(e){U.absdkVersion=Array.isArray(e)?e.join(","):e}static get AB_SDK_VERSION(){return U.absdkVersion}static attachPreloader(e){e3.attach(e)}static detachPreloader(){e3.detach()}static get defaultConfig(){return eN()}get preloadMDL(){return e3}get playerId(){var e;return(null==(e=this.player)?void 0:e.playerId)||this.vInfo.vid}init(e){m(e4,"init",e);let t=this.options||{};Object.keys(e).forEach(i=>{t[i]=e[i]});let i={...e.trackConfig};["referrer","channel","channel_domain"].forEach(t=>{void 0!==e[t]&&(i[t]=e[t])}),e.channelDomain&&(i.channel_domain=e.channelDomain),e8&&e8.config(i),this.initSessionId(),this.update(e,Q.NONE)}update(e,t=Q.NONE){$(e),eK.incrementPlay(),this.pIndex=eK.playCount,this.vInfo.init(e);let{ext:i={},switchPlayerTime:r}=e;this.setExtData(i),r&&this.setSwitchTime(r),e3.setExtData(e),this.addTimeLinePoint(eT.INIT),this.playPerf.updateReuseCount(t),this.playPerf.setFormat(this.vInfo.vtype),this.playPerf.setUserAction(e.userAction),this.strategyData.update(e.strategy)}set reuseType(e){this.playPerf.updateReuseCount(e)}initSessionId(){if(this.sessionId)return;let e="0";try{e=function(e){if(!window.localStorage)return"";let t=window.localStorage.getItem(e)||"";try{return JSON.parse(t)}catch{return t}}(F).web_id||"0"}catch{e="0"}this.sessionId=function(e){let t="0";try{let i=window.localStorage.getItem(e)||"",r=JSON.parse(i);t=(null==r?void 0:r.web_id)||"0"}catch{t="0"}var i=t;let r=new Date().getTime(),s=0;try{s=parseInt(i)}catch{s=0}return r+=s,window.performance&&"function"==typeof window.performance.now&&(r+=window.performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){let t=(r+16*Math.random())%16|0;return r=Math.floor(r/16),("x"===e?t:3&t|8).toString(16)})}(e),m(e4,`sessionId webId:${e} ${this.sessionId}`)}attachPlayer(e){e!==this.player&&(this.detachPlayer(this.player),this.player=e,this.player.version&&(U.pv=this.player.version),this._bindEvt(e),this.timeline.playerId=this.player.uuid||this.player.playerId);let t=null==e?void 0:e.preloader;t&&e3.attach(t)}detachPlayer(e){this.player&&e===this.player&&(this._unBindEvt(),this.player=null)}resetConfig(e){m(e4,"reset",e)}reset(e,t=!1){super.reset(e,t),this.strategyData.reset(),this.isSendOnePlay=!1}destroy(){let{operate:e,playPerf:t,playMDL:i,wait:r,error:s,player:n,strategyData:a}=this;m(e4,"destroy",this.sessionId);let o="log_destroy";t.setExit(q.LOG_DESTROY,n),t.updateAcc(o),i.breakPlaybackData(o,n),this._trackOnePlay(o),e.reset(),t.reset(!1),r.reset(),s.reset(),i.reset(),a.reset(),this.detachPlayer(this.player)}getTokenFromTracker(){return e8?e8.getToken():{}}breakPlayback(e,t){let{error:i,playPerf:r,wait:s,playMDL:n}=this;i.setError(e,this.player);let a=r.ifFirstTimeUpdate&&r.vvTime;m(e4,"breakPlayback",a,t,e),a&&(r.seeking=!1,r.setBreak(t,r.currentTime.current),r.updateAcc(t),s.suspendWait(t,this.player),n.breakPlaybackData(t,this.player),this._trackOneError(t,i.latest))}_bindEvt(e){e&&(ej(this.sessionId,eW,this._onVisibilityChange),ej(this.sessionId,eH,this._onPageUnload),eV(e,this,1))}_unBindEvt(){let{player:e}=this;e&&(eV(e,this,2),eG(this.sessionId,eW),eG(this.sessionId,eH))}_suspendStateCallback(e,t){if(!(!e||!t))switch(m(e4,"_suspendStateCallback",e,t),e){case G.ONE_EVENT:this._trackOneEvent("wait",t);break;case G.ONE_OPERA:this._trackOneOpera(t);break;case G.MDL_DATA_SIZE:this._trackMdlVideoSize(t)}}_trackOnePlay(e,t){let{playPerf:i}=this;if(this.isSendOnePlay||!i.playTime)return void m(e4,this.playerId,`_trackOnePlay_${e} isSendOnePlay:${this.isSendOnePlay} renderState:${i.renderState} reuseType: ${i.reuseType} pt:${i.playTime}`);this.addTimeLinePoint(eT.LEAVE);let r=function(e,t,i){var r,s;let{vInfo:n,playPerf:a,playMDL:o,wait:l,operate:h,error:d,player:u,sessionId:c,extData:p,performanceNow:f,options:m,timeline:g,pIndex:_,insIndex:v,strategyData:T}=e,{bitrateAdapter:b={},playerType:S="default"}=m,k=eM(c,n,a,u,{playerType:S,pIndex:_,insIndex:v}),P=e.getPlayerPoolStats(),{url:w,host:x,ip:L,bitrate:D}=a.initialUrl,{leave:I,exit:R,playTime:O,vvTime:M,newTime:B,volume:N,muted:U,playbackRate:F,bufferFinishTime:V,preloadData:$,br:z,resolution:j,startLoadTime:G,width:H,height:W,switchPt:q,meta:K,startPlayInfo:Y,autoplayStart:X,softDecodeInfo:Q}=a,J=a.getUserFvt(),{seekCount:Z,sat:ee,pauseLog:et}=h,{playedSize:er,cdnSize:es,cdnVSize:en,pcdnSize:ea,pcdnVSize:eo}=o.accDatas,{firstWait:eh}=l,{errors:ed}=d,eu=d.first,ec=a.getWatchDuration(),ep=a.getWatchDurationOffset(),ef=a.getWatchDurationPlaying(),em=function(e){if(!e||!e.pcdnVVStat)return{};{let t=e.pcdnVVStat;return{try_req:t.try_req_num,req_succ:t.req_node_succ,has_ret:t.has_ret_node,conn_ret:t.conn_ret_num,conn_fail:t.conn_fail_num,conn_jump:t.conn_jump_num}}}(u),eg=u&&u.performance||{},e_=function(e){let t=ei(e),i={total:0,dropped:0,drop_rate:0};try{let e=null==t?void 0:t.getVideoPlaybackQuality();return i.dropped=(null==e?void 0:e.droppedVideoFrames)||0,i.total=(null==e?void 0:e.totalVideoFrames)||0,i.total>0&&(i.drop_rate=y(i.dropped/i.total*100)),i}catch{return i}}(u),{bitrateSet:ev}=n,ey=function(e){let{h264:t=[],h265:i=[],dash:r,audio:s,default:n}=e||{},a={h1:t.length,h2:i.length,set1:eL(t),set2:eL(i)};return n&&(a.def=`${n.qualityType}|${n.gearName}`),r&&r.length>0&&(a.h_dash=r.length),s&&s.length>0&&(a.audio=eL(s),a.h3=s.length),a}(ev),eA=g.getDurations();return{...k,perf_time:f,prepare_start_time:0,prepare_end_time:0,initial_url:w||"",initial_host:x,initial_ip:L,isexpired:C(w),width:H,height:W,initial_resolution:a.initialUrl.resolution,nt:B,pt:O,vt:M,fvt:el(O,M),svt:el(G,M),nvt:M>0?M-B:O-B,user_fvt:(null==J?void 0:J.costTime)||0,action_type:(null==J?void 0:J.actionType)||"",switch_pt:q,player_created_t:B,lt:I.time,lpt:a.lpt,et:R.time,lv_method:R.method,bft:V,volume:y(N.current,2),mute:+!!U.current,play_speed:F.current,sc:Z,sat:ee,dbc:l.dbc,nbc:l.nbc,bc:l.dbc+l.nbc,bu_acu_t:l.dAcuTime+l.nAcuTime,de_bu_acu_t:l.dAcuTime,n_bu_acu_t:l.nAcuTime,pause_acu_t:et.acuTime,start_time:A(a.startPlayInfo.startPos||0),finish:a.ended||a.loopCount>0?1:0,lc:a.loopCount,watch_dur:ec,watchDur_t:ep,watchDur_p:ef,is_start_play_automatically:X,first_buf_startt:eh.start,first_buf_endt:eh.end,play_c:a.playCount,load_state:a.loadState,playback_state:a.playbackState,pcdn:E(em),pre_info:E($),perf:E(eg),frame_info:E(e_),br:z.count,fbrt:z.time,accu_br:z.accTime,df:j.current,lf:j.last,bitrate:D,errc:i?i.code:0,errt:i?i.type:0,vsc_message:i?i.message:"",fir_errc:eu?eu.code:0,fir_errt:eu?eu.type:0,accu_errc:d.count||0,merror:E(ed),end_type:t,vps:er,vds:es,pvds:ea,vvds:en,pvvds:eo,vplt:$.time,vpls:$.size||0,cache_s:$.cacheSize||0,cache_t:$.type,ext:E(p),bitset:E(ey),meta:E(K),exit:E(R),start_info:E(Y),rstate:a.renderState,pre_rstate:a.preRenderState,prepare_before_play_t:a.prepareBeforePlayTime,user_resolution:b.userResolution||"auto",quality_type:b.qualityType||0,selector:b.selector||"default",...Y,...eA,timeline:E(eA),loudness:(null==(r=n.volumeInfo)?void 0:r.loudness)||0,peak:(null==(s=n.volumeInfo)?void 0:s.peak)||0,soft_info:E(Q),session_cnt:(null==P?void 0:P.totalCount)||0,crosstalk_count:(null==P?void 0:P.playCount)||0,strategy_stats:T.getStat()||""}}(this,e,t);m(e4,this.playerId,r.v,`_trackOnePlay_${e}`,`renderState:${i.renderState} reuseType: ${i.reuseType} fvt:${r.fvt} vplt:${r.vplt} vpls: ${r.vpls} vid:${r.v}`,r.codec_type,r,this.timeline.getDurations()),this.isSendOnePlay=!0,this.sendEvent(G.ONE_PLAY,r)}_trackOneEvent(e,t){let{closeEvents:i=[]}=this.options;if(i.includes(G.ONE_EVENT))return;let r=function(e,t,i){let{vInfo:r,playPerf:s,operate:n,player:a,sessionId:o,pIndex:l,insIndex:h}=i,{playerType:d="default"}=i.options,u=eM(o,r,s,a,{pIndex:l,insIndex:h,playerType:d}),{playbackRate:c,firstUpdateTime:p,softDecodeInfo:f}=s,{latestSeek:m,latestSwitch:g}=n,{endDiff:_=-1,startDiff:v=-1}=t,y=i.getPlayerPoolStats();return{...u,event_type:e,cost_time:t.costTime,end_type:t.endType,first_frame_interval:w(p,t.start),last_seek_interval:m?w(m.start,t.start):0,last_switch_interval:g?w(g.start,t.start):0,last_event_interval:t.interval,video_pos:A(t.pos),play_speed:c.current,st:t.start,et:t.end,e_buf:_,s_buf:v,rstate:s.renderState,pre_rstate:s.preRenderState,prepare_before_play_t:s.prepareBeforePlayTime,soft_info:E(f),session_cnt:(null==y?void 0:y.totalCount)||0,crosstalk_count:(null==y?void 0:y.playCount)||0}}(e,t,this);m(e4,`_trackOneEvent_${e}`,t,r),this.sendEvent(G.ONE_EVENT,r)}_trackOneOpera(e){let{closeEvents:t=[]}=this.options;if(t.includes(G.ONE_OPERA))return;let i=e.op,r=function(e,t,i){let{vInfo:r,playPerf:s,player:n,sessionId:a,pIndex:o,insIndex:l}=i,{playerType:h="default"}=i.options,d=eM(a,r,s,n,{playerType:h,pIndex:o,insIndex:l}),u=i.getPlayerPoolStats();return{...d,opera_type:e,end_type:t.endType,state_before:t.stateBefore,state_after:t.stateAfter,cost_time:t.costTime,is_seek_in_buffer:+!!t.inBuffer,last_interval:t.interval,video_pos:A(t.pos),cdn_url:"",cdn_ip:"",rstate:s.renderState,pre_rstate:s.preRenderState,prepare_before_play_t:s.prepareBeforePlayTime,session_cnt:(null==u?void 0:u.totalCount)||0,crosstalk_count:(null==u?void 0:u.playCount)||0}}(i,e,this);m(e4,`_trackOneOpera_${i}`,e,r),this.sendEvent(G.ONE_OPERA,r)}_trackOneError(e,t){if(!t)return;let i=function(e,t,i=""){let{error:r,vInfo:s,playPerf:n,player:a,sessionId:o,extData:l,timeline:h,pIndex:d,insIndex:u}=t,{playerType:c="default"}=t.options,p=eM(o,s,n,a,{playerType:c,pIndex:d,insIndex:u}),{resolution:f}=n.initialUrl,m=r.errorCodes,g=h.getDurations(),_=t.getPlayerPoolStats();return{...p,errt:e.type,errc:e.code,err_msg:e.message,cdn_url:e.cdnUrl,cdn_host:e.cdnHost,cdn_ip:e.cdnIp,es:e.stage||"",isexpired:e.isExpired,resolution:function(e){try{return e.toString()}catch{return""}}(f),end_type:i,last_errors:m,retry_count:r.retryCount,ext:E(l),rstate:n.renderState,pre_rstate:n.preRenderState,prepare_before_play_t:n.prepareBeforePlayTime,timeline:E(g),soft_info:E(n.softDecodeInfo),session_cnt:(null==_?void 0:_.totalCount)||0,crosstalk_count:(null==_?void 0:_.playCount)||0}}(t,this,e);m(e4,`_trackOneError_${e}`,t,i),this.sendEvent(G.ONE_ERROR,i)}_trackMdlVideoSize(e){let t=function(e,t){let{vInfo:i,playPerf:r,player:s,sessionId:n,pIndex:a,insIndex:o}=e,{playerType:l="default"}=e.options;return{...eM(n,i,r,s,{playerType:l,pIndex:a,insIndex:o}),...t,rstate:r.renderState,pre_rstate:r.preRenderState,prepare_before_play_t:r.prepareBeforePlayTime}}(this,e);m(e4,`_trackMdlVideoSize${e.end_type}`,t),this.sendEvent(G.MDL_DATA_SIZE,t)}sendEvent(e,t){if(m(e4,"sendEvent",`eventName:${e} extNAme:${H[e]}`),e8&&e8.event(e,t),e6){let i=H[e];i&&e6.event(i,function(e){let t={...e};try{return delete t.line_user_id,delete t.deviceScore,delete t.ua,delete t.absdkVersion,Object.keys(eB).forEach(e=>{t[eB[e]]=t[e],delete t[e]}),t}catch{return t}}(t))}}getFinalInfo(){var e,t;let{error:i,playPerf:r,vInfo:s,player:n}=this;return{vt:r.vvTime,pt:r.playTime,currentTime:n.currentTime,firstframeDuration:r.fvt,errorCode:(null==(e=i.latest)?void 0:e.code)||0,errorMessage:(null==(t=i.latest)?void 0:t.message)||"",isFinish:+(r.loopCount>0),codecType:s.codec_type,resolution:r.resolution.current,url:r.initialUrl.url}}getPlayerPoolStats(){var e,t;let{playerType:i}=this.options;return i&&(null==(t=null==(e=e5[i])?void 0:e.getStats)?void 0:t.call(e))||null}setUserAction(e){var t;null==(t=this.playPerf)||t.setUserAction(e)}}let e7="XGTracker",te="__xgplayer_vod_log__",tt={appId:548444,_tt:{user_unique_id:""},_tracker:null,_options:{},init(e,t,i){var r,s,n;if((t.appId||t.app_id)&&(this.appId=t.appId||t.app_id),this._options=t,!M)return;m(e7,"init",this.appId,t);let a=window[te];!a&&e?(this._tracker=new e("xgplayer_tracker"),window[te]=this._tracker):this._tracker=a;let{channel:o,channel_domain:l}=t,h={app_id:this.appId,log:!1,disable_sdk_monitor:!0,enable_ab_test:!1,disable_auto_pv:!0,...t,channel:o||"cn",channel_domain:l};return null==(r=this._tracker)||r.init(h),null==(s=this._tracker)||s.getToken(e=>{this._tt=e}),this.config(i||{}),null==(n=this._tracker)||n.start(),this._tracker},config(e={}){let t={...e};B&&B.name&&!B.isChrome&&!B.isSafari&&(t.browser=B.name,B.appVersion&&(t.browser_version=B.appVersion));let i=e.user_unique_id||"";i&&(t.user_unique_id=i,t.web_id=i,t.device_id=i,t.user_id=e.user_id||i,this._tt={user_unique_id:i,user_id:e.user_id||i}),e.referrer&&(t.referrer=e.referrer,t.referrer_host=S(e.referrer)),this._tracker&&this._tracker.config(t)},getToken(){return this._tt},event(e,t){let{appId:i,_tracker:r,_tt:s}=tt;m(e7,`sendEvent_${i}`,!r,e,t),r&&(t.line_user_id||(t.line_user_id=(null==s?void 0:s.user_unique_id)||""),"function"==typeof r?r(e,t):r.event(e,t))}};e9.Tracker=tt;let ti=function(e){if(e&&e.player){let t=e.player.config.vodLogOpts||{};e.player.vodLogger=new e9(t,e.player),e.player.plugins.xgVodLogger=e.player.vodLogger}else this.vodLogger=new e9(this.config.vodLogOpts||{},this)};ti.initTracker=function(e,t={}){tt.init(e,t)},ti.configTracker=function(e){tt.config(e)},ti.pluginName="__xgVodLogger",ti.playerConfig={},ti.setABSdkVersion=e=>{e9.AB_SDK_VERSION=e}},10067:function(e,t,i){"use strict";let r,s,n;i.d(t,{Mk:function(){return v},Xi:function(){return m},n9:function(){return u},rE:function(){return w},yC:function(){return P}});var a=i(55651),o=i(37634),l=i(64455);let h="ttplayer-poster";class d{constructor(e){this.__timer=-1,this.__faded=!1,this.__src="",this.__objectFit="contain",this.visible=!1;let t=document.createElement("div");t.className=h,this.__el=t,this.src=e}get src(){return this.__src}set src(e){this.__src=e,this.__el.style.backgroundImage=`url(${e})`}set objectFit(e){this.__el.style.backgroundSize="fill"===e?"100% 100%":e,this.__objectFit=e}get objectFit(){return this.__objectFit}updateStyle(e){Object.keys(e).forEach(t=>{"objectFit"===t?this.objectFit=e[t]:this.__el.style[t]=e[t]})}show(e){this.visible||(this.visible=!0,this.__el.className=o(h,"ttplayer-show"),null==e||e())}hide(e={},t){let i=!0===e.fade;if(this.visible){let r=o(h,i&&"ttplayer-fade");this.__timer>=0&&window.clearTimeout(this.__timer),e.delay?this.__timer=window.setTimeout(()=>{this.__timer=-1,this.visible=!1,this.__el.className=r,this.__faded=i,null==t||t()},e.delay):(this.visible=!1,this.__el.className=r,this.__faded=i,null==t||t())}else this.__faded&&!i&&(this.__faded=!1,this.__el.className=h)}attach(e){e.appendChild(this.__el)}detach(){var e;this.__faded=!1,window.clearTimeout(this.__timer),null==(e=this.__el.parentNode)||e.removeChild(this.__el)}}class u{static isEqual(e,t){return e===t||l.vV.isObject(e)&&l.vV.isObject(t)&&u.getCacheKey(e)===u.getCacheKey(t)}static isMultiple(e){return!l.vV.isString(e)&&e&&e.urls&&e.urls.length>0}static isEmpty(e){var t;return!(l.vV.isString(e)?e:e&&(null==(t=e.urls)?void 0:t.length)>0)}static isContainCacheKey(e,t){return l.vV.isString(e)?e===t:null!=e&&!!e.urls&&(e.cacheKey||e.urls[0])===t}static getProps(e){return l.vV.isString(e)?{}:null!=e&&e.urls?e:{}}static getUrl(e,t){return l.vV.isString(e)?e:null!=e&&e.urls?e.urls[t]:""}static getCacheKey(e){if(l.vV.isString(e))return e;if(e){if(e.cacheKey)return e.cacheKey;if(e.urls)return e.cacheKey||e.urls[0]||""}return""}}let c="ttplayer-videohide";var p=((r=p||{}).CANPLAY="canplay",r.TIMEUPDATE="timeupdate",r);class f extends l.bk{constructor(e){super(),this.HideTrigger=p,this.__logger=l.MD.createLogger("poster"),this.__updatedStyle={},this.__posters=[],this.__src="",this.__visible=!1,this.__autoPause=!1,this.__autoMute=!0,this.__hideOptions={fade:!0,delay:0,trigger:"canplay"},this.__selfCallPaused=!1,this.__handleSrcPreSetter=(e,t,i)=>{u.getProps(i).inherit||this.show()},this.__handleSeekPreSetter=()=>{this.__controller.removePreSetter("currentTime",this.__handleSeekPreSetter),this.hide()},this.__handlePausePreGetter=(e,t)=>()=>{t(),this.__selfCallPaused=!1,this.__controller.replaceGetter("pause",null)},this.__handleMutePreSetter=(e,t,i)=>{this.__reservedMuted=i},this.__handleLoadedData=()=>{let{trigger:e}=this.__tempHideOptions||this.__hideOptions;"timeupdate"===e?this.__controller.dedup("timeupdate",this.__handleTimeUpdateWithPoster):"canplay"===e&&this.__controller.dedup("canplay",this.__handleCanplay),this.__video.autoplay&&this.__togglePauseVideo(!1)},this.__handleCanplay=()=>{this.__controller.off("canplay",this.__handleCanplay),this.hide()},this.__handleTimeUpdateWithPoster=()=>{this.__controller.paused&&0===this.__controller.currentTime||(this.__controller.off("timeupdate",this.__handleTimeUpdateWithPoster),this.hide())};let{controller:t}=e;this.__controller=t,this.__video=t.getElement(),this.__container=document.createElement("div"),this.__styleContainer=document.createElement("style"),this.__styleContainer.innerHTML=".ttplayer-poster-enhance{position:static!important}.ttplayer-poster{position:absolute;top:0;left:0;width:100%;height:100%;background-position:center center;background-repeat:no-repeat;background-size:contain;pointer-events:none;z-index:1;opacity:0}.ttplayer-poster.ttplayer-fade{transition:opacity .3s ease-out 0s}.ttplayer-poster.ttplayer-hide{opacity:0}.ttplayer-poster.ttplayer-show{opacity:1}.ttplayer-videohide{visibility:hidden}",document.head.appendChild(this.__styleContainer),t.addPreSetter("src",this.__handleSrcPreSetter)}__togglePauseVideo(e){let{delay:t}=this.__hideOptions;if(!(this.__autoPause&&t>0))return;let i=this.__video;e?(i.paused||(i.pause(),this.__selfCallPaused=!0,this.__logger.info("since autoPause=true, the video is paused automatically")),this.__controller.replaceGetter("pause",this.__handlePausePreGetter)):i.paused&&this.__selfCallPaused&&(this.__controller.replaceGetter("pause",null),i.play(),this.__selfCallPaused=!1,this.__logger.info("resume playback automatically when the poster is hidden",i.paused))}__toggleMuteVideo(e){let{delay:t}=this.__hideOptions;if(!(this.__autoMute&&t>0))return;let i=this.__video;e?(void 0===this.__reservedMuted&&(this.__reservedMuted=i.muted),i.muted=!0,this.__controller.removePreSetter("muted",this.__handleMutePreSetter),this.__controller.addPreSetter("muted",this.__handleMutePreSetter),this.__logger.info("since autoMute=true, the video is muted automatically")):void 0!==this.__reservedMuted&&(this.__controller.removePreSetter("muted",this.__handleMutePreSetter),i.muted=this.__reservedMuted,this.__reservedMuted=void 0,this.__logger.info("restore the muted state of the video",i.muted))}__setVideoVisible(e){let t=this.__video;this.src&&(e?t.className=t.className.replace(RegExp("\\s*?"+c,"g"),""):-1===t.className.indexOf(c)&&(t.className=o(t.className,c)))}__createPoster(e){let t=new d(e);return this.__updatedStyle&&t.updateStyle(this.__updatedStyle),t.attach(this.__container),t}__appendToCache(e){this.__posters.some(t=>t.src===e)||(this.__posters.length?this.__posters[0].src=e:this.__posters.push(this.__createPoster(e)))}__forceShow(e){this.__posters.forEach(t=>{t.src===this.__src?t.show(e):t.hide()});try{this.emit("show")}catch(e){console.error(e)}}set hideTrigger(e){this.__hideOptions.trigger=e}get hideTrigger(){return this.__hideOptions.trigger}set fade(e){this.__hideOptions.fade=e}get fade(){return this.__hideOptions.fade}set delay(e){this.__hideOptions.delay=e}get delay(){return this.__hideOptions.delay}set autoPause(e){this.__autoPause=e}set autoMute(e){this.__autoMute=e}get visible(){return this.__visible}set src(e){this.__src=e,this.__appendToCache(e),this.__visible&&this.__forceShow()}get src(){return this.__src}set objectFit(e){this.__updatedStyle.objectFit=e,this.__posters.forEach(t=>{t.objectFit=e})}get objectFit(){return this.__updatedStyle.objectFit}set cache(e){let t=new Set(e),i=[],r=this.__posters.filter(e=>t.has(e.src)?(t.delete(e.src),!0):!!e.visible||void i.push(e));this.__posters=r.concat(Array.from(t).map(e=>{let t=i.pop();return t?(t.src=e,t):this.__createPoster(e)})),i.forEach(e=>e.detach())}get cache(){return this.__posters.map(e=>e.src)}show(e){this.__tempHideOptions=void 0,this.__controller.removePreSetter("currentTime",this.__handleSeekPreSetter),this.__controller.addPreSetter("currentTime",this.__handleSeekPreSetter),this.__controller.off("loadeddata",this.__handleLoadedData),this.__controller.once("loadeddata",this.__handleLoadedData),!this.__src||this.__visible||(this.__visible=!0,this.__forceShow(e),this.__toggleMuteVideo(!0),this.__setVideoVisible(!1),this.__logger.info("poster showed, src:",this.__src))}hide(e){if(!this.__visible)return;this.__setVideoVisible(!0),this.__visible=!1,this.__togglePauseVideo(!0);let t=[];this.__posters.forEach(e=>{e.src===this.__src?t.push(e):e.hide()});let i=()=>{this.__toggleMuteVideo(!1),this.__togglePauseVideo(!1),null==e||e(),this.__logger.info("poster hided, src:",this.__src,this.__tempHideOptions);try{this.emit("hide")}catch(e){console.error(e)}};t.length?t.forEach(e=>{e.hide(this.__tempHideOptions||this.__hideOptions,i)}):i()}setTempHideOptions(e){this.__tempHideOptions=l.vV.combineDefaultOptions(e,this.__hideOptions)}preventDefault(){this.__controller.removePreSetter("src",this.__handleSrcPreSetter)}attach(e){e.appendChild(this.__container)}destroy(){var e;document.head.removeChild(this.__styleContainer),this.__posters.forEach(e=>e.detach()),this.__controller.off("canplay",this.__handleCanplay),this.__controller.off("timeupdate",this.__handleTimeUpdateWithPoster),this.__controller.off("loadeddata",this.__handleLoadedData),this.__controller.replaceGetter("paused",null),this.__controller.removePreSetter("muted",this.__handleMutePreSetter),this.__controller.removePreSetter("src",this.__handleSrcPreSetter),this.__controller.removePreSetter("currentTime",this.__handleSeekPreSetter),null==(e=this.__container.parentNode)||e.removeChild(this.__container)}}var m=((s=m||{}).POSTER="poster",s),g=((n=g||{})[n.NETWORK=2100]="NETWORK",n[n.NETWORK_TIMEOUT=2101]="NETWORK_TIMEOUT",n[n.NETWORK_FORBIDDEN=2103]="NETWORK_FORBIDDEN",n[n.DEMUX_MP4=3300]="DEMUX_MP4",n[n.DEMUX_DASH=3400]="DEMUX_DASH",n[n.REMUX_FMP4=4100]="REMUX_FMP4",n[n.MEDIA_ABORTED=5101]="MEDIA_ABORTED",n[n.MEDIA_NETWORK=5102]="MEDIA_NETWORK",n[n.MEDIA_DECODE=5103]="MEDIA_DECODE",n[n.MEDIA_SRC_NOT_SUPPORTED=5104]="MEDIA_SRC_NOT_SUPPORTED",n[n.MEDIA_UNSUPPORT=5105]="MEDIA_UNSUPPORT",n[n.MEDIA_EMPTY_SRC=5106]="MEDIA_EMPTY_SRC",n[n.MEDIA_MSE_ADD_SB=5200]="MEDIA_MSE_ADD_SB",n[n.MEDIA_MSE_SB_APPEND=5201]="MEDIA_MSE_SB_APPEND",n[n.MEDIA_MSE_OTHER=5202]="MEDIA_MSE_OTHER",n[n.MEDIA_MSE_OVERFLOW=5203]="MEDIA_MSE_OVERFLOW",n[n.MEDIA_MSE_HIJACKED=5204]="MEDIA_MSE_HIJACKED",n[n.MEDIA_MSE_SB_CHANGE_TYPE=5205]="MEDIA_MSE_SB_CHANGE_TYPE",n[n.MEDIA_MSE_SB_REMOVE=5206]="MEDIA_MSE_SB_REMOVE",n[n.OTHER=8e3]="OTHER",n[n.OTHER_PARAMS=8100]="OTHER_PARAMS",n[n.RUNTIME_NO_CANPLAY=9001]="RUNTIME_NO_CANPLAY",n[n.RUNTIME_BUFFER_BREAK=9002]="RUNTIME_BUFFER_BREAK",n[n.RUNTIME_WAITING_TIMEOUT=9003]="RUNTIME_WAITING_TIMEOUT",n);let _=class e extends Error{constructor(e,t,i){super(t),this.name="PlayerError",this.code=e,this.category=g[e],this.message=t||this.category,this.extra=i}static fromMediaError(t,i){switch(t.code){case 1:return new e(5101,t.message,i);case 2:return new e(5102,t.message,i);case 3:return new e(5103,t.message,i);case 4:return new e(5104,t.message,i);default:return new e(8e3,t.message,i)}}};_.Code=g;let v=_,y=["playnext","exception"],A=["canplay","canplaythrough","durationchange","emptied","ended","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","stalled","suspend","seeked","seeking","resize","timeupdate","volumechange","waiting"];class T extends l.bk{constructor(e){super(),this._logger=l.MD.createLogger("controller"),this.__replacedGetterMap=new Map,this.__replacedSetterMap=new Map,this.__preSetterMap=new Map,this.__videoOffCallbackMap=new Map,this.__remapOffCallbacks=[],this.__videoEventProxyMap=new Map,this.__currUrlIndex=0,this.willEmitEventNameSet=new Set,this.__handleSrcPreSetter=(e,t,i)=>{u.isMultiple(i)?(this.__urls=i.urls,this.__currUrlIndex=0):this.__urls=void 0},this.processError=()=>{let e={url:this.__core.currentSrc},t=this.__core.error?v.fromMediaError(this.__core.error,e):new v(v.Code.OTHER,"The error event was triggered, but video.error is null",e);if(this.__urls)if(this.__currUrlIndex++,this.__currUrlIndex<this.__urls.length){this.emit("exception",t);let e=this.__core.currentTime;this.emit("waiting"),this.__core.src=this.__urls[this.__currUrlIndex],this.__core.load(),this.__core.currentTime=e,this.__core.play()}else this.emit("error",t);else this.emit("error",t)},this.play=async()=>new Promise(e=>{this.__core.play().then(()=>{e(null)}).catch(t=>{this._logger.warn(t),e(t)})}),this.pause=()=>this.__core.pause(),this.reset=()=>{this.__core.removeAttribute("src"),this.__core.load()};let t=a(e,{objectFit:"contain"}),{objectFit:i,crossOrigin:r,attributes:s,...n}=t,o=document.createElement("video");return o instanceof HTMLVideoElement&&(s&&Object.keys(s).forEach(e=>{o.setAttribute(e,s[e])}),r&&(o.crossOrigin=r),o.setAttribute("data-version","0.3.46"),o.style.width="100%",o.style.height="100%",o.style.verticalAlign="middle"),this.coreName="video-element",this.coreVersion="",this.__core=o,this.__bindEvents(),Object.assign(this,n),e.container.appendChild(o),this.__posterManager=new f({controller:this}),this.__posterManager.attach(t.container),this.addPreSetter("src",this.__handleSrcPreSetter),new Proxy(this,{set:(e,t,i)=>{if(0===t.indexOf("_"))return e[t]=i,!0;let r=this.__preSetterMap.get(t);if(r&&r.some(r=>!1===r(e,e[t],i)))return!0;let s=this.__replacedSetterMap.get(t);return s?s(e,e[t],i):e[t]!==i&&(e[t]=i,this.emit("update",t,e[t],i)),!0},get:(e,t)=>{if(0===t.indexOf("_"))return e[t];let i=this.__replacedGetterMap.get(t);return i?i(e,e[t]):e[t]}})}__bindVideoEvent(e,t){this.__videoOffCallbackMap.has(e)||(this.__core.addEventListener(e,t,!1),this.__videoOffCallbackMap.set(e,()=>{this.__core.removeEventListener(e,t,!1)}))}__bindEvents(){A.forEach(e=>{this.__bindVideoEvent(e,()=>this.emit(e)),this.willEmitEventNameSet.add(e)}),y.forEach(e=>{this.willEmitEventNameSet.add(e)}),[{onName:"error",emitName:"error",callback:this.processError}].forEach(e=>{this.__videoEventProxyMap.set(e.onName,e),this.__bindVideoEvent(e.onName,e.callback),this.willEmitEventNameSet.add(e.emitName)}),l.bk.remap(this,this,{loadedmetadata:"update",play:"update",pause:"update",volumechange:"update",ratechange:"update"}).forEach(e=>{this.__remapOffCallbacks.push(e)})}getInternalModule(e){if(e===m.POSTER)return this.__posterManager;throw new v(v.Code.OTHER_PARAMS,`Module [${e}] not found, please use InternalModuleName as parameter`)}getElement(){return this.__core}getCore(){return this.__core}addPreSetter(e,t){let i=this.__preSetterMap.get(e);i?i.push(t):this.__preSetterMap.set(e,[t])}removePreSetter(e,t){let i=this.__preSetterMap.get(e);i&&i.length&&this.__preSetterMap.set(e,i.filter(e=>e!==t))}replaceSetter(e,t){t?this.__replacedSetterMap.set(e,t):this.__replacedSetterMap.delete(e)}replaceGetter(e,t){t?this.__replacedGetterMap.set(e,t):this.__replacedGetterMap.delete(e)}disableEvents(e){e.forEach(e=>{let t=this.__videoOffCallbackMap.get(e);t&&(t(),this.__videoOffCallbackMap.delete(e))})}enableEvents(e){e.forEach(e=>{let t=this.__videoEventProxyMap.get(e);t?this.__bindVideoEvent(e,t.callback):this.__bindVideoEvent(e,()=>this.emit(e))})}_switchUrl(e,t){let i=0,r=!1;t?(i=this.__core.currentTime,r=this.__core.paused):this.emit("playnext"),this.__core.src=e,t&&(this.__core.currentTime=i,r?this.__core.pause():this.__core.play())}get videoWidth(){return this.__core.videoWidth}get videoHeight(){return this.__core.videoHeight}get objectFit(){return this.__core.style.objectFit}set objectFit(e){this.__core.style.objectFit=e}get error(){return this.__core.error}get buffered(){return this.__core.buffered}get duration(){return this.__core.duration}get paused(){return this.__core.paused}get ended(){return this.__core.ended}get rawSrc(){return this.currentSrc}get currentSrc(){return this.__core.currentSrc}set src(e){if("string"==typeof e)this._switchUrl(e,!1);else if(u.isMultiple(e)){let t=e.urls[this.__currUrlIndex];this._switchUrl(t,!!e.inherit)}else this.emit("error",new v(v.Code.MEDIA_EMPTY_SRC,"src is invalid"))}get src(){return this.__core.src||""}set sources(e){this.__urls=e,this.__currUrlIndex=0}get sources(){return this.__urls}set sourceIndex(e){this.__currUrlIndex=e}get sourceIndex(){return this.__currUrlIndex}set poster(e){this.__posterManager.src=e}get poster(){return this.__posterManager.src}set autoplay(e){this.__core.autoplay=e}get autoplay(){return this.__core.autoplay}set crossOrigin(e){e?this.__core.crossOrigin=e:this.__core.removeAttribute("crossOrigin")}get crossOrigin(){return this.__core.crossOrigin}set currentTime(e){this.__core.currentTime=e}get currentTime(){return this.__core.currentTime}set volume(e){this.__core.volume=e}get volume(){return this.__core.volume}set muted(e){this.__core.muted=e}get muted(){return this.__core.muted}set playbackRate(e){this.__core.playbackRate=e}get playbackRate(){return this.__core.playbackRate}set loop(e){this.__core.loop=e}get loop(){return this.__core.loop}set lang(e){this.__core.lang=e}get lang(){return this.__core.lang}set preload(e){this.__core.preload=e}get preload(){return this.__core.preload}get readyState(){return this.__core.readyState}get networkState(){return this.__core.networkState}destroy(){var e;this.__remapOffCallbacks.forEach(e=>e()),this.__remapOffCallbacks=[],this.__videoOffCallbackMap.forEach(e=>e()),this.__videoOffCallbackMap.clear(),this.__videoEventProxyMap.clear(),this.removeAllListeners(),this.__posterManager.destroy(),this.__preSetterMap.clear(),this.__replacedSetterMap.clear(),this.__replacedGetterMap.clear(),this.reset(),null==(e=this.__core.parentNode)||e.removeChild(this.__core)}}class b{constructor(e){var t;this.__logger=l.MD.createLogger("plugin-manager"),this.__map=new Map,this.__context={...e.context,pluginManager:this},null==(t=e.plugins)||t.forEach(e=>{e&&this.register(e)})}get(e){return this.__map.get(e)}register(e){this.__map.has(e.name)?this.__logger.warn(`[${e.name}] already exists`):(e.install(this.__context),this.__map.set(e.name,e),this.__logger.info(`[${e.name}] has been registered`))}unregister(e){let t="string"==typeof e?e:e.name,i=this.__map.get(t);i&&(this.__map.delete(t),i.uninstall(this.__context),this.__logger.info(`[${i.name}] has been unregistered`))}reset(){var e;for(let t of this.__map.values())null==(e=t.reset)||e.call(t)}destroy(){this.__map.forEach(e=>{e.uninstall(this.__context),this.__logger.info(`[${e.name}] has been uninstalled`)}),this.__map.clear()}}let S={ttplayer_record_event:!!(0,l.HZ)()&&!!localStorage.getItem("ttplayer_record_event"),ttplayer_record_instance:!!(0,l.HZ)()&&!!localStorage.getItem("ttplayer_record_instance")},E=(0,l.HZ)()?window:{};S.ttplayer_record_instance&&(E.__ttplayers__=[]);let k=class extends l.bk{constructor(e){super(),this.__logger=l.MD.createLogger("ttplayer"),this.getInternalModule=e=>this.__controller.getInternalModule(e),this.__logger.info("options",e);let t=[];if(e.plugins)for(let i of e.plugins)i&&i.name&&i.install&&t.push(i);let{src:i,...r}=e;this.__controller=new T(Object.assign(r)),this.__controller.willEmitEventNameSet.forEach(e=>{this.__controller.on(e,(...t)=>{this.emit(e,...t)})}),e.eventOrdered&&this._reorderEvents(),this._checkEnableDebugLog(),this.__pluginManager=new b({context:{container:e.container,controller:this.__controller},plugins:t}),i&&(this.__controller.src=i),S.ttplayer_record_instance&&E.__ttplayers__&&E.__ttplayers__.push(this)}_checkEnableDebugLog(){S.ttplayer_record_event&&l.bk.throttle(this,this.__controller.willEmitEventNameSet,["timeupdate","progress","durationchange"],e=>{this.__logger.log("event emitted 	->	",e)})}_reorderEvents(){this.on("loadstart",()=>{this.block("timeupdate"),this.__logger.log("event blocked - timeupdate")}),this.on("loadeddata",()=>{this.unblock("timeupdate"),this.__logger.log("event unblocked - timeupdate")})}getElement(){return this.__controller.getElement()}getPlugin(e){return this.__pluginManager.get(e)}get coreName(){return this.__controller.coreName}get coreVersion(){return this.__controller.coreVersion}get error(){return this.__controller.error}get buffered(){return this.__controller.buffered}get duration(){return this.__controller.duration}get paused(){return this.__controller.paused}get ended(){return this.__controller.ended}get rawSrc(){return this.__controller.rawSrc}get currentSrc(){return this.__controller.currentSrc}set src(e){this.__controller.src=e}get src(){return this.__controller.src}set poster(e){this.__controller.poster=e}get poster(){return this.__controller.poster}set autoplay(e){this.__controller.autoplay=e}get autoplay(){return this.__controller.autoplay}set crossOrigin(e){this.__controller.crossOrigin=e}get crossOrigin(){return this.__controller.crossOrigin}set currentTime(e){this.__controller.currentTime=e}get currentTime(){return this.__controller.currentTime}set volume(e){this.__controller.volume=e}get volume(){return this.__controller.volume}set muted(e){this.__controller.muted=e}get muted(){return this.__controller.muted}set playbackRate(e){this.__controller.playbackRate=e}get playbackRate(){return this.__controller.playbackRate}set objectFit(e){this.__controller.objectFit=e}get objectFit(){return this.__controller.objectFit}get videoWidth(){return this.__controller.videoWidth}get videoHeight(){return this.__controller.videoHeight}set loop(e){this.__controller.loop=e}get loop(){return this.__controller.loop}set lang(e){this.__controller.lang=e}get lang(){return this.__controller.lang}play(){return this.__controller.play()}pause(){this.__controller.pause()}set preload(e){this.__controller.preload=e}reset(){this.__controller.reset(),this.__pluginManager.reset()}get readyState(){return this.__controller.readyState}get networkState(){return this.__controller.networkState}destroy(){var e;this.removeAllListeners(),this.__pluginManager.destroy(),this.__controller.destroy(),S.ttplayer_record_instance&&null!=(e=E.__ttplayers__)&&e.length&&(E.__ttplayers__=E.__ttplayers__.filter(e=>e!==this))}};k.InternalModuleName=m;let P=k,w="0.3.46"}}]);